{"title": "A Multi-Loss Strategy for Vehicle Trajectory Prediction:\nCombining Off-Road, Diversity, and Directional Consistency Losses", "authors": ["Ahmad Rahimi", "Alexandre Alahi"], "abstract": "Trajectory prediction is essential for the safety\nand efficiency of planning in autonomous vehicles. However,\ncurrent models often fail to fully capture complex traffic\nrules and the complete range of potential vehicle movements.\nAddressing these limitations, this study introduces three novel\nloss functions: Offroad Loss, Direction Consistency Error, and\nDiversity Loss. These functions are designed to keep predicted\npaths within driving area boundaries, aligned with traffic\ndirections, and cover a wider variety of plausible driving\nscenarios. As all prediction modes should adhere to road\nrules and conditions, this work overcomes the shortcomings of\ntraditional \"winner takes all\" training methods by applying\nthe loss functions to all prediction modes. These loss func-\ntions not only improve model training but can also serve as\nmetrics for evaluating the realism and diversity of trajectory\npredictions. Extensive validation on the nuScenes and Argoverse\n2 datasets with leading baseline models demonstrates that\nour approach not only maintains accuracy but significantly\nimproves safety and robustness, reducing offroad errors on\naverage by 47% on original and by 37% on attacked scenes.\nThis work sets a new benchmark for trajectory prediction\nin autonomous driving, offering substantial improvements in\nnavigating complex environments. Our code is available at\nhttps://github.com/vita-epfl/stay-on-track.", "sections": [{"title": "I. INTRODUCTION", "content": "Trajectory prediction plays a crucial role in autonomous\nsystems, particularly in enhancing the safety and reliability of\nself-driving vehicles. Recent advancements have significantly\nimproved the capabilities of predictive models, enabling them\nto generate multimodal trajectory predictions that account for\nuncertainties in drivers' intentions and driving styles. Despite\nthese advancements, significant challenges remain, including\naccurately understanding scenes and predicting all possible\ntrajectory modes.\nCurrent models often struggle with fully grasping scene\ndynamics and accurately forecasting every potential move-\nment, as evidenced in Figure 1. Even advanced models\nmay incorrectly predict trajectories that go off-road, oppose\ntraffic flow, or overlook viable maneuvers at intersections\nand in complex urban settings. This highlights the need\nfor enhanced models capable of better interpreting and\nnavigating various traffic situations for improved safety and\ndependability.\nMoreover, traditional objective functions used in model\ntraining often fall short in enhancing the mentioned aspects\nof prediction. Typically, these training methods adopt a\n\u201cwinner takes all\u201d approach where they focus on minimizing\nthe prediction errors for the trajectory closest to the ground\ntruth observation. This method neglects other viable trajec-\ntory predictions during the model's learning phase, as only"}, {"title": "II. RELATED WORK", "content": "Recent advancements in vehicle trajectory prediction have\nled to significant improvements in modeling techniques.\nInspired by breakthroughs in convolutional neural networks\n(CNNs) and computer vision, early models utilized rasterized\nbird's-eye view images, incorporating static map elements\nand agent trajectories as input representations. This approach\nleveraged CNNs to predict future paths [2], [3], [4], [5],\n[6]. However, rasterized inputs are computationally intensive\nand memory-heavy, suffer from a limited field of view,\nand burden the model with extracting already available 2D\npositional information challenges that complicate agent\ninteraction modeling and scene comprehension.\nAddressing these limitations, more recent models have\nadopted fully vectorized map representations, initially em-\nploying graph neural networks [7], [8], [9], [10] and Recur-\nrent Neural Networks [11], [12], [13], [14]. The introduction\nof transformers in the field has further enhanced model capa-\nbilities, integrating attention mechanisms to refine trajectory\npredictions [1], [15], [16], [17], [18].\nAlthough there have been advances in model architectures\naimed at enhancing prediction accuracy, the quality and\nsafety of the diverse predicted trajectories have not been as\nthoroughly addressed. State-of-the-art models often produce\nundesirable results, such as trajectories that deviate off-road\nor violate traffic directions, as demonstrated in Figure 1.\nSome models have incorporated explicit road structures\nto enhance scene feasibility [19], [20], [21], and impose\nhigher diversity [22], [23], [11]. yet their dependency on\nspecific map structures limits their adaptability across various\ndatasets. Instead of developing new architectural frameworks,\nour work introduces simple universal loss functions that en-\nhance prediction quality and diversity across any prediction\nmodel.\nA significant body of work related to ours has also\nintroduced an Offroad metric [24], [25], [26], [27], [28],\n[29], with some employing it directly as an auxiliary loss\nfunction [25], [26], [27], [29]. These studies traditionally rely\non rasterized offroad masks, which are less compatible with"}, {"title": "III. METHOD", "content": "This section formally defines the vehicle trajectory pre-\ndiction problem to establish a mathematical framework. It\nthen reviews the challenges inherent in the commonly used\n\"winner takes all\" training approach in recent models. Fi-\nnally, the section presents three novel auxiliary loss functions\ndesigned to enrich models with greater scene understanding\nand promote diversity in predictions.\nConsider the trajectory prediction problem involving an\nego agent surrounded by N neighbouring agents within\na scene. Let s = (x,y) define the state of agent i at\ntimestep t. We have access to the observed trajectories\n$x^i = [s^i_t,\u2026\u2026\u2026, s^i_{-1}, s^i_0]$ for all agents over the past t timesteps,\naggregated as $x = [x^0,x^1,...,x^N] \\in R^{N \\times t \\times 2}$. Additionally, the\ninput includes the drivable area \u03a9, represented as a union\nof several closed polygons, and the centerlines $c\\in R^{S\\times K\\times 3}$,\nwith each of S centerline segments containing K points\ncharacterized by their 2D position and yaw (x,y, \u03b8). The pre-\ndiction model f aims to predict the ego agent's ground truth\ntrajectory $y = [s^0_1,\u2026\u2026,s^0_T]$ over the next T timesteps. Given\nthe multimodal nature of the prediction task, stemming from\nuncertainties in drivers' intentions, the model f generates M\ndistinct possible trajectories, thus $y = f(x,\u03a9, c) \\in R^{M\\times T \\times 2}$.\nMultimodal predictions are a fundamental aspect of cur-\nrent trajectory prediction models, with each model generating\nM distinct trajectories. Traditionally, these models are trained\nusing objective functions like minADE, defined as:\n$\\minADE = \\min_{1<m<M} \\frac{1}{T} \\sum_{t=1}^{T}||y^m_t - \\hat{y_t}||^2$. (1)\nThis function focuses on minimizing the error for the tra-\njectory closest to the ground truth, effectively prioritizing\nthe most likely outcome while allowing other predictions to\nrepresent alternative possible scenarios. However, such an ap-\nproach has a significant drawback: only the closest trajectory\nto the ground truth receives gradient updates during training,\nleaving other predicted trajectories largely unrefined. This\nmethod of sparse supervision can lead to unsatisfactory\nmodeling of less common but plausible behaviors, thereby\nlimiting the model's ability to fully capture the diverse\npossibilities inherent in real-world driving scenarios."}, {"title": "C. Proposed objective functions", "content": "To address the limitations of common \"winner takes all\"\ntraining objectives, we propose three new loss functions.\nUnlike traditional methods, these functions supervise all\nprediction modes, enhancing different aspects of the model's\nperformance. Each function is designed to infuse the model\nwith deeper knowledge, targeting specific shortcomings in\nexisting approaches. Figure 2 illustrates these loss functions.\nThe first proposed loss function directs\npredictions toward the drivable area and penalizes off-road\ndeviations by employing a signed distance function between\nthe predicted trajectory y and the drivable area \u03a9. This\nfunction is continuous and differentiable, with its gradient\ndirected toward the nearest point within \u03a9. Figure 2a visually\ndemonstrates the offroad function, where the penalty values\nare depicted across different areas around the vehicle. Math-\nematically, the signed distance function & for 2 is defined\nsuch that it returns the shortest distance from any point x to\nthe boundary d\u03a9 of \u03a9, being negative if x is inside 2 and\npositive otherwise. We define our Offroad loss function as:\n$\\text{Offroad Loss} (y, \\Omega) = \\frac{1}{M}\\sum_{i=1}^{M} \\frac{1}{T} \\sum_{t=1}^{T} \\text{Cmax}(\\phi(y^i_t, \\Omega) +m,0)$, (2)\nwhere $y_t^i$ represents the position at timestep t of the ith\nprediction, o is the signed distance function, and m is a\nmargin that maintains a buffer from \u03a9's boundary. This\nloss sums across all prediction points, with zero indicating\npresence within the drivable area (including a margin of m\nmeters) and increasing as predictions move further from \u03a9.\nTo compute the signed distance function (p,\u03a9), we\ncalculate the distance from point p to all polygon edges\nin 2 and select the minimum distance to determine the\nclosest boundary. For determining whether p is inside \u03a9,\na ray casting algorithm is utilized, where a ray extending\nfrom p along the x-axis is used to count the intersections\nwith the polygon's edges. Then, point p is in or out of\n\u03a9 if the number of crossings is odd or even, respectively.\nThis method, commonly used for point-in-polygon tests, is\nadapted from computational geometry principles outlined by\n[32]. All computations are efficiently implemented on the\nthe performance overhead and accelerate\nthe loss evaluation process.\nGiven that road cen-\nterlines are part of the map context for prediction mod-\nels, maintaining the correct directional alignment is crucial.\nTo address instances where models may align with these\ncenterlines in the incorrect direction, we propose the Road\nDirection Consistency loss function. As Figure 2b illustrates,\nthis function imposes a significant penalty on trajectories\ndeviating from corresponding centerline's direction, ensuring\nalignment not just in position but also in orientation.\nTo implement it, we calculate the heading direction\n of each predicted trajectory y' at timestep t. The difference\n$\\delta(c,y)$ between a centerline point c = (x,y, 0) and a trajec-\ntory point $y = (x',y', \\gamma)$ is defined as:\n$\\delta(c,y) = \\text{max} (||(x, y) - (x', y')||_2 - m_d, 0)$\n$+ \\text{max} (|\\theta - \\gamma| - m_{\\theta}, 0)$,\nwhere $m_d$ and $m_{\\theta}$ represent the allowable distance and angle\nmargins, respectively.\nThe Road Direction Consistency loss then aggregates the\nminimum 8 value between each trajectory point and all"}, {"title": "Direction Consistency(y, c)", "content": "centerline points, summed across all trajectory points:\n$\\text{Direction Consistency}(y, c) = \\frac{1}{M}\\sum_{i=1}^{M} \\frac{1}{T} \\sum_{t=1}^{T} \\min_{1<s<S\\ \\ 1<k<K} \\delta (c_{s,k}, y^i_t)$. (3)\nThe flexibility of this loss function is particularly important\nin complex environments like intersections, where many\ncenterlines are close together but may have very different\ndirections. Matching the trajectory strictly to the nearest\ncenterline can sometimes lead to incorrect alignments. Our\napproach allows for matching with any centerline while in-\ntroducing a penalty for the distance, ensuring a more accurate\nmatch. This means the model might align a trajectory with\na centerline that is not the closest one but has a more\nsuitable heading. This method ensures each trajectory point is\nevaluated against the most appropriate centerline, effectively\nimproving accuracy in both position and direction, especially\nin challenging scenarios.\nEnsuring a diverse set of predictions\nis critical for robust and safe route planning, particularly\nto capture all highly probable and plausible trajectories. To\nsupport this, we introduce the Mode Diversity loss, which\npromotes a spread of predictions and is depicted in Figure 2c,\nthat favours more spread predictions over the concentrated\nones, as long as the predictions are feasible. This function\nfirst excludes any trajectories that are off-road by employing\nan indicator function 1(i) which assesses whether trajectory\ny\u00b9 remains within drivable area. The diversity loss is then\ncalculated as the sum of pairwise distances between all\nremaining feasible trajectories:\n$\\text{Mode Diversity} (y, \\mathbb{1}) = \\frac{1}{T} \\sum_{1<i<M}\\sum_{i<j<M} \\sum_{t=1}^{T}\\mathbb{1}(i)=1\\ \\mathbb{1}(j)=1 ||y^i_t-y^j_t||_2$, (4)\nwhere 1(i) = 1 indicates that trajectory $y^i$ is within drivable\narea. This selective approach ensures that the Mode Diversity\nloss only considers trajectories that are practical and safe,\nthereby avoiding an undesired increase in the loss value from\ntrajectories pushed outside of road boundaries."}, {"title": "IV. EXPERIMENTS", "content": "In this section, we detail our experimental setup, including\na description of the vehicle trajectory prediction datasets\nand the baseline models utilized. We enhanced the base-\nline models by integrating our proposed loss functions as\nauxiliary components. Specifically, the total loss for train-\ning is formulated as $L_{final} = L_{original} + \\alpha L_{aux}$, where a\nis a hyperparameter that balances the contributions of the\noriginal and auxiliary losses. For experiments that utilize all\nintroduced loss functions, we calculate the total auxiliary\nloss using a weighted sum of each function, where the\nweights are derived from the optimal a values determined\nduring individual training with each specific loss function,\nand adjusted for optimal performance.\nWe present both quantitative results demonstrating the\nperformance improvements achieved with our auxiliary loss\nfunctions and qualitative examples that illustrate specific en-\nhancements in trajectory prediction due to our methodology.\nAdditionally, we explore how varying the weight a of the\nauxiliary loss affects overall model performance, providing\ninsights into the optimal configuration for balancing between\nthe baseline and proposed modifications. Finally, we show\nthe improved robustness of our models through evaluations\nusing the Scene Attack benchmark [33], in realistic scenarios\nthat include synthetically introduced turns.\nOur experiments leverage the UniTraj framework [34]\nto integrate our proposed loss functions with two state-\nof-the-art trajectory prediction models: Wayformer [1] and\nAutoBots [15]. Wayformer is known for its superior predic-\ntion capabilities within UniTraj, whereas AutoBots provides\na performant yet lightweight alternative. The experiments\nare conducted on two prominent datasets: nuScenes [35], a\nsmaller and more challenging dataset, and Argoverse 2 [36],\nwhich offers a broader range of scenarios.\nWe adopt UniTraj's setup, where the models are trained\nusing a history of 2 seconds and make predictions over\n6 seconds, with each model outputting M 6 possible\ntrajectories, using UniTraj's hyperparameters.\nTo\nin terms of evaluation metrics, we introduce three novel\nmeasures Offroad, Direction Error, and Diversity to\nassess specific aspects of prediction quality. Additionally, we\nutilize standard metrics from the field which evaluate pre-\ndiction accuracy, including minimum Average Displacement\nError (minADE), as previously defined in Equation (1), along\nwith minimum Final Displacement Error (minFDE) and Miss\nRate (MR). MinFDE is calculated as:\n$\\minFDE = \\min_{1<m<M} ||y^m_T - \\hat{Y_T}||_2$. (5)\nMiss Rate (MR) is defined as the ratio of the samples where\nthe minFDE exceeds 2 meters, and is useful where deviations\nup to 2 meters are acceptable.\nWe train the baseline models and those\nincorporating Offroad and Direction Consistency losses from\nscratch to achieve optimal results. However, the Diversity\nloss is applied through finetuning the baseline model over 10\nepochs, as introducing it from the start tends to destabilize\ntraining. When employing all our loss functions together, we\nalso opt for finetuning because of the Diversity loss's impact,\nalthough this approach might slightly limit improvements in\nOffroad and Direction Consistency metrics."}, {"title": "B. Quantitative results", "content": "The quantitative performance of our method, as detailed in\nTab. I, demonstrates significant enhancements when training\nWayformer and AutoBots on the nuScenes and Argoverse 2\ndatasets. We observe several key improvements:\n\u2022\nThe implementation of our proposed loss functions\nconsistently leads to substantial reductions in their tar-\ngeted metrics. For instance, applying the Offroad loss\ntypically cuts the offroad metric nearly in half. By\nintegrating all three proposed loss functions, our method\nimproves performance across all assessed quality met-\nrics compared to baseline models.\n\u2022\n\u2022 Although we observe a slight increase in minADE/\nminFDE in certain settings, this is offset by the sig-\nnificant reduction in scene compliance errors like off-\nroad, which is critical for ensuring safe and feasible\npredictions. This trade-off highlights the importance of\nprioritizing safety over minor decreases in accuracy in\nreal-world autonomous driving scenarios.\nThe Offroad and Direction Error metrics benefit each\nother. Using one as an auxiliary loss not only improves\nits own performance but also enhances the other. This\nmutual boost is especially notable with the Direction\nError loss, which often shows improvements similar to"}, {"title": "C. Qualitative results", "content": "We present qualitative results of our proposed auxiliary\nloss functions in Figure 3, demonstrating significant improve-\nments in model predictions across various scenarios. In the\nfirst panel, the baseline model generates multiple off-road\npredictions, failing to align with the ground truth. Incorpo-\nrating the Offroad loss during training teaches the model\nto recognize and avoid such errant paths, leading to more\naccurate trajectory predictions. In the second panel, a notable\nerror in the baseline predictions includes a dangerous right"}, {"title": "D. Metric weight study", "content": "In this study, we explore how combining the original loss\nfunction with our auxiliary loss affects model performance.\nWe illustrate this relationship in Figure 4, where we adjust\nthe weight of the auxiliary loss, a. Starting with a high\nauxiliary weight a close to the selected model in each\ncurve, we gradually decrease this weight, moving towards\nbaseline, which typically worsens the auxiliary metrics but\ncan improve the main prediction accuracy.\nInterestingly, there is a sweet spot along these curves\nwhere the prediction accuracy, specifically minADE, is close\nto that of the baseline model, while simultaneously im-\nproving on the auxiliary metrics. This balance demonstrates\nthat it's possible to enhance certain aspects of a model's\npredictions without degrading overall accuracy. These results\nshow that advanced models are capable of achieving a desir-\nable balance between accuracy and specific improvements,\nvalidating the effectiveness of our proposed loss functions as\ndiscussed in \u00a7IV-B."}, {"title": "E. Robustness to scene attack", "content": "We evaluate the enhanced robustness of our models using\nthe Scene Attack benchmark [33], which simulates natural-\nistic attacks by introducing varying turns in the road ahead\nof the ego agent. Tab. II displays the Offroad metric for\npredictions made by our baseline models on both original\nand manipulated scenes across the Argoverse 2 and nuScenes\ndatasets. These metrics are averaged across different types\nand degrees of introduced road changes. Notably, models\ntrained with our proposed loss functions consistently have"}, {"title": "V. CONCLUSIONS", "content": "This study has demonstrated the efficacy of integrating\nnovel loss functions Offroad Loss, Direction Consistency\nError, and Diversity Loss into trajectory prediction models\nto significantly enhance their quality and robustness across\ndiverse driving scenarios. Our comprehensive evaluation on\nthe nuScenes and Argoverse 2 datasets, utilizing state-of-the-\nart baseline models Wayformer and Autobots, has substan-\ntiated that these functions not only reduce undesirable be-\nhaviors such as off-road trajectories and direction violations\nbut also improve the overall diversity and plausibility of pre-\ndicted trajectories. The proposed loss functions stand out for\ntheir ability to be applied universally across different models\nand datasets without necessitating specialized architectural\nadaptations. As autonomous technologies continue to evolve,\nthe methodologies developed in this work provide a scalable\nand efficient approach to improving the safety and reliability\nof trajectory predictions in complex urban environments.\nA possible extension to this work would be the addition\nof other differential loss functions to this suite to further en-\nhance the quality of predictions. Examples would be collision\navoidance and kinematic feasibility of predictions. Another\npossibility for future investigation is the integration of a\nadaptive weight assigning algorithm to these loss functions,\npossibly based on model's state during training."}]}