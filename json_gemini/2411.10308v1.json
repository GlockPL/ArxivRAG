{"title": "A Realistic Collimated X-Ray Image Simulation Pipeline", "authors": ["Benjamin El-Zein", "Dominik Eckert", "Thomas Weber", "Maximilian Rohleder", "Ludwig Ritschl", "Steffen Kappler", "Andreas Maier"], "abstract": "Collimator detection remains a challenging task in X-ray systems with unreliable or non-available information about the detectors position relative to the source. This paper presents a physically motivated image processing pipeline for simulating the characteristics of collimator shadows in X-ray images. By generating randomized labels for collimator shapes and locations, incorporating scattered radiation simulation, and including Poisson noise, the pipeline enables the expansion of limited datasets for training deep neural networks. We validate the proposed pipeline by a qualitative and quantitative comparison against real collimator shadows. Furthermore, it is demonstrated that utilizing simulated data within our deep learning framework not only serves as a suitable substitute for actual collimators but also enhances the generalization performance when applied to real-world data.", "sections": [{"title": "1 Introduction", "content": "In digital radiography, the detection of collimator-covered areas is essential to present diagnostically relevant regions to radiologists. Geometric alignment algorithms, as described in [9], can be employed in X-ray systems with known extrinsic projection parameters. However, despite their availability, these often suffer from inaccuracies sabotaging effectiveness in practice. Due to the inherent geometrical variability in conventional X-ray systems, particularly with mobile flat panel detectors, precise information of the relative position to the detector is unavailable. Moreover, imprecise collimator movement further complicates the detection process, necessitating analysis within image domain. Contrary to a simplistic threshold-based approach, the identification of relevant areas is challenging due to the presence of physical effects like edge-blurring, noise, and scattered radiation. Even human visual perception faces difficulties due to these complexities, as depicted in Fig. 1.\nDeep neural networks (DNNs) show promise for collimator detection, but the limited availability of pre-processed raw data poses a challenge for training"}, {"title": "2 Methods", "content": null}, {"title": "2.1 Randomized Collimator Simulation Pipeline", "content": "The process of simulating collimator shadows involves three distinct stages. In the first stage random labels are generated to define the shape and position of the collimated area. The second stage introduces scattered radiation, whereas the final stage adds a simulation of noise."}, {"title": "Binary Mask Sampling Strategy", "content": "The first part of the pipeline generates a binary mask of the same shape as the X-ray image to be investigated. Thus, all image pixels are classified according to their property of lying inside or outside the assumed collimator shadow. To determine random position, shape and size of the collimator, a centroid location along with width and height are sampled from a truncated normal distribution, yielding a rectangle as shown in Fig.2a. Due to practical constraints in clinical settings, e.g. with bedridden patients, the resulting images may exhibit rotations or distortions that deviate from the desired orientation. To accommodate these cases, a randomized rotation and distortion transformation are applied to the binary image's rectangle, as shown in Fig.2b and Fig.2c."}, {"title": "Collimator Physics", "content": "To account for collimator attenuation, the binary mask is adjusted by assigning its zeros to a damping factor, resulting in the mask Md. The non-infinitesimal size of the focal spot causes blurring of the collimator edges at the detector as shown in Fig. 3a. As the intensity profile of the radiated X-rays is Gaussian distributed in space, this effect can be approximated by convolving the mask Ma with a Gaussian kernel Gb. Hence, the damping operation can be applied to the input image Iinput as follows:\nL(Iinput) = (Md * Gb). Iinput\n(1)"}, {"title": "Scattered Radation Simulation", "content": "Incoherent scattering describes the process of an high energetic photon colliding with matter, resulting in a deflection from the initial pathway as shown in Fig.3b [8]. Due to this fact it predominantly affects X-ray imaging depending on the matter the photon interacts with. A collimator influences the number of photons that pass through the patient, altering the scatter characteristics. This change must be accounted for in the simulation. According to comprehensive Monte Carlo simulation studies [14], it was shown that intensities created by scattered photons are in a range from 1.2%-2% of the primary intensity, e.g. for thorax images of c-arm systems without anti scatter grids. In relation to the dampened intensities by the collimator, contributing 2%-4% of the primary intensity based on empirical analysis, scatter has a significant influence."}, {"title": "Scatter Estimation", "content": "The intended pipeline requires a methodology capable of modeling the distribution of scattered photons in a collimated X-ray image. Ohnesorge et al. [13] present a convolution kernel based scatter estimation that can be utilized for our application. At first, they define a scatter potential Sp which is defined as follows:\nSp(IIo) = c.(\u03b1c(IIo)\u03b2)\n(2)\nThe input image I and the primary intensity Io are modified by three hyper parameters a, \u03b2 and c."}, {"title": "Scatter Correction", "content": "Given the presented framework, this part of the pipeline follows a two-step process. First, the scatter present in Iinput is removed, as it does not match the scatter of a real collimator specified by L(Iinput). To achieve this, we employ the scatter estimation method proposed by Ohnesorge et al., as depicted by the following equation, in order to obtain a scatter-free image, Isc.\nIsc = Iinput - Se(Iinput)\n(4)\nIn the second step, the collimated image Is with the corresponding scatter is simulated. Eq. 1 is applied to collimate the scatter free image. The corresponding scatter map is generated and added to the image as following:\nIs = L(Isc) + Se(L(Isc))\n(5)"}, {"title": "Poisson Noise Simulation", "content": "Due to the quantum properties of light, photons exhibit random arrival times. Hence, there exists a level of uncertainty regarding the received signal. The probability for z photons arriving at one pixel at the detector can be modeled by the Poisson distribution, which is defined as\nP(x) = (Xe-z)/z!\n(6)\nIt is dependent on the parameter A that represents the average rate at which an event occurs, thus the mean arrival rate of the photons.\nThe damping of real collimators by a factor a = [0,1] causes a reduction of the mean photon arrival rate A to \u03b1\u03bb and hence, an increase in noise in the image. Since for a Poisson distribution X = \u03c3 = \u03bc holds true, the altered SNR is defined with a new mean \u03bc\u03b7 and variance on respectively as\nSNR \u03bc\u03b7/\u03c3\u03b7 = \u03b1\u03bb/\u0393\u03b1\u03bb = \u221a\u03b1.\n(7)\nTherefore, besides scaling the intensities in the region of the simulated collimator, the noise level has to be increased to account for the increased uncertainty in the number of arrived photons. So far, applying our collimator mask did change \u03bc \u03c4o \u03b1\u03bcand \u03c3\u03c4o \u03b1\u03c3, remaining the SNR unchanged. To compensate for this, we add a normal distribution N(0,\u03c3\u03b1) to the signal, to get the right SNR [3] [4]:\n\u03b1\u03bc/\u221a\u03b1 = \u221a\u03c32\u03b1 + \u03b1\u03bb\nRearranging the equation yields \u03c3\u03b1 = \u221a\u03bb\u00b7 (1 \u2212 a).\n(8)"}, {"title": "2.2 Experiments", "content": "Real vs. Simulated: For the purpose of evaluation, the pipeline's output is examined by acquiring X-ray images of an anthropomorphic thorax phantom. The acquisitions include both open field and a collimated image, approximately to the lungs. We use our pipeline to simulate a matching collimator on the open field X-ray image and compare that image to the physically collimated image. To perform a detailed analysis, various image patches are extracted and quantitatively analyzed.\nApplication Case DNN: Using the augmentation method described, we evaluate its effectiveness in simulating collimators within a simple deep learning framework. We generate samples and random labels on-the-fly for 1500 real in-house X-ray images with collimators being manually cropped out. This is called SimNet. In addition, we trained a second DDN, referred to as RealNet, with the uncropped images containing the real collimators and hand-labeled masks. This allows to inspect if it is possible to replace real collimated images with simulated images of our pipeline.\nBoth DNNs are based on the DeepLabV3 architecture [2], classifying pixels as collimated or non-collimated, utilizing the Dice metric as a loss function and the ADAM optimizer during 500 epochs of training. Evaluation is performed on three datasets calculating the Dice score: a subset of 80 randomly extracted training images, 30 challenging cases with dark attenuating line-shaped implants, and 20 images showing detector line artifacts. RealNet is evaluated with the real collimator version. Furthermore, we check SimNets performance on real and simulated versions of the test sets data in order to reveal the pipelines authenticity and generalization on authentic data."}, {"title": "3 Results", "content": null}, {"title": "3.1 Framework Validation", "content": "Fundamentally, the goal of the simulation pipeline is to generate real collimator intensity distributions. On the one hand, the Figures below show that the desired image impression can be achieved.\nOn the other hand, uncertainties arising from the inherent approximations made within the pipeline can be identified. The scatter's Gaussian distribution, attributable to the simulation methodology, is distinctly discernible and exhibits a discrepancy from the actual scatter behavior. To obtain a more detailed representation of this observation, we proceed with showing the intensity distribution along the dashed line indicated in Fig.6. Leveraging the understanding of the impact of a real collimator on images is achieved by showing the real collimator image together with the open field image in Fig.5a. Subsequently, Fig.5b presents the same for the real collimator and the simulated collimator, confirming high resemblance from qualitative point of view."}, {"title": "3.2 Network Evaluation", "content": "The performance of the DNN based on pipeline augmentation (SimNet), as presented in Table 2, demonstrates that it achieves slightly better results on simulated data, which can be attributed to its training on such data. However, the"}, {"title": "4 Discussion", "content": "The presented X-ray image processing pipeline effectively simulates the properties of real collimators by incorporating key physical effects such as scattered radiation and quantum noise, adapting them to the randomly generated labels that define the synthetic collimators shape and location. This approach enables the generation of an unlimited amount of collimator training data. The realism of the generated characteristics is both qualitatively and quantitatively validated.\nWhen applied to a dataset of real X-ray images within a DNN environment, the pipeline demonstrates a significantly close performance on real test collimators compared to the simulated ones. Furthermore, it outperforms the corresponding DNN based on training with real collimators and hence no augmentation, affirming the effectiveness of the proposed approach."}]}