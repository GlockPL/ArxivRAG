{"title": "FragNet: A Graph Neural Network for Molecular Property Prediction with Four Layers of Interpretability", "authors": ["Gihan Panapitiya", "Peiyuan Gao", "C Mark Maupin", "Emily G Saldanha"], "abstract": "Molecular property prediction is a crucial step in many modern-day scientific applications including drug discovery and energy storage material design. Despite the availability of numerous machine learning models for this task, we are lacking in models that provide both high accuracies and interpretability of the predictions. We introduce the FragNet architecture, a graph neural network not only capable of achieving prediction accuracies comparable to the current state-of-the-art models, but also able to provide insight on four levels of molecular substructures. This model enables understanding of which atoms, bonds, molecular fragments, and molecular fragment connections are critical in the prediction of a given molecular property. The ability to interpret the importance of connections between fragments is of particular interest for molecules which have substructures that are not connected with regular covalent bonds. The interpretable capabilities of FragNet are key to gaining scientific insights from the model's learned patterns between molecular structure and molecular properties.", "sections": [{"title": "1 Introduction", "content": "Molecular property prediction is a crucial component of material discovery and design in many modern scientific applications including drug design, energy storage material discovery, catalysis and agrochemicals. Despite the availability of a large number of machine learning models [1] for molecular property prediction, there is often a trade-off in the ability of models to provide highly accurate predictions versus their ability to provide interpretability of their predictions to enable scientific insights. In this work, we introduce a graph neural network architecture called FragNet which is not only capable of achieving prediction accuracies comparable to or exceeding the accuracies of the current state-of-the-art models but also has the ability to provide insight into four levels of molecular substructures which are the atoms, bonds, fragments and fragment connections. In other words, with this model, one can understand which atoms, bonds, molecular fragments and also which connections between molecular fragments play critical role in predicting a given molecular property. By enhancing the model with the ability to reason about the connections between fragments, we provide improved representations for molecules with substructures that are not connected with regular covalent bonds, such as salts and complexes.\nThere are several prior works which implement deep learning models which leverage attention mechanisms which can provide values for different types of molecular substructures. The AttentiveFP [2] and MoGAT [3] models provide atom level importance values. The work by Wu et al. [4] provides fragment level attention. However, their work is limited in the range of molecular properties on which it evaluates, as it only provides results for the ESOL dataset [5] using a random train-test split configuration. In contrast, our work provides prediction results for several benchmark datasets in MoleculeNet [6] while using more challenging scaffold splitting method [7]. This provides a more comprehensive and robust understanding of how the reasoning of the molecular property prediction models is affected by the target property.\nIn addition to demonstrating the strong property prediction performance of the FragNet model across this challenging set of tasks, we also demonstrate the utility of the multi-layered interpretability mechanisms of the through several case studies on a selection of property prediction tasks. We use model attention weights and contribution values to investigate the reasoning used by the model for both individual molecular predictions as well as aggregated across multiple predictions, to identify the key molecular constituents that drive property variations. To further validate the reasoning extracted from the models, we perform a comparative study of FragNet contribution scores with density functional theory (DFT) computations of electrostatic surface potentials. Finally, we develop and release a interactive browser application to make these types of interpretability studies accessible for other molecular property tasks."}, {"title": "2 Results", "content": "The FragNet model is based on a message-passing graph neural network architecture which reasons over four different graph-based representations of the molecular structure. An overview of the graph-based representations used by our model is shown in Figure 1. The data representation used by our model consists of four graph structures: atom-based, bond-based, fragment-based and fragment connection-based. The nodes and edges of the atom graph are atoms and covalent bonds respectively. In the bond graph, the nodes are bonds, while an edge in this graph is formed when two bonds have a common atom. The fragment graph is created by decomposing the molecules into substructures using a fragmentation scheme. In this work, we used BRICS fragmentation[14-16]. If the molecule is not a salt or a complex, the edges in the fragment graph are formed by bonds at which the fragments are split.\nIn the case of molecular complexes, where regular bonds do not exist between some fragments, we form 'virtual' connections to enable message passing between such disconnected substructures. Specifically, we create virtual connections between fragments that are linked by BRICS fragments. If a molecule cannot be decomposed into fragments, we treat the molecule itself as a fragment and establish a self-connection. For molecules composed of substructures that are not connected by covalent bonds, we create virtual connections by linking each fragment in one substructure to each fragment in the other.\nFinally, the fragment-connection graph represents the connections between fragments as nodes with an edge formed when the connections have a fragment in common. These connections can be regular and/or virtual bonds depending on the type of the molecule. An important benefit of the fragment-connection graph is that it gives the ability to understand the interactions between different substructures of the molecules. This is particularly useful when regular bonds do not exist between two substructures.\nThe FragNet model leverages a hierarchical approach among these graph-representations, using the learned representations of lower-level structures to initialize the features of the high-level structures in the each subsequent graph representation. Our model starts by creating the representation for a given molecule using the bond graph. The nodes in the bond graph are initially featurized using bond properties, while the edges in the bond graph are featurized using bond angles. As bond properties we considered bond type (single, double, triple, aromatic), whether the bond is considered to be conjugated, whether the bond is in a ring and stereochemistry of the bond. The node representation of the bond graph is updated using the graph attention mechanism [17]. The updated node features of the bond graph are then used as the initial edge features of the atom graph, as indicated by the yellow arrow in Figure 1(a). Using these edge features, the atom graph is updated, also using the graph attention mechanism. Once updated,\nThe fragment graph is updated following a similar procedure. For the initial node features of the fragment graph, we use the summed atom features from the atom graph a molecular representation is created by summing all the atom feature vectors of the atom graph."}, {"title": "2.1 Model", "content": ""}, {"title": "2.1.1 Prediction Accuracies", "content": "We test the performance of FragNet on multiple molecular property prediction tasks derived from the MoleculeNet benchmark including four regression tasks and three classification tasks. These tasks spanned a range of chemical, biological, and toxicity properties. Before performing property prediction training, the model was pre-trained on a set of self-supervised tasks as described in the Methods section. With the exception of CEP and Malaria, FragNet achieves accuracies comparable to or better than the current state-of-the-art for both regression and classification tasks. For CEP, the slightly lower accuracies may be attributed to fact that we only the first hyperparameter combination suggested by Optuna compared to thirty hyperparameter optimization runs conducted for the other datasets. This is due to the time constraints of training as the training set of CEP is large, with 23,982 molecules."}, {"title": "2.2 Interpretability", "content": "The primary distinction between FragNet and other models lies in its ability to interpret predictions based on four different types of substructures. Notably, FragNet can handle molecules with substructures that are not connected via covalent bonds, such as salts and complexes. We can analyze all four substructure types using two different mechanisms from the model - attention weights and contribution values. Attention weights are derived from the graph attention mechanisms from each of the four graph representations and provide insight into which substructures the model focuses on when making its predictions. Meanwhile, we can quantify the contribution of a given substructure to the prediction of a molecular property value [4]. This is achieved by first predicting the property for the entire molecule in the usual manner. Subsequently, another prediction is made after masking the substructure of interest, meaning the node features of this substructure are excluded from the prediction process. If the prediction with the masked substructure is lower than that of the unmasked molecule, the masked substructure is considered property-increasing. Conversely, if the prediction with the masked substructure is higher, the masked substructure is deemed to reduce the property value. Formally, the contribution is defined as follows:\nContribution = Propertyunmasked Propertymasked (1)"}, {"title": "2.2.1 Interpretation Case Study", "content": "We first demonstrate the interpretation capabilities of FragNet using a sample compound. In the subsequent sections, we analyse the insights that can be gained by using attention weights and contribution values using three prediction tasks: solubility, lipophilicity and cancer drug response. In the following discussions, we use the notation A(i) to denote an atom of type A with atom index i, and A(i)-B(j) to denote a bond connecting atoms A(i) and B(j).\nThe attention weights and contribution values of 1-Naphthyloxyethylethyl-beta-chloroethylamine hydrochloride from the solubility prediction model are illustrated in Figure 2. The largest atom attention weights are on the atoms in the vicinity of positively charged nitrogen, N(2) atom. This is expected as this region likely interacts most significantly with the solvent water molecules. The next largest weights are on four atoms in the aromatic ring and ether O(8). A significant attention on ether oxygen is also understandable as it can act as a hydrogen bond acceptor allowing it to interact with water molecules. These ether oxygen can also withdraw electrons from the adjacent -C2H2- group and donate them to double ring system[19].\nIn terms of bond attention weights, the largest weights are on the C(0)-C(1), C(3)-C(4), and C(6)-C(7) bonds. One atom of each of these bonds are connected to N(2)+. Note that these three bonds are part of fragments 0, 2, and 3. Examining the 3D structure of this molecule, we observe that these three fragments could cause steric hindrance to N(2)+. We hypothesize that the large weights on C(0)-C(1) and C(3)-C(4) could be attributed to two factors: (a) the steric effects caused by fragments 0, 2, and 3, and (b) the electron flow towards the N(2)+ atom, as alkyl groups generally exhibit electron-donating properties. It should also be noted that due to the presence of chlorine in fragment 2, its electron-donating capability might be less than that of fragment 0. Moreover, there could be an electron flow through C(6)-C(7) towards the double ring system because of the ether oxygen bonded to the fragment 3. Ethers are known to exhibit both electron-withdrawing and electron-donating effects [19]. In this molecule, it is possible that the ether oxygen is withdrawing electrons from fragment 3 and donating them to the double ring system. The large weight on the C(6)-C(7) bond could signify this interesting dynamic in electron flow, as it is situated between two electron-withdrawing atoms, O(8) and N(2)."}, {"title": "2.2.2 Substructure Analysis", "content": "In the following sections, we perform a quantitative study of the highly impactful substructures for predicting solubility, lipophilicity, and cancer drug response. To identify these substructures, we first filter the model predictions to those with low error to focus on cases where the model is correctly inferring the structure-property relationships. We then identify substructures which appear in multiple molecules and average their attention weights across all the predictions. Substructures which have high average attention across the predictions are likely to have a significant impact on the predicted property."}, {"title": "Atom and Bond Weights", "content": "Figure 3 illustrates the atoms with largest average attention weights for solubility, lipophilicity, and cancer drug response (CDR) prediction for molecules with absolute errors less than 0.1. It is observed that Nitrogen (N) and Carbon (C) play dominant roles in all three scenarios, followed by O and S. Compared to solubility and lipophilicity, F and Cl have a more significant impact on cancer drug response prediction.\nHighly weighted bonds in compounds making absolute prediction errors less than 0.1 are shown in Figure 4. The significance of the carbon-carbon (C-C) bond is greater for solubility and lipophilicity prediction than for cancer drug response prediction. It is unsurprising that the carbon-oxygen (C-O) bond is more critical for solubility prediction than for lipophilicity prediction, primarily because of the polarity of the C-O bond. Polar substances are more soluble in polar solvents like water."}, {"title": "Fragment weights", "content": "Next, we study the attention weight and contribution score distributions for the fragment-level substructures. In the left panel of Figure 5, we present the attention weight distributions of highly weighted fragments in the context of solubility prediction. Meanwhile, the fragments associated with largest and smallest contribution values are shown in the right panel of Figure 5. These results are based on test set predictions with an absolute error below 0.1, and correspond to an R2 score of 0.99 between observed and predicted solubility values.\nWe find that the fragments containing N are among the high weight fragments ([*]N([*])[*]) and high contribution value fragments (CN(C)[*], [*]). Nitrogen containing functional groups are known to be hydrophilic. Agreeing with the known chemistry, -OH which is also a well known hydrophilic functional group that has on average a positive contribution value.\nThe compounds containing [Cl-] are salt structures. Our analysis reveals that Cl is either the most significant or the second most significant fragment in all but one of the compounds containing Cl in our study set according to the attention weights. Additionally, these compounds contain N+, which ranks among the two most significant substructures in 8 out of the 14 compounds. The fragment weights for these 14 compounds are illustrated in Figure S1. Considering the chemical properties, Cl is likely to interact predominantly with the positively charged (N) atom. Consequently, the model's identification of these structures as the most important underscores its focus on the relevant substructures.\nDespite the presence of the polar C=O group, the substructures O = C([*])[*] and O = C([*])C[*] also have most of their contribution values between -0.5 and 0. This is likely because of the other fragments attached to these substructures. Upon further inspection, we found that the contribution of O = C([*])[*] is positive when one of the substructures attached to it is OH or NH2 (see Figure S2). This result is consistent with the well-known fact that the carboxylic acid group (O=C(C)OH) is hydrophilic. When we inspected the compounds where O = C([*])[*] has negative contributions, we find that in majority of them O"}, {"title": "Fragment-Fragment Connection Weights", "content": "The highly weighted fragment-fragment connections for predicting solubility, lipophilicity, and drug response are shown in Figure 9. In most cases, these connections involve oxygen (O) or nitrogen (N) atoms. The presence of N-H connections is notably important for lipophilicity prediction. Additionally, C=O connections are also observed to be crucial for determining all three properties. In particular, the interaction between [*]CC[*] and oxygen is significant for both solubility and drug response predictions. Non-covalent interactions between CC[*] and substructures containing halogen atoms are also noteworthy, as observed in the solubility datasets. Upon close inspection, we found that in almost all cases, these ethyl groups are attached to electron-donating N or O atoms. Therefore, we believe these interactions signify non-covalent interactions between the electronegative group and the anionic substructure. Also, because of the electron donating nature of the ethyl groups, it is possible that there is an attraction between Cl- and slightly positively charged ethyl groups. This ethyl halogen interaction is also observed for when Cl- is the anion."}, {"title": "2.3 Additional Analysis", "content": ""}, {"title": "2.3.1 Model Embeddings", "content": "To further demonstrate the effectiveness of FragNet's representations in distinguishing different classes of molecules, we present UMAP results in Figure 10 which show the 2D projection of the embeddings from the layer immediately preceding the final linear layer of the model. The embeddings from this layer should include a condensed representation of the molecular structure that encodes the information necessary for predicting the molecular property. Therefore, the groupings of molecules in this space provides insight into the reasoning used by the model to infer the target property. For solubility, we observe that some molecules containing hydrophilic and hydrophobic fragments are located in separate regions in the embedding space."}, {"title": "2.3.2 Validations using Density Functional Theory (DFT) calculations", "content": "To further investigate the interpretability of FragNet, we calculated the electrostatic surface potentials of some molecules that had the FragNet model trained on solubility predicted with high accuracy using Density Functional Theory (DFT). Regions with electrostatic surface potentials (absolute value) greater than 10 were designated as polar areas, while those with potentials less than 10 were classified as non-polar areas. For each molecule, the ratio of the non-polar area to the polar area (NPR) was then calculated for the fragments. A larger NPR indicates a fragment with lower expected polarity. Therefore, we expect fragments with high NPR values to have negative or small contribution values. We observe this trend is in some molecules, as shown in Figure 11. This observation is prominent in highly hydrophobic molecules. Specifically, in molecules where the total NPR is greater 1, the average fragment contribution is -1.19, and in molecules where the total NPR is less than 1 the average fragment contribution is -0.35. In Table S1, we provide the fragment contribution and NPR values for 16 molecules."}, {"title": "2.3.3 Interactive Browser Application", "content": "We are also releasing the code for a web browser-based application that permits users to edit molecules and examine how attention weights vary across different substructures (Figure 12). This tool is designed for educational purposes and small-scale molecule design. It supports fragmenting a molecule using both BRICS, Murcko, and BRICS+Murcko fragmentation schemes. Currently, users can visualize atom, bond, and fragment weights, as well as fragment contributions. Additionally, substructure weights and substructure-substructure connection weights are displayed."}, {"title": "3 Conclusion", "content": "We developed a new graph neural network (GNN) architecture capable of providing model interpretations using atoms, bonds, fragments, and fragment connections. To the best of our knowledge, this is the first GNN architecture that accounts for message passing between non-covalently bonded fragments, thereby creating an improved representation for salts and ionic liquids. The prediction accuracies of our model, FragNet, are comparable to the latest state-of-the-art models. Fragment masking allows for the determination of fragments that enhance or diminish property values, a capability particularly useful in molecular design applications. We find that the model correctly focuses on fragments that most affect solubility, lipophilicity, and drug response based on known chemical properties, thus validating the FragNet architecture. Our code is publicly available at github/fragnet, and we have also provided an interactive web-based application for editing molecules and visualizing the corresponding attention weights of the substructures."}, {"title": "4 Methods", "content": ""}, {"title": "FragNet Architecture", "content": "The importance of node j and the edge connecting nodes i and j to node i is defined by $a_{ij}^{bond-graph}$ in Equation (2).\n$a_{ij}^{bond-graph} = \\frac{exp(LeakyRelU (M_{i,j}))}{\\Sigma_{k\\in N(i)} exp(LeakyRelU (M_{i,k}))}$, (2)\nwhere,\n$M_{i,j} = a[W^h\\bar{h_j}||W^h\\bar{h_i}||W^b e_{i,j}]$, (3)\n$h_j$ is a feature vector of a neighboring node of node i in the bond graph. Note that these nodes correspond to bonds in the atom graph. $\\bar{h_i}$ and $\\bar{h_j}$ trainable weight vectors. $e_{i,j}$ is the feature vector for the edge connecting nodes i and j in the bond graph. These attention weights determine the level of impact that each other bond has $h_j$ in updating the learned representation of a given bond, $h_i$.\nThe updated node features of the bond are calculated as,\n$h_i^{bond-graph} = \\Sigma_{j \\in N(i)} a_{ij}^{bond-graph} Wh_j^{bond-graph}$. (4)\nWe do not consider self edges in the bond graph, as it can significantly increase the computational cost. Hence $N(i)$ includes only the first nearest neighbors.\nWe then use these $h_i^{bond-graph}$ as the edge features of the atom graph. As in the case of bond graph, the attention coefficients of the atom graph will be computed considering both node features and edge features. The initial node features of the atom graph are based on the atomic properties like atom type, number of valence electrons, etc. For the message passing in the atom graph, we do consider self edges (the edges connecting an atom to itself). The edge properties of the self edges are initialized as a vector of zeros having the same dimension as $h_i^{bond-graph}$.\n$h_i^{atom-graph} = \\Sigma_{j \\in N(i)} a_{ij}^{atom-graph} Whatom-graph$ (5)\nOur model also considers a graph of molecular fragments. We use BRICS fragmentation to identify the fragments. In the case of regular molecules (not salts or complexes), the edge between two molecular fragments is a regular covalent bond. In the case of molecules with isolated fragments (like salts and complexes), where regular covalent bonds do not exist between some fragments, we create virtual bonds connecting each such isolated fragment to every other fragment (illustrated in Figure 1 [c] ). There are some molecules which cannot be fragmented."}, {"title": "Pretraining and Finetuning", "content": "We pretrained FragNet using 2,054,100 molecules from the dataset used by Uni-Mol[40]. The pretraining is based on the method outlined in the reference [41] and focuses on minimizing losses based on the predictions of bond length, bond angle, dihedral angle, and conformational energy of the molecule.\nHyperparameter tuning was performed using the Optuna package [42]. For small datasets we used a regression head with four layers. The number of nuerons in each layer were allowed to take values from 64 to 2048 in steps of 64. We also tuned the activation function (with options relu, silu, gelu, celu, selu, rrelu, relu6, prelu, leakyrelu) and batch size (with options 16, 32, 64, 128)."}, {"title": "DFT calculation", "content": "Density functional theory (DFT) calculations were performed using the B3LYP[43, 44] functional with ORCA package. [45] The geometries of the molecules were optimized with def2-SVP basis set. Single point energies were calculated with def2-TZVP basis set. Vibrational frequencies were calculated for validation of stable configuration.\nAn effect of implicit solvent model with water was included via Conductor-like Polarizable Continuum Model (CPCM) model.[46] The surface charge potentials were calculated by Multiwfn software. [47]"}]}