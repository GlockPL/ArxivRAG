{"title": "Spatio-temporal neural distance fields for conditional generative modeling of the heart", "authors": ["Kristine S\u00f8rensen", "Paula Diez", "Jan Margeta", "Yasmin El Youssef", "Michael Pham", "Jonas Jalili Pedersen", "Tobias K\u00fchl", "Ole de Backer", "Klaus Kofoed", "Oscar Camara", "Rasmus Paulsen"], "abstract": "The rhythmic pumping motion of the heart stands as a cornerstone in life, as it circulates blood to the entire human body through a series of carefully timed contractions of the individual chambers. Changes in the size, shape and movement of the chambers can be important markers for cardiac disease and modeling this in relation to clinical demography or disease is therefore of interest. Existing methods for spatio-temporal modeling of the human heart require shape correspondence over time or suffer from large memory requirements, making it difficult to use for complex anatomies. We introduce a novel conditional generative model, where the shape and movement is modeled implicitly in the form of a spatio-temporal neural distance field and conditioned on clinical demography. The model is based on an auto-decoder architecture and aims to disentangle the individual variations from that related to the clinical demography. It is tested on the left atrium (including the left atrial appendage), where it outperforms current state-of-the-art methods for anatomical sequence completion and generates synthetic sequences that realistically mimics the shape and motion of the real left atrium. In practice, this means we can infer functional measurements from a static image, generate synthetic populations with specified demography or disease and investigate how non-imaging clinical data effect the shape and motion of cardiac anatomies.", "sections": [{"title": "1 Introduction", "content": "During a heart beat, the heart chambers undergo a series of complex 3D deformations and the morphology as well as the motion of contraction and relaxation are critical functions to pump blood to all human organs. Such shape and motion can be captured by Computed Tomography (CT), where Cardiac Functional Analysis (CFA) has enabled fast acquisition with 20 (or more) time frames per heartbeat. The cardiac anatomy and motion vary widely between individuals and it is therefore of interest to disentangle the individual characteristics from that of clinical factors such as gender, age or disease. Traditional shape modeling based on shape correspondence and point distribution models [9] can be used for generative modeling, but the integration of clinical data in such models is currently an unsolved problem. Modeling the spatio-temporal characteristics of the heart has been achieved through 4D registration methods [21] or by building spatio-temporal atlases [13,16]. More recently, deep learning based methods have been used to learn the distribution over plausible cardiac shapes based on dense point clouds [20,5], meshes [6] and voxel volumes [7]. Modeling the temporal movement is usually approached by mapping the anatomy at one time frame to another time frame (ie. end-diastole (ED) to end-systole (ES) or vice versa) and has been handled using i.e. mesh U-nets [4], spatio-temporal graph convolutions [15] or adversarial methods in the image domain [17]. Generative frameworks have incorporated non-imaging clinical data with methods for generating cardiac ultrasound images with specified functional properties [24] and Magnetic Resonance Images (MRI) with specified anatomical characteristics [2], pathology [10] or biophysical parameters [22]. Generation of spatio-temporal cardiac anatomies based on clinical demography has been approached by [23], who learned a temporal latent space based on a recurrent neural network and generated cardiac anatomies represented by voxelized labelmaps. The explicit voxelmap representation however suffer from large memory requirements and are not ideal for representing the smooth and often highly detailed cardiac anatomy. Implicit representations (such as distance fields) have shown to be an effective representation of complex shapes for medical image segmentation [27,1,28] as well as shape generation in 3D [18,8] and 4D [11]. In contrast to other representations, the continuous nature of neural distance fields allows for modeling highly complex structures without requiring correspondence between samples or have memory requirements growing cubically with the image resolution.\nWe propose a novel conditional generative model architecture, that integrates clinical demographic data into the generation of spatio-temporal signed distance fields (SDFs) of dynamic anatomies. The model is tested for modeling the left atrium (LA) and its complex extrusion; the left atrial appendage (LAA). The shape and motion of the LA and LAA are related to the risk of thrombus formation and stroke [12] and a detailed representation of the spatio-temporal dynamics are therefore of interest. Capturing the small details of the LAA anatomy would require a very large voxel map and obtaining point correspondence across the widely varying samples are unattainable [26]. The use of a neural SDF representation allows for modeling complex surfaces jointly in space and time, while the auto-decoder formulation enables the derivation of two separate latent spaces that disentangles the patterns related to the clinical demography from those related to individual variation. The proposed method are used to complete the full cardiac cycle based on a single time frame and to generate realistic synthetic anatomical sequences with specified clinical demography."}, {"title": "2 Materials and methods", "content": "Overall framework\nA spatio-temporal neural distance field is a neural function that maps an arbitrary space-time coordinate x = (p,t), consisting of the 3D coordinate p and the time index t, to the signed distance d = fo(x). The surface represented by the neural SDF can thus be considered the decision boundary separating SDF<0 from SDF>0. To learn such decision boundary for a single sequence, the network is presented with a set X consisting of space-time coordinates x and corresponding SDF-values d, such that X := {(x, d) : SDF(x) = d}. The network parameters are optimized using the clamped L1-loss between the true and predicted SDF-values in this set:\n$\\mathcal{L}(f_{\\theta}(x), d) = |\\text{clamp}(f_{\\theta}(x), \\delta) - \\text{clamp}(d, \\delta)|$ (1)\nwhere the clamping parameter \u03b4 controls the distance from the surface, over which we expect to learn an accurate distance field. The continuous spatio-temporal SDF can then be approximated as SDF(S) \u2248 f\u03b8(S), where S refers to all possible space-time coordinates.\nTo model multiple anatomical sequences with the same neural network, we introduce a latent vector to represent each of the anatomical sequences indexed by n = {1, ..., N}. This latent vector is concatenated with the space-time coordinate and given as input to f\u03b8, where it enables the neural function to create decision boundaries unique to each anatomical sequence. We propose to learn this latent vector as two separate parts: the clinical demographic latent vector zc representing an embedding of the clinical demography (gender, age and SBP) and a residual latent vector zr representing the individual information that cannot be described by the clinical demography. zc is embedded from the clinical demography c with a neural network such that zc = g\u03b8(c). The residual latent vector zr is a learnable embedding unique to each of the sequences in the training set (zr,1, zr,2, ..., zr,N) and is optimized jointly with f\u03b8 and g\u03b8 using an auto-decoder formulation. The use of an auto-decoder circumvents the need for designing and training a 3D data encoder, but requires test time optimization which is slightly more time consuming and may risk converging to a local solution. To optimize the autodecoder parameters, we sample K = 110.000 space-time coordinates for the 20 time frames (t = {0%, 5%, ..., 95%} of the cardiac cycle) in each of the N = 290 anatomical sequences in the training set and denote each of these samples sn,k,t and the corresponding SDF value dn,k,t. The loss over the predicted and measured SDF-values across all N.T.K samples are computed as:\n$\\underset{\\theta, g_{\\theta},\\{z_{r,n}\\}_{n=1}^N}{\\text{arg min }} \\sum_{n=1}^{N} \\sum_{k=1}^{K} \\sum_{t=0\\%}^{95\\%} \\mathcal{L}(f_{\\theta}(g_{\\theta}(c_n) \\oplus z_{r,n} \\oplus s_{n,k,t}), d_{n,k,t}) + \\frac{\\lambda}{2} ||z_{r,n}||_2^2,$ (2)\nSequence completion The proposed model can complete an anatomical sequence based on the clinical demography c and the static anatomy at a given time frame tgiven. The clinical demography are mapped to the clinical demographic latent space as zc = g\u03b8(c), whereas the individual latent vector zr is found using test-time optimization. We sample K = 110.000 space coordinates (sk|tgiven), measure the distances to the static anatomy at tgiven and optimize over the values in zr while locking the parameters of f\u03b8 and g\u03b8:\n$\\underset{z_r}{\\text{arg min }} \\sum_{k=1}^{K} \\mathcal{L}(f_{\\theta}(g_{\\theta}(c) \\oplus z_r \\oplus s_{k|t_{\\text{given}}}), d_{k|t_{\\text{given}}}) + \\frac{\\lambda}{2} ||z_r||_2^2,$ (3)\nThe full anatomical sequence can be reconstructed by evaluating the SDF at all points on a uniform grid for the desired time frames and extract the zero-level isosurface using Marching Cubes [14].\nSequence generation The model can generate new plausible anatomical sequences by sampling randomly in the individual latent space zr and concatenate it with the embedding of the clinical demography. In the derivation of the auto-decoder formulation of neural distance fields (see [18]) the prior distribution over the latent variables zr is assumed to come from a zero-mean multivariate Gaussian distribution. To generate new sequences with individual shape and motion characteristics, we sample zr from such distribution.\nImplementation details\nThe model was implemented with PyTorch [19] and trained on a NVIDIA RTX A4000 (16GB) for 9 hours. The clinical demographic input is passed as a vector with one-hot encoded gender (male/female) and age-group (<50,50-59,60-69 and >69) and uses the continuous SBP normalized to [0;1]. Both f\u03b8 and g\u03b8 are implemented as a multi-layer perceptron (MLP). f\u03b8 follows the architecture from [18], whereas g\u03b8 consist of two hidden layers with each 128 neurons. We use 64 dimensions for both zc and zr. During training we randomly dropout zr in 20% of the training steps, which was found necessary to force the network to make use of the clinical demography. All surfaces are extracted from an SDF evaluated on an uniform grid sized 1283.\nData and preprocessing\nA dataset of 4D geometries was extracted from CFA scans of 667 randomly selected participants from the Copenhagen General Population Study. All subjects are asymptomatic individuals from the general population, with 301/366 male/female participants, aged 41-89 years and with known systolic blood pressure (SBP). Participation was conducted following the declaration of Helsinki and approved by the ethical committee (H-KF-01-144/01). Each CFA series consists of a cardiac computed tomography angiography (CCTA) image at 20 equally spaced time steps during one heart beat (t = 0%, 5%, ..., 95%). Each image was segmented using an automatic deep learning based segmentation method specifically developed for LAA segmentation from CT images [27]. We aligned all anatomies at t = 0% by matching the center-of-mass, fine-tuned with a rigid transformation based on iterative closest point (ICP)[3] and applied the found transformation to all time frames. Finally, each anatomy was scaled with a fixed factor such that all surfaces lie within the unit-sphere. We follow the sampling strategy from [27] and sample 10.000 random samples within the unit sphere and 100.000 samples in the vicinity of the surface based on the shape diameter at each vertex for each time frame. All transformations and point-to-surface distances were obtained using VTK [25]. We split the dataset randomly with 290/10/367 anatomical sequences for training/validation/testing."}, {"title": "3 Experiments and results", "content": "We evaluate the proposed methods on two different tasks - anatomical sequence completion based on a single static anatomy as well as the clinical demography and anatomical sequence generation based only on the clinical demography.\nSequence completion \u2014 Evaluating the sequence completion abilities of a generative model assure us that the model has learned a descriptive distribution of both shape and movement from the sequences in the training data. We report results for completion based on the static anatomy at t = 0% as this allows for comparison to [23]. We evaluate the completion quality using symmetric Chamfer Distance (CD) and Hausdorff Distance (HD) between the predicted and true surfaces at each time step. The ability to capture the dynamic movement is measured by comparing the maximum volume (Vmax), Fractional Change (FC = (Vmax - Vmin)/Vmax)) and Cyclic Change CC = Vmax - Vmin between the true and completed sequences. We have compared against the default CHeart implementation [23] trained on our dataset as well as investigated the effect of removing the clinical demography from our model, by setting the clinical demography vector c to a zero-vector for all samples during training and testing. We observe that the proposed method significantly outperforms CHeart [23], which is attributed the joint spatial and temporal modeling and the increased representational power from the SDF. An ablation study on the clinical demography, demonstrate a positive effect on estimating the functional parameters (FC, CC and Vmax) even though the reconstruction errors do not show an improvement.\nFigure 2 shows the completion results from three different test cases. The blue volume curve is an example of a normal atrial function consisting of a relaxation phase (t = 0% to first peak), a passive emptying phase (first peak to plateau at t\u2248 75%) and an active emptying phase (plateau to t = 95%). The red curve is an example of an abnormal atrial motion dominated by passive emptying. We observe that the proposed model correctly completes both of these sequences, which indicates that the model are able to learn individual motion patterns.\nSequence generation The proposed method can be used to generate unique sequences with specified clinical demography. Figure 4(left) shows four synthetically created samples based on the same clinical demography. We observe that all generated anatomies are continuous and smooth surfaces, with volumes indicating normal atrial motion. It is evident that multiple plausible LA and LAA geometries and motions exist despite being generated from the same clinical demography. This diversity is attributed to factors not included in the model (ie. height, weight, smoking status, etc.), but also individual traits that cannot be directly related to demography or disease. To evaluate the models ability to generate realistic cohorts, we generate a synthetic counterpart to the test set, where a synthetic anatomical sequence is generated based on the clinical demography of each person in the test set. Since multiple plausible sequences can be generated based on the same clinical demography, we do not compare the generated surfaces directly to those from the test set. Instead, Figure 3 shows the distribution of measured FC in both the real and synthetic data in eight subgroups split on age and gender. Both the real and the generated data exhibit similar trends; the FC decreases with age and are higher in women compared to men. The longer tails in the real data are attributed outliers errors made by the automatic image segmentation, where the volume is over- or underestimated in one or more time frames.\nDemography manipulation \u2014 We sample a single individual vector zr and investigate the effect of changing the gender and age in the clinical demography input. Figure 4(right) shows how changing the demography alters the anatomical sequence. It can be noted that the shared zr ensures a relatively stable overall anatomy across all samples, but that associations are captured such that changing the gender from male to female for example results in a smaller LA volume. The blue/pink opaque circles in the Principle Component Analysis (PCA) plots in Figure 4 show the embeddings of the training data for male/female participants. We observe a clear gender separation in clinical demographic space, whereas the individual latent space shows no obvious gender separation. This supports our idea of zr as a residual latent vector and that the two spaces can be sampled independently."}, {"title": "4 Discussion and conclusion", "content": "We have presented a conditional generative model, that is capable of creating plausible temporal sequences of cardiac anatomy while taking patient demography into account. The neural SDF models the cardiac anatomy and movement jointly, and allows for generating smooth and detailed anatomical sequences with close resemblance to real anatomies. We showed that the proposed model outperforms a current state-of-the-art method for anatomical sequence completion and that it can be used to estimate functional parameters from the large pool of CT protocols, where only one or two best-phase images are acquired. In contrast to previous work, the versatility of the neural SDF representation allows for basing the sequence completion on any single time frame or even multiple scans (i.e. end-systolic and end-diastolic). We demonstrated that the model was able to learn abstract associations between the clinical demography and atrial shape and motion. We expect that the model can be extended with a larger collection of diverse non-imaging data, which will allow for generating synthetic populations with specific demography, disease status or biophysical constraints. Being able to generate realistic anatomical sequences of dynamically moving anatomies based on such conditions is a valuable tool for methods such as fluid simulation, operation planning and disease detection not only in the cardiac domain, but any domain where spatio-temporal models are of interest."}]}