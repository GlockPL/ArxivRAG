{"title": "SpaDiT: Diffusion Transformer for Spatial Gene Expression Prediction using scRNA-seq", "authors": ["Xiaoyu Li", "Fangfang Zhu", "Wenwen Min"], "abstract": "The rapid development of spatial transcriptomics (ST) technologies is revolutionizing our understanding of the spatial organization of biological tissues. Current ST methods, categorized into next-generation sequencing-based (seq-based) and fluorescence in situ hybridization-based (image-based) methods, offer innovative insights into the functional dynamics of biological tissues. However, these methods are limited by their cellular resolution and the quantity of genes they can detect. To address these limitations, we propose SpaDiT, a deep learning method that utilizes a diffusion generative model to integrate scRNA-seq and ST data for the prediction of undetected genes. By employing a Transformer-based diffusion model, SpaDiT not only accurately predicts unknown genes but also effectively generates the spatial structure of ST genes. We have demonstrated the effectiveness of SpaDiT through extensive experiments on both seq-based and image-based ST data. SpaDiT significantly contributes to ST gene prediction methods with its innovative approach. Compared to eight leading baseline methods, SpaDiT achieved state-of-the-art performance across multiple metrics, highlighting its substantial bioinformatics contribution.", "sections": [{"title": "Introduction", "content": "Single-cell RNA sequencing (scRNA-seq) can represent the entire transcriptome of a specific cell in an organ, providing an excellent perspective for in-depth study of various behaviors and mechanisms between cells [1]. However, since scRNA-seq must undergo sample tissue dissociation, it also leads to the inability of scRNA-seq to capture the spatial distribution and spatial information of cells, which is often crucial for understanding the complex physiological processes between cells [2]. Therefore, spatial transcriptomics (ST) has emerged as an advanced technology that can retain spatial location information while measuring gene expression in tissue or cell samples [3]. This technology enables researchers to parse the spatial distribution of gene expression in tissues, enhancing the understanding of cell types, functions, interactions, and key details in development, disease, and biological processes.\nAt present, ST technology can be mainly divided into two categories: Based on next-generation sequencing technology (seq-based): such as 10x Visium [4], Slide-seq [5] and Stereo-seq [6], transcriptome-wide gene expression within a spatial point can be detected. Fluorescence in situ hybridization (image-based): such as seqFish [7] and MERFISH [8], can measure thousands of genes at the resolution of single cells, but they usually lack full transcriptome coverage, resulting in only a few hundred genes in actual sequencing. Although these two technologies can detect gene expression in the whole transcriptome range, their capture rate is low due to their resolution [9, 10]. The current solution mainly focuses on increasing the capture rate and predicting uncaptured genes by using scRNA-seq data to enhance ST data to improve its resolution [11, 12, 13].\nIn recent years, a variety of methods have been proposed to use scRNA-seq data to improve the resolution of ST data and predict uncaptured genes. These methods, such as Tangram [14], scVI [15], SpaGE [16], stplus [17], SpaOTsc [18], novoSpaRc [19], SpatialScope [20], stDiff [21]. They all assume that scRNA-seq data and ST data have similar expression distributions, and they identify the similarity between scRNA-seq cells and ST cells by detecting the expression patterns of shared genes. Then, these methods use similar scRNA-seq cells to predict the unmeasured part of ST data. However, due to the sparse nature of scRNA-seq and ST data, and the reliance on common genes to calculate similarity, this poses a huge challenge to how to align the two data. In addition, simply using scRNA-seq as a reference for ST data prediction is difficult to avoid introducing batch bias of scRNA, which increases the difficulty of predicting unknown genes [22].\nIn this paper, we introduce a novel method named SpaDiT, which uses a conditional diffusion model to understand and generate unmeasured gene expression in ST data. Although"}, {"title": "Materials and methods", "content": "In this paper, we collected ten benchmark datasets (scRNA sequencing and spatial transcriptomics data) from different tissues of various organisms. As illustrated in Table 1, these datasets originate from various biological organizations and utilize differing sequencing platforms and technologies. They also vary in sample sizes, number of spatially measured genes, and missing data rates. Specifically, the sequencing platforms for single-cell data in these datasets include 10X Chromium, Smart-seq, and Smart-seq2. For spatial transcriptomics data, the platforms are seqFISH, MERFISH, 10X Visium, STARmap, and Slide-seqV2. These datasets are derived from different biological tissues, primarily from mouse and human breast cancer tissue sections.\nFor the implementation of SpaDiT, we adhered to the data preprocessing protocols as established in prior studies [35]. More specifically, we first removed genes with no expression from both the single-cell and spatial transcriptomics datasets. Subsequently, we screened the remaining genes to identify those that were highly expressed, using criteria based on the number of genes in each dataset.\nWe partitioned the processed data into training, validation, and test sets with ratios of 7:2:1, respectively. These subsets are mutually independent, with the test set being strictly separate from the training set. All reported results were derived solely from evaluations on the test set."}, {"title": "The architeture of SpaDiT", "content": "SpaDiT is a conditional diffusion-based deep generative model that enhances spatial transcriptomics data by leveraging single- cell RNA sequencing (scRNA-seq) data as prior information, aiming to accurately predict the expression of unmeasured or unknown genes. As illustrated in the Figure 1, SpaDiT takes two types of input data: a gene expression matrix from spatial transcriptomics data and another from scRNA- seq data. Utilizing a conditional diffusion model, SpaDiT uses scRNA-seq data as a conditioning factor to guide the model through the diffusion and denoising processes, thereby generating the targeted gene expression profiles for the spatial transcriptomic data. The SpaDiT architecture comprises three key modules: the Latent Embedding module for processing spatial transcriptomic data, the Condition Embedding module for processing scRNA-seq data, and the core network architecture: Diffusion with Transformer, which facilitates the integration and generation of data. In the following sections, we will introduce the main modules of SpaDiT."}, {"title": "Latent Embedding in SpaDiT", "content": "In the proposed SpaDiT, the latent embedding module is crucial. Instead of operating directly on real data, we work within an efficient, low-dimensional latent space, which is better suited for likelihood-based generative models. Therefore, we utilize an encoder to map the high-dimensional input data to a low-dimensional representation, and we train the diffusion model within this latent space.\nNotably, our proposed method involves two types of data input: spatial transcriptomics data (Xst) and ScRNA-seq data (Xsc). The genes in Xsc are divided into shared genes (Gshare) with spatial transcriptomics data and unique genes (Gunique). For the input of Latent Embedding, we define it as follows: for each sample (i,e., gene) x \u2208 Xst in the spatial transcription data, we integrate it with the scRNA-seq data x \u2208 Xsc, where xt and xc in Gshare are utilized as inputs. In latent embedding, we employ a simple feed-forward network to project xst and xc into the same dimensional space, concatenating the projected xst and xc as the output of the latent embedding, that is, xi = f (xst, xc)."}, {"title": "Condition Embedding in SpaDiT", "content": "The condition embedding module leverages scRNA-seq data as a conditioning factor in our model, integrating it into the diffusion process to guide the model in generating the"}, {"title": "Diffusion with Transformer in SpaDiT", "content": "The backbone network of our proposed SpaDiT is Diffusion Transformers (DiTs), a new architecture for diffusion models. For the backbone network model, we refer to previous work [36] and make modifications based on the challenges we encounter. Our backbone model has two types of input: x\u03c4, representing latent embedding, and x\u03c8, representing condition embedding. We initialize each residual block in the backbone network as an identity function and incorporate the condition embedding into the backbone. At each layer, we also perform scaling regression on all residual connections within the backbone, facilitating rapid model convergence.\nAfter the final DiT block, the gene expression token sequence needs to be decoded into output noise prediction and output diagonal covariance prediction. The shapes of both outputs are identical to the input in the original space, and a standard linear decoder is employed to achieve this. Finally,"}, {"title": "Training phase in SpaDiT", "content": "Here in, SpaDiT works with two types of input data: the spatial transcriptomics data Xst = {xsti}\u2208 Rnxp and scRNA- seq data Xsc = {xsci} \u2208 Rmxq. Among them, n and p respectively represent the number of genes and the number of spots in spatial transcriptomics data, and m and q respectively represent the number of genes and the number of cells in scRNA-seq data.\nThe training phase of SpaDiT is shown in the Figure 1 (A). We first mask the genes of the original spatial transcriptomics data according to a certain proportion, where the mask is divided into two parts: the part with an expression value of zero and the part with an expression value that is not zero. The input tensor of the training phase is defined as follows:\nxo = cst \u2295 csc\nwhere cst and csc are projection of xst and xsc by a simple feed-forward network.\nIn the realm of DDPMs [23, 37], consider the task of learning a model distribution p\u03b8 (x0) that closely approximates a given data distribution q(x0). Suppose we have a sequence of latent variables xt for t = 1,..., T, existing within the same sample space as xo, which is denoted as X. DDPMs are latent variable models that are composed of two primary processes: the forward process and the reverse process. The forward process is defined by a Markov chain, as follows:\nq(x1:T|x0) := \u220fT t=1 q(xt|xt\u22121),\nwhere q(xt|xt\u22121) := N(\u221a1 \u2212 \u03b2txt\u22121, and the variable \u03b2t is a small positive constant indicative of a noise level. The sampling of xt can be described by the closed-form expression q(xt|xo) =\nN(xt; \u221a\u03b1txo, (1 \u2212 \u03b1t)I), where \u03b1t := 1 \u2212 \u03b2t and \u03b1t is the cumulative product \u03b1t := \u220ft i=1 \u03b1i. Consequently, It is given by the equation xt = \u221a\u03b1txo + (1 \u2212 \u03b1t)e, with e \u223c N(0, I). In contrast, the reverse process aims to denoise xt to retrieve xo, a process which is characterized by the ensuing Markov chain:\np\u03b8 (x0:T) := p(xT) \u220fT t=1 p\u03b8(xt\u22121|xt), xT \u223c N(0, 1),\np\u03b8 (xt\u22121|xt) := N(xt\u22121; \u03bc\u03b8 (xt, t), \u03c3\u03b8 (xt, t)I),\n\u03bc\u03b8 (xt, t) = 1/\u221a\u03b1t (xt \u2212 \u03b2t/ \u221a1 \u2212 \u03b1te\u03b8(xt, t)),\n\u03c3\u03b8 (x, t) = \u03b21/2 \u221a1 \u2212 \u03b1t\nwhere e\u03b8(xt, t) is a trainable denoising function and\n\u03b2t = 1-\u03b1t-1/1-\u03b1t \u03b2t, for t > 1,\n\u03b21, for t = 1.\nSpaDiT aims to help models understand and estimate the expression of missing genes in ST data by utilizing scRNA-seq data as prior information, thereby enabling the model to better predict gene expression from ST data. We represent the data of the condition as x = x\u03c8. Therefore, our goal is to estimate the posterior p(((En,1 \u2212 m1) \u2295 ((En,1m2) \u2299 xo))|x), where En,1"}, {"title": "Inference phase in SpaDiT", "content": "We focus on improving the conditional diffusion model characterized by the inverse process described in Equation 7. Our goal is to accurately model the conditional distribution p(x\u03c4\u22121|x\u03c4, x) without resorting to approximations. To achieve this, we adapt the parameterization of DDPM from Equation 4 for the conditional setting. We introduce a conditional denoising function e\u03b8 : (X \u00d7 \u03c8 \u00d7 R) \u2192 x\u00d7 \u03c8 accepts conditional observation value x as input parameter. On this basis, we use e\u03b8 for parameterization, as follows:\n\u03bc\u03b8 (x, t|x) = \u03bc(x, t, s\u03b8(x, t|x)),\n\u03c3\u03b8 (x, t|x) = \u03c3(x, t)\nwhere \u03bc and \u03c3 are defined in Equation 4. Utilizing the function e\u03b8 and the data xo, we can simulate samples of x by employing the reverse process outlined in Equation 7."}, {"title": "Evaluation metrics", "content": "To evaluate the performance of SpaDiT and other baseline methods, we use five evaluation indicators: Pearson Correlation Coefficient (PCC), Structural Similarity Index Measure (SSIM), Root Mean Square Error (RMSE), Jensen-Shannon Divergence (JS) and Accuracy Score (AS) to evaluate the gene prediction performance of different methods on ten datasets. The specific definition of the evaluation metrics can be found in Supplementary Materials."}, {"title": "Baselines", "content": "We compared the performance of SpaDiT to eight baseline methods, with data processing procedures (e.g., normalization and scaling) consistent for each method. The specific baselines are as follows:\nTangram [14]: It is a method that can map any type of sc/snRNA-seq data, including multimodal data such as those from SHARE-seq, which can be used to reveal spatial patterns of chromatin accessibility.\nscVI [15]: It is a scalable framework for probabilistic representation and analysis of single-cell gene expression.\nSpaGE [16]: It is a method that integrates spatial and scRNA-seq datasets to predict whole-transcriptome expressions in their spatial configuration.\nstPlus [17]: It is a reference-based method that leverages information in scRNA-seq data to enhance spatial transcriptomics.\nSpaOTsc [18]: It is a method that relies on structured optimal transfer to recover the spatial properties of scRNA- seq data by exploiting spatial measurements of a relatively small number of genes.\nnovoSpaRc [19]: It is a method that reconstructs tissue based on this hypothesis and optionally improves the reconstruction by including a reference map of marker genes.\nSpatialScope [20]: It is a method to integrate scRNA- seq reference data and ST data using deep generative models.\nstDiff [21]: It is a method that capturing gene expression abundance relationships in scRNA-seq data through two Markov processes."}, {"title": "Results", "content": "To rigorously assess the SpaDiT method's capabilities in predicting gene expression, we conducted a comparative analysis with eight other widely recognized methods in the field. We used four key performance metrics, as outlined in subsection 2.3, to systematically evaluate both SpaDiT and the comparator baseline methods. The evaluation focused on computing the mean and variance of these metrics across all genes within each dataset. The results are depicted in Table 2.\nOur findings indicate that SpaDiT consistently achieves state-of-the-art (SOTA) performance in all four metrics across the ten examined datasets. However, it is important to note that in a few cases, SpaDiT slightly lags behind some established methods in one particular metric. This deviation provides critical insights into scenarios where SpaDiT might be further optimized.\nIn addition to these traditional metrics, we introduced an advanced scoring system, referred to as AS metrics, to further evaluate SpaDiT's performance. The results, illustrated in Figure 2, confirm that SpaDiT not only meets but often exceeds the performance benchmarks set by the baseline methods across all ten spatial transcriptomics (ST) datasets. The inclusion of AS metrics provides a more nuanced understanding of SpaDiT's predictive prowess, underscoring its robustness and effectiveness in diverse experimental conditions. This comprehensive approach solidifies SpaDiT's position as a leading method in gene expression prediction, highlighting its potential to significantly enhance the accuracy and reliability of spatial transcriptomics analyses.\nTo fully demonstrate the superior ability of the SpaDiT method in gene expression prediction, especially its advantages in maintaining the global and local structural characteristics of gene expression data, we used UMAP technology for visualization analysis for conducting in-depth comparisons with other benchmark methods.\nAs shown in the Figure 3, we conducted an analysis of ten different datasets. The results clearly show that the prediction results of the SpaDiT method (in orange) closely resemble the real gene expression data (in blue), with minimal perceptible deviation. This is in sharp contrast to the prediction results generated by several other methods, such as Tangram, scVI, SpaGE, stPlus, SpaOTsc, novoSpaRc, SpatialScope, and stDiff. Although the prediction results of these methods have their own focuses, compared with SpaDiT, they all fail to accurately capture the structural characteristics of real gene data and exhibit significant deviations. In addition, the UMAP analysis further underscores SpaDiT's superiority in maintaining data integrity, enabling it to accurately simulate complex biological information.\nTo fully demonstrate the accuracy of the SpaDiT method in predicting gene expression, we employed hierarchical clustering"}, {"title": "SpaDiT improves prediction accuracy of spatial gene expression", "content": "SpaDiT enhances the similarity of predicted gene expression in high-dimensional space"}, {"title": "SpaDiT preserves the similarity between genes", "content": "SpaDiT accurately predicts ST Spatial Patterns"}, {"title": "Robustness evaluation of SpaDiT across various sampling rates", "content": "Ablation studies: The impact of different modules of SpaDiT on model performance"}, {"title": "Discussion", "content": "In this paper, we present SpaDiT, a novel approach to predict unmeasured genes in spatial transcriptomics (ST) data. Methodologically, SpaDiT is significantly different from existing ensemble techniques. While traditional approaches primarily enhance ST data by aligning ST data to similar cells within a reference scRNA-seq dataset, SpaDiT employs a diffusion-based generative model that utilizes the inherent relationships within the gene expression data. This approach enables it to precisely model and generate spatial gene expression patterns.\nSpaDiT, as a conditional diffusion model, employs noise addition and denoising stages to learn complex relationships from scRNA-seq data. In the inference stage, SpaDiT incorporates raw ST data during the denoising process, resulting in accurate predictions of spatial gene expression. The application of diffusion models in genomics, especially transcriptomics, is relatively new, marking this as a largely unexplored area. We assessed SpaDiT using ten ST datasets, employing multiple metrics to evaluate performance, gene spatial structure, and gene similarity. The results show that SpaDiT not only maintains the intricate topology inherent in cell layout but also excels in accurately aligning predicted gene expression with actual data, demonstrating its robustness and accuracy in reproducing spatial patterns. These features highlight the utility of SpaDiT in enhancing the resolution and richness of ST data analysis.\nFuture research may combine SpaDiT's diffusion-based approach with traditional similarity-based methods to enhance the accuracy of ST data predictions. These advances may significantly improve the analysis and interpretation of ST data, potentially setting new standards in the field. It is important to acknowledge the potential limitations. For example, when ST data lack sufficient markers to accurately identify cell types, SpaDiT's efficacy may be diminished, similar to other methods. This is due to the reliance on existing gene expression signals to guide the prediction process, potentially resulting in inaccuracies if the initial data are too sparse or ambiguous. This underscores the need for improvements in handling datasets with limited information, ensuring that SpaDiT can adapt to various levels of data completeness and quality."}]}