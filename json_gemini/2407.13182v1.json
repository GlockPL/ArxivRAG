{"title": "SpaDiT: Diffusion Transformer for Spatial Gene Expression Prediction using scRNA-seq", "authors": ["Xiaoyu Li", "Fangfang Zhu", "Wenwen Min"], "abstract": "The rapid development of spatial transcriptomics (ST) technologies is revolutionizing our understanding of the spatial organization of biological tissues. Current ST methods, categorized into next-generation sequencing-based (seq-based) and fluorescence in situ hybridization-based (image-based) methods, offer innovative insights into the functional dynamics of biological tissues. However, these methods are limited by their cellular resolution and the quantity of genes they can detect. To address these limitations, we propose SpaDiT, a deep learning method that utilizes a diffusion generative model to integrate scRNA-seq and ST data for the prediction of undetected genes. By employing a Transformer-based diffusion model, SpaDiT not only accurately predicts unknown genes but also effectively generates the spatial structure of ST genes. We have demonstrated the effectiveness of SpaDiT through extensive experiments on both seq-based and image-based ST data. SpaDiT significantly contributes to ST gene prediction methods with its innovative approach. Compared to eight leading baseline methods, SpaDiT achieved state-of-the-art performance across multiple metrics, highlighting its substantial bioinformatics contribution.", "sections": [{"title": "Introduction", "content": "Single-cell RNA sequencing (scRNA-seq) can represent the entire transcriptome of a specific cell in an organ, providing an excellent perspective for in-depth study of various behaviors and mechanisms between cells [1]. However, since scRNA-seq must undergo sample tissue dissociation, it also leads to the inability of scRNA-seq to capture the spatial distribution and spatial information of cells, which is often crucial for understanding the complex physiological processes between cells [2]. Therefore, spatial transcriptomics (ST) has emerged as an advanced technology that can retain spatial location information while measuring gene expression in tissue or cell samples [3]. This technology enables researchers to parse the spatial distribution of gene expression in tissues, enhancing the understanding of cell types, functions, interactions, and key details in development, disease, and biological processes.\nAt present, ST technology can be mainly divided into two categories: Based on next-generation sequencing technology (seq-based): such as 10x Visium [4], Slide-seq [5] and Stereo-seq [6], transcriptome-wide gene expression within a spatial point can be detected. Fluorescence in situ hybridization (image-based): such as seqFish [7] and MERFISH [8], can measure thousands of genes at the resolution of single cells, but they usually lack full transcriptome coverage, resulting in only a few hundred genes in actual sequencing. Although these two technologies can detect gene expression in the whole transcriptome range, their capture rate is low due to their resolution [9, 10]. The current solution mainly focuses on increasing the capture rate and predicting uncaptured genes by using scRNA-seq data to enhance ST data to improve its resolution [11, 12, 13].\nIn recent years, a variety of methods have been proposed to use scRNA-seq data to improve the resolution of ST data and predict uncaptured genes. These methods, such as Tangram [14], scVI [15], SpaGE [16], stplus [17], SpaOTsc [18], novoSpaRc [19], SpatialScope [20], stDiff [21]. They all assume that scRNA-seq data and ST data have similar expression distributions, and they identify the similarity between scRNA-seq cells and ST cells by detecting the expression patterns of shared genes. Then, these methods use similar scRNA-seq cells to predict the unmeasured part of ST data. However, due to the sparse nature of scRNA-seq and ST data, and the reliance on common genes to calculate similarity, this poses a huge challenge to how to align the two data. In addition, simply using scRNA-seq as a reference for ST data prediction is difficult to avoid introducing batch bias of scRNA, which increases the difficulty of predicting unknown genes [22].\nIn this paper, we introduce a novel method named SpaDiT, which uses a conditional diffusion model to understand and generate unmeasured gene expression in ST data. Although"}, {"title": "Materials and methods", "content": "In this paper, we collected ten benchmark datasets (scRNA sequencing and spatial transcriptomics data) from different tissues of various organisms. As illustrated in Table 1, these datasets originate from various biological organizations and utilize differing sequencing platforms and technologies. They also vary in sample sizes, number of spatially measured genes, and missing data rates. Specifically, the sequencing platforms for single-cell data in these datasets include 10X Chromium, Smart-seq, and Smart-seq2. For spatial transcriptomics data, the platforms are seqFISH, MERFISH, 10X Visium, STARmap, and Slide-seqV2. These datasets are derived from different biological tissues, primarily from mouse and human breast cancer tissue sections.\nFor the implementation of SpaDiT, we adhered to the data preprocessing protocols as established in prior studies [35]. More specifically, we first removed genes with no expression from both the single-cell and spatial transcriptomics datasets. Subsequently, we screened the remaining genes to identify those that were highly expressed, using criteria based on the number of genes in each dataset.\nWe partitioned the processed data into training, validation, and test sets with ratios of 7:2:1, respectively. These subsets are mutually independent, with the test set being strictly separate from the training set. All reported results were derived solely from evaluations on the test set."}, {"title": "The architeture of SpaDiT", "content": "SpaDiT is a conditional diffusion-based deep generative model that enhances spatial transcriptomics data by leveraging single-cell RNA sequencing (scRNA-seq) data as prior information, aiming to accurately predict the expression of unmeasured or unknown genes. As illustrated in the Figure 1, SpaDiT takes two types of input data: a gene expression matrix from spatial transcriptomics data and another from scRNA-seq data. Utilizing a conditional diffusion model, SpaDiT uses scRNA-seq data as a conditioning factor to guide the model through the diffusion and denoising processes, thereby generating the targeted gene expression profiles for the spatial transcriptomic data. The SpaDiT architecture comprises three key modules: the Latent Embedding module for processing spatial transcriptomic data, the Condition Embedding module for processing scRNA-seq data, and the core network architecture: Diffusion with Transformer, which facilitates the integration and generation of data. In the following sections, we will introduce the main modules of SpaDiT."}, {"title": "Latent Embedding in SpaDiT", "content": "In the proposed SpaDiT, the latent embedding module is crucial. Instead of operating directly on real data, we work within an efficient, low-dimensional latent space, which is better suited for likelihood-based generative models. Therefore, we utilize an encoder to map the high-dimensional input data to a low-dimensional representation, and we train the diffusion model within this latent space.\nNotably, our proposed method involves two types of data input: spatial transcriptomics data (Xst) and ScRNA-seq data (Xsc). The genes in Xsc are divided into shared genes (Gshare) with spatial transcriptomics data and unique genes (Gunique). For the input of Latent Embedding, we define it as follows: for each sample (i,e., gene) x \u2208 Xst in the spatial transcription data, we integrate it with the scRNA-seq data x \u2208 Xsc, where xt and xc in Gshare are utilized as inputs. In latent embedding, we employ a simple feed-forward network to project xst and xc into the same dimensional space, concatenating the projected vst and vsc as the output of the latent embedding, that is, v = v \u2295 v."}, {"title": "Condition Embedding in SpaDiT", "content": "The condition embedding module leverages scRNA-seq data as a conditioning factor in our model, integrating it into the diffusion process to guide the model in generating the required gene expression. Given that scRNA-seq data is high-dimensional, directly using the entire matrix as input would result in the curse of dimensionality. Consequently, the condition embedding module utilizes an attention mechanism to convert the high-dimensional single-cell data matrix into a lower-dimensional representation. This reduces the data to a low-dimensional, high-expression latent representation, which is then used as a conditional mechanism in subsequent diffusion model training.\nFor the input of Condition Embedding, the high-dimensional input matrix Xsc is processed using Flash-attention to compute a lower-dimensional representation X\u03c8 as output:\n$Q = X_{sc}W^Q, K = X_{sc}W^K, V = X_{sc}W^V,$\n$X_\\psi = softmax(\\frac{QK}{\\sqrt{d_k}}) \\Phi_V(V)$", "where": ["W^Q, W^K, and W^V are projection matrices that transform X_{sc} into queries Q, keys K, and values V, respectively.", "$\\Phi_K$ and $\\Phi_V$ are the dimensionality reduction functions applied to K and V, resulting in lower-dimensional.", "$d_k$ is the dimension of K after projection, used to scale the softmax computation.", "The softmax function is applied over each row, normalizing the dot product scores into a probability distribution used to compute the weighted sum of values $\\Phi_V(V)$."]}, {"title": "Diffusion with Transformer in SpaDiT", "content": "The backbone network of our proposed SpaDiT is Diffusion Transformers (DiTs), a new architecture for diffusion models. For the backbone network model, we refer to previous work [36] and make modifications based on the challenges we encounter. Our backbone model has two types of input: xt, representing latent embedding, and x\u03c8, representing condition embedding. We initialize each residual block in the backbone network as an identity function and incorporate the condition embedding into the backbone. At each layer, we also perform scaling regression on all residual connections within the backbone, facilitating rapid model convergence.\nAfter the final DiT block, the gene expression token sequence needs to be decoded into output noise prediction and output diagonal covariance prediction. The shapes of both outputs are identical to the input in the original space, and a standard linear decoder is employed to achieve this. Finally,"}, {"title": "Training phase in SpaDiT", "content": "Here in, SpaDiT works with two types of input data: the spatial transcriptomics data $X_{st} = \\{x_{st}\\}^n \\in \\mathbb{R}^{n\\times p}$ and scRNA-seq data $X_{sc} = \\{x_{sc}\\}^m \\in \\mathbb{R}^{m\\times q}$. Among them, n and p respectively represent the number of genes and the number of spots in spatial transcriptomics data, and m and q respectively represent the number of genes and the number of cells in scRNA-seq data.\nThe training phase of SpaDiT is shown in the Figure 1 (A). We first mask the genes of the original spatial transcriptomics data according to a certain proportion, where the mask is divided into two parts: the part with an expression value of zero and the part with an expression value that is not zero. The input tensor of the training phase is defined as follows:\n$x_o = v_{st} \\oplus v_{sc}$", "where": ["$v_{st}$ and $v_{sc}$ are projection of $x_{st}$ and $x_{sc}$ by a simple feed-forward network."]}, {"title": "", "content": "In the realm of DDPMs [23, 37], consider the task of learning a model distribution $p_\\theta (x_0)$ that closely approximates a given data distribution q(x0). Suppose we have a sequence of latent variables xt for t = 1,..., T, existing within the same sample space as xo, which is denoted as X. DDPMs are latent variable models that are composed of two primary processes: the forward process and the reverse process. The forward process is defined by a Markov chain, as follows:\n$q(x_{1:T}|x_0) := \\prod_{t=1}^{T} q(x_t|x_{t-1}),$", "where": ["$q(x_t|x_{t-1}) := \\mathcal{N}(x_t; \\sqrt{1 - \\beta_t}x_{t-1}, \\beta_t I)$ and the variable \\(\beta_t\\) is a small positive constant indicative of a noise level. The sampling of xt can be described by the closed-form expression $q(x_t|x_0) = \\mathcal{N}(x_t; \\sqrt{\\bar{a}_t}x_0, (1 - \\bar{a}_t)I)$, where $a_t := 1 - \\beta_t$ and $\\bar{a}_t$ is the cumulative product $\\bar{a}_t := \\prod_{i=1}^t a_i$. Consequently, It is given by the equation $x_t = \\sqrt{\\bar{a}_t}x_0 + (1 - \\bar{a}_t)\\epsilon$, with $\\epsilon \\sim \\mathcal{N}(0, I)$. In contrast, the reverse process aims to denoise xt to retrieve xo, a process which is characterized by the ensuing Markov chain:\n$p_\\theta(x_{0:T}) := p(x_T) \\prod_{t=1}^{T} p_\\theta(x_{t-1}|x_t), x_T \\sim \\mathcal{N}(0, I),$\n$p_\\theta(x_{t-1}|x_t) := \\mathcal{N}(x_{t-1}; \\mu_\\theta(x_t, t), \\sigma_\\theta(x_t, t)I),$\n$\\mu_\\theta(x_t, t) = \\frac{1}{\\sqrt{a_t}} (x_t - \\frac{\\beta_t}{\\sqrt{1-\\bar{a}_t}} \\epsilon_\\theta(\\epsilon_t, t)),$\n$\\sigma_\\theta(x, t) = \\beta^{1/2} \\frac{\\sqrt{1 - a_{t-1}}}{\\sqrt{1 - \\bar{a}_t}}$", "where $\\epsilon_\\theta(x_t, t)$ is a trainable denoising function and", "$\\beta_t = \n \\begin{cases}\n    \\frac{1-a_{t-1}}{1-\\bar{a}_t} \\beta_t, & \\text{for } t > 1, \\\\\n    \\beta_1,              & \\text{for } t = 1.\n  \\end{cases}$"]}, {"title": "", "content": "SpaDiT aims to help models understand and estimate the expression of missing genes in ST data by utilizing scRNA-seq data as prior information, thereby enabling the model to better predict gene expression from ST data. We represent the data of the condition as x = x\u03c8. Therefore, our goal is to estimate the posterior $p((\\mathcal{E}_{n, 1-m_1}) ((\\mathcal{E}_{n, 1-m_2}) x_0)|x)$, where $\\mathcal{E}_{n, 1}$ is an all-1 matrix n \u00d7 1 with dimension, $m_1, m_2 \\in \\{0, 1\\}^{n\\times 1}$ is an element-wise indicator, representing the zero and non-zero parts of the mask respectively.\nWe also denote predicted genes as $x_{t+1}$, where t is the time step. Therefore, the goal of our SpaDiT conditional mechanism is to estimate the probability:\n$p_\\theta(x_{t+1}|x_t, x).$\nIn order to better use the scRNA-seq data as a priori conditions for the diffusion model to perform prediciting gene expression, we transform the Equation 3 and Equation 4 into:\n$p_\\theta(x_{0:T}|x) := p(x_T|x) \\prod_{t=1}^{T} p_\\theta(x_{t-1}|x_t, x), x_T \\sim \\mathcal{N}(0, 1).$\n$p_\\theta(x_{t-1}|x_t, x) := \\mathcal{N}(x_{t-1}; \\mu_\\theta(x_t, t|x), \\sigma_\\theta(x_t, t|x)I).$\nWe can optimize the Equation 7 parameters by minimizing the variational lower bound:\n$\\mathbb{E}_q[-\\log p_\\theta(x_0 | x)] < \\mathbb{E}_q \\Big[-\\log \\frac{p_\\theta(x_{0:T})}{q(x_{1:T}|x_0)} \\Big].$\nAlso we can get a simplified training objective:\n$\\mathbb{E}_{x_0\\sim q(x_0),\\epsilon \\sim \\mathcal{N}(0,1), t} ||(\\epsilon - \\epsilon_\\theta (x_t, t|x))||^2$.\nWe provide the training procedure of SpaDiT in Algorithm 1."}, {"title": "Inference phase in SpaDiT", "content": "We focus on improving the conditional diffusion model characterized by the inverse process described in Equation 7. Our goal is to accurately model the conditional distribution $P(x_{t-1}|x_t, x)$ without resorting to approximations To achieve this, we adapt the parameterization of DDPM from Equation 4 for the conditional setting. We introduce a conditional denoising function $\\epsilon_\\theta : (X*X \\rightarrow X*X ) \\rightarrow x*$ accepts conditional observation value x as input parameter. On this basis, we use $e_\\theta$ for parameterization, as follows:\n$\\mu_\\theta(x, t|x) = u(x, t, s_\\theta(x, t|x)),$\n$\\sigma_\\theta(x, t|x) = \\sigma (x, t),$\nwhere \u03bc and \u03c3 are defined in Equation 4. Utilizing the function $e_\\theta$ and the data xo, we can simulate samples of xt by employing the reverse process outlined in Equation 7. We provide the inference procedure of SpaDiT in Algorithm 2."}, {"title": "Evaluation metrics", "content": "To evaluate the performance of SpaDiT and other baseline methods, we use five evaluation indicators: Pearson Correlation Coefficient (PCC), Structural Similarity Index Measure (SSIM), Root Mean Square Error (RMSE), Jensen-Shannon Divergence (JS) and Accuracy Score (AS) to evaluate the gene prediction performance of different methods on ten datasets.\nThe specific definition of the evaluation metrics can be found in Supplementary Materials."}, {"title": "Baselines", "content": "We compared the performance of SpaDiT to eight baseline methods, with data processing procedures (e.g., normalization and scaling) consistent for each method. The specific baselines are as follows:\nTangram [14]: It is a method that can map any type of sc/snRNA-seq data, including multimodal data such as those from SHARE-seq, which can be used to reveal spatial patterns of chromatin accessibility. We refer to the guide on the Tangram GitHub repository: https://github.com/\nbroadinstitute/Tangram.\nscVI [15]: It is a scalable framework for probabilistic representation and analysis of single-cell gene expression."}, {"title": "Results", "content": "Our findings indicate that SpaDiT consistently achieves state-of-the-art (SOTA) performance in all four metrics across the ten examined datasets. However, it is important to note that in a few cases, SpaDiT slightly lags behind some established methods in one particular metric. This deviation provides critical insights into scenarios where SpaDiT might be further optimized.\nIn addition to these traditional metrics, we introduced an advanced scoring system, referred to as AS metrics, to further evaluate SpaDiT's performance. The results, illustrated in Figure 2, confirm that SpaDiT not only meets but often exceeds the performance benchmarks set by the baseline methods across all ten spatial transcriptomics (ST) datasets. The inclusion of AS metrics provides a more nuanced understanding of SpaDiT's predictive prowess, underscoring its robustness and effectiveness in diverse experimental conditions. This comprehensive approach solidifies SpaDiT's position as a leading method in gene expression prediction, highlighting its potential to significantly enhance the accuracy and reliability of spatial transcriptomics analyses."}, {"title": "SpaDiT enhances the similarity of predicted gene expression in high-dimensional space", "content": "To fully demonstrate the superior ability of the SpaDiT method in gene expression prediction, especially its advantages in maintaining the global and local structural characteristics of gene expression data, we used UMAP technology for visualization analysis for conducting in-depth comparisons with other benchmark methods.\nAs shown in the Figure 3, we conducted an analysis of ten different datasets. The results clearly show that the prediction results of the SpaDiT method (in orange) closely resemble the real gene expression data (in blue), with minimal perceptible deviation. This is in sharp contrast to the prediction results generated by several other methods, such as Tangram, scVI, SpaGE, stPlus, SpaOTsc, novoSpaRc, SpatialScope, and stDiff. Although the prediction results of these methods have their own focuses, compared with SpaDiT, they all fail to accurately capture the structural characteristics of real gene data and exhibit significant deviations. In addition, the UMAP analysis further underscores SpaDiT's superiority in maintaining data integrity, enabling it to accurately simulate complex biological information."}, {"title": "SpaDiT preserves the similarity between genes", "content": "To fully demonstrate the accuracy of the SpaDiT method in predicting gene expression, we employed hierarchical clustering to visualize the similarity between the predicted genes and the true gene labels, and compared the results with those from other benchmark methods.\nFirst, we calculated the Euclidean distance between each pair of genes in the gene expression matrix predicted by each method to reflect the similarity of the expression patterns of two genes: the smaller the distance, the higher the similarity. After calculating the distance of all gene pairs, we used hierarchical clustering to sort these genes to ensure that the genes within the cluster show the greatest similarity. With this sorting, we can reorganize the rows and columns of the distance matrix so that similar genes are adjacent to each other in the heat map.\nAs shown in the Figure 4, the first column of the figure visualizes the true gene labels after clustering. The closer the predicted gene heat map is to the true labels, the higher the prediction accuracy of the method. As evident from the figure, the prediction results of the SpaDiT method are very close to the true labels, demonstrating its high accuracy in predicting gene expression."}, {"title": "SpaDiT accurately predicts ST Spatial Patterns", "content": "In addition to quantitatively evaluating the gene expression similarity between the true genes of ST and the genes predicted by ST, we also visually demonstrate the consistency of spatial patterns in Figure 5."}, {"title": "Robustness evaluation of SpaDiT across various sampling rates", "content": "In our study, the sparsity of the ten dataset pairs varies. Most of the datasets are highly sparse spatial transcriptomic data, except for the MH dataset, which has a sparsity of 6.7%. To test the ability of SpaDiT to resist data sparsity, we downsampled the expression matrix of MH's spatial transcriptomics data to simulate different high-sparse data. To quantify the stability of the SpaDiT and its ability to resist data sparsity, we counted the percentage of genes with a prediction accuracy (PCC) greater than 0.5 in both the original data and the downsampled data, defined as the Robustness Score (RS). As shown in the Figure 6, the red points represent genes with a PCC value greater than 0.5, and the gray points represent genes with a PCC value less than 0.5. We tested different downsampling rates: 0.1, 0.3, 0.5, and 0.7, and found that the stability scores of all methods decreased with the increase of data sparsity, while the stability score of SpaDiT was always higher than that of other baseline methods. In addition, we compared the changing trends of model performance under different sampling rates and different sparsity levels on ten datasets. For detailed results on other datasets, please refer to the Supplementary Materials."}, {"title": "Ablation studies: The impact of different modules of SpaDiT on model performance", "content": "As mentioned above, Condition Embedding and Backbone network in SpaDiT are the key parts of our proposed method. In order to verify the importance of these two parts, we conducted ablation experiments in this section.\nFor the backbone network part (Figure 1), we used three different network backbones and used AS as the evaluation indicator. As shown in the Table 3, we compared three different network architectures: U-Net, Mamba, and Transformer. It is worth noting that the model using Transformer as the network backbone has the best performance, which further proves the importance of Transformer and verifies the superiority of SpaDiT.\nIn our proposed, SpaDiT, the main innovation involves using spatial transcriptomics (ST) and single-cell (SC) common genes to concatenate by gene in latent embedding. We use the known part (concatenated SC gene) to infer the gene expression of the unknown part (ST gene to be predicted). This approach enables the model to learn the similarity between different spots and cells across genes. Additionally, the Condition module utilizes the overall SC data as the prior condition to guide the model's generation process. To verify the effectiveness of the proposed method, we conducted ablation experiments on these two modules separately.\nThe specific experimental results are shown in Table 4. First, for the Condition module (4), to verify the effectiveness of the Attention mechanism, we replaced Attention with a simple MLP (Part: w/o Flash-Attention). We found that the performance of the model dropped significantly across ten datasets. Further, to verify the effectiveness of the Condition module (4) (Part: w/o Condition ), we replaced the output of the entire part with a vector of all zeros. We observed that compared to replacing Attention, the performance of the model further declined. Additionally, to verify the effectiveness of the overall SC data as a priori conditions (Part: w/ Common Gene in 4), we replaced the overall SC data with SC that only retained the common genes. We found that the performance also declined compared to the overall SC. Finally, to verify the effectiveness of the splicing of the common genes (Part: w/o Concat in $), we removed this part and found that the performance significantly declined. Therefore, we conclude that the method we proposed is highly effective. In addition, we also tried using Condition modules with different Condition methods. For details, please refer to the Supplementary Materials."}, {"title": "Discussion", "content": "In this paper, we present SpaDiT, a novel approach to predict unmeasured genes in spatial transcriptomics (ST) data. Methodologically, SpaDiT is significantly different from existing ensemble techniques. While traditional approaches primarily enhance ST data by aligning ST data to similar cells within a reference scRNA-seq dataset, SpaDiT employs a diffusion-based generative model that utilizes the inherent relationships within the gene expression data. This approach enables it to precisely model and generate spatial gene expression patterns.\nSpaDiT, as a conditional diffusion model, employs noise addition and denoising stages to learn complex relationships from scRNA-seq data. In the inference stage, SpaDiT incorporates raw ST data during the denoising process, resulting in accurate predictions of spatial gene expression. The application of diffusion models in genomics, especially transcriptomics, is relatively new, marking this as a largely unexplored area. We assessed SpaDiT using ten ST datasets, employing multiple metrics to evaluate performance, gene spatial structure, and gene similarity. The results show that SpaDiT not only maintains the intricate topology inherent in cell layout but also excels in accurately aligning predicted gene expression with actual data, demonstrating its robustness and accuracy in reproducing spatial patterns. These features highlight the utility of SpaDiT in enhancing the resolution and richness of ST data analysis.\nFuture research may combine SpaDiT's diffusion-based approach with traditional similarity-based methods to enhance the accuracy of ST data predictions. These advances may significantly improve the analysis and interpretation of ST data, potentially setting new standards in the field. It is important to acknowledge the potential limitations. For example, when ST data lack sufficient markers to accurately identify cell types, SpaDiT's efficacy may be diminished, similar to other methods. This is due to the reliance on existing gene expression signals to guide the prediction process, potentially resulting in inaccuracies if the initial data are too sparse or ambiguous. This underscores the need for improvements in handling datasets with limited information, ensuring that SpaDiT can adapt to various levels of data completeness and quality."}]}