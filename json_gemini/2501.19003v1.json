{"title": "Virtual airways heatmaps to optimize point of entry location in lung biopsy planning systems", "authors": ["Debora Gill", "Pere Lloret", "Marta Diez-Ferrer", "Carles Sanchez"], "abstract": "Purpose: We present a virtual model to optimize point of entry (POE) in lung biopsy planning systems. Our model allows to compute the quality of a biopsy sample taken from potential POE, taking into account the margin of error that arises from discrepancies between the orientation in the planning simulation and the actual orientation during the operation. Additionally, the study examines the impact of the characteristics of the lesi\u00f3n. Methods: The quality of the biopsy is given by a heatmap projected onto the skeleton of a patient-specific model of airways. The skeleton provides a 3D representation of airways structure, while the heatmap intensity represents the potential amount of tissue that it could be extracted from each POE. This amount of tissue is determined by the intersection of the lesion with a cone that repre- sents the uncertainty area in the introduction of biopsy instruments. The cone, lesion, and skeleton are modelled as graphical objects that define a 3D scene of the intervention. Results: We have simulated different settings of the intervention scene from a single anatomy extracted from a CT scan and two lesions with regular and irregular shapes. The different scenarios are simulated by systematic rotation of each lesion placed at different distances from airways. Analysis of the heatmaps for the different settings show a strong impact of lesion orientation for irregular shape and the distance for both shapes.", "sections": [{"title": "1 Introduction", "content": "Bronchoscopy is a standard procedure to extract lung tissue samples for histopatholog- ical analysis. Although there are currently various technologies such as endobronchial ultrasound and navigation that enable guiding the doctor to the lesion, the reality is that in most centers where diagnostic bronchoscopy is performed, these technologies are not available as its expensiveness and expertness [1]. Conventional bronchoscopy may be the only bronchoscopic option available in centers without interventional expertise [2]. Virtual bronchoscopy (VB) is the usual approach to computational planning. Virtual bronchoscopies combine medical imaging, 3D visualization technologies and simulations to enable a virtual exploration of 3D reconstruction of airways extracted from CT scans. These systems provide doctors with several POE with optimal distance to the lesion and instrumental orientation. During the procedure, the pulmonologist must replicate the previously planned navigation. The guidance systems [3-5] help the doctor to navigate through the bronchi following the planned route, positioning and orienting the bronchoscope, according to the virtual biopsy. Regardless of the guidance technology, guidance systems have a margin of error in, both, location of the POE and orientation of sampling and tunneling instruments. These errors might have a different impact on the quality of the sample depending on specific anatomical and morphological conditions, like lesion shape irregularity, distance and orientation to the POE and lesion size, among others [6]. The existing planning systems provide position and orientation, but do not incorporate the feasi- bility of the intervention taking into account the errors of the navigation system or the patient anatomy [7]. The few feasibility studies [8] are clinical studies that collect this feasibility by doing a bronchoscopy and comparing the result with those of virtual bronchoscopy simulations. The goal of this work is to analyze the feasibility of a guided bronchoscopic biopsy from a given POE through the implementation of heatmaps in virtual bronchoscopy. In particular, we contribute in the following aspects. Unlike existing VB planners, we compute a 3D scene of a guided biopsy that includes the patient's anatomy and the area of uncertainty caused by the error in the guidance system. This area is mathematically modelled as a cone that is defined from the elements of the anatomical scene and an error in the orientation of the guidance system. We model the feasibility of a biopsy taken from a given POE by means of intersections between the 3D objects"}, {"title": "2 Scene of the Biopsy", "content": "Heatmaps are calculated from a scene that represents both the patient's lung anatomy and the uncertainty of the tunneling orientation. The scene of the anatomy is com- puted from two binary segmentations of the patient's airways and lesion. The scene of the orientation uncertainty is modelled using graphical primitives. Both scenes are modelled and visualized using the Python library Vedo [9]. The input data to compute the anatomical scene are two binary volumes extracted from CTs representing the patient's nodule and bronchial anatomy. The volume of the nodule is a manual segmentation done by an expert using the 3DSlicer software. The volume of the bronchi has been obtained automatically with the segmentation algorithm described in [10]. These two volumes have been transformed into Vedo mesh objects. In order to represent all possible navigation paths, we extract the skeleton points of the bronchial volume. A 3D skeletonization is a process by which the central points or axes of a three-dimensional object, in this case the bronchi, are found. In our case, the skeleton is extracted from the airway's mesh using the Skeletoner library [11]. For the modelling of the uncertainty in tunneling orientation, we observe that, in an ideal guidance system, the orientation for biopsy tunneling instruments from a POE could be represented as a straight line in the direction of the lesion. A margin of error in this orientation generates an area of uncertainty around the central direction, which can be represented as a conical volume. Figure 1 shows a 2D representation of a scene with the margin of error given as the opening angle (labelled error in the figure) of the triangle that crosses the lesion represented as a dark ellipse. In the 3D case, this angular margin can be oriented in any direction of the plane perpendicular to the height of the triangle (given by the vector V in Figure 1) and, thus, this error generates a 3D cone. We define this 3D cone using the Cone class of Vedo, which generates the mesh of a cone from parameters (see Figure 1) that determine its shape. The shape parameters are the height of the cone (h in Figure 1), the direction vector (V in Figure 1) defining the orientation of the cone, the center (C in Figure 1) which is the middle point of the central axis of the cone and the radius of the base (r in Figure 1) These parameters have been determined by studying the scene as we explain below. The height of the cone represents the distance that the instruments must travel in order to perform the biopsy. Since it must be large enough to completely cross the nodule, we defined it as the distance between the POE and the farthest point of the nodule's bounding box. The bounding box is extracted with the GetBounds() method of the Vedo mesh objects."}, {"title": "3 Heatmap of the Biopsy Feasibility", "content": "The computation of the heatmap has two main steps: selection of a set of valid POE and computation of the amount of tissue that could be extracted from them. Both steps are computed from intersections between the 3 objects of the biopsy scene, cone, lesion and airways. Intersections are computed in the voxel volumetric domain by adding the binary volumes of the masks associated to each 3D object. The value of this additive volume is equal to the number of intersecting objects: zero for background, and Nobj > 0 for voxels belonging to Nobj objects. There are two conditions on POE that make a biopsy from them infeasible. In case instruments cross other anatomic structures a POE should be discarded since it increases the risk for the patient. Also POE such that the cone of uncertainty includes surrounding lung tissue outside the nodule should be discarded since the sample could not contain enough lesion tissue. POE where any of these conditions occur are discarded. In order to determine whether instruments cross a bronchus, for each POE in the skeleton, we compute the intersection between the cone with vertex at this POE and the bronchial volume. If the maximum of the additive volume is greater than 1, then, the POE is discarded. Figure 2 (a) shows an example of a POE invalid for the biopsy of the distal lesion with the bronchi traversed by its cone in a red circle. To discard POE's such with an uncertainty cone including surrounding lung tissue, we compute the intersection between the lesion volume and the cone boundary. The cone boundary is computed in the volumetric domain by subtracting the volumes of the original cone and a dilated version. POE's with the maximum of the additive intersection volume is less than 2 are discarded. Heatmaps are computed from the maximum amount of tissue available for the biopsy from each valid POE, which corresponds to the number of voxels of the inter- section volume with value equal to two. This quantity increases with the distance of the nodule to the POE. This is not consistent from a clinical point of view, since it has been shown that the more distant the lesion is, the more inconclusive the biopsy might be. We take this into account by the introduction of a distance penalty factor and formulate heatmaps at a valid POE as the volume of the intersection POE cone and lesion divided by the distance from the center of the nodule, CNod to POE:\n$\\mathrm{heatmap(POE) := \\frac{V_{Nod} \\cap V_{Cone}}{||C_{Nod} - POE||_2}}$\nwhere V is the binary volume of a mesh object and || the volume of a 3D volumetric object."}, {"title": "4 Experiments and Results", "content": "The goal of these experiments is to explore the impact of the nodule shape, orientation and distance from bronchi on the feasibility of a biopsy. To do so, we have generated several lung scenes with two lesions with different shapes, one with a regular shperi- cal shape and the other one with an irregular elongated and spiculated shape. Each nodule has been placed at 3 increasing distances (D1, D2, D3) from a distal point. In order to determine each distance, we extract a distance map from the airways mask to the rest of lung scene. Afterwards an histogram of the distances is applied to finally randomly select lung scene points (discarding such near outside the lungs) at different percentiles (25, 60, 90) representing distances. Finally we have located the nodule to each respective point, depending on the distance we were analyzing. For each distance, nodule has been rotated around its center. Each rotation is defined by the axis of rota- tion given by the unitary vector $(\\cos(\\theta)\\cos(\\phi), \\sin(\\theta)\\cos(\\phi), \\sin(\\phi))$, for $\\theta \\in [0,180]$, $\\Phi \\in [0,90]$ and an angle of rotation $a \\in [0,360]$. The three ranges of the angles defin- ing the rotation have been uniformly sampled every 45 to obtain 64 rotations, which gives a total number of 128 scenes (64 for each nodule shape). Regarding the anatomy of airways, we have used one of the binary volumes of the public CPAP database [12]. The CPAP dataBase contains CTs from 20 patients recorded in inspiration and expi- ration with 4 different positive airway pressure protocols. We have used the volume number (with size (321,464,767)) 14 in inspiration and standard pressure protocol for the definition of our anatomical scene. For each one of the 128 scenes, its heatmap has been computed in order to analyze the impact of the lesion shape and distance to the airways. The computational cost of the heatmap for each scene is around 42 seconds on a computer of CPU: AMD Ryzen 7 5700U, GPU: AMD Radeon Vega 8 Graphics, and 32 GB of RAM. In order to analyze the impact of the distance, Table 1 reports a statistical summary of the distribution of heatmap values (median and IQR) for the 3 distances. For each distance, we report mean \u00b1 standard deviation of heatmap median and IQR computed for the 64 rotations. For the regular shape, the distribution of heatmap values have a significant drop in average values as distance increases, although the IQR remains stable. Whereas for the irregular shape, both, median and IQR, suffer a significant drop across increasing distances. The drop in ranges is attributed to a drop in the number of valid POE as the distance increases, which makes the distribution of values to be more concentrated around the median."}, {"title": "5 Conclusions", "content": "As far as we know this is the first work that addresses the computation of the feasibility of a guided biopsy using virtual bronchoscopy. We consider that virtual bronchoscopy systems could benefit in several aspects if they incorporated heatmap analysis for PO\u0415 location. These heatmaps could help to determine which is the optimal POE, model the maximum error allowed in the navigation systems, as well as study which variables have a greater influence on the success of the operation. The statistical analysis of the impact of the variables has allowed a better understanding of how the different morphological factors influence the biopsy yield and can provide useful information for decision-making in future interventions. Virtual bronchoscopy softwares are widely accessible in most centers, and the incorporation of heatmaps could represent a low- cost upgrade with significant potential impact on diagnosing extrabronchial lesions. This could be particularly valuable for less complex. Furthermore, being able to study"}]}