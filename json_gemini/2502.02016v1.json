{"title": "A PERIODIC BAYESIAN FLOW FOR MATERIAL GENERATION", "authors": ["Hanlin Wu", "Yuxuan Song", "Jingjing Gong", "Ziyao Cao", "Yawen Ouyang", "Jianbing Zhang", "Hao Zhou", "Wei-Ying Ma", "Jingjing Liu"], "abstract": "Generative modeling of crystal data distribution is an important yet challenging task due to the unique periodic physical symmetry of crystals. Diffusion-based methods have shown early promise in modeling crystal distribution. More recently, Bayesian Flow Networks were introduced to aggregate noisy latent variables, resulting in a variance-reduced parameter space that has been shown to be advantageous for modeling Euclidean data distributions with structural constraints (Song et al., 2023). Inspired by this, we seek to unlock its potential for modeling variables located in non-Euclidean manifolds e.g. those within crystal structures, by overcoming challenging theoretical issues. We introduce CrysBFN, a novel crystal generation method by proposing a periodic Bayesian flow, which essentially differs from the original Gaussian-based BFN by exhibiting non-monotonic entropy dynamics. To successfully realize the concept of periodic Bayesian flow, CrysBFN integrates a new entropy conditioning mechanism and empirically demonstrates its significance compared to time-conditioning. Extensive experiments over both crystal ab initio generation and crystal structure prediction tasks demonstrate the superiority of CrysBFN, which consistently achieves new state-of-the-art on all benchmarks. Surprisingly, we found that CrysBFN enjoys a significant improvement in sampling efficiency, e.g., ~ 100\u00d7 speedup (10 v.s. 2000 steps network forwards) compared with previous diffusion-based methods on MP-20 dataset. Code is available at https://github.com/wu-han-lin/CrysBFN.", "sections": [{"title": "1 INTRODUCTION", "content": "Deep generative models, with their strong ability to approximate data distribution with complex geometries, have recently emerged as a promising approach to de novo drug design (Hoogeboom et al., 2022), protein engineering (Shi et al., 2022), and material science (Liu et al., 2017). To discover new functional materials (Wang et al., 2023; Peng et al., 2022), there has been an active line of research on crystal generative modeling (Ren et al., 2021; Hoffmann et al., 2019; Noh et al., 2019; Court et al., 2020; Yang et al., 2023; Nouira et al., 2018). Recent diffusion-based models learns through an iterative reverse process with multi-level noise perturbation, and has been demonstrated as a powerful tool for capturing complex geometries of crystals. Studies show that these models can generate crystal samples with realistic structures that well satisfy physical constraint (Xie et al., 2021; Jiao et al., 2023; 2024; Lin et al., 2024).\nDespite promising results, significant challenges persist. The search space for crystal structures grows exponentially with the number of atoms, while thermodynamically stable materials represent only a small fraction (Miller et al., 2024). This presents challenges in the multi-step generation process, the variance of which might cause structures to deviate from stable distributions. Moreover, the current widely-adapted diffusion-based approaches (Jiao et al., 2023; 2024) for crystal structure"}, {"title": "2 RELATED WORK", "content": "Modeling and generating stable materials with data-driven approaches has been applied to discovering new functional materials (Peng et al., 2022). One line of approaches indirectly models crystal space by transforming crystals into human-designed representations (Ren et al., 2021; Hoffmann et al., 2019; Noh et al., 2019; Court et al., 2020; Yang et al., 2023), though the encoding and decoding process often leads to physical geometry loss In contrast, another line of research directly models crystals in the sample space, drawing inspiration from the success of Diffusion models (Ho et al., 2020b; Song et al., 2020a; Song & Ermon, 2019). For instance, CD-VAE (Xie et al., 2021) and SyMat"}, {"title": "3 PRELIMINARIES", "content": "Crystal Representation and Related Manifold Crystals can be represented as a structure composed of infinite, periodic and repeating unit cells defined by a triplet $\\mathcal{M} = (A, F, L)$. Denote the number of atoms in the unit cell as $N$, $A = (a_1, a_2, \\dots, a_N) \\in \\mathcal{S}^{K\\times N}$ is the representation of atom types with the length of vocabulary $K$, and every such one-hot discrete variable locates in the simplex $\\mathcal{S}^K$ represented by:\n$\\mathcal{S}^K \\stackrel{\\text{def}}{=} \\{s \\in \\mathbb{R}^{K} | \\sum_{i=1}^K s_i = 1, s_i \\geq 0, i = 1, ..., K\\}$ \nwhich requires the designed generative path for $A$ should be well defined on the simplex. Following Jiao et al. (2023), $F = [f_1, f_2, ..., f_N] \\in [0, 1)^{3\\times N}$ is the fractional coordinates of atoms located in quotient space $\\mathbb{R}^{3\\times N}/\\mathbb{Z}^{3\\times N}$ equivalent to the hypertorus $\\mathbb{T}^{3\\times N}$ (Jing et al., 2022). The hypertorus $\\mathbb{T}^{3\\times N}$ can be represented as the Cartesian product of $3 \\times N$ toruses $\\mathbb{T}^1$:\n$\\mathbb{T}^1 \\stackrel{\\text{def}}{=} \\{z \\in \\mathbb{R}^2 : ||z|| = 1\\}$\nAnd $L = [l_1, l_2, l_3] \\in \\mathbb{R}^{3\\times 3}$ denotes the lattice matrix, every column vector of which is the periodic basic vector of the crystal. We can get the Cartesian coordinates representation of unit cell's atom coordinates $X$ by $X = LF \\in ]\\mathbb{R}^{3\\times N}$. The ideal infinite periodic crystal structure of $\\mathcal{M}$ can be represented by $\\{(a, x)|a_i = a, x = x_i + Lk,\\forall k \\in \\mathbb{Z}^{3\\times 1}\\}$. Based on the above notations, the symmetry of crystal geometry is defined as periodic $E(3)$ invariance\u00b2 (Jiao et al., 2023), including periodic translational invariance of $F$ and rotational invariance of $L$ (details in Appendix \u0412) .\nBayesian Flow Networks Different from the well-established SDE-based approaches, e.g. Diffusion Models (Ho et al., 2020a; Song et al., 2020b;a) and ODE-based approaches e.g. Flow Matching (Lipman et al., 2022), Bayesian Flow Networks define a generative process driven by consecutive Bayesian updates on noised samples from the uninformative prior distribution $\\theta_0$ to posteriors $\\theta$ with higher confidence and more information.\nTo define the consecutive Bayesian update process, Bayesian Flow Networks contain a process to add noise to the clean data samples which is an analogy to the forward process in Diffusion Models. In BFN, such a process is explicitly defined by the so-called sender distribution $p_s(y|x; \\alpha)$"}, {"title": "4 METHOD", "content": "In this section, we explain the detailed design of CrysBFN tackling theoretical and practical challenges. First, we describe how to derive our new formulation of Bayesian Flow Networks over hyper-torus $\\mathbb{T}^D$ from scratch. Next, we illustrate the two key differences between CrysBFN and the original form of BFN: 1) a meticulously designed novel base distribution with different Bayesian update rules; and 2) different properties over the accuracy scheduling resulted from the periodicity and the new Bayesian update rules. Then, we present in detail the overall framework of CrysBFN over each manifold of the crystal space (i.e. fractional coordinates, lattice vectors, atom types) respecting periodic E(3) invariance."}, {"title": "4.1 PERIODIC BAYESIAN FLOW ON HYPER-TORUS TD", "content": "For generative modeling of fractional coordinates in crystal, we first construct a periodic Bayesian flow on $\\mathbb{T}^D$ by designing every component of the totally new Bayesian update process which we demonstrate to be distinct from the original Bayesian flow (please see Fig. 3).\nThe fractional atom coordinate system (Jiao et al., 2023) inherently distributes over a hyper-torus support $\\mathbb{T}^{3\\times N}$. Hence, the normal distribution support on $\\mathbb{R}$ used in the original (Graves et al., 2023) is not suitable for this scenario.\nTo tackle this problem, the circular distribution (Mardia & Jupp, 2009) over the finite interval $[-\\pi, \\pi)$ is a natural choice as the base distribution for deriving the BFN on $\\mathbb{T}^D$. Specifically, circular distributions enjoy desirable periodic properties: 1) the integration over any interval length of $2\\pi$ equals 1; 2) the probability distribution function is periodic with period $2\\pi$. Sharing the same intrinsic with fractional coordinates, such periodic property of circular distribution makes it suitable for the instantiation of BFN's input distribution, in parameterizing the belief towards ground truth $x$ on $\\mathbb{T}^D$.\nvon Mises Distribution and its Bayesian Update We choose von Mises distribution (Mardia & Jupp, 2009) from various circular distributions as the form of input distribution, based on the appealing conjugacy property required in the derivation of the BFN framework. That is, the posterior of a von Mises distribution parameterized likelihood is still in the family of von Mises distributions. The probability density function of von Mises distribution with mean direction parameter $m$ and concentration parameter $c$ (describing the entropy/uncertainty of $m$) is defined as:\n$f(x|m, c) = vM(x|m, c) = \\frac{exp(c cos(x - m))}{2\\pi I_o(c)}$\nwhere $I_o(c)$ is zeroth order modified Bessel function of the first kind as the normalizing constant. Given the last univariate belief parameterized by von Mises distribution with parameter $\\theta_{i-1} = \\{m_{i-1}, c_{i-1}\\}$ and the sample $y$ from sender distribution with unknown data sample $x$ and known accuracy $a$ describing the entropy/uncertainty of $y$, Bayesian update for the receiver is deducted as:\n$h(\\{m_{i-1}, c_{i-1}\\}, y, a) = \\{m_i, c_i\\}, where$\n$m_i = atan2(a sin y + c_{i-1} sin m_{i-1}, a cos y + c_{i-1} cos m_{i-1})$\n$c_i = \\sqrt{a^2 + c_{i-1}^2 + 2ac_{i-1} cos(y \u2013 m_{i-1})}$\nThe proof of the above equations can be found in Appendix A.3. The atan2 function refers to 2-argument arctangent. Independently conducting Bayesian update for each dimension, we can obtain the Bayesian update distribution by marginalizing $y$:\n$p_\u03c5(\\theta'|\\theta, x; \\alpha) = E_{p_s(y|x;\\alpha)}\\delta(\\theta' \u2013 h(\\theta, y, a)) = E_{vM(y|x,\\alpha)}\\delta(\\theta' \u2013 h(\\theta, y, a))$\nNon-additive Accuracy The additive accuracy is a nice property held with the Gaussian-formed sender distribution of the original BFN expressed as:\n$p_\u03c5(\\theta'' | \\theta, x; \\alpha_a + \\alpha_b) = E_{p_t(\\theta'|\\theta,x;\\alpha_a)}p_\u03c5(\\theta'' | \\theta', x; \\alpha_b)$"}, {"title": "4.2 EQUIVARIANT BAYESIAN FLOW FOR CRYSTAL", "content": "With the above Bayesian flow designed for generative modeling of fractional coordinate F, we are able to build equivariant Bayesian flow for each modality of crystal. In this section, we first give an overview of the general training and sampling algorithm of CrysBFN (visualized in Fig. 1). Then, we describe the details of the Bayesian flow of every modality. The training and sampling algorithm can be found in Algorithm 1 and Algorithm 2.\nOverview Operating in the parameter space $\\Theta^M = \\{\\theta^A,\\theta^L, \\theta^F\\}$, CrysBFN generates high-fidelity crystals through a joint BFN sampling process on the parameter of atom type $\\theta^A$, lattice parameter $\\theta^L = \\{\\mu^L, p^L\\}$, and the parameter of fractional coordinate matrix $\\theta^F = \\{m^F, c^F\\}$. We index the n-steps of the generation process in a discrete manner $i$, and denote the corresponding continuous notation $t_i = i/n$ from prior parameter $\\Theta^M_0$ to a considerably low variance parameter $\\Theta^M_n$ (i.e. large $p^L, m^F$, and centered $\\theta^A$).\nAt training time, CrysBFN samples time $i \\sim U\\{1, n\\}$ and $\\Theta^{i-1}_n$ from the Bayesian flow distribution of each modality, serving as the input to the network. The network $\\Psi$ outputs $(\\Theta^{i-1}_{1, n}, t_{i-1}) = (\\Theta^{i-1}_{A, 1, n}, \\Theta^{i-1}_{L, 1, n}, \\Theta^{i-1}_{F, 1, n}, t_{i-1})$ and conducts gradient descents on loss function Eq. (5) for each modality. After proper training, the sender distribution $p_s$ can be approximated by the receiver distribution $p_R$.\nAt inference time, from predefined $\\Theta^M_0$, we conduct transitions from $\\Theta^{0}_{1, n}$ to $\\Theta^M_n$ by: (1) sampling $Y_i \\sim p_R(y_i|\\Theta_{i-1}, \\alpha_i)$ according to network prediction $\\Psi(\\Theta^{i-1}_{1, n}, t_{i-1})$; and (2) performing Bayesian update $h(\\Theta^{i-1}_{1, n}, y_i, \\alpha_i)$ for each dimension.\nBayesian Flow of Fractional Coordinate F The distribution of the prior parameter $\\Theta_0^F$ is defined as:\n$p(\\Theta^F_0) \\stackrel{\\text{def}}{=} \\{vM(m|0^{3\\times N}, 0^{3\\times N}), \\delta(c_o \u2013 0^{3\\times N})\\} = \\{U(0, 1), \\delta(c_o \u2013 0^{3\\times N})\\}$\nNote that this prior distribution of $m^F_0$ is uniform over [0,1), ensuring the periodic translation invariance property in Definition 1. The training objective is minimizing the KL divergence between sender and receiver distribution (deduction can be found in Appendix A.7):\n$\\mathcal{L}_F = nE_{i\\sim U\\{1,n\\},\\mathbb{P}_F(\\Theta^F|F;0_1,0_2,...,\\alpha_i)}[ \\frac{I_1(\\alpha_i)}{I_o(\\alpha_i)} -(1-\\text{cos}(F-\\hat{F}(\\Theta^{F-1}_1, t_{i-1}))) ]$\nwhere $I_o(x)$ and $I_1(x)$ are the zeroth and the first order of modified Bessel functions. The transition from $\\Theta_{i-1}^F$ to $\\Theta_i^F$ is the Bayesian update distribution based on network prediction:\n$\\mathbb{P}(\\Theta_{i+1}^F|\\Theta_{i}^F) = E_{vM(y_i|\\Theta_{i-1}^F)}[ \\delta(\\Theta_i - h(\\Theta_{i-1}^F, y, a)) ]$\nProposition 4.2. With IF as a periodic translation equivariant function namely $\\Psi F(\\Theta^A,w(\\Theta^F + t),\\Theta^L,t) = w(\\Psi F(\\Theta^A,\\Theta^F,\\Theta^L,t) + t), \\forall t \\in \\mathbb{R}^3$, the marginal distribution of $p(F_n)$ defined by Eqs. (17) and (19) is periodic translation invariant.\nBayesian Flow of Lattice Parameter L Noting the lattice parameter L located in Euclidean space, we set prior as the parameter of a isotropic multivariate normal distribution $\\Theta_0^L \\stackrel{\\text{def}}{=} \\{\\mu_o, \\rho_o\\} =$"}, {"title": "5 EXPERIMENTS", "content": "We evaluate on two crystal generation tasks: ab initio generation in Sec. 5.1 and stable structure prediction task in Sec. 5.2. Ablation studies are detailed in Sec. 5.3 to validate design choices. We provide the implementation details in Appendix C.\nFollowing Xie et al. (2021); Jiao et al. (2023), we choose the following datasets for evaluation: 1) Perov-5 (Castelli et al., 2012a;b) is composed of 18,928 perovskite crystals of similar structures, with 5 atoms in a unit cell sharing the chemical formula ABX3. 2) Carbon-24 (Pickard, 2020) contains 10,153 crystals with 6~24 atoms in a cell, and all atom types are carbon. 3) MP-20 (Jain et al., 2013) selects 45,231 stable inorganic materials from Material Projects (Jain et al., 2013), including the majority of experimentally-verified materials with at most 20 atoms in a unit cell. 4) MPTS-52 (Jiao et al., 2023) consists of 40,476 crystals up to 52 atoms per cell, which is a more challenging extension of MP-20. All crystals are reduced as Niggli cells (Niggli, 1928). The procedure to split the datasets into training, validation, and testing subsets adheres to prior practices (Xie et al., 2021; Jiao et al., 2023)."}, {"title": "5.1 AB INITIO GENERATION", "content": "Baselines For this task, the compared baselines include: 2) two-stage VAE-based methods Cond-DFC-VAE (Court et al., 2020) and CD-VAE (Xie et al., 2021); 2) auto-regressive method G-SchNet (Gebauer et al., 2019), and its periodic adaptation P-G-SchNet (Xie et al., 2021); 3) diffusion-based joint generation approach DiffCSP (Jiao et al., 2023). 4) flow-matching-based approach FlowMM (Note that FlowMM only reports results on MP-20 and excludes $d_e$). We follow (Hoogeboom et al., 2022; Jiao et al., 2023) to sample atom numbers from a distribution that is pre-computed based on atom numbers in the training dataset. Performance Indicators Following previous work (Xie et al., 2021), we evaluate the efficacy of our model from three aspects: 1) Validity: Structure and compositional validity of randomly generated 10000 materials. 2) Coverage: Coverage score between generated 10000 materials and test set, defined by average minimum structure distance and average minimum compositional distance. 3) Property Statistics: the earth mover's distance (EMD) between the property distribution of generated crystals and test dataset crystals. Monitored properties include density ($\\rho$, unit g/cm\u00b3), energy predicted by an independent GNN ($E$, unit eV/atom), and the number of unique elements (# elem.).\nResults The evaluation metrics for ab initio generation tasks are listed in Tab. 1. Our method consistently achieves better or competitive property statistics and generation precision on three datasets compared to baseline generative models. For compositional metrics including $d_{elem}$ and compositional validity, our method demonstrates bigger performance improvement for the more challenging dataset MP-20 (+4.34% compared to DiffCSP with the same level of $d_{elem}$), underscoring the importance of modeling atom types in the simplex space."}, {"title": "5.2 STABLE STRUCTURE PREDICTION", "content": "In this section, we extend our method to stable structure prediction task, where the modeling target is $p(L, F|A)$. The condition of atom types $A$ is incorporated into the network by concatenating node feature and atom type embedding, following Jiao et al. (2023)."}, {"title": "5.3 ABLATION STUDY", "content": "Using MP-20 dataset and stable structure predic- tion task, we validate the necessity of proposed components of CrysBFN with results summa- rized in Tab. 3:\n1) By removing the entropy parameter condi- tion cf and using time as condition, match rate drops to 52.16%, proving that, different from original BFN, the non-additive accuracy dynam- ics requires the network to model both mean parameter m and entropy parameter condition c.\n2) By altering the approximated linear-entropy sender accuracy schedule to the hand-designed roughly linear-entropy schedule $c(t) = tc_t(1)$, we validate the effect of exact searched linear entropy schedule.\n3) By replacing the proposed hyper-torus BFN with the original continuous BFN, we observe poor match rate at 6.17%, indicating the importance of redesigning BFN for crystal data. Calculating the computational time for simulating 1000 batches, we observe ~ 4\u00d7 efficiency, verifying fast sampling rate considering the full training procedure of MP-20 requires ~ 150k steps."}, {"title": "5.4 SAMPLING EFFICIENCY EXPERIMENT", "content": "We compare the sampling efficiency of Crys- BFN and DiffCSP over the CSP task on the MP-20 dataset, based on the Number of Func- tion Evaluations (NFE), i.e., the number of net- work forward passes. The experimental results is plotted in Fig. 4. Notably, CrysBFN achieves a remarkable match rate of 60.02% with only 10 step network forwards, surpassing DiffCSP's performance of 51.49% at 2000 step network forwards. This illustrates the exceptional sam- pling efficiency of CrysBFN."}, {"title": "6 CONCLUSION", "content": "In this paper, we present the first periodic Bayesian flow modeling on the hyper-torus, addressing an unprecedented theoretical issue related to non-additive accuracy. Specifically, we introduce a novel entropy conditioning mechanism, theoretical reformulations of BFN, a fast sampling algorithm, and a numerical method for determining the accuracy schedule. Leveraging the proposed periodic Bayesian flow, we implement the first periodic E(3) equivariant Bayesian flow networks for crystal generation. Our approach achieves state-of-the-art performance in crystal generation, with efficiency improved by two orders of magnitude. Additionally, our methodology can be adapted to a wide range of data types and tasks involving hyper-torus data."}, {"title": "ETHICS STATEMENT", "content": "We confirm that our work complies with the ICLR Code of Ethics, and we have carefully considered potential ethical concerns related to the development and use of our proposed method, CrysBFN, for crystal generation. Our method is designed for general crystal generative modeling tasks and does not involve sensitive data or tasks. We strongly encourage users to ensure compliance with relevant privacy regulations and critically assess the model's outputs. We are confirmed that there is no conflict of interest, financial sources or other factors, that could influence the development or presentation of this work.\nWith these considerations, we do not anticipate any violations of the ICLR Code of Ethics in the development or use of this model. And we stress once again that CrysBFN should not be used for malicious purposes, such as creating harmful structures."}, {"title": "REPRODUCIBILITY STATEMENT", "content": "To ensure reproducibility, we give a detailed derivation of the periodic Bayesian flow in Appendix A and the proof of the propositions in Appendix B. All datasets and performance evaluation method used in our experiments are publicly available and clearly specified or cited in Sec. 5. We provide our implementation details including training and sampling procedure, hyper-parameters, used computational resources and anonymous code repository link in Appendix C."}]}