{"title": "From Histopathology Images to Cell Clouds: Learning Slide Representations with Hierarchical Cell Transformer", "authors": ["Zijiang Yang", "Zhongwei Qiu", "Tiancheng Lin", "Hanqing Chao", "Wanxing Chang", "Yelin Yang", "Yunshuo Zhang", "Wenpei Jiao", "Yixuan Shen", "Wenbin Liu", "Dongmei Fu", "Dakai Jin", "Ke Yan", "Le Lu", "Hui Jiang", "Yun Bian"], "abstract": "It is clinically crucial and potentially beneficial to analyze and directly model the spatial distributions of cells in histopathology whole slide images (WSI). However, most existing WSI datasets lack cell-level annotations, owing to the extremely high cost over gigapixel images. Thus, it remains an open question whether deep learning models can directly and effectively analyze WSIs from the semantic aspect of cell distributions. In this work, we construct a large-scale WSI dataset (WSI-Cell5B) with more than 5 billion cell-level annotations and a novel hierarchical Cell Cloud Transformer (CCFormer) to tackle these challenges. WSI-Cell5B is based on 6,998 WSIs of 11 cancers from The Cancer Genome Atlas Program, and all WSIs are annotated per cell with coordinates and types. To the best of our knowledge, WSI-Cell5B is the first WSI-level large-scale dataset integrating cell-level annotations. Besides, CCFormer formulates the collection of cells in each WSI as a cell cloud to model cell spatial distribution. In CCFormer, Neighboring Information Embedding is proposed to characterize the distribution of cells within the neighbor of cells, and a Hierarchical Spatial Perception module is proposed to learn the spatial relationship among cells in a bottom-up manner. Clinical analysis indicates that WSI-Cell5B can be used to design clinical evaluation metrics based on counting cells that effectively assess patients' survival risk. Extensive experiments on survival prediction and cancer staging show that learning from cell spatial distribution alone can already achieve state-of-the-art performance, i.e., CCFormer evidently outperforms other competing methods.", "sections": [{"title": "1. Introduction", "content": "Analyzing histopathology whole slide images (WSIs) presents a significant challenge in computational pathology. It requires managing gigapixel images while capturing the features and distributions of tissues and cells. Significant progress in WSI analysis and related downstream tasks has been achieved by training models on high-quality WSI datasets, such as those from the Cancer Genome Atlas Program (TCGA) [28]. These advancements include tasks like survival prediction [4, 46], cancer staging [25], cancer sub-typing [49], and gene mutation prediction [58].\nExisting methods [4, 5, 20] typically analyze WSIs via conventional image perception frameworks, where the image representation is the cornerstone of downstream tasks. Thus, numerous histological foundation models [6, 31, 32, 55, 58] have been proposed, pre-trained on large-scale datasets for general-purpose representations. Unlike natural images, the analysis of cell spatial distribution within WSIs has been verified as clinically important, associated with the molecular profile [44], tumor progression [9], prognostic biomarkers [37], etc. Heavy reliance on the foun-"}, {"title": "2. Related Work", "content": "Cell Detection and Classification Datasets. Due to the excessively high cost of cell-level annotation, current cell detection and segmentation datasets [13, 15, 16, 23, 52] are composed of patches selected from WSIs. For each patch, these datasets provide cell-level annotations, including the type, coordinates, and segmentation of cells and nuclei. Specifically, PanNuke [13] consists of over 200,000 labeled nuclei and 19 different tissue types. Lizard [16] consists of over 400,000 labeled nuclei of colon tissue. However, as patches are independent, these datasets can not be used for analyzing cell spatial distribution of WSIs, limiting the application on downstream tasks, such as survival prediction, cancer staging, cancer sub-typing, and so on. To build a high-accuracy cell annotation dataset across the entire WSI, reducing the cost of cell-level annotation is a critical issue. In this paper, we propose a weakly supervised label refinement based on foundation models to address this issue.\nWSI Datasets. High-quality WSI datasets [1, 2, 28, 43] consist of WSIs with detailed clinical information. CAMELYON17 [1] consists of over 1,000 WSIs for the detection and classification of breast cancer metastases. PANDA [2] consists of over 12,000 WSIs for Gleason grading of prostate biopsies. EBRAINS [43] consists of over 3,000 WSIs for brain tumor sub-typing. TCGA [28] consists of over 40,000 WSIs from 28 organs. These datasets have significantly facilitated the development of WSI analysis. However, due to a lack of cell-level annotations, the cell spatial distribution of each WSI can not be analyzed based on these datasets. In this paper, we propose WSI-Cell5B to track this issue.\nPatch-Level Methods in Histopathology. Patch-level methods [3, 4, 20, 25, 27, 42, 46, 47] divide WSIs into patches and employs pre-trained models [6, 18, 27, 33] to extract patch features for downstream tasks. Since WSIs are typically giga-pixel images, most existing methods [20, 47] are designed with Multi-Instance Learning (MIL), where WSIs are formulated as a bag of sampled patch features. Although MIL-based method can effectively analyze WSIs, these method only focus on sampled regions of interest, limiting to learning the spatial and semantic relationship of patches across the WSI. To track this issue, graph of patches has been introduced into WSI analysis [3, 4, 25, 46]. Patch-GCN [4] introduces patch-based graph convolutional networks to model the relation-"}, {"title": "3. The WSI-Cell5B Dataset", "content": "We collect H&E-stained WSIs from TCGA [17] to build the WSI-Cell5B dataset. As shown in Figure 2 (a), WSI-Cell5B includes 6,998 WSIs on 11 types of cancers across 10 organs. The statistics of cells are shown in Figure 2 (c). More than 5.2 billion cells (2.0 billion neoplastic cells, 0.7 billion inflammatory cells, and 2.5 billion others) have been identified. To improve the accuracy of annotations and reduce costs, We carefully design an annotation workflow as shown in Figure 2 (b). We perform preliminary annotations on WSIs with DPA-P2PNet [48] pre-trained on PanNuke [13]. However, due to the differences in data distribution between PanNuke and TCGA, there are numerous errors in the preliminary annotations. Moreover, due to the large scale of the cell-level annotations, manual label refinement would result in substantial costs. Therefore, we propose a Weakly Supervised Label Refinement (WSLR) method based on foundation models to minimize human involvement and reduce the costs of label refinement."}, {"title": "3.1. Weakly Supervised Label Refinement", "content": "Label refinement at the cell level incurs significant manual costs. In contrast, annotating at the patch level is less expensive. Therefore, WSLR utilizes samples with credible patch-level labels to fine-tune the pre-trained cell detection and classification models. Specifically, WSLR involves a two-step cycle: 1) screening credible samples from the preliminary data annotations, and 2) fine-tuning. With WSLR,"}, {"title": "3.2. Clinical Analysis", "content": "Cell-level annotations and statistics hold significant clinical importance [37]. To illustrate it, we construct survival risk evaluation metrics based on the WSI-Cell5B and conduct Kaplan-Meier analyses on three types of cancer. Based on clinical experience, the survival risk is highly influenced by the proportion and distribution of neoplastic and inflammatory cells [37]. Therefore, We construct two metrics as shown in the left of Figure 3: Cell Proportion Score (CPS) and Multi-scale Cell Proportion Score (MCPS). CPS considers only the proportions of various cell types within the WSI, whereas the MCPS further considers the distribution of cells within small regions.\nCPS is defined as follows:\n$S_{CPS} = [\\frac{N_{neo}}{N_{total}}, \\frac{N_{inf}}{N_{total}}, \\frac{N_{neo}}{N_{inf}}] \\alpha$\nwhere $S_{CPS}$ denotes Cell Proportion Score, $\\alpha = [a_1, a_2, a_3]^T$ is the weight vector, and $N_{total}, N_{neo}, N_{inf}$ are the number of cells, neoplastic cells, and inflammatory cells within a WSI, respectively. For different types of cancer, $\\alpha$ is set based on the type of cancer to focus on different components. Furthermore, MCPS introduces randomly sized and positioned boxes to perceive the distribution of cells across different scales within the WSI: $S_{MCPS} = \\frac{1}{N_{box}} \\sum_{i=1}^{N_{box}} S_{CPS}^{(i)}$ where $S_{MCPS}$ denotes Multi-scale Cell Proportion Score, $N_{box}$ is the number of bounding boxes, and $S_{CPS}^{(i)}$ denotes computing Cell Proportion Score within the i-th box.\nAs shown in the right of Figure 3, CPS correctly distinguishes between high-risk and low-risk patients on PAAD and KIRC. However, due to the lack of local perception, SPC fails to distinguish patients of HNSC. In contrast, MCPS successfully stratifies patients across the three cancer types and achieves lower p-values than CPS. Compared to CPS, MCPS reduces the p-value from 9.11e-4, 1.35e-2, and 8.04e-2 to 3.08e-5, 4.40e-3, and 1.28e-2 on PAAD, KIRC, and HNSC, respectively."}, {"title": "4. Hierarchical Cell Cloud Transformer", "content": "The framework of CCFormer is illustrated in Figure 4. First, cell clouds are encoded with Neighboring Information Embedding (NIE) to supplement the neighborhood cell distribution. The Hierarchical Spatial Perception (HSP) further learns and aggregates the cell spatial distributions hierarchically. Finally, the feature of cell spatial distributions across the entire WSI is applied to clinical endpoints."}, {"title": "4.1. Neighboring Information Embedding", "content": "The neighborhood cell distribution patterns at the cell level are critical characteristics in distinguishing the cells with the same category. For cells similarly labeled as cancer, whether they are surrounded by a large number of cancer cells or immune cells have completely different clinical significance [54]. Thus, we propose NIE to embed the spatial distribution information of neighboring cells. Specifically, we propose the local and global density features to embed statistical information of neighboring cells.\nFor each WSI, the mean shortest distance among cells $d_{mean}$ across the dataset is used to adaptively set the largest local neighborhood radius $r_{max} = \\lambda_r d_{mean}$, where $\\lambda_r$ is the scale factor. To obtain more precise local spatial information, we introduce discrete number $N_d$ to uniformly divide $r_{max}$ into multiple segments, thereby obtaining a series of radius $r = [r^{(1)}, r^{(2)}, . . . r^{(N_d)}]^T$. We denote the number of the t-th type of cell within the j-th radius of the i-th cell as $N^{(i,r^{(j)},t)}$, $i \\in \\{1,2,\\dots,\\dots,\\dots, C\\}$, $j \\in \\{0,1,2,\\dots, N_d\\}$, $t \\in \\{1,2,...,T\\}$, where C is the number of cells and T is the number of cell types. Specifically, $N^{(i,r^{(0)},t)} = 0$. Thus, the local relative density feature is computed as follows:\n$f_{ld}^{(i,j,t)} = \\frac{N^{(i,r^{(j)},t)} - N^{(i,r^{(j-1)},t)}}{N^{(i,r^{(N_d)},t)}}$\nwhere $f^{(.)}$ denotes the local density feature of the t-th type of cell within the j-th radius of the i-th cell.\nThe local density feature vector of i-th cell $F_{ld} = [f^{(i,r^{(1)},1)}, ... f^{(i,r^{(N_d)},T)}]^T$. Equation 2 measures the relative density of cells within multiple neighborhood radii,"}, {"title": "4.2. Hierarchical Spatial Perception", "content": "In WSI, the spatial distribution of cells is hierarchical. The entire WSI is composed of multiple important regions, each of which consists of smaller clusters of cells. We propose HSP to learn this hierarchical structure of cell clouds. Specifically, HSP groups the cells to divide the WSI into a collection of sub-regions. For each group, we conduct intra-group information interaction to learn the cell spatial distribution of the local region. By aggregating features for each group and repeating the above process at higher levels, HSP hierarchical models cell clouds.\nGiven the coordinates C = $\\{c^{(i)}\\}_{i=1}^{N_{total}}$ and features $F_{cell} = \\{f_{cell}^{(i)}\\}_{i=1}^{N_{total}}$ of a collection of cells, group anchors"}, {"title": "5. Experiments", "content": "We conduct extensive experiments across all cancer types included in the WSI-Cell5B. Specifically, the experiments encompass two critical tasks in WSI analysis, including survival prediction and cancer staging."}, {"title": "5.1. Experiment Settings", "content": "Datasets. Datasets. Metrics. In our experiments, we follow the usual practice to evaluate the performance of survival prediction [4, 36] and cancer staging [3, 25] by C-Index and Macro-F1 with 5-fold cross-validation, respectively.\nBaselines. Baselines."}, {"title": "5.2. Main Results", "content": "Table 1 and Figure 6 report the results of survival prediction and cancer staging, respectively. Point cloud methods and CCFormer achieve competitive results with MIL-based and graph-based methods. Results indicate that patient survival risk and cancer stages are closely related to cell spatial distribution, which aids in the analysis of WSIs and further enhances the accuracy of downstream tasks such as survival prediction and cancer staging.\nSurvival Prediction. As shown in Table 1, CCFormer outperforms other SOTA methods on most cancer types. CCFormer achieves the highest C-Index with improvements of 1% to 4% on the BLCA, BRCA, COADREAD, LUAD, PAAD, and STAD. Besides, CCFormer achieves a C-Index similar to that of the best methods on the HNSC and LUSC, with differences less than or equal to 0.002.\nHowever, modeling cell spatial distribution is insufficient for survival prediction in some cancer types. As evi-"}, {"title": "5.3. Ablation Studies", "content": "Neighboring Information Embedding. Table 2 reports the results of ablation studies on NIE. Both $F_{ld}$ and $F_{gd}$ individually improve the C-Index of survival prediction on PAAD. The combined use of $F_{ld}$ and $F_{gd}$ further enhances the accuracy. Specifically, method with $F_{ld}$, $F_{gd}$, and $F_{ld} + F_{gd}$ outperform the baseline with 6%, 5%, and 9%, respectively. By default, the one-hot embedding of cell types is utilized as input in CCFormer. Ablation studies also show the importance of modeling neighboring cell spatial distributions that CCFormer achieves a better C-Index than the baseline even without cell types as input.\nWe cluster cells based on $F_{ld}$ and $F_{gd}$ via K-Means to visualize NIE. As shown in Figure 7, cells with different neighboring cell spatial distributions are distinguished. Specifically, cancer cell clusters, immune cell clusters, mixed cell regions, and outlier cells are identified.\nHierarchical Spatial Perception. Table 3 reports the results of ablation studies on HSP. Compared to the baseline that generates groups only based on spatial information, in-"}, {"title": "6. Conclusion", "content": "In this paper, we propose WSI-Cell5B, the first large-scale WSI dataset to integrate cell-level annotations with WSIs, comprising 6,998 WSIs of 11 cancers and more than 5 billion cell-level annotations. To reduce the cost of cell-level annotations, we further propose a weakly supervised label refinement method based on foundation models. We argue the collection of cells within a WSI can be regarded as a cell cloud and propose a novel hierarchical Cell Cloud Transformer (CCFormer) to model the spatial distribution of cells. We propose a novel Neighboring Information Embedding (NIE) to embed the neighborhood cell distribution"}]}