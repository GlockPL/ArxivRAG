{"title": "Risk-Aware Vehicle Trajectory Prediction Under Safety-Critical Scenarios", "authors": ["Qingfan Wang", "Dongyang Xu", "Gaoyuan Kuang", "Chen Lv", "Shengbo Eben Li", "Bingbing Nie"], "abstract": "Trajectory prediction is significant for intelligent vehicles to achieve high-level autonomous driving, and a lot of relevant research achievements have been made recently. Despite the rapid development, most existing studies solely focused on normal safe scenarios while largely neglecting safety-critical scenarios, particularly those involving imminent collisions. This oversight may result in autonomous vehicles lacking the essential predictive ability in such situations, posing a significant threat to safety. To tackle these, this paper proposes a risk-aware trajectory prediction framework tailored to safety-critical scenarios. Leveraging distinctive hazardous features, we develop three core risk-aware components. First, we introduce a risk- incorporated scene encoder, which augments conventional encoders with quantitative risk information to achieve risk-aware encoding of hazardous scene contexts. Next, we incorporate endpoint-risk-combined intention queries as prediction priors in the decoder to ensure that the predicted multimodal trajectories cover both various spatial intentions and risk levels. Lastly, an auxiliary risk prediction task is implemented for the ultimate risk-aware prediction. Furthermore, to support model training and performance evaluation, we introduce a safety-critical trajectory prediction dataset and tailored evaluation metrics. We conduct comprehensive evaluations and compare our model with several SOTA models. Results demonstrate the superior performance of our model, with a significant improvement in most metrics. This prediction advancement enables autonomous vehicles to execute correct collision avoidance maneuvers under safety-critical scenarios, eventually enhancing road traffic safety.", "sections": [{"title": "I. INTRODUCTION", "content": "In intricate road traffic scenarios, accurately forecasting the multimodal trajectories of surrounding agents presents a formidable challenge for autonomous vehicles. As a research hotspot in the field of intelligent traffic [1], [2], precise and timely trajectory prediction is paramount for developing the subsequent decision-making system, including planning and control, eventually promoting the universal application of autonomous driving technology.\nStudies on trajectory prediction have progressed rapidly and proposed various prediction structures, resulting in the best prediction scores being constantly updated across different benchmarks [4], [5], [6], [7]. However, existing endeavors primarily concentrate on normal safe traffic scenarios, neglecting safety-critical scenarios, especially those involving imminent collisions. Meanwhile, we observe significant data heterogeneity between normal and hazardous driving behaviors, which can be reflected in the distribution discrepancies of vehicle dynamics, shown in Fig. 1. Compared with normal scenarios, vehicles' motion under safety-critical scenarios presents a more dispersed distribution, where behaviors involving large acceleration and yaw rate were more frequently observed. This means when confronting sudden traffic hazards, drivers tend to adopt more aggressive driving behaviors to avoid collisions. Recent studies have proposed various model structures to explore the interaction relationship between agents and maps since road lanes play an essential role in restricting vehicle behaviors [8], [9], [10], which have been used to facilitate accurate trajectory prediction. However, under safety-critical scenarios, such restrictions become less strict as collision avoidance becomes drivers' most important goal rather than obeying the traffic rules and arriving at the destination. Due to such nonnegligible heterogeneity in both vehicle dynamics and drivers' intentions, even state-of-the-art models (e.g., MTR, Motion transformer, ranking first place at Waymo Motion Prediction leaderboard [10]) fail to exhibit satisfactory trajectory prediction performance under intricate safety-critical scenarios. Quantitative evaluations, as depicted in Table I, underscore the noticeable performance degradation.\nWe learn that existing widely used public trajectory prediction datasets, such as the Waymo open motion dataset (WOMD) [3], [11] and the Argoverse dataset [12], [13], were manually curated to exclude scenarios with potential hazards. Although such safety-critical scenarios belong to low- probability events, these rare cases still constitute a unique modality in real-world traffic. To achieve higher prediction accuracy, models trained on such datasets tend to consider surrounding agents to be 'friendlier' by predicting their trajectories with a lower likelihood of inducing accidents. In particular, some recent studies call it \"social-aware\" or \"social-compatible\u201d prediction [9], [14], [15], [16], [17]. We argue that though this makes sense in the majority of traffic scenarios and enhances prediction performance, it still poses inherent risks of traffic accidents in real-world deployment, potentially jeopardizing occupant safety by disregarding the dangerous trajectory modalities of surrounding vehicles.\nTo address the above issues, this study proposes a risk- aware trajectory prediction framework that can assess driving risks promptly and generate trajectory predictions aligned with prevailing risk levels. Such advancement is achieved by three core components tailored to safety-critical characteristics: a risk-incorporated scene encoder, a trajectory decoder guided by endpoint-risk-combined intention queries, and auxiliary risk prediction. Moreover, to mitigate the dearth of traffic hazards in existing public datasets, we develop an algorithm to automatically generate virtual safety-critical scenarios in CARLA and then conduct extensive driving simulation experiments to establish a safety-critical trajectory prediction dataset. Additionally, realizing the inadequacy of existing metrics in evaluating multimodal trajectory predictions under safety-critical scenarios, a series of specialized metrics are proposed to comprehensively assess the effect of predicted trajectories on subsequent risk judgment and safety decision-making of autonomous vehicles.\nThe contributions of this study are summarized as follows:\n1) A risk-aware trajectory prediction framework is developed, which incorporates various core components to adapt to the characteristics of safety-critical scenarios.\n2) We propose a trajectory prediction dataset that collects drivers' collision-avoidance responses under safety-critical scenarios by conducting large-scale driving simulation experiments. Meanwhile, a set of evaluation metrics tailored to safety-critical trajectory prediction tasks are developed.\n3) We experimentally validate our risk-aware trajectory prediction framework on the safety-critical dataset. Compared with several SOTA models, our approach achieves the best trajectory prediction performance on both classical metrics and tailored safety-critical metrics.\nThis paper is structured as follows: First, recent studies related to models, datasets, and metrics of trajectory prediction are summarized in Section II. Then, Section III elaborates on the problem statement and the formulation of the proposed risk-aware trajectory prediction framework. Section IV details the establishment of the driver-centered risk indicator. Section V introduces our proposed training dataset and evaluation metrics designed for safety-critical scenarios. Experiment Setup and result analyses are conducted in Section VI, which are then discussed and concluded in Section VII."}, {"title": "II. RELATED WORK", "content": "As a connecting module between perception and planning, trajectory prediction has long been considered crucial to the ability of autonomous vehicles to understand traffic scenes, thus attracting significant research interest over the past years [18], [19], [20]. To achieve accurate trajectory prediction, researchers have carried out research from different aspects, including the prediction method itself, the training dataset, and the evaluation metrics. Here, a brief review summarizes the existing research from the above three aspects.\nRecently, various trajectory prediction frameworks have been proposed, constantly updating the best performance across different public benchmarks. These models typically adopt a hierarchical encoder-decoder architecture [21], [22], [23], [24], [25]. Given the manifold traffic factors influencing the vehicle's future motion, such as road geometry and surrounding agents' historical behaviors, recent studies elaborated different structures of the encoder to process these diverse factors and aggregated information via specific feature fusion techniques to achieve accurate scene understanding, e.g., the early fusion strategy for input modalities with factorized attention proposed by Wayformer [4] and the query-centric scene encoding paradigm proposed by QCNet [5]. Leveraging high-dimensional representations processed by the encoder, the decoder forecasts multiple future trajectories of the target agent along with their probabilities, i.e., modeling the multimodal motion patterns. For instance, MTR used a set of learnable motion query pairs as spatial intention priors to facilitate multimodal prediction [10]."}, {"title": "III. RISK-AWARE TRAJECTORY PREDICTION", "content": "This section presents the detailed formulation of the proposed risk-aware trajectory prediction framework tailored to safety-critical scenarios (Fig. 2).\nThe core goal of trajectory prediction is to accurately predict future positions (generally in 2D coordinates) of the target vehicle $O_{-Th:0}^a$, given its historical trajectory and observed surroundings $S = {A, M}$. S includes other agents' historical trajectories $A_{-Th:0}^{DO:Na}$ and map information $M_{O:Nm}^{O:P}$ represented by lane segments, where Tf represents the future prediction frames, Th is historical frames, i denotes the i-th mode of multimodal trajectory prediction, Na is the number of other observed agents, Nm denotes the number of surrounding lane segments, and P is the number of points to represent a lane segment's centerline.\nFor trajectory prediction under safety-critical scenarios, we emphasize the importance of quantifying risk to achieve risk- aware prediction. Thus, the surroundings S are expanded as $S = {A, M, R}$, where the collision risk information between the target vehicle and other agents $R_{-Th:0}^{DO:Na}$ is estimated based on an artificial potential field method, detailed in Section IV.\nThe design of our model was inspired by a previous SOTA trajectory prediction model, i.e., MTR [10], [37], which adopted a classical encoder-decoder architecture. Different from the original MTR, we incorporated a series of innovative risk-aware components to cater to the safety-critical trajectory prediction task. Before detailing them, here we first briefly introduced the basic architecture of our model, which was similar to the original MTR.\nScene Encoder. The scene encoder first utilized polyline encoders, developed based on PointNet [38], to encode the raw inputs of agents $A_{-Th:0}^{DO:Na}$ and maps $M_{O:Nm}^{MO:P}$ into high- dimension representations, which were then concatenated together. Next, a standard Transformer encoder was applied to further mine the coupling relationship between different inputs to achieve a more comprehensive encoding of scene context. To capture the potential future interactions between different agents, a multilayer perceptron (MLP)-based dense future prediction module was used to densely predict the trajectories of all agents, which was taken as an auxiliary supervised learning task with the loss denoted as $L_{dense}$.\nTrajectory Decoder. Taking the encoded agent and map features as key and value, a Transformer decoder consisting of $N_a$ cross-attention layers were applied to propagate information among different features. To generate multimodal predictions, the original decoder in MTR used 64 motion pairs, i.e., trajectory endpoints clustered by a k-means clustering algorithm, as the spatial intention queries. At last, MLP-based prediction heads predicted the future motions, including trajectory (each trajectory point is represented as a distribution modeled by a Gaussian mixture model), velocity, and their probabilities, which were used to calculate the final trajectory loss $L_{traj}$, defined as:\n$L_{traj} = L_{reg} + L_{cls} = GR(\tau, \\hat{\tau_j}) + CE(p_{1:N}, j) $\n$j = arg \\underset{i}min {\\rm FDE}(\\kappa_i, \tau_{g1})$\nwhere GR(,) denotes the Gaussian regression loss, CE(,) is the cross-entropy loss, $\tau$ and $\\hat{\tau}$ denote the j-th predicted trajectory and the ground-truth trajectory, respectively, $P_{1:N}$ is the predicted probability of all N trajectory predictions, $\\kappa_i$ is the i-th endpoint intention, and j represents the sequence number of the endpoint intention with minimal errors from the ground-truth endpoint.\nThough MTR performed well on several public trajectory prediction datasets, its prediction performance under safety- critical scenarios still needs to be further enhanced. Therefore, we incorporated various architecture modification and training techniques into the original MTR to help it better interpret safety-critical scenarios, identify the potential risk level, and predict risk-aware multimodal trajectories. Technically, the core components of the proposed risk-aware model include: a risk-incorporated scene encoder, endpoint-risk-combined intention queries, and auxiliary risk prediction.\nAs described above, we introduced the quantitative traffic risk information $R_{O:Na}^{O:Th}$ as an independent input in addition to the conventional agent and map information. After being encoded by three polyline encoders $PolyEnc(\u00b7)$, agent features $F_A$, map features $F_M$, and risk features $F_R$ were concatenated and passed together to a standard Transformer encoder with $N_{enc}$ stacked multi-head self-attention layers, where the risk features could further interact with the agent and map information to help the model enhance the understanding of safety-critical scene context (Fig. 2c). The whole process can be represented as:\n$F_{A/M/R} = PolyEnc(A_{O:Na/MO:Nm/RO:Na}^{O:Th})$\n$E_{i+1} = SelfAttn(q = E_i + PE(E_i), k = E_i + PE(E_i), v = E_i), i = 0,1,..., N_{enc} - 1$\n$E_A, E_M, E_R = Div(E_{N_enc})$\nwhere $E_0 = [F_A, F_M, F_R] \\in \\mathbb{R}^{(N_a+N_m+N_a) \\times D_f}$ represents the concatenated input features that aggregate all the scene context features, $D_f$ is the feature dimension, [,] is the concatenation operation, q, k, and v denote the query, key, and value in the self-attention module, and PE() denotes the sinusoidal position encoding of input tokens. The final outputs of the encoder $E_N$ was divided (Div(\u00b7)) into the agent, map, and risk features $E_a \\in \\mathbb{R}^{N_a \\times D_f}, E_M \\in \\mathbb{R}^{N_m \\times D_f}$, and $E_R \\in \\mathbb{R}^{N_a \\times D_f}$, which would be taken as the independent key and value for the subsequent independent cross-attention modules in the trajectory decoder to provide scene context information.\nOur proposed trajectory decoder contains $N_{dec}$ decoder layers, one of which is depicted in Fig. 3. Each layer adopts two parallel Transformer decoder layers (gray box) to independently process trajectory-related features (blue box) and risk-related features (red box), which are then integrated to make final predictions.\nInspired by taking the clustered trajectory endpoints as spatial intention priors in MTR, we innovatively proposed to incorporate risk intentions to represent the potential risk level of the future scenario as priors. We expected this modification could instruct our model to make more risk-aware trajectory predictions. Technically, we first utilized MLPs to encode both endpoint intention queries $I^t$ (i.e., $N_{end}$ two-dimensional coordinates) and risk intention queries $I^r$ (i.e., $N_{risk}$ scalars) into high-dimension representations $T^{t/r}$:\n$T^{t/r} = MLP PE(I^{t/r})$\nThen, two multi-head self-attention modules were used to process trajectory-related and risk-related features separately, where $T^t$ and $T^r$ were taken as the position embedding for queries and keys, developed as:\n$S^{t/r} = SelfAttn(q = Q_i^{t/r} +T^{t/r}, k = Q_i^{t/r} +T^{t/r}, v = Q_i^{t/r}), i = 1,2,..., N_{dec} - 1$\nwhere $Q_i^{tr} \\in \\mathbb{R}^{N_{end}/N_{risk} \\times D_f}$ denotes the trajectory-related and risk-related query content features at the i-th layer of the decoder, respectively. The query content features at the zeroth layer $Q_0$ are initialized as zeros.\nFor trajectory-related modules, the encoded information from self-attention $S^t$ and endpoint intentions $T^t$ were taken as the query in two cross-attention modules to interact with the agent features $E_A$ and map features $E_M$ from the encoder, respectively, formulated as:\n$C^{A/M} = CrossAttn(q = [S^t,T^t], k = [E_{A/M}, PE(E_{A/M})], v = E_{A/M})$\n$C = MLP([C^A, C^M])$\nwhere the outputs of cross-attention $C^A$ and $C^M$ were then aggregated into C by an MLP. On the other hand, the risk- related modules also adopted a cross-attention module to query the encoded risk features $E_R$:\n$C^r = CrossAttn(q = [S^r,T^r], k = [E_R, PE(E_R)], v = E_R)$\nNote that the mode number of trajectory-related features $C \\in \\mathbb{R}^{N_{end} \\times D_f}$ and risk-related features $C^r \\in \\mathbb{R}^{N_{risk} \\times D_f}$ is different. To integrate them for the final predictions, we first extended their modes by copying trajectory-related features $N_{risk}$ times to get $C^{te} \\in \\mathbb{R}^{(N_{end} \\times N_{risk}) \\times D_f}$ and copying risk- related features $N_{end}$ times to get $C^{re} \\in \\mathbb{R}^{(N_{risk} N_{end}) \\times D_f}$. Then, we utilized an MLP to aggregate them into an integrated feature, denoted as $Q_i \\in \\mathbb{R}^{(N_{end} \\times N_{risk}) \\times D_f}$. The above process can be described as:\n$C^{te} = Ext(C^t, N_{risk}), C^{re} = Ext (C^r, N_{end})$\n$Q_i = MLP([C^{te}, C^{re}])$\n$\\hat{\tau}^{TP,i} = MLP(Q_i), p_i = MLP(Q_i)$\nwhere Ext(,) denotes the extension by copying and $\\hat{\tau}^{TP,i}, p_i$ represent the predicted trajectories and risks at the i-th layer, both with the prediction modality of $N_{end} \\times N_{risk}$. By incorporating endpoint-risk-combined intention queries, we established a two-dimensional prediction matrix, effectively ensuring that the multimodal trajectories predicted by our model not only covered various spatial intention priors (represented by trajectory endpoints) but also took into consideration different risk levels of the future traffic scene.\nFor the next (i + 1)-th decoder layer, the trajectory-related and risk-related query content features $Q_{i+1}^{t/r}$ were obtained by averaging the corresponding dimensions of the integrated feature Q; to narrow down the number of predicted modes and restore them to their original dimensions, formulated as:\n$Q_{i+1}^{t} = Avg(Q_i, d = N_{end})$\n$Q_{i+1}^{r} = Avg(Q_i, d = N_{risk})$\nwhere $Q_{i+1}^{t/r} \\in \\mathbb{R}^{N_{end}/N_{risk} \\times D_f}$ and Avg(,d) denotes the average operation with the dimensions d to retain.\nTo iteratively update the predictions, the above process was repeated $N_{dec}$ times in the trajectory decoder. Via such iterative optimization, trajectory-related features and risk- related features were effectively integrated, not only facilitating the information interaction between endpoint intentions and risk intentions but also promoting the information propagation within each type of intention. A detailed analysis of the effect of the proposed risk intention queries on trajectory prediction under safety-critical scenarios is given in Section VI. E.\nIn addition to the conventional trajectory prediction task, we advocated simultaneously predicting the future evolution of traffic risks as an auxiliary supervised learning task to help the model identify the current risk levels. Compared with conventional models, the proposed risk-incorporated scene encoder and risk intention queries endowed our risk-aware model with the ability to accurately predict future risks. Upon obtaining the integrated feature $Q_i$ with $N_{risk} \\times N_{end}$ modes, an independent MLP was adopted to predict the future risk sequence of the target vehicle, which is formulated in (8).\nTo promote multimodal predictions during optimization, the auxiliary risk prediction loss $L_{risk}$ was calculated in a similar way as the trajectory prediction loss $L_{traj}$, i.e., a hard- assignment strategy that calculates losses based on the risk intention query with minimal errors, formulated as:\n$L_{risk} = - max(2_t^r) + CE(P_N, j)$\n$j = arg \\underset{i}min ||\\gamma - max(\\hat{r}_{i_t}^{TP})||_1$\nwhere $||\\cdot||_1$ denotes the L1 norm, $\\gamma$ and $\\hat{r}^r_{TP}$ are the j-th predicted risk sequence (in three dimensions, i.e., probability, cost, and risk) of the target agent and its ground-truth risk (calculated by the risk quantification method in Section IV), $P_N$ is the predicted probability of N risk predictions, $v_i$ represents the i-th risk intention, and j represents the sequence number of the risk intention with minimal errors from the maximum value of the ground-truth risk sequence.\nNote that, for brevity, we simplified the formulation of $L_{traj}$ and $L_{risk}$ in (2) and (10). In fact, for loss calculation, the selection of predicted trajectories and risks from multimodal predictions is coupled. Technically, we first selected the optimal endpoint intention with the index of i and the optimal risk intention with the index of j, independently. Then, the (i, j)-th prediction (including both trajectory and risk) in the coupled prediction matrix (Nrisk, Nend) was selected as the optimal prediction to calculate losses in (2) and (10).\nTo sum up, the overall training loss $L$ consists of three terms (Fig. 2e): trajectory prediction loss $L_{traj}$, dense motion prediction loss $L_{dense}$, and risk prediction loss $L_{risk}$."}, {"title": "IV. DRIVER-CENTERED RISK QUANTIFICATION", "content": "Numerous indicators have been proposed to quantify traffic risks, the most classic of which is time-to-collision (TTC) and time headway (THW). Since our ultimate goal is to predict vehicle trajectories determined by the driver's decision- making behaviors, an indicator that can assess the level of traffic risk from the driver's perspective is needed to assist in trajectory prediction. Thus, inspired by a previous study [39], we developed an artificial potential field-based traffic risk indicator. Technically, traffic risk perceived by drivers can be represented as the product of two parts: the probability of a collision and its cost (Fig. 2b) [40].\nThe driver's subjective belief about the probability of a crash accident occurring was quantified via a method named driver's risk field (DRF) [39]. The DRF is represented as a two-dimensional matrix, where the target agent is located in the middle, and the value of each other cell stands for its collision probability with the target if an obstacle exists (Fig. 4). To model it, we assume that the target vehicle maintains a constant velocity and angular velocity in the coming few seconds. Thus, based on the target vehicle's current states, e.g., positions, velocities, and steering angle, we can utilize a planar 3-DoF bicycle model to estimate its future motion, which is represented as an arcing curve. Then, the position coordinates of each point in the DRF are projected onto this arcing curve. The new coordinate contains two parameters, i.e., longitudinal position s and lateral position t. Following the principle that the closer the obstacle is, the greater the risk, the DRF was modeled as a torus with a Gaussian cross-section with varying height (a) and width (\u03c3), which can be formulated as:\n$DRF = a(s) \\cdot exp \\frac{-(t)^2}{2\\sigma^2(s)}$\n$a(s) = \\begin{cases} A \\cdot \\frac{(s_{max} - max(s, s_{min}))^2}{(s_{max} - s_{min})^2} , & \\text{if } s < s_{max} \\\\ 0, & \\text{if } s \\geq s_{max} \\end{cases}$\n$\\sigma^2(s) = (B \\cdot max(s, s_{min}) + C)^2$\nwhere smax is the maximum longitudinal position affected by the risk receptive field of drivers and is assumed velocity dependent, i.e., $s_{max} = D \\cdot (max(v, 5))^E$, smin is the allowed minimal value of s, and A~E are constant coefficients.\nThe cost of a potential collision refers to the collision severity and occupant injury risks, affected by various factors, including vehicle dynamics, usage of restraint systems, and occupant characteristics. For simplification, we quantified the cost based on the impact energy at the vehicle level, which mainly contains three parts: a constant basic cost Er for collisions with any obstacle, an absolute cost equal to the obstacle's kinetic energy Ea depending on its mass and absolute velocity, and a relative cost E, depending on the obstacle's relative velocity towards the target vehicle. The total collision cost equals the weighted sum of the three.\nAfter multiplying the above two parts, a comprehensive driver-centered risk indicator was obtained. Note that the risks posed to the target vehicle by different agents were calculated independently. For the target vehicle, the overall risk equals to the sum of all agents' risks, i.e., $R^o = \\sum_{i=1}^{N_a} Ri$. After concatenation, the final risk information $R_{O:Na}^{O:Th}$ with three dimensions, i.e., probability, cost, and comprehensive risk, was obtained. By integrating the agent and map information in traffic scenarios from the driver's perspective, the risk information R is regarded as a vital auxiliary input for the trajectory prediction model to enhance its ability of scene understanding and risk perception, eventually assisting the model in making risk-aware trajectory predictions."}, {"title": "V. DATASET AND METRICS TAILORED TO SAFETY-CRITICAL SCENARIOS", "content": "In addition to the risk-aware trajectory prediction model, training data and evaluation metrics tailored to safety-critical scenarios are also critical to improving prediction performance, which are detailed in this section.\nFor the establishment of the safety-critical trajectory prediction dataset, given the danger and low frequency of safety-critical scenarios in real-world traffic, we conducted a large-scale driving simulation experiment to ensure the safety and efficiency of data acquisition (Fig. 5).\nIn terms of hardware, we utilized a high-fidelity driving simulator with a fully instrumented vehicle cab mounted on a 6-DOF motion system with three monitors to provide immersive traffic stimulation. Regarding software, various safety-critical events were designed based on the open-source simulation platform CARLA [41]. According to NHTSA [42], our experiment concentrated on three of the most frequent vehicle-to-vehicle conflict types, i.e., rear-end, cut-in, and merging scenarios (Fig. 6). We developed a hazard-triggering algorithm to achieve the random automatic generation of safety-critical events. Technically, this algorithm first assessed the collision risk between the ego vehicle controlled by the volunteer and surrounding background vehicles (controlled by our algorithm). The most aggressive background vehicle with the highest risk was selected as the hazard-triggering vehicle to execute aggressive behaviors and create traffic conflicts. Volunteers' various collision-avoidance behaviors subject to the random traffic hazards were automatically collected to form the final safety-critical trajectory prediction dataset after a series of necessary post-processing procedures. Each hazard-triggering instance was followed by a minimum 30-second interval, allowing drivers to revert to natural driving states.\nTwelve volunteers, aged between 22 and 43 years, with an average annual driving distance of more than 8,000 km, participated in the experiment, except one volunteer withdrew due to motion sickness. Volunteers underwent four 30-minute driving sessions, with 10-minute rest between sessions. Participants were free to select their routes and were responsible for executing evasive maneuvers when necessary. The Institutional Review Board (IRB) of Tsinghua University has approved the whole experimental procedure.\nVia the experiment, we established a dataset consisting of 1620K frames of continuous driving data (22.5 hours with 20Hz) with detailed trajectory and map information. Among this data, 2088 safety-critical events were extracted, each covering five seconds before and after the hazard occurrence, which is defined as the moment when the hazard-triggering vehicle shows an obvious abnormal behavior, such as emergency braking at a deceleration exceeding a certain threshold and a reckless lane change with the lane offset exceeding a certain threshold. To increase the diversity of prediction cases, threshold values under different safety- critical scenarios vary, following Gaussian distribution. After removing anomalies, over 350K frames of 1879 safety-critical events are available for training and validating the proposed prediction framework. Table II summarizes the distributions of collected events' conflict type, collision time, and driver's emergency maneuvers when confronting safety-critical events. For more details about the dataset, please refer to another paper our team is currently preparing.\nMost existing trajectory prediction metrics measure errors in terms of the trajectory itself, i.e., distance errors between predicted and ground-truth trajectories. Under safety-critical scenarios, the predicted trajectories of surrounding agents will directly determine the ego autonomous vehicle's subsequent decision-making, eventually affecting the collision risk and the potential occupant injury severity. Thus, we advocate further considering the effects of trajectory prediction on evaluating the collision probability and severity.\nTechnically, for collision samples in the safety-critical dataset, prediction errors of relative collision velocity between the two vehicles were calculated to represent the estimation accuracy of collision severity. Prediction errors of the collision time were also calculated. Additionally, for safety-critical trajectory prediction, we emphasize that it is hazardous to predict a collision as a non-collision accident, which might cause autonomous vehicles to misjudge the collision risk and fail to make timely and reasonable avoidance behaviors. Thus, for collision samples, we calculated the collision miss rate (MR). We defined that a collision miss occurs when all the multimodal predicted trajectories do not coincide with the surrounding vehicles' trajectories. Regarding non-collision samples, we evaluated the risk prediction errors based on the driving risk indicator proposed in Section IV to represent collision probability.\nSimilar to trajectory-related metrics, we also adopted mean square error and miss rate to calculate errors in predicting collision velocity (i.e., $MSE_{velo}^k$ and $MR_{velo}^k$), collision time (i.e., $MSE_{time}^k$ and $MR_{time}^k$), and traffic risk (i.e., $MSE_{risk}^k$ and $MR_{risk}^k$), where k = 6 denotes the multimodal prediction with six trajectories, and k = 1 denotes the unimodal prediction by selecting the predicted trajectory with the maximum predicted probability. $MR_{velo}^k$, $MR_{time}^k$, and $MR_{risk}^k$ were defined as the ratio of the validation scenarios where the prediction error of collision velocity, collision time, and traffic risk exceeds a threshold of 2.5 m/s, 0.25 s, and 0.15 (after normalization), respectively.\nIn addition, for existing trajectory-related metrics (e.g., minADE and min FDE), we split the samples in the validation dataset into four groups depending on the time of the collision (non-collision, collision-in-1s, collision-in-3s, and collision- in-5s) and calculated the evaluation results independently since the prediction time horizon significantly influences these metrics' magnitude."}, {"title": "VI. EXPERIMENTS", "content": "This section presented and discussed the experimental setup and evaluation results. We first introduced the validation experiments and implementation details. Second, the results of our proposed risk-aware trajectory prediction model are compared with those of several baseline methods. Finally, necessary ablation studies were conducted to demonstrate how each module in our model contributes to the final result.\nThe hidden feature dimensions of encoder $D_{enc}$ and decoder $D_{dec}$ are set as 256 and 512, respectively. All the self-attention and cross-attention modules adopt a standard setting, i.e., six attention layers, each with eight heads. Dropout rate in attention layers is 0.1. Due to the sparsity of lane segments in CARLA, we deleted the dynamic map collection module in the original MTR.\nRegarding endpoint intentions, sixteen motion queries ($N_{end}$ =16) were generated by clustering the endpoints on the training set of our proposed safety-critical dataset based on a k-means clustering algorithm. For risk intentions, we manually set a series of values to represent different urgency levels of traffic scenes, given the actual risk distribution. Specifically, we adopt two schemes: a model with three risk queries ($N_{risk}$ = 3), i.e., 300, 600, and 999 (maximum risk value representing collision conditions), and another model with four risk queries ($N_{risk}$ = 4), i.e., 300, 500, 650, and 999.\nBased on the proposed safety-critical trajectory prediction dataset, we first evaluated our models using classical metrics. As shown in Table III, the proposed two models, i.e., ours-3rq and ours-4rq, outperformed the baseline methods on most metrics with remarkable margins, averagely decreasing minADE and minFDE by 13.6% (i.e., 7.7%, 17.9%, 19.2%, and 9.4% across the four groups) and 11.5% (i.e., 1.1%, 21.1%, 18.2%, and 5.5% across the four groups) from the ten baseline models' best performance. From the total 16 metrics, our proposed models only showed suboptimal results on the metrics of MR and b-FDE for Non-collision and b-FDE for collision-in-1s, yet they still remained very close to optimal performance.\nTraditional physical-based methods, i.e., CV and VA, performed the worst as expected, especially in the long-term prediction horizon, e.g., Non-collision and Collision-in-5s. However, CV has achieved pretty good performance for short- term prediction, e.g., Collision-in-1s, even better than some SOTA trajectory prediction models. This proves that it is feasible for some existing studies to use the CV model to predict vehicle trajectories in the event of an impending collision, where a collision generally occurs no more than 1s [26], [44]. As classic machine learning models, GRU performed better than LSTM, but both performances were far inferior to that of the recently proposed models due to their simple network structure. As for the SOTA models, the latest proposed methods (e.g., EDA and HPNet) did not exhibit a significant performance improvement over the older methods (e.g., MTR and Wayformer). This could be caused by the fact that the latest methods made elaborative modifications tailored to a specific benchmark to obtain performance improvement in the leaderboard, which thus might compromise their generalization ability to some extent. As a vital basis that derived many other SOTA models (e.g., EDA), MTR demonstrated good generalization ability with superior performance among the several SOTA models. Thus, our proposed models were developed based on MTR. Compared with these previous SOTA models, our risk-aware model achieved significantly better performance on most classical metrics by incorporating various architecture modifications and training techniques tailored to safety-critical scenarios.\nTable IV displays the performance comparison on metrics tailored to safety-critical scenarios. Our models consistently maintained the leading position on all the eleven metrics. This demonstrates that our models are not just good at predicting trajectories but also do well in estimating the future evolution of traffic risks and the consequences of collisions, e.g., collision velocity and collision time, which is essential for the subsequent guidance of autonomous vehicles to carry out correct safety decisions to reduce collision probability and mitigate injuries [26], [45], [46].\nIn addition, note that MTR outperformed HPNet on most classical metrics, but HPNet demonstrated much better performance on most of our proposed safety-critical metrics. This displays a potential risk in selecting the best trajectory prediction model for safety-critical scenarios solely based on the classical trajectory prediction metrics, further proving the importance of safety-critical metrics. Moreover, we found MTR performed relatively well for unimodal prediction, i.e., k = 1, but showed an apparent performance reduction for multimodal prediction with k = 6, which could be attributed to the inappropriate design of multimodal queries. To rectify this defect, according to the characteristics of safety-critical scenarios, we innovatively incorporated a set of risk intention queries and combined them with endpoint intentions to guide more risk-aware multimodal predictions.\nThe performance of the two models was similar on most evaluation metrics. One difference is that the model of ours-3rq performed better on most classical metrics, while ours-4rq demonstrated slightly better predictions on safety- critical metrics, which can be attributed to the refined design of risk intention queries, i.e., incorporating more risk levels.\nSome existing studies on traffic safety utilized Monte Carlo to randomly sample agents' future trajectories and then estimated their collision probability under safety-critical scenarios [47], [48]. Inspired by these approaches, we estimated the collision probability in a similar way and substituted the randomly sampled trajectories with the predicted multimodal trajectories of the target vehicle. The overall estimated collision probability was 54.7% for the model ours-4rq. Further, the collision probability was estimated as 78.8% and 28.0% for collision and non-collision cases, respectively. For ours-3rq, the three probabilities were 55.0%, 78.9%, and 28.3%. The significant probability difference between collision cases and non-collision cases proved that our proposed models could be used for autonomous vehicles to detect whether there is a potential collision in the near future.\nBesides quantitative results, we also provide qualitative results to show our predictions under safety-critical scenarios.\nAs shown in Fig. 7, four representative safety-critical scenarios are displayed, including two collision scenarios (I and II) and two non- collision scenarios (III and IV).\nIn Scenario I (Fig. 7a), the blue vehicle suddenly braked to stop when passing through a green light intersection, triggering traffic danger. Due to the small car-following distance and the driver's slow reaction, the target vehicle rear- ended the front vehicle. Seeing from the predicted trajectories represented by green dashed lines, our model accurately captured the target vehicle's intention of longitudinal braking. Additionally, our model also predicted two reasonable turning intention modes, demonstrating the comprehensiveness of the model in multimodal prediction. The risk evolution curves below show that these turning intentions effectively reduced traffic risks, ultimately achieving collision avoidance.\nScenario II and III each presented a safety-critical scenario triggered by surrounding vehicles' malicious lane changes and deceleration (Fig. 7b and 7c). In Scenario II, the excessive relative speed between two vehicles led to an accident, while the target vehicle in Scenario III took deceleration in advance and avoided crashes. The predicted trajectories in Scenario II could be classified into two collision-avoidance intentions, namely, changing lanes to the right (with four trajectories, three of which still resulted in accidents) and driving out of the road to the left (with two trajectories, both of which avoided collisions). In Scenario III, our model accurately predicted the target vehicle' trajectory to evade collisions by timely braking. Additionally, our model also precisely estimated the speeds of the vehicles in the left front and left rear when predicting the two trajectories of turning left, thereby these trajectories adopting appropriate steering rates and deceleration without causing new accidents.\nIn Scenario IV (Fig. 7d), the target vehicle was instructed to change lanes to the left, but simultaneously, the blue vehicle began emergency braking to create a hazard. In the predicted trajectories, the target vehicle adopted different longitudinal decelerations to reduce collision risks to varying degrees, while two other predicted trajectories also avoided collisions without significant deceleration, which were achieved by executing another left lane change.\nOverall, we concluded that our proposed model achieved ideal multimodal prediction capabilities under different safety- critical scenarios and various risk levels. It not only achieved a high degree of overlap with the ground-truth trajectories but also accurately captured the future evolution of traffic risks.\nWe also visualized the comparison with SOTA models (Fig. 8).\nIn Scenario I (Fig. 8a), trajectories predicted by different models all collided with the blue vehicle, but only our model and EDA predicted the target vehicle's deceleration, achieving a more accurate estimation of the collision speed. In Scenario II (Fig. 8b), our model successfully predicted that the target vehicle would change lanes to the left while emergency braking to avoid the accident, while the other models only predicted the deceleration behaviors, still causing accidents. In the curved road shown in Scenario III (Fig. 8c), our model accurately captured the target vehicle's lane change intention.\nFollowing the same routine as the main experiment, we conducted a series of ablation experiments for the three proposed risk-aware components, i.e., RSE, ERQ, and APR. Considering the sequence of the three components in processing input data, we added them to the original MTR model to observe their impact on prediction accuracy. As displayed in Table V, most evaluation metrics, e.g., non-collision minADE and $MSE_{risk}^{K=6}$, kept reducing when different components were added. The introduction of RSE improved the encoder's scene encoding ability to understand safety-critical scene context, leading to the reduction of some classical metrics, e.g., minADE and minFDE for non-collision cases. As the core module of our model, ERQ was designed to achieve risk-aware predictions by incorporating a set of pre-defined risk intention queries as prediction priors, eventually contributing to the significant reduction on most metrics, especially for collision-in-5s minADE and $MR_{velo}^{k=6}$. Introducing APR further improved the whole technical framework with the best performance. Overall, the ablation studies preliminarily proved that each component contributes to the final enhancement of trajectory prediction performance under safety-critical scenarios.\nTwo models with three and four risk queries were proposed in the main experiment, i.e., ours-3rq and ours-4rq. Table VI further investigated the effects of the number of risk intention queries (from two to six). Models of ours-3rq and ours-4rq performed best in most metrics. When only two risk queries exist, the model performed well on classical trajectory-related metrics and even obtained the lowest minFDE for the collision-in-5s cases. However, its performance on the tailored safety-critical metrics declined significantly due to insufficient consideration of the risk levels. The prediction performance also dropped when the number of risk queries improved to five or six. This might be caused by the lack of training data when the modes of multimodal prediction (i.e., $N_{risk} \\times N_{end}$) improve with the predicting multimodal trajectories, eventually contributing to the achievement of risk-aware trajectory prediction under safety-critical scenarios.\nTable VII investigated the effects of the relative weight of risk prediction loss. The weight of 0.3 performed best on most metrics. Additionally, we found that increasing risk weight was helpful in improving the forecasting effect on the metrics tailored to safety-critical scenarios (e.g., $MR_{velo}^{k=6}$ of 0.166 with the risk weight of 1), and vice versa was conducive to the performance on classical metrics (e.g., non-collision minFDE of 1.851 with the risk weight of 0.03).\nTo further analyze the effect of the proposed risk intention queries on safety-critical trajectory prediction, we made an additional statistical analysis of the distribution characteristics of the multimodal trajectory predictions guided by various risk queries. The results are shown in Table VIII. We observed that for both models, i.e., ours-3rq and ours-4rq, the estimated crash rate and maximum traffic risk monotonically rose with the increase of the risk query level. We considered that through carefully designing a set of pre-defined risk values as prediction priors (from low-risk level to high-risk level), after training, different risk intention queries successfully learned to be responsible for their respective risk regions when predicting multimodal trajectories, eventually contributing to the achievement of risk-aware trajectory prediction under safety-critical scenarios."}, {"title": "VII. CONCLUSION", "content": "This study presents a novel risk-aware vehicle trajectory prediction framework tailored to safety-critical scenarios. Different from conventional approaches, we propose a series of risk-aware prediction components specifically developed in combination with the characteristics of safety-critical scenarios. The proposed risk-incorporated scene encoder aims to achieve risk-aware encoding of hazardous scene contexts by introducing quantitative traffic risk computed based on an artificial potential field approach. Combining spatial endpoint intentions and traffic risk intentions into a two-dimensional query matrix, the multimodal trajectories predicted by our trajectory decoder effectively cover various motion modes and risk levels. The effectiveness of our model is verified through quantitative and qualitative analyses on a newly acquired safety-critical trajectory prediction dataset. The experimental results reveal that our model outperforms mainstream methods and existing SOTA models on not only the regular evaluation metrics (e.g., minFDE) but also the tailored metrics developed for safety-critical scenarios.\nTo the best of the authors' knowledge, this study is the first to conduct trajectory prediction under safety-critical scenarios. To sum up, the contributions of this study are threefold: (1) A series of core trajectory prediction components to adapt to safety-critical scenarios and achieve risk-aware predictions. (2) A new trajectory prediction dataset that provides large-scale driving behaviors under safety-critical scenarios. (3) A series of evaluation metrics tailored to trajectory prediction under safety-critical scenarios.\nThis study just focuses on trajectory prediction tasks under safety-critical scenarios. However, in real-world traffic scenarios, normal situations gradually evolve into hazardous ones. Thus, it is challenging to define the exact time when traffic hazards occur precisely. Thus, more efforts should be made to develop a trajectory prediction approach that can handle both normal and safety-critical scenarios by adaptively switching prediction modes according to the risk level in the scenario. To achieve it, domain adaptation may be a promising method. Meanwhile, compared with existing public datasets, our proposed safety-critical dataset is not big enough to bring the ability of data-driven methods into full play. The further expansion and detailed validation of our dataset are now underway."}]}