{"title": "Risk-Aware Vehicle Trajectory Prediction Under Safety-Critical Scenarios", "authors": ["Qingfan Wang", "Dongyang Xu", "Gaoyuan Kuang", "Chen Lv", "Shengbo Eben Li", "Bingbing Nie"], "abstract": "Trajectory prediction is significant for intelligent vehicles to achieve high-level autonomous driving, and a lot of relevant research achievements have been made recently. Despite the rapid development, most existing studies solely focused on normal safe scenarios while largely neglecting safety-critical scenarios, particularly those involving imminent collisions. This oversight may result in autonomous vehicles lacking the essential predictive ability in such situations, posing a significant threat to safety. To tackle these, this paper proposes a risk-aware trajectory prediction framework tailored to safety-critical scenarios. Leveraging distinctive hazardous features, we develop three core risk-aware components. First, we introduce a risk-incorporated scene encoder, which augments conventional encoders with quantitative risk information to achieve risk-aware encoding of hazardous scene contexts. Next, we incorporate endpoint-risk-combined intention queries as prediction priors in the decoder to ensure that the predicted multimodal trajectories cover both various spatial intentions and risk levels. Lastly, an auxiliary risk prediction task is implemented for the ultimate risk-aware prediction. Furthermore, to support model training and performance evaluation, we introduce a safety-critical trajectory prediction dataset and tailored evaluation metrics. We conduct comprehensive evaluations and compare our model with several SOTA models. Results demonstrate the superior performance of our model, with a significant improvement in most metrics. This prediction advancement enables autonomous vehicles to execute correct collision avoidance maneuvers under safety-critical scenarios, eventually enhancing road traffic safety.", "sections": [{"title": "I. INTRODUCTION", "content": "In intricate road traffic scenarios, accurately forecasting the multimodal trajectories of surrounding agents presents a formidable challenge for autonomous vehicles. As a research hotspot in the field of intelligent traffic [1], [2], precise and timely trajectory prediction is paramount for developing the subsequent decision-making system, including planning and control, eventually promoting the universal application of autonomous driving technology. Studies on trajectory prediction have progressed rapidly and proposed various prediction structures, resulting in the best prediction scores being constantly updated across different benchmarks [4], [5], [6], [7]. However, existing endeavors primarily concentrate on normal safe traffic scenarios, neglecting safety-critical scenarios, especially those involving imminent collisions. Meanwhile, we observe significant data heterogeneity between normal and hazardous driving behaviors, which can be reflected in the distribution discrepancies of vehicle dynamics, shown in Fig. 1. Compared with normal scenarios, vehicles' motion under safety-critical scenarios presents a more dispersed distribution, where behaviors involving large acceleration and yaw rate were more frequently observed. This means when confronting sudden traffic hazards, drivers tend to adopt more aggressive driving behaviors to avoid collisions. Recent studies have proposed various model structures to explore the interaction relationship between agents and maps since road lanes play an essential role in restricting vehicle behaviors [8], [9], [10], which have been used to facilitate accurate trajectory prediction. However, under safety-critical scenarios, such restrictions become less strict as collision avoidance becomes drivers' most important goal rather than obeying the traffic rules and arriving at the destination. Due to such nonnegligible heterogeneity in both vehicle dynamics and drivers' intentions, even state-of-the-art models (e.g., MTR, Motion transformer, ranking first place at Waymo Motion Prediction leaderboard [10]) fail to exhibit satisfactory trajectory prediction performance under intricate safety-critical scenarios. Quantitative evaluations, as depicted in Table I, underscore the noticeable performance degradation."}, {"title": "II. RELATED WORK", "content": "As a connecting module between perception and planning, trajectory prediction has long been considered crucial to the ability of autonomous vehicles to understand traffic scenes, thus attracting significant research interest over the past years [18], [19], [20]. To achieve accurate trajectory prediction, researchers have carried out research from different aspects, including the prediction method itself, the training dataset, and the evaluation metrics. Here, a brief review summarizes the existing research from the above three aspects."}, {"title": "A. Models for Trajectory Prediction", "content": "Recently, various trajectory prediction frameworks have been proposed, constantly updating the best performance across different public benchmarks. These models typically adopt a hierarchical encoder-decoder architecture [21], [22], [23], [24], [25]. Given the manifold traffic factors influencing the vehicle's future motion, such as road geometry and surrounding agents' historical behaviors, recent studies elaborated different structures of the encoder to process these diverse factors and aggregated information via specific feature fusion techniques to achieve accurate scene understanding, e.g., the early fusion strategy for input modalities with factorized attention proposed by Wayformer [4] and the query-centric scene encoding paradigm proposed by QCNet [5]. Leveraging high-dimensional representations processed by the encoder, the decoder forecasts multiple future trajectories of the target agent along with their probabilities, i.e., modeling the multimodal motion patterns. For instance, MTR used a set of learnable motion query pairs as spatial intention priors to facilitate multimodal prediction [10]. However, most studies only focused on normal and safe scenarios. Trajectory prediction tasks under safety-critical scenarios remain unaddressed. Given the vital importance of predicted trajectories on subsequent decision-making of autonomous vehicles [26], a specialized trajectory prediction framework tailored to safety-critical scenarios is urgently needed, which can be developed by incorporating risk-aware components to quantify and infer the evolution of traffic risks and make corresponding predictions. Benefiting from such risk-aware trajectory predictions, autonomous vehicles can better identify risks and make reasonable collision-avoidance behaviors to mitigate potential collision risks."}, {"title": "B. Dataset for Trajectory Prediction", "content": "It is widely acknowledged that data quality plays a pivotal role in determining the performance of data-driven algorithms. Numerous trajectory prediction datasets have emerged to facilitate training algorithms [27], [28], [29]. Early datasets were typically small in scale and exhibited limited trajectory accuracy. Representative datasets include NGSIM [30] and HighD [31], which were collected from a specific segment of highways using roadside cameras or stationary drones. Currently, prominent trajectory prediction datasets, including Argoverse [12], [13], WOMD [3], [11], and Nuscene [32], have significantly enhanced the scale of the trajectory data. In addition to trajectory, they also offer detailed map information. However, during data collection, these datasets exclusively provide normal traffic data under safe scenarios, deliberately excluding safety-critical scenarios, such as collision and near-collision cases. This discrepancy from real-world traffic data can result in subpar performance of SOTA trajectory prediction models when tested under safety-critical scenarios. In application, such prediction errors could lead to misjudgments of the risk level of current scenarios by subsequent decision-making algorithms, finally inducing traffic accidents. The Interaction dataset [33] and Waymo interaction dataset paid more attention to the complex interactions between different traffic participants, alleviating the above issues to some extent. Nevertheless, they still lack traffic hazards that require traffic agents to react in a very short amount of time, which can be seen as a kind of 'extremely interactive' behavior. Datasets in traffic anomaly detection, e.g., DoTA [34] and PSAD [35], involve large-scale safety-critical scenarios but generally can only provide first-person videos or raw EDR data. Due to the lack of precise trajectory data, such datasets cannot support the training of trajectory prediction models. Overall, currently, a dataset consisting of large-scale trajectory data under safety-critical scenarios is urgently needed to support the training of risk-aware trajectory prediction models."}, {"title": "C. Metrics for Trajectory Prediction", "content": "The field of trajectory prediction has proposed several metrics to evaluate the deviation between actual and predicted trajectories [36]. Among these, the most prominent are average displacement error (ADE) and final displacement error (FDE), which quantify the average distance and endpoint distance between predicted and actual trajectories in Euclidean space. Given the diversity in drivers' intentions, recent studies have developed multimodal prediction by outputting multiple trajectories (and their probabilities) per prediction. This derives metrics, such as minADE and minFDE, representing the error of the best trajectory among the multiple predicted trajectories, formulated as: \n\n$$\n\begin{aligned}\n\\min \\mathrm{ADE} & =\\min _{t} \\frac{1}{T_{f}} \\sum_{t=1}^{T_{f}}\\left\\|\tau_{i, t}^{p}-\tau_{t}^{\\mathrm{gt}}\right\\|_{2} \\\n\\min \\mathrm{FDE} & =\\min _{t} \\quad \tau_{i, T_{f}}^{p}-\tau_{T_{f}}^{\\mathrm{gt}}\n\\end{aligned}\n$$ \nwhere $\tau_{i, t}^{p}$ and $\tau_{t}^{\text {gt }}$ denote the $i$-th predicted trajectory and the ground-truth trajectory at the timestamp of $t, T_{f}$ is the future prediction frames, and $\\|\\cdot\\|_{2}$ represents the L2 norm. Metrics like mean average precision (mAP) and brier-minFDE additionally consider different prediction confidences to enhance the assessment comprehensiveness. These existing metrics measure prediction errors in terms of trajectory itself. Under safety-critical scenarios characterized by extremely short agent-agent distances, the same trajectory prediction errors could yield diametrically opposed outcomes, such as collisions and non-collisions. This highlights the imperative to account for the impact of predicted trajectories on driving risk and collision probability to achieve a more comprehensive evaluation under safety-critical scenarios."}, {"title": "III. RISK-AWARE TRAJECTORY PREDICTION", "content": "This section presents the detailed formulation of the proposed risk-aware trajectory prediction framework tailored to safety-critical scenarios (Fig. 2)."}, {"title": "A. Problem Statement", "content": "The core goal of trajectory prediction is to accurately predict future positions (generally in 2D coordinates) of the target vehicle $\tau_{i, 0 ; T_{f}}^{p}$, given its historical trajectory and observed surroundings $S=\\{A, M\\} . S$ includes other agents' historical trajectories $A_{-T_{h} / 0}^{0: N_{a}}$ and map information $M_{0: P}^{0: N_{m}}$, represented by lane segments, where $T_{f}$ represents the future prediction frames, $T_{h}$ is historical frames, $i$ denotes the $i$-th mode of multimodal trajectory prediction, $N_{a}$ is the number of other observed agents, $N_{m}$ denotes the number of surrounding lane segments, and $P$ is the number of points to represent a lane segment's centerline. For trajectory prediction under safety-critical scenarios, we emphasize the importance of quantifying risk to achieve risk-aware prediction. Thus, the surroundings $S$ are expanded as $S=\\{A, M, R\\}$, where the collision risk information between the target vehicle and other agents $R_{-T_{h} / 0}^{0: N_{a}}$ is estimated based on an artificial potential field method, detailed in Section IV."}, {"title": "B. Basic Architecture", "content": "The design of our model was inspired by a previous SOTA trajectory prediction model, i.e., MTR [10], [37], which adopted a classical encoder-decoder architecture. Different from the original MTR, we incorporated a series of innovative risk-aware components to cater to the safety-critical trajectory prediction task. Before detailing them, here we first briefly introduced the basic architecture of our model, which was similar to the original MTR. Scene Encoder. The scene encoder first utilized polyline encoders, developed based on PointNet [38], to encode the raw inputs of agents $A_{0: T_{h}}^{0: N_{a}}$ and maps $M_{0: P}^{0: N_{m}}$ into high-dimension representations, which were then concatenated together. Next, a standard Transformer encoder was applied to further mine the coupling relationship between different inputs to achieve a more comprehensive encoding of scene context. To capture the potential future interactions between different agents, a multilayer perceptron (MLP)-based dense future prediction module was used to densely predict the trajectories of all agents, which was taken as an auxiliary supervised learning task with the loss denoted as $\\mathcal{L}_{\text {dense }}$. Trajectory Decoder. Taking the encoded agent and map features as key and value, a Transformer decoder consisting of $N_{d}$ cross-attention layers were applied to propagate information among different features. To generate multimodal predictions, the original decoder in MTR used 64 motion pairs, i.e., trajectory endpoints clustered by a k-means clustering algorithm, as the spatial intention queries. At last, MLP-based prediction heads predicted the future motions, including trajectory (each trajectory point is represented as a distribution modeled by a Gaussian mixture model), velocity, and their probabilities, which were used to calculate the final trajectory loss $\\mathcal{L}_{\text {traj }}$, defined as: \n\n$$\n\begin{gathered}\n\\mathcal{L}_{\text {traj }}=\\mathcal{L}_{\text {reg }}+\\mathcal{L}_{\text {cls }}=\\operatorname{GR}\\left(\tau_{j}^{p}, \tau^{\text {gt }}\right)+\\operatorname{CE}\\left(p_{1: N}^{p}, j\right) \\\nj=\\arg \\min \\operatorname{FDE}\\left(\\kappa_{i}, \tau^{\text {gt }}\right)\n\\end{gathered}\n$$ \nwhere $\\operatorname{GR}(\\cdot, \\cdot)$ denotes the Gaussian regression loss, $\\operatorname{CE}(\\cdot, \\cdot)$ is the cross-entropy loss, $\tau_{j}^{p}$ and $\tau^{\text {gt }}$ denote the $j$-th predicted trajectory and the ground-truth trajectory, respectively, $p_{1: N}^{p}$ is the predicted probability of all $N$ trajectory predictions, $\\kappa_{i}$ is the $i$-th endpoint intention, and $j$ represents the sequence number of the endpoint intention with minimal errors from the ground-truth endpoint."}, {"title": "C. Core Risk-Aware Components", "content": "Though MTR performed well on several public trajectory prediction datasets, its prediction performance under safety-critical scenarios still needs to be further enhanced. Therefore, we incorporated various architecture modification and training techniques into the original MTR to help it better interpret safety-critical scenarios, identify the potential risk level, and predict risk-aware multimodal trajectories. Technically, the core components of the proposed risk-aware model include: a risk-incorporated scene encoder, endpoint-risk-combined intention queries, and auxiliary risk prediction. Risk-incorporated Scene Encoder (RSE). As described above, we introduced the quantitative traffic risk information $R_{0: T_{h}}^{0: N_{a}}$ as an independent input in addition to the conventional agent and map information. After being encoded by three polyline encoders PolyEnc( $\\cdot$ ), agent features $F_{A}$, map features $F_{M}$, and risk features $F_{R}$ were concatenated and passed together to a standard Transformer encoder with $N_{\text {enc }}$ stacked multi-head self-attention layers, where the risk features could further interact with the agent and map information to help the model enhance the understanding of safety-critical scene context (Fig. 2c). The whole process can be represented as: \n\n$$\n\begin{gathered}\nF_{A / M / R}=\text { PolyEnc } A_{0: T_{h}}^{0: N_{a}} / M_{0: P}^{0: N_{m}} / R_{0: T_{h}}^{0: N_{a}} \\\nE_{i+1}=\\operatorname{SelfAttn}\\left(q=E_{i}+\\operatorname{PE}\\left(E_{i}\right), k=E_{i}+\\operatorname{PE}\\left(E_{i}\right), v\right. \\\n\\left.=E_{i}\right), \\quad i=0,1, \\ldots, N_{\text {enc }}-1 \\\nE_{A}, E_{M}, E_{R}=\\operatorname{Div}\\left(E_{N_{\text {enc }}}\right)\n\\end{gathered}\n$$ \nwhere $E_{0}=\\left[F_{A}, F_{M}, F_{R}\right] \\in \\mathbb{R}^{\\left(N_{a}+N_{m}+N_{o}\right) \times D_{f}}$ represents the concatenated input features that aggregate all the scene context features, $D_{f}$ is the feature dimension, $[\\cdot ; \\cdot]$ is the concatenation operation, $q, k$, and $v$ denote the query, key, and value in the self-attention module, and $\\mathrm{PE}(\\cdot)$ denotes the sinusoidal position encoding of input tokens. The final outputs of the encoder $E_{N_{e n c}}$ was divided $(\\operatorname{Div}(\\cdot))$ into the agent, map, and risk features $E_{A} \\in \\mathbb{R}^{N_{a} \times D_{f}}, E_{M} \\in \\mathbb{R}^{N_{m} \times D_{f}}$, and $E_{R} \\in$ $\\mathbb{R}^{N_{a} \times D_{f}}$, which would be taken as the independent key and value for the subsequent independent cross-attention modules in the trajectory decoder to provide scene context information. Trajectory decoder with Endpoint-Risk-combined intention Queries (ERQ). Our proposed trajectory decoder contains $N_{d e c}$ decoder layers, one of which is depicted in Fig. 3. Each layer adopts two parallel Transformer decoder layers (gray box) to independently process trajectory-related features (blue box) and risk-related features (red box), which are then integrated to make final predictions. Inspired by taking the clustered trajectory endpoints as spatial intention priors in MTR, we innovatively proposed to incorporate risk intentions to represent the potential risk level of the future scenario as priors. We expected this modification could instruct our model to make more risk-aware trajectory predictions. Technically, we first utilized MLPs to encode both endpoint intention queries $I^{t}$ (i.e., $N_{\text {end }}$ two-dimensional coordinates) and risk intention queries $I^{r}$ (i.e., $N_{\text {risk }}$ scalars) into high-dimension representations $T^{t / r}$ : \n\n$$\nT^{t / r}=\\operatorname{MLP} \\operatorname{PE}\\left(I^{t / r}\right)\n$$ \nThen, two multi-head self-attention modules were used to process trajectory-related and risk-related features separately, where $T^{t}$ and $T^{r}$ were taken as the position embedding for queries and keys, developed as: \n\n$$\n\begin{aligned}\nS_{i}^{t / r}=\\operatorname{SelfAttn}\\left(q\right. & \\left.=Q_{i}^{t / r}+T^{t / r}, k=Q_{i}^{t / r}+T^{t / r}, v\right. \\\n& \\left.=Q_{i}^{t / r}\right), \\quad i=1,2, \\ldots, N_{d e c}-1\n\\end{aligned}\n$$ \nwhere $Q_{i}^{t / r} \\in \\mathbb{R}^{N_{\text {end }} / N_{r t s k} \times D_{f}}$ denotes the trajectory-related and risk-related query content features at the $i$-th layer of the decoder, respectively. The query content features at the zeroth layer $Q_{0}^{t / r}$ are initialized as zeros. For trajectory-related modules, the encoded information from self-attention $S_{i}^{t}$ and endpoint intentions $T^{t}$ were taken as the query in two cross-attention modules to interact with the agent features $E_{A}$ and map features $E_{M}$ from the encoder, respectively, formulated as: \n\n$$\n\begin{gathered}\nC_{i}^{A / M}=\\operatorname{CrossAttn}\\left(q=\\left[S_{i}^{t}, T^{t}\right], k\right. \\\n=\\left[E_{A / M}, \\operatorname{PE}\\left(E_{A / M}\right)\right], v=E_{A / M} \\\nC_{i}^{t}=\\operatorname{MLP}\\left(\\left[C_{i}^{A}, C_{i}^{M}\right]\right)\n\\end{gathered}\n$$ \nwhere the outputs of cross-attention $C_{i}^{A}$ and $C_{i}^{M}$ were then aggregated into $C_{i}^{t}$ by an MLP. On the other hand, the risk-related modules also adopted a cross-attention module to query the encoded risk features $E_{R}$ : \n\n$$\n\begin{gathered}\nC_{i}^{r}=\\operatorname{CrossAttn}\\left(q=\\left[S_{i}^{r}, T^{r}\right], k=\\left[E_{R}, \\operatorname{PE}\\left(E_{R}\right)\right], v\right. \\\n\\left.=E_{R}\right)\n\\end{gathered}\n$$ \nNote that the mode number of trajectory-related features $C_{i}^{t} \\in \\mathbb{R}^{N_{\text {end }} \times D_{f}}$ and risk-related features $C_{i}^{r} \\in \\mathbb{R}^{N_{r t s k} \times D_{f}}$ is different. To integrate them for the final predictions, we first extended their modes by copying trajectory-related features $N_{r t s k}$ times to get $C_{i}^{t, r} \\in \\mathbb{R}^{\\left(N_{\text {end }} \times N_{r t s k}\right) \times D_{f}}$ and copying risk-related features $N_{\text {end }}$ times to get $C_{i}^{r, r} \\in \\mathbb{R}^{\\left(N_{\text {risk }} \times N_{\text {end }}\right) \times D_{f}}$. Then, we utilized an MLP to aggregate them into an integrated feature, denoted as $Q_{i} \\in \\mathbb{R}^{\\left(N_{\text {end }} \times N_{r t s k}\right) \times D_{f}}$. The above process can be described as: \n\n$$\n\begin{gathered}\nC_{i}^{t, r}=\\operatorname{Ext}\\left(C_{i}^{t}, N_{r t s k}\right), \\quad C_{i}^{r, r}=\\operatorname{Ext}\\left(C_{i}^{r}, N_{e n d}\right) \\\nQ_{i}=\\operatorname{MLP}\\left(\\left[C_{i}^{t, r}, C_{i}^{r, r}\right]\right) \\\n\tau^{p, i}=\\operatorname{MLP}\\left(Q_{i}\right), \\quad \\gamma^{p, i}=\\operatorname{MLP}\\left(Q_{i}\right)\n\\end{gathered}\n$$ \nwhere $\\operatorname{Ext}(\\cdot ; \\cdot)$ denotes the extension by copying and $\tau^{p, i}, \\gamma^{p, i}$ represent the predicted trajectories and risks at the $i$-th layer, both with the prediction modality of $N_{\text {end }} \times N_{\text {risk }}$. By incorporating endpoint-risk-combined intention queries, we established a two-dimensional prediction matrix, effectively ensuring that the multimodal trajectories predicted by our model not only covered various spatial intention priors (represented by trajectory endpoints) but also took into consideration different risk levels of the future traffic scene. For the next $(i+1)$-th decoder layer, the trajectory-related and risk-related query content features $Q_{i+1}^{t / r}$ were obtained by averaging the corresponding dimensions of the integrated feature $Q_{i}$ to narrow down the number of predicted modes and restore them to their original dimensions, formulated as: \n\n$$\n\begin{gathered}\nQ_{i+1}^{t}=\\operatorname{Avg}\\left(Q_{i}, d=N_{\text {end }}\right) \\\nQ_{i+1}^{r}=\\operatorname{Avg}\\left(Q_{i}, d=N_{\text {risk }}\right)\n\\end{gathered}\n$$ \nwhere $Q_{i+1}^{t / r} \\in \\mathbb{R}^{N_{\text {end }} / N_{\text {risk }} \times D_{f}}$, and $\\operatorname{Avg}(\\cdot, d)$ denotes the average operation with the dimensions $d$ to retain. To iteratively update the predictions, the above process was repeated $N_{\text {dec }}$ times in the trajectory decoder. Via such iterative optimization, trajectory-related features and risk-related features were effectively integrated, not only facilitating the information interaction between endpoint intentions and risk intentions but also promoting the information propagation within each type of intention. Auxiliary Prediction of Risk (APR). In addition to the conventional trajectory prediction task, we advocated simultaneously predicting the future evolution of traffic risks as an auxiliary supervised learning task to help the model identify the current risk levels. Compared with conventional models, the proposed risk-incorporated scene encoder and risk intention queries endowed our risk-aware model with the ability to accurately predict future risks. Upon obtaining the integrated feature $Q_{i}$ with $N_{\text {risk }} \times N_{\text {end }}$ modes, an independent MLP was adopted to predict the future risk sequence of the target vehicle $\\gamma^{p}$, which is formulated in (8). To promote multimodal predictions during optimization, the auxiliary risk prediction loss $\\mathcal{L}_{\text {risk }}$ was calculated in a similar way as the trajectory prediction loss $\\mathcal{L}_{\text {traj }}$, i.e., a hard-assignment strategy that calculates losses based on the risk intention query with minimal errors, formulated as: \n\n$$\n\begin{aligned}\n\\mathcal{L}_{\text {risk }}= & \\gamma_{j}^{p}-\\max \\left(\\gamma^{g t}\right) \\underset{1}{1}+\\operatorname{CE}\\left(p_{1: N}^{p}, j\right) \\\n& j=\\underset{j}{\\arg \\min }\\left\\|\nu_{i}-\\max \\left(\\gamma^{g t}\right)\right\\|_{1}\n\\end{aligned}\n$$ \nwhere $\\|\\cdot\\|_{1}$ denotes the L1 norm, $\\gamma_{j}^{p}$ and $\\gamma^{g t}$ are the $j$-th predicted risk sequence (in three dimensions, i.e., probability, cost, and risk) of the target agent and its ground-truth risk (calculated by the risk quantification method in Section IV), $p_{1: N}^{p}$ is the predicted probability of $N$ risk predictions, $\nu_{i}$ represents the $i$-th risk intention, and $j$ represents the sequence number of the risk intention with minimal errors from the maximum value of the ground-truth risk sequence. Note that, for brevity, we simplified the formulation of $\\mathcal{L}_{\text {traj }}$ and $\\mathcal{L}_{\text {risk }}$ in (2) and (10). In fact, for loss calculation, the selection of predicted trajectories and risks from multimodal predictions is coupled. Technically, we first selected the optimal endpoint intention with the index of $i$ and the optimal risk intention with the index of $j$, independently. Then, the ( $i$, $j$ )-th prediction (including both trajectory and risk) in the coupled prediction matrix ( $N_{\text {risk }}, N_{\text {end }}$ ) was selected as the optimal prediction to calculate losses in (2) and (10). To sum up, the overall training loss $\\mathcal{L}$ consists of three terms (Fig. 2e): trajectory prediction loss $\\mathcal{L}_{\text {traj }}$, dense motion prediction loss $\\mathcal{L}_{\text {dense }}$, and risk prediction loss $\\mathcal{L}_{\text {risk }}$."}, {"title": "IV. DRIVER-CENTERED RISK QUANTIFICATION", "content": "Numerous indicators have been proposed to quantify traffic risks, the most classic of which is time-to-collision (TTC) and time headway (THW). Since our ultimate goal is to predict vehicle trajectories determined by the driver's decision-making behaviors, an indicator that can assess the level of traffic risk from the driver's perspective is needed to assist in trajectory prediction. Thus, inspired by a previous study [39], we developed an artificial potential field-based traffic risk indicator. Technically, traffic risk perceived by drivers can be represented as the product of two parts: the probability of a collision and its cost (Fig. 2b) [40]."}, {"title": "A. Collision Probability", "content": "The driver's subjective belief about the probability of a crash accident occurring was quantified via a method named driver's risk field (DRF) [39]. The DRF is represented as a two-dimensional matrix, where the target agent is located in the middle, and the value of each other cell stands for its collision probability with the target if an obstacle exists (Fig. 4). To model it, we assume that the target vehicle maintains a constant velocity and angular velocity in the coming few seconds. Thus, based on the target vehicle's current states, e.g., positions, velocities, and steering angle, we can utilize a planar 3-DoF bicycle model to estimate its future motion, which is represented as an arcing curve. Then, the position coordinates of each point in the DRF are projected onto this arcing curve. The new coordinate contains two parameters, i.e., longitudinal position $s$ and lateral position $t$. Following the principle that the closer the obstacle is, the greater the risk, the DRF was modeled as a torus with a Gaussian cross-section with varying height $(a)$ and width $(\\sigma)$, which can be formulated as: \n\n$$\n\begin{gathered}\n\\operatorname{DRF}=a(s) \\cdot \\exp \\left(\\frac{-t^{2}}{2 \\sigma^{2}(s)}\right) \\\na(s)=\begin{array}{c}\nA \\cdot \\frac{\\left(s_{\\max }-\\max \\left(s, s_{\\min }\right)\right)^{2}}{\\left(s_{\\max }-s_{\\min }\right)^{2}}, \\quad s<s_{\\max } \\\n0, \\quad s \\geq s_{\\max }\n\\end{array} \\\n\\sigma^{2}(s)=\\left(B \\cdot \\max \\left(s, s_{\\min }\right)+C\right)^{2}\n\\end{gathered}\n$$ \nwhere $s_{\\max }$ is the maximum longitudinal position affected by the risk receptive field of drivers and is assumed velocity dependent, i.e., $s_{\\max }=D \\cdot(\\max (v, 5))^{E}, s_{\\min }$ is the allowed minimal value of $s$, and $A-E$ are constant coefficients."}, {"title": "B. Collision Cost", "content": "The cost of a potential collision refers to the collision severity and occupant injury risks, affected by various factors, including vehicle dynamics, usage of restraint systems, and occupant characteristics. For simplification, we quantified the cost based on the impact energy at the vehicle level, which mainly contains three parts: a constant basic cost $E_{b}$ for collisions with any obstacle, an absolute cost equal to the obstacle's kinetic energy $E_{a}$ depending on its mass and absolute velocity, and a relative cost $E_{r}$ depending on the obstacle's relative velocity towards the target vehicle. The total collision cost equals the weighted sum of the three."}, {"title": "C. Comprehensive Risk", "content": "After multiplying the above two parts, a comprehensive driver-centered risk indicator was obtained. Note that the risks posed to the target vehicle by different agents were calculated independently. For the target vehicle, the overall risk equals to the sum of all agents' risks, i.e., $R^{0}=\\frac{N_{a}}{i=1} R^{i}$. After concatenation, the final risk information $R^{0: N_{a}}$ with three dimensions, i.e., probability, cost, and comprehensive risk, was obtained. By integrating the agent and map information in traffic scenarios from the driver's perspective, the risk information $R$ is regarded as a vital auxiliary input for the trajectory prediction model to enhance its ability of scene understanding and risk perception, eventually assisting the model in making risk-aware trajectory predictions."}, {"title": "V. DATASET AND METRICS TAILored TO SAFETY-CRITICAL Scenarios", "content": "In addition to the risk-aware trajectory prediction model, training data and evaluation metrics tailored to safety-critical scenarios are also critical to improving prediction performance, which are detailed in this section."}, {"title": "A. Dataset", "content": "For the establishment of the safety-critical trajectory prediction dataset, given the danger and low frequency of safety-critical scenarios in real-world traffic, we conducted a large-scale driving simulation experiment to ensure the safety and efficiency of data acquisition (Fig. 5). In terms of hardware, we utilized a high-fidelity driving simulator with a fully instrumented vehicle cab mounted on a 6-DOF motion system with three monitors to provide immersive traffic stimulation. Regarding software, various safety-critical events were designed based on the open-source simulation platform CARLA [41]. According to NHTSA [42], our experiment concentrated on three of the most frequent vehicle-to-vehicle conflict types, i.e., rear-end, cut-in, and merging scenarios (Fig. 6). We developed a hazard-triggering algorithm to achieve the random automatic generation of safety-critical events. Technically, this algorithm first assessed the collision risk between the ego vehicle controlled by the volunteer and surrounding background vehicles (controlled by our algorithm). The most aggressive background vehicle with the highest risk was selected as the hazard-triggering vehicle to execute aggressive behaviors and create traffic conflicts. Volunteers' various collision-avoidance behaviors subject to the random traffic hazards were automatically collected to form the final safety-critical trajectory prediction dataset after a series of necessary post-processing procedures. Each hazard-triggering instance was followed by a minimum 30 -second interval, allowing drivers to revert to natural driving states. Twelve volunteers, aged between 22 and 43 years, with an average annual driving distance of more than $8,000 \\mathrm{~km}$, participated in the experiment, except one volunteer withdrew due to motion sickness. Volunteers underwent four 30-minute driving sessions, with 10 -minute rest between sessions. Participants were free to select their routes and were responsible for executing evasive maneuvers when necessary. The Institutional Review Board (IRB) of Tsinghua University has approved the whole experimental procedure. Via the experiment, we established a dataset consisting of 1620 K frames of continuous driving data ( 22.5 hours with 20 Hz ) with detailed trajectory and map information. Among this data, 2088 safety-critical events were extracted, each covering five seconds before and after the hazard occurrence, which is defined as the moment when the hazard-triggering vehicle shows an obvious abnormal behavior, such as emergency braking at a deceleration exceeding a certain threshold and a reckless lane change with the lane offset exceeding a certain threshold. To increase the diversity of prediction cases, threshold values under different safety-critical scenarios vary, following Gaussian distribution. After removing anomalies, over 350 K frames of 1879 safety-critical events are available for training and validating the proposed prediction framework. Table II summarizes the distributions of collected events' conflict type, collision time, and driver's emergency maneuvers when confronting safety-critical events. For more details about the dataset, please refer to another paper our team is currently preparing."}, {"title": "B. Metrics", "content": "Most existing trajectory prediction metrics measure errors in terms of the trajectory itself, i.e., distance errors between predicted and actual trajectories. Under safety-critical scenarios, the predicted trajectories of surrounding agents will directly determine the ego autonomous vehicle's subsequent decision-making, eventually affecting the collision risk and the potential occupant injury severity. Thus, we advocate further considering the effects of trajectory prediction on evaluating the collision probability and severity. Technically, for collision samples in the safety-critical dataset, prediction errors of relative collision velocity between the two vehicles were calculated to represent the estimation accuracy of collision severity. Prediction errors of the collision time were also calculated. Additionally, for safety-critical trajectory prediction, we emphasize that it is hazardous to predict a collision as a non-collision accident, which might cause autonomous vehicles to misjudge the collision risk and fail to make timely and reasonable avoidance behaviors. Thus, for collision samples, we calculated the collision miss rate $\\left(\\mathrm{MR}_{\text {coll }}^{k}\right)$. We defined that a collision miss occurs when all the multimodal predicted trajectories do not coincide with the surrounding vehicles' trajectories. Regarding non-collision samples, we evaluated the risk prediction errors based on the driving risk indicator proposed in Section IV to represent collision probability. Similar to trajectory-related metrics, we also adopted mean square error and miss rate to calculate errors in predicting collision velocity (i.e., $\\mathrm{MSE}_{\text {velo }}^{k}$ and $\\mathrm{MR}_{\text {velo }}^{k}$ ), collision time (i.e., $\\mathrm{MSE}_{\text {time }}^{k}$ and $\\mathrm{MR}_{\text {time }}^{k}$ ), and traffic risk (i.e., $\\mathrm{MSE}_{\text {risk }}^{k}$ and $\\mathrm{MR}_{\text {risk }}^{k}$ ), where $k=6$ denotes the multimodal prediction with six trajectories, and $k=1$ denotes the unimodal prediction by selecting the predicted trajectory with the maximum predicted probability. $\\mathrm{MR}_{\text {velo }}^{k}, \\mathrm{MR}_{\text {time }}^{k}$, and $\\mathrm{MR}_{\text {risk }}^{k}$ were defined as the ratio of the validation scenarios where the prediction error of collision velocity, collision time, and traffic risk exceeds a threshold of $2.5 \\mathrm{~m} / \\mathrm{s}, 0.25 \\mathrm{~s}$, and 0.15 (after normalization), respectively. In addition, for existing trajectory-related metrics (e.g., minADE and min FDE), we split the samples in the validation dataset into four groups depending on the time of the collision (non-collision, collision-in-1s, collision-in-3s, and collision-in-5s) and calculated the evaluation results independently since the prediction time horizon significantly influences these metrics' magnitude."}, {"title": "VI. EXPERIMENTS", "content": "This section presented and discussed the experimental setup and evaluation results. We first introduced the validation experiments and implementation details. Second, the results of our proposed risk-aware trajectory prediction model are compared with those of several baseline methods. Finally, necessary ablation studies were conducted to demonstrate how each module in our model contributes to the final result."}, {"title": "A. Experimental Setup", "content": "Implementation Details. The hidden feature dimensions of encoder $D_{\text {enc }}$ and decoder $D_{\text {dec }}$ are set as 256 and 512 , respectively. All the self-attention and cross-attention modules adopt a standard setting, i.e., six attention layers, each with eight heads. Dropout rate in attention layers is 0.1 . Due to the sparsity of lane segments in CARLA, we deleted the dynamic map collection module in the original MTR. Regarding endpoint intentions, sixteen motion queries $\\left(N_{\text {end }} \\approx 16\right)$ were generated by clustering the endpoints on the training set of our proposed safety-critical dataset based on a k-means clustering algorithm. For risk intentions, we manually set a series of values to represent different urgency levels of traffic scenes, given the actual risk distribution. Specifically, we adopt two schemes: a model with three risk queries ( $N_{\text {risk }}$ $=3$ ), i.e., 300,600 , and 999 (maximum risk value representing collision conditions), and another model with four risk queries $\\left(N_{\text {risk }}=4\right)$, i.e., $300,500,650$, and 999 . Training Details. The proposed model was trained for 200 epochs using an AdamW optimizer with a weight decay of 0.01 . The initial learning rate was set as $1 \times 10^{-4}$ and decayed by a factor of 0.5 at the epoch of $100,125,150$, and 175 . The model was trained with a batch size of 64 on eight NVIDIA GeForce RTX 3090 GPUs."}, {"title": "B. Quantitative Results", "content": "Comparison with Baselines. We compared the proposed risk-aware trajectory prediction model's performance with several baseline models", "follows": "Physical-based Models: constant velocity model (CV) and constant acceleration model (CA). They predict future trajectories based on the target vehicle's current kinematic state by assuming the agent moves at a constant velocity or acceleration. Classic Machine Learning Models: long short-term memory (LSTM) and gated recurrent unit (GRU). SOTA Trajectory Prediction Models: Motion transformer (MTR) and its end-to-end variant, MTR-e2e [10", "37": "Wayformer [4", "5": "trajectory prediction network with Evolving and Distinct Anchors (EDA) [43", "7": ".", "26": [44]}]}