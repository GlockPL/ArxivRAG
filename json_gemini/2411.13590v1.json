{"title": "Deep learning waterways for rural infrastructure development", "authors": ["Matthew Pierson", "Zia Mehrabi"], "abstract": "Surprisingly a number of Earth's waterways remain unmapped, with a significant number in low and middle income countries. Here we build a computer vision model (WaterNet) to learn the location of waterways in the United States, based on high resolution satellite imagery and digital elevation models, and then deploy this in novel environments in the African continent. Our outputs provide detail of waterways structures hereto unmapped. When assessed against community needs requests for rural bridge building related to access to schools, health care facilities and agricultural markets, we find these newly generated waterways capture on average 93% (country range: 88-96%) of these requests whereas Open Street Map, and the state of the art data from TDX-Hydro, capture only 36% (5-72%) and 62% (37% - 85%), respectively. Because these new machine learning enabled maps are built on public and operational data acquisition this approach offers promise for capturing humanitarian needs and planning for social development in places where cartographic efforts have so far failed to deliver. The improved performance in identifying community needs missed by existing data suggests significant value for rural infrastructure development and better targeting of development interventions.", "sections": [{"title": "Main Text", "content": "Water is fundamental to human existence, and how water flows across landscapes has important implications for human mobility [1, 2]. It is a surprising fact that not all waterways on the Earth are mapped. Part of this is due to a focus on perennial rivers and streams [3], and part is due to a legacy effect of modern cartographic effort, resources, and capacity by countries to undertake mapping programs or digitize existing maps that exist. We see more comprehensive documentation in Northern American and Europe, for example, with much less understood water systems in other regions, particularly in Africa [4]. While data intensive advances in mapping aspects like surface water have been made in recent years that allow for expanding the extent of maps of waterways, they are limited in resolution and capture only major waterways and water bodies [5]; see also [6, 7]. A number major scientific efforts to map waterways have been undertaken and continue, including estimates of seasonal reaches [3], but known gaps exist in coverage and completeness [7-9]. Gaps in knowledge of the world's waterways in data scarce areas pose issues to advancing science for those geographies, as well as downstream tasks such as understanding impacts of climate change, infrastructure development, transport, as well as water security.\nTo date, waterways mapping has basically fallen into two camps those that depend predominantly on digital elevation models (DEM) [10], [8]; and those that rely primarily on visual information from satellite imagery [6, 11]. Here, we have merged these two basic ideas in a deep learning model that is scalable across large geographic areas, using publicly available satellite missions such as 10m Sentinel-2 imagery, and the 30 meter Copernicus DEM as features and trained on labels from waterways data from the United States [12]. The model, WaterNet, is a computer vision based convolutional neural network built on an architecture of similar style to U-Net [13], originally developed by engineers for segmentation in biomedical research. We show that we are able to use this model, alongside additional post-processing steps to vectorize the output, to reproduce best in class datasets of waterways not used in training [10]. We deploy this model to map high resolution waterways wall-to-wall in a number of African countries, and are able to show that compared to existing datasets, it better addresses on the ground infrastructure needs.\nWe compare the outputs of this model to existing datasets. We note that the existing understanding of coverage of waterways by world region depends strongly on the data source. OpenStreetMap (OSM), a dataset which is widely used, but highly dependent on community effort, demonstrates this well, with the percentage of Water-Net's inner segment points (ie all points in the polyline excluding the tip and tail, or the midpoint if there is only a tip and tail) within 0.002 degrees of an OSM waterway ranging from 43% (Standard Deviation = 12%) for countries in Europe, and 37% (20%) for basins in the United States, compared to just 18% (12%) for countries in Africa. Contrast this with nations with specific mapping initiatives, such as the United States' National Hydrography Dataset (NHD) [12], where the gap is small at 83% (7%). Notably, these geospatial differences in coverage between geographies are substantially reduced through comparisons with TDX-Hydro (TDX), a globally consistent data set from a derived from the 12m TanDEM-X DEM by United States National Geospatial-Intelligence Agency (Figure 1)."}, {"title": "Discussion", "content": "We show how WaterNet, a deep learning model trained in the United States can be effectively deployed in the African continent, and can reproduce the outputs of the best available data through learnt satellite and elevation features with minimal processing. We also show how this algorithm can draw waterways of importance to local communities, streams and rivers which to date have remained unmapped in existing publicly available data. These two factors, alongside the potential for use of these data for assisting in individual infrastructure deployments at high spatial resolution, on individual waterways stretches, offer an exciting advance to complement existing applications of use of artificial intelligence for sustainable development.\nWhile we have presented our new model results as completely independent from existing best in class data such as TDX for comparative purposes, new work may integrate these data sets, to leverage additional benefits of the higher resolution DEM used in the backbone of TDX. A key benefit of our fusion of satellite imagery with a digital elevation model however, permits an operational deploy to map waterways, at high resolution in time series, filling an important mapping need for dynamic assessment of ephemeral waterways structures [3]; and also could help better evaluate how communities are impacted by disasters in near real time.\nIn additional experiments we have found that tuning our model to explicitly label specific water bodies (such as swamps) in training data can allow for picking up of large scale events and humanitarian disasters related to flooding in near real time (Extended Data Figure 3). This coupled with new advances in deep learning forecasted weather [14] or flooding events [15], provides promise for more adaptation focused infrastructure planning that maintains physical connectivity for rural communities in face of climate change and other environmentally driven disruptions to connectivity.\nImportantly, waterways mapping efforts focused on physical hydrology alone, can intentionally disregard reaches (rivers, streams etc) because the hydrological flow models themselves so far developed are not designed to represent the full network at high resolution [16]. Integrating a social perspective on community need for mapping those reaches, might enable a better understanding of resilience, such as how extreme weather events and flooding, may cause communities to be cut off some essential resources. We show incorporating community consultation can capture those community needs more comprehensively, and as a result could potentially provide a firm foundation to develop programs that reduce inequity and exclusion of those communities from development planning around which interventions are layered.\nRecently, there has been a rise in the use of artificial intelligence for sustainable development, enabled through advancements in earth observation with high repeat frequency and high resolution sensors [17]. Notable successful examples have been in identifying poverty and causally evaluating the impacts of infrastructure, or public safety net programs on income proxies [18]; [19]. However, there is a recognized need for investment and improvement of the application of these technologies by governments and the international monetary organizations, at all stages of needs assessment, implementation, and evaluation, due to their geographic reach and cost efficiency [20].\nUsing computer vision to learn waterways from elevation and satellite input features conjointly also offers a new opportunity for cost effective generation of waterways"}, {"title": "Methods", "content": "3.1 Satellite data\nSentinel-2 (NRGB bands) [21] and Copernicus DEM GLO-30 [22] data were acquired from the Microsoft Planetary Computer API [23]. Cloud-free composites were assembled by iteratively downloading Sentinel-2 tiles for the year 2023 and choosing dates with minimal cloud cover, as determined by Sentinel-2's scene classification. In cases where more than 1% of the tiles pixels had clouds, cloud shadows, or missing data, additional tiles were downloaded, prioritizing those that minimized the coverage of cloud classified pixels in the final composite. The cloud free pixels of the individual images where normalized by channel, and transformed using\n$f(x) = round \\left(\\frac{255}{1 + e^{-0.6x}}\\right)$\nFinally, to further remove clouds unidentified by the scene classification in the transformed images, a buffer of 500m around clouds, missing data or cloud shadows were also removed, prior to mean compositing, and the images were stored as 8-bit unsigned integers. These data were used to create input features included 10 channels: the first four being transformed Sentinel-2 NRGB channels (NRGBt), and the remaining 7 being NDVI, NDWI, Shifted Elevation (Es), Elevation x-delta (\u0394\u0395), Elevation y-delta (AE), elevation gradient (VE).\n3.2 Waterways labels\nThe National Hydrography High Resolution Dataset (NHD) [12] was utilized as training data. NHD is mapped at a scale of 1:24,000 scale or better in the contiguous United States (CONUS) and represents the most up-to-date and geographically inclusive hydrography dataset available for the United States, covering all basins, a wide range of terrain types and landscapes, hydrographic contexts, and biomes (Tropical Rain-forest, Tropical Deciduous Forest, Temperate Deciduous Forest, Temperate Coniferous Forest, Boreal Forest, Tundra, Temperate Grassland, Desert) - making it an interesting candidate for training a model for out-of-sample prediction in other geographies in the world outside the United States. NHDPlus encodes a wide range of features such as naturally occurring and man-made surface water (lakes, ponds, and reservoirs), water flow paths (canals, ditches, streams, and rivers), and point features (springs, wells, stream gauges, and dams). The surface water and water flow"}, {"title": "Model Architecture", "content": "We build a novel deep learning model architecture following a U-Net style approach [24], a computer vision algorithm original developed in the biomedical segmentation tasks. It consisted of encoder and decoder layers, with the rows and columns halved and the channels doubled for five iterations (encoder layers), followed by the reverse for three iterations (decoder layers). The initial layer included a global attention type layer, instance normalization, and a convolutional block to increase the number of channels. Encoding layers comprised 2x2 convolutions without padding, instance normalization layers, residual convolutional layers, a multiplication layer, and a fully connected layer. Decoding layers included transposed convolutions, instance normalization layers, residual blocks, multiplication blocks, a fully connected layer, and a convolutional layers. This version of WaterNet creates raster outputs at 40m resolution."}, {"title": "Model Training", "content": "The model was trained on waterways labels using two grid sizes. First the model was trained on 1.5M (1,543,120) 224x224 size grids with 2.4K validation grids. In this case, the iterations consisted of 2K training grids with 2 randomly chosen augmentations for each grid, resulting in 6k training grids. The augmentations consisted of reflecting and rotating the original images, and dropping out 20% of the input cells. We used a batch size scheduler with an initial batch size of 100, which increased by 100 if the F1-score on the validation data did not increase for 15 iterations. The optimizer was stochastic gradient descent with momentum and L2 regularization. (learning rate=0.125, momentum=0.9, weight decay=0.0001). The model was then trained on 96K (96,691) 832x832 size grids with 200 validation grids and no augmentations. In this case, the iterations consisted of 400 training grids, with an initial batch size of 8, which increased by 8 if the Fl-score on the validation data did not increase for 15 iterations; with the same optimizer and settings. The loss function was Binary Cross-Entropy (BCE), weighted by fcode type (Extended Data Table 2). Weighting allowed us to adjust for the label imbalance and also to down weight/ mask out classes that create different kinds of features in the output. Experiments showed re weighting swamp fcode values, for example, allowed for tuning model versions to potentially pick up humanitarian disasters and flooding events (Extended Data Figure 2)."}, {"title": "Post-Processing", "content": "For evaluation the 40m raster output required vectorization. Within a given watershed or country used for deploy tiles were merged, waterways thinned and vectorized. Each cell in the raster was assigned weights based on elevation. Cells were then iteratively labeled as three states, either S (skeleton), I (interior), or R (removable) (a point"}, {"title": null, "content": "that can be removed without altering the topology) in a process of thinning. A cell is labeled S cell if it is touching a max of one other waterway cell, or if its removal would change the connectedness of the waterway (if its removal would turn a single waterway into two or more waterways which were no longer connected), labeled as I if its removal would introduce a gap in the waterway, and the remainder of cells labeled R. R cells were iteratively checked and removed without altering topology, in order of elevation (highest to lowest) with neighboring interior points reassessed for label status changes at each iteration. The process completes when there are no I or R points remaining. Finally, midpoints of S cells from the thinning process were used as points in a polyline to represent waterways.\nA modified Strahler stream order is then determined for the vectorized output, to better evaluate model performance. Rather than starting at a leaf node, we traverse through the waterways in order by elevation, with the same rule that if two streams of the same order n merge, then the result is a stream or order n + 1, and if streams of order n and m merge then the resulting stream is of order max(n, m), where n and m equal the order of the respective connecting streams. These modifications make it possible to put an order on a non-tree graph. We also set any stream with both endpoints connected to another waterway to have a stream order of max(2, current stream order). We generally use 3 categories, order 1 streams, order 2 streams, and order 3 and above streams. This is simply for comparison purposes for this study (and not intended for use of water flow routing)."}, {"title": "Model deployment", "content": "We deployed this model across all contiguous US HU4 watersheds (including 18 held completely out in model training), 8 countries in western Europe (Spain, France, Belgium, Netherlands, Germany, Switzerland, Austria, Italy), and 8 countries in the African continent (Liberia, C\u00f4te d'Ivoire, Ethiopia, Rwanda, Uganda, Tanzania, Zambia, Kenya). After post-processing, we then used these deploys to evaluate the performance of the model."}, {"title": "Evaluation", "content": "Notably in the USA, our comparisons were direct to the input labels, being derived from the NHD, and represent standard out of sample tests for hold out basins. In Europe and in Africa we relied on two independent existing waterways datasets to evaluate model performance. For this purpose we utilized a widely accessible data set, OpenStreetMap, and the most extensive waterways data set currently available, TDX-Hydro, developed by the National Geospatial-Intelligence Agency using the 12m TanDEM-X DEM. Critically, we also evaluate the comparisons for OSM and TDX in the USA as a way of triangulating among these different source datasets. Points were taken from the model's vectorized output excluding the tip and tail of reaches (to avoid potentially double counting those points). We found the nearest waterway from the test datasets (OSM, TDX, or NHD), and found the distance to that waterway in each case. We consider hits if that distance was less than 0.001/ 0.002 degrees (~100m/200m). We did this for stream order 1, 2, and 3 plus waterways, and all waterways. Together"}, {"title": null, "content": "this allowed us to evaluate how well the model performed in the USA with the hold out set, but also compare the model performance in new geographies against available benchmark datasets."}, {"title": "Community Requests", "content": "We independently assessed the model performance with community requests for bridge sites collected by the non-governmental organization Bridges to Prosperity (B2P) across 6 countries in Africa (Rwanda, Uganda, Ethiopia, Liberia, C\u00f4te d'Ivoire, Zambia). In total these represent 4790 unique requests that communities have made for a bridge to enable those communities to access essential services such as schools, healthcare facilities and markets. The spatial coverage and sampling of of these data differ by country, and range from full-coverage nationwide needs assessments (Rwanda), full coverage assessments within specific regions (Uganda, Ethiopia), full coverage within 5km buffer zones sampled within the country (C\u00f4te d'Ivoire), and opportunistic (Zambia, Liberia, Ethiopia). Differences also exist in the order of stream coverage, although overall 25% fell on first order streams, 35% on second order, and 30% on third order or greater. As our main focus was recall, differences in sampling intensity were less of a concern, although we provide country level breakdowns of performance for clarity.\nWe assessed recall for our new computer vision generated waterways data against the benchmarks of OSM and TDX for all of the aforementioned countries."}]}