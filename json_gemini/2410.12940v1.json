{"title": "UMambaAdj: Advancing GTV Segmentation for Head and Neck Cancer in MRI-Guided RT with UMamba and nnU-Net ResEnc Planner", "authors": ["Jintao Ren", "Kim Hochreuter", "Jesper Folsted Kallehauge", "Stine Sofia Korreman"], "abstract": "Magnetic Resonance Imaging (MRI) plays a crucial role in MRI-guided adaptive radiotherapy for head and neck cancer (HNC) due to its superior soft-tissue contrast. However, accurately segmenting the gross tumor volume (GTV), which includes both the primary tumor (GTVp) and lymph nodes (GTVn), remains challenging. Recently, two deep learning segmentation innovations have shown great promise: UMamba, which effectively captures long-range dependencies, and the nnU-Net Residual Encoder (ResEnc), which enhances feature extraction through multistage residual blocks. In this study, we integrate these strengths into a novel approach, termed 'UMambaAdj'. Our proposed method was evaluated on the HNTS-MRG 2024 challenge test set using pre-RT T2-weighted MRI images, achieving an aggregated Dice Similarity Coefficient (DSCagg) of 0.751 for GTVp and 0.842 for GTVn, with a mean DSCaggof 0.796. This approach demonstrates potential for more precise tumor delineation in MRI-guided adaptive radiotherapy, ultimately improving treatment outcomes for HNC patients. Team: DCPT-Stine's group.", "sections": [{"title": "1 Introduction", "content": "Magnetic Resonance Imaging (MRI) plays a pivotal role in radiotherapy (RT), particularly in MRI-guided adaptive radiotherapy, due to its superior soft-tissue contrast compared to other imaging modalities like computed tomography (CT)."}, {"title": "2 Material and Methods", "content": ""}, {"title": "2.1 Data", "content": "The dataset used in this study was provided by the organizers of the HNTS-MRG 2024 challenge task 1, consisting of 150 HNC patients, primarily with oropharyngeal cancer (OPC). Each patient had T2-weighted MRI sequences of the head and neck region, acquired at University of Texas MD Anderson Cancer Center [30]. The images included pre-RT scans taken 1-3 weeks before the start of radiotherapy. For all cases, GTV for the primary tumor (GTVp) and involved lymph nodes (GTVn) were independently segmented by 3 to 4 expert physician observers based on the MRI images. The ground truth segmentation was then generated using the Simultaneous Truth And Performance Level Estimation (STAPLE) algorithm."}, {"title": "2.2 Network Architecture", "content": "The proposed network architecture is based on a combination of a 3D ResEnc U-Net and Mamba blocks. The CNN part of network architecture was designed according to the new nnU-Net Residual encoder planner (M). The U-Net consists of 6 stages, each with varying features per stage (32, 64, 128, 256, 320, 320). The network uses 3D convolutional layers with kernel sizes mostly set to (3, 3, 3), except for the first stage where it is (1, 3, 3). The strides vary across stages to enable down-sampling at different levels, with a stride set of (1, 2, 2) between the first and second stages, and (2, 2, 2) for the remaining stages. Each stage contains a different number of residual CNN blocks with counts of (1, 3, 4, 6, 6, 6) in the encoder, and a Mamba layer is appended after each residual CNN block except the first stage. A skip connection with concatenation was connecting the Mamba layer and the decoder blocks, while each decoder block consists of only one 3D CNN block. Instance normalization and the Leaky ReLU activation function are used. Additionally, deep supervision is applied at the top four levels of the network outputs. The overall structure of the network can be seen in Figure la."}, {"title": "2.3 Mamba layer", "content": "The Mamba layer, adapted from the UMamba design for capturing long-range dependencies, processes input image feature maps of shape $(B,C,H,W,D)$, where B is the batch size, C the channel, and H, W, D the spatial dimensions. These feature maps are first reshaped and transposed into a flattened representation $(B, L, C)$, where $L = H \\times W \\times D$, treating all spatial locations as individual"}, {"title": "2.4 Training Parameters", "content": "Training was conducted with a batch size of 4, using a patch size of (48, 192, 192) and Z-score normalization for data preprocessing. The median image size in voxels was (123, 512, 511), with spacing set at (1.199, 0.5, 0.5). Resampling spline interpolation functions were employed to adjust both image and segmentation data, using an interpolation order of 3 for images and an order of 1 (linear) for masks. The training was performed using the SGD optimizer with a PolyLR scheduler (exponent = 0.9), starting with a learning rate of 0.01. The adoption of the Mamba layer often led to gradient vanishing or explosion during training, especially when using mixed-precision (fp16) with automatic casting. To address this, normalized gradients were clipped with a value of 1.\nThe 150 patients were randomly divided into 5 folds, with each fold comprising 120 patients for training and 30 for validation. Each model was trained for a maximum of 1,000 epochs, and the final models from the last epoch were saved for prediction. For the final challenge submission, predictions on the test set were generated using an ensemble of all models trained across the five folds. In line with reproducibility and verification guidelines [14], all source code, predicted masks, training logs and trained weights have been made publicly available on GitHubt."}, {"title": "2.5 Evaluation", "content": "The aggregated Dice Similarity Coefficient (DSCagg) [2] was used as the primary evaluation metric in accordance with the guidelines of the HNTS-MRG 2024 challenge. Additionally, we employed the mean 95th percentile Hausdorff Distance (HD95), and the mean surface distance (MSD) as supplementary metrics to further evaluate the segmentation performance for both GTVp and GTVn. Hausdorff Distance (HD) was used for case study.\nTo evaluate the performance of the proposed method, we compared both the segmentation accuracy and training epoch times of the default nnU-Net,"}, {"title": "2.6 System environment", "content": "The experiments were conducted on a system equipped with dual AMD Ryzen Threadripper 3990X 64-core processors (128 threads) and 256GB of system memory. An NVIDIA RTX A6000 GPU with 48GB VRAM was used for training. The software environment included Python 3.12.4, PyTorch 2.4.0, CUDA 12.6 and nnU-Net 2.5.1. Distance metrics were calculated using SimpleITK 2.4.0."}, {"title": "3 Results", "content": ""}, {"title": "3.1 Cross-Validation performance", "content": "The performance metrics for GTVp and GTVn across 5-fold cross-validation are summarized in Table 1 and Table 2. For GTVp, DSCagg ranged from 0.742 to 0.804 across different folds, with an average of 0.779. The HD95 varied from 5.7 mm to 10.4 mm, yielding an average of 7.5 mm. MSD ranged between 1.9 mm and 4.2 mm, with an average of 2.68 mm. For GTVn, DSCagg ranged from 0.751 to 0.885, with an average of 0.847. The HD95 showed a wider range from 15.2 mm to 24.5 mm, resulting in an average of 18.78 mm. The MSD values spanned from 2.6 mm to 4.2 mm, with an average of 3.36 mm."}, {"title": "3.2 Comparision of nnU-Net, ResEnc, UmambaEnc and\nUmambaAdj", "content": "Table 3 summarizes the performance of various models for GTVp and GTVn segmentation. For GTVp, the proposed UMambaAdj achieved the highest DSCagg (0.804) and the best results in terms of HD95 (5.7 mm) and MSD (2.6 mm).\nIn the case of GTVn, UMambaEnc achieved the highest DSCagg (0.880) and outperformed others with the lowest HD95 (10.5 mm) and MSD (2.2 mm).\nTwo cases were selected for illustration in Figure 2. For patient (a), all methods except UMambaAdj predicted a significantly smaller GTVp (DSC range 0.277-0.584), with the lower part missing, whereas UMambaAdj achieved a higher DSC of 0.703, despite all methods failing to capture the upper part. Additionally, the default nnU-Net model incorrectly identified a lymph node as GTVn, resulting in an HD of 75.2 mm, compared to 3.2-3.5 mm for the other methods. For patient (b), all methods except UMambaAdj made false positive predictions of GTVp in the same location. Moreover, all methods except UMambaEnc incorrectly predicted a lymph node as positive bilaterally, leading to an HD of 60 mm.\nThe training epoch time for the nnU-Net default model was 116 seconds, while the nnU-Net ResEnc took 127 seconds. The UMambaEnc required 400 seconds, and UMambaAdj took 199 seconds. Mixed-precision (fp16) autocast was enabled for all layers, except the Mamba layer, to ensure training stability."}, {"title": "3.3 Final test score", "content": "We submitted our trained UMambaAdj models in a Docker container to the HNTS-MRG 2024 challenge on the grand challenge platform. Predictions were made using an ensemble of all five models trained across the 5-folds. Our model was evaluated on the test set using pre-RT T2-weighted MRI images, achieving an DSCagg of 0.751 for GTVp and 0.842 for GTVn, resulting in an overall mean DSCagg of 0.796."}, {"title": "4 Discussion", "content": "In this study, we developed a customized network that integrates features from both UMamba and the nnU-Net Residual Encoder for T2-weighted MRI head and neck tumor segmentation. The aim was to combine the feature extraction strength of the residual encoder with the long-range dependency capabilities of Mamba blocks. Compared to the original UMambaEnc, the proposed UMambaAdj demonstrated comparable segmentation accuracy with reduced training and inference time, and outperformed UMambaEnc for GTVp. It also achieved significantly better HD95 and MSD while maintaining similar DSCagg compared to nnU-Net ResEnc. All recent methods outperformed the default nnU-Net model across all metrics, confirming the complementary strengths of UMamba and nnU-Net ResEnc in the proposed approach.\nThe cross-validation and final test results revealed a notable performance gap between the segmentation accuracy of the primary tumor (GTVp) and the nodal disease (GTVn). Although the DSCagg for GTVn was substantially higher than for GTVp, the HD95 and MSD metrics were significantly larger for GTVp.\nThis discrepancy suggests that the model struggled more with accurately delineating the nodal boundaries or even on detecting the nodes, often due to falsely predicted lymph nodes. These false predictions greatly influenced the distance-based metrics.\nOur experiments demonstrated that models incorporating the UMamba block achieved significant improvements in distance-based metrics (HD95 and MSD), underscoring the value of long-range dependencies provided by the Mamba. This capability is crucial for capturing the intricate structures of HNC tumors, where understanding dependencies between primary tumors and metastatic lymph nodes is vital. Notably, the proposed UMambaAdj model, which excludes the Mamba block from the first stage, matched the ResEnc model's DSCagg performance while achieving HD95 and MSD metrics similar to UMambaEnc. This suggests UMambaAdj effectively balances volumetric overlap and boundary delineation, although GTVn results indicate a need for the Mamba layer in the first stage.\nThe evaluation results show that while HD95 and MSD metrics vary significantly among the methods, DSCagg remains relatively consistent. This difference is due to the metrics' sensitivities: DSCagg, being a global overlap measure, is less affected by minor boundary discrepancies or isolated false predictions. In contrast, HD95 is highly sensitive to boundary inaccuracies, making it more responsive to small over-segmentation, under-segmentation, or isolated false predictions. This sensitivity makes these metrics more reflective of clinically relevant errors, where even small false positives or negatives would be unacceptable. This observation underscores the importance of employing multiple evaluation metrics for a comprehensive assessment of segmentation performance. Although DSCagg might be suitable as a single ranking metric in public challenges due to its straightforward interpretation, relying solely on it can be misleading. The best DSCagg method does not always correspond to the best overall segmentation performance, particularly in accurately capturing the boundaries or avoiding false predictions a critical factor in real-world clinical applications.\nDespite the promising performance of the proposed UMambaAdj model, its effectiveness must be validated on external datasets. Our current validation was limited to a single fold from a single institutional dataset, and thus, further testing on public datasets or other private datasets is essential to confirm the generalizability and robustness of our approach. This need for broader validation is especially relevant given the rapid emergence of various Mamba-based segmentation models since Mamba's initial publication.\nRecent adaptations, such as the \"Swin\" feature with Mamba [20], the tri-oriented vision Mamba approach [33], and the Visual Mamba U-Net [31], have shown that integrating Mamba with existing CNN blocks can lead to notable segmentation accuracy, all claiming achieved state-of-the-art (SOTA). However, some of these models still require significant modifications to match the 3D segmentation performance of nnU-Net. Our adjustments based on UMamba indicate that Mamba holds particular promise for HNC tumor segmentation, especially for GTVn.\nNevertheless, even with these advances, head and neck cancer tumor segmentation remains a challenging task that is far from being a \"solved\" problem. Fully automatic segmentation methods often face limitations that necessitate human intervention to ensure accurate treatment planning. In our study, despite achieving decent DSCagg scores, even SOTA models struggled with accurately identifying tumor locations, highlighting the persistent difficulties in this domain. The complex anatomy of the head and neck region, coupled with the challenge of distinguishing tumors in T2-weighted images (as evidenced in the GTVp cases from Figure 2), reinforces these challenges. Therefore, incorporating complementary information such as FDG-PET imaging [16,26], biopsy data, patient reports [25], or human interaction [32] may be crucial for improving the accuracy and reliability of HNC GTV segmentation."}, {"title": "5 Conclusion", "content": "In conclusion, our customized UMambaAdj model successfully combines the strengths of long-range dependencies from UMamba blocks with the feature encoding capabilities of the nnU-Net Residual encoder, offering a balanced solution for GTV segmentation in HNC. The model showed promise in achieving accurate segmentations with a more efficient architecture, demonstrating comparable or improved performance over existing methods. However, further validation on diverse datasets and incorporating complementary tumor information with human-in-the-loop strategies will be necessary to advance the application of automatic segmentation in clinical practice for MRI guided adaptive RT."}]}