{"title": "HedgeAgents: A Balanced-aware Multi-agent Financial Trading System", "authors": ["Xiangyu Li", "Yawen Zeng", "Xiaofen Xing", "Jin Xu", "Xiangmin Xu"], "abstract": "As automated trading gains traction in the financial market, algorithmic investment strategies are increasingly prominent. While Large Language Models (LLMs) and Agent-based models exhibit promising potential in real-time market analysis and trading decisions, they still experience a significant -20% loss when confronted with rapid declines or frequent fluctuations, impeding their practical application. Hence, there is an imperative to explore a more robust and resilient framework. This paper introduces an innovative multi-agent system, HedgeAgents, aimed at bolstering system robustness via \"hedging\u201d strategies. In this well-balanced system, an array of hedging agents has been tailored, where HedgeAgents consist of a central fund manager and multiple hedging experts specializing in various financial asset classes. These agents leverage LLMs' cognitive capabilities to make decisions and coordinate through three types of conferences. Benefiting from the powerful understanding of LLMs, our HedgeAgents attained a 70% annualized return and a 400% total return over a period of 3 years. Moreover, we have observed with delight that HedgeAgents can even formulate investment experience comparable to those of human experts (https://hedgeagents.github.io/).", "sections": [{"title": "1 Introduction", "content": "In contemporary financial markets, automated trading has emerged as a pivotal investment strategy [3]. Leveraging advanced algorithms, traders can actively track market trends in real-time, enabling swift and precise decision-making, thereby enhancing investment yields while mitigating risk [9]. The integration of artificial intelligence into financial transactions has unlocked significant opportunities, notably with the advent of large language models (LLMs) [4, 26, 36]. These cutting-edge models possess the capability to analyze extensive financial and news information, forecast market variations, and even produce financial analyses and reports [11]. Moreover, LLM-based agents can refine trading strategies through the simulation of market dynamics.\nDespite the impressive performance of these cutting-edge models [17, 32], they still lack the robustness required to withstand real-world fluctuations. As depicted in Figure 2, the performance of state-of-the-art models is notably poor on Total Return (TR) and Sharpe Ratio (SR) metrics. For instance, in \"rapid decline\" scenarios, 8 out of 9 baselines exhibit negative scores below zero. Meanwhile, both RL-based DeepTrader [28] and LLM-based FinGPT [31] experience financial losses ranging from -15% to -20% in \"frequent fluctuations\u201d scenarios. This limitation stems from the absence of risk management mechanisms within these models or systems, impeding their practical application in real markets. Compounded by the inherent complexity and uncertainty already prevalent in financial markets, the challenge of designing and optimizing trading strategies is further exacerbated.\nIn this paper, our aim is to incorporate the concept of \"hedging\" in the development of a robust and reliable financial trading system. Empirically, hedging serves as a strategic tool that enables traders to sustain returns amidst market volatility by constructing diversified portfolios. Along this line, we are committed to building a multi-agent system that mirrors real-world market, with a LLM acting as the brain [7, 30]. A key challenge lies in the configuration and coordination of these hedge agents, which constitutes our primary focus. Illustrated in Figure 2, unconstrained agent system (e.g. FinAgent [38]) can only achieve suboptimal performance.\nWe are devoted to developing a multi-agent hedging system named HedgeAgents. Within this well-balanced framework, we have established a comprehensive array of hedge agents, comprising a fund manager and a team of specialized experts in various fields such as Stocks, Forex, and Bitcoin. Each expert is tasked with overseeing their designated area, while the fund manager plays a pivotal role in orchestrating their efforts through facilitating discussions, conducting reviews, and consolidating insights. Leveraging the profound understanding capabilities of LLM, these agents (from their memories) have distilled invaluable investment experience akin to those crafted by human counterparts! Drawing from these rich experiences and hedging expertise, our HedgeAgents not only demonstrates unwavering stability even in the face of extreme conditions (Figure 2), but also wins across all metrics, achieving a total return of 400% over 3 years (Figure 1). We hold a strong belief that this research will pave the way for a dependable automated system that enhances the security of financial investments.\nThe contributions are summarized as follows:\n\u2022 To the best of our knowledge, this work represents a pioneering effort in integrating \"hedging\" within a multi-agent environment to develop a robust and reliable financial trading system.\n\u2022 We have established a hedging portfolio consisting of three experts and one manager, collaborating through three types of conference, with a LLM serving as the central cognitive hub.\n\u2022 Extensive experiments has demonstrated that our framework delivers optimal performance on all metrics, achieving a 70% annualized return and a total return of 400% over 3 years. Furthermore, the hedge experts within our framework have produced an invaluable investment experience in their memories akin to human expertise. The codes are available at here\u00b9."}, {"title": "2 Related Work", "content": "Quantitative finance is an interdisciplinary field that merges finance with mathematical and statistical methods to address complex financial challenges [9, 10]. It plays a crucial role in the valuation of sophisticated financial derivatives, portfolio optimization, and the analysis of market dynamics [8, 24]. With the advent of machine learning, the field has seen a surge in predictive modeling capabilities, enhancing both the accuracy of market forecasts and the efficiency of algorithmic trading systems [12], such as MV [33], DeepTrader [28]. As financial markets continue to evolve, the integration of quantitative techniques is essential for developing effective strategies that can withstand market uncertainties [11]."}, {"title": "2.2 LLM-based Agent", "content": "LLM-based Agents, leveraging the cognitive and generative prowess of Large Language Models [4, 26], promising advancements towards Artificial General Intelligence (AGI)[32]. LLMs play a vital role in enhancing the autonomy [27], reactivity, and social interaction capabilities of agents. This enables agents to perform a range of complex tasks, including natural language interaction, knowledge integration, information memory, logical reasoning, and strategic planning[18, 21]. LLM-based agent systems based on LLMs hold promise for impactful contributions across sectors like finance (e.g. FinGPT [31], FinAgent [38]), offering novel approaches and sophisticated solutions to intricate challenges [7, 30, 37]."}, {"title": "3 Proposed Method", "content": "The objective is to optimize returns while minimizing risk using hedging strategies. Specifically, this task involves utilizing financial data, encompassing prices and news, as input. Our framework then generates and implements trading actions, such as buying and selling, across three domains: Bitcoin, Stocks, and Forex."}, {"title": "3.2 Overall Framework", "content": "The HedgeAgents framework simulates the architecture of a real hedge fund company, aiming to optimize risk hedging for multi-asset investment portfolios. As depicted in Figure 3, the framework comprises four agents: Bitcoin Analyst Dave, Dow Jones Analyst Bob, Forex Analyst Emily, and Hedge Fund Manager Otto. Each of the three analysts is in charge of managing a specific asset. Otto, as their supervisor, is responsible for the overall risk management of the investment portfolio and the distribution of the asset investment budget. To achieve effective collaboration, we have established three types of multi-agent coordination meetings: Budget Allocation Conference (BAC), Experience Sharing Conference (ESC) and Extreme Market Conference (EMC). These conferences serve to facilitate budget allocation, experience summary, and swift emergency actions."}, {"title": "3.3 Definitions of Single Agent", "content": "In this section, we will provide a comprehensive overview of the composition and execution process of a single agent, designed to simulate the human decision-making process in investments. Each agent comprises a range of financial analysis tools T, along with definitions for profile, action A, memory and reflection M. Among them, there are 23 tools, encompassing Indicator Analysis, Cryptocurrency Market Analysis, and Risk Management. Actions comprise 8 types, such as Buy/Sell/Hold for current assets. Memory is categorized into 3 types: basic Market Information Memory MMI, Investment Reflection MIR, and General Experience MGE."}, {"title": "3.4 Coordination of Hedging Agents", "content": "In this section, we design three collaborative meetings to implement the hedging strategies of multiple agents. Among them, the periodic Budget Allocation Conference realizes the trading of multiple assets, with Dave (Bitcoin), Bob (Stocks), Emily (Forex), and manager Otto participating. The Extreme Market Conference serves as an emergency mechanism, enhancing the overall robustness of our system, while the Experience Sharing Conference fosters the exchange of valuable investment insights."}, {"title": "3.4.1 Budget Allocation Conference", "content": "This conference spans a 30-day cycle, wherein Dave, Bob, and Emily present reports to Manager Otto aimed at budget allocation. Each report encompasses the current profit situation Rp alongside budget expectations & reasons Rb. Subsequently, manager Otto consolidates all reports and auxiliary tools Ra via a prompt template \\(f_p\\), to evaluate expected future returns pi.\n\\(P_i = LLM (\\varphi_p (R_p, R_b, R_a)), i \\in \\{Dave, Bob, Emily\\}.\\)"}, {"title": "4 Experiments", "content": "We have compiled a comprehensive financial dataset comprising Bitcoin, foreign exchange, and the Dow Jones component stocks. These data were sourced from reputable financial databases, namely Yahoo Finance and the Alpaca News API. The dataset spans from January 1, 2015, to December 31, 2023, encompassing daily data points such as open, high, low, and close prices, as well as volume and adjusted close prices. Additionally, daily news updates\u00b2 and 60 standard technical analysis indicators are included for each asset."}, {"title": "4.2 Evaluation Metrics", "content": "We compare HedgeAgents and baselines in terms of 9 financial metrics following [19, 23], which include 2 profit metrics: Total Return (TR), Annual Return Rate (ARR); 3 risk-adjusted profit metrics: Sharpe Ratio (SR), Calmar Ratio (CR), Sortino Ratio (SOR); 2 risk metrics: Maximum Drawdown (MDD), Volatility (VOI); and 2 diversity metrics: Entropy (ENT) and Effect Number of Bets (ENB)."}, {"title": "4.3 Implementation Details", "content": "The dataset is divided using January 1, 2021, as the cutoff point, with data from January 1, 2015, to December 31, 2020, designated as the training set, and data from January 1, 2021, to December 31, 2023, as the testing set. Notably, during the testing phase, only historical prices can be access to avoid data leakage issues. To ensure the fairness of the evaluation results, all baseline models are trained and tested in the same reinforcement learning environment.\nFor baseline configurations, we employed Optuna [1] for hyperparameter optimization. For LLM-based approaches and HedgeAgents, we consistently use the GPT-4-1106-preview version with a temperature setting of 0.7 to balance consistency and creativity. The memory module in our framework is designed as a text similarity-based storage and retrieval mechanism, utilizing the text-embedding-3-large model [15], with a top-k value of 5. We ensured LLM-based methods are adjusted to their optimal configurations as suggested in their respective studies."}, {"title": "4.4 Overall Performance Comparison", "content": "We selected a diverse range of classical and state-of-the-art baseline models for comparison purposes. These encompass three classical rule-based quantitative investment strategies: MV[33], ZMR[5], and TSM[13]; three reinforcement learning-based financial agents: SAC [6], DeepTrader [29], and AlphaMix+[22]; and three LLM-based methods: FinGPT[31], FinMem [34], and FinAgent [38]. To ensure a fair comparison, we meticulously adhered to the specific requirements of each baseline, providing them with the necessary conditions for optimal performance."}, {"title": "4.5 Ablation Study", "content": "To comprehensively evaluate the utility of Experience Sharing Conference (ESC), Budget Allocation Conference (BAC), and Extreme Market Conference (EMC) in our proposed multi-agent architecture, we conducted a systematic ablation study."}, {"title": "4.5.1 Effectiveness of Each Conference", "content": "The experimental results are shown in Table 2, We have the following observations: 1) The ESC module is crucial for portfolio diversification and hedging tail risks associated with individual assets, which is beneficial for enhancing returns and risk resistance capabilities. When this module is removed, the ENT metric decreases by 16.63% to 2.61, showing the largest drop; although the annualized return and Sharpe ratio decrease, they remain at a moderate level. 2) The BAC module has the greatest impact on returns. After removing this module, the annualized return drops by 37.75% to 44.57%, the lowest among the three single-module experiments; however, when only this module is retained, the annualized return reaches the highest value of 45.58% for a single module. 3) The EMC module is vital for risk aversion and return robustness. After removing this module, the maximum drawdown rate increases by 71.93% to 24.44%, and the Sharpe ratio decreases by 19.86% to 1.93; however, when only this module is retained, both the maximum drawdown rate and Sharpe ratio achieve the best levels among single modules. 4) The synergistic effect of the three modules significantly impacts the overall performance. Taking the Sharpe ratio as an example, compared to the removal of the other modules alone, the Sharpe ratio of the complete architecture improves by 41.29%, 60.65%, and 19.72%, respectively, highlighting the synergistic effect of each module and ensuring a balance between risk and return. This demonstrates the superior performance of our effective multi-agent architecture."}, {"title": "4.5.2 Effectiveness of LLM Backbone", "content": "To evaluate the performance of different LLMs as the backbone in our HedgeAgents, we selected 6 representative models, including ChatGLM-6B[35], Baichuan-13B[2], Qwen-72B[20], Gemini 1.5 Pro[25], gpt-3.5-turbo-16k[14], and gpt-4-1106-preview [16]. We incorporated each of these models into the HedgeAgents framework and tested their investment performance.\n1) Robustness Analysis: As shown in Figure 5, despite variations in individual metrics across backbones, the curves shapes are strikingly similar, indicating that our framework is not entirely contingent upon the capabilities of a certain language model.\n2) Impact of Parameter Size: Experimental results demonstrate that an increase in parameters contributes to enhancing the investment returns. The gpt-4-1106-preview significantly outperforms others in terms of ARR and TR metrics. Notably, models with more parameters tend to adopt more aggressive investment strategies, which can lead to higher risk. Conversely, ChatGLM-6B achieves the best scores in MDD and SR, showcasing strong risk control capabilities.\n3) Comparison between Open-source and Closed-source: Closed-source models exhibit excellent performance across all metrics, likely due to their proprietary optimization algorithms and datasets, which provide them with a competitive edge in decision-making capabilities. In the realm of open-source models, Qwen-72B demonstrates performance comparable to the closed-source model.\nTherefore, we have selected GPT-4 as the core of our framework. Notably, our system has accumulated a total cost of $15 over the three years, averaging only 2 cents per day!"}, {"title": "4.6 Single-Asset Performance without Hedging", "content": "In the previous setup, we examined performance in a multi-asset hedging scenario. In this subsection, we will divide our dataset into three categories: Bitcoin-only, AAPL-only (stocks), and YUAN-only (forex). This will allow us to assess the capabilities of all models under single-asset conditions without any hedging strategy.\nFigure 6 illustrates the cumulative returns of all models over a three-year period for each single asset. 1) The Bitcoin-only setting showcased HedgeAgents' exceptional management of high-volatility assets, achieving a cumulative return of about 210%, far exceeding all baseline models. The Bitcoin expert, Dave, excelled in interpreting blockchain data, anticipating regulatory changes, and analyzing global adoption trends, which facilitated stable growth and resilience during market downturns. 2) In the stock market, represented by AAPL, HedgeAgents attained a cumulative return of approximately 160%, significantly outperforming competitors like FinAgent and FinMem, which recorded returns of about 135% and 120%, respectively. The stock expert, Bob, adeptly navigated both bullish and bearish periods, maintaining consistent growth through his skills in analyzing financial statements and predicting market movements. 3) For the forex market, represented by YUAN, HedgeAgents achieved a modest but positive return of around 9%, surpassing several baselines that showed negative returns. The forex expert, Emily, demonstrated a deep understanding of macroeconomic indicators, geopolitical events, and central bank policies, enabling the model to capitalize on small price movements and achieve profitability.\nThese results highlight the versatility and robustness of HedgeAgents across various asset classes and market conditions."}, {"title": "4.7 Visualization", "content": "To examine our framework's cognitive processes during execution, we have employed visualizations to elucidate the workflow of a single agent and how Otto achieves hedging strategies."}, {"title": "4.7.1 Visualization of single agent", "content": "Figure 7 illustrates the decision-making process of a single agent, exemplified by Bitcoin Analyst Dave. Dave's workflow begins with a market analysis noting significant price increases and a robust growth trajectory for Bitcoin. This prompts him to query about historical performance under similar optimistic conditions influenced by macroeconomic policies. Through memory retrieval, Dave recalls past instances where optimistic expectations led to full investment in Bitcoin, but also highlights the challenges of swift position liquidation during subsequent market changes. This historical context informs Dave's decision-making phase, where he considers the positive influence of current macroeconomic policies. Balancing optimism with caution, Dave decides to purchase 50% of the current position in Bitcoin, complemented by continuous market monitoring. This measured approach reflects Dave's synthesis of historical lessons and present market dynamics. The reflection phase reveals a 7.43% increase in asset value over four trading days, validating the effectiveness of Dave's strategy. Consequently, he advocates for maintaining a prudent investment posture and implementing dynamic asset management strategies. Dave's workflow exemplifies an iterative learning process that combines historical insights with real-time analysis, enhancing decision quality in the volatile market."}, {"title": "4.7.2 Visualization of hedging expert", "content": "Figure 8 illustrates the decision-making process of Otto, our hedging expert agent, during a significant Bitcoin market decline of 10.22%. In this scenario, Otto first assesses the market condition, noting the current portfolio composition of 13.2% cash and 56.8% Bitcoin. Otto's risk assessment identifies three key factors: the recent Bitcoin price surge and subsequent correction, the impact of Federal Reserve policies on market liquidity, and Bitcoin's inherent volatility. Based on this analysis, Otto concludes that a cautious and balanced approach is necessary to protect the portfolio. The situation analysis reveals Otto's concern about the high volatility of the Bitcoin market and the current losses, leading to the decision to avoid excessive trading and risky bottom-fishing strategies. In response to these conditions, Otto proposes a comprehensive hedging strategy. This strategy combines portfolio diversification, options trading, and risk management techniques to create a multi-layered hedge against market volatility. By employing this balanced approach, Otto aims to mitigate downside risk while preserving upside potential in adverse market conditions. The effectiveness of Otto's approach is evident in the final operation result, where total assets increased by 8.6% over two days, despite the initial market turbulence."}, {"title": "5 Conclusions", "content": "This paper presents HedgeAgents, an innovative multi-agent system designed to bolster the robustness of financial actions via hedging strategies. Within this crafted framework, we have developed a suite of specialized hedging agents and organized regular conferences to foster collaboration among multiple agents. Through extensive experiments, our framework has consistently demonstrated superior and robust performance. Furthermore, our observations via visualization indicate that our HedgeAgents is capable of generating investment experience in their memories on par with those achieved by human experts."}, {"title": "6 Acknowledgments", "content": "This work is supported in part by the National Natural Science Foundation of China (62372187), in part by the National Key Research and Development Program of China (2022YFC3601005) and in part by the Guangdong Provincial Key Laboratory of Human Digital Twin (2022B1212010004). The authors are highly grateful to the anonymous reviewers for their careful reading and insightful comments."}, {"title": "A Experiment of Ablation Study", "content": null}, {"title": "A.1 Effectiveness of Each Conference", "content": "Cumulative returns of ablation analysis on three conference, as shown in Figure 9."}, {"title": "A.2 Effectiveness of LLM Backbone", "content": "For using different LLM as the backbone for HedgeAgents, their experimental results are presented in Table 3, and the cumulative returns chart is in Figure 10. the activation of the MR. Compared to the ARR and SR without the module the enhancements reached 57.71% and 39.3%, directly confirming the positive role of the MR module in promoting returns and hedging risks. To delve deeper into the operational mechanics of the MR module, let's consider the case of DJ30 analyst Bob. We'll illustrate the distribution of various types of memory embeddings when employing this module, as depicted in Figure 11 (b). By employing t-SNE for dimensionality reduction and visualization, we have observed that embeddings derived by LLM from hierarchical memory contents, including Market Information Memory, General Investment Experience Pool, and Intelligent Investment Reflection Memory, showcase a discernible clustering distribution in semantic features. This indicates a certain level of distinctiveness between different categories. Such findings substantiate the efficacy of our Hierarchical Memory Retrieval approach in effectively capturing the semantic attributes of memory content, thereby furnishing the agent with valuable contextual memory support."}, {"title": "B Experiment of Memory Retrieval", "content": "To quantify the impact of the Memory Retrieval (MR) module on the overall performance of HedgeAgents, we have specifically designed comparative experiments with and without this module."}, {"title": "C Experiment of Temporal Isolation", "content": "To minimize the risk of inadvertent information leakage, we designed context-rich prompts incorporating real-time conditions, market variables, and asset-specific data. Figure 12 shows the performance of HedgeAgents during Q1-Q3 of 2024, demonstrating its ability to adapt to rapidly changing market with high predictive accuracy and robustness. The model achieved a Total Return of 68.44%, a Sharpe Ratio of 2.1. These results validate the model's robustness and confirm the effectiveness of our information leakage mitigation strategies."}]}