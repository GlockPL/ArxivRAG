{"title": "Automatically Planning Optimal Parallel Strategy for Large Language Models", "authors": ["Zongbiao Li", "Xiezhao Li", "Yinghao Cui", "Yijun Chen", "Zhixuan Gu", "Yuxuan Liu", "Wenbo Zhu", "Fei Jia", "Ke Liu", "Qifeng Li", "Junyao Zhan", "Jiangtao Zhou", "Chenxi Zhang", "Qike Liu"], "abstract": "The number of parameters in large-scale language models based on transformers is gradually increasing, and the scale of computing clusters is also growing. The technology of quickly mobilizing large amounts of computing resources for parallel computing is becoming increasingly important. In this paper, we propose an automatic parallel algorithm that automatically plans the parallel strategy with maximum throughput based on model and hardware information. By decoupling the training time into computation, communication, and overlap, we established a training duration simulation model. Based on this simulation model, we prune the parallel solution space to shorten the search time required. The multi-node experiment results show that the algorithm can estimate the parallel training duration in real time with an average accuracy of 96%. In our test, the recommendation strategy provided by the algorithm is always globally optimal.", "sections": [{"title": "Introduction", "content": "Scaling laws are driving large language models (LLMs) to become larger and larger in recent years(Kaplan et al. 2020; Hoffmann et al. 2022). The larger training data volume and larger models impose higher requirements on training hardware. Previously, engineers could train models on a single Neural network Processing Unit (NPU), but now training large models requires multiple servers or even a large training cluster.\nCollaborating such a large cluster to train a large language model is very delicate and complex. Designers need to carefully consider how to allocate models to different NPUs and use extra ones to process data in parallel to accelerate training. Many advanced distributed training methods, such as tensor parallelism(Dean et al. 2012; Shoeybi et al. 2019), pipeline parallelism(Huang et al. 2019) and data parallelism(Li et al. 2014a,b), are proposed. Meanwhile, aiming to develop more scalable and efficient training processes, distributed training framework such as Megatron(Narayanan et al. 2021b), DeepSpeed(Rasley et al. 2020) and ModelLink(Ascend 2024b) are designed. Combining multiple parallel strategies, these systems can train large models with billions of parameters on large clusters. However, for a large number of training hyperparameters introduced by multiple parallel strategies, these systems do not provide the basis for hyperparameter selection, but merely provide recommended empirical values. This makes it difficult for users to select hyperparameters for their own models.\nThe suboptimal parallel strategy can lead to increased training time, which means additional costs and is expensive in the development of high cost large-scale language models. In the absence of guidance, users often need to do a lot of pre-experiments to determine a set of hyperparameters, which also means wasted time and increased costs.\nBased on this dilemma, some work provides hyperparameter search strategies for these systems(Chen et al. 2024; Isaev et al. 2023; Miao et al. 2022). However, due to the complexity of parallel frameworks, finding the globally optimal parallel strategy quickly and accurately remains a challenge. In this article, we propose an automatic planning algorithm for finding the optimal parallel strategy. Our algorithm first simulates the training duration, and by analyzing and modeling at the operator level, we can achieve an average estimation accuracy of 96% for the training time. Then, based on the simulation model, we establish a pruning strategy that can prune 99% of the search space, making it easy for us to enumerate the most efficient parallel strategies.\nUnlike previous work, our algorithm covers a more comprehensive range of parallel hyperparameters, including terms such as micro batch size and global batch size that are often overlooked. The main content of this paper will be divided into the following three parts.\n\u2022 Training duration simulation: We divide the parallel training duration into several sub items: computation, communication, and overlap, and simulate each items. Based on partial estimation, we can estimate the total training time required for each parallel strategy.\n\u2022 Pruning and Searching: We first propose a complete planning model with a very large feasible range. Based on the simulation model, we prune the search space, reduce the feasible range size by nearly 99%. Finally, we search for the optimal parallel strategy within a very small domain.\n\u2022 Experiment and verification: We experiment with various Large Language Models on a small-scale cluster to verify whether our simulation algorithm and search algorithm are accurate."}, {"title": "Related Work", "content": "Basic parallel methods\nEach parallel strategy has its own focus and limitations. Therefore, efficient training of LLMs on large scale usually requires a combination of multiple parallelization methods.\nData parallelism (DP) can divides a large batch size of data to multiple workers(Li et al. 2014b). It replicates the entire model on multiple workers and accelerates the learning efficiency of the model through parallel computing. The respective gradient will be accumulated periodically to ensure the consistency of the weights in different workers.\nTensor parallelism (TP) partitions weights and activation tensors of LLMs over multiple devices(Dean et al. 2012), and communicates at specific locations at each layer to aggregate block tensors. The parameters can be split along its row or column dimension to reduce the number of communications. With the segmentation strategy provided by Megatron-LM(Shoeybi et al. 2019), each transformer layer only requires two communications in the forward/backward computation. However, because TP communication occurs at each layer, the communication frequency is relatively high. In the backward stage, a certain overlap algorithm(Rashidi et al. 2021; Wang et al. 2022) can be used to perform communication and calculation at the same time, thus reducing communication time cost.\nPipeline parallelism (PP)(Jia, Zaharia, and Aiken 2019; Yang et al. 2021) splits the layers of LLMs into parts and allocates them to multiple workers. Activetion are communicated point-to-point between workers and are calculated in sequence. Because the execution of different layers of LLMs must wait in line, a certain amount of time waste is inevitable. This extra time is called pipe bubbles. There have been a lot of methods trying to reduce the pipeline bubbles. GPipe (Huang et al. 2019) divided a training batch into multiple micro batches and queued for computation to reduce the waiting time of subsequent NPUs. PipeDream-Flush (Narayanan et al. 2021a) is an improved version of GPipe. It chooses the strategy that one forward pass followed by one backward pass (i.e., 1F1B), which effectively reduces the memory usage compared to GPipe. By dividing the reverse calculation into two parts, the new work(Qi et al. 2023) achieves lower bubble rate and effectively improves the throughput of PP.\nOthers parallelism. The combination of DP TP PP is called 3D parallelism. In addition, there are many other parallel ways. Some methods solve the memory overhead introduced by LLM long sequences through sequence parallelism(Li et al. 2021; Korthikanti et al. 2023). Optimizer parallelism (Rajbhandari et al. 2021)divides optimizer states, gradients, and parameters to reduce redundant memory usage. This makes it possible to train larger models with limited memory resources. Parallel method for Mixture-of-Experts (MoE) model is also proposed(Kim et al. 2021), and the model parallelism is carried out by splitting experts. Most of these parallel approaches are independent of 3D parallelism and can be optimized separately. In addition, most distributed frameworks are based on 3D parallelism. Therefore, in this paper, we only consider the optimal strategy search of 3D parallelism, and will continue to incorporate other parallel methods in the future.\nPrior strategy search methods\nBefore our work, there was some other projects tried to solve the problem of optimal parallel strategy searching.\nMindspeed(Ascend 2024a) provides a strategy search algorithm based on profile, which can perform probabilistic search in the pruned strategy space. The profiling-based algorithm provides precise order-preserving estimation, but it takes a long time to search. Gavatron(Miao et al. 2022) uses decision tree and dynamic programming to search for optimal strategy, and supports asymmetric model parallelism across devices. It only uses profiling for computing power estimation, training time is obtained by simulation, which greatly reduces the time of searching algorithm. However, it ignores the optimization of micro-batch. We demonstrate that ignoring this parameter may result in missing the global optimum.\nAs an analytical performance model, Calculon(Isaev et al. 2023) provides a training time estimation method, which can also be used to select the optimal parallel strategy. In contrast to Gavatron, Calculon sets the micro batch size to the maximum size that the memory can hold for the sake of computing density. However, our experiments indicate that there is an optimal value for micro batch size. When the optimal value is exceeded, additional increase will only lead to an increase in bubbles, which in turn reduces training efficiency. InternEvo(Chen et al. 2024) is a new parallel training framework with specific optimizations for long sequence transformers. The training time estimation and automatic parallelism are included in the framework, but part of the communication is ignored, which may affect the order preservation.\nUnlike previous work, our autoparallel algorithm takes into account more comprehensive variables, such as global batch size and micro batch size, which are often assumed to be constants in other work. The newly introduced variables will cause the search space to become larger, especially global batch size will expand the search space to infinity. In order to reduce the complexity caused by the increase of variables, we set up a white-box simulation system. The mathematical proof based on the white-box system helps us to prun the search space a lot, even if more variables are introduced, the search strategy space becomes very limited."}, {"title": "Auto Parallelism Process", "content": "We use Figure 1 to summarize the overall process of our auto-parallel planing algorithm. The implementation of the algorithm can be divided into two steps: training duration simulation and pruned search of the optimal strategy.\nThe first step is to establish a simulation model based on the information of the model and training cluster, which can be used to estimate the required training duration for each strategy. The simulation of training duration can be divided into deterministic part and uncertain part. The deterministic part includes the computation volume, communication volume of the transformer model, which is static with the training test, and can be estimated by direct calculation. The uncertain part includes the utilization rate of computing power and effective transmission bandwidth of the cluster, which are dynamic during the training process and obtained through profiling. This profile can be completed in advance to ensure a quick start for each training task. Alternatively, it can be performed before each training session to reduce interference.\nIn the strategy search algorithm, due to the consideration of multiple parallel variables, the search space is large and the complete search will be impossible. Based on this, we have established a search space pruning method based on the simulation model. It is possible to narrow down the search scope by more than 99%. Finally, we find the optimal strategy through enumeration in a relatively small search space. Next, we'll discuss two parts of the algorithm in detail."}, {"title": "Training Time Estimation", "content": "Notation and target\nTo ensure the effectiveness of optimal strategy search, the simulation of training duration must be accurate and stable, and the order-preserving property must be provided. In this section, we introduce our training duration simulation model. Table 1 lists symbols to be used in this paper.\nIn order to make an accurate simulation, we split the training duration into several items and model them separately. Specifically, the total training duration is represented as equation 1,\n$T_T = (T_F + T_{CT} + T_{AT} - T_O + T_{CD} + T_{AD} + T_B + T_{CP}) \\frac{S_t}{G}$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ITY."}, {"title": "Experiment and Result", "content": "Experimental Setup\nIn this section, we conducted experiments to verify the accuracy and robustness of our algorithm. The main purpose of the experiment was to examine three aspects:\n\u2022 Simulation precision: How accurately does the simulation algorithm estimate training time under different parallel settings.\n\u2022 Rank preservation: Whether the algorithm can find the global optimal parallel setting and whether the ranking of sub-optimal strategies is accurate.\n\u2022 Inference correctness: Whether our inferences about G, b, and memory hold.\nOur experiment was conducted using 16 Ascend 910b NPUs on 2 servers, with each NPU having a maximum computing power of 313T and a memory capacity of 64GB. Internal communication within the server is done through mesh architecture, while communication between servers is done through ring. The total data volume and global batch size of the experiment is fix to 256. The distributed training framework is ModelLink, a large language models solution that is well adapted to the NPU. The software environment used is python3.8, pytorch2.1.0.\nSimulation precision\nTo verify the simulation accuracy of the algorithm for training time, we estimate the training time under different models and parallel configurations, and compare the results with the real profiling. Since most of the profiling tools cannot measure the granularity of our formula 1, we combine those item to align with the profiling tools. What needs to be compared is computation duration, communication duration, and the overlap. Among them, bubbles time and reduce computation time are both included in the communication duration."}, {"title": "Rank preservation", "content": "In the test, our algorithm successfully suggests the global optimal strategy for all the tested models. The optimal parallel strategy for Baichuan2-7b and Qwen-14b is (2, 4, 2, 2). Among the remaining strategies, t = 4 is optimal, slightly better than t = 8 suggested by Megatron-LM.\nIn addition, our algorithm not only accurately finds the global optimal parallel strategy, but also correctly estimates and sorts the top five sub-optimal strategies. In the experiment, all the strategies are sorted correctly, which proves that our algorithm has reliable rank-preserving property. The deviation between the estimated time and the actual training time is stable."}, {"title": "Inference correctness", "content": "In previous section, we propose several pruning theorems based on our white box model. These theorems constrain our searching space, such as G and b, enabling enumeration based algorithms to conduct. Previous work often ignores these two hyperparameters, especially in the setting of b, where most of the work was controversial. For example, Gavatron sets b to 1, while Calculon sets it to the maximum value within the memory capacity. Here, we set up experiments to verify the validity of the inference of G and b.\nTraining accelerate from G. By observing the single-step training time under different G settings, we evaluate the efficiency of the algorithm in resource utilization. While keeping other parameters unchanged, we gradually doubled G from 32 to 512, and recorded the single step time of training for each G. The result of training efficiency evaluation is shown in Figure 3. When G increases from 32 to 512, the number of batches processed per second increases, indicating that the model performs well in utilizing computational resources. A larger G allows for more efficient sample usage, reducing the computational overhead for each iteration, thereby accelerating the training process. However, the acceleration effect of G is only effective for a part of the time-consuming term, and a decrease in the acceleration effect can be observed."}, {"title": "Conclusion", "content": "In this article, we propose an automatic parallel algorithm based on simulation and strategies search. Our algorithm automatically adjusts the configuration of parallel strategies based on the specifications of the training cluster and models, providing the most efficient training strategies. Experimental results have shown that our algorithm can make very accurate estimates of training time. Even though the optimal strategies for different models may vary greatly, our algorithm can accurately find the global optimum. In recent years, many efforts have been made to address the issue of automatic parallelism. The main difficulty lies in the fact that simulating and modeling training duration is a very detailed and tedious task, and some small errors can easily occur and accumulate. Moreover, when theoretical simulation models are applied in practice, they inevitably encounter many interferences, which is difficult to quantify, resulting in system instability. It is very difficult to establish a precise and robust simulation model. In this work, we have made fine adjustments to the simulation model, and many items in the model have undergone multiple iterations to ensure the accuracy of the estimation. However, in terms of communication duration simulation, there is still space for improvement in our current work, and we expect to further optimize this part in future iterations."}, {"title": "Communication duration", "content": "Similar to the simulation of the computation duration, the simulation of the communication duration is carried out by the following basic ideas:\n\u2022 Communication duration = Total communication volume / (Full speed bandwidth \u00d7 Slow down rate).\nThe total communication volume depends on the model and the parallel approach, and this part of the simulation is static and can be obtained through direct analysis of the parallel training framework. On the other hand, the full speed bandwidth and bandwidth slow down rate are dynamic during the training process, depending on the physical connection form and communication algorithm. For example, if a meshed connection and communication algorithm are used within the server, the bandwidth of communication will not decrease with the increase of members. On the other hand, in a ring communication method, when there are fewer communication members, the bandwidth will be high, but as the number of members increases, the bandwidth will linearly decrease. Same as the estimation of computation duration, the dynamic part of communication is obtained through profiling."}, {"title": "Data parallelism", "content": "DP communication occurs at the end of each step and is used to synchronize model weights across different devices. The communication methods employed here is ring all-reduce, the duration estimation is shown in equation 4,\n$T_{CD} = \\lambda_1 + \\frac{1}{n} \\lambda_2 + \\frac{1}{n} \\lambda_1 \\frac{p}{t} + 2(\\frac{1}{td} -\\frac{1}{n})B_s$,\n\\$ \\lambda_1 = \\frac{2L(4h^2 + 2hH + 9h + H)u}{g} \\quad (5)\n \\lambda_2 = \\frac{2Vhu}{g}$."}, {"title": "Tensor parallelism", "content": "The intra-server communication adopts in our work is the mesh grid method, which means that the all-reduce of TP can be one-to-all. Therefore, the TP communication duration based on this architecture merely increases with the TP degree. However, as the number of communication members increases, bandwidth congestion may occur, resulting in a slight increase in communication duration. We evaluate this effect using a slow rate q, q obtained by profiling. The simulation for TP communication is presented in equation 6,\n$\\T_{CT} = \\begin{cases}0, & t=1\\\\\\gamma_1 + \\gamma_2 p, & t>1\\end{cases}$,\nwhere\n$ \\gamma_1 = \\frac{8LshuG}{q g 2n} \\quad \\quad (7)\n \\gamma_2 = \\frac{shuG}{q g 2n}$."}, {"title": "Pipeline parallelism", "content": "The time consumption caused by PP consists of two parts: bubble and point-to-point(P2P) transmission.\nBubble is the main time-consuming part, since NPU at the end of the queue must wait for the preceding members to complete their computation and communication. Some interleaved pipeline scheduling can reduce this wait time and keep the NPU in compute(Huang et al. 2019; Yang et al. 2021). Here, we use the PipeDream-Flush(Narayanan et al. 2021a) for modeling, also known as 1-forward 1-back (1F1B) scheduling. After an initial startup period, all NPUs enter the computing state. In addition, the activation cache does not increase infinitely with micro-steps. The simulation of bubble time is shown in equation 8,\n$T_{BP} = (T_T + T_{CT} + T_{ART} - T_o) \\times \\frac{p-1}{m}.$\nIt is important to note that bubble time refers to the waiting period for other NPUs to complete their computations and communications. Thus, both computation and TP communication contribute to bubbles.\nAnother time-consuming item is P2P communication. PP communication transfers an activation to the next NPU when its computation ends, which takes a relatively short time. The estimation of PP communication is presented in equation 9,\n$T_{CP} =\\begin{cases} 0, p=1\\\\(a pt + 2\\beta p b - 3\\beta b, p>1\\end{cases}.$\n$a = \\frac{shuG}{g \\quad (10)}\n\\beta=\\frac{shuG}{g}$"}, {"title": "Overlap", "content": "In our training framework, all-reduce occurs in both the multi head attention layer and feed-forward layer. This communication can overlap with computation during back propagation. So the basic idea of communication overlap is that, the communication of the activation and the computation of weight can be synchronized during the backward stage.\nFigure 2 shows the stages of two all-reduce operations, with the direction of the arrows indicating forward propagation. During backward propagation, the communication between X\u2081 and X\u2082 can be synchronized with the computations and updates of WA1, WA2, WP1, and WP2.\nThe time estimation of overlap can be summarize as equation 11,\n$To = min(T(AR(\\frac{dL}{dx1}),\\frac{dL}{dx2}),T(\\frac{dL}{dwMAH},\\frac{dL}{dwMLP}))\\quad (11)$.\nThe all-reduce communication time of activation has been described in the TP communication duration, and the computation time of the weight can be expressed as:\n$\\frac{dL}{dwL}=\\frac{3ush^2 L}{nUmax},\\quad Gp, MAH\\\\\\frac{ushHL}{nUmax},\\quad Gp, MLP. (12)$"}, {"title": "Strategy Searching", "content": "Overall searching space\nBy simulating the training duration items", "target": "narg min $T_T$ \np", "as": "n$T_T = (\\frac{1"}, {"considerations": "computing efficiency and memory limitation. In terms of computing efficiency, the increasing of b expands the input tensor shape of each operator, which boost computing power utilization, but the increase in computing power is marginally decreasing. On the other hand, an increase in b leads to an increase in bubbles. Based on this trade-off, we think that there is an optimal value for b, which is easy to verify by the partial derivative of Tr, as Formula 16.\n$\\frac{dT_T}{db}=\\frac{S_t}{G} (\\omega_1 \\frac{\\partial \\rho (b)}{\\partial b}+ \\omega_2 b \\frac{\\partial \\rho (b)}{\\partial b} + \\omega_3"}]}