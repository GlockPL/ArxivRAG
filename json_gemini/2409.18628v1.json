{"title": "Towards Integrating Epistemic Uncertainty Estimation into the Radiotherapy Workflow", "authors": ["Marvin Tom Teichmann", "Manasi Datar", "Lisa Kratzke", "Fernando Vega", "Florin C. Ghesu"], "abstract": "The precision of contouring target structures and organs-at-risk (OAR) in radiotherapy planning is crucial for ensuring treatment efficacy and patient safety. Recent advancements in deep learning (DL) have significantly improved OAR contouring performance, yet the reliability of these models, especially in the presence of out-of-distribution (OOD) scenarios, remains a concern in clinical settings. This application study explores the integration of epistemic uncertainty estimation within the OAR contouring workflow to enable OOD detection in clinically relevant scenarios, using specifically compiled data. Furthermore, we introduce an advanced statistical method for OOD detection to enhance the methodological framework of uncertainty estimation. Our empirical evaluation demonstrates that epistemic uncertainty estimation is effective in identifying instances where model predictions are unreliable and may require an expert review. Notably, our approach achieves an AUC-ROC of 0.95 for OOD detection, with a specificity of 0.95 and a sensitivity of 0.92 for implant cases, underscoring its efficacy. This study addresses significant gaps in the current research landscape, such as the lack of ground truth for uncertainty estimation and limited empirical evaluations. Additionally, it provides a clinically relevant application of epistemic uncertainty estimation in an FDA-approved and widely used clinical solution for OAR segmentation from Varian, a Siemens Healthineers company, highlighting its practical benefits.", "sections": [{"title": "1 Our Datasets for Uncertainty Model Evaluation", "content": "In this application study, we evaluate the integration of uncertainty estimation and OOD detection within the framework of a clinical solution from Varian, a Siemens Healthineers company, designed for OAR contouring in radiotherapy. The study leverages a CT dataset comprising scans of the pelvic region, each resampled to an isometric resolution of 1 mm per voxel. Segmentation annotations for six organs Bladder, Prostate, Rectum, Femoral Head Left, Femoral Head Right and Seminal Vesicles were created in-house by a team consisting of radiologists, radiation oncologists and trained personal. The primary dataset comprises 679 training and 20 control cases. In addition we collect three distinct OOD datasets:"}, {"title": "2 Our Method for Epistemic Uncertainty Estimation and OOD Detection", "content": "This section provides details of the architectural design, training protocol, and statistical methods for uncertainty quantification essential to integrate epistemic uncertainty estimation into the radiotherapy contouring workflow."}, {"title": "2.1 OAR Contouring: Architectural Design and Training Protocol", "content": "We approach OAR contouring as a 3D CT image segmentation task, processing 3D volumes (H \u00d7 W \u00d7 T) to produce segmentation maps with identical spatial dimensions. Our architecture, inspired by ConvNeXt [12] and illustrated in Figure 2, adopts a U-Net [14] style CNN with stages of ResBlocks \u2013 each comprising a 3D convolution, group normalization [17], and ReLU activation. Stages include downsampling and upsampling layers, with ResBlock counts of 1,1,3,1 and 1,1,1, respectively, and channel widths doubling after each downsampling and halving upon upsampling, starting from 16 channels. For training we minimize a softmax cross-entropy loss utilizing the AdamW optimizer [8,13], a batch size of 8, and a 1 \u00d7 10-3 initial learning rate, with a polynomial learning rate schedule [15], weight decay, and mixed-precision training. Augmentation techniques include random rotations (\u00b15\u00b0), rescaling (\u00b120%) and gamma correction adjustments."}, {"title": "2.2 Methodology for Estimating Epistemic Uncertainty", "content": "We integrate a deep ensemble model [9] with Monte Carlo (MC) dropout [3], capitalizing on the strengths of both to augment uncertainty estimation within deep convolutional networks. This increases the sample size for uncertainty estimation, which is statistically advantageous offering a more robust measure. The selection of these methods is motivated by several key factors: 1) They specifically model epistemic uncertainty, aligning with our objective of performing OOD detection [7]; 2) Their theoretical foundations are solid and have been"}, {"title": "2.3 Statistical Method for OOD Detection", "content": "For statistical threshold estimation and OOD detection we utilize the Mahalanobis distance [11], traditionally applied to network feature distributions for OOD detection, which often necessitates network architecture modifications, such as flattening the final encoder layer [4] or averaging feature maps [2]. These adaptations can lead to potential feature collapse [10]. Contrary to these approaches, we directly apply the Mahalanobis distance to uncertainty scores derived from class-conditional distributions, offering a novel method that circumvents the need for architectural changes and avoids the risk of feature collapse.\nAs outlined in Section 2.2:Deep Ensemble Configuration, our training set is partitioned so each sample is used by only half of the base learners. This partitioning allows for the computation of conservative uncertainty scores $u_i$ using the learners for which the sample was not in the training set. We approximate a class-conditional uncertainty distribution for the in-distribution (ID) training population by estimating $M$ class-conditional Gaussian distributions $N(\\mu_m, \\Sigma), m \\in [1, M]$ over uncertainty scores $u_i$. Here, $\\mu_m = \\frac{1}{\\abs{I_m}} \\sum_{i=m}^{i=M} u_i$ represents the class-wise means, and $\\Sigma = \\frac{1}{\\abs{I_m} - 1} \\sum_{i=m}^{i=M} (u_i - \\mu_m)^T (u_i - \\mu_m)$ is the covariance matrix, capturing shared uncertainties across classes. For each test case with class-wise uncertainty scores $z_i$ the Mahalanobis distance is now given as $D_M(z_i, N(\\mu_m, \\Sigma)) = \\sum_{i=1}^{i=M} (z - \\mu_m)^T\\Sigma^{-1}(z_i - \\mu_m)$. An additional advantage is that the Mahalanobis distance follows a $x^2$ distribution [1], with degrees of freedom equal to the number of features (foreground classes in this case), allowing for the computation of a critical value for OOD detection at a specific significance level without necessitating OOD or ID test samples."}, {"title": "3 Experimental Evaluation", "content": "In this section, we assess the effectiveness of our Bayesian epistemic uncertainty model in discriminating between ID and OOD cases in the OAR contouring workflow through qualitative analysis and quantitative assessment using the statistical methods discussed in Section 2.3."}, {"title": "3.1 Qualitative Analysis", "content": "Figure 3 showcases a representative case from each OOD dataset, illustrating confidence predictions, model uncertainty responses, and post-processed uncertainty for each scenario. Confidence levels are derived from the original deterministic contouring model, not the mean of the Bayesian model, and are visualized as soft-confidences using the alpha channel of the image overlay. A fully opaque pixel in the color of the corresponding class indicates a strong positive prediction by the deterministic model. Conversely, visibility of the background image signifies low confidence in any class, implying a high certainty of background rather than organ presence.\nFemur Implants Figure 3(a) shows a case with an implant in the left femur head, where an analysis of confidence levels reveals high-confidence false positives and false negatives in the lower region of the left femur head. No low-confidence predictions are observed in this area, indicating that the model generates high-confidence predictions for this OOD case. Notably, our Bayesian model detects a significant uncertainty response in the lower part of the left femur head, accurately identifying the area where predictions are unreliable."}, {"title": "3.2 Quantitative Analysis", "content": "We use the class-conditional uncertainty distribution based in the training data as discussed in Section 2.3 and estimate the Mahalanobis distance from this distribution for each sample in the ID (training, control) and OOD (implant, brachy) datasets. Using the train distribution we estimate an OOD threshold of 10.64 utilizing the $x^2$ table [1] for an application-specific critical value of 0.9 and degrees of freedom equal to 6 (number of foreground classes). Figure 4(a) illustrates the threshold selection. Note that only the training set is required for the threshold estimation, no OOD or control samples are utilized.\nFigure 4(b) illustrates the OOD-detection efficacy of our threshold on the ID and OOD test sets. The threshold accurately classifies 95.0% of control cases as ID (Specificity), and identifies 92.3% of Implant cases and 83.3% of Brachy cases as OOD (Sensitivity). The choice of a critical value, and thus the Sensitivity-Specificity trade-off, may vary based on specific application needs. For a comprehensive evaluation, Figure 4(c) showcases our method's threshold-independent performance through an ROC curve, derived from class-conditional Mahalanobis distances across the test dataset. With ID (control) class = 0 and OOD (brachy, implant) class = 1, we achieve an AUC-ROC of 0.95. This demonstrates that our distance-based metric, derived from the underlying multivariate uncertainty distribution, effectively discriminates OOD samples with statistical significance."}, {"title": "4 Conclusion & Future Work", "content": "In this study, we have explored the integration of epistemic uncertainty estimation within the radiotherapy contouring workflow, particularly focusing on enhancing the detection of OOD scenarios. Our investigation was motivated by the critical need to improve the safety and reliability of OAR models in radiotherapy, where the contouring precision for target structures and OAR is paramount for effective treatment planning and the safety of the patient. We were able to demonstrate the effectiveness and utility of epistemic uncertainty estimation in identifying instances where model predictions are unreliable. Our approach achieved an AUC-ROC of 0.95 for OOD detection, with a specificity of 0.95 and a sensitivity of 0.92 for implant cases. These findings highlight the potential of uncertainty estimation as an early warning system for cases requiring additional attention during requiring expert review. By doing so we also address the previously identified gaps in the current research landscape [18], namely the lack of ground truth data and tasks as well as the need for empirical evaluations.\nLooking forward, our study lays the groundwork for further research into the integration of uncertainty analysis into the radiotherapy workflow. The promising results from our initial feasibility study suggest that epistemic uncertainty estimation can significantly enhance the accuracy, safety, and clinical applicability of deep learning models in radiotherapy planning. Future work will focus on expanding the range of OOD scenarios explored, refining our methodology, and conducting empirical comparisons. Additionally, we encourage the academic community to develop benchmarks and similar tasks based on public data, which can be used for quantitative comparisons and empirical evaluations of various methods. There remains a significant gap in the comparative analysis of uncertainty estimation methods, as highlighted in [18]. Our work provides meaningful, clinically relevant tasks that the community can use to quantitatively evaluate methods. We hope that our work and results highlight the importance of further research in the space of uncertainty estimation for medical imaging, driving advancements in this critical area."}]}