{"title": "OVERCOMING UNCERTAIN INCOMPLETENESS FOR ROBUST MULTIMODAL SEQUENTIAL DIAGNOSIS PREDICTION VIA KNOWLEDGE DISTILLATION AND RANDOM DATA ERASING", "authors": ["Heejoon Koo"], "abstract": "In this paper, we present NECHO v2, a novel framework designed to enhance the predictive accuracy of multimodal sequential patient diagnoses under uncertain missing visit sequences, a common challenge in clinical settings. Firstly, we modify NECHO to handle uncertain modality representation dominance under the imperfect data. Next, we develop a systematic knowledge distillation by employing the modified NECHO as both teacher and student. It encompasses a modality-wise contrastive and hierarchical distillation, transformer representation random distillation, along with other distillations to align representations tightly and effectively. We also utilise random erasing on individual data points within sequences during both training and distillation of teacher to lightly simulate scenario with missing visit information to foster effective knowledge transfer. As a result, NECHO v2 verifies itself by showing superiority in multimodal sequential diagnosis prediction on both balanced and imbalanced incomplete settings on multimodal healthcare data.", "sections": [{"title": "1. INTRODUCTION", "content": "Predicting future patient diagnoses, a.k.a. sequential diagnosis prediction (SDP), based upon clinical records is crucial for enhancing healthcare decision-making [1-5]. Recent advances in multimodal learning, which integrate diverse modalities such as clinical notes and demographics, have significantly improved SDP accuracy [4, 5]. Nevertheless, most previous studies assume the availability of all data, which is often impractical due to privacy, equipment failures, and other uncertain factors [5]. Encountering such situation presents a significant challenge to healthcare analytics.\nMissing data, a common issue in reality, exacerbates model performance. Basic approaches, such as imputation by mean or excluding incomplete data instances, often fail to preserve true data distribution and result in information loss [6]. Advanced statistical techniques, including Multiple Imputation by Chained Equations (MICE) [7], show better efficacy, but their application in complex multimodal scenarios still remains challenging. Therefore, deep learning approaches such as reconstruction [8-10], which impute missing features, and knowledge distillation (KD) [11], which transfers teacher's knowledge on complete data to a student learning with incomplete data [12, 13], have gained popularity.\nKD has proven effective in model compression [14-16] and other applications, such as tackling missing data. Wang et al. [12] modality-specialised teachers transfer knowledge to a multimodal student. MissModal [13] employs geometric multimodal contrastive loss [17] and distribution alignment loss on combination of modality representations. However, no existing methodologies have taken into account the fixed dominance of specific modalities under complete data and the fluctuating modalities importance under incomplete data, leading to sub-optimal performance. Furthermore, there is a research gap in systematically leveraging KD to alleviate the representation discrepancy in teacher-student in missing data contexts.\nMeanwhile, data augmentation (DA) is widely used to enhance model performance [18]. Some studies have explored its impact on KD [19]. However, there is still lack of research on effectively applying DA in the presence of incomplete data.\nTo this end, we propose NECHO v2, not only overcoming the challenges in multimodal SDP with imperfection for the first time but also tackling the aforementioned limitations. First, we modify the original NECHO to manage uncertain modality representation dominance in the presence of missing data. Second, we establish a systematic KD pipeline, including modality-wise contrastive and hierarchical distillation, followed by transformer random representation distillation, penultimate layer distillation, and dual-level logit distillation, to fully transfer teacher's semantic knowledge from perfect data. We also employ a random data point erasing on visit sequences to simulate missing visit to reduce the data distributional gap and facilitate representation transfer. By doing so, NECHO v2 demonstrates robust superiority under both balanced and imbalanced imperfect data scenarios on MIMIC-III data [20]."}, {"title": "2. METHODOLOGIES", "content": ""}, {"title": "2.1. Problem Statement", "content": "Multimodal EHR Data A clinical record is a time-ordered sequence of visits V1, ..., VT, where T represents the total number of visits for any given patient P. Each visit Vt at the t-th admission consists of three components: Ht, demographics; Nt, a clinical note; and Dt, a set of diagnosis codes. Specifically, a medical ontology G is utilised to structure diagnosis codes into three hierarchical levels: unique medical codes, category codes, and disease-typing codes, from leaf to node. The input and output is unique medical codes and category codes, respectively.\nMissing Visit Sequences To simulate real-world missingness, we randomly discard aforementioned components in each visit sequence, creating an m-modal dataset with 2m missing patterns. Missing probabilities are balanced or imbalanced across modalities and kept the same during both training and inference phases.\nSequential Diagnosis Prediction Given a patient's multimodal clinical records for the past T visits under incompleteness, the objective is to predict diagnoses codes that will appear in the (T + 1)-th visit."}, {"title": "2.2. NECHO v2", "content": "In this section, we present the KD-based NECHO v2 framework. For a comprehensive flow detailing the process from input to prediction, refer to the original NECHO [5]."}, {"title": "2.2.1. Modification of NECHO", "content": "NECHO [5] achieves state-of-the-art performance in SDP by integrating demographics, clinical notes, and medical codes using a medical code-centric framework with bi-modal contrastive loss and a centric multimodal adaptation gate (CMAG) for alignment and fusion. Each modality-specific encoder predicts at the parental level of target medical codes (disease-typing codes) to enhance training.\nHowever, it confronts two issues: 1) under-performance in incomplete data despite outstanding performance in complete data and 2) adoption of a pre-trained BioWord2Vec [21], limiting performance on non-MIMIC-III datasets [20]. To mitigate these concerns, we modify by: 1) replacing the demo \u2192 code cross-modal transformer (CMT) with a demo \u2192 note CMT to relieve bias from medical codes and 2) utilisation of clinical TinyBERT [22] as a text encoder to potentially facilitate adaptability to other datasets."}, {"title": "2.2.2. Systematic Knowledge Distillation Framework", "content": "Teacher-Student Network Configuration In our KD pipeline, we adopt the modified NECHO as both teacher and student. In addition, the teacher leverages CMAG [5] to consider modality representation dominance when learning with the full data, while the student adopts MAG [23] that adjusts significant representations flexibly, considering fluctuating dominant feature under missing conditions. We avoid using the original NECHO as the teacher to reduce architectural heterogeneity, thereby fostering the KD [24]. We adopt offline distillation [11] where the teacher is trained, then frozen during distillation. Additionally, the teacher is absent during student's inference.\nModality-wise Contrastive and Hierarchical Distillation We begin our KD process by distilling modality-wise representations from the teacher to the student, using contrastive learning [25] and L2 distance measures (Mean Squared Error, MSE). First, contrastive learning identifies and amplifies both similarities and discrepancies between the representations [17, 25]. When utilised in KD, it encourages the student's representations to be similar to those of the teacher's for corresponding samples, while also distinguishing between different samples. MSE further tightens this alignment, reducing deviations and promoting consistency.\nUnlike previous method [13], we explicitly distill modality-specific semantic distributions. We utilise a contrastive loss [25] with symmetrical losses to promote stable and effective distillation in a modality-wise fashion. Let teacher and student representations with the same data as positive sample pairs $(H_{m_t}, \\hat{G}_{m_t})$, with $m \\in (H, N, D)$, and teacher and student are H and G, respectively. Then, modality-wise contrastive distillation $L_{MWCD}$ is:\n$L_{CH\\rightarrow G,m}^{MWCD} = -log \\frac{exp((H_{m_t}, \\hat{G}_{m_t})/\\tau)}{\\sum_{k=1}^{N} exp((H_{m_t}, \\hat{G}_{m_k})/\\tau)}$ (1)\n$L_{LWC_{H,m}}^{MWCD} = -log \\frac{exp((\\hat{G}_{m_t}, H_{m_t})/\\tau)}{\\sum_{k=1}^{N} exp((\\hat{G}_{m_t}, H_{m_k})/\\tau)}$ (2)\n$L_{MWCD} = \\sum_{m \\in{H,N,D}} {\\alpha L_{CH\\rightarrow G,m}^{MWCD} + (1 - \\alpha)L_{LWC_{H,m}}^{MWCD}}$ (3)\nwhere $(.,.)$ denotes cosine similarity and the temperature $\\tau \\in R^+$ is a parameter that controls the distribution concentration and the gradient of the Softmax function. Next, with $H_{m_t}$ and $\\hat{G}_{m_t}$, modality-specific teacher and student feature at t-th visit, modality-wise hierarchical distillation $L_{MWHD}$ Via MSE $||\\cdot||_2$ is:\n$L_{MWHD} = \\sum_{m \\in{H,N,D}} ||H_m - \\hat{G}_m||_2$. (4)\nAccordingly, the modality-wise contrastive and hierarchical distillation $L_{MWD}$ is formulated as the sum of the above two loss terms:\n$L_{MWD} = L_{MWCD} + L_{MWHD}$. (5)"}, {"title": "Transformer Representation Random Distillation", "content": "Previous research have explored intermediate layer distillation (ILD) between transformer layers for compression [15, 22, 26]. Meanwhile, NECHO has cross-modal (CMT) and self-attention transformer encoders (SAT) to align and merge inter- and intra-modality representations. Considering its multiple transformers, layer-wise distillation is computationally expensive. Hence, we distill teacher's randomly selected final transformer features, reducing computational burden and avoiding overfitting.\nDenote representations from two CMTs as $R^{M,H\\rightarrow N}$ and $R^{M,D\\rightarrow N}$, and those from three SATs are $S^{M,H\\rightarrow N}$, $S^{M,D\\rightarrow N}$ and $S^{M,D}$, where M is either teacher or student. Then, for the randomly selected transformer representations, the proposed distillation (LTR2D) using MSE for both CMT (LCMTD) and SAT (LSATD) are:\n$L^{LTR2D} = L^{CMTD} + L^{SATD}$, (6)\nwhere $L^{CMTD} = \\sum_{m \\in{H,D}} ||R_{teacher, m\\rightarrow N} - R_{student, m\\rightarrow N}||_2$, (7)\n$L^{SATD} = \\sum_{m \\in{H,D}} ||S_{teacher, m\\rightarrow N} - S_{student,m\\rightarrow N}||_2+ ||S_{teacher, D} - S_{student, D}||_2$. (8)"}, {"title": "MAG Distillation", "content": "To ensure the student model further mimics the teacher, we introduce MAG (penultimate layer) distillation. Its importance is also highlighted due to its rich, informative features [27]. MAG representations from teacher and student be $MAG_{teacher}$ and $MAG_{student}$, respectively. Then, the regarding loss is:\n$L_{MAGD} = ||MAG_{teacher} \u2013 MAG_{student}||_2$. (9)"}, {"title": "Dual Logit Distillation", "content": "NECHO predicts target codes, as well as parental-level codes (disease typing codes) at the modality-specific encoders. Accordingly, we transfer both teacher predictions to the corresponding student predictions. Previous work [16] argues that MSE outperforms Kullback-Leibler (KL) divergence for logit distillation, without requiring hyper-parameter tuning. Hence, MSE is applied to both distillations.\nThe final prediction and modality-specific parental-level prediction are $\\hat{y}_{t+1}$ and $\\hat{O}_{t+1}^{M,m}$. Then, the dual logit distillation loss $L_{DualLD}$ is written as:\n$L_{DualLD} = L_{LLD} + L_{hrcyLD}$, (10)\nwhere $L_{LLD} = ||\\hat{y}_{teacher} - \\hat{y}_{student}||_2$, (11)\n$L_{hrcyLD} = \\sum_{m \\in{H,N,D}} ||\\hat{O}_{teacher, m} - \\hat{O}_{student, m}||_2$ (12)\nwhere $L_{LLD}$ and $L_{hrcyLD}$ are final logit distillation and modality-specific hierarchical logit distillation, respectively."}, {"title": "Model Optimisation", "content": "The student model is also optimised using a pair of task loss $L_{DualCE}$ (CE stands for Cross Entropy), which consists of two components: one for the target level $L_{CE}$ and another for the parental level $L_{hrcyCE}$, in accordance with NECHO.\nBy integrating the task losses with the above distillation losses with the corresponding constant A, the full optimisation objective is formulated as:\n$L_{total} = A_{MWD}L_{MWD} + A_{TR2D}L_{TR2D}+ A_{MAGD}L_{MAGD} + A_{DualLD}L_{DualLD} + A_{DualCE}L_{DualCE}$. (13)"}, {"title": "2.2.3. Single Data Point Erasing Guided Curriculum Learning", "content": "It is desirable to acquire a teacher that transfers better representations to a student learning with uncertain missing data. Prior studies show that large discrepancies in data distribution between teacher and student can hinder KD [19]. Therefore, we propose random single-point data erasing [28] to both training and distillation of the teacher, a minimalistic approach to mimic missing sequences and alleviate the data distribution gap, thereby further improving KD and the performance of resultant student. Note that, DA is not applied to the student during distillation.\nFirstly, the teacher is trained using data erasing guided curriculum learning [29], starting with easier samples and gradually progressing to more difficult ones. Each modality is assigned a missing probability of 0.0 or 0.1 with equal probability until specific epoch e1, after which the probability of 0.2 is added. Next, during the distillation, the unified teacher trained in the previous manner, complete data representations are transferred until epoch e2, after which training continues with either no missing data or a 0.1 missing ratio."}, {"title": "3. EXPERIMENTS", "content": ""}, {"title": "3.1. Experimental Setup", "content": "Dataset and Pre-processing We evaluate on MIMIC-III data [20], following the pre-processing steps from previous works [2, 5] but with a more rigorous patient selection criteria by removing records 1) with a length of stay of zero or negative and 2) who died within 30 days post-discharge. We also leverage only discharge summaries for clinical notes. Detailed statistics upon pre-processing are in Table 1.\nTo handle missing data, we assign a value beyond the existing range for erased or missing points in demographics and codes. For instance, if the total number of medical codes is 3882, the missing value is assigned as 3883. We also replace missing tokens in notes with the UNK token."}, {"title": "Training and Evaluation Details", "content": "We mostly follow the implementation details from previous study [5]. We set the hidden dimension to 128 and the dropout rate to 0.1. The transformer encoders have 4 heads and 3 layers. We set the temperature T to 0.1 and the alpha a to 0.25 for the contrastive distillation. The coefficients for loss terms are set to 1, except for the $L_{hrcyCE}$ which is 0.1.\nOptimisation is performed via AdamW [30], with a constant learning rate of 2e-5 for the parameters of clinical TinyBERT and 1e-4 for all other parameters. We train with a batch size of 4 for up to 100 epochs, stopping early if no improvement in validation set for 5 consecutive epochs. For curriculum learning, e1 and e2 are set to 5 and 10, respectively.\nNECHO v2 is evaluated against joint learning methods (MulT [23] and three NECHO variations: original, teacher, and student [5]) and KD methods (UnimodalKD [12] and MissModal [13]). KD methods use the same teacher and student for fair comparison. Evaluation uses top-k accuracy with k values of 10 and 20, following [1, 3, 5]. Experiments are implemented using PyTorch [31] and trained on a single NVIDIA RTX A6000."}, {"title": "3.2. Experimental Results", "content": ""}, {"title": "3.2.1. Main Results", "content": "As shown in Table 2, NECHO v2 demonstrates remarkable performance across various missing scenarios on MIMIC-III dataset. Specifically, it outperforms the original NECHO by 1.52%, its teacher by 3.32%, its student by 1.45%, and UnimodalKD by 1.83% in top-10 accuracy at the balanced missingness of 0.5. Similar trends are observed in other settings. On the other hand, NECHO performs well when medical codes are mostly present (0.2) but predicts poorly in scenarios where codes are highly missing (0.8). This highlights the robust and superior performance of NECHO v2.\nThis performance gain is attributed to: 1) modifying NECHO for both teacher and student to address varying modality significance, 2) implementing systematic KD, including modality-wise contrastive and hierarchical distillation and transformer representation random distillation and others, to comprehensively mimic teacher at various representation levels, and 3) simulating random visit information by single point data erasing to minimise data distribution gaps and improve KD. These enables student to imitate the teacher in varied incompleteness, ensuring robust performance effectively."}, {"title": "3.2.2. Ablation Studies", "content": ""}, {"title": "3.2.3. Comparative Studies", "content": ""}, {"title": "4. CONCLUSION", "content": "We tackle uncertain missing sequences for robust multimodal SDP with NECHO v2. Firstly, we modify NECHO to dynamically adjust dominant representations under varying missingness. Next, we design a systematic KD pipeline, adopting the modified NECHO and leveraging multiple distillations including modality-wise contrastive and hierarchical distillation, to comprehensively learn teacher representations from complete data. We also randomly erase single data points per visit to reduce the data distribution discrepancy and enhance KD process. Extensive experiments show the efficacy of NECHO v2 over the existing methodologies. The code will be released upon publication."}]}