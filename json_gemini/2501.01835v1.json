{"title": "ASKCOS: an open source software suite for synthesis planning", "authors": ["Zhengkai Tu", "Sourabh J. Choure", "Mun Hong Fong", "Jihye Roh", "Itai Levin", "Kevin Yu", "Joonyoung F. Joung", "Nathan Morgan", "Shih-Cheng Li", "Xiaoqi Sun", "Huiqian Lin", "Mark Murnin", "Jordan P. Liles", "Thomas J. Struble", "Michael E. Fortunato", "Mengjie Liu", "William H. Green", "Klavs F. Jensen", "Connor W. Coley"], "abstract": "The advancement of machine learning and the availability of large-scale reaction datasets have accelerated the development of data-driven models for computer-aided synthesis planning (CASP) in the past decade. Here, we detail the newest version of ASKCOS, an open source software suite for synthesis planning that makes available several research advances in a freely available, practical tool. Four one-step retrosynthesis models form the basis of both interactive planning and automatic planning modes. Retrosynthetic planning is complemented by other modules for feasibility assessment and pathway evaluation, including reaction condition recommendation, reaction outcome prediction, and auxiliary capabilities such as solubility prediction and quantum mechanical descriptor prediction. ASKCOS has assisted hundreds of medicinal, synthetic, and process chemists in their day-to-day tasks, complementing expert decision making. It is our belief that CASP tools like ASKCOS are an important part of modern chemistry research, and that they offer ever-increasing utility and accessibility.", "sections": [{"title": "1 Introduction", "content": "Synthesis planning describes a broad category of approaches for selecting experimental pathways and procedures during target-oriented synthesis. While planning a synthesis campaign may require significant chemistry expertise and benefits from the years of training that many experienced chemists undergo, the well-defined yet combinatorially complex nature of synthesis planning renders this task particularly amenable to algorithmic reasoning. Formally, computer-aided synthesis planning (CASP) integrates a variety of computational methodologies that assist chemists with different tasks in this process, including identifying viable synthetic routes through retrosynthetic analysis, recommending reaction conditions, and predicting reaction outcomes.\nSince the 1960s, chemists have sought to encode the rules of organic synthesis into automated computational systems [1, 2]. Early CASP tools generally relied on expert-encoded reaction rules and heuristics for making suggestions. In particular, for one-step retrosynthetic analysis [3], expert systems such as LHASA [4] and SECS [5] made use of reaction templates that encode chemical reaction rules based on molecular pattern matching; AIPHOS [6] and WODCA [7] were among the first to combine retrosynthesis, reaction condition suggestion, and product prediction into an integrated system. More recent advancements include tools like Chematica (now Synthia) [8], which leverages modern computational capabilities alongside expert-curated rules and heuristics to propose transformations, generating synthetic pathways for complex molecules that have been successfully implemented in the laboratory [9, 10].\nWith the development of machine learning and the availability of reaction datasets containing millions of entries, there has been renewed interest in CASP with data-driven approaches [11, 12]. Many data-driven models for one-step retrosynthesis have been developed with formulations based on reaction template prediction [13, 14] or retrieval [15, 16], machine translation [17-19], graph edit prediction [20, 21], as well"}, {"title": "2 Results", "content": ""}, {"title": "2.1 One-step retrosynthetic expansion", "content": "The one-step retrosynthetic expansion engine lies at the core of retrosynthetic analysis in ASKCOS. Given a target molecule, a list of candidate precursors is first predicted with user-specified one-step model(s). A fast plausibility filter based on the in-scope filter described by Segler et al. [25] removes unlikely precursors, and the remaining list is reranked based on buyability and complexity (e.g., by heavy atom count, ring count, or by SCScore [61]). Thereafter, the candidates undergo a series of optional post-processing steps. Because several predictions from the list of candidate precursors may correspond to highly similar strategies (e.g., differing only by leaving groups), precursors can be clustered based on their structures or reaction classes to return a diverse set of suggestions to the user; atom mapping and template extraction can"}, {"title": "2.2 Interactive planning with the template relevance model", "content": "The use of reaction templates to suggest retrosynthetic disconnections has remained a popular choice since its origination in the early CASP tools of the 1960s [1, 4, 5]. Template-based models within ASKCOS follow the neural-symbolic approach of Segler and Waller [62] wherein a policy network is trained to rank which templates appear most strategic and chemically plausible given the target. ASKCOS contains a variety of such models trained to use template sets derived from reactions in Pistachio [63], CAS Content [64], USPTO [65], and Reaxys [66] using RDChiral [67] (see Section Methods). Specialized models trained on enzymatic reaction data in BKMS [68] and a specialized \"ring-breaker\" Pistachio model are also available and described in Levin et al. [50] and Thakkar et al. [69], respectively. Because template-based models propose candidate precursors using templates extracted from published reactions, model suggestions can be traced back to reaction precedents and are therefore somewhat explainable.\nFigure 2 shows a sample planning step with the original template-based model trained on Reaxys in 2016 in the Interactive Path Planner (IPP). The target is specified by a simplified molecular input line entry system (SMILES) string [70] but can also be defined by drawing its structure with Ketcher or by common name using the PubChem API [71]. One-step expansion can then be triggered by pressing the green button. The top few (5 by default) suggestions will be added to the canvas as the child nodes of the target, with circles representing the reaction nodes and rectangles representing the molecule nodes. Clicking on the nodes display more context-specific details and provide access to additional features, such as banning the reaction/molecule (thereby preventing them from appearing in future searches) or deleting/collapsing all child nodes of that node. Reaction nodes report the template scores (i.e., the template probabilities returned by the model), plausibility (evaluated by the fast binary filter as mentioned in Section One-step retrosynthetic expansion), and links to template details (which include links to the reaction precedents that the templates were extracted from).\nEach reaction can be analyzed further with the EVALUATE REACTION button, such as recommending conditions for the reaction or predicting reaction outcomes (see Sections Reaction condition recommendation and Reaction outcome prediction for details). Molecule nodes report their price and are additionally color-coded to reflect whether they are buyable or appear in known reactions stored in a reference database, as explained in the bottom-left IPP legend. Molecule node-specific features are also available, including expanding the nodes, adding and saving notes, and viewing recommended templates for the molecule. Once molecule nodes are expanded, their node details additionally list all predicted precursors. These precursors can then be sorted according to different criteria (e.g., heuristic scores, synthetic complexity, number of precedents), grouped into clusters (if already clustered as mentioned in Section One-step retrosynthetic expansion), or filtered by reaction center by selecting the green-circled atom in the rendering of the molecule. Specific precursors can be added or removed from the canvas with the green + button or the red - button, respectively.\nAfter this first expansion of the target molecule, it is up to the user to decide which molecule node(s) to expand further, hence the interactive nature of this view. For instance, users can choose a non-buyable molecule to expand next and continue"}, {"title": "2.3 Interactive planning with multiple models, including template-free models", "content": "There is an abundance of one-step retrosynthetic models reported in the past several years that forgo the use of templates and instead learn to predict reactant structures from product structures in a more flexible end-to-end manner. ASKCOS currently contains four categories of one-step strategies, including Transformer [18, 34, 72], Graph2SMILES [17], Retrosim [15], and the aforementioned template relevance strategy [62]. Transformer and Graph2SMILES use template-free approaches and model retrosynthesis as SMILES-to-SMILES and graph-to-SMILES translation tasks, respectively. Retrosim offers a retrieval-based, learning-free approach in which reactions are suggested based on analogy to most-similar precedents. Each model may exhibit distinct strengths and failure modes not reflected in their quantitative performance on standard benchmark tasks . For this reason, ASKCOS supports the consolidation of recommendations from multiple strategies; when multiple models recommend the same precursors, this can be interpreted as a sign of confidence in that recommendation.\nM ixing and matching different one-step strategies is performed within the STRATEGY SETTINGS menu. Different strategies are queried in sequence and combined results are de-duplicated before appearing on the page. Each strategy has its own settings, such as the maximum number of templates to be applied for the template relevance model and the training set to use. When viewing node details, suggested reactions from template-free and Retrosim models contain different metadata (e.g., Retrosim results display the reaction precedents if that information is included on deployment). When multiple models predict the same precursor, the metadata from all models are merged to show all template and/or reaction precedent information where applicable. Most of these strategies can be retrained using new reaction databases, e.g., proprietary collections from an internal electronic lab notebook system, which may provide better coverage of different reaction and substrate types."}, {"title": "2.4 Automatic multi-step planning with the Tree Builder", "content": "In addition to interactive planning where users guide the selection of which molecule nodes to expand, automatic planning can be more convenient, particularly when there are many target molecules of interest. Retrosynthetic searches can be run for thousands of targets through asynchronous requests, albeit at the expense of losing explicit control on the direction of expansion. Formally, automatic multi-step planning has been formulated as tree search or graph search problems. In each iteration of the search, a molecule is selected for one-step retrosynthetic expansion. New hypothetical reactions and their corresponding reactants are added to the search tree. This process is repeated until some termination criterion is reached, for example, until a synthetic pathway is"}, {"title": "2.5 Reaction condition recommendation", "content": "The prediction of reaction conditions, including the identity of agents (catalysts, reagents, solvents) and operating conditions such as temperature and equivalence ratios, is an often overlooked aspect of synthesis planning. Condition recommendation is essential for any suggested reactions to be experimentally validated, and reaction outcomes are strongly influenced by reaction conditions. Reaction type specific data-driven models have been built, for example, to predict classes of solvent and catalyst for Michael additions [90], ligands for Pd-catalyzed C-N coupling [91], and reaction contexts including temperature and pressure for four families of substrate-specific cross-coupling reactions [30, 31]. Global models which are not specific to reaction families have also been developed using a variety of approaches, including multi-class classifier chains [29] and its variant using a Transformer encoder with SMILES inputs [92], retrieval-augmented prediction using text descriptions of similar reactions [32], and a two-stage model with candidate generation and ranking as distinct steps [33].\nASKCOS includes a data-driven condition recommendation model based on Gao et al. [29] as well as a second version being developed in ongoing work which additionally predicts equivalence ratios. This model formulates condition recommendation in terms of four sub-problems (1) predicting agent identities as multi-label classification; (2) predicting temperature as binned classification; (3) predicting reactant equivalence"}, {"title": "2.6 Reaction outcome prediction", "content": "Another component of synthesis planning beyond retrosynthesis is the prediction of reaction outcome(s). In our workflows, these predictions mostly serve to identify chemically infeasible or unfavorable reactions, which the user can choose to prune from the synthesis tree in an interactive setting. Many data-driven approaches simplify this task as predicting the identity of the major product, making it equivalent to a molecule-to-molecule transformation. Similar to one-step retrosynthesis, some studies have formulated it as forward template prediction [93, 94], whereas later developments have been dominated by graph-edit based [20, 35], electron-flow based [36, 37], and translation-based [17-19, 34] template-free methods. Outcome prediction can answer more fine-grained questions about reaction outcomes, such as the site selectivity of aromatic C-H functionalization reactions [95] or other situations where multiple regioisomers appear possible based on reaction templates [96]. Another application of outcome prediction is the analysis of potential impurities. When impurities are defined as the minor products of the main reactions or the products of side reactions, they can be predicted by considering several predicted reaction outcomes with lower probabilities or by predicting the outcomes of new reactant sets containing a product of the original reactions (i.e., anticipating potential over-reaction).\nThe major product prediction page in ASKCOS is shown in the bottom of Figure 4. In this specific example, the top outcome is carbamate formation arising from nucleophilic attack of the alcohol into the isocyanate (followed by hydrolysis [97]) with a probability of 0.9726. Non-hydrolyzed product and nucleophilic attack by a tetrazole nitrogen are predicted to be the second and third most likely products, but with lower probabilities of 0.0273 and 0.0001, respectively. Past studies have shown these probabilities to correlate with accuracy on average but may not be a robust measure of confidence for a particular result [34, 35, 98]. Modules for impurity prediction, regioselectivity, and C-H site-selectivity are accessible via other tabs on the same page. The impurity prediction module relies on the major product predictor and considers minor products, over-reaction, dimerization, solvent adducts, and subsets of reactants; the details of regio- and site-selectivity predictions are reported in Guan et al. [96] and Struble et al. [95], respectively."}, {"title": "2.7 Pathway scoring and ranking", "content": "When many putative synthetic pathways are found for a target molecule, a new challenge arises: to identify the routes that best satisfy a chemist's goals, not merely to identify any route. It is impractical to triage routes manually when the number of suggestions becomes too large. Strategically similar pathways can first be clustered or grouped based on trained pathway embeddings [99] or the reactions types they involve (e.g., using NameRxn [100] categories or approximations thereof). Pathway-level evaluations then help prioritize promising synthetic routes, though there are many criteria by which a synthetic pathway could be judged [101]. Simple, readily-calculable metrics include step count, longest linear sequence, atom economy, cost of starting materials, or diversifiability based on an estimate of the size of an analog space achieved through building block enumeration [102]. More complex metrics that may be derived from other predictive models include estimates of human likeness [99], overall perceived likelihood of feasibility, pathway greenness based on solvent usage [81],"}, {"title": "2.8 Utilities and supplementary predictive models", "content": "Beyond these \"core\" synthesis planning capabilities, ASKCOS contains additional complementary tools. These include basic drawing functionality (Drawing) and buyable building block search by SMILES or SMARTS (Buyable Look-up). The latter makes use of a predefined commercial catalog that is easily customizable when ASKCOS is deployed. The utilities page also offers two additional machine learning models for solvation prediction (Solubility Prediction and Solvent Screening) [104] and the prediction of atom- and bond-level descriptors calculated by DFT (QM Descriptor) [96, 105]. Solubility prediction is part of a long-term goal of improving the relevance of CASP for process chemistry [106] as it helps guide the selection of solvents for reactions, liquid-liquid extractions, or crystallizations. ML-estimated QM descriptors can be used as features by other predictive models [107] or standalone, e.g., for human assessment of selectivity.\nThe pages for solubility prediction, solvent screening, and QM feature prediction are organized under the Utilities tab, each with a standard layout as in Figure 4. Solubility prediction requires a solute, solvent, and temperature as inputs; solvent screening expects a single solute, a list of solvents, and a list of temperatures; QM prediction needs the SMILES of the target molecule."}, {"title": "3 Discussion", "content": "As a broad, extensible software suite for synthesis planning, ASKCOS has been adopted by various organizations within and beyond the context of the MLPDS consortium. While not all usage of ASKCOS is publicly described, several use cases where ASKCOS has aided chemists' workflows have been discussed in the 2020 review by Struble et al. [49]. Particularly well-received features include the interactive planning"}, {"title": "4 Methods", "content": ""}, {"title": "4.1 Overview", "content": "The majority of the usage of ASKCOS from end-users' perspectives has been covered in Section Results. In the rest of Section Methods, we will elaborate on the details of modeling and computation, which were only briefly discussed in Section Results. Considerations for software development and for the 2023 refactor are elaborated in Supplementary Section Technical details of software engineering. Other non-central but very useful features for more advanced users including model retraining and customization are described in Supplementary Section Advanced features."}, {"title": "4.2 Technical details of the template relevance model and MCTS tree search", "content": "Our implementations of the template relevance model and of MCTS tree search deviate from what is described in Segler et al. [25] with several modifications. Specifically, most of the trained template relevance models we provide use simple feedforward neural networks, which we found to have comparable performance to the original but more complex highway networks [118] on larger datasets (e.g., with hundreds of thousands of training reactions). We use RDKit for computing Morgan fingerprints of the input targets, and RDChiral [67] for reaction template extraction. The template classification model with feedforward networks is then implemented, trained, and evaluated using PyTorch [119].\nOur MCTS tree search differs significantly from Segler et al. [25] and we use a simplified formulation for Upper Confidence bound applied to Trees (UCT) [120]. In particular, we do not use a rollout phase. The UCT score for a given reaction node in the search tree is calculated as\n$a_r = Q_r + c * U_r$ (1)\n$U_r = \\sqrt{\\frac{lnN_r}{n_r}}$  (2)\nwhere the score ($a_r$) takes into consideration an exploitation term ($Q_r$) and an exploration term ($c*U_r$) with c being the weight for exploration. $Q_r$ can be interpreted as a heuristic score with $s_r$ being the reaction score from model output (e.g., the template probability for template relevance model), $v_r$ being the average buyability score of all children (1.0 for buyables and 0.0 for non-buyables), and $n_r$ having its typical definition of node visit counts. The $N_r$ in the exploration term is the visit counts of the parent chemical node. The tree search operates in a select-expand-update loop starting from the root node. The search network will keep expanding until the termination criteria is reached, for example, if reaching the time limit. A path enumeration phase identifies all synthesis pathways in the search tree. Optionally, the search can be configured to terminate once the first viable pathway is found."}, {"title": "4.3 Technical details of other modules", "content": "The implementations of other modules are summarized below.\n\u2022 Augmented Transformer [18] for retrosynthesis and forward prediction: we re-implement using PyTorch, the OpenNMT [121] package, and a regex tokenizer based on previous work by Schwaller [34, 122] to tokenize SMILES strings into input and output tokens.\n\u2022 Graph2SMILES [17] for outcome prediction and retrosynthesis: no deviation from the published version.\n\u2022 Retrosim [15] for one-step retrosynthesis: instead of extracting the templates on-the-fly after retrieving similar targets in the original implementation, we pre-extract all templates and store them in the database for later use, which speeds up inference at the expense of storage.\n\u2022 Retro* [28] for multi-step search: while remaining faithful to the original algorithm, the code structure of our implementation is heavily tailored towards that of the MCTS for consistency.\n\u2022 WLDN5 [35] for reaction outcome prediction: no deviation from the published version.\n\u2022 The reaction condition recommender [29]: no deviation from the published version for the V1 model. The V2 model is experimental and undergoing active development with publication underway.\n\u2022 The analog counting module from Levin et al. [102]: no deviation from the published version.\n\u2022 The regio-selectivity predictor from Guan et al. [96]: no deviation from the published version.\n\u2022 The site-selectivity predictor from Struble et al. [95]: no deviation from the published version.\n\u2022 The synthesis pathway scorer from Mo et al. [99]: no deviation from the published version.\n\u2022 The SCScorer from Coley et al. [61]: no deviation from the published version.\n\u2022 The solubility prediction module from Vermeire et al. [104]: no deviation from the published version.\n\u2022 The QM descriptor predictor from Li et al. [105]: no deviation from the published version."}]}