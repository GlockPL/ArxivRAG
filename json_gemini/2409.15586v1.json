{"title": "TFT-multi: simultaneous forecasting of vital sign trajectories in the ICU", "authors": ["Rosemary Y. He", "Jeffrey N. Chiang"], "abstract": "Trajectory forecasting in healthcare data has been an important area of research in precision care and clinical integration for computational methods. In recent years, generative Al models have demonstrated promising results in capturing short and long range dependencies in time series data. While these models have also been applied in healthcare, most of them only predict one value at a time, which is unrealistic in a clinical setting where mul- tiple measures are taken at once. In this work, we extend the framework temporal fusion transformer (TFT), a multi- horizon time series prediction tool, and propose TFT-multi, an end-to-end framework that can predict multiple vital trajectories simultaneously. We apply TFT-multi to forecast 5 vital signs recorded in the intensive care unit: blood pressure, pulse, SpO2, temperature and respiratory rate. We hypothesize that by jointly predicting these measures, which are often correlated with one another, we can make more accurate predictions, especially in variables with large missingness. We validate our model on the public MIMIC dataset and an independent institutional dataset, and demonstrate that this approach outperforms state-of- the-art univariate prediction tools including the original TFT and Prophet, as well as vector regression modeling for multivariate prediction. Furthermore, we perform a study case analysis by applying our pipeline to forecast blood pressure changes in response to actual and hypothetical pressor administration.", "sections": [{"title": "I. INTRODUCTION", "content": "In the age of big data, electronic health records (EHR) have become paramount in both clinical practice and research [1]. One subset of EHR that has been of interest to both clinicians and researchers is time series data, often measured in laboratory values and vital signs, that can be applied to track disease trajectory from every few minutes to the span of years [2]. Compared to cross-sectional (static) data, which remains constant, time series offer more information on patient development over time. These data can be leveraged to build trajectory prediction tools that can be used for surveillance (e.g., early warning systems [3], [4]), and decision support (e.g., forecasting event of interest [5] or response to interven- tions [6], [7]). In this work, we develop a single approach that simultaneously predicts vital signs commonly recorded in the intensive care unit. We demonstrate that not only does this approach outperform state-of-the-art forecasting models, but it also can be used to forecast patient trajectories under hypothetical scenarios."}, {"title": "A. Related work", "content": "With successful applications of generative artificial intelli- gence (genAI) models on time series data in finance [8], [9] and climate science [10], [11], researchers have turned to AI- based tools to predict trajectories over time in healthcare [12], [13]. Compared to traditional autoregressive methods such as the ARIMA model [14], AI-based models have the potential to better capture complex relationships between variables. In univariate modeling, Prophet [15] is a state-of-the-art method to predict time series data in many applications. Another model that has been effective in capturing both long and short term trends is temporal fusion transformer (TFT) [16]. In previous works, both methods have been used for vital sign forecasting in cardiovascular diseases [17] and sepsis patients [18]. However, the feasibility of implementing these approaches is limited by the fact that a separate model must be used for each outcome. Furthermore, vital signs may be informative of each other and their trajectories should not be predicted independently, prompting the need for models that can predict multiple variables simultaneously. The state- of-the-art for multivariate prediction models is the vector autoregressive (VAR) model [19], which captures the linear interdependencies among multiple time series. In this work, we extend the TFT model from univariate to multivariate prediction and develop an end-to-end pipeline that can simulta- neously predict 5 common vital signs recorded in the intensive care unit (ICU). We demonstrate our method outperforms state-of-the-art methods including Prophet, the original TFT and VAR in terms of predictive power. In the future, our pipeline can be extended to real-time predictions and applied as an early warning system for patients in the ICU. In addition, we demonstrate a study case to apply our model for treatment effect estimation and decision support, generating hypothetical blood pressure trajectories with and without the administration of pressors."}, {"title": "II. METHODS", "content": "This study was performed using two independent datasets: MIMIC 2.2 [20], [21], and a de-identified electronic health records from a large academic medical center deemed non human-subjects research by the institutional IRB. We train and validate our model using the MIMIC dataset and perform external validation on the second private institutional dataset. MIMIC is a publicly available and widely used EHR dataset, and details about the study can be found in the original papers [20], [21]. After initial filtering, the MIMIC set consisted of 9,638 patients who were admitted to the intensive care unit (ICU). The institutional cohort consisted of 35,286 pa- tients who presented at the Emergency Department and were eventually admitted to the ICU. We summarize some key characteristics of both cohorts in Table I, where the entry format is mean\u00b1standard deviation or %."}, {"title": "A. Data preparation", "content": "We include static and time series, numerical and binary variables including 5 demographic variables such as age and BMI, 72 comorbidities including heart failure and diabetes, 21 laboratory results including blood glucose and potassium, 12 medications in the class of pressors including Epinephrine and Angiotensin, and 5 common vital signs: mean arterial blood pressure (mean BP), pulse, SpO2, respiratory rate (Resp) and temperature (Temp). We resampled all time series data into 15 minute intervals and aggregated using the mean (for numeric variables) or median (for categorical variables) within each interval, and then forward-filled for any missing intervals (e.g., [5]). For static variables, we fill missing values with 0 for binary inputs such as comorbidities and drop samples with missing numeric values. For medications, we group all pressor administrations into one categorical variable and assume a missing value indicates no medication given. For each encounter, we construct 100 time points and use the first 75 as the past (18.75 hours) and the last 25 as the future (6.25 hours). During model training, different variables are considered as follows: demographics and comorbidities as past static variables; laboratory results, vital signs, age and medications up until the first 75 time points as past time series variables; age in the last 25 time points as known future time series variables. We randomly split the cohort to 80% training set and 20% held-out test set."}, {"title": "B. Temporal fusion transformer", "content": "In this section, we briefly introduce temporal fusion trans- former (TFT) [16], a transformer based model for multi- horizon time series forecasting. TFT introduces a novel way to incorporate static and time series covariates separately, preserving both short and long range dependencies between variables. There are several building blocks that make TFT powerful in time series prediction. First, historical time series inputs are passed through sequence-to-sequence layers to gen- erate context vectors for short range dependencies. Meanwhile, static covariates are passed through an encoder to generate a representation, which is then combined with the context vectors in the static enrichment layer. Next, these embeddings are fed into multi-head attention blocks, which are better at capturing long term relations [22]. Lastly, the output from the attention layer is processed by more densely connected layers to produce prediction forecasts. In multiple parts of the architecture, variable selection units are incorporated to select relevant covariates to pass onto the next layer. TFT allows different data types to be incorporated at different points in the model: past static variables, past time series variables, and future time series variables. The model outputs multi- horizon forecasts for 3 quantiles: the 10th, 50th and 90th. While the 50th quantile is often closest to the ground truth, the 10th and 90th quantiles act as prediction upper and lower bounds. By incorporating and processing different types of covariates and combining strengths from short and long term dependencies, TFT has shown promising results in predicting electricity, traffic and stock market patterns [16]. In addition, feature weights can be extracted across multi-head attention layers for interpretability. In other studies, TFT have shown comparable results in vital prediction [18], prompting our work to extend it to simultaneous prediction for multiple variables in sparsely sampled data."}, {"title": "C. TFT-multi", "content": "In this section, we propose TFT-multi, our extension to the original model, that is capable of handling sparsely sampled data and simultaneously predicting multiple measures of inter- est (in this work 5 vital signs in ICU monitoring). In Fig. 1, we show an illustration of our end-to-end pipeline that takes in time series and static covariates and simultaneously predicts 3 toy trajectories. We modify TFT in two main ways: the input- output structure and the loss function, while keeping the inner network the same. In the original model, past target values are appended to the past time series covariates, which we now extend from one to multiple at each time point. In the output, instead of predicting three quantiles at each time point for one target, we modify the last fully connected layers to output three quantiles for each target variable all at once.\nWe make two modifications in the loss function. First, we sum over trajectory losses over all quantiles and variables to jointly optimize all target variables. Second, we apply a masking technique to only account for losses in the real values and not the imputed ones to avoid overfitting to imputed data in sparsely sampled variables and increase predictive performance. Our loss function is as follows:\n$L(\\Omega) = \\sum_{V \\in V} \\sum_{Y_i \\in \\Omega} \\sum_{q \\in Q} \\sum_{t=1}^{t_{max}} QL(y_{it}, \\hat{y}_{it}(q), q) \\cdot I_{y_{it}(real \\ value)}$\n(1)\n$QL(y, \\hat{y}, q) = qmax(0, (y - \\hat{y})) + (1 -q)max(0, (\\hat{y}-y))$, (2)\nwhere V is the set of target variables, \u03a9 is the training dataset, Q is the set of quantiles {0.1,0.5,0.9} across future time points t to tmax. We use the notation \u2161(x) as the indicator function with value 1 when x is true and 0 otherwise.\nFor training the model, we use the Adam [23] optimizer with a learning rate of 1e-3, a batch size of 800 and a dropout rate of 0.3. We train the model for a maximum of 2000 epochs and implemented early stopping to obtain the best performing model during training. We implement parallelization across two Tesla V100-PCIE-16GB GPUs, and training the model took 6 hours."}, {"title": "D. Treatment response forecasting", "content": "We present a study case applying our prediction pipeline to forecast patient trajectories conditioning on whether a patient is administered pressors. Pressors (vasopressors) are a class of drugs which raise blood pressure and are used in the man- agement of hypotension and shock [24]. They are clinically indicated when mean blood pressure falls below 60 mmHg. As these drugs are expected to increase blood pressure within a short time, blood pressure forecasts should reflect this trend when provided time-varying medication administration. In this analysis, we use the MIMIC cohort only, as the institutional dataset obtained does not have enough information about the injection time and duration of medications. Our experimental set-up is as follows. First, we train a separate TFT-multi model assuming that medication (pressor) administration is known into the future, i.e. as a future time series variable. Then for each patient in the test set, we make forecasts based on three scenarios: the observed truth for medication input, assuming constant administration throughout the prediction interval (all 1s), and assuming no administration (all Os)."}, {"title": "III. RESULTS", "content": "First, we compare performance in predicting 5 standard vital values in the ICU: mean BP, pulse, temperature, respiratory rate and SpO2 across four methods: Prophet [15], VAR [19], the original TFT [16] and our method, TFT-multi. Because Prophet [15] is a univariate forecasting model, five instances were trained to predict each of the vital sign time series. We note here that since Prophet [15] requires the covariate inputs to also be known into the future, we only add age as a covariate. For TFT [16], we also trained 5 instances with the same covariate inputs as our model to predict each of the vital signs. For VAR [19], we trained a model to take in past vital sign trajectories and no exogenous variables, in accordance with convention. We note here that respiratory rate and temperature did not pass the Granger's causality test [25], which determines if one time series can predict another time series. Since VAR assumes all variables to be predictive of one another [19], we did not include them in the model. By the same logic, we did not include temperature in the external validation set. For each model, we calculate the mean absolute error (MAE) in both validation datasets for all vital predictions against their true values. We examine only the time points with recorded and not imputed values, calculated as follows for each vital sign:\n$MAE = \\frac{\\sum_{Y_i \\in \\Omega} \\sum_{t=1}^{t_{max}} |Y_{it} - \\hat{y}_{it}|\\cdot I_{t(real \\ value)}}{\\sum_{Y_i \\in \\Omega} t_{max} I_{t(real \\ value)}}$ (3)"}, {"title": "A. Multi-horizon prediction", "content": "In Table II, we compare performances for each vital sign, with the best performing model in bold. The top 4 rows are calculated with the held-out MIMIC test set, while the bottom 4 with the external validation (EV) set. For TFT and TFT- multi, we take the 50th percentile prediction as the prediction. In the held-out test set, TFT-multi archives the lowest MAE in 4 out of 5 vitals, and outperforms Prophet in respiratory rate. In the external set, TFT-multi achieves the lowest MAE for 4 out of 5 vitals, and performs comparably with Prophet in SpO2, which Prophet is expected to perform well in as it is highly regular and cyclical. Compared to the original TFT model, there is a significant improvement in predicting vitals that have more missingness, such as SpO2."}, {"title": "B. Prediction bound estimation", "content": "In clinical support systems, prediction bounds are some- times more helpful than singular values, as vital measures have high interpersonal differences and a value is considered abnormal only if it falls outside a range. Therefore, we perform an additional analysis to better understand model performances in predicting upper and lower bounds. For each subject in both validation sets, we calculate the percentage of times a true value is within prediction bounds. For Prophet, we use y_hat_upper and y_hat_lower as bounds, which capture uncertainty in trend, seasonality and observation noise in the prediction [15]. For TFT [16] and TFT-multi, we use the 10th and 90th quantile predictions. Since VAR [19] does not offer any bound, it is excluded in this analysis. In Fig. 5a, we show the percentage distribution over the test set for all 5 vital signs in a violin plot and the first, second and third quartile values as lines within each plot. Across all vitals, TFT-multi correctly bounds the most number of points within the entire trajectory. Consistent with the Bland-Altman analysis (Fig. 2), our findings suggest that for values that have high missingness such as SpO2, calculation using only real values may not be the best as there are few values. In Fig. 5b, we show results for the external set, where performance across methods have decreased as expected, but TFT-multi still remains the top performing method."}, {"title": "C. Feature importance", "content": "We conducted a feature importance test, as proposed in the original TFT paper [16], by aggregating the multi-head attention weights for each input feature to see which input had the most influence over the predictions. We show the top features by weight for both the time series and static inputs in Fig. 4. For time series inputs, medication has the most influence over vital predictions. This aligns with our expectation, as pressors should influence blood pressure significantly within a relative short period of time. Among static variables, comorbidities such as heart failure, arterial fibrillation and chronic obstructive pulmonary disease have the most effects over vital signs. We note here the feature importance is reported across all patients and time points, which may not be informative on a subject level and is a shortcoming of this analysis. For each subject, the factor that affects their prediction may be different and will be included in future analysis."}, {"title": "D. Treatment response forecasting", "content": "For patients who received pressor administrations within the course of their ICU care, we forecasted three trajectories: (1) assuming the true administration; (2) assuming continuous ad- ministration (all 1's); and (3) assuming no administration (all 0's). First, we calculate a MAE for real points between these scenarios and report the results: 7.44 when the ground truth pattern is used, 7.47 when setting pressor administration to 1, and 7.46 when setting pressor administration to 0. As expected, the actual medication input pattern produces predictions most closely fit with observation than setting the medication to all 1s or Os. Second, we applied t-tests to test that the modeled effect of pressor administration was consistent with its intended effect. We present our t-test results in Table III, where for \u0177 we use the 50th percentile prediction. We perform 3 comparison tests, the first in which we compare the mean trajectory prediction between the two hypothetical scenarios without considering the ground truth. In row 1, we see an average increase of 3.67 in blood pressure when assuming some medication is administered. The second and third comparisons take real observations into account and test for predicted differences between scenarios for time points that have a ground truth observation (obs) of 1 or 0. When the ground truth observation is no medication (obs=0), hypothetically modeling pressor administration predicts a value 3.12 higher than the alternative. When the patient was given medication in real life, the difference is 2.19. In all three scenarios, the p-values are significant (< 0.05) to reject the null hypothesis and could indicate that our model is learning the association between increased BP and pressor administration."}, {"title": "IV. DISCUSSION", "content": "In this work, we extend TFT, a multi-horizon time series prediction tool, from univariate to multivariate and develop a novel end-to-end pipeline to simultaneously predict 5 vital signs for patients in the ICU. We compare our method against state-of-the-art methods and show our model performs the best across vital signs in both the test set and external validation set. While the original TFT may have a difficult time predicting variable trajectories with high missingness such as SpO2 by itself, TFT-multi uses its relation with other vitals such as pulse to improve prediction. Though we observed limited calibration of our model in predicting respiratory rate, SpO2 and temperature, we hypothesize a contributing factor to be due to the data itself. Respiratory rate has a lower sampling rate and may not provide enough data for the model to fully learn its pattern (as observed in Fig. 2c); SpO2 and temperature have a limited range of observations in our training data, as observed in Fig. 2d and 2e. In addition, we demonstrate a use case of our pipeline for treatment effect estimations, which can be extended into a counterfactual estimation tool.\nNext, we discuss some limitations and future directions of this work. First, the model assumes at least 18 hours of past data is known before making future predictions, which can be limiting. While padding past observations with 0 can be a naive approach to the problem, a more flexible training regime can be incorporated to handle varying input lengths. Second, interpretability in AI models has been a long-standing issue [28]. While we try to interpret the model in Section III- C, further work can be done to analyze feature importance on a subject-level. Lastly, in our proof-of-concept medication analysis, we assumed a binary administration of pressors while in reality medications are given intermittently and at varying doses. Future work will include modeling these medications inputs with more variability to test performance in a more realistic setting."}, {"title": "A. Clinical application", "content": "Our pipeline has the potential to be incorporated into clinical practice in several ways. First, it can be extended into a real time early warning system, which can assist clinicians in monitoring ICU patients and predict anomalous events up to 6 hours prior. Second, the model can be further extended to include other data modalities including medical images and text data, which are highly complex and often serial in nature. Another future direction for this work is to extend it to the outpatient cohort, which is more representative of the population but has large amounts of missing in time series data. A model to first impute irregularly sampled time series data can be added in the pipeline to address this issue and predicts longer range trajectories in the outpatient cohort, benefiting a larger population."}]}