{"title": "On the practical applicability of modern DFT functionals for chemical computations. Case study of DM21 applicability for geometry optimization.", "authors": ["Kirill Kulaev", "Alexander Ryabov", "Michael Medvedev", "Evgeny Burnaev", "Vladimir Vanovskiy"], "abstract": "Density functional theory (DFT) is probably the most promising approach for quantum chemistry calculations considering its good balance between calculations precision and speed. In recent years, several neural network-based functionals have been developed for exchange-correlation energy approximation in DFT, DM21 developed by Google Deepmind being the most notable between them. This study focuses on evaluating the efficiency of DM21 functional in predicting molecular geometries, with a focus on the influence of oscillatory behavior in neural network exchange-correlation functionals. We implemented geometry optimization in PySCF for the DM21 functional in geometry optimization problem, compared its performance with traditional functionals, and tested it on various benchmarks. Our findings reveal both the potential and the current challenges of using neural network functionals for geometry optimization in DFT. We propose a solution extending the practical applicability of such functionals and allowing to model new substances with their help.", "sections": [{"title": "I. INTRODUCTION", "content": "Density Functional Theory (DFT) is a fundamental computational method widely used in chemistry and physics to investigate the electronic and nuclear structures of many-body systems, including atoms, molecules, and condensed phases. Its popularity comes from a good balance between computational efficiency and accuracy. More accurate computational methods, such as CCSD\u00b9 and Quantum Monte Carlo2,3, can provide higher precision but are computationally intensive and scale poorly with system size. A central component of DFT is the exchange-correlation (XC) component of total energy, which encapsulates the complex many-body interactions among electrons. The exact form of the XC functional is unknown, and developing accurate approximations for it is essential because it determines the overall accuracy of DFT calculations. Traditionally, XC functionals have been constructed using analytical expressions based on approximations such as the Local Density Approximation (LDA)4\u20136, the Generalized Gradient Approximation (GGA)7\u20139, and Meta-GGA10,11. These functionals involve tuning multiple parameters within chosen mathematical forms to fit experimental data or results from more accurate calculations. Although successful in many applications, this approach struggles from limited flexibility and can make it challenging to incorporate new physical specificities from advanced computational methods like quantum Monte Carlo or post-Hartree-Fock calculations.\nIn fact, exchange-correlation functionals serve as surrogate models- approximate mathematical models used to calculate the effects of electron-electron interactions within a system of formally non-interacting particles in DFT. Neural networks, being universal approximators12, are naturally used to build surrogate models, so neural networks have become state-of-the-art approach in various fields: atomic potentials13,14, protein folding15, property prediction16. And also it offers the potential to achieve new levels of accuracy in DFT calculations considering the flexibility of neural network approximators, with their ability to handle a large number of parameters. In recent years, neural network-based functionals have seen significant development. These efforts include creation of completely new neural network based functionals17\u201320 as well as studies aimed to interpolation or improving of existing functionals with the focus to analysis of physical conditions and new architectures21\u201323. Furthermore, some models incorporate physical asymptotic constraints to improve functional accuracy24. However, despite the high accuracy obtained in energy calculation, neural network functionals are not as commonly used in practical research as analytical functionals. The official documentation for quantum chemical packages like PySCF25, Octopus26, ORCA27, and others lacks comprehensive information about such functionals, and there is no full integration of such functionals by the developers of these packages, this can be attributed to several factors. Firstly, neural networks are often characterized by limitations such as low interpretability and vulnerability to adversarial attacks. Additionally, prior to the introduction of DM21, neural network functionals did not demonstrate superior performance compared to traditional analytical functionals. Secondly, there has been limited investigation into the application of these functionals in practical contexts, including geometric optimization, considering their oscillatory behaviour, computational cost, impact of basis set selection, and the extrapolation capabilities beyond the training dataset.\nA neural network (NN) XC functional typically takes electron density descriptors as input and outputs the XC energy density. The total energy of the molecule is then obtained by integrating XC energy density over the grid and adding Coulomb and kinetic energies. The optimization of the neural network weights is achieved by minimizing the error between"}, {"title": "II. METHODS", "content": "Density functional theory is a quantum mechanical method widely used to investigate the electronic structure of many-body systems, including atoms, molecules, and solids. The fundamental principle of DFT is that all ground-state properties of a system of interacting electrons can be determined from the electron density p(r), which depends only on three spatial coordinates, rather than the many-electron wave function (r1, r2,...,r), which depends on the coordinates of all N electrons and is computationally intractable for large systems.\nThe foundation of DFT was established by the Hohenberg-Kohn theorems30. The first theorem states that the ground-state electron density uniquely determines the external potential (and thus the Hamiltonian and all properties of the system). The second theorem introduces a variational principle: the ground-state energy is a functional of the electron density, and the correct ground-state density minimizes this energy functional.\nIn practice, DFT calculations are performed using the Kohn-Sham formalism28,30, which maps the complex interacting electron system onto a fictitious system of non-interacting electrons moving in an effective potential. This approach simplifies the problem while preserving the exact ground-state electron density. The Kohn-Sham equations are:\n$\\left[-\\frac{\\hbar^{2}}{2 m} \\nabla^{2}+V_{\\text {ext }}(\\mathbf{r})+V_{H}(\\mathbf{r})+v_{x c}(\\mathbf{r})\\right] \\phi_{i}(\\mathbf{r})=\\epsilon_{i} \\phi_{i}(\\mathbf{r}),$ (1)\nwhere:\n\u2022 $ \\phi_{i}(\\mathbf{r}) $ are the Kohn-Sham orbitals,\n\u2022 $ \\epsilon_{i} $ are the corresponding orbital energies,\n\u2022 vext(r) is the external potential due to the nuclei and any applied fields,\n\u2022 VH(r) is the Hartree potential representing the classical electrostatic (Coulomb) interaction between electrons,\n\u2022 vxc (r) is the exchange-correlation potential, accounting for quantum mechanical effects of exchange and correlation between electrons.\nThe exchange-correlation potential vxc(r) is defined as the functional derivative of the exchange-correlation energy Exc[p] with respect to the electron density:\n$v_{x c}(\\mathbf{r})=\\frac{\\delta E_{x c}[\\rho]}{\\delta \\rho(\\mathbf{r})},$ (2)\nTotal exchange-correlation energy can be written as (also called exchange-correlation functional):\n$E_{x c}=\\int \\epsilon_{x c}[\\rho(\\mathbf{r}), \\nabla \\rho(\\mathbf{r}), \\ldots] d \\mathbf{r},$ (3)\nThen the total potential energy of system Etot is calculated from Eext - the energy due to the external potential, Coulumb energy Ej and exchange-correlation energy Exc.\n$E_{t o t}=E_{e x t}+E_{j}+E_{x c},$ (4)\nChallenge in DFT lies in approximating Exc[p] accurately since its exact form is unknown. The simplest approximation is the Local Density Approximation (LDA)4\u20136, which assumes that the exchange-correlation energy at each point depends only on the local electron density. While LDA provides reasonable accuracy for simple systems with slowly varying"}, {"title": "A. Density functional theory", "content": "electron densities, it struggles with more complex systems where nonlocal effects become important. To address nonlocal effects, additional characteristics of the electronic structure, such as the electron density gradient Vp(r) in the Generalized Gradient Approximation (GGA)7\u20139 and the kinetic energy density (r) = \u2211\u00a1|\u2207\u2081(r)|2 in Meta-Generalized Gradient Approximation (Meta-GGA)10,11 are incorporated into the exchange-correlation functional. Moreover, introduction of orbital-dependent energies, such as in hybrid functionals31 significantly increases the level of approximation. Neural network functionals functionals can belong to different levels of approximation (LDA, GGA etc.)."}, {"title": "B. DM21 Functional Overview", "content": "DM21 is one of modern neural network XC functionals. It achieved qualitatively new results for systems with strong correlation and artificial charge delocalization. According to the detailed energy benchmark conducted in the original paper17, DM21 significantly outperformed classical functionals in energy calculation of main-group molecules and atoms, the mean absolute error (MAE) in energy values on the GMTKN55 benchmark32 for DM21 was 1.5 kcal/mol, compared to 3.6 kcal/mol using analytical functional SCAN33.\nDM21 depends on the local Hartree-Fock exchange energies eHF and it's range-separated version e@HF. This approach positions DM21 as a Local Hybrid range-separated Functional (LHF). Instead of mixing the global Hartree-Fock exchange energy with the integrated value of the semi-local XC functional, LHFs34 mix the value of the Hartree-Fock exchange energy at point r with the output of the XC functional in this point. The expression for the local Hartree-Fock exchange is expressed by the formula, where Dpq =\n\u2211occupied Cpacqa is the density matrix, ca is the orbital coefficient and a represents the basis orbitals:\n$\\epsilon_{x}^{D A}(r)=-2 \\pi\\left[\\frac{3}{4 \\pi}\\left(\\rho^{\\uparrow}(\\mathbf{r})+\\rho^{\\downarrow}(\\mathbf{r})\\right)\\right]^{4 / 3},$ (5)\n$\\epsilon_{x}^{H F}(\\mathbf{r})=-\\frac{1}{2} \\sum_{p q r s} D_{p q} D_{r s} \\int \\frac{\\operatorname{erf}\\left(\\omega\\left|\\mathbf{r}-\\mathbf{r}^{\\prime}\\right|\\right)}{\\left|\\mathbf{r}-\\mathbf{r}^{\\prime}\\right|} \\phi_{p, \\sigma}^{*}(\\mathbf{r}) \\phi_{q, \\sigma}(\\mathbf{r}) \\phi_{r, \\sigma}^{*}(\\mathbf{r}^{\\prime}) \\phi_{s, \\sigma}\\left(\\mathbf{r}^{\\prime}\\right) d^{3} r,$\n(6)\nLocal Hartree-Fock exchange energy eff (r) is calculated similarly to eHF (r) with the w range-separation parameter is zero. The expression of the exchange-correlation functional of DM21 is as follows.\n$\\mathrm{E}_{M L P}[\\rho]=\\int f_{\\theta}(\\mathbf{x}(\\mathbf{r}))\\left(\\begin{array}{c}\\epsilon_{x c}^{L D A}(\\mathbf{r}) \\\\\\epsilon_{x}^{H F}(\\mathbf{r}) \\\\\\epsilon_{x}^{\\omega H F}(\\mathbf{r})\\end{array}\\right) d^{3} r,$ (7)\nfe(x(r)) is a vector of 3 values which are outputs of neural network. The integrand is computed by scalar product of"}, {"title": "C. DM21 Functional Overview", "content": "fo(x(r)) and the vector of 3 energies at r: eLDA (r), eHF (r) =\neff (r) + eff (r) and e@HF (r) = eHF eHF (r) + eHF (r). Neural network takes as input 11 variables including electron density for each spin channel, norms of electron density gradient, kinetic energy density, and four features of local Hartree-fock exchange energy.\nResolution of identity (RI)35 is a technique that is claimed to reduce the scaling of DM21 with system size and number of basis orbitals. Unfortunately, since the release of DM21, which showed an increase in computational speed using this feature, no RI implementation for DM21 has been released that can replicate author's speed test. For this reason, in the speed test we describe below, we did not use speedup techniques for all methods.\nDespite the high accuracy of the DM21 functional in energy calculations, this does not necessarily guarantee high accuracy in geometric optimization. Such optimization relies on the gradients of the energy with respect to the atomic nuclei coordinates (forces). These gradients can be highly oscillatory, possibly because such functionals are trained primarily on optimal or near-optimal molecular geometries, and may not accurately capture the energy landscape far from equilibrium configurations, leading to unstable optimization. While calculating energies and various properties for a set of known geometries- such as those previously computed by others- can be valuable, it is often necessary to perform a geometry optimization process if a suitable geometry is not readily available. This step ensures that the structure corresponds to a local or global minimum on the potential energy surface, which is critical for accurate energy and property predictions."}, {"title": "C. Geometry optimization", "content": "The goal of geometry optimization is to find the coordinates of atoms R* corresponding to the minimum energy on potential energy surface for given atomic structure represented as atomic coordinates R. Then the optimization problem can be written as follows:\n$R^{*}=\\underset{R}{\\operatorname{argmin}} E_{\\text {tot }}(R),$ (8)\nGiven XC functional and basis set, it starts from the initial coordinates of atoms. The process of geometric optimization using DFT can be represented as the following iterative algorithm:"}, {"title": "E. Geometry optimization", "content": "The geometry optimisation Fig. 1 starts by solving the Kohn-Sham equations using the SCF method. Then the forces are calculated (using analytical or numerical gradients) and the positions of the atoms are adjusted by the optimisation algorithm to minimise the energy. In the last step, convergence criteria are checked: changes in energy, forces or geometry adjustments.\nIn this work, the functionals PBE036, SCAN33, and DM21 were compared in predicting the geometries of molecules. For all systems in this study, we utilized Cartesian coordinate-based geometry optimization from the GeomeTRIC37 library implemented in PySCF25.\nThe GeomeTRIC library37 introduces an approach to geometry optimization by employing a translation-rotation-internal coordinate (TRIC) system. This system explicitly includes the collective translations and rotations of molecules or molecular fragments. Translations are represented by the centroid position of the molecule, while rotations are parameterized using the exponential map of quaternions."}, {"title": "D. Nuclear gradients", "content": "In each step of geometric optimization, the calculation of interatomic forces is essential. The force acting on an atom A is given by:\n$F_{A}=-\\nabla_{A} E(\\mathbf{R}),$ (9)\nPrevious studies have indicated that the calculation of energy derivatives with respect to atomic coordinates for local hybrid functionals is challenging38. While there are semi-numerical approaches available38, there is currently no effective implementation of analytical gradients for local range-separated hybrid functionals, such as DM21, in the literature. To address this limitation, we have integrated numerical gradient calculations within the PySCF framework specifically for DM21."}, {"title": "E. Force calculation techniques", "content": "The central finite difference method was used to calculate the interatomic forces. Force acting on the atom A in the finite difference approximation was calculated as:\n$F_{A}=\\frac{d E(\\mathbf{R})}{d R}=\\frac{E(\\mathbf{R}+\\Delta \\mathbf{R})-E(\\mathbf{R}-\\Delta \\mathbf{R})}{2 \\Delta R},$ (10)\nThe central finite difference method has limited practicality due to the fact that the calculation of forces on one iteration of the geometry optimization requires 6N + 1 separate SCF runs where N is the number of atoms. We accelerated numerical force calculations using the following technique: by making small increments to the atomic coordinates, we initiated the self-consistent energy calculation at the points R\u00b1 AR based on the electron density at R. This approach allows us to reuse the density matrix from R in the self-consistent field calculations at R\u00b1AR. The numerical differentiation parameter AR was chosen empirically, the selection of the optimal parameter for each system under study is intractable for practical applications (and this is a limitation of the method), for this reason we have checked the stability of the numerical forces for typical chemical bonds in molecules similar to the substances from the test sets under study and presented the results in Supplementary Materials."}, {"title": "F. Mathematical modeling of oscillations", "content": "Neural networks are known to suffer from non-smooth behavior of interpolation that produces the high-frequency oscillations in their gradients. The purpose of this subsection is to measure the level of oscillations in potential energy surface and their effect on the numerical and analytical nuclear gradients. Since DM21 does not have analytical nuclear gradients, we assumed that an analytical functional with added noise, the level of which is similar to the neural network one, would allow us to model the gradient behavior while preserving the possibility of both analytical and numerical estimates. To better understand and quantify the impact of these oscillations, we start with creating a mathematical model that captures its characteristics and effect on the potential energy surface (PES) in case of DM21 functional. Due to the fact that the magnitude of noise can vary with the elemental composition of substances29, we chose the H\u2082 dissociation curve as a model system, when the noise in our model was calibrated on the SCF of H2 and He2 in order to then estimate the oscillations in the nuclear gradients on the H2 system.\nPotential energy surface is a hypersurface that represents the total energy of a system as a function of atoms' positions (or related parameters). The total exchange-correlation energy Exc is given by the integral over the electron density p(r) and the exchange-correlation energy per particle Exc(r) 3. Within the scales of variations of input parameters used for the calculation of numerical derivatives to compute forces, Exc and Vxc depend linearly on the inputs. We assume that the error in the inputs is modeled as Gaussian noise. For small variations"}, {"title": "F. Mathematical modeling of oscillations", "content": "in the input data 8X, the outputs Exc and vxe can be approximated linearly, and if the input data has Gaussian noise, the changes in the outputs will also linearly depend on this noise, thus following a normal distribution.\nTherefore, this assumption allows us to create a tractable model for comparison. In order to model the noise of the DM21 neural network, we assumed Gaussian noise was added to the XC energy per particle and XC potential of SCAN functional.\n$\\epsilon_{x c}^{\\prime}=\\epsilon_{x c}+\\eta_{\\epsilon}, \\quad \\eta_{\\epsilon} \\sim \\mathcal{N}\\left(0, \\sigma_{\\epsilon}^{2}\\right), \\quad \\sigma_{\\epsilon}=10^{-6.8},$ (11)\n$v_{x c}^{\\prime}=v_{x c}+\\eta_{v}, \\quad \\eta_{v} \\sim \\mathcal{N}\\left(0, \\sigma_{v}^{2}\\right), \\quad \\sigma_{v}=10^{-6.2},$ (12)\nThe standard deviation of the noise was chosen to achieve two objectives: first, to ensure that the resulting energy oscillations matched the level of those calculated with DM21, and second, to align the number of SCF iterations with the number required for convergence with DM21. Note that for the H2 system in 6-31G basis set, the number of SCF iterations required for convergence with SCAN was 4, while with DM21, it was 16. The paper29 also highlighted the difficulty of achieving SCF convergence with DM21. Therefore, the increased number of SCF iterations with DM21 is attributed to the noise in exc and vxc."}, {"title": "III. RESULTS", "content": "Speed tests\nGeometry optimization is a combination of single-point computations. Therefore, we first determine how computationally expensive the SCF calculation with DM21 is compared to PBEO and CCSD(T) (the main reference method for neural network training). For this purpose, we determined the calculation time of single SCF cycles for two-atom molecules of elements from H to Ca in neutral form and +1 cations using the cc-pVTZ basis set and energy tolerance of 10-9En. The comparison of the calculation time using the mentioned methods is given in Fig. 3."}, {"title": "A. Benchmark study", "content": "LMGB3539 is a benchmark for geometry optimization problem described in subsection \"Geometry optimization\". It contains covalent systems from the first and second rows of the periodic system compiled from experimental data, the reference values are represented by bond lengths. With the exception of systems such as BO, F2, 5, NF, NH+, \u017b, OH+, molecules from LMGB35 were represented in the DM21 training dataset (within the W4-17 subset). Calculations of DFT atomization energies were performed using the cc-pVQZ basis set, when its reference values were calculated using CCSD(T)/cc-pVQZ. Geometry optimizations were conducted with the 6-31G(d,p) and def2-TZVP basis sets.\nBased on Fig. 4, several conclusions can be drawn. Overall, the DM21 functional (blue bars) demonstrates competitive performance compared to the other functionals: PBE0 (yellow bars) and SCAN (green bars). The chart shows that the MAE in bond lengths after optimization is generally below 2 pm for most molecules across all functionals. There are specific molecules where DM21 shows lower MAE in bond lengths compared to PBE0 and SCAN, such as certain hydrocarbons (e.g., C2H4, C2H2). However, there are also many cases where PBE0 or SCAN outperform DM21. Therefore, even though the molecules in the benchmark set are very similar to those in the training set of DM21, this similarity does not guarantee good geometry optimization capabilities. From the MAE values, one may observe that for the LMGB35 benchmark DM21 outperforms the analytical functionals in the energy calculation, but is not more accurate in the geometry optimization.\nTo assess accuracy beyond the training sample, DM21 was tested in geometry optimization of larger molecules that were not in the training set. The reference data were geometries optimized at the CCSD(T) level with a large basis set, as taken from the studies 40,41.\nDM21 showed stable result in predicting geometries of glycine conformers (Fig. 5), overall its accuracy on this benchmark was marginally higher than PBE0 and SCAN functional's accuracy. Despite the exclusion of these molecular systems from the training sample, generalizability of DM21 to this structures was confirmed."}, {"title": "IV. CONCLUSION", "content": "In our study, we performed the first analysis of neural network functional in geometry optimization tasks. Firstly, we conducted mathematical modeling of oscillations produced by NN and measured its impact to PES and gradients of NN. The results of modeling show that both analytical and numerical gradients can be used with NN XC functionals even with the presence of NN-specific oscillations. After that, we conducted several benchmark tests to assess practical applicability of DM21 functional. Firstly, we performed time tests of DM21 and compared its speed with PBE0 and CCSD(T). These tests showed that the speed of DM21 in single-point computations is strongly biased in favor of analytic functionals and even CCSD(T). Moreover, given the absence of analytical gradients for LHF, the geometric optimization problem for DM21 becomes practically limited. After that, we conducted comparison of DM21 and several analytical functionals in energy computations and geometry optimization.\nIn summary, the analyses performed in this study have shown that, despite the significantly increased accuracy of energy calculation using the DM21 functional compared to the analytical one, the quality of equilibrium geometry prediction remains at nearly the same level as can be achieved using the analytical PBE0 and SCAN functionals. Additionally, the features of neural network functionals often do not allow for the analytical calculation of atomic forces, which significantly reduces their practical applicability. This may indicate the need to revise the approach to the construction and training of neural network XC functionals.\nAn effective way to increase the accuracy of exchange-correlation functionals, not only for the geometric optimization problem but also in general, involves informing the neural network about the curvature of the PES. For instance, when training the DM21 functional, such an approach was used in dataset construction by adding diatomic molecules with non-equilibrium bond lengths to the training sample. However, one can explicitly consider the PES curvature for functionals having an expression for the analytic derivative of energy at atomic coordinates (e.g., LDA, GGA, MGGA, hybrids, range-"}]}