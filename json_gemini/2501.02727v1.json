{"title": "A Tree-based RAG-Agent Recommendation System: A Case Study in Medical Test Data", "authors": ["Yahe Yang", "Chengyue Huang"], "abstract": "We present HiRMed (Hierarchical RAG-enhanced Medical Test Recommendation), a novel tree-structured recommendation system that leverages Retrieval-Augmented Generation (RAG) for intelligent medical test recommendations. Unlike traditional vector similarity-based approaches, our system performs medical reasoning at each tree node through a specialized RAG process. Starting from the root node with initial symptoms, the system conducts step-wise medical analysis to identify potential underlying conditions and their corresponding diagnostic requirements. At each level, instead of simple matching, our RAG-enhanced nodes analyze retrieved medical knowledge to understand symptom-disease relationships and determine the most appropriate diagnostic path. The system dynamically adjusts its recommendation strategy based on medical reasoning results, considering factors such as urgency levels and diagnostic uncertainty. Experimental results demonstrate that our approach achieves superior performance in terms of coverage rate, accuracy, and miss rate compared to conventional retrieval-based methods. This work represents a significant advance in medical test recommendation by introducing medical reasoning capabilities into the traditional tree-based retrieval structure.", "sections": [{"title": "I. INTRODUCTION", "content": "Medical test recommendation plays a pivotal role in modern healthcare systems, directly influencing diagnostic accuracy, treatment outcomes, and resource utilization. While traditional approaches like rule-based systems and similarity-based retrieval methods have been widely used, they often fall short in capturing the nuanced, context-dependent nature of medical diagnosis. The challenge lies not only in recommending appropriate diagnostic tests based on patient symptoms but also in considering the complex interplay of medical priorities, resource constraints, and diagnostic uncertainty.\nRecent advances in large language models (LLMs) and retrieval-augmented generation (RAG) have shown promising results in various healthcare applications. However, their direct application to medical test recommendations faces several critical limitations. These include the lack of hierarchical reasoning structure that mirrors medical diagnostic processes, insufficient integration of domain-specific medical knowledge at different diagnostic stages, limited ability to maintain and utilize reasoning history throughout the recommendation process, and the challenge in balancing between comprehensive coverage and targeted specificity in test recommendations.\nTo address these limitations, we propose HiRMed (Hierarchical RAG-enhanced Medical Test Recommendation), a novel system that combines hierarchical reasoning structures with RAG-enhanced medical decision support. Our approach is distinguished by three key innovations. First, our Hierarchical RAG Architecture implements a tree-structured architecture where each node incorporates specialized RAG processes, enabling progressive refinement of recommendations through multiple levels of medical reasoning, from general symptom assessment to specific test selection. Second, our system features Dynamic Knowledge Integration with a dual-layer knowledge base architecture a root-level knowledge base for broader medical understanding and department-specific knowledge bases for specialized diagnostic considerations. This structure enables more precise and context-aware recommendations at different stages of the diagnostic process. Third, HiRMed incorporates Memory-Augmented Reasoning with a sophisticated memory mechanism that maintains reasoning history across nodes, enabling coherent and comprehensive diagnostic paths while avoiding redundant or conflicting recommendations.\nThe significance of our work extends beyond theoretical innovation. Through comprehensive empirical evaluation, we demonstrate that HiRMed achieves higher accuracy in test recommendations compared to traditional approaches, improved coverage of potential diagnostic paths, lower miss rates for critical diagnostic tests, and better interpretability of recommendation rationale through explicit reasoning paths. This paper presents both the theoretical framework underpinning HiRMed and its practical implementation, providing a blueprint for next-generation medical test recommendation systems that combine the power of LLMs with structured medical reasoning."}, {"title": "II. RELATED WORK", "content": "The intersection of artificial intelligence and healthcare has seen significant advances, particularly in the realm of recommendation systems for diagnostic and treatment purposes. This section reviews existing work in tree-based recommendation systems, Retrieval-Augmented Generation (RAG), and their applications in medical diagnostics."}, {"title": "III. METHODOLOGY", "content": "Our system focuses on recommending medical tests in an outpatient setting, leveraging both structured patient data and comprehensive medical knowledge. To facilitate Retrieval-Augmented Generation (RAG), we compile an extensive dataset of outpatient visits and construct layered knowledge bases that integrate both general and department-specific medical information.\n1) Dataset: We collect outpatient visit records from multiple hospital departments. Each record captures the patient's initial consultation, including physical parameters and presenting symptoms, as well as the diagnostic tests recommended by the physician. Over the course of treatment, additional diagnostic tests may also be performed, and these are recorded in our dataset alongside subsequent physician notes, final diagnoses, and treatment outcomes. By documenting both the initially recommended tests and any supplementary tests administered later, our dataset provides a comprehensive view of each patient's diagnostic and treatment pathway.\nAll outpatient records are preprocessed by removing personally identifiable information and standardizing key medical terms to ensure consistency across various hospital information systems. This results in a structured dataset containing fields such as patient demographics, reported symptoms, recommended diagnostic tests, follow-up tests, and corresponding clinical outcomes.\n2) Knowledge Base Construction: We build a two-tiered knowledge base to enable hierarchical reasoning:\n1) Knowledge Base for Departments. This repository covers broad, department-level medical knowledge (e.g., cardiology, endocrinology). Entries include standard disease-symptom correlations, commonly prescribed tests, and high-level clinical guidelines that apply to each specialty.\n2) Knowledge Base for Department Testing Items. This repository contains more granular information regarding individual diagnostic tests (e.g., indications, interpretations, normal ranges). Each department has a specialized subset, allowing more precise recommendations for specific conditions.\nAll textual knowledge in these repositories is embedded into a high-dimensional vector space using an OpenAI embedding model (e.g., text-embedding-ada-002). The embeddings are indexed in a FAISS-based vector database, which"}, {"title": "B. Model Selections", "content": "Our hierarchical recommendation system incorporates three central models to handle vector representations, natural language reasoning, and final weighting of test suggestions. Each model is selected for its strengths in a particular aspect of the RAG workflow.\n1) Embedding Model: We employ OpenAI's Embedding API to convert both patient queries and knowledge-base text into numerical vectors. This transformation process captures nuanced semantic relationships, which is especially crucial for retrieving domain-relevant content in medical settings. The resulting embeddings are of manageable dimensionality, which allows for efficient similarity searches in the FAISS vector database. As a result, our system can swiftly locate high-value records or guidelines that match the patient's symptoms and history.\n2) LLM API (GPT-01): The GPT-01 large language model serves as the core reasoning engine. It processes the text retrieved from the vector database, aligns it with the patient's context, and formulates initial or refined recommendations at each layer of the hierarchy. Through multi-turn interactions and dynamic prompts, GPT-01 can generate intermediate diagnostic hypotheses and produce human-readable explanations that shed light on its reasoning. These outputs are instrumental in constructing a more interpretable and coherent test recommendation process.\n3) Weight Model (Fine-tuned LLaMA3.2-3B): We further enhance our recommendation pipeline with a fine-tuned version of LLaMA3.2-3B, which assigns weights or priorities to each recommended diagnostic test. The fine-tuning is conducted on historical outpatient data where each test has an associated physician-annotated relevance score. By learning from these annotations, the weight model can factor in patient demographics, symptom severity, and known comorbidities when ranking the final recommendations. This weighting mechanism is critical in distinguishing high-priority tests from those that may be secondary or less immediately necessary."}, {"title": "C. Model Architecture", "content": "Figure la illustrates the three-layer hierarchical architecture of our RAG-based medical test recommendation system. The design emulates real-world diagnostic logic by transitioning from broad, department-level considerations to specific test recommendations.\n1) Root Layer: Initial Analysis and Department Routing: In the Root layer, the system takes the patient's query (symptoms and other relevant data) and encodes it into a vector representation using the chosen embedding model. The vector database is then queried for semantically related information from the department-level knowledge base. GPT-01 processes the retrieved documents alongside the patient context to identify potential diagnostic categories or specialties that should be explored. The fine-tuned LLaMA3.2-3B model subsequently assigns weights to each recommended specialty, allowing the system to rank and prioritize which departments may require more immediate attention.\n2) Department Layer: Specialty-Specific Reasoning: Based on the Root layer's output, the system transitions to the Department layer. Here, it retrieves domain-specific knowledge relevant to the selected specialty. GPT-01 refines the diagnostic hypotheses by leveraging specialized guidelines, common presenting complaints, and department-focused protocols. This refined reasoning stage often involves narrowing down potential tests from a general list to those that align more closely with the patient's clinical picture in the chosen specialty. LLaMA3.2-3B then updates the test prioritization, considering the context of that department's typical patient risks and medical standards.\n3) Item Layer: Final Test Recommendations and Weighting: In the final Item layer, a memory component consolidates the intermediate decisions and flagged symptoms to ensure continuity. GPT-01 performs item-level reasoning, identifying the most appropriate diagnostic tests and resolving any inconsistencies or redundancies that might arise from previous layers. The fine-tuned LLaMA3.2-3B model then assigns definitive weights, reflecting the urgency or clinical utility of each test within the broader diagnostic strategy. The system ultimately produces a ranked list of recommended tests, accompanied by interpretive scores that highlight the underlying reasoning and urgency.\n4) Benefits of the Hierarchical Strategy: Breaking down the recommendation process into these three layers enables more targeted retrieval, clearer interpretability, and better alignment with the medical decision-making process. The Root layer effectively broadens the diagnostic net, the Department layer introduces specialist insight, and the Item layer ensures that final test recommendations are both clinically focused and context-aware. The multi-layered approach, combined with a dedicated memory component and weighting mechanism, provides an adaptive framework that accommodates the complexity of real outpatient scenarios while maintaining transparent and consistent medical reasoning."}, {"title": "IV. EXPERIMENTS & RESULTS", "content": "We focused our evaluation on three key departments - cardiology, endocrinology, and gastroenterology - as these specialties frequently encounter complex diagnostic scenarios requiring multiple tests and offer standardized clinical pathways for system validation."}, {"title": "B. Baselines", "content": "We compared HiRMed against several baseline approaches:\n1) Traditional Vector Similarity (TVS): A standard retrieval-based system using cosine similarity between symptom embeddings and test descriptions.\n2) Flat-RAG: A single-layer RAG system that directly maps symptoms to test recommendations without hierarchical reasoning."}, {"title": "C. Evaluation Metrics", "content": "We assessed system performance using the following metrics:\n1) Coverage Rate (CR): The proportion of relevant diagnostic tests included in the recommendations.\n2) Accuracy: The percentage of recommended tests that were deemed appropriate and necessary by reviewing physicians, measured by comparing system recommendations against expert-validated test orders in our ground truth dataset.\n3) Miss Rate (MR): The proportion of critical tests (as determined by physician review) that were not recommended.\n4) Clinical Relevance Score (CRS): Expert-assigned scores (1-5) evaluating the medical appropriateness of recommendations."}, {"title": "D. Results", "content": "Overall Performance Analysis"}, {"title": "V. CONCLUSION", "content": "This paper presented HiRMed, a novel hierarchical RAG-enhanced system for medical test recommendations that successfully addresses several key challenges in automated diagnostic support. Inspired by rigorous reasoning approaches like Chain-of-Thought and Monte Carlo Tree Search in game theory, we demonstrate that hierarchical structures can significantly enhance conventional reasoning tasks. By integrating a tree-structured architecture with RAG-based reasoning and memory augmentation, our system shows that decomposing complex decisions into hierarchical steps can achieve substantial improvements over traditional approaches across multiple performance metrics.\nThe experimental results validate our hierarchical approach, with HiRMed achieving a coverage rate of 92.3% and an accuracy of 88.7%, substantially outperforming baseline methods. Particularly noteworthy is the system's low miss rate of 2.1% for critical tests, addressing a crucial concern in medical diagnosis. The consistent performance across different medical departments, with accuracy rates exceeding 87% in all specialties, demonstrates that hierarchical reasoning can effectively handle diverse and complex scenarios.\nOur ablation studies revealed the essential nature of each architectural component, particularly highlighting the importance of the dual-layer knowledge base and memory augmentation mechanism. The significant performance degradation observed when removing these components confirms that structured, hierarchical reasoning is crucial for maintaining high accuracy and comprehensive coverage in recommendation tasks. Furthermore, the positive clinical validation results, with a Clinical Relevance Score of 4.3/5, underscore that hierarchical decomposition of complex decisions can achieve practical utility in real-world settings.\nLooking forward, this work opens several promising directions for future research in hierarchical reasoning systems. First, the architecture could be extended to incorporate real-time learning from physician feedback, allowing continuous refinement of the hierarchical decision process. Second, the system could be adapted to handle more complex scenarios involving multiple comorbidities and rare disease presentations. Finally, investigating the integration of temporal patient data could enhance the system's ability to perform multi-scale hierarchical reasoning across different time horizons.\nHiRMed represents a significant step forward in both medical test recommendation systems and hierarchical reasoning approaches, demonstrating that combining tree-structured architectures with RAG-enhanced reasoning can effectively bridge the gap between general knowledge and specialized requirements. The system's success in maintaining both high accuracy and low miss rates, while providing interpretable recommendations, suggests that hierarchical reasoning could be a powerful paradigm for improving complex decision-making systems across various domains beyond healthcare."}]}