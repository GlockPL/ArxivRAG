{"title": "Time Series Treatment Effects Analysis with Always-Missing Controls", "authors": ["Juan Shu", "Qiyu Han", "George Chen", "Xihao Cao", "Kangming Luo", "Dan Pallotta", "Shivam Agrawal", "Yuping Lu", "Xiaoyu Zhang", "Jawad Mansoor", "Jyoti Anand"], "abstract": "Estimating treatment effects in time series data presents a significant challenge, especially when the control group is always unobservable. For example, in analyzing the effects of Christmas on retail sales, we lack direct observation of what would have occurred in late December without the Christmas's impact. To address this, we try to recover the control group in the event period while accounting for confounders and temporal dependencies. Experimental results on the M5 Walmart retail sales data demonstrate robust estimation of the potential outcome of the control group as well as accurate predicted holiday effect. Furthermore, we provided theoretical guarantees for the estimated treatment effect, proving its consistency and asymptotic normality. The proposed methodology is applicable not only to this always-missing control scenario but also in other conventional time series causal inference settings.", "sections": [{"title": "1 Introduction", "content": "Time series treatment effect estimation holds importance in a variety of practical applications: policy changes, marketing campaigns, and seasonal event monitoring (e.g. holidays). A significant challenge arises when the control group is inherently always unobservable. For example, we cannot observe consumer behavior during Independence Day in absence of the holiday itself. Practitioners must rely on data from non-holiday periods to learn about the control group's properties, making it essential to develop methodologies that can accurately estimate treatment effects under these constraints.\nOur work addresses a critical challenge in the context of causal inference for time series, where the control group is always unobservable during the treatment"}, {"title": "2 Methodology", "content": null}, {"title": "2.1 Preliminaries", "content": "We aim to estimate the causal effect of rare events in time series data. A rare event, denoted by R, is characterized by a window of size |TR| = d, where d is negligible relative to the overall observation period. In this study, the rare events of interest recur annually within the same time window. Holidays serve as a typical example of such events in our context. Following the notation convention in the potential outcomes framework ([14]), we denote $Y_{t}(1)$ for any $t \\in T_{R}$ as the observed time series during the event period. Conversely, $Y_{t}(0)$ for any $t \\notin T_{R}$ represents the time series observations during the non-event period."}, {"title": "2.2 Estimating synthetic control", "content": "Statistical models and deep learning models are primarily designed to capture the main signal from input data, often leaving anomalies in the residuals. This characteristic is essential for many anomaly detection techniques. For example, confidence interval-based methods fit models with uncertainty quantification, flagging anomalies when new data points fall outside the predetermined range. Similarly, autoencoders assess reconstruction errors, identifying anomalies as data points that are difficult to accurately reconstruct. These anomaly detection techniques are not only useful for identifying outliers but also offer insights into constructing synthetic controls which serve as a baseline to compare with the impact of interventions or events. By analyzing the residuals or reconstruction errors, we can estimate what the expected \"normal\" behavior should be under specific conditions. This methodology can then be extended to create synthetic controls, which serve as a baseline to compare and assess the impact of interventions or events.\nFormally, we trained a deep learning model with an adaptive loss function to adjust the loss landscape in rare even regions. We then performed in-sample forecasts to extract the synthetic control. The estimated synthetic control can be expressed as:\n${Y_{i,t}(0)}_{t\\in T_{R}} = f_{\\theta}(X_{tr}), (1)$ where $f_{\\theta}()$ is the trained deep learning model parametrized by $\\theta$, with adaptive loss function defined in (2). $X_{tr}$ is the training data. ${Y_{i,t}(0)}_{t\\in T_{R}}$ s the estimated synthetic control during rare event region R."}, {"title": "2.3 Temporal Adaptive loss", "content": "A rare event usually has larger loss compared with non-rare events region. Therefore, in order to ensure a good landscape of loss function, and capture the synthetic control more accurately, we train the model with a temporal adaptive loss function defined in (2)."}, {"title": "3 Theoretical Properties", "content": "In this section, we provide a detailed illustration of the methodology using a time series that follows an AR(1) model during the non-event period. It is important to note that the AR(1) model is used solely as a simplified example for theoretical development. However, the theoretical guarantees remain valid when extended to an ARIMA(p, \u0394, q) model with fixed values of p, \u0394, and q."}, {"title": "3.1 Model Specification for Treatment Effect", "content": "Consider N independent time series ${Y_{i,t}}_{t=1}^{T}$, where i = 1,..., N indexes the each series and t = 1, ..., T indexes time periods. The model can be written as\n$Y_{i,t} = \\phi Y_{i,t-1} + \\epsilon_{i,t}, (3)$ where t = 1,..., $T_{0}$, for $T_{0}$ represents the last time step before the holiday, and $\\epsilon_{i,t}$ denote random noise. During the holiday/treament period (t = $T_{0}$+ 1,..., $T_{0}$ + d), the observation $Y_{i,t}$ is given by\n$Y_{i,t} = Y_{i,t}(1) = Y_{i,t}(0) + \\delta_{t}, (4)$"}, {"title": "3.2 Forecasting Counterfactual Outcomes and Estimating the Treatment Effects", "content": "With $\\hat{\\phi}$ estimated, we forecast the counterfactual outcomes $\\hat{Y}_{i,t}(0)$ for the treatment period, representing what the outcomes would have been in the absence of treatment. At time t = $T_{0}$, we have $Y_{i,T_{0}}(0) = Y_{i,T_{0}}$, then for t = $T_{0}$+1,...,$T_{0}$+d we estimate the center factual by\n$\\hat{Y}_{i,t}(0) = \\hat{\\phi} \\hat{Y}_{i,t-1}(0)$.\nIntuitively, using the AR(1) model estimated from the pre-treatment data, we project the expected trajectory of the counterfactual control group. The recursive aspect arises from the fact that only data from outside the holiday period is employed to estimate the parameters. We then use the estimated $\\hat{\\phi}$ to iteratively forecast the counterfactual values within the holiday period.\nWith the estimation of $\\hat{\\phi}$ along with the estimation of the counterfactual outcome, the treatment effect at each time t \u2208 $T_{R}$ is estimated by comparing the observed outcomes to the forecasted counterfactuals. Specifically, we have For each t = $T_{0}$ + 1, ..., $T_{0}$ + d:\n$\\hat{\\delta}_{t} = \\hat{Y}_{t} - \\hat{Y}_{t}(0) = \\frac{1}{N} \\sum_{i=1}^{N}(Y_{i,t} - \\hat{Y}_{i,t}(0)), (5)$ where $\\hat{Y}_{t} := (1/N) \\sum_{i=1}^{N} Y_{i,t}$ is the sample mean of the observed outcomes, and $\\hat{Y}_{t}(0) := (1/N) \\sum_{i=1}^{N} \\hat{Y}_{i,t}(0)$ is the sample mean of the estimated counterfactual outcomes. Therefore, $\\hat{\\delta}_{t}$ represents the estimated average effect of the treatment at time t over N independent series."}, {"title": "3.3 Theoretical Guarantees", "content": "In this section, we provide the theoretical guarantees for the estimation of causal effects when the AR(1) model is specified. In particular, we establish the asymptotic normality of $\\hat{\\delta}$, and assume the following."}, {"title": "4 Experiment", "content": "We used the Walmart retail sales dataset to evaluate the effectiveness of our method in estimating holiday treatment effect during several holidays. We try to answer the following questions with the experiments:\nDoes our construction of the synthetic control via in-sample forecast perform better than the out-of-sample forecast?\nDoes the estimated synthetic control have the consistency across different years, which empirically supports our established statistical property.\nCan estimated synthetic control be generalized well empirically?\nCan the method be applicable to different holidays, while preserving decent robustness and accuracy?"}, {"title": "4.1 Setup", "content": "The Walmart M5 data are accessible at UNIC website. Original data, provided at the item level, were aggregated to the department level. Additionally, we combined data from three geographical regions: California, Texas, and Wisconsin. This resulted in six daily time series from January 2011 to April 2016, each representing a specific department. Our backbone model is NHITS [10]. The forecast horizon is 30 days and the lookback window is 90 days. We used the Python package Neuroforecast (1.2) and Statsmodels (0.14) in the experiments.\nTo the best of our knowledge, there are no methods that designed to handle the causal inference problem in always-missing control scenario in time series analysis. However, we did several ablation studies to further demonstrate the effectiveness of our methods.\nDirect forecast (DF) : Instead of including the holiday period in the training, we use the data till the start of the holiday as training and forecast the synthetic control within the holiday period using NHITS model.\nSeasonality decomposition (SD): As holidays are an annual event, we use MSTL [5] to decompose the time series and try to extract the yearly seasonality corresponding to each holidays and use the extracted yearly seasonality as estimation of the sales during holiday period."}, {"title": "4.2 Consistency of Estimated Synthetic control", "content": "Figure 1 illustrates the experimental results for Thanksgiving (A) and Christmas (B) over multiple years and departments. Each row represents one department. We can see from the first two columns in Fig.1(A) and Fig.1(B) that the estimated synthetic control remains consistent across years, demonstrating that our assumption, namely, that the model effectively captures the main signal and is robust to anomalies, holds true in this scenario. The significant deviation between the synthetic control and the observed values is attributed to the holiday impact, which also exhibits a consistent pattern over the years."}, {"title": "4.3 Holiday impact Prediction", "content": "We further evaluate the accuracy of estimated treatment effect using 2015 as test data. To account for the multiplicative property of time series, we first calculate the holiday impact ratio $r_{i \\in \\{2012,2013,2014\\}}$ by dividing the estimated treatment effect by their year-specific scale $C_{i \\in \\{2012,2013,2014\\}}$, where $C_{i}$ can be any monthly aggregation to reflect the scale of that year. The average holiday impact ratio $\\bar{r}$ from 2012 to 2014 was then used as the estimated holiday impact ratio for 2015, and $\\bar{r} \\times \\hat{C}_{2015}$ will be used as the estimated holiday effect for 2015. The figures in the third columns of Fig.1(A) and Fig.1(B) demonstrate the accurate forecast for Thanksgiving and Christmas. We also compared MAPE between different methods and it is evident that our method can achieve a significant improvement, as shown in Table 1. These results align with our intuition that seasonality decomposition-based approaches are sensitive to other confounders in the time series, as many holidays do not exhibit exact periodicity. Out-of-sample forecasts of synthetic control within holiday regions are heavily dependent on the stationarity assumption, which limits their applicability in real-world scenarios."}, {"title": "5 Conclusion", "content": "In this paper, we address the challenging problem of estimating treatment effects in time series data when the control group is always unobservable during the treatment period, a common scenario such as evaluating the impact of holidays on retail sales. We developed an innovative estimation framework for imputing the always-unobserved control group. We also provided the asymptotic analysis of the treatment effect. Our experimental results demonstrated the robustness and accuracy of our method in capturing impact of events."}, {"title": "Disclosure of Interests", "content": "There is no conflict of interests."}, {"title": "Appendix", "content": "Proof of Theorem 1\nTo make the proof go smoothly, we first introduce a necessary lemma that can facilitate this proof.\nLemma 1. Let $\\hat{\\phi}$ be the Ordinary Least Squares (OLS) estimator of $\\phi$ based on the observations $\\{Y_{i,t}\\}_{t=1}^{T_{0}}$ for i = 1,..., N. Then, as N \u2192 \u221e (with $T_{0}$ fixed), $\\hat{\\phi}$ is a consistent estimator of $\\phi$, and moreover,\n$\\hat{\\phi} - \\phi = O_{p}(N^{-1/2}).$"}]}