{"title": "Predicting Subway Passenger Flows under Incident Situation with Causality", "authors": ["Xiannan Huang", "Shuhan Qiu", "Quan Yuan", "Chao Yang"], "abstract": "In the context of rail transit operations, real-time passenger flow prediction is essential; however, most models primarily focus on normal conditions, with limited research addressing incident situations. There are several intrinsic challenges associated with prediction during incidents, such as a lack of interpretability and data scarcity. To address these challenges, we propose a two-stage method that separates predictions under normal conditions and the causal effects of incidents. First, a normal prediction model is trained using data from normal situations. Next, the synthetic control method is employed to identify the causal effects of incidents, combined with placebo tests to determine significant levels of these effects. The significant effects are then utilized to train a causal effect prediction model, which can forecast the impact of incidents based on features of the incidents and passenger flows. During the prediction phase, the results from both the normal situation model and the causal effect prediction model are integrated to generate final passenger flow predictions during incidents. Our approach is validated using real-world data, demonstrating improved accuracy. Furthermore, the two-stage methodology enhances interpretability. By analyzing the causal effect prediction model, we can identify key influencing factors related to the effects of incidents and gain insights into their underlying mechanisms. Our work can assist subway system managers in estimating passenger flow affected by incidents and enable them to take proactive measures. Additionally, it can deepen researchers' understanding of the impact of incidents on subway passenger flows.", "sections": [{"title": "1. Introduction", "content": "The subway system is a critical component of the transportation network in metropolitan areas due to its environmental benefits, efficiency, and reliability. Understanding passenger flow patterns within these systems is essential for enhancing operational efficiency and user satisfaction. While much research has focused on typical operating conditions, there is a significant gap in addressing unusual situations, such as incidents. Analyzing and predicting how incidents impact passenger flows is vital for subway operators to implement proactive strategies. For instance, some studies have concentrated on emergency bus bridging and dis-patching models during subway incidents [47, 39], considering the affected passenger numbers as inputs for their models. Consequently, we aim to fill this gap in our paper by proposing a method to interpret the influence of incident on OD (origination- destination) passenger flows and predict the passenger flows under incident situation.\nThere are several papers [54, 26] that focus on predicting passenger flows in subway sys-tems, treating incidents as input features. Since incidents are characteristics of the inputs, these models can predict passenger flows under both normal and incident conditions. They demonstrate improved predictive power and provide valuable insights. However, these mod-els employ complex deep learning methods and end-to-end structures, which obscure the mechanisms by which incidents affect passenger flows. Furthermore, it can be challenging for these models to learn patterns related to incidents in depth, as the number of incidents in subway systems is typically small. Additionally, the imbalance between the volume of data in normal and incident situations may lead to the model to prioritize normal conditions, hindering its ability to adequately learn the rules governing incident situations. Finally, the criteria for determining which OD flows are influenced by incidents have not been thoroughly discussed. Some methods [54] assume that the influenced OD flows occur during the incident period and the shortest paths of them include the incident stations. But this assumption is too simple and contradicts reality, for example, even though an incident ends, the effects of it may still persist. And we will elaborate it in the experiment section.\nTo address these gaps, we propose a two-stage method for predicting passenger flow during incidents, as illustrated in Figure 1. First, a model trained with passenger flow data under normal conditions can be utilized to predict the OD flows that would occur in the absence of an incident. Subsequently, another model can be employed to predict the causal effects of the incident on passenger flows. These causal effects can then be incorporated into the normal OD flow predictions to obtain the final predictions. Besides, these causal effects can also be feed into emergency bus bridging and dispatching models [47, 39] to generate an appropriate bridging bus plan.\nThis two-stage approach effectively addresses the aforementioned challenges to some ex-tent. For instance, it offers a significant advantage in interpretability: it allows for a detailed analysis of the underlying mechanisms by which incidents impact passenger flows, as the incident model is separated. In contrast, an end-to-end model functions more like a \"black box,\" making it difficult to analyze the underlying mechanism. Furthermore, in a two-stage framework, high-quality data can be selectively utilized to calibrate the incident model, enhancing its ability to capture incident patterns. This process is more challenging for end-to-end models, as the incident data is often obscured within the normal data. Finally, our method provides flexibility, as each stage can be independently improved. For instance, if a more accurate normal OD prediction model becomes available in the future, it can be directly integrated into the first stage of our method.\nIn order to complete our prediction method, we will encounter the following four chal-lenges: First, we need to develop an OD prediction model under normal conditions. Second, we must identify the causal effects of incidents on passenger flows using historical data. Third, we need to calibrate a causal effect prediction model based on the identified causal effects. Finally, we must integrate the results from the normal condition prediction model with those from the causal effect prediction model to derive the final predicted OD flows."}, {"title": "2. Related Work", "content": "Research about evaluating the effects of incident on subway systems can be broadly categorized into two main areas: network vulnerability or robustness and the impacts of incidents on passenger flows."}, {"title": "2.2.1. Network vulnerability", "content": "The majority of studies in this category utilize simulation-based methods or approaches grounded in complex network theory. These methodologies often focus on evaluating network redundancy and robustness. Complex network-based methods conceptualize the subway net-work as a graph, with stations as nodes and the connections between them as edges. By systematically removing nodes or edges, new graphs are generated, and researchers analyze changes in various coefficients that reflect the network's structure or passenger travel con-venience [7] This allows for the assessment of incident impacts in different regions and the overall resilience of the subway network.\nFor instance, [49] analyzed Shanghai's subway network by removing stations or intervals and evaluating changes in network efficiency, network size, average node centrality, and average edge centrality. This helped determine the vulnerability of specific intervals and assess the network's overall robustness. Similarly, [48] used changes in network efficiency-related coefficients before and after node and edge deletions to evaluate the vulnerability of subway networks in several cities. Other notable studies include [30, 38]. [51] proposed various indicators to reflect network vulnerability, using concepts from causal inference and actual data to evaluate changes in these indicators under normal and incident scenarios.\nAdditionally, some research incorporated network passenger flow into models to evalu-ate the effects of incidents on subway networks [25, 20]. Simulation-based methods were often employed to mimic passenger travel behavior under incident conditions, enabling the evaluation of passenger losses such as increased travel time and congestion costs [29]. And some work considered the cascading failure caused by one incident [28, 34] to evaluate the robustness of subway network, and found the some vulnerable stations or intervals. Further-more, some articles proposed using simulations to quantify the spillover effects of incidents in specific intervals [45]."}, {"title": "2.2.2. Incidents effect on passenger flows", "content": "Some studies have utilized passenger flow prediction models to evaluate the effects of incidents. For example, [35] developed a prediction model for subway passenger flow in London based on normal conditions. This model can predict expected passenger flow in the absence of an incident, so this passenger flow can server as a counterfactual value to quantify the impact of subway incident. According to this thought, Other models designed for short-term passenger flow prediction, such as PVGCN [18] and MPSTN [14], could also be adapted to assess the effects of incidents on subway stations.\nBesides, [54] created an OD prediction model using smart card data, incorporating inci-dents as an independent variable. This model can calculate OD values under both incident and non-incident conditions, with the difference indicating the impact of subway incidents on passenger flows. Additional studies have developed specific prediction models for passenger flow during incidents, comparing these results with normal conditions to gauge the impact [42, 43, 24]. Simulation-based approaches have also been used to estimate passenger flow at stations during incidents, thereby evaluating the impact at various stations [44, 36].\nFurthermore, [52] utilized real operational data and causal inference methods to assess the effects of subway system disruptions on station passenger flows, highlighting the spillover effects of some disruptions.\nSeveral studies have also analyzed and predicted individual passenger behaviors during"}, {"title": "2.3. Summary", "content": "In summary, very few studies address passenger flow prediction for subway systems un-der incident conditions. And these existing works primarily apply deep learning models, often with simplistic assumptions about which passenger flows are impacted by subway in-cidents. These studies do not delve into how incidents affect passenger flows in detail, and the interpretability of their models is generally limited.\nMoreover, most existing literature about the impact of incidents on subway systems focuses on network vulnerability, often relying on simulations or complex network methods that may not fully reflect real-world subway operations. Besides, their research questions are pretty different compared with the questions proposed in this work. Some studies evaluate the impact of incidents on passenger flow using predictive models, comparing predicted normal conditions with actual passenger flow during incidents. However, these studies lack analysis from causality. Besides, they can only calculate these differences after incidents ended."}, {"title": "3. Method", "content": "Our method consists of three parts: causal effect estimation, causal effect prediction model calibration and normal prediction adjustment. We will elaborate them in the following part."}, {"title": "3.1. Causal effect estimation", "content": "We have observed that some research focuses on identifying the causal effects of highway incidents on traffic state [16], and they used double robust or inverse propensity weighting methods to address selection biases, i.e., whether an incident happens is related to the influ-ence factors of traffic state. However, incidents in subway systems differ significantly from those on highways, with one of the most notable differences being the number of incidents. The frequency of incidents in subway systems is considerably lower than that in highways. Furthermore, for a specific OD, not all incidents will have an impact on it. Consequently, the number of incidents affecting a specific OD may be even smaller. Therefore, the adjustment of selection biases may be unnecessary. But we require a method to address the issue of having only a limited number of experimental samples.\nWe use the synthetic control method [2] to calculate counterfactual values and obtain causal effects. This method is widely applied in empirical research within economics and social sciences [1] when only a few samples are intervened. Following the algorithm proposed in [2], we design our approach to estimate the causal effects. But at first, we will give some notations."}, {"title": "Definition of variables", "content": "Assuming we have a dataset containing n days, with each day divided into m time intervals, let $x_{i,j}$ represent the passenger flow for a specific OD on day i during time interval j. Here, $x_{l,k}^1$ denotes the passenger flow during normal conditions, while $x_{l,k}^0$ indicates the flow after an incident occurs. For simplicity, we assume only one incident occurs in the k-th time interval of day l (our method can be easily generalized to multiple incident situation). Thus, the observed data for a specific OD can be expressed as:\n\\[\n\\begin{array}{ccccccccc}\nX_{1,1} & X_{1,2} & \\dots & x_{1, k-1} & x_{1,k}^0 & x_{1,k+1} & \\dots & x_{1, m} \\\\\nX_{2,1} & X_{2,2} & \\dots & x_{2, k-1} & x_{2,k}^0 & x_{2,k+1} & \\dots & X_{2, m} \\\\\n\\vdots & \\vdots & & \\vdots & \\vdots & \\vdots & & \\vdots \\\\\n\\hline\nX_{l-1,1} & X_{l-1,2} & \\dots & x_{l-1,k-1} & x_{l-1, k}^0 & x_{l-1,k+1} & \\dots & X_{l-1, m} \\\\\n\\hline\nX_{l,1} & X_{l,2} & \\dots & x_{l,k-1} & x_{l,k}^1 & x_{l,k+1} & \\dots & X_{l, m} \\\\\n\\hline\nX_{l+1,1} & X_{l+1,2} & \\dots & x_{l+1,k-1} & x_{l+1,k}^0 & x_{l+1,k+1} & \\dots & X_{l+1, m} \\\\\n\\vdots & \\vdots & & \\vdots & \\vdots & \\vdots & & \\vdots \\\\\nX_{n,1} & X_{n,2} & \\dots & x_{n, k-1} & x_{n,k}^0 & x_{n,k+1} & \\dots & X_{n, m}\n\\end{array}\n\\]\n(1)\nAnd we want to estimate: $x_{l,k}^0 -x_{l,k}^1, x_{l,k+1}^0 - x_{l,k+1}^1,...,x_{l,m}^0 - x_{l,m}^1$. It is important to note that $x_{l,k}^1$ is observed, while $x_{l,k}^0$ is not. The latter term represents a counterfactual value in the context of causal inference.\nAdditionally, let $a_{i,j}$ denote the influencing factors for $x_{i,j}$, such as whether day i is rainy, whether it is a weekend, and passenger flow numbers from previous intervals. We assume the dimension of $a_{i,j}$ is d.\nThe process for synthetic control can be summarized as: synthetic the unobserved $x_{l,k}^0$ using observed $x_{i,k}^0$, as illustrated in Figure 2, and we will explain this process using the calculation of $x_{l,k}^0$ as an example.\nIn our setting, $x_{i,k}^0$ is observed for $i \\in {1, 2, ..., l - 1, l + 1,...,n}$. We estimate $x_{l,k}^0$ using the following formulation:\n\\[\nX_{l,k}^0 = \\sum_{i\\in{1,2,...,l-1,l+1,...,n}} W_i \\times X_{i,k}^0\n\\]\n(2)\nwhere each $w_i$ is in [0,1] and $\\Sigma_i w_i = 1$. This means that if there was no incident on day 1, the passenger flow on that day would approximate a weighted-sum of passenger flow numbers on other no-incident days. In other words, we synthesize counterfactual data using observed data, with \"synthetic\" referring to the weighted sum. For convenience, we use W to signify the vector composed of all $w_i$'s: $W = (W_1, ... W_{i-1}, W_{i+1}, ..., W_n) \\in R^{n-1}$. The challenge then becomes determining $w_i$. Recall that a d-dimensional vector $a_{i,j}$ is defined to represent the influence factors of $x_{i,j}$. Therefore, the target of determining W is to make the variable a of the synthetic sample more similar to the a in day l. Let A be the matrix of all $a_{i,j}$'s where $i \\in {1, 2, ..., l - 1,l + 1, ..., n}$. Thus, $A \\in R^{n-1,d}$. Then W can be determined as:\n\\[\nW = arg\\ min_W ||a_{l,k} - WA|| = \\sqrt{(a_{l,k} - WA)^T(a_{l,k} - WA)}\n\\]\n(3)\nBut the importance of each dimension in a may not be equal. As a result, [1] propose to use V-norm instead of $l_2$ norm and we follow this setting in our method. So W is determined"}, {"title": "Calculating W", "content": "by:\n\\[\nW = arg\\ min_W ||a_{l,k} - WA||_V = \\sqrt{(a_{l,k} - WA)^TV(a_{l,k} - WA)}\n\\]\n(4)\nwhere V is a d \u00d7 d positive diagonal matrix. Equation 4 means the influence factors of syn-thetic counterfactual data, i.e., WA, are similar to the influence factors of actual counterfac-tual data $a_{l,k}$. The matrix V represents the importance of each dimension in a. According to [1], V can be chosen to minimize the prediction error in previous t time intervals, as the following Equation 5 shows:\n\\[\nV = arg\\ min_V ||XW(V) - X_0||\n\\]\n(5)\nwhere $X_0$ is a t-dimensional vector, $X_0 = (x_{l,k-t}, x_{l,k-t+1},...,x_{l,k-1})$, and X is a matrix with shape t \u00d7 (n \u2212 1), the i-th column of X representing the passenger flow number in time intervals k - t to k \u2212 1 of day i. W(V) is the function mapping V to W, as defined by Equation 4. For more details, interested readers can refer to [1]. Finally, the causal effect can be estimated as $x_{i,k}^0 - x_{i,k}^1$.\nSome readers may question that why we do not choose to fit a model form a to $x^0$ directly but use such a complicated process. This is because directly fitting model could meet the problem of extrapolation and results in inferior performance, this phenomenon has been discussed by [3] and interested readers can refer to it."}, {"title": "3.2. Causal effect prediction model", "content": "Even though we can identify the causal effects of incidents on OD flows, these effects are determined only after the incidents have ended and cannot be directly applied to the actual operation of the subway system. Therefore, we need a prediction model to predict the causal effects of incidents on passenger flows immediately after an incident occurs."}, {"title": "3.2.1. Feature selection", "content": "First, it is necessary to identify the factors influencing the causal effects. On one hand, the severity of an incident is believed to impact these causal effects. It is reasonable to assume that more severe incidents have a greater potential to affect a larger number of ODs and result in more significant consequences. We have selected six primary indicators to quantify severity: the maximum delay time caused by the incident, the number of trains delayed by five minutes or more, the number of canceled trains, the number of trains that have cleared all passengers, the number of affected stations, and the overall duration of the incident.\nOn the other hand, the relationship between the ODs and the incident, in both spatial and temporal dimensions, is also considered to influence the causal effects. In the spatial domain, we consider several indicators: the distance from the origin station to the incident interval (where distance is defined as the number of stations on the shortest path, and this definition applies to subsequent distances as well), the distance from the destination station to the incident interval, and the proportion of the shortest path between the origin and destination that overlaps with the incident interval. These indicators reflect the spatial relationship between the ODs and the incident. In the temporal domain, we select the time difference between the OD time and the occurrence of the incident, the time difference between the OD time and the end of the incident, and whether the OD time falls within the duration of the incident. Finally, if the OD originally experiences a higher passenger flow, the causal effect may be more pronounced. Consequently, the counterfactual flow $x_0$ is also selected.\nIt is important to note that certain indicators, such as the delay time caused by an incident, the number of trains delayed by five minutes or more and the overall duration of the incident, can only be obtained after the incidents have concluded. Consequently, these indicators cannot be accessed when predicting causal effects. However, we believe this is not a significant issue, as experienced staff in the subway system can generally extrapolate these indicators based on the type or other characteristics of the incident. Additionally, the severity of the incident must be considered when predicting its causal effects; therefore, we have no choice but to include these indicators. In future work, features related to the types of incidents and the degree of damage to facilities could be considered as indicators of incident severity, and these features can be obtained immediately after an incident occurs. A description of the selected features is provided in Table 1."}, {"title": "3.2.2. Sample selection", "content": "According to the formal section, we can calculate the causal effects for all OD pairs and all time intervals for an incident. However, these differences are not solely attributable to the incident; some may be influenced by random effects. For example, an incident situation is show in Figure 3, and this incident may clearly impact the passenger flow from station A to station B, but the effect on the passenger flow from station C to station B may be less apparent. Although the difference between the counterfactual and observed passenger flow from station C to station B can indeed be calculated, it is essential to determine whether this difference is due to random effects or the incident itself. Therefore, it is necessary to select the significantly affected passenger flows, as illustrated in the upper part of Figure 4."}, {"title": "3.2.3. Significant test", "content": "Judging a causal effect is truly because of incident or because of randomness is a classical significant test problem. And we will elaborate it in the following part.\nFirst, our null hypothesis is:\n\\[\nH_0: x_{i,k}^0 = x_{l,k}^1\n\\]\n(6)\nThis null hypothesis means the actual OD flow under incident $x_{i,k}^1$ is the same as the coun-terfactuals OD flow in normal situation $x_{l,k}^0$. Therefore, the calculated causal effect, i.e., $x_{l,k}^0 - x_{i,k}^1$, is because of randomness. We use a placebo test to construct the test statistic [2] and determine whether to reject the null hypothesis. If the null hypothesis is rejected, then we can regard this causal effect is different from zero significantly. The placebo test is widely used, distribution-free and similar to the permutation test. We will elaborate it as follows.\nRecall the method from the causal effect estimation section, we use $(a_{i,k}, x_{i,k}^0)$ for $i \\in {1, 2, ..., l - 1,l + 1, ..., n}$ and $a_{l,k}$ to infer $x_{l,k}^0$. Let f represent this process. Besides, let S denote the set ${(a_{i,k}, x_{i,k}^0) | i \\in {1, 2, ..., n}}$, and $S_{-i}$ denote the set obtained by removing $(a_{i,k}, x_{i,k}^0)$ from S. Thus, we have:\n\\[\nx_{1,k}^0 = f(S_{-l}, a_{l,k})\n\\]\n(7)\nThen we define $e_l = |x_{l,k}^1 - x_{l,k}^0| = |x_{l,k}^1 - f(S_{-i}, a_{i,k})|$, where $x_{l,k}^1$ represents the observed passenger flow. Specifically, $x_{i,k}^0 = x_{i,k}^1$ when i = 1, and $x_{i,k}^0 = x_{l,k}^1$ on other days. Therefore, $e_1, e_2,..., e_n$ can be calculated according to our definition.\nIntuitively, if the null hypothesis is true, which means $x_{l,k}^0 = x_{l,k}^1$, then all the $(a_{i,k}, x_{i,k}^0)$ follow the same rule since all $x_{i,k}^0$ equal to $x_{l,k}^1$. Consequently, each error term $e_i$ will follow the same distribution. The order of $e_i$ is equally likely to be in any position from 1 to n. In another word, if $e_l$ is extremely large, for example, the largest among all $e_i$, it indicates a low probability event happens. Thus, the order of $e_i$ can be viewed as a test statistic to control the type 1 error in the significance test, i.e., to control the significance level.\nLet $order(e_l)$ denote the order of $e_l$ among $e_1, e_2,..., e_n$. For example, $order(e_i) = n$ means $e_l$ is the largest element. Then we can use $order(e_l)$ to construct p-value as:\n\\[\np=1-\\frac{order(e_l)}{n}\n\\]\n(8)\nIf the significance level we want to control is $a$ (which is $p_1$ in Figure 4) and p < a, we will reject $H_0$ and conclude that the incident significantly influenced the passenger flow."}, {"title": "3.3. Prediction adjustment", "content": "In practical forecasting tasks, we first utilize a conventional passenger flow prediction model to obtain passenger flow under normal conditions. Subsequently, we utilize a causal effect prediction model to derive the predicted causal effects of specific incident. These causal effects are then used to adjust the passenger flow predictions from the normal model, resulting in passenger flow forecasts under incident conditions. In this section, we concentrate on how to use the causal effect prediction model to correct normal predictions. This approach may seem somewhat peculiar, as one might assume that adjustments could simply be summed together. However, our research underscores the importance of determining which normal predictions should be adjusted.\nTaking the example illustrated in Figure 3, it is evident that the passenger flow from station A to station B is likely to be significantly affected by an incident. Therefore, we need to add the causal effect to the predicted passenger flow for the OD from station A to station B. However, the passenger flow from station C to station B raises questions. Should we also adjust the passenger flow for this OD? This remains uncertain, and thus we need to ascertain which passenger flows require adjustment.\nWe use the following strategy to adjust OD flow prediction: If there are many ODs and these ODs are affected by an incident with different probability according to relationship between these ODs and the incident. Then we note the probability of a specific OD to be affected by the incident is p. Then the strategy is: First determining a threshold P (which is 1-$\\rho_2$ in Figure 4), for each OD, if the probability of the OD to be affected by the incident, i.e., p, is greater than P, we will use causal effect prediction model to adjust it, otherwise we will just regard the prediction of normal model as the final prediction value, as shown in Figure 4. Then we can obtain the risk of this strategy.\nIf the influence factors about the causal effects is noted as x, the causal effect is donated as y, assume y and x obeys the following rule:\n\\[\ny = \\epsilon_1 with probability 1 - p \\\\\ny = \\epsilon_1 + (f(x) + \\epsilon_2) with probability p\n\\]\nWhere $\\epsilon_1$ following normal distribution $N(0, \\sigma^2_1)$ and $\\epsilon_2$ following normal distribution $N(0, \\sigma^2_2)$, $\\beta$ is the parameter and p is a constant between 0 and 1. If there are a lot of samples $(x_i, p_i)$ and a prediction model\n\\[\n\\hat{y} = f(x)\n\\]\nThen we can get the risk of the above strategy.\n\\[\nE (y - \\hat{y})^2 = \\frac{1}{2}P^2(Ef (x)^2 + E\\hat{f} (x)^2 - E (f (x) - \\hat{f} (x))^2) - PE\\hat{f} (x)^2 + c\n\\]\nWhere c is a constant. and the expectation is taken over x and $\\epsilon_1, \\epsilon_2$.\nThe risk is a quadratic function of P, then to obtain the minimum risk, we should set P as:\n\\[\nP=\\frac{Ef \\hat{f} (x)^2}{Ef \\hat{f} (x)^2 + E\\hat{f} (x)^2 - E (f (x) - \\hat{f} (x))^2}\n\\]\n(9)"}, {"title": "More analysis of Theorem", "content": "Some detailed analysis of this theorem is given as follows. First, when $f(x) = \\hat{f} (x)$, which means the causal effect prediction model is completely correct, then we have P = 1/2. This strategy means that if we know the probability for an OD to be affected by an incident is great than 0.5, we will use the causal effect prediction model to adjust this OD passenger flow, otherwise, we will not adjust it. Besides, when $E (f(x) - \\hat{f} (x))^2$ is smaller, in other words, the mean square error of causal effect prediction model is smaller, the best P could be smaller. This rule means more samples can be adjusted if the model is more accurate and it also conforms intuition. Finally, when the magnitude of causal effect, i.e. $Ef \\hat{f} (x)^2$, is greater, the P should be set to a smaller value, which means more samples should be adjusted.\nBesides, the probability of a specific OD to be affected by the incident, i.e., $p_i$, is not known, but we can use the p-value in history data (calculated by significant test section) and some influence factors to fit a model to predict p. As a result, the workflow of training and deploying the causal effect prediction model could be shown in Figure 4, and $p1, p2$ in the figure are thresholds used to select training samples and samples need correction."}, {"title": "4. Experiments", "content": "The data utilized in our study is derived from the Shanghai subway system, one of the largest and most complex subway networks in China, which comprises 20 lines and 508 stations.\nThe first part comprises OD data from the Shanghai subway system. The timing of ODs is determined by the exit time, with a temporal granularity of thirty minutes. The data covers the period from January 1, 2024, to March 24, 2024. We excluded data from the New Year's holiday and the Chinese New Year period because their unique passenger flow patterns differ significantly from those of regular weekdays.\nThe second part of our dataset includes incident records from the Shanghai subway system. These records provide a detailed description of each incident, including the start time, end time, maximum delay caused by the incident, the number of canceled trains, and other relevant information.\nMost incidents in our dataset had minimal impact, resulting in no or insignificant delays. Consequently, we only selected those incidents that caused delays exceeding five minutes. Additionally, we excluded incidents that occurred during the early morning hours, such as those involving the first train of the day, as passenger flow during these times is inherently low, rendering the analysis less meaningful. Ultimately, we identified six eligible incidents, with the last incident in our dataset occurring on March 14th. Our objective is to utilize the data prior to March 14th to build models that predict passenger flow on that day. It is noted that the incident began at 7:15 a.m. and ended at 9:24 a.m.; therefore, our focus is to predict passenger flows between 7:00 a.m. and 12:30 a.m. Given that the incident occurred in suburban sections, OD pairs whose origin and destination stations are not located on the incident line are unlikely to be affected. Therefore, our analysis concentrates on ODs with at least one station (either the origin or destination) located on the incident line."}, {"title": "4.2. Causal effect identification results", "content": "The details in causal effect identification are first explained. As previously mentioned in Equation 4 of Method section, we need to consider several influencing factors a for an OD. In this paper, we use weather conditions (whether it is sunny), whether it is a weekend, and historical passenger flow volume from the previous two time periods as a. Similarly, when we determine V using Equation 5, we also rely on historical data from the previous two time periods to construct $X_0$ and X. The significance level used in our analysis is 0.05.\nThe effect of an incident typically increases with its onset and gradually dissipates as the incident ends. Consequently, we analyze all OD pairs from the beginning of an incident until three hours after its end. Using the model proposed in the Method section, we identify the causal effects of each subway incident and conduct significance tests on these effects. However, due to space limitations, we only provide a detailed report on the causal effect identification results for the incident in 11th Marth. The details of this incident are as follows:\nStarting at 7:45 on the 11th Marth, a vehicle malfunction occurred on Line 11, and the malfunctioning vehicle was arranged to proceed slowly. From 7:51 to 8:43, temporary passenger flow control measures were implemented at Malu, Chenxiang Highway, Nanxiang, Taopu Xincun, Qilianshan Road, Liziyuan, and Fengqiao Road stations.\nFigure 5 illustrates the significantly affected ODs identified during the six time periods from 8:00 AM to 10:30 AM. In the figure, the blue line represents the subway line where the incident occurred, the black lines denote regular subway lines, and the red lines indicate the ODs that were significantly impacted by the incident.\nIt should be noted that the incident occurred at 7:45 AM and ended at approximately 8:45 AM. As illustrated in Figure 5, the number of affected ODs initially increased and peaked between 8:30 and 9:00 AM, before gradually declining. By 10:00 and 10:30 AM, only"}, {"title": "4.3. Passenger flow prediction results", "content": "In this section, we conducted experiments to determine whether the proposed two-stage approach enhances the accuracy of passenger flow predictions under incident conditions. We began by selecting baseline prediction models under normal situations. These models include three traditional machine learning algorithms: Linear Regression (LR), Random Forest (RF), and Gradient Boosted Decision Trees (GBDT).\nWe selected two matrix-based models: ST-ResNet [50] and UNet [31], which are widely utilized for matrix data, and GEML [41], a model specifically designed for Ride-hailing OD prediction.\nWe also conducted experiments with different causal effect prediction models. Specifically, we selected three models: Linear Regression, Random Forest, and Gradient Boosted Decision Trees. Following [54], we omitted the ODs with passenger flow less than 2. Besides, MAE (mean absolute err), RMSE (root mean square error) and MAPE (mean absolute percentage error) are used to evaluate the prediction accuracy. The equations to calculate them are in follows.\n\\[\nMAE = \\frac{1}{n} \\sum_{i=1}^n |\\hat{y} - y|\n\\]"}, {"title": "Calculating RMSE and MAPE", "content": "\n\\["}]}