{"title": "Efficient Generation of Molecular Clusters with Dual-Scale Equivariant Flow Matching", "authors": ["Akshay Subramanian", "Shuhui Qu", "Cheol Woo Park", "Sulin Liu", "Janghwan Lee", "Rafael G\u00f3mez-Bombarelli"], "abstract": "Amorphous molecular solids offer a promising alternative to inorganic semiconductors, owing to their mechanical flexibility and solution processability. The packing structure of these materials plays a crucial role in determining their electronic and transport properties, which are key to enhancing the efficiency of devices like organic solar cells (OSCs). However, obtaining these optoelectronic properties computationally requires molecular dynamics (MD) simulations to generate a conformational ensemble, a process that can be computationally expensive due to the large system sizes involved. Recent advances have focused on using generative models, particularly flow-based models as Boltzmann generators, to improve the efficiency of MD sampling. In this work, we developed a dual-scale flow matching method that separates training and inference into coarse-grained and all-atom stages and enhances both the accuracy and efficiency of standard flow matching samplers. We demonstrate the effectiveness of this method on a dataset of Y6 molecular clusters obtained through MD simulations, and we benchmark its efficiency and accuracy against single-scale flow matching methods.", "sections": [{"title": "1 Introduction", "content": "Amorphous molecular solids are disordered organic systems with several applications in the field of organic optoelectronics. Their mechanical flexibility and solution processability make them attractive alternatives to inorganic semiconductors [22, 14, 19]. Different molecules tend to pack differently in amorphous solids, which lead to different network extensivity, electronic properties, and transport rates [13]. The influence of packing structure on optoelectronic properties has led to significant interest in computationally simulating these materials with molecular dynamics (MD) simulations [13, 6] to enhance our understanding of the correlations between structural design and corresponding packing and optoelectronic properties. This can inform better design strategies for the next generation of organic electronics devices.\nHaving the ability to generate amorphous solids in a computationally efficient manner can enable faster sampling from the multi-molecule Boltzmann distribution, as well as property-guided generation of optimally packed configurations. There have been several works developing efficient methods to sample from Boltzmann distributions or their emulated (non re-weighted) versions [17, 11]. Scaling up to larger systems (such as amorphous clusters) is however computationally expensive if generation is to be performed at the all-atom (AA) level. In the field of protein generation, coarse-grained (CG) representations are used to collapse amino acids into single beads, which drastically reduces system size while still retaining higher-level structural features. There have been works that generate proteins in their coarse-grained representations, and other works that back-map coarse-grained proteins into their all-atom structure [12, 4, 24, 10]."}, {"title": "2 Background", "content": "Conditional Flow Matching (CFM). This is a new paradigm of training continuous normalizing flows (CNFs) efficiently in a simulation free manner [3, 2, 15]. An ODE parameterized by a learnable vector field $v_\\theta(x, t)$ transforms an easy-to-sample prior distribution $p_0$, into the more complex target distribution $p_1$. Parameters $\\theta$ are learned through the regression objective\n$$L_{CFM} = E_{t\\sim U[0,1],z\\sim p_0(x_0)p_1(x_1),x\\sim p_t(x|z)} ||v_\\theta(x, t) \u2013 u(x|z)||^2,$$\nWe chose the probability path definition to be $p_t(x|z) = N(x|tx_1 + (1 \u2212 t)x_0, \u03c3^2)$, which gives $u(x|z) = x_1 - x_0$ as the conditional vector field. Similar to work by Stark et al. [20], we trained $v_\\theta$ to predict $x_1$ rather than $x_1 - x_0$, and parameterized $v_\\theta$ by SE(3) equivariant refinement tensor field network (TFN) [23] layers. We present a comparison against other parameterizations in Section A.1.\nHarmonic Prior. Besides the standard gaussian prior, another common choice for prior in molecule generation tasks is the harmonic prior. The harmonic prior was introduced in Jing et al. [9] and used within the flow-matching framework by Stark et al. [20] as a more chemically plausible prior. The prior distribution $p_0(x_0)$ is interpreted as a Boltzmann distribution with a quadratic potential energy function, i.e., $p_0(x_0) \\propto e^{-E(x)} = e^{-x^THx}$, where $H$ is chosen such that $E(x) = \\sum_{i,j\\in E} ||x_i - x_j||^2$. We need to have the bond connectivity information $E$ a-priori to sample from the harmonic prior."}, {"title": "3 Methods", "content": null}, {"title": "3.1 Model", "content": "Dual-Scale CFM. This method decomposes the task of predicting all-atom coordinates $X_1$, into two sequential steps of predicting coarse-grained coordinates $C_1 \\in R^{M\\times3}$, and predicting all-atom coordinates $X_1 \\in R^{N\\times3}$, where $M$ and $N$ are dimensions of coarse-grained and all-atom coordinates respectively. Two separate vector field networks (VFNs) are learned: 1) $v_\\theta(c, t)$ to generate coarse-grained bead positions $c_1$, and 2) $v_\\phi(x, t|\\hat{c}_1)$ to generate all-atom positions $x_1$ conditioned on predicted bead positions $\\hat{c}_1$. Separate priors $p_0(c_0)$ and $p_0(x_0)$ are used for the two flows since they act on different input dimensionalities.\nTraining and Inference. Both flows are trained using Eq. 1 with the relevant distributions and vector fields being substituted in. To be precise, the two objectives are:\n$$L_{CG} = E_{t\\sim U[0,1],z\\sim p_0(C_0)p_1(C_1),C\\sim p_t(c|z)} ||U_g (c, t) \u2013 u(c|z)||^2,$$ $$L_{AA} = E_{t\\sim U[0,1],z\\sim p_0(X_0)p_1(x_1),x\\sim p_t(x|z)} ||U(x, t|c_1) \u2013 u(x|z)||^2,$$\n$U$ was trained using the ground-truth coarse-grained coordinates $c_1$ as the condition instead of predicted coordinates $\\hat{c}_1$, which decoupled the two flows. Inference was performed using an Euler ODE solver to integrate from t = 0 to 1 for each of the two flows. For the coarse-grained flow, the bead positions were obtained with $\\hat{c}_1 = v_\\theta(c, t)$, and an integration timestep was performed with $c_{t+\\Delta t} = c_t + \\Delta t(\\hat{c}_1 - c_0)$. Similarly, for the all-atom flow, $x_1 = v_\\phi(x, t|\\hat{c}_1)$, and $x_{t+\\Delta t} = x_t + \\Delta t(\\hat{x}_1 - x_0)$ were used. A total of 40 integration steps were taken to go from coarse-grained prior sample $c_0$ to all-atom target $X_1$."}, {"title": "3.2 Graph Representation", "content": "Besides cartesian coordinates (c/x), the vector field predictors $v_{\\theta/\\phi}$ also take atom features $f_{CG/AA}$ and bond features $B_{CG/AA}$ as input. More details on features and their data-types are provided in Table 2.\nWe pre-defined a mapping $B$ between node indices of all-atom atoms and coarse-grained beads, based on the basic chemical intuition that atoms present within rings have restricted degrees of freedom. The scheme is shown in Figure 1(a). We needed to define a means of collapsing the atom features $f_{AA}$ and bond features $B_{AA}$ into corresponding features $f_{CG}$ and $B_{CG}$ of coarse-grained beads so that this information was not completely lost to the flow $v_\\theta$.\nAtom Features. We aggregated atom features with $f^{CG}_i = \\bigoplus_{j\\in B(i)} f_j^{AA}$, where $\\bigoplus$ denotes an arbitrary aggregation operator. In our case we used either the elementwise Mean or OR operations depending on the data-type of the atomic feature. We did not include String atom features as input to $v_\\theta$. We assigned the cartesian coordinates of beads to be the averaged coordinates of all atoms present within the bead, and included them as equivariant node features to $v_\\theta$.\nBond Features. We assigned bond connectivity to beads based on connectivity of atoms within the beads. If any two atoms belonging to different beads had a bond connecting them in the all-atom structure, we created a bond between the two beads with the corresponding bond features."}, {"title": "3.3 Dataset", "content": "We followed the approach developed in Kupgan et al. [13] to simulate an amorphous morphology for the molecules. We first performed geometry optimization of the Y6 molecular structure using the method described in [21]. Then we used PACKMOL [16] to pack 5 structures in a cubic box at a low density (~ 0.1 g/cm\u00b3). The OPLS-AA force field [18] was used via the LigParGen server [5]. The system was equilibrated for 30 ns at 650 K, cooled to room temperature (300 K) at 10 K/ns, and subjected to a 30 ns production run at 300 K. All MD simulations were performed under the NPT ensemble at 1 atm with a timestep of 2 fs, using GROMACS 2023 [1]. We saved 301 frames from the production run and used a random 80:10:10 split into train, validation and test datasets. We unwrapped the molecular structures to remove periodic boundary conditions (PBC) and also removed hydrogen atoms. Each resulting frame contained 505 atoms in total in the all-atom representation."}, {"title": "4 Results and Discussion", "content": "We evaluated generated samples on 3 metrics (shown in Table 1). To evaluate distributional matching capabilities, we measured Jensen Shannon Divergence (JSD) between distributions of generated and MD distributions for bond lengths and angles. We evaluated efficiency through the average time taken per integration step during inference on one NVIDIA A100 GPU. We noticed that the dual-scale flow matching method improved upon a single-scale flow matching method (with Gaussian/Harmonic priors) by 15-25% on bond length and angle JSDs, while also decreasing the inference time by ~85%.\nWe also tested the influence of the ratio of integration steps taken in coarse-grained and all-atom resolutions, on the 3 metrics to see how much inference time can be saved without sacrificing accuracy (shown in Figure 1(b)). We denote the ratio of number of CG and AA integration steps by CG:AA. It is interesting to see that even for large CG:AA ratios, we significantly decreased inference time with negligible sacrifice to JSD performance."}, {"title": "5 Conclusions", "content": "In this work, we developed a dual-scale flow matching method that improves upon single-scale flow matching-based samplers in accuracy as well as inference efficiency, as demonstrated on a dataset of amorphous Y6 clusters. Moreover, it is interesting to see that we can push the ratio of CG:AA during inference integration to large values without sacrificing the prediction accuracy, while boosting inference speed. While we tested on clusters of size 5 in this paper, we plan to expand to larger clusters in the future whose packing properties are more representative of active layers in optoelectronic devices. We also plan on testing the influence of coarse-graining mapping scheme on performance since we tested a single pre-defined scheme in this work."}, {"title": "A.1 Choice of VFN architecture", "content": "Our choice of VFN architecture was based on a comparison of various architectures (shown in Table 2). We observed that using TFN as the VFN achieved best JSD performance across bond lengths and angles, as well as across gaussian and harmonic prior choices."}, {"title": "A.2 Graph Featurization", "content": null}]}