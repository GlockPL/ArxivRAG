{"title": "Unraveling Molecular Structure: A Multimodal Spectroscopic Dataset for Chemistry", "authors": ["Marvin Alberts", "Oliver Schilter", "Federico Zipoli", "Nina Hartrampf", "Teodoro Laino"], "abstract": "Spectroscopic techniques are essential tools for determining the structure of molecules. Different spectroscopic techniques, such as Nuclear magnetic resonance (NMR), Infrared spectroscopy, and Mass Spectrometry, provide insight into the molecular structure, including the presence or absence of functional groups. Chemists leverage the complementary nature of the different methods to their advantage. However, the lack of a comprehensive multimodal dataset, containing spectra from a variety of spectroscopic techniques, has limited machine-learning approaches mostly to single-modality tasks for predicting molecular structures from spectra. Here we introduce a dataset comprising simulated 1H-NMR, 13C-NMR, HSQC-NMR, Infrared, and Mass spectra (positive and negative ion modes) for 790k molecules extracted from chemical reactions in patent data. This dataset enables the development of foundation models for integrating information from multiple spectroscopic modalities, emulating the approach employed by human experts. Additionally, we provide benchmarks for evaluating single-modality tasks such as structure elucidation, predicting the spectra for a target molecule, and functional group predictions. This dataset has the potential automate structure elucidation, streamlining the molecular discovery pipeline from synthesis to structure determination. The dataset and code for the benchmarks can be found at https://rxn4chemistry.github.io/multimodal-spectroscopic-dataset.", "sections": [{"title": "Introduction", "content": "The rapid advancement of artificial intelligence (AI) and machine learning (ML) methods has ushered in a new era for the field of chemistry. Computational approaches have transformed various aspects of chemical research, including retrosynthesis planning [1, 2, 3, 4], reaction optimization through Bayesian optimization [5, 6, 7, 8], molecular design [9, 10, 11, 12] and more. Tasks that were previously laborious and time-consuming when performed manually are now being automated, accelerating the discovery process. Despite these advancements, one critical aspect of chemistry that remains heavily reliant on human expertise is structural elucidation \u2013 the process of determining the molecular structure from spectroscopic data."}, {"title": "Related Work", "content": "USPTO Dataset: The USPTO dataset, by Lowe [33], has become a staple for machine learning based works in chemistry [2, 31, 32, 34]. It is sourced from patent data and in contrast to many other datasets in chemistry fully open source, making a popular choice for training and evaluating reaction prediction models. The main advantage of this dataset is that all molecules are sourced from patent data, i.e. their distribution is very similar to molecules common in industry and to a lesser extent academia.\nNMR: Predicting the chemical structure from NMR spectra remains a largely unexplored subject. Jonas [35] first utilized imitation learning to predict the molecular structure from 13C-NMR spectra. Sridharan et al. [36] approached the problem from a different angle using a reinforcement learning guided Monte Carlo tree search to generate molecules from 13C-NMR spectra. The first work to combine both \u00b9H- and 13C-NMR spectra employed 1D-CNNs to predict substructures contained in the parent molecule from both 1H and 13C-NMR spectra. Subsequently, a database search is employed to provide the closest match [16]. More recently Alberts et al. [14] demonstrated that Transformer models are capable of generating molecular structure from annotated NMR spectra.\nHowever, very few other works have been published and comparison between the approaches is rare. A few studies have evaluated model performance on the experimental spectra available in the nmrshiftdb2 database [37] but most works utilise different private datasets. While some exclusively train on a limited amount of experimental spectra, most simulate a large number of spectra and"}, {"title": "Dataset", "content": "Since most spectral data is acquired after a reaction has been completed, a dataset intended for inferring molecular structures should encompass a chemical space similar to that accessible through common organic chemistry reactions. Therefore, we chose to utilize the USPTO reaction dataset, mined by Lowe [33] who extracted chemical reactions from the US patent database. This dataset spans 1,435,481 chemical reactions across various reaction classes and as such only contains realistic molecular structures and commonly used chemicals such as solvents, reactant and reagent. We identified all unique molecules from these reactions and applied filtering criteria based on the heavy atom count (all atoms except Hydrogen), retaining only those molecules with more than five and fewer than 35 heavy atoms. Additionally, we filtered out molecules containing elements other than Carbon, Hydrogen, Oxygen, Nitrogen, Sulfur, Phosphorus, Silicon, Boron, and the halogens. This reduced the number of molecules from 1,675,439 to 1,416,499. We attempted to simulate all molecules; however, since some simulations failed for certain molecules, we opted to include only those molecules for which all spectra simulations were successful (see Figure1).\nOverall, we ended up with 794.403 unique molecules and their corresponding IR, 1H-NMR, 13C-NMR, HSQC-NMR, negative ion mode MS/MS and positive ion mode MS/MS spectra (for more details about the simulations, refer to Section 3.1). The molecular structures is represented as SMILES and additionally the molecular formula of each molecule (e.g. C6H12O6) is provided. The distribution of SMILES lengths and heavy atom counts is visualized in Figure 2 (A), spanning the full range between 5 and 35 heavy atoms. Additionally, the chemical similarity between 200 randomly sampled molecules was investigated by calculating the Tanimoto similarity of their chemical"}, {"title": "Data Generation", "content": "An overview of the generated data can be found in Table 1. In addition, the spectra and annotations for two molecules are shown in Appenxix section A.1.\nNMR Simulations: We employ MestReNova [49] to simulate 1H-, 13C- and HSQC-NMR spectra. The spectra were simulated using deuterated Chloroform as solvent. Default settings were used for all simulations. For 13C-NMR spectra, \u00b9H decoupled spectra were generated.\nWe utilize the in-built spectral analysis tools of MestreNova to annotate the spectra. For 1H-NMR spectra, we employ the automultiplet analysis function yielding a set of peaks, the type of each peak e.g. doublet, triplet, etc., and the normalized integration of the peak. The same method yields the"}, {"title": "Experimental vs Simulated Spectra", "content": "To evaluate the similarity of the simulated spectra to experimental ones, we compared them with a set of 251 molecules and their corresponding experimentally measured spectra from Van Bramer and Bastin [57]. Out of these 251 molecules, 96 had all spectroscopic techniques measured and were also simulated in the dataset introduced in this manuscript (excluding HSQC-NMR). Since each spectral technique has a different representation, multiple approaches were required for comparison."}, {"title": "Benchmarks", "content": "In the following we will present benchmarks on predicting the correct structure, functional groups contained in a molecule and generating spectra from a given molecule. We only evaluate performance on single modalities and leave exploring multimodal tasks for future work. An overview of the different tasks is shown in Figure 4."}, {"title": "Structure Elucidation from Spectra", "content": "As described in the introduction, we envision full structure elucidation from spectra as the primary use case for this dataset. To this end, we provide baseline results on predicting the exact chemical structure from spectra (see Table 3). We train a vanilla encoder-decoder transformer model [60, 61] on each individual modality and on the combination of 1H- and 13C-NMR. More information on the exact model and parameters used can be found in Appendix section A.5. In addition to the spectra, we provide the models with the chemical formula, i.e. the elements present in the molecule, as a prior. The chemical formula can be obtained experimentally via high resolution MS.\nTo train a transformer model on the spectra we convert the spectra into a structured text representation. For IR and NMR spectra we follow the representations described in earlier works by Alberts et al. [17, 14]. For IR spectra this representation converts the spectrum to a set of 400 tokens each sampled from a fixed position in the spectrum and bins the intensities to tokens. For 13C-NMR spectra the representation provides the model with the position of each peak in the spectrum, whereas 1H-NMR spectra we provide the integration and type of each peak in addition its beginning and end. We train a model on both the positive and the negative MS/MS spectra. Each peak in a spectra is described using the peaks m/z and intensity. As we simulate three MS/MS spectra for positive and negative mode at different energy levels, we concatenate these spectra. Examples for all representations can be found in Appendix section A.7.\nWe observe the worst performance for models solely trained on IR spectra followed by MS/MS spectra. On the other hand, 1H- and 13C-NMR perform relatively well. Encouragingly the combination of both 1H- and 13C-NMR performs the best. These results can be explained by the information contained in each modality. While IR spectra can be leveraged easily to determine the functional groups present in a molecule, for larger and more complex molecules the peaks in the spectrum start to overlap rendering it difficult to extract information. The low performance on MS/MS spectra are caused by similar factors: The more complex the molecule, the larger the number of potential fragmentations, increasing the difficulty of assigning a definite structure. Models trained on 1H-NMR spectra perform"}, {"title": "Functional Group prediction", "content": "Another task that can be explored using the dataset is predicting the functional groups present in the structure from the spectra. We extract functional groups from the molecules using the SMARTS [62] pattern defined in A.2. While not as useful to chemists as full structure elucidation, the success of a chemical reaction can in most cases be determined by a change in functional groups. We approach this task as a multiclass, multilabel classification problem. As such we evaluate the performance of three different models, a boosted tree classifier [cite], a 1D-CNN as implemented by Jung et al. [41] and a transformer model, in predicting the functional groups present in the target molecule. The performance of the models on the modalities is shown in Table 4. We train the boosted gradient tree and 1D-CNN on the non processed vector form of each spectrum. In contrast we employ the same representations as used in for structure elucidation task for the transformer model. Unlike the previous task, we do not include the chemical formula as an input.\nAcross four modalities the transformer trained on the structured text representations outperforms both the 1D-CNN and the gradient boosted trees. Only on IR spectra is the performance of the 1D-CNN marginally better than the Transformer model. In contrast to MS/MS and the NMR spectra, IR spectra are not sparse explaining the good performance of the 1D-CNN."}, {"title": "Spectra prediction", "content": "We primarily conceived the dataset to explore structure elucidation. However, the dataset can also be used for the reverse, i.e. predicting the corresponding spectrum given a target molecule. To this end we train a transformer model to predict the from the molecule for each modality. We use the same model architecture and representations as in section 4.1. This mean that while we predict the whole spectrum for IR spectra, for all other modalities a processed form of the spectrum is generated. In the case of the MS/MS spectra this consists of the m/z of each peak and it's intensity. Similarly for 13C-NMR spectra the model predicts the position of each peak. However, for 1H-NMR spectra we predict the start and end of each peak, it's type and integration.\nTo compare the predicted and target spectrum we use two similarity metrics: One one hand we employ greedy cosine similarity and on the other the exact token accuracy. For MS/MS, 13C- and 1H-NMR spectra we compute the cosine similarity by first aligning the peaks in the predicted and target spectrum before calculating the similarity.\nFor IR spectra we observe both a low cosine and token similarity. This is likely caused by the represenation used for predicting the spectra as a sequence of 400 tokens has to be generated for each spectrum. Other approaches such as graph neural networks as proposed by McGill et al. [51] may show better performance. For both positive and negative MS/MS we observe a decrease in performance with an increase in the ionisation energy, likely a result of molecules fragmenting to a larger extent at higher ionisation energy and as such resulting in a more complex spectrum. Predicted 1H- and 13C-NMR spectra both exhibit a high cosine similarity while showing a small token accuracy. This is caused by two factors: One one hand only the position of the peak is used to calculate the similarity and on the other hand the token accuracy requires an exact match of the token, i.e. even if the predicted peak has an error of only 0.1ppm it would be deemed false."}, {"title": "Other tasks to explore", "content": "While we benchmark three different tasks that could be of interest to researchers, the dataset can also be used for various other ML applications. The following ideas serve as starting points for potential research opportunities to explore.\nIncluding more information: Typically, when predicting the structure of molecules from spectra, chemists do not start from scratch. Instead, they leverage prior knowledge of the reaction performed to make informed initial guesses about the structure. These guesses may include the desired product, the starting material, or plausible side products. Chemists then use clues obtained from various spectra to confirm or eliminate these initial hypotheses. In this context, we propose a task where a model is provided with a set of molecules and a spectrum, and it predicts which molecule from the set corresponds to the given spectrum.\nMixtures: While the previous sections discussed structure elucidation from pure compounds, in reality chemists typically encounter mixtures far more often than pure compounds, e.g. a reaction is a mixture of a set of compounds. The mixtures commonly need to be separated into their constituent components before definite structure elucidation can be carried out. If the components of a mixture could identified accurately this would greatly aid chemists. The spectra of mixtures can be constructed as convex combinations of their constituent components for NMR and IR spectra. As such this dataset could be used to construct the spectra of complex mixture based on which the components of the mixture can be predicted."}, {"title": "Conclusion and Limitations", "content": "In this study we introduce the first multimodal spectroscopic dataset for structure elucidation including six different types of spectra for 790k molecules sampled from USPTO. We conduct a series of experiments on structure elucidation, generating a spectrum from a molecule and evaluate boosted gradient trees, 1D-CNNs and transformer models on classifying which functional groups are present in a molecule based on the spectra.\nHowever, the dataset also has multiple limitations, the largest being that all data is simulated. As a result there is a distribution shift between simulated and experimental spectra and trained on the data in this set will likely benefit from further finetuning on experimental spectra.\nWe hope that this work can address the severe lack of openly available spectroscopic datasets and serve as a foundation to build models capable of automated structure elucidation for chemistry and with that streamline the molecular discovery pipeline from synthesis to structure determination."}, {"title": "Functional Group Analysis", "content": "The count of functional groups in the molecular structures was analyzed by SMARTS [63] pattern matching using RdKit [64]. The applied SMARTS patterns were derived from Jung et al. [41] and listed in Table 6. Each molecule can have only one occurrence of a particular functional group. For instance, if a molecule has two alcohol groups, the occurrence counts only once. However, each molecule can have multiple occurrences of different functional groups."}, {"title": "Functional Group influence on 1H-NMR spectra", "content": "To investigate if the simulated \u00b9H-NMR spectra exhibit the behavior described in the literature of having peaks in the region between 6.0 \u2013 8.7 ppm for aromatic compounds, we divided the spectra into two groups: one containing molecules with aromatic atoms and one with molecules without aromatic atoms. Then, we averaged all the spectra within each group and plotted the averaged spectra with the corresponding standard deviations (see Figure 5). It can be clearly seen that the non-aromatic molecules lack a signal in the literature-reported aromatic range, as expected. Conversely, the averaged spectra of the aromatic molecules show a distinct peak region in the aromatic range. This indicates that the simulations tend to correctly predict the aromatic regions of the 1H-NMR spectra."}, {"title": "Similarity Metrics", "content": "Cosine Similarity:\nThe cosine similarity, Sc(A, B), is defined as the cosine of the angle @ between two vectors A and B, representing the continuous spectra. It is calculated as:\n$Sc(A, B) := cos(0) = \\frac{A \\cdot B}{|A||B|}$ (1)\nChemical Similarity:\nThe chemical similarity between two molecules is calculated by computing the Tanimoto similarity between their Morgan fingerprints (built using RDKit [64]). The Morgan fingerprints are generated with a length of 1024 and radius of 2. The Tanimoto similarity, T(A, B), between two bit vectors A and B, representing the molecular fingerprints, is defined as:\n$T(A, B) = \\frac{A \\cdot B}{|A|^2 + |B|^2 \u2013 A \\cdot B}$ (2)\nCosineGreedy: The CosineGreedy class from the MatchMS package [59] calculates a modified version of the cosine similarity between two mass spectra. Instead of treating the spectra as vectors across all possible m/z values, it identifies pairs of peaks between the two spectra that have m/z values within a specified tolerance. It then uses a greedy approach to find the best set of matched peak pairs, rather than solving the optimal assignment problem. The cosine similarity score is calculated based on the intensities of these matched peak pairs, optionally weighted by the m/z values raised to a specified power. It can be adapted to list of NMR peaks by giving instead of the m/z value the ppm, and instead of the intensity giving the integral value."}, {"title": "Model", "content": "For all models we employ the same 90/10 train test split. The seeds are fixed for all runs."}, {"title": "Gradient Boosted Tree", "content": "All experiments using gradient boosted trees employ the XGBoost library [65] using the default settings on 32cpu cores:\nn estimators: 100\nbase score:0.5\ngamma: 0\nlearning rate:0.1\nmax delta step:0\nmax depth: 10"}, {"title": "1D-CNN Model", "content": "We use the implementation by Jung et al. [41] for all 1D-CNN experiments and reuse the same hyperparameters. This 1D-CNN employs three convolutional followed by three fully connected layers. The model is trained with an Adam optimiser for 41 epochs on A100 GPU using keras [66]."}, {"title": "Transformer Model", "content": "We employ a vanilla encoder-decoder transformer as implemented in the OpenNMT-py library [67, 61] with four layers each for the encoder and decoder and a hidden dimension of 512. We train all transformer models for 250k steps amounting to approximately 35h on a A100 GPU. Further hyperparameters can be found below:\nlayers: 4\nheads: 8\nword_vec_size: 512\nhidden_size: 512\ntransformer_ff: 2048\noptim: adam"}, {"title": "Evaluation metrics", "content": "F1 Score:\nThe F1 score is a measure of a model's performance that combines precision and recall into a single score. It is calculated as the harmonic mean of precision and recall, given by:\n$F1=2. \\frac{precision \\cdot recall}{precision + recall}$ (3)\nwhere precision is the fraction of true positives among the predicted positives, and recall is the fraction of true positives among the actual positives. The F1 score ranges from 0 to 1, with higher values indicating better performance.\nTop-k Accuracy:\nTop-k Accuracy measures the fraction of instances where the correct answer is among the top-k ranked predictions made by the model."}, {"title": "Representations for Transformers", "content": "All molecules in this study are treated as SMILES, a string based molecular representation. We tokenize the molecules following Schwaller et al. [32] using the following regex:\n(\\\\[[^\\\\]+]|Br?|C1?|N|0|S|P|F|I|b|cn|o|s|p|\\(|\\)|\\.|=|#|\\+|\\\\\\/|:|@|\\?|>|\\*|\\$|\\%[0-9]{2}|[0-9])\nThe IR spectra generated via molecular dynamics range from 400 to 4000cm-1 with a resolution of 2cm-1, i.e. it is a vector of size 1800. To convert this vector into a structured text representation ingestible by a transformer model we first downsample the spectrum to a vector of size 400 via linear interpolation. We subsequently scale the spectrum to a range of 0 to 100 and round the values to integers. In effect this converts a vector of size 1800 to a string of 400 integers."}, {"title": "NMR Spectra", "content": "To tokenize 1H-NMR peaks, we proceed as follows: The position of the peak is rounded to the second decimal point, the type of multiplet (singlet, doublet, triplet, etc.) and the number of hydrogens are appended as second and third token respectively. All peaks are separated with a separating token (\"|\"). As an example a singlet at 1.239 ppm with an integral of 3 would become \"1.24 s 3H |\", with tokens separated by whitespaces. A string of the 1H NMR spectrum is built accordingly by concatenating the peaks starting with the lowest ppm and ending at the highest one. In addition, a prefix token is used to differentiate 1H- from 13C-NMR spectra. As an example an 1H-NMR with two peaks would be formatted as follows: \u201c1HNMR 1.24 t 3H | 1.89 q 3H |\u201d.\n13C-NMR are formatted according to a simpler scheme. As the multiplet type and integration is not relevant for this type of spectrum the position of the peaks are rounded to one decimal point and tokenized accordingly. To illustrate this, a typical NMR spectrum is tokenized as follows: \u201c13CNMR 12.1 27.8 63.5\u201d."}, {"title": "MS/MS Spectra", "content": "The generated MS/MS consist of stick spectra, i.e. a list of the position in m/z and the intensity of each peak. We convert this stick spectrum into a structured text representation by listing each peak followed by it's intensity. Both the m/z and intensity are rounded to one decimal point. We concatenate the MS/MS generated at the three different ionisation energies as shown in Figure 8."}]}