{"title": "A Distribution Semantics for Probabilistic Term Rewriting*", "authors": ["Germ\u00e1n Vidal"], "abstract": "Probabilistic programming is becoming increasingly popular thanks to its ability to specify problems with a certain degree of uncertainty. In this work, we focus on term rewriting, a well-known computational formalism. In particular, we consider systems that combine traditional rewriting rules with probabilities. Then, we define a distribution semantics for such systems that can be used to model the probability of reducing a term to some value. We also show how to compute a set of \"explanations\" for a given reduction, which can be used to compute its probability. Finally, we illustrate our approach with several examples and outline a couple of extensions that may prove useful to improve the expressive power of probabilistic rewrite systems.", "sections": [{"title": "1 Introduction", "content": "Term rewriting [29] is a widely recognized computational formalism with many applications, ranging from providing theoretical foundations for programming languages to model specification and the development of analysis and verification techniques. The addition of probabilities to a programming language or formalism has proven useful for modeling domains with complex relationships and uncertainty. Surprisingly, however, we find only a few proposals for probabilistic term rewriting. Among the various approaches to incorporating probabilities into term rewriting, the proposal by Bournez et al. [7,4,5] is perhaps the most well-known. It introduces the concept PARS (Probabilistic Abstract Reduction System) and its instance PTRS (Probabilistic Term Rewrite System), together with the corresponding notions of probabilistic (abstract) reduction. Intuitively speaking, in this line of work, a probabilistic term rewrite system (PTRS) is a collection of probabilistic rules of the form\nl \u2192 P\u2081:r1,...,Pm:rm with \\sum_{i\\in{1,...,m}} Pi = 1"}, {"title": "2 Standard Term Rewriting", "content": "In this section, for self-completeness, we recall some basic concepts from term rewriting. We refer the reader to, e.g., [3] and [29], for further details.\nTerms and Substitutions\nA signature F is a set of ranked function symbols. Given a set of variables V with F \u2229 V = \u2205, we denote the domain of terms by T(F, V). We use f, g,... to denote functions and x, y,... to denote variables. Positions are used to address the nodes of a term viewed as a tree. A position \u03c0 in a term t, in symbols \u03c0 \u2208 Pos(t), is represented by a finite sequence of natural numbers, where \u03b5 denotes the root position. We let t|\u03c0 denote the subterm of t at position \u03c0 and t[s]\u03c0 the result of replacing the subterm t|\u03c0 by the term s. Var(t) denotes the set of variables appearing in t. We also let Var(t1, ..., tn) denote Var(t1) \u222a ... \u222a Var(tn). A term t is ground if Var(t) = \u2205.\nA substitution \u03c3 : V \u2192 T(F, V) is a mapping from variables to terms such that Dom(\u03c3) = {x \u2208 V | x \u2260 \u03c3(x)} is its domain. A substitution \u03c3 is ground if x\u03c3 is ground for all x \u2208 Dom(\u03c3). Substitutions are extended to morphisms from T(F, V) to T(F,V) in the natural way. We denote the application of a substitution \u03c3 to a term t by t\u03c3 rather than \u03c3(t). The identity substitution is denoted by id. We let \u201c\u2218\u201d denote the composition of substitutions, i.e., \u03c3 \u2218 \u03b8(x) = (x\u03b8)\u03c3 = x\u03b8\u03c3. The restriction \u03b8|V of a substitution \u03b8 to a set of variables V is defined as follows: x\u03b8|V = x\u03b8 if x \u2208 V and x\u03b8|V = x otherwise."}, {"title": "2.1 Term Rewriting Systems", "content": "A set of rewrite rules l \u2192 r such that l is a nonvariable term and r is a term whose variables appear in l is called a term rewriting system (TRS for short); terms l and r are called the left-hand side and the right-hand side of the rule, respectively. We restrict ourselves to finite signatures and TRSs. Given a TRS R over a signature F, the defined symbols DR are the root symbols of the left-hand sides of the rules and the constructors are CR = F \\ DR. Constructor terms of R are terms over CR and V, denoted by T(CR, V). We sometimes omit R from DR and CR if it is clear from the context. A substitution \u03c3 is a constructor substitution (of R) if x\u03c3 \u2208 T(CR, V) for all variables x.\nFor a TRS R, we define the associated rewrite relation \u2192R as the smallest binary relation on terms satisfying the following: given terms s, t \u2208 T(F, V), we have s \u2192R t iff there exist a position \u03c0 in s, a rewrite rule l \u2192 r \u2208 R, and a substitution \u03c3 such that s|\u03c0 = l\u03c3 and t = s[r\u03c3]\u03c0; the rewrite step is sometimes denoted by s \u2192\u03c0,l\u2192r t to make explicit the position and rule used in this step. The instantiated left-hand side l\u03c3 is called a redex. A term s is called irreducible or in normal form with respect to a TRS R if there is no term t with s \u2192R t; we often omit \u201cwith respect to R\u201d if it is clear from the context. A derivation is a (possibly empty) sequence of rewrite steps. Given a binary relation \u2192, we denote by \u2192* its reflexive and transitive closure, i.e., s \u2192* t means that s can be reduced to t in R in zero or more steps; furthermore, we let s \u2192! t if s \u2192* t, and, moreover, t is a normal form. We also use the relation \u201c\u22b3\u201d to denote reachability, i.e., s \u22b3 t if there exists a derivation s \u2192* t."}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "In this section, we present an extension of term rewrite systems in order to model uncertainty and, then, we define a distribution semantics for them.\nIn the following, we assume that the domain of function symbols D is par- titioned into a set Dp of probabilistic functions and a set Dr of regular (non- probabilistic) functions, which are disjoint, i.e., D = Dp \u228d Dr. A probabilistic rule has the form\nl \u2192 P\u2081:r1;...;Pn:rn\nwhere l, r1, ..., rn are ground terms and p1, ..., pn are real numbers in the interval [0, 1] (their respective probabilities) such that  \\sum_{i=1}^n  Pi \u2264 1. When \u2211i=1n Pi < 1, we implicitly assume that a special term \u22a5 is added to the right- hand side of the rule, where \u22a5/0 is a fresh constructor symbol which does not occur in the original system, with associated probability 1 \u2212 \u2211i=1n Pi. Here, choosing \u22a5 is equivalent to not reducing the selected term (nor any of its de- scendants). Thus, in the following, we assume w.l.o.g. that  \\sum_{i=1}^n Pi = 1 for all probabilistic rules. A probabilistic term rewrite system (PTRS) S = Sp \u222a Sr with DS = Dp \u222a D\u2032r consists of a set of probabilistic rules Sp defining the func- tion symbols in Dp and a set of regular rewrite rules Sr defining the function symbols in D\u2032r."}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "Let us now consider the definition of a distribution semantics for PTRSS. Essentially, each probabilistic rule R = (l \u2192 p1 : r1; ... ; pn : rn) represents a choice between n regular rules: l \u2192 r1, ..., l \u2192 rn. In other words, each probabilistic rule represents a random variable of the model represented by the PTRS. A particular choice is denoted by a tuple (R, i), i \u2208 {1, ..., n}, which is called an atomic choice, and has as associated probability \u03c0(R, i), i.e., pi in the rule above. Following [23], we say that a set of atomic choices is consistent if it does not contain two atomic choices for the same probabilistic rule, i.e., it cannot contain (R, i) and (R, j) with i \u2260 j. A set of consistent atomic choices is called a composite choice. We also say that two composite choices, \u03ba1, \u03ba2, are incompatible if \u03ba1 \u222a \u03ba2 is not consistent, i.e., we have (R, i) \u2208 \u03ba1 and (R, j) \u2208 \u03ba2 with i \u2260 j. A set K of composite choices is mutually incompatible if for all \u03ba1 \u2208 K, \u03ba2 \u2208 K, \u03ba1 \u2260 \u03ba2 implies \u03ba1 \u222a \u03ba2 is not consistent.\nA composite choice is called a selection when it includes an atomic choice for each probabilistic rule of the PTRS. We let SS denote the set of all possible selections for a given PTRS S. Each selection s \u2208 SS identifies a world WS which contains a regular rule l \u2192 ri for each atomic choice (R, i) \u2208 s, together with the rules for regular functions:\nWS = {l \u2192 ri | R = (l \u2192 p1 : r1; ... ; pn : rn) \u2208 Sp \u2227 (R, i) \u2208 s} \u222a Sr\nGiven a selection s, the probability of world WS is then defined as follows:\nP(WS) = P(s) = \\prod_{(R,i) \\in s} \\pi(R,i)\nGiven a PTRS S, we let WS denote the set of all possible worlds, i.e., WS = {WS | s \u2208 SS}. Here, P(W) defines a probability distribution over WS. By definition, the sum of the probabilities of all possible worlds is equal to 1.\nIn this context, given a PTRS S, we are interested in computing the proba- bility of whether a term s can be reduced to term t in S\u2014a typical reachability problem\u2014, in symbols P(s \u2192S t) or simply P(s \u2192 t) when the PTRS S is clear from the context. This probability can be obtained by marginalization from the joint distribution P(s \u2192S t, W) as follows:\nP(s \u2192S t) = \\sum_{W \\in W_S} P(s \u2192S t, W) = \\sum_{W \\in W_S} P(s \u2192S t | W) \u00b7 P(W)\nwhere P(s \u2192S t | W) = 1 if there exists a derivation s \u2192*W t and P(s \u2192S t | W) = 0 otherwise. Intuitively speaking, the probability of s \u2192* t is equal to the"}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "sum of the probabilities of all the worlds where term s can be reduced to term t. Often, we will be interested in knowing the probability of s \u2192* t where t is a normal form (a possible \u201cvalue\u201d of s).\nConsider again the PTRS of Example 1. Here, we have four possible worlds:\nW1 = {coin1 \u2192 heads, coin2 \u2192 heads}\nW2 = {coin1 \u2192 heads, coin2 \u2192 tails} \u222a {main \u2192 flip2coins(coin1, coin2)}\nW3 = {coin1 \u2192 tails, coin2 \u2192 heads} {flip2coins(x, y) \u2192 t2(x, y)}\nW4 = {coin1 \u2192 tails, coin2 \u2192 tails}\nwith associated probabilities P(W1) = 0.5 * 0.6 = 0.3, P(W2) = 0.5 * 0.4 = 0.2, P(W3) = 0.5 * 0.6 = 0.3, and P(W4) = 0.5 * 0.4 = 0.2. Then, for in- stance, the probability of reducing main to t2(heads, heads) is given by P(main \u2192 t2(heads, heads)) = P(W1) = 0.3. Let us now add the following (nondeterminis- tic) regular rules to the considered PTRS:\nswitch(t2(x, y)) \u2192 t2(x, y)\nswitch(t2(x, y)) \u2192 t2(y, x)\nThe number of worlds and their probabilities do not change since the proba- bilistic rules are the same; the only difference is that, now, rules R5 and R6 are added to every world. Consider now the probability of reducing switch(main) to t2(heads, tails), i.e., the probability of getting one heads and one tails, no matter which coin. Here, we have the following derivation D1 in world W2:\nswitch(main) \u2192 switch(flip2coins(coin1, coin2))\n\u2192 switch(t2(coin1, coin2))\n\u2192 t2(coin1, coin2)\n\u2192 t2(heads, coin2)\n\u2192 t2(heads, tails)\nand the following one, D2, in world W3:\nswitch(main) \u2192 switch(flip2coins(coin1, coin2))\n\u2192 switch(t2(coin1, coin2))\n\u2192 t2(coin2, coin1)\n\u2192 t2(heads, coin1)\n\u2192 t2(heads, tails)\nThus, P(switch(main) \u2192 t2(heads, tails)) = P(W2) + P(W3) = 0.2 + 0.3 = 0.5, i.e., the probability of getting heads and tails with the two coins does not depend on whether one of them is biased (it is always 50%).\nWe note that P(s \u2192 t) does not depend on the number of possible derivations from s to t in each world, but only on the number of worlds where the derivation is possible. Consider, e.g., the following PTRS:\nch \u2192 0.7: f(a); 0.3: b\nf(a) \u2192 st\na \u2192 c\nf(c) \u2192 st\nb \u2192 d1\nb \u2192 d2"}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "Now, we want to calculate P(ch \u2192 st). In this case, we have two possible worlds:\nW1 = {ch \u2192 f(a)} \u222a { f(a) \u2192 st \n a \u2192 c \n f(c) \u2192 st} \nW2 = {ch \u2192 b } \u222a {b \u2192 d1 \nb \u2192 d2}\nwith probabilities P(W1) = 0.7 and P(W2) = 0.3. Here, the probability of reducing ch to st, i.e., P(ch \u2192 st), is equal to 0.7. The fact that there are two possible derivations from ch to st is irrelevant. On the other hand, note that P(ch \u2192 d1) = P(ch \u2192 d2) = 0.3, since both reductions can only be performed in world W2.\nThe usual properties over standard TRSs can be lifted to PTRS straight- forwardly by considering the associated worlds. E.g., we say that a PTRS S is terminating (resp. confluent) if every world W \u2208 WS is terminating (resp. confluent). In general,\nDefinition 1. Let S be a PTRS. We say that a property P holds for PTRS S if P holds for each TRS W \u2208 WS.\nIn practice, however, it is very difficult or simply impossible to compute the probability P(s \u2192 t) by summing up the probabilities of the worlds where s can be reduced to t since the number of worlds can be very large even with a few probabilistic rules (e.g., n rules with only two choices already give rise to 2n worlds). Therefore, we will now present an extension of the term rewriting relation that will help us compute the probability more efficiently.\nSimilarly to [21,23] in the context of a formalism based on Horn clauses, we consider the notion of explanation. First, we say that a selection s extends a composite choice \u03ba if \u03ba \u2286 S; analogously, a world W is compatible with a composite choice \u03ba if there is a selection s that extends \u03ba and W = WS. In general, a composite choice \u03ba identifies the set of worlds W\u03ba that are compatible with \u03ba, i.e., W\u03ba = {WS | s \u2208 SS \u2227 \u03ba \u2286 s}. Moreover, given a (finite) set of composite choices K, we let WK = \u222a\u03ba\u2208K W\u03ba.\nDefinition 2 (explanation, covering). Let S be a PTRS and \u03ba a composite choice for the probabilistic rules of S. Given terms s, t, we say that \u03ba is an explanation for s \u2192 t iff there exists a derivation s \u2192* t in each world that is compatible with \u03ba, i.e., there is a derivation s \u2192*W t for all W \u2208 W\u03ba.\nLet K be a (finite) set of explanations for s \u2192 t. We say that K is covering for s \u2192 t if for all W \u2208 WS such that s \u2192W t we have W \u2208 WK.\nIn the following, we are interested in computing a covering set of explanations for a given problem s \u2192 t. For this purpose, we now introduce an extension of rewriting over pairs (t, \u03ba), where t is a term and \u03ba is a composite choice.\nDefinition 3 (probabilistic rewriting). Let s, t be terms and \u03ba, \u03ba\u2032 be com- posite choices. A PTRS S induces a probabilistic rewrite relation \u219dS where (s, \u03ba) \u219dS (t, \u03ba\u2032) if either"}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "there is a position \u03c0 in s, a regular rewrite rule l \u2192 r \u2208 S, and a substitution \u03c3 such that s|\u03c0 = l\u03c3, t = s[r\u03c3]\u03c0, and \u03ba\u2032 = \u03ba, or\nthere is a position \u03c0 in s, a probabilistic rewrite rule R = (l \u2192 p1 : r1; ... ; pn : rn) \u2208 S, and a substitution \u03c3 such that s|\u03c0 = l\u03c3, t = s[ri\u03c3]\u03c0, i \u2208 {1, ..., n}, and \u03ba\u2032 = \u03ba \u222a {(R, i)} is consistent.\nWe often label a probabilistic rewriting step with the probability of the choice made, i.e., (s, \u03ba) \u2192 (t, \u03ba \u222a {(R, i)}) with \u03c0(R, i) = pi; moreover, if the step applies a regular rewrite rule, we consider that the probability is 1, so that (s, \u03ba) \u2192 (t, \u03ba) is equivalent to (s, \u03ba) \u21921 (t, \u03ba). Probabilities can then be lifted to derivations by computing the product of the probabilities of their steps, i.e., (s0, \u03ba0) \u2192p1 (s1, \u03ba1) \u2192p2 ... \u2192pn (sn, \u03ban) if (s0, \u03ba0) \u2192 (s1, \u03ba1), ..., (sn\u22121, \u03ban\u22121) \u2192 (sn, \u03ban) and p = p1 * p2 * ... * pn.\nGiven a reachability problem s \u2192S t, its associated set of explanations, E(s \u2192S t), is defined as follows:\nE(s \u2192S t) = {\u03ba | (s, \u2205) \u2192S (t, \u03ba)}\nNow, we prove that E(s \u2192 t, S) is indeed a covering set of explanations for s \u2192S t:\nTheorem 1. Let S be a PTRS and let s, t be terms. Then, for all selection s \u2208 SS, we have s \u2192WS t iff (s, \u2205) \u2192S (t, \u03ba) with \u03ba \u2286 S.\nProof. First, we consider the \u201conly if\u201d direction. Let s \u2192WS t. Since s is consis- tent by definition, we can construct a derivation (s, \u2205) \u2192S (t, \u03ba) that mimicks the same steps of s \u2192*W t. Trivially, \u03ba is then a (consistent) composite choice with \u03ba \u2286 S.\nConsider now the \u201cif\u201d direction. Let (s, \u2205) \u2192S (t, \u03ba) be a derivation with the probabilistic rewrite relation. Trivially, \u03ba is a (consistent) composite choice and s \u2192*W t can be proved in every world that is compatible with \u03ba since the choices made in the probabilistic rules used in the derivation are the same.\nAs a consequence of this result, we can state the following:\nCorollary 1. Let S be a PTRS and let s, t be terms. Then, E(s \u2192S t) is a covering set of explanations for s \u2192S t.\nIn the following, we define the probability of a derivation D = (s, \u2205) \u2192S (t, \u03ba) as the probability of the associated explanation, i.e.,\nP(D) = P(\u03ba) = \\prod_{(R,i) \\in \\kappa} \\pi(R, i)\nConsider again the PTRS of Example 2 and the two derivations D1 and D2 from switch(main) to t2(heads, tails). The corresponding derivations with"}, {"title": "3 A Distribution Semantics for Probabilistic TRSS", "content": "the probabilistic rewrite relation, D\u02dc1 and D\u02dc2, are now as follows:\n(switch(main), \u2205) \u2192 (switch(flip2coins(coin1, coin2)), \u2205)\n\u2192 (switch(t2(coin1, coin2)), \u2205)\n\u2192 (t2(coin1, coin2), \u2205)\n 0.5\n \u2192 (t2(heads, coin2), {(R1, 1)})\n 0.4\n \u2192 (t2(heads, tails), {(R1, 1), (R2, 2)})\n(switch(main), \u2205) \u2192 (switch(flip2coins(coin1, coin2)), \u2205)\n\u2192 (switch(t2(coin1, coin2)), \u2205)\n\u2192 (t2(coin2, coin1), \u2205)\n 0.6\n \u2192 (t2(heads, coin1), {(R2, 1)})\n 0.5\n \u2192 (t2(heads, tails), {(R1, 2), (R2, 1)})\nGiven a composite choice \u03ba, we trivially have P(\u03ba) = \u2211W\u2208W\u03ba P(W), i.e., the probability of composite choice \u03ba is equal to the sum of the probabilities of all the worlds that are compatible with \u03ba. This gives us a possible method to compute the probability of s \u2192 t without necessarily computing all possible worlds, using instead a covering set of explanations for s \u2192 t.\nFurthermore, given a problem s \u2192 t, one could prune the derivations for s where t is clearly not reachable (e.g., when there is a mismatch in an out- ermost constructor symbol). Defining efficient and terminating methods for computing a covering set of explanations is left as future work.\nFor example, let \u03ba1 and \u03ba2 be the explanations computed in the exam- ple above, i.e., \u03ba1 = {(R1, 1), (R2, 2)}, \u03ba2 = {(R1, 2), (R2, 1)}. Then, we have P(\u03ba1) = \u03c0(R1, 1) * \u03c0(R2, 2) = 0.5 * 0.4 = 0.2 and P(\u03ba2) = \u03c0(R1, 2) * \u03c0(R2, 1) = 0.5 * 0.6 = 0.3. Since this set of explanations is covering and, moreover, \u03ba1 and \u03ba2 are incompatible (i.e., \u03ba1 \u222a \u03ba2 is not consistent), then the sets of worlds W\u03ba1 and W\u03ba2 are disjoint (cf. [23, Lemma 4.4]) and, thus, the probability of switch(main) \u2192 t2(heads, tails) can be obtained from the sum of P(\u03ba1) and P(\u03ba2):\nP(switch(main) \u2192 t2(heads, tails)) = P(\u03ba1) + P(\u03ba2) = 0.2 + 0.3 = 0.5\nIn the previous example, we have only considered two derivations, although there are actually quite a few more. In this case, however, they all compute one of the two explanations shown above (either \u03ba1 or \u03ba2). Unfortunately, given a covering set of explanations K for s \u2192 t, the equality P(s \u2192 t) = \u2211\u03ba\u2208K P(\u03ba) does not generally hold since the sets of worlds that are compatible with the explanations may overlap, i.e., we can have \u03ba1, \u03ba2 \u2208 K such that W\u03ba1 \u2229 W\u03ba2 \u0338= \u2205 and, thus, P(\u03ba1) + P(\u03ba2) \u0338= \u2211W\u2208W\u03ba1\u222aW\u03ba2 P(W)."}, {"title": "4 Modeling Problems with Uncertainty", "content": "In this section we explore the expressive power of PTRSs for modeling problems with uncertainty and propose some extensions.\nConsider the following PTRS which specifies the level of protection (against covid-19) depending on the vaccination status and the mask worn:\nstatus(senior) \u2192 0.9: vacc; 0.1: non_vacc\nstatus(adult) \u2192 0.5: vacc; 0.5: non_vacc\nstatus(young) \u2192 0.2: vacc; 0.8: non_vacc\nmask \u2192 0.2: ffp2; 0.1: surgical; 0.7: none\nprotection(x) \u2192 lookup(status(x), mask)\nlookup(vacc, ffp2) \u2192 strong\nlookup(vacc, surgical) \u2192 strong\nlookup(non_vacc, ffp2) \u2192 strong\nlookup(non_vacc, surgical) \u2192 weak\nlookup(x, none) \u2192 no\nNote that vaccination status depends on a person's age while wearing a mask is considered a generic property which is independent of age in this example. Here, we may be interested in knowing the probability that a senior person has strong protection against covid, i.e., P(protection(senior) \u2192 strong)."}, {"title": "4 Modeling Problems with Uncertainty", "content": "For this purpose, we get a set of explanations K from the following proba- bilistic rewriting derivations:\n(protection(senior), \u2205) \u2192 (lookup(status(senior), mask), \u2205)\n 0.9\n \u2192 (lookup(vacc, mask), {(R1, 1)})\n 0.2\n \u2192 (lookup(vacc, ffp2), {(R1, 1), (R4, 1)})\n \u2192 (strong, {(R1, 1), (R4, 1)})\n(protection(senior), \u2205) \u2192 (lookup(status(senior), mask), \u2205)\n 0.9\n \u2192 (lookup(vacc, mask), {(R1, 1)})\n 0.1\n \u2192 (lookup(vacc, surgical), {(R1, 1), (R4, 2)})\n \u2192 (strong, {(R1, 1), (R4, 2)})\n(protection(senior), \u2205) \u2192 (lookup(status(senior), mask), \u2205)\n 0.1\n \u2192 (lookup(no_vacc, mask), {(R1, 2)})\n 0.2\n \u2192 (lookup(no_vacc, ffp2), {(R1, 2), (R4, 1)})\n \u2192 (strong, {(R1, 2), (R4, 1)})\nThe computed set of explanations is thus as follows:\nK = {{(R1, 1), (R4, 1)}, {(R1, 1), (R4, 2)}, {(R1, 2), (R4, 1)}}\nwith P(\u03ba1) = 0.18, P(\u03ba2) = 0.09 and P(\u03ba3) = 0.02. In this case, the explanations in K are already mutually incompatible and, thus, we have P(protection(senior) \u2192 strong) = P(\u03ba1) + P(\u03ba2) + P(\u03ba3) = 0.29."}, {"title": "4.1 Probabilistic Rules with Variables", "content": "Variables in rewrite rules represent a very expressive resource. Although in the previous section we have only considered probabilistic ground rules, there are several ways we can extend the definition to include variables. First, we can accept probabilistic rules with variables as long as the domain of such variables is finite. Here, probabilistic rules with variables are seen only as a compact representation of a (finite) set of ground rules. Then, rules with variables could be replaced by the corresponding instances in a grounding preprocessing stage.\nIn this case, though, we should extend the notion of atomic choice to a triple (R, \u03b8, i) where R, i are the rule and the choice (as before), and \u03b8 is the considered (ground) instance of rule R. The associated probability is still \u03c0(R, i) since we assume that all instances have the same choices and probabilities. Now, we can say that each ground instance of each probabilistic rule represents a random variable of the model."}, {"title": "4.1 Probabilistic Rules with Variables", "content": "Now, let us consider that there is no grounding stage. Unfortunately, if we accept probabilistic rules with variables which can, in principle, be bound to infinitely many terms, the number of choices and, thus, the number of random variables, can be infinite. Therefore, the probability of a world cannot be defined as the product of the choices in a selection, P(Ws) = \\prod_{(R,\\theta,i) \\in s} \\pi(R,i), since it would converge to zero whenever there are infinitely many possible ground instances of probabilistic rules.\nFollowing [23], in order to overcome the above problem, one can introduce a measure over (possibly infinite) sets of possible worlds:\nGiven a finite set of (finite) composite choices K, the probability of the (pos- sibly infinite) set of worlds WK is given by \u03bc(K), which is defined in terms of a set K\u2032 of mutually incompatible composite choices that are equivalent to K, i.e., that represents the same (possibly infinite) set of worlds, WK = WK\u2032. Such a set K\u2032 can always be obtained from K by splitting [23]. Alternatively, one can use a conversion to BDDs in order to compute \u03bc(K), as we have seen in the previous section. In particular, if K is a set of mutually incompatible composite choices, then \u03bc(K) = \u2211\u03ba\u2208K P(\u03ba) = \u2211\u03ba\u2208K \u220f(R,\u03b8,i)\u2208\u03ba \u03c0(R, i).\nThen, given a reachability problem, s \u2192S t and a finite set of (finite) covering explanations K, we let P(s \u2192S t) = \u03bc(K).\nTherefore, introducing probabilistic rules with variables is not a problem as long as we can obtain a finite covering set of (finite) explanations. In particular, we"}, {"title": "4.2 Conditional PTRSS", "content": "Another interesting extension from the point of view of expressive power consists of considering conditional rewrite rules. For this purpose, let us first briefly introduce conditional term rewrite systems (CTRSs); namely oriented 3-CTRSS, i.e., CTRSs where extra variables are allowed as long as Var(r) \u2286 Var(l) \u222a Var(C) for any rule l \u2192 r \u2190 C [18]. In oriented CTRSS, a conditional rule l \u2192 r \u2190 C has the form l \u2192 r \u2190 s1 \u2192 t1, ..., sm \u2192 tm, where each oriented equation si \u2192 ti is interpreted as reachability (\u2192)."}, {"title": "4.2 Conditional PTRSS", "content": "For a CTRS R, the associated rewrite relation \u2192R is defined as the smallest binary relation satisfying the following: given terms s, t \u2208 T(F), we have s \u2192R t iff there exist a position p in s, a rewrite rule l \u2192 r \u2190 s1 \u2192 t1, ..., sm \u2192 tm \u2208 R, and a substitution \u03c3 such that s|p = l\u03c3, si\u03c3 \u2192 tio for all i = 1, ..., m, and t = s[r\u03c3]p.\nThe extension of PTRS s and probabilistic rewriting to the conditional case is very natural. A probabilistic conditional rule has now the form\nl \u2192 p1 : r1; ... ; pn : rn \u2190 s1 \u22b3 t1, ..., sm \u22b3 tm\nThen, a probabilistic conditional term rewrite system (PCTRS) is a disjoint set of probabilistic conditional rules and regular conditional rewrite rules. A world is then obtained from a selection s as in the unconditional case, i.e., by choosing one right-hand side per probabilistic conditional rule:3\nWS = {l \u2192 ri \u2190 C | R = (l \u2192 p1 : r1; ... ; pn : rn \u2190 C) \u2208 Sp \u2227 (R, i) \u2208 s} \u222a Sr\nwhere C is a (possibly empty) sequence of oriented equations of the form si \u22b3 ti, i = 1, ..., m, m \u2265 0. Definition 1 applies to PCTRSs too: given a PCTRS S, we say that a property P holds for S if P holds for each world induced from a given selection.\nProbabilistic conditional rewriting can then be defined as follows:\nDefinition 4 (probabilistic conditional rewriting). Let s, t be terms and \u03ba, \u03ba\u2032 be composite choices. A PCTRS S induces a probabilistic conditional rewrite relation \u219dS where (s, \u03ba) \u219dS (t, \u03ba\u2032) if either\nthere is a position \u03c0 in s, a regular rewrite rule l \u2192 r \u2190 s1 \u22b3 t1, ..., sm \u22b3 tm \u2208 S, and a substitution \u03c3 such that s|\u03c0 = l\u03c3, (si\u03c3, \u03ba) \u2192 (ti\u03c3, \u03bai) for all i = 1, ..., m, t = s[r\u03c3]\u03c0, and \u03ba\u2032 = \u03ba1 \u222a ... \u222a \u03bam is consistent, or\nthere is a position \u03c0 in s, a probabilistic rewrite rule l \u2192 p1 : r1; ... ; pn : rn \u2190 s1 \u2192 t1, ..., sm \u2192 tm \u2208 S, and a substitution \u03c3 such that s|\u03c0 = l\u03c3, (si\u03c3, \u03ba) \u2192 (ti\u03c3, \u03bai) for all i = 1, ..., m, t = s[rj\u03c3]\u03c0, j \u2208 {1, ..., n}, and \u03ba\u2032 = \u03ba1 \u222a ... \u222a \u03bam \u222a {(R, j)} is consistent.\nIn this case, calculating the probability associated with a conditional rewriting step is a bit more complex than in the unconditional case. Specifically, it is obtained from the product of the probabilities of the new atomic choices added in the step, no matter if they come from the evaluation of the conditions or from the step itself. For instance, given a reduction step (s, \u03ba) \u2192 (t, \u03ba \u222a \u03ba\u2032), we have p = \u220f(p,R)\u2208\u03ba\u2032 \u03c0(p, R) if \u03ba\u2032 \u0338= \u2205 and p = 1 otherwise."}, {"title": "5 Related Work", "content": "As mentioned in the Introduction, the most popular approach to probabilistic rewriting is that of Bournez et al. [7,4,5", "2": "where multidistributions are introduced to appropriately account for both the probabilistic behavior of each rule and the nondeterminism in rule selection. A similar notion of PTRS is considered in [15,16,14"}]}