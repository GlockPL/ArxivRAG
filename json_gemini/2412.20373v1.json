{"title": "A Deep Subgrouping Framework for Precision Drug Repurposing via Emulating Clinical Trials on Real-world Patient Data", "authors": ["Seungyeon Lee", "Ruoqi Liu", "Feixiong Cheng", "Ping Zhang"], "abstract": "Drug repurposing identifies new therapeutic uses for existing drugs, reducing the time and costs compared to traditional de novo drug discovery. Most existing drug repurposing studies using real-world patient data often treat the entire population as homogeneous, ignoring the heterogeneity of treatment responses across patient subgroups. This approach may overlook promising drugs that benefit specific subgroups but lack notable treatment effects across the entire population, potentially limiting the number of repurposable candidates identified. To address this, we introduce STEDR, a novel drug repurposing framework that integrates subgroup analysis with treatment effect estimation. Our approach first identifies repurposing candidates by emulating multiple clinical trials on real-world patient data and then characterizes patient subgroups by learning subgroup-specific treatment effects. We deploy STEDR to Alzheimer's Disease (AD), a condition with few approved drugs and known heterogeneity in treatment responses. We emulate trials for over one thousand medications on a large-scale real-world database covering over 8 million patients, identifying 14 drug candidates with beneficial effects to AD in characterized subgroups. Experiments demonstrate STEDR's superior capability in identifying repurposing candidates compared to existing approaches. Additionally, our method can characterize clinically relevant patient subgroups associated with important AD-related risk factors, paving the way for precision drug repurposing.", "sections": [{"title": "1 INTRODUCTION", "content": "Drug repurposing, the process of identifying new therapeutic uses for existing drugs, has emerged as a promising strategy to accelerate drug development and reduce costs compared to traditional de novo drug discovery methods [22]. Recent advancements in computational methods have significantly enhanced drug repurposing efforts. These methods utilize various data types, including structural features of compounds or proteins [23], genome-wide association studies (GWAS) [30], and gene expression data [36]. However, a significant challenge persists in translating pre-clinical outcomes to actual clinical therapeutic effects in humans [5].\nReal-world data (RWD), such as medical claims and electronic health records (EHRs), contains valuable information about patient health outcomes, treatment patterns, and patient characteristics. This makes RWD a vital resource for comparing the treatment effects of drugs and identifying those with beneficial effects as repurposing drug candidates [7, 38]. Despite this, existing studies [22, 45] often treat the entire population as homogeneous, overlooking the heterogeneity of treatment responses across patient subgroups. This approach may miss promising drugs that benefit"}, {"title": "2 RELATED WORK", "content": "Drug repurposing on EHRs. EHRs have emerged as a promising resource for drug repurposing as being direct observations from patients, [38]. Several works leverage EHRs for drug repurposing. These methods rely on the treatment effects estimated from the entire population to identify repurposable drug candidates. Specifically, Zang et al. [45] propose a framework that leverages high-throughput emulations for AD drug repurposing. The framework reweights individuals using the stabilized IPTW derived from a regularized logistic regression-based PS model, and it estimates the treatment effects by adjusted 2-year survival difference and HR. Similarly, studies [22, 44] employ PS models for IPTW but estimate the treatment effects by directly comparing the outcomes of treated and control groups. Yan et al. [42] leverage ChatGPT to recommend drugs by expediting the literature review process and evaluating the potential effects of using HR with PS-Matching.\nTreatment Effect Estimation. Many studies have leveraged the power of neural networks for estimating treatment effects [10, 32\u201334]. To apply neural networks for causal inference, several previous works employ a strategy where covariates from different treatment groups are assigned to separate branches. For example, DrangonNet [34] consists of a shared feature network and three auxiliary networks that predict propensity score, and treated and control outcomes, respectively. DR-CRF [16] learns disentangled representations of the covariates to separately predict the potential outcomes and the propensity score. TransTEE [48] leverages the Transformer to model the interaction between the input covariate and treatment."}, {"title": "3 PRELIMINARY", "content": "Longitudinal Patient Data. A patient health record is represented as a sequence of multiple visits in the order of their occurrence, denoted as x = {x1,..., xT }. Each visit is characterized by a series of varying numbers of diagnosis codes, m1, \u2026, m|M| \u2208 M, where |M| is the number of unique diagnosis codes. The t-th visit of the i-th patient is expressed as a binary vector xi,t \u2208 {0,1}|M|, where a value of 1 for the m-th coordinate (i.e. xi,t,m = 1) indicates that the m-th diagnosis code is recorded at that patient's visit. The data is presented as D = {(\u0161i, ti, yi)}Ni=1, where \u0161i is pre-treatment covariates, N is the number of observed samples. ti \u2208 {0, 1} indicates a treatment variable when binary treatment setting, and yi \u2208 R is the observed outcome.\nTreatment Effect Estimation and Subgrouping Given a dataset D = {(xi, ti, yi)}Ni=1, a unit x has two potential outcomes, Y1 (x) given it is treated and Y0 (x) otherwise, following the potential outcome framework [28]. The individual treatment effect (ITE) is expressed as \u03c4(x) := E[Y|T = 1,X] \u2013 E[Y|T = 0,X]. Given an hypothesis f : X \u2192 Y, such that f(x, t) = ht ((x)), we aim to estimate the treatment effect of the hypothesis f for unit x as \u00ee(x) = f(x, 1)"}, {"title": "4 METHOD", "content": "TEE allows for a quantification of the potential benefits or risks of the drug, which enables the accurate assessment of the existing drugs' effects in new therapeutic uses. We leverage TEE as a foundational component of our framework for drug repurposing. Our method, STEDR, innovatively combines TEE with subgroup identification to estimate subgroup-specific treatment effects for targeted drug repurposing. Figure 2 shows an illustration of STEDR."}, {"title": "4.1 Patient-level Representation", "content": "Covariate-level Attention. We investigate the impact of each covariate by covariate-level attention. We assume that each subgroup has distinct characteristics, so the attentions affect both subgroup assignment and the potential outcome.\nTo preserve differences between covariates from being lost, the method learns a different embedding for each covariate. Each covariate is expressed as a sequence of its occurrences across all visits. This sequence is denoted as di,m = {xi,1,m, ..., xi,T,m} for the m-th code of the i-th patient. This vector not only reflects how often the code appears but also preserves the order of its occurrences. The embedding for each covariate is denoted as hi,m = emb(di,m), where hi,m \u2208 RP.\nPatient data poses unique challenges due to irregular temporality, meaning variation in time intervals between visits. Since these intervals often play a crucial role in the outcome, we also incorporate temporal information in covariate embeddings. The time information is measured as the relative time to the time of interest for each visit and is expressed as t\u012f = t1,\u2026, tT . The embedding for time information is expressed as ri\u012f = embt (ti), where ri \u2208 RP. The final covariate embedding for the m-th code is then obtained as follows:\nem = hm + r\n(1)\nNote that ri is applied to all covariates for the i-th patient. To learn and signify the importance of each covariate, we introduce a learnable vector sd. The attention scores are computed as ad \u2208 R|M|\u00d71, where:\nam =\nexp(emsd)\n\u03a3mexp(emsd)\n(2)\nVisit-level Attention. Each patient's data is represented as a series of all visits. We also examine the importance of each visit. The embedding for each visit is obtained as vit = embo (xi,t). Note that visit embeddings for all visits are derived from a single embedding layer. We also introduce a learnable vector s and calculate attention scores a \u2208 RT\u00d71 as follows:\nat =\nexp(vs)\n\u03a3t exp(vs)\n(3)\nPatient-level Attention. With covariate-level and visit-level attention scores, our method obtains patient-level importance, computed"}, {"title": "4.2 Subgroup Representation Learning", "content": "Subgroup representation learning aims to identify potential subgroups by capturing the heterogeneous data distributions and learning subgroup-specific representations. We rely on the following assumptions. First, we assume that heterogeneous subgroups exist within the data, where each subgroup follows a distinct local distribution that captures the specific attributes of that subgroup. The entire population follows a single global distribution reflecting the characteristics of the entire population. Second, the global distribution can be estimated as a mixture Gaussian of the local distributions.\nThe entire population follows the global distribution, with p-dimensional global parameter vectors {\u03bcg, \u03c3g}.\np(z) ~ N(z|\u03bcg, \u03a3g)\n(5)\nWe infer p(z) using \u03a6(xi; \u03c6g), which is the global encoder of the VAE that extracts global parameters. The global encoder \u03a6(\u00b7; \u03c6g) and decoder g\u03c6 of the VAE are optimized using the reconstruction loss to ensure that the global distribution accurately reflects the latent characteristics of the entire population.\nLvae = \u222b p(z|x) log g(x|z)dz = \u222b \u03a6(xi; \u03c6g) log g(x|z)dz (6)\nThe k-th subgroup's local distribution is also characterized by p-dimensional local parameter vectors \u03bc\u03ba and \u03c3\u03ba as follows:\nqk(z) ~ N(z|\u03bc\u03ba, \u03a3\u03ba)\n(7)\nWe infer qk (z) using \u03a6(x\u012f; \u03c6k), which is the k-th local encoder. Note that the global parameters and the local parameters are distinctly extracted from different one-layer encoders.\nGiven a sample x, the global distribution can be estimated as a mixture Gaussian distribution of the local distributions with probabilities of the sample assigned to the subgroups:\np(z) ~ q(z) := \u2211k qk (z) \u2022 p(c = k|x)\n(8)\nThe probability assigned to the subgroup k, p(c = k|xi), can be rewritten, derived from the Bayes' theorem:\np(c = k|xi) =\np(xi|c = k) \u00b7 p(c = k)\np(x)\n=\np(xi|c = k) \u00b7 p(c = k)\n\u2211k' p(xi|c = k') \u00b7 p(c = k')\n(9)\np(xi|c = k) can be estimated using the global distribution. Consequently, we estimate the subgroup probability as the softmax function over similarities between the global and local representations of all subgroups:\np(c = k|xi) =\nexp (sim (\u03a6(xi; \u03c6k), \u03a6(xi; \u03c6g)))\n\u2211k' exp (sim (\u03a6(xi; \u03c6k'), \u03a6(xi; \u03c6g)))\n(10)\nwhere sim() indicates the similarity score, which is calculated using the Euclidean distance.\nThe local distributions are learned by KL Divergence between the mixture Gaussian distribution and the global distribution. It ensures that the local representations are finely tuned to reflect the unique attributes of each subgroup, and the global distribution reflects the diverse characteristics of all subgroups.\nLkl = \u222b p(z) log (p(z)\nq(z))\n(11)\nTo balance the local distributions, we also define a target distribution as a reference, following [43]. This target distribution is defined using soft assignments to subgroups and is used to guide the learning process, expressed as:\nq(c = k|xi) =\np(c = k|xi)2/rk\n\u2211k' p(c = k'|xi)2/rk'\nrk = \u2211i p(c = k|xi)\n(12)\nwhere rk represents the soft assignment frequencies to subgroup k, and p(c = k|xi) calculates the soft assignment probability for subgroup k given xi. The overall loss function, Ltarget, is defined as follows:\nLtd = \u2211i\u2211k q(c = k|xi) \u00b7 log (q(c = k|xi)\np(c = k|xi))\n(13)\nThe total loss function for the subgroup representation network is as follows:\nLsnn = Lkl + Ltd + Lvae\n(14)\nEach sample is assigned to the subgroup with the highest probability, such that k* = argmaxkp(c = k|x). The representation extracted from the corresponding subgroup's encoder, \u03a6(\u00b7; \u03c6k*), is fed into the prediction network."}, {"title": "4.3 Treatment Effect Estimation for Drug Repurposing", "content": "Outcome Prediction. Given the representation of the assigned subgroup, the prediction network estimates both treated and control outcomes. To preserve treatment information within the high-dimensional latent representation, the network assigns features from distinct treatment groups to separate branches. Furthermore, we design additional modules to predict treatment assignment to balance the distributions of treated and control groups and to predict the subgroup assignment to ensure that the latent representations effectively distinguish the unique characteristics of subgroups.\nThe prediction network f(\u00b7; \u0398) is composed of four separate feedforward networks: {fy (x, t; \u03b8y) : RP \u2192 R} for predicting potential outcomes \u0177 (two heads for t \u2208 {0,1}); f(x; \u03b8t) : RP \u2192 R for the treatment assignment t; f (x; \u03b8k) : RP \u2192 RK for subgroup assignment k. The prediction network is optimized as follows:\nLpnn =\n|D|\n\u2211CE(f(\u03a6k\u2217 (xi); \u03b8t), ti) + CE(f(\u03a6k\u2217 (xi); \u03b8k), k)\ni=1\n+ wi\u2022l(f(\u03a6k\u2217 (xi), ti; \u03b8y), Yi)\n(15)\nwhere CE() is the cross-entropy loss and l() represents the mean squared error for continuous outcomes or the cross-entropy loss for binary outcomes. The term wi refers to individual weights.\nPropensity Score Weighting. The weights w aim to reweight the population for confounder adjustment, ensuring that the treated and control groups are comparable and mitigating the influence of confounding variables. They are computed using inverse probability of treatment weighting (IPTW), with the predicted probability of receiving treatment t\u012f and the probability of being in the treated group Pr(T), expressed as wi = Pr(T)/\u00ee\u00bf + (1 \u2212 Pr(T))/(1 \u2013 ti).\nLoss Function and Optimization. To identify subgroups with different treatment effects, we introduce an additional loss function aimed at reducing the overlap between confidence intervals (CIs) of estimated treatment effects across subgroups, which forces the distinct separation of subgroups. The overlap for two intervals is defined as OL(CI\u012f, CIj) = max(0, min(upi, upj) \u2013 max(lowi, lowj)), where CI\u012f, up\u012f, and low\u012f represent the CI, upper bound, and lower bound of subgroup i, respectively.\nThe total overlap penalty given a batch is computed by summing these overlaps for every pair of subgroups, with a strength factor \u03b1, which is expressed as:\nLoverlap = \u03b1\u00b7 \u2211Ki=1\u2211Kj=i+1OL(CIi, CIj)\n(16)\nThe total loss function to optimize the model is expressed as Eq. (17). The training process of the model is outlined in Algorithm 1.\nL = Lsnn + Lpnn + Loverlap\n(17)\nDrug Repurposing with Patient Subgroups. Given an eligible patient cohort for each drug, our framework first estimates the subgroup-specific treatment effects. We then calculate the 95% confidence intervals (CIs) and evaluate the statistical significance of the averages of estimated treatment effects for each subgroup over 100 trials. The framework identifies repurposable drugs that have enhanced effects with p < 0.05 across all or specific subgroups."}, {"title": "5 DEPLOYMENT OF DRUG REPURPOSING FOR ALZHEIMER'S DISEASE", "content": "This study conducts large-scale drug screening of repurposing drugs for Alzheimer's disease (AD) treatment via high-throughput clinical trial emulation on RWD containing over 8 million patients. AD is a highly heterogeneous neurodegenerative disorder, and drug effects may vary based on genetic risk factors and subtypes [26]. In this study, we evaluate the subgroup-based heterogeneous effects of trial drugs on the progression of patients with mild cognitive impairment (MCI) to AD and AD-related dementias (ADRD) [12, 44, 46]. From a total of 1,134 drugs, STEDR emulates 100 trials of each eligible drug to identify new repurposable drug candidates for AD. The following sections detail our data and study design."}, {"title": "5.1 Data", "content": "We used a large-scale real-world longitudinal patient-level healthcare warehouse, MarketScan Medicare Supplemental and Coordination of Benefits Database (MDCR) from 2012 to 2018, which is a claims database that represents health records for over 8 million retirees (aged 65 or older) in the USA. The MarketScan data contains individual-level and de-identified healthcare claims information, including diagnoses, procedures, prescriptions, and demographic characteristics. We identify 155K distinct MCI patients, among whom 40K are diagnosed with AD. MCI and AD patients are identified using the diagnosis codes. The diagnosis codes are defined by the International Classification of Diseases (ICD) 9/10 codes. We map the ICD codes to Clinical Classifications Software (CCS), including a total of 286 codes. For drugs, we match national drug codes (NDCs) to ingredient levels. We use diagnosis codes and their time information to construct input variables for our method."}, {"title": "5.2 Study Design", "content": "Case and Control Cohorts. The estimation of drug effects necessitates a comparative analysis between two cohorts: the case cohort with patients prescribed a trial drug, and the control cohort prescribed alternative drugs. Figure 3 shows our study design with"}, {"title": "6 RESULTS", "content": "We demonstrate the performance of our model, focusing on answering the following research questions:\n\u2022 Q1: How accurate is STEDR on TEE?\n\u2022 Q2: How effective is STEDR on drug repurposing?\n\u2022 Q3: How does STEDR enhance precision drug repurposing?"}, {"title": "6.1 Q1: How accurate is the method on TEE?", "content": "TEE is an effective approach in drug repurposing, as it quantifies the magnitude of the drug effect. The accuracy and reliability of TEE models, therefore, are directly linked to the success of drug repurposing efforts. We conduct a quantitative analysis of TEE using synthetic and semi-synthetic datasets, comparing the proposed method against state-of-the-art neural network-based TEE models [9, 16, 25, 32-34, 48]. Additionally, we compare with two representative subgrouping models [21, 24] to further evaluate the effectiveness of the proposed method in subgroup identification.\nOur method outperforms the baselines on both subgrouping and TEE tasks across all datasets, especially representing a significant reduction in error on TEE performance. Specifically, it achieves 35.3%, 5.6%, and 35.1% lower error than the second-best model, as measured by the precision in the estimation of heterogeneous effect (PEHE). The datasets, baselines, evaluation metrics, experimental setting, and results are detailed in Section A.2 of the Supplemental material."}, {"title": "6.2 Q2: How effective is the method on drug repurposing?", "content": "We screened 1,134 drugs (with 100 emulated trials for each drug) and found 136 that met our study design criteria. From the eligible trials of these drugs, 19 were balanced after applying IPTW"}, {"title": "6.3 Q3: How does STEDR enhance precision drug repurposing?", "content": "Subgroup-Specific Treatment Effect Analysis Figure 5 presents the 95% CIs of the estimated treatment effects in Subgroups 1 to 3, with Subgroup 1 showing the most enhanced effect and Subgroup 3 exhibiting the most diminished effect. We select four example drugs as case studies, which represent a range of response patterns across the subgroups:\n\u2022 Rosuvastatin: This drug demonstrated enhanced ATE, also with HTE consistently below zero across all subgroups. This suggests that Rosuvastatin could be broadly applicable as a repurposable drug for AD.\n\u2022 Trazodone: Although the drug showed beneficial effects in the overall population, some patient subgroups were at risk with these drugs, suggesting that they may not be broadly applicable. This highlights that their application might need to be tailored to avoid risks in certain subgroups, with the importance of identifying subgroup-specific effects."}, {"title": "7 CONCLUSION", "content": "In this work, we address the crucial challenges inherent in computational drug repurposing. We introduce a novel framework that seamlessly integrates patient subgroup identification and TEE for precision drug repurposing. The real-world study demonstrates the efficiency of our method in identifying potential drug candidates and enhancing precise treatment selection. Our work represents a useful framework for precision drug repurposing, especially in its application to complex diseases characterized by varied patient responses."}, {"title": "A APPENDIX", "content": "A.1 Causal Assumption\nOur study is based on three standard assumptions in causal inference [20], which are as follows: (1) Conditional Independence Assumption: The assignment of treatment is independent of the outcome, given the pre-treatment covariates. (2) Common Support Assumption: There is a nonzero probability of the treatment assignment for all samples. (3) Stable Unit Treatment Value Assumption: The observed outcome of each unit remains unaffected by the assignment of treatments to other units. These assumptions are essential in treatment effect estimation as they provide the necessary conditions for unbiased and consistent estimation of causal effects. The assumptions form the basis for our methodology."}, {"title": "A.2 Simulation study", "content": "Treatment Effect Estimation (TEE) is crucial in drug repurposing, as it predicts how an existing drug might influence outcomes and quantifies the magnitude of the drug effect. The accuracy and reliability of TEE models, therefore, are directly linked to the success of drug repurposing efforts, suggesting a strong potential for examining new uses for existing drugs.\nTo assess the predictive performance of our framework, we conduct a quantitative analysis of TEE, comparing it against state-of-the-art neural network-based TEE models [9, 16, 25, 32-34, 48]. Since treated and control outcomes are not simultaneously observable in real-world data, our study employs two synthetic and one semi-synthetic datasets for the quantitative analysis. We also conduct comparative experiments with two representative subgrouping models [21, 24] to further evaluate the effectiveness of the proposed method in subgroup identification.\nA.2.1 Datasets. We use two synthetic and one semi-synthetic datasets, which have both simulated treated and control outcomes for quantitative analysis. The synthetic datasets are entirely composed of simulated data, whereas the semi-synthetic dataset combines real covariates with simulated potential outcomes. The statistics of the datasets are presented in Table 3.\nSynthetic Dataset A. We simulate a synthetic dataset, following existing works [2, 21]. The dataset is inspired by the initial clinical trial results of remdesivir to COVID-19 [41]. The results show that the shorter the time from the onset of symptoms to the start of clinical trials with Remdesivir, the faster the time to clinical improvement. The dataset comprises 10 covariates, each derived from a specific normal distribution. The covariates are: age ~ N(66,4), white blood cell count (\u00d710\u2079 per L) ~ N(66,4), lymphocyte count (\u00d710\u2079 per L) ~ N (0.8, 0.1), platelet count (\u00d710\u2079 per L) ~ N (183, 20.4), serum creatinine (U/L) ~ N(68, 6.6), aspartate aminotransferase (U/L) ~ N (31, 5.1), alanine aminotransferase (U/L) ~ N (26, 5.1), lactate dehydrogenase (U/L) ~ N(339, 51), creatine kinase (U/L) ~ N (76, 21), and time from symptom onset to"}, {"title": "A.2.2 Baselines", "content": "The following is a concise overview of the baseline models for TEE:\n\u2022 TNet [9] is a deep neural network version of T-learner [18].\n\u2022 SNet [9] learns disentangled representations of the covariates, assuming that the covariates can be disentangled into five components, and predicts two potential outcomes and the propensity score by using different components.\n\u2022 DrangonNet [34] consists of a shared feature network and three auxiliary networks that predict propensity score, and treated and control outcomes, respectively.\n\u2022 TARNet [33] consists of a shared feature network for balanced hidden representations and two auxiliary networks that predict treated and control outcomes, respectively.\n\u2022 DR-CRF [16] predicts the potential outcomes and the propensity score by learning disentangled representations of the covariates.\n\u2022 DRNet [32] consists of shared base layers, intermediary treatment layers, and heads for the multiple treatment settings with an associated dosage parameter.\n\u2022 VCNet [25] uses separate prediction heads for treatment mapping to preserve and utilize treatment information.\n\u2022 TransTEE [48] leverages the Transformer to model the interaction between the input covariate and treatment.\nWe also conduct comparative experiments with two representative existing subgrouping models to further evaluate the effectiveness of the proposed method in subgroup identification.\n\u2022 R2P [21] is a tree-based recursive partitioning method.\n\u2022 HEMM [24] utilizes Gaussian mixture distributions to learn subgroup probabilities.\nR2P and HEMM use the CMGP [1] model and a neural network-based model, respectively, to pre-estimate treatment effects for subgroup identification."}, {"title": "A.2.3 Evaluation Metrics", "content": "We employ the precision in estimating heterogeneous effects (PEHE) metric to measure the treatment effect at the individual level, expressed as:\nPEHE =\n1\nN\nN\u2211i=1\n(fy\u2081 (xi) \u2212 fyo (xi) \u2212 E[Y\u2081 \u2212 Yo|xi])\u00b2\n(20)\nAdditionally, we employ the absolute error in average treatment effect (ATE) to assess the overall treatment effect at the population level, defined as:\n\u20acATE = |E[fy\u2081 (x) \u2013 fyo (x)] \u2013 E[y\u2081 - Yo]|\n(21)\nTo evaluate the performance for subgroup identification, we analyze the variance of treatment effects within and across subgroups. The variance across the subgroups evaluates the variance of the mean of the treatment effects in each subgroup, while the variance within subgroups measures the mean of the variance of the treatment effects in each subgroup. They are expressed as:\nVacross = Var ({Mean(TEk)}Kk=1)\n(22)\nVwithin =\n1\nK\u2211k=1Var(TEk)\n(23)\nwhere TEk indicates a set of estimated treatment effects in subgroup k, such that TEk = {E[y|t = 1, x] - E[ylt = 0, x] for all x \u2208 Ck }."}, {"title": "A.2.4 Implementation Details", "content": "All neural network-based models are implemented using PyTorch. We use the SGD/Adam optimizer, with a learning rate set to 0.001 and a batch size of 128. The hyperparameters for the baseline models follow the implementations provided by the respective authors. For our proposed model, we set the hidden nodes from the set {50, 100, 200, 300}, the number of hidden layers in the Transformer and the prediction network from the set {1,2,3}, the number of subgroups from the range of [2, 7], and coefficient a from the range of [0.1, 0.5]. The data is randomly divided into training, validation, and test sets, with a split ratio of 6:2:2. We train the model on the training set and employ a stopping rule based on the performance on the validation set. All results are reported on the test set."}, {"title": "A.2.5 Experimental Results", "content": ""}, {"title": "A.3 Drug Repurposing for Alzheimer's Disease", "content": "A.3.1 Dataset. We used a large-scale real-world longitudinal patient-level healthcare warehouse, MarketScan Medicare Supplemental and Coordination of Benefits Database (MDCR) from 2012 to 2018, which contains individual-level and de-identified healthcare claims information. The MarketScan MDCR database is created for Medicare-eligible retirees with employer-sponsored Medicare Supplemental plans. The MarketScan data are primarily used to evaluate health utilization and services, containing administrative, including patients' longitudinal information, including diagnoses, procedures, prescriptions, and demographic characteristics. We identify 155K distinct MCI patients, among whom 40K are diagnosed with AD. The distribution of gender and age at MCI initiation date and patients' distribution of total time in the database are shown in Figure 8. MCI and AD patients are identified using the diagnosis codes, as shown in Table 6. We consider diagnosis and prescription codes for study variables. The diagnosis codes are defined by the International Classification of Diseases (ICD) 9/10"}, {"title": "A.3.2 Experimental Setup", "content": "In our study, we set the number of clusters to three for all trial drugs. For each drug trial emulation, the data is randomly divided into training, validation, and test sets, with a split ratio of 6:2:2. We train the model on the training set and employ a stopping rule based on the performance on the validation set. The hyperparameters of our model include a which is a penalty strength factor for Loverlap, the number of layers and hidden nodes in the Transformer encoder, the number of hidden nodes in both the local/global distribution in the subgroup representation network, and the number of layers of the prediction network. Notably, the number of hidden nodes in the prediction network is the same as that in the subgroup representation network. We evaluated our model across several trials to determine the optimal hyperparameters and applied these parameters consistently across all drug evaluations. Detailed information about the hyperparameters can be found on our GitHub repository5."}, {"title": "A.3.3 Metrics", "content": "We measure the balance between case and control cohorts by standardized mean difference (SMD) [3] and weighted propensity score area under the curve (AUC) [35] using IPTW from our model to evaluate selection bias. For a continuous covariate, the SMD is calculated as follows:\nSMD =\n(Xtreatment \u2212 Xcontrol)\n\u221a(streatment+s2control)/2\n(24)\nwhere xtreatment and xcontrol represent the mean of the covariate in patients from case and control cohorts, respectively, while streatment and scontrol denote the variance of the covariate. The covariate is considered balanced if its SMD \u2264 0.1 [3, 45]. Emulated trials are regarded as balanced if the proportion of unbalanced covariates is \u2264 2% of all covariates [22, 45]."}]}