{"title": "Latent ArtiFusion: An Effective and Efficient Histological Artifacts Restoration Framework", "authors": ["Zhenqi He", "Wenrui Liu", "Minghao Yin", "Kai Han"], "abstract": "Histological artifacts pose challenges for both pathologists and Computer-Aided Diagnosis (CAD) systems, leading to errors in analysis. Current approaches for histological artifact restoration, based on Generative Adversarial Networks (GANs) and pixel-level Diffusion Models, suffer from performance limitations and computational inefficiencies. In this paper, we propose a novel framework, LatentArtiFusion, which leverages the latent diffusion model (LDM) to reconstruct histological artifacts with high performance and computational efficiency. Unlike traditional pixel-level diffusion frameworks, LatentArtiFusion executes the restoration process in a lower-dimensional latent space, significantly improving computational efficiency. Moreover, we introduce a novel regional artifact reconstruction algorithm in latent space to prevent mistransfer in non-artifact regions, distinguishing our approach from GAN-based methods. Through extensive experiments on real-world histology datasets, LatentArtiFusion demonstrates remarkable speed, outperforming state-of-the-art pixel-level diffusion frameworks by more than 30x. It also consistently surpasses GAN-based methods by at least 5% across multiple evaluation metrics. Furthermore, we evaluate the effectiveness of our proposed framework in downstream tissue classification tasks, showcasing its practical utility. Code is available at https://github.com/bugs-creator/LatentArtiFusion.", "sections": [{"title": "1 Introduction", "content": "Histological Whole Slide Images (WSI) provide ample information on tissue and nuclei structures, serving as a valuable resource for contemporary clinical diagnosis and informing treatment decisions [5,9]. Both pathologists and Computer-Aided Diagnosis (CAD) rely on the analysis of morphological and contextual information present in histological images. Nevertheless, the intricate digitization process and potential mishandling can commonly lead to alterations in tissue structure or staining information, such as tissue folding, bubbles, tissue mask, and other deformation [18,1,21]. Such deformation of tissue structures, namely artifacts in the context of pathology, not only poses challenges for both pathologists and Computer-Aided Diagnosis but also elevates the risk of mis-diagnosis, i.e., incorrectly identifying artifacts as tumors [25]. Many existing methods struggle to achieve satisfactory results in the presence of histological artifacts [28].\nTo address the challenge posed by the histological artifacts, many methods have been proposed based on Generative Adversarial Networks (GANs). For example, AR-CycleGAN [11] employs a Cycle Generative Adversarial Network (CycleGAN) [29,4] to learn the transfer between unpaired artifact and artifact-free images through adversarial learning. This model frames artifact restoration as a domain transfer problem, aiming to transform artifact images into clean images. However, this approach introduces a potential challenge of unintended stain style transfer in non-artifact regions, thereby increasing the risk of misdiagnosis. Additionally, GAN-based models are prone to failures during training due to mode collapse and mode dropping [2], posing challenges for their practical use. Recently, with the success of diffusion models [10,19], ArtiFusion [8] is introduced, which leverages the denoising diffusion probabilistic model [10] to selectively reconstruct the artifact region, aiming to preserve the structural and stain information of non-artifact areas. Further, a lightweight transformer based denoising backbone is employed for efficient histological artifact restoration [24]. While, the restorations is still taken by the denoising process of DDPM within the pixel-level space, which, given its substantial size, results in considerable computational costs. For example, DDPM based methods take approximately 30 times longer processing time compared to GAN-based methods, making it inefficient for real applications.\nIn this paper, we aim to achieve high performance on histological artifacts restoration while maintaining high computational efficiency. To this end, we propose LatentArtiFusion, in which we seamlessly integrate Variational AutoEncoder (VAE) [13] and the Denoising Diffusion Probabilistic Model (DDPM) [10]. This combination enables a denoising process within a perceptually equivalent space with lower-dimensions, thereby preserving the high performance of DDPM and achieving comparably lower computational costs. Moreover, a latent regional denoising process is proposed to simultaneously leverage and preserve the semantic information of adjacent non-artifact regions, specifically tailored for artifact restoration.\nOur major contributions are: (1) We present a framework for histological artifact restoration, as the first attempt at latent diffusion models driven framework for histological artifact restoration. This approach opens up new possibilities for artifact restoration in histopathology. (2) We propose a novel regional latent de-noising algorithm guided by artifact masks, allowing selective reconstruction of the artifact regions. This algorithm effectively preserves the stain style of non-artifact regions, resulting in visually consistent and coherent restorations. (3) Our method demonstrates superior efficiency, significantly surpassing previous pixel-level diffusion frameworks (e.g., by over 30 times faster compared with ArtiFusion) in processing speed. Additionally, we achieve state-of-the-art results"}, {"title": "2 Method", "content": "2.1 Preliminary in Diffusion Models\nDenoising Diffusion Probabilistic Model (DDPM) [10]. DDPM learns the complex data distribution through diffusion and denoising process. In diffusion process, given the input data $Xo \\sim p(X)$, random Gaussian noise is gradually added into $Xo$ to obtain the noisy version $Xt$ for timestep $t \\in N[0, T]$ following the Markov process $q(xt|xt\u22121) = N(xt; \\sqrt{1 \u2013 \\beta_t}xt\u22121, \\beta_tI)$, where $T$ is the total diffusion timesteps, $\u0425\u0442 \\sim N(0, I)$ represents white noise without any semantic information, and $\u03b2t$ is the hyper-parameter representing the variance schedule. In the denoising process, a U-shaped denoising network with parameter 0 is trained to reverse the diffusion process $q(xt|xt\u22121)$ to learn $po(xt-1|xin)$ and gently denoise $XT$ back to $Xo$ to recover the information of data $Xo$. The overall training objectives are formulated by the variational lower bound of the negative log-likelihood and can be written as:\n$L = Eq[DKL(q(xT|xo)||p(XT) + \\sum DKL(q(xt-1|Xt, xo))||po(Xt-1|Xt) - log po (XoX1)]$,\n$LT$\n$t>1$\n$Lt-1$\n-\n$Lo$\nwhere $DKL(||\u00b7)$ is the KL divergence.\nLatent Diffusion Models (LDM) [17]. Denoising in large data space, i.e., pixel-level space $RW\u00d7H\u00d73$, is relatively computationally costly and inefficient. To reduce the computational costs, LDM conducts the diffusion and denoising"}, {"title": "2.2 LatentArtiFusion", "content": "Overall Pipeline. The comprehensive architecture of our proposed framework is illustrated in Fig. 1(a). The framework comprises two key stages: training and inference, constituting the backbone of our restoration approach. During the training stage, our primary objectives involve the training of a latent diffusion model. This model assimilates contextual information and captures the color distribution inherent in real artifact-free histology images. In the inference stage, We propose a novel latent regional denoising algorithm to selectively reconstruct artifact regions in latent space leveraging the semantic information of nearby artifact-free regions to preserve the morphological details of non-artifact regions and maintain visual consistence in reconstructed artifact regions. Fig. 1(b) visually represents the latent regional denoising process in pixel-level space to demonstrate the gradual reconstruction of the artifact region.\nModel Training. For efficiency, we follow the formulation of the latent diffusion model to train our model from scratch in a lower-dimensional latent space. Initially, we utilize a pre-trained Variational Autoencoder (VAE) [13] to compress the input image $X \u2208 RW\u00d7H\u00d73$ into the latent space $Rwxhxc$. Subsequently, we perform the diffusion and denoising processes within this latent space, aiming to enhance computational efficiency. Given a compressed image $Zo = \u03b5(X) \u2208 Rwxhxc$, random Gaussian noises are gruadually injected following the Markov Chain $q(zt|Zt-1) = N(zt; \\sqrt{1 \u2013 \\beta_t}zt-1, \\beta_tI)$, as shown in Fig. 1 (a).\nSubsequently, we train a U-shaped denoising network, which takes z\u0142 conditioned on the time t as input, to predict the corresponding noise added from zt\u22121 to z\u0142 in the denoising process. This allows us to learn $po(Zt-1|zt)$ and sample the noisy data back to input data zo step by step.\nCrucially, we utilize the pre-trained VAE \u00b9 by [17], and all parameters of the VAE are frozen throughout the model training process.\nRegional Denoising in Latent Space. During the inference stage, we introduce an innovative latent regional denoising algorithm. This algorithm selectively focuses on reconstructing the artifact region in the latent space, deviating from the conventional approach of reconstructing the entire image. As shown in Fig. 2, the compressed histology image with artifacts and its corresponding artifact mask in the latent space retain the semantic information of artifacts, we leverage the compressed mask to precisely guide the restoration process, focusing exclusively on the artifact regions. To perform regional denoising in the artifact region while preserving non-artifact regions in the latent space, we encode the Boolean mask representing the localization of the artifact region into the latent space (denoted as M). At each denoising timestep t, the input to the denoising network (0) is a concatenation of the noised non-artifact regions (occurring t times) with the denoised artifact region obtained from the denoising network at the previous step (t + 1). The whole latent regional denoising process can be formulated as follows:\n$Z_t = Denoising [Z^{sample}_{t+1} M + Z^{output}_{t+1}(1 - M)]$,\n$Z^{sample}_{t+1} = \\sqrt{a_t}Zo + \\sqrt{1 \u2013 a_t}e_t$,\n(1)\nwhere $Z^{sample}_{t+1}M$ is non-artifact region diffused as t times from the compressed input data Zo, following the forward Gaussian process with $\u0101_t = \u03a0_{i=1}^t(1 \u2013 \u03b2\u03b5)$. Additionally, $Z^{output}_{t+1}$ denotes the output of the denoising network at previous timestep i.e., $po(z^{output}_{t+2}_{t+1})$, and the $Zt$ is used as $Z^{output}_{t+1}$ in subsequent time step. Through iteration, the reconstructed sample can be obtained as $2o = Denoising[Z^{sample}_{t+1} M + Z^{output}_{t+1}(1 \u2013 M)]$"}, {"title": "3 Experiments", "content": "3.1 Implementation details\nWe implement the proposed LatentArtiusion in Python 3.10 and PyTorch 2.1 with Diffusers [16]. Hyperparameters are set as follows: batch size is 16, learning rate is 1 \u00d7 10-4 with the Adam optimizer, the downsample factor of the VAE is set to 8, linear variance scheduler is used, and the number of total timesteps is set to 50."}, {"title": "3.2 Datasets", "content": "We use a subset of Camelyon17 [14] comprised of 2445 artifact-free images with the resolution of 256 \u00d7 256 as the training set 2. To evaluate the performance and robustness of our model, we test on two different data sources containing multiple cell types. (1) Histology: a public histology dataset 3, which is widely used for nuclei segmentation task [12,9], consists of 462 artifact-free images collected from multiple patients with densely clustered nuclei. (2) MoNuSAC 2020 [22]: another public dataset of 154 artifact-free tissue images scanned from various organs. In the two test sets, we manually synthesize artifacts into original artifact-free images to obtain paired artifact and artifact-free images for performance evaluation."}, {"title": "3.3 Comparison and Results", "content": "To quantitatively analyze the restoration performance and computational efficiency, we measure the similarities between unprocessed clean images and restored artifact images using the following evaluation metrics, L2 distance (L2) over the whole image, the mean-squared error (MSE) specifically focused on the artifact region, structural similarity index (SSIM) [26], peak signal-to-noise ratio (PSNR) [3] and feature-based similarity index (FSIM) [27]. Additionally, we measure the time costs during inference. We compare our model with the state-of-the-art models, CycleGAN [29] and ArtiFusion [8].\nQuantitative comparisons across two distinct data sources highlight the success of our proposed framework in effectively reconstructing tissue structures within artifact regions while maintaining high computational efficiency. The substantial performance gaps observed across all evaluation metrics between CycleGAN [29] and our method corroborate that our latent regional denoising algorithm excels in selectively reconstructing the artifact region while successfully preserving both color and structural information in non-artifact regions. In contrast to the previous pixel-level approach of ArtiFusion [8], denoising in the latent space accelerates the inference time by more than 30 times, resulting in a substantial reduction from 30 seconds to just 0.8 seconds. Moreover, fewer reconstruction steps are required, leading to significant savings in computational resources.\nOverall, our method outperforms the other methods in all metrics across different datasets of various nuclei types collected from multiple organs. At the same time, our method obtains a significant increase by 30x and 1.2\u00d7 respectively in the inference time compared with ArtiFusion [8] and CyclyGAN [29]."}, {"title": "3.4 Downstream Classification Evaluation", "content": "To validate the effectiveness of our framework in reducing the misdiagnosis rate, we further conduct a downstream classification task. We utilize the publicly available NCT-CRC-HE-100K tissue classification dataset for training and the CRC-VAL-HE-7K dataset for testing. The training set comprises a total of 100,000 samples, while the test set consists of 7, 180 samples. Various classification models are employed to ensure the robustness of the evaluation across different model architectures. After training all classification models on the training set, we assess their performance on the test data under three different conditions: (a) clean images, (b) images with synthetic artifacts, and (c) artifact images restored by a specific method. Note that the classification result on clean images serves as the upper bound, while the test result on artifact images represents the lower bound.\nA substantial decrease of up to 15% in the classification results across all models is observed when comparing unprocessed data to data with artifacts, demonstrating the disruptive impact of artifacts on deep-learning approaches. The considerable performance gap between CycleGAN [29] and diffusion-based methods further validates the superiority of the denoising diffusion model in histological artifact restoration. Crucially, artifact images restored by our method exhibit the highest classification performance across various model architectures when compared with artifact images reconstructed by CycleGAN [29] and ArtiFusion [8]. Through restoration by our framework, the classification accuracy is improved from approximately 80% to a remarkable 93%, which is very close to the classification result using clean images. This underscores the practical effectiveness of our framework in downstream tasks."}, {"title": "4 Conclusion", "content": "In this paper, we have presented an efficient and effective framework, LatentArtiFusion, for histological artifact restoration, which subtly integrates VAE and DDPM, resulting in a strong model for artifact restoration in a lower-dimensional latent space, leading to a significant increase in computational efficiency. Further, we have introduced a regional denoising algorithm in the latent space that successfully preserves the tissue and nuclei information of non-artifact regions. The experimental results demonstrate the superiority of our method over previous works across multiple datasets."}, {"title": "Disclosure of Interests", "content": "The authors have no competing interests to declare that are relevant to the content of this article."}]}