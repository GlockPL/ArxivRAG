{"title": "3D Nephrographic Image Synthesis in CT Urography\nwith the Diffusion Model and Swin Transformer", "authors": ["Hongkun Yu", "Syed Jamal Safdar Gardezi", "E. Jason Abel", "Daniel Shapiro", "Meghan G. Lubner", "Joshua Warner", "Matthew Smith", "Giuseppe Toia", "Lu Mao", "Pallavi Tiwari", "Andrew L. Wentland"], "abstract": "Purpose: This study aims to develop and validate a method for synthesizing 3D\nnephrographic phase images in CT urography (CTU) examinations using a dif-\nfusion model integrated with a Swin Transformer-based deep learning approach.\nMaterials and Methods: This retrospective study was approved by the local In-\nstitutional Review Board. A dataset comprising 327 patients who underwent\nthree-phase CTU (mean \u00b1 SD age, 63 \u00b1 15 years; 174 males, 153 females) was\ncurated for deep learning model development. The three phases for each patient\nwere aligned with an affine registration algorithm. A custom deep learning model\ncoined dsSNICT (diffusion model with a Swin transformer for synthetic nephro-\ngraphic phase images in CT) was developed and implemented to synthesize the\nnephrographic images. Performance was assessed using Peak Signal-to-Noise\nRatio (PSNR), Structural Similarity Index (SSIM), Mean Absolute Error (MAE),\nand Fr\u00e9chet Video Distance (FVD). Qualitative evaluation by two fellowship-\ntrained abdominal radiologists was performed.\nResults: The synthetic nephrographic images generated by our proposed ap-\nproach achieved high PSNR (26.3 \u00b1 4.4 dB), SSIM (0.84 \u00b1 0.069), MAE (12.74\n\u00b1 5.22 HU), and FVD (1323). Two radiologists provided average scores of 3.5\nfor real images and 3.4 for synthetic images (P-value = 0.5) on a Likert scale of\n1-5, indicating that our synthetic images closely resemble real images.\nConclusion: The proposed approach effectively synthesizes high-quality 3D\nnephrographic phase images. This model can be used to reduce radiation dose in\nCTU by 33.3% without compromising image quality, which thereby enhances\nthe safety and diagnostic utility of CT urography.", "sections": [{"title": "1\nIntroduction", "content": "Hematuria, the presence of blood in the urine, affects up to 31.4% of the general adult\npopulation in the United States (1). CT urography is a tailored imaging protocol to\nevaluate the various causes of hematuria (2). Etiologies of hematuria include stones,\ninfection, renal masses, or urothelial tumors (3). The conventional approach to CT\nurography is a single bolus protocol (4), consisting of three phases: the non-contrast\nphase, the nephrographic phase, and the excretory (or urographic) phase. Non-contrast\nimages are first acquired to detect stones and also to establish a baseline attenuation for\npotential tumor enhancement on subsequent CT phases. Images in the nephrographic\nphase are acquired approximately 90 seconds after the intravenous injection of io-\ndinated contrast. This time is optimized for evaluation of the renal parenchyma and to\ndetect enhancement of both renal and urothelial lesions. The third set of images is ac-\nquired 10 minutes after the initial contrast injection. At this final time point, the contrast\nhas been excreted into the renal collecting system and is used to detect smaller urothe-\nlial lesions or other abnormalities of the collecting systems, ureters, and bladder. Each\nof these three phases provides unique information about the kidneys and urinary tract,\nand each phase is invaluable in the workup of hematuria. However, 3-phase CT urog-\nraphy requires approximately twice the examination time and three times the radiation\ndose of a standard portal-venous-phase CT (5).\nTo reduce radiation dose, an alternative CT urography protocol, termed split-bolus\nCT urography has been developed (6). In split-bolus CT urography, non-contrast im-\nages are first acquired. Subsequently, a bolus of iodinated contrast is injected (often\n50% of the total dose), and at this time point no images are acquired. After a delay, the\nremaining bolus is injected and after approximately 90 seconds the second set of images\nis acquired. This second set of images combines the nephrographic and urographic im-\nages into a single acquisition. Unfortunately, this split-bolus technique inherently lacks\na dedicated nephrographic phase set of images, and moreover prior studies have shown\nthat split-bolus CT urography provides worse contrast opacification (7,8) and worse\ndistention of the urinary tract (9,10) compared to the single bolus three phase CT urog-\nraphy technique. Furthermore, small urothelial lesions can be masked on excretory\nphase images in split-bolus CT urography (11,12), and thus may be missed. Alternative\nmethods for reducing the number of acquisitions in CT urography would aid in reducing\nthe overall radiation dose.\nThe development of deep learning has revolutionized medical image synthesis, lead-\ning to the creation of highly sophisticated methods that can generate realistic medical\nimages. Such deep learning models have achieved some success with synthesizing im-\nages between modalities (for example MRI to CT and vice versa) (13), but the task has\nbeen challenging due to the non-linearity between imaging modalities and the highly\nill-posed nature of this synthesis task (14). Within-modality image synthesis has also\nbeen investigated primarily with MRI, in which contrast-enhanced images are synthe-\nsized from the other soft tissue contrast weightings acquired in MRI (15-18). Such a\ntask is theoretically achievable due to the information contained within different MRI\ntissue-contrast weightings that inform whether a structure should or should not be en-\nhancing. The task of within-modality image synthesis in CT has had much more limited\nsuccess. Specifically, the synthesis of contrast-enhanced CT images from non-contrast\nimages has been performed in several investigations (19-23). However, such ap-\nproaches have struggled due to the limited biologic information contained within the\nsingle set of non-contrast CT images and therefore have not led to diagnostically usable\nimages; rather, these synthesized images have largely been used for radiation dose plan-\nning and/or organ segmentation. In other words, these models fail to distinguish reliably\nbetween an enhancing mass and a non-enhancing mass. Consequently, the development\nof an image synthesis deep learning model that utilizes both pre- and post-contrast in-\nformation in CT would thereby contain the needed biologic information for generating\nother post-contrast images and moreover would take advantage of the linearity inherent\nto within-modality image synthesis tasks. CT imaging protocols that have three or more\nacquisitions, including pre- and post-contrast images, are well-suited to this task. CT\nurography is one such imaging protocol that includes both pre- and post-contrast im-\nages and can thereby benefit from optimization techniques. Hence, we propose using\nthe non-contrast and excretory phase images as inputs to synthesize the nephrographic\nphase images.\nThe elimination half-life of iodinated contrast agents is 90-120 minutes in subjects\nwith normal renal function and substantially longer in those with impaired renal func-\ntion (24). Therefore, images acquired during the urographic phase at ~10 minutes post-\ninjection also contain nephrographic information. The synthesis of nephrographic\nphase images is achievable due to the redundancy of information contained within the\nurographic phase images.\nRecently, diffusion models (25) have shown great performance in image generation.\nThese models generate images by iteratively adding and then removing noise from data.\nThis diffusion process can make image generation more stable and easier to fine-tune\ncompared to classical image generation approaches like Generative Adversarial"}, {"title": "2 Materials and Methods", "content": "This retrospective study was compliant with the Health Insurance Portability and Ac-\ncountability Act and approved by the institutional review board. Informed consent was\nwaived given the retrospective nature of the study. A retrospective dataset was curated\nfrom our institution and locoregional hospitals from studies acquired between 2009 and\n2024. Our dataset pertains to the CT urography study and is specific to the three-phase\nCT urography. We excluded cases involving any phases that have incomplete kidney\nslices. The data set includes 819 patients (mean \u00b1 SD age 68\u00b1 10 years; 524 males and\n295 females; slice thickness 3.75 mm; kilovolt peak 120-140 kVp). Additionally, we\nused the non-contrast CT images and paired annotations from public dataset KiTS19\n(34) for training a kidney segmentation model during the data preprocessing step. The\npipeline of our proposed approach is shown in Fig. 1."}, {"title": "2.1 Data preprocessing", "content": "The original DICOM data of each patient were collected through PACS (35). We se-\nlected the phase that has the smallest number of slices (Z) to determine the slice"}, {"title": "2.2\nDiffusion Model", "content": "We denote the real nephrographic image as Xo and the corresponding non-contrast and\nexcretory images as Y, which serve as the condition for the diffusion model. The\nnephrographic image X, is progressively subjected to Gaussian noise until it becomes\na highly noisy image xt. The noisy nephrographic image xt depends on the noisy image\nXt-1 through the Markov chain (25) process q. However, estimating q is challenging.\nTherefore, we replace to estimate q by training a model, parameterized by 0, to effec-\ntively approximate it:\n$P_\u03b8 (X_{t\u22121}|X_t, Y ) = N(X_{t\u22121}; \u03bc_\u03b8 (X_t, t, Y), \u03a3_\u03b8 (X_t, t, Y))$\nwhere \u03bce and \u03a3e are matrices learned by the resblcok (37) and swin-transformer (33)\nbased network 0 for mean and variance of the estimated Gaussian distribution. The\narchitecture of our proposed method is shown in Fig. 2.\nWe can gradually denoise XT to obtain the noise-free nephrographic image Xo by\nremoving the noise &e predicted by 0. During the sampling stage, we input the non-\ncontrast and excretory images along with Gaussian noise into the pretrained diffusion\nmodel. Consequently, we can synthesize the nephrographic image. The best model was\nselected based on its performance on the validation dataset.\nAt the patient-level we randomly selected 30 patients for validation, 30 patients for\ntesting, and the remaining 267 patients for training. Due to hardware limitations, we set\ninput data size to 192\u00d764\u00d732. We also performed data augmentation on the training\ndata. First, we used a sliding window approach, selecting a 32-slice window and moved\nit step-by-step through the entire volume to generate multiple overlapping sub-volumes.\nSecond, we applied rotation and flipping to these sub-volumes. We utilized an NVIDIA\nA100-SXM4-80GB GPU with a batch size of 4. The AdamW optimizer was applied\nwith Mean Absolute Error (MAE) loss and a learning rate of 2 \u00d7 10-5."}, {"title": "2.3\nEvaluation", "content": "We evaluated and compared our approach using four metrics: (1) Peak Signal-to-Noise\nRatio (PSNR), (2) Structural Similarity Index (SSIM), (3) Mean Absolute Error (MAE)\nof attenuation value, and (4) Fr\u00e9chet Video Distance (FVD) (38). We compared our\nproposed approach with the original diffusion model, 3D DDPM (25), and two autoen-\ncoder-based approaches: 3D VQVAE (39) and 3D AutoencoderKL which applies the\nKullback-Leibler regularization (40) in the Autoencoder (28). Additionally, we evalu-\nated a GAN-based approach, 3D CycleGAN (41). The same dataset was used for train-\ning, validation, and testing of these comparison models.\nIn addition to those metrics, two fellowship-trained radiologists (with 8 and 5 years\nof experience in abdominal imaging) evaluated the synthetic nephrographic images."}, {"title": "3\nExperimental Results", "content": "The performance of our approach and other comparison methods is shown in Table 1.\nOur proposed method performed exceptionally well across all four metrics: PSNR\n26.29 \u00b1 4.41 dB, SSIM 0.84 \u00b1 0.069, MAE 12.74 \u00b1 5.22, and FVD 1323. The DDPM\napproach performed worse than dsSNICT, achieving PSNR 24.14 \u00b1 3.69 dB, SSIM\n0.72 \u00b1 0.131, MAE 19.90 \u00b1 9.16, and FVD 2663. CycleGAN had the lowest perfor-\nmance among all comparison methods. The VQVAE achieved a PSNR 25.80 \u00b1 3.82\ndB, an SSIM 0.827 \u00b1 0.057 and an MAE 13.76\u00b15.87. However, it recorded the highest\nFVD of 6181, indicating that the synthetic images generated by VQVAE have the great-\nest distance from the real images. The kidney segmentation model used in image pre-\nprocessing step achieved a Dice score of 0.94."}, {"title": "3.1 Model Performance", "content": "First, we randomly selected 125 slices of the synthetic images. We then selected 125\nslices of paired ground truth images, resulting in a total of 250 2D images in the evalu-\nation pool. These 250 images were then shuffled for the radiologists' evaluation. This\nnumber of images provides a tolerance of 0.1 with 80% power to detect differences in\nscores between ground truth and synthetic images (computation performed with a bi-\nnomial [chi-square] test on sensitivity). Both radiologists evaluated the same set of im-\nages, scoring them on a Likert scale of 1-5, where 5 indicates excellent image quality.\nInter-rater agreement was assessed using the intraclass correlation coefficient (ICC)\n(42). For each rater and their average, real and synthetic images were compared using\nthe Wilcoxon rank sum test. P values < 0.05 were considered statistically significant.\nAll analyses were performed using R version 4.4.2."}, {"title": "3.2\nImage Quality Analysis", "content": "Fig. 3 presents examples of synthetic nephrographic images and their absolute errors.\nThe synthetic images generated by our proposed method, dsSNICT, demonstrate ex-\ncellent realism, particularly in the depiction of kidneys and renal cysts. Other methods\nshow significant differences compared to our approach, especially in the area of renal\ncysts. Fig. 4 provides more details about the renal cysts in the synthetic image exam-\nples. We plotted the histogram of attenuation values in the marked region. The attenu-\nation value distribution by our method (Fig. 4b) closely matches that of real images,\nindicating that the renal cysts in the synthetic images generated by our approach not\nonly resemble real images visually but also have very similar attenuation values.\nTo distinguish renal cysts from renal masses, radiologists need to check the attenu-\nation of the region of interest (ROI) in both non-contrast and nephrographic phases.\nFig. 5 shows synthetic image examples of renal cysts and renal masses generated by\nour proposed method. In Example 1, the average attenuation of the ROI in the real\nnephrographic phase image is 63.9 HU, while in the synthetic nephrographic image, it\nis 63.4 HU, indicating a close match. The average attenuation value of the non-"}, {"title": "3.3\nExpert Review Results", "content": "Table 2 presents the score summaries from the two radiologist raters. The Intraclass\nCorrelation Coefficients (ICCs) for inter-rater agreement and the 95% confidence in-\ntervals (CI) are as follows: for synthetic images, -0.05 (-0.222, 0.126); for real images,\n0.087 (-0.089, 0.258); and overall, 0.018 (-0.106, 0.142). These ICCs indicate weak"}, {"title": "4\nDiscussion", "content": "This study utilized a diffusion model with a Swin transformer backbone to synthe-\nsize the nephrographic phase images in CT urography studies from the texture and spa-\ntial details obtained from the corresponding non-contrast and urographic CTU phases.\nThis approach enables the reduction of a three-phase acquisition to a two-phase acqui-\nsition, effectively lowering the radiation dose by one third compared to the original\nmethod.\nThe CT urography examinations impart high radiation dose, raising the risk of radi-\nation-induced malignancy. Conventional CT urography studies acquire three full"}, {"title": "4.4.2 One", "content": "We gave more weight to $SSIM_{UN}$ because urographic contains both important morpho-\nlogical and attenuation information. Finally, considering the number of cases used for\nthe synthetic model training, as well as the quality of registration, we set a threshold of\n0.65 and selected patients with $SSIM_{select} > 0.65$. Consequently, we selected 327 pa-\ntients (63 \u00b1 15 years; 174 males and 153 females) for the synthetic model experiment.\nDue to this registration step\u2013reducing the Z dimension to\n$Z\u2032$ , which varies by patient. Finally, the cropped images were used for the second regis-\ntration (Fig. 1c) for optimization specifically for the kidneys.\nAfter preprocessing, some patients\u2019 registration results were still poorer than ex-\npected due to artifacts and peristalsis interference, as the cropped images may still have\ncontained stomach and bowel. To automatically select patients with good registration,\nwe used Structural Similarity Index (SSIM). First, we calculated the SSIM between\nnon-contrast and nephrographic phases ($SSIM_{NN}$), the SSIM between non-contrast and\nurographic phases ($SSIM_{NU}$), and the SSIM between urographic and nephrographic\nphases ($SSIM_{UN}$). Then we obtained the final SSIM ($SSIM_{select}$) using the following\nfunction:\n$SSIM_{select} = 0.2 \u2217 SSIM_{NN} + 0.1 \u2217 SSIM_{NU} + 0.7 \u2217 SSIM_{UN}$\n (1)"}, {"title": "86 Table", "content": "agreement between the raters, likely due to differences in their training programs and\nperspectives on image quality evaluation. Despite the weak agreement, the scores sug-\ngest that synthetic images closely resemble real images. Rater 1 rated 69.6% of syn-\nthetic images with scores of 4 to 5, indicating high image quality. In contrast, Rater 2\npredominantly assigned a medium score of 3 to both real and synthetic images, resulting\nin lower average scores compared to Rater 1. However, the mean scores in Table 3\nshow that synthetic images are very similar to real images. Notably, Rater 1's mean\nscore for synthetic images is even higher than for real images, and Rater 2's mean scores\nfor both image types are also very close. Therefore, the synthetic images generated by\nour approach appear realistic and closely match the real images."}, {"title": "Table", "content": "abdominopelvic sets of images, thus raising concerns regarding the degree of radiation\nexposure imparted to patients, particularly young patients. A split-bolus CT urography\ntechnique has previously been developed to reduce radiation dose. Yet, a prior survey\nfound that the majority (76%) of radiologists employ three-phase CT urography over\nsplit-bolus CT urography (43), likely due to the optimized soft tissue contrast the ded-\ndicated nephrographic phase images provide via the 3-phase CT urography technique.\nDeep learning data-driven approaches have shown great potential in medical imag-\ning synthesis, with diffusion model-based approaches recently demonstrating excellent\nperformance in image generation. Additionally, the Swin transformer has shown good\nperformance in applying the transformer structure to the imaging domain. Thus, a Swin\ntransformer-based network would be a strong backbone for the diffusion model. For\nthe input to this Swin transformer-based diffusion model, we note that both the non-\ncontrast and urographic phases contain important texture, morphological, and geomet-\ntric features. The urographic phase, in particular, offers contrast attenuation information\nuseful for nephrographic synthesis. Therefore, we propose applying this Swin trans-\nformer-based diffusion model to synthesize the nephrographic phase image using the\nnon-contrast and urographic phase images.\nWe compared our method with four popular approaches and found that it achieved\nthe best performance. Our method outperformed the original 3D DDPM, demonstrating\nthat the Swin transformer effectively extracts information. Although the synthetic im-\nages generated by VQVAE had a good PSNR score, they appeared too smooth and\nblurry, making them unrealistic. Therefore, we used another evaluation metric, FVD.\nThe unrealistic nature of VQVAE-generated images resulted in a high FVD score. Fur-\nthermore, the synthesized nephrographic images produced by our approach showed\nmore accurate shapes and attenuation values of kidney tumors compared to other meth-\nods, as illustrated in Fig. 3 and Fig. 4. Additionally, our approach has great potential to\nmaintain the consistency of nephrographic phase images. The synthetic images gener-\nated by our method displayed great details of the cortex and medulla, as shown in Fig.\n6, overcoming the variations in the nephrographic phase caused by heart or liver func-\ntion.\nA single metric or even multiple metrics may not fully and objectively evaluate syn-\nthetic image quality. Consequently, we invited two fellowship-trained radiologists to\nevaluate the synthetic images generated by our approach. Despite weak inter-rater\nagreement (ICC) between these two radiologists, the mean scores from both radiolo-\ngists indicated that the synthetic images closely resembled real images. One rater even\ngave higher mean scores to synthetic images than real ones, suggesting that our syn-\nthetic images not only look similar to real images but also have high quality.\nThe main goal of this study is to synthesize diagnostic quality nephrographic phase\nimages from the dual inputs of non-contrast and urographic phase images from three-\nphase CT urography examinations. Results from this study demonstrate that the syn-\nthesized nephrographic phase images provide high fidelity of attenuation values, which\nallows for the differentiation between benign entities, such as hemorrhagic/proteina-\nceous cysts, and renal neoplasms. Such preliminary findings set the stage for further\ninvestigation into incorporating the synthesized images info clinical practice, which\ncould be further evaluated with a cross-over radiologist reader study to compare CT\nurography data sets with synthetic images to those with ground truth nephrographic\nimages."}, {"title": "One major limitation in this study is multi-phase image registration. Currently, we", "content": "lack annotated data for each phase, preventing us from using organ masks in registration\nalgorithms. Additionally, achieving accurate registration in abdominal CT is challeng-\ning due to the complex abdominal environment. Unlike the brain or other body parts,\nsome abdominal organs, such as the stomach and bowel, exhibit peristalsis, which can\nhinder registration performance. Moreover, most current deep learning-based registra-\ntion algorithms strictly limit the number of slices to under 32 or the image size of each\nslice to below 256 pixels due to hardware limitations (44,45). These limitations make\nthese algorithms unsuitable for our study, as most patients have more than 32 slices,\nincluding the kidneys. Shrinking the image size may result in the loss of important in-\nformation about kidney tumors and cysts. To address these issues, we proposed a three-\nstep registration strategy using an affine registration algorithm. We performed registra-\ntion twice and cropped images before the second registration to reduce the interference\nof peristalsis. However, some cases may still include parts of the stomach or bowel in\nthe cropped images. Additionally, some cases have serious artifacts in one or more of\nthe three phases, leading to poorer registration results than expected. Since we are using\nsupervised learning, the ground truth is crucial for the model's performance. Therefore,\nwe used SSIM with a thresholding value to select 327 patients from a total of 819 for\nthe synthetic model experiment. Another limitation is the lack of data from external\ninstitutions. However, we collected data from eight local hospitals in our cohort. Alt-\nhough the imaging protocols vary slightly, the patient population is essentially the\nsame, as all participants are from the same region. It is also worth noting that we cur-\nrently set the window and level to 400 and 50 in the preprocessing step for better reg-\nistration and easier training of the synthetic model. However, this can be overcome in\nthe future by applying an advanced registration algorithm and more iterations of syn-\nthetic model training. Therefore, we will apply the full range of attenuation values in a\nfuture study.\nIn summary, the dsSNICT model effectively established a methodology for synthe-\nsizing nephrographic phase images from the other phases in a single-bolus three phase\nCT urography examination, which facilitates a 33% reduction in radiation dose. The\nframework developed by this model has the potential to enhance the efficiency of other\nmulti-phase CT examinations."}]}