{"title": "TSBP: Improving Object Detection in Histology Images via Test-time Self-guided Bounding-box Propagation", "authors": ["Tingting Yang", "Liang Xiao", "Yizhe Zhang"], "abstract": "A global threshold (e.g., 0.5) is often applied to determine which bounding boxes should be included in the final results for an object detection task. A higher threshold reduces false positives but may result in missing a significant portion of true positives. A lower threshold can increase detection recall but may also result in more false positives. Because of this, using a preset global threshold (e.g., 0.5) applied to all the bounding box candidates may lead to suboptimal solutions. In this paper, we propose a Test-time Self-guided Bounding-box Propagation (TSBP) method, leveraging Earth Mover's Distance (EMD) to enhance object detection in histology images. TSBP utilizes bounding boxes with high confidence to influence those with low confidence, leveraging visual similarities between them. This propagation mechanism enables bounding boxes to be selected in a controllable, explainable, and robust manner, which surpasses the effectiveness of using simple thresholds and uncertainty calibration methods. Importantly, TSBP does not necessitate additional labeled samples for model training or parameter estimation, unlike calibration methods. We conduct experiments on gland detection and cell detection tasks in histology images. The results show that our proposed TSBP significantly improves detection outcomes when working in conjunction with state-of-the-art deep learning-based detection networks. Compared to other methods such as uncertainty calibration, TSBP yields more robust and accurate object detection predictions while using no additional labeled samples. The code is available at https://github.com/jwhgdeu/TSBP.", "sections": [{"title": "1 Introduction", "content": "Object detection methods enable automated localization and classification of key objects in images, and play an important role in various areas such as medical image analysis and disease diagnosis. In recent years, with the rapid development of deep learning, object detection has made significant improvements in the field of biomedical research, driving innovation in medical image diagnostics and biomedical studies [3,4,13].\nA confidence score of each detected bounding-box is often generated by a detection model, which reflects the level of certainty that the detection is correct [5]. Fig. 1 showcases the predicted results of object detection models on two histology images. Higher confidence thresholds (e.g., 0.90) can effectively reduce false positives but lead to false negatives, while lower thresholds (e.g., 0.6) can increase the recall rate at the expense of more false positives. During the deployment (test-time) of an object detection model, using confidence thresholds to determine which bounding-boxes to include is critical but fewer studies were conducted in this aspect [19]. A common approach involves testing and evaluating different thresholds on a validation set, followed by selecting the optimal threshold as the deployment confidence threshold [21]. However, this approach has two notable limitations. First, object detection tasks involve diverse objects with varying categories, sizes, and shapes. Consequently, using a single threshold may not effectively cater to all the objects. Second, estimating a threshold using data inevitably incurs the data shift problem [14]. That is, when the test set exhibits data shift with respect to the training and validation sets, the estimated threshold can be ineffective for test samples.\nPredictions with higher confidence scores are statistically more likely to be correct than those with lower confidence scores. In this paper, we aim to utilize bounding-box predictions with high confidence to rectify the bounding-box predictions with lower confidence. More specifically, we propose a new method called Test-time Self-guided Bounding-box Propagation (TSBP). TSBP propagates information of bounding-boxes with high confidence to influence bounding-boxes with lower confidence, with the goal of adjusting the class labels associated to bounding-boxes with low prediction confidence. Our main contributions can be summarized in the following three aspects.\nWe explore a practical test-time task aimed at improving object detection performance in histology images. We illustrate the efficacy of a test-time optimization procedure in refining predictions by leveraging visual similarities among test samples. Our findings underscore the potential benefits of this approach in enhancing detection accuracy.\nTo tackle this challenge, we introduce a novel and adaptable method termed Test-time Self-guided Bounding-box Propagation (TSBP). TSBP employs an iterative matching and selection process, leveraging high-confidence bounding-boxes to refine low-confidence ones by exploiting their visual similarities. Unlike conventional confidence calibration techniques, TSBP operates without such requirements for label adjustment.\nExperiments, conducted on gland detection and cell detection tasks in histology images, show that our TSBP method can substantially enhance detection outcomes. Compared to known confidence calibration methods, TSBP leads more robust and accurate object detection predictions."}, {"title": "2 Related Work", "content": "Our TSBP method is related to confidence calibration, as TSBP can be viewed as a method for dynamically adjusting (or calibrating) the confidence score for each prediction (bounding-box) of a model. The goal of confidence calibration is to align the predicted confidences of a model with their actual accuracy [7]. Studies have shown that deep neural networks (DNNs) tend to make overconfident predictions [16], leading to inaccurate confidence estimation. Post-processing calibration, which requires parameter estimation on a validation set, is the most widely-used approach for confidence calibration, and such methods include histogram binning [22], Bayesian binning [15], Platt scaling [17], and Beta calibration [10]. In [12], calibration results were improved by considering both confidence scores and bounding-box information of object detection models. In [6], histogram binning calibration was modified under the condition of bounding-box sizes.\nIn traditional classification tasks, the maximum class probability (MCP) is commonly used as the confidence score [9]. This approach assigns the highest softmax output as the confidence score, which means that even incorrect predictions can result in high confidence values. Considering that MCP can lead to the overlap of confidence scores between correct and incorrect predictions, a confidence module called ConfidNet [2] was introduced into the original classification model to output confidence predictions that are closer to the true class probability (TCP). To suppress low-quality prediction boxes, CPSS-FAT [20] multiplies a consistent location quality estimation (CLQE) score by a class score as the confidence score."}, {"title": "3 Methodology", "content": "Fig. 2 provides a high-level overview of the proposed method. We utilize a trained object detection model (e.g., DiffusionDet [1]) on a set of test images, denoted as \\(X = {x_1, x_2,...,x_n}\\). For each image \\(x_i \\in \\mathbb{R}^{3\\times H \\times W}\\), we obtain a collection of bounding-boxes \\(box_{i,k} = {u_{i,k}, v_{i,k}, w_{i,k}, h_{i,k}, c_{i,k}, s_{i,k}}, k = 1,2,..., z_i\\). As the number of generated bounding-boxes may vary for each image during inference, we use \\(z_i\\) to represent the count of bounding-boxes produced for image \\(x_i\\). Here, \\((u_{i,k}, v_{i,k}, w_{i,k}, h_{i,k})\\) indicates the positional attributes of the corresponding bounding-box: \\((u_{i,k}, v_{i,k})\\) denotes the top-left corner coordinates, while \\((w_{i,k}, h_{i,k})\\) represent its width and height, respectively. \\(c_{i,k}\\) denotes the category label of the bounding-box, while \\(s_{i,k}\\) represents its confidence score, ranging from 0 to 1. A high value of \\(s_{i,k}\\) indicates the model's strong confidence in the category label assignment, whereas a low value suggests being uncertain. Below, we describe our proposed method for refining the label assignment of the bounding-boxes, utilizing the higher-confidence bounding-boxes to influence those with lower confidence."}, {"title": "3.1 Initialization", "content": "In the subsequent matching process, we need to compare the feature similarity between bounding-boxes. Therefore, we introduce an additional feature information \\(feat_{i,k}\\) for each bounding-box \\(box_{i,k}\\). \\(feat_{i,k}\\) is obtained by cropping the image patch inside the bounding-box \\(box_{i,k}\\) at the corresponding position on the original image \\(x_i\\), and then applying a feature extractor, e.g., ResNet-50 [8], to the cropped image patch. We denote feature extractor as \\(\\pi\\), and then the feature information \\(feat_{i,k}\\) is obtained by \\(feat_{i,k} = \\pi(x_i[v_{i,k}: (u_{i,k} + h_{i,k}), u_{i,k}: (u_{i,k}+w_{i,k})])\\). TSBP takes all the bounding-boxes as its input. The task of TSBP is to reassign class categories to those bounding-boxes with low confidence scores.\nFor simplicity, suppose there are two class categories, denoted as \\(c_1\\) and \\(c_2\\). We set confidence thresholds, \\(s_{c1}\\) and \\(s_{c2}\\). For bounding-boxes \\(box_{i,k}\\) with \\(c_{i,k} = c_1\\) and confidence scores \\(s_{i,k} > s_{c1}\\), we consider them as high-confident (HF) \\(c_1\\) bounding-boxes. Similarly, for bounding-boxes \\(box_{i,k}\\) with \\(c_{i,k} = c_2\\) and confidence scores \\(s_{i,k} > s_{c2}\\), we consider them as high-confident (HF) \\(c_2\\) bounding-boxes. The found HF \\(c_1\\) and \\(c_2\\) bounding-boxes are set as the initial confirmed \\(c_1\\) and \\(c_2\\) bounding-boxes. We then select a set of representative bounding-boxes from HF \\(c_1\\) and \\(c_2\\) bounding-boxes for the following Multi-Round EMD Matching step. To achieve more efficient and effective matching performance, we use a classic K-means algorithm (the number \\(K\\) of clusters"}, {"title": "3.2 Multi-Round EMD Matching and Bounding-Box Propagation", "content": "The multi-round bounding-box propagation comprises two stages. In the first stage, propagation is carried out with stricter constraints when admitting newly confirmed bounding-boxes (via utilizing the above obtained \\(D_{c1}^{max}\\) and \\(D_{c2}^{max}\\)). This is done to ensure that the bounding-boxes added during this early stage are more likely to have correct label assignments. In the second stage, these constraints are relaxed to allow propagation to occur across a wider range of candidate bounding-boxes.\nIn each round of propagation, suppose there are \\(a\\) candidate bounding-boxes and \\(m\\) confirmed bounding-boxes. Among these confirmed bounding-boxes, \\(t\\) are of class category \\(c_1\\) and the rest, \\(m - t\\), are of class category \\(c_2\\). The input to Earth Mover's Distance (EMD) consists of two signatures: \\(P = {p_1, p_2,..., p_a}\\) and \\(Q = {q_1, q_2,..., q_t, q_{t+1},..., q_m}\\), where \\(P\\) represents the candidate bounding-boxes and \\(Q\\) represents the confirmed bounding-boxes. Specifically, \\(Q\\) comprises \\(t\\) confirmed \\(c_1\\) boxes and \\(m - t\\) confirmed \\(c_2\\) boxes.\nThe distance between \\(p_i\\) and \\(q_j\\) is denoted as \\(D_{i,j}\\), reflecting the cost of matching a candidate bounding-box \\(p_i\\) with a confirmed box \\(q_j\\). \\(D_{i,j}\\) is computed using the Euclidean distance between the features of \\(p_i\\) and \\(q_j\\) (features obtained in Section 3.1). The matching flow between \\(p_i\\) and \\(q_j\\) is denoted by \\(f_{i,j}\\), with a potential value of either 0 or 1. The matching optimization goal is:\n\\[\\min_f \\sum_{1\\leq i \\leq a} \\sum_{1\\leq j \\leq m} f_{i,j} D_{i,j},\\qquad(1)\\]\nsubject to\n\\[\\sum_{1\\leq i \\leq a} f_{i,j} \\leq 1, \\quad 1 \\leq j \\leq m, \\qquad(2)\\]\n\\[\\sum_{1\\leq j \\leq m} f_{i,j} \\leq 1, \\quad 1 \\leq i \\leq a, \\qquad(3)\\]\n\\[\\sum_{1\\leq i \\leq a} \\sum_{1\\leq j \\leq m} f_{i,j} = \\min(a, m), \\qquad(4)\\]\n\\[f_{i,j} \\in \\{0, 1\\}, \\quad 1 \\leq i \\leq a, \\quad 1 \\leq j \\leq m.\\qquad(5)\\]\nEquation (2) indicates that a confirmed bounding-box (\\(c_1\\) or \\(c_2\\)) can be matched with at most one candidate bounding-box. Equation (3) indicates that a candidate bounding-box can be matched with at most one of the confirmed bounding-boxes. When the matching flow \\(f_{i,j}\\) is 1, it means candidate bounding-box \\(p_i\\) has been successfully matched with confirmed bounding-box \\(q_j\\).\nIn the first stage of propagation, for each confirmed \\(c_1\\) bounding-box associated with \\(q_j\\), where \\(1 \\leq j \\leq t\\), we identify \\(p_{i^*}\\) such that \\(f_{i^*,j} = 1\\). If \\(D_{i^*,j}\\) is smaller than the distance constraint \\(D_{c1}^{max}\\) (obtained in Section 3.1), we include the corresponding candidate bounding-box \\(p_{i^*}\\) in the confirmed \\(c_1\\) bounding-box set. The same procedure is followed for \\(c_2\\) bounding-boxes associated with \\(q_j\\), where \\(t < j < m\\). The confirmed box set \\(Q\\) is then updated to a new state with the newly added \\(c_1\\) and \\(c_2\\) bounding-boxes, while the remaining candidate bounding-boxes proceed to the next round of EMD matching (with updated \\(P\\)).\nThe second stage of propagation starts when no new bounding-boxes were added to the confirmed bounding-box sets for both \\(c_1\\) and \\(c_2\\) categories in the last round of propagation. Consequently, the \\(D_{c1}^{max}\\) and \\(D_{c2}^{max}\\) constraints are relaxed to allow more bounding-boxes to be added to the confirmed sets, that is, any matched pairs found in the EMD matching are used for adding the candidate bounding-boxes to the confirmed bounding-box sets. Specifically, for each confirmed \\(c_1\\) bounding-box associated with \\(q_j\\), where \\(1 \\leq j \\leq t\\), we find \\(p_{i^*}\\) such that \\(f_{i^*,j} = 1\\), and then add the corresponding candidate bounding-box \\(p_{i^*}\\) to the confirmed \\(c_1\\) bounding-box set. The same procedure is applied for \\(c_2\\) bounding-boxes associated with \\(q_j\\), where \\(t < j < m\\).\nThe termination condition for multiple rounds of bounding-box propagation occurs when the number of candidate bounding-boxes in \\(P\\) becomes 0. At this point, we report all the bounding boxes in the confirmed bounding-box sets for both \\(c_1\\) and \\(c_2\\) class categories to form the final detection results."}, {"title": "4 Experiments", "content": "To validate the effectiveness of our proposed method on histology images, we conduct experiments on two datasets: GlaS [18] and MoNuSeg [11]. The GlaS dataset consists of 165 images from 16 colon adenocarcinoma tissue slides. Among them, 85 images are used as the training set, 60 images are used as test set A, and 20 images are used as test set B. The MoNuSeg dataset contains different cell nuclei from multiple organs. It includes 30 images (around 22,000 cells) for training and 14 images (around 7000 cells) for testing. The codes for all the experiments will be made publicly available."}, {"title": "4.1 Datasets", "content": "We use the bounding-box predictions from a well-trained DiffusionDet [1] with a confidence threshold set at 0.50 as the baseline. The inputs for the proposed TSBP method are obtained from the same DiffusionDet model with all of its output bounding-boxes (without applying the threshold). We compare TSBP with"}, {"title": "4.2 Main Results", "content": "On Initial Bounding-Box Selection. The parameter \\(s_{c1}\\) and \\(s_{c2}\\) determine the inclusion criteria for bounding-boxes in the initial confirmed bounding-box set. Here, we examine the impact of selecting the initial confidence threshold \\(s_{c1}\\) on the detection performance. As shown in Table 2, TSBP yields better detection results with a lower initial threshold (0.60). When a higher threshold (0.70) is applied, the initial confirmed bounding-boxes may fail to encompass the diversity of object appearances in the test samples, resulting in sub-optimal performance of bounding-box propagation. Notably, compared to other methods across varying confidence thresholds, TSBP consistently achieves better results.\nK in the K-means step of TSBP. In Table 3, we show that different values of \\(K\\) lead to performance fluctuations in a small range on the Glas (testA) and MoNuSeg datasets. Due to the smaller size of the testB in Glas dataset, smaller value of \\(K\\) gives better results.\nError rates in different stages of TSBP. Table 4 demonstrates that the error rate in the first stage is lower than that in the second stage, consistent with the method design, where early propagated samples are more likely to be assigned correct labels."}, {"title": "4.3 Ablation and Additional Studies", "content": "The abundance of visual information in histology images can be leveraged during test time to improve the performance of key object detection. This paper introduced a novel perspective and approach to enhance object detection in histology images in test time. Specifically, we designed a versatile matching-based algorithm (TSBP) that leverages detections with high model confidence to influence detections with low model confidence, aiming to rectify potential errors and"}, {"title": "5 Conclusion", "content": "enhance the overall accuracy of the detection results. Experiments on two object detection tasks in histology images showed the effectiveness of our proposed method. Compared to confidence calibration methods, our method requires no additional labeled data for model training and parameter estimation. Future work will focus on developing a more automatic and robust procedure for forming the initial condition of TSBP. Further studies of utilizing TSBP for test-time model training can be considered an interesting future research target."}]}