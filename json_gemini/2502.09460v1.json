{"title": "Metamorphic Testing for Pose Estimation Systems", "authors": ["Mat\u00edas Duran", "Thomas Laurent", "Ellen Rushe", "Anthony Ventresque"], "abstract": "Pose estimation systems are used in a variety of fields, from sports analytics to livestock care. Given their potential impact, it is paramount to systematically test their behaviour and potential for failure. This is a complex task due to the oracle problem and the high cost of manual labelling necessary to build ground truth keypoints. This problem is exacerbated by the fact that different applications require systems to focus on different subjects (e.g., human versus animal) or landmarks (e.g., only extremities versus whole body and face), which makes labelled test data rarely reusable. To combat these problems we propose MET-POSE, a metamorphic testing framework for pose estimation systems that bypasses the need for manual annotation while assessing the performance of these systems under different circumstances. MET-POSE thus allows users of pose estimation systems to assess the systems in conditions that more closely relate to their application without having to label an ad-hoc test dataset or rely only on available datasets, which may not be adapted to their application domain. While we define MET-POSE in general terms, we also present a non-exhaustive list of metamorphic rules that represent common challenges in computer vision applications, as well as a specific way to evaluate these rules. We then experimentally show the effectiveness of MET-POSE by applying it to Mediapipe Holistic, a state of the art human pose estimation system, with the FLIC and PHOENIX datasets. With these experiments, we outline numerous ways in which the outputs of MET-POSE can uncover faults in pose estimation systems at a similar or higher rate than classic testing using hand labelled data, and show that users can tailor the rule set they use to the faults and level of accuracy relevant to their application.", "sections": [{"title": "I. INTRODUCTION", "content": "Pose Estimation Systems has applications in medicine [1], sign language recognition [2] and high stakes sports events [3], requiring them to be well-tested in order to provide a sub- stantiated assessment of the correct behaviour when applied to sensitive domains. Such systems need to perform correctly and as expected under a variety of conditions. This work aims to provide practitioners with a means of assessing this.\nIn this work we propose MET-POSE, a metamorphic testing framework to test pose estimation systems without the signif- icant cost of manual data labelling. Additionally, we propose a non exhaustive set of metamorphic rules for MET-POSE, including flexible metrics to assess violations. These rules allow practitioners to apply various commonly encountered"}, {"title": "II. BACKGROUND", "content": "This section provides an overview and definition of the con- cepts used in this work. First, Section II-A defines human pose estimation systems, which the proposed framework tests, then Section II-B defines challenges specific to testing Machine Learning (ML) systems, and Section II-C explains the idea of metamorphic testing, the basis of the proposed framework."}, {"title": "A. Pose Estimation", "content": "Pose estimation is the task of estimating the locations of different landmarks on a subject from images or video frames, with the overall aim of providing an overview of their pose. This task is important to a wide variety of fields including human activity recognition [5], sign language recognition [2], and sports analytics [3]. It is typically solved using DL- based regression algorithms which estimate the coordinates of each body part. One of the most common open-source"}, {"title": "B. Challenges in Testing ML-based Systems", "content": "Deep Learning (DL) research has gained enormous mo- mentum over the last decade, with a majority of the devel- opment in this area being centred around computer vision. However, despite their success, these deep architectures have also demonstrated harmful decision-making [7]\u2013[9], bias [10] and a lack of \u201cunderstanding\u201d of common-sense concepts such as basic spatial relations [11], [12]. These issues are made all the more challenging to identify given that DL methods lack interpretability, with the steps that lead to a particular decision often being unclear. This lack of transparency means that it is crucial that these systems are systematically tested and their results compared to their expected behaviour in order to understand their sensitivities, along with the conditions under which they can be expected to behave correctly.\nAnother aspect that complicates the testing of complex systems is that they often present what is known as the Oracle Problem [13], which describes a scenario where the correct output of the system under test is not known. Sometimes there are no automated ways to compute this oracle, or the act of querying this oracle can be prohibitively expensive. In the case of pose estimation, labelling keypoints in videos is extremely time consuming, making it expensive to collect this form of ground truth data for many applications. This complicates the testing of these systems and requires techniques that can assess the correct functioning of the system without needing an oracle for the correctness of a single execution of the system.\nThough testing techniques for computer vision-based clas- sification systems have been extensively explored [14]\u2013[16], less attention has been given to more complex computer vision tasks such as pose estimation. For example, while MediaPipe does evaluate its pose estimation framework for bias related to the demographics of individuals an admirable activity this analysis is expensive as it requires ground truth information. Additionally, though their evaluation states that degradation can be expected as video quality and lighting gets worse, a comprehensive testing procedure is not outlined. For many applications, it is crucial that we understand the specific parameters within which a system can be expected to operate accurately, especially where mistakes are costly. There has been some work in this area [17]"}, {"title": "C. Metamorphic testing", "content": "Metamorphic Testing (MT) has been used to address the oracle problem for both classical programs [18] and ML applications [15] and has demonstrated promising results at a relatively low cost. MT relies on metamorphic rules relations between certain changes to the input of the system (e.g., doubling an integer input) and their effect on its output (e.g., the output should be doubled too) to circumvent the oracle problem. If one of these relations is violated for a given input, then the system is not behaving correctly. Note that the violation of the metamorphic rule can be verified without knowing what the correct output for either of the inputs is, i.e., without an oracle for the correctness of each output.\nThis method is well suited for testing pose estimation systems as it does not require ground truth labels, which come from expensive manual annotation of data. Additionally, since the inputs can be modified in numerous ways, it can help understand the boundaries of the input space under which the system performs as expected."}, {"title": "III. METAMORPHIC TESTING FOR POSE ESTIMATION (MET-POSE)", "content": "This section first formally defines the problem of testing pose estimation systems (III-A) and then introduces MET- POSE (III-B)."}, {"title": "A. Problem definition", "content": "MET-POSE aims to test pose estimation systems at large. Given an input image img, a pose estimation system returns an output O which is a list of sets of keypoints: $O = [KP_0, KP_1, ..., KP_n]$ with $n \\in \\mathbb{N}$ or $O = []$. Each list of keypoints $KP_i$ corresponds to the keypoints of a subject detected in the image by the system, i.e., $\\forall i \\in \\{0..n\\}, KP_i = \\{kp_0, ..., kp_p\\}$, with each keypoint $kp_j$, identifying a landmark of subject i and its coordinates.\nTesting these systems is an inherently complex task, as they often lack exact requirements. For example, the list of landmarks that should be found on a person in the task of human pose estimation is not defined in a consistent manner with each system defining its own. Similarly, the way to account for occlusion in an image or to process images containing no or multiple subjects is often not defined. This lack of standard requirements contributes to the oracle problem and to the cost of testing pose estimation systems, as each system requires its own hand labelled data for evaluation.\nAdditionally, current systems that rely on pose estimation are mostly built using deep neural networks-based pose esti- mation system. These models are typically trained on large, diverse datasets to facilitate generalisation. Given the \u201cgener- alised\" nature of these models and high cost of labelling pose data, these models are typically used \u201cout-of-the-box\", without fine-tuning them for the particular application of the system they are used in, and even sometimes without domain-specific testing. Additionally, different use cases and environmental factors can challenge a pose estimation system in different ways, for example: low lighting, different camera angles, or"}, {"title": "B. Approach overview", "content": "We aim for MET-POSE to be a general framework so we present it here in broad terms. A specific example of how the framework can be applied is detailed in Section IV. MET- POSE is a metamorphic testing framework for pose estimation systems. It thus relies on metamorphic rules based on images and keypoints. Each rule M is defined by two elements:\n\u2022 A transformation M.trans, that defines a modification to apply to an image, e.g., making the image greyscale. Given an original test image imgorig, M.trans produces a modified test image imgmod = M.trans(imgorig).\n\u2022 A relation M.rel, that defines a property between the System Under Test (SUT)'s output keypoints for imgorig and its output keypoints for imgmod that should appear if the system functions correctly. The simplest relation is the identity relation, i.e., the system should output the same keypoints for imgorig and imgmod. If this relation is not followed (i.e., the property does not appear), then the rule is said to be violated.\nA violation of a metamorphic rule on an image indicates that the pose estimation system is providing incorrect output on imgorig, on imgmod, or on both. The severity of the system's error can vary, i.e., the output can be more incorrect in some cases than others. This is something that MET-POSE takes into account by returning the severity of a violation, which can then be considered by, for example, using different error thresholds to decide if a violation constitutes a test failure.\nMET-POSE takes as input the SUT, a set of metamorphic rules, and a set IMGorig of test images. MET-POSE applies the transformation of each rule to each test image in IMGorig, and for each pair of original and modified images it checks whether the rule is violated, and to what degree. For each input image imgorig\u2208 IMGorig, and each metamorphic rule M in the input set, the output of MET-POSE is: a modified image M.trans(imgorig), whether the pair of images violates M.rel, how severely the pair violates M.rel if it does. Users are then free to analyse this output based on the quality constraints of their application. Some use cases, for example, might not require that small violations be considered failures if high precision is not required.\nMET-POSE is agnostic to the way rules are defined and how the relations are assessed. The next section details examples of rules and a possible error metric-based technique to assess their relations."}, {"title": "IV. PROPOSED METAMORPHIC RULES", "content": "MET-POSE can be used with any metamorphic rule that defines a transformation trans of an input image img and a relation rel between the keypoints of img and trans(img). This section describes a non-exhaustive set of rules that we propose to evaluate MET-POSE with. Section IV-A describes the transformations and relations of these rules and Sec- tion IV-B defines a possible error-metric based mechanism to assess violations of the rules. Section V-D defines the exact metric used in this work."}, {"title": "A. Transformations and Relations", "content": "This section describes a varied set of rules for MET- POSE that cover a range of transformations that are often encountered in the applications of pose estimation systems. In each different application of pose estimation, it can be useful to compare the effect of various modifications to the input images to infer which specific modifications lead to higher output inaccuracies. This is particularly important when there is a possibility of collecting new data for a given task, as these data quality issues can be potentially mitigated or minimised.\nThe relation for these rules is that the keypoints should be unchanged after the transformation. All colour trans- formations test the SUT's over-reliance on colour, which can affect performance when the system is used in a new context [23].\nGreyscale (Grey): turns the image into a greyscale (only shades of grey) image.\nColour wheel (CWheelo): changes colours in the im- age by applying a rotation @ on the hue colour wheel value of a HSV [24] encoding of the input image.\nColour channels (Cchans$_{\\text{factor1, factor2, factor3}}$): multiplies each of the 3 colour channels in the encoding (RGB, BGR or XYZ) of the image by a"}, {"title": "B. Error Metric-based Relation Assessment", "content": "This section introduces an error metric-based technique to assess violations of rules used in MET-POSE. All the rules proposed in this work either expect no change in keypoints or modify the position of the expected output keypoints between the original and modified. However, different rules, e.g., those involving removing or adding landmarks to the image, could"}, {"title": "V. EXPERIMENTS", "content": "This section details the experiments conducted to illustrate how MET-POSE can be used and evaluate how well it can find faults in a pose estimation system without using ground truth keypoints. Section V-A details the research questions we explore with these experiments. Sections V-B and V-C detail the pose estimation system under test and datasets used in the experiments, and Section V-D defines the error metric used to evaluate rule violations."}, {"title": "A. Research questions", "content": "The experiments in this work aim to answer the following research questions (RQs):\n\u2022 RQ1: Does MET-POSE find faults?\nThis RQ considers whether MET-POSE can find faults in pose estimation systems. In order to explore this question we consider the number of rule violations found by MET- POSE using different subsets of the rules described in Section IV-A and different error thresholds.\n\u2022 RQ2: How different are the results of MET-POSE and classic, ground truth-based testing?\nThis RQ focuses on whether the faults found by MET- POSE correspond to those found using classic, ground truth-based testing using the same error metric and error threshold as MET-POSE. This research question considers the same rule sets and error thresholds as RQ1 and is composed of three sub-RQs:\nRQ2.1: Do both testing methods lead to a similar number of failures?\nThis RQ first assesses whether both testing methods uncover the same number of failing test cases, a test case being considered as an input image for both methods.\nRQ2.2: Do the same test images make the system fail with both methods?\nThis RQ explores whether the particular images that lead to a failure are the same for both methods, i.e., if they expose the same system failures.\nRQ2.3: How large are the errors found by both meth- ods?\nFinding larger (w.r.t. the chosen error metric) errors in addition to small errors would show that a testing method finds faults in the SUT with a stronger effect on the output.\n\u2022 RQ3: What do the different proposed metamorphic rules bring to the method?\nThis RQ explores the contribution of the different rules proposed in Section IV-A to MET-POSE. It is composed of two sub-RQs:\nRQ3.1 Are there subsumption relationships amongst the proposed rules?\nThis RQ explores possible subsumption relations be- tween the different proposed rules. A rule subsumes another rule if it finds the failure-inducing images another rule does, making the second rule redundant.\nRQ3.2 Do the different metamorphic relations reveal the same types of faults?\nThis RQ assesses whether the different metamorphic rules find the same failure-inducing images, which would indicate the violations of these rules could have their roots in the same fault in the system."}, {"title": "B. System Under Test", "content": "In order to explore the three RQs defined in Section V-A, we applied MET-POSE to Mediapipe Holistic [4], a state of the art human pose estimation system. Its underlying DL model is BlazePose GHUM 3D [25]. The BlazePose [26] model is a lightweight convolutional neural network that predicts the co-ordinates of body parts.\nHolistic is composed of three sub-models, each one respon- sible for the keypoints of the: face (468 landmarks), hands (21 landmarks each), and overall body pose (33 landmarks).\nWe used Holistic in static image mode. Using the system in this mode provides a deterministic output, as verified by the use of the Id rule (i.e. there is no difference between two different generations without a transform). This ensures that no noise from non-determinism is integrated into the error metric."}, {"title": "C. Datasets", "content": "We tested the SUT with MET-POSE with two datasets:\n\u2022 PHOENIX [27] is a dataset created for sign language recognition. It contains 947,756 video frames from a signed German weather forecast. Given that this dataset is used in the field of sign-language recognition and transla- tion, the dataset contains manually labelled annotations in"}, {"title": "D. Metamorphic Rules and Error Metrics", "content": "In order to explore the research questions that Section V-A details, we applied MET-POSE using a set of the rules that Section IV-A describes using a range of configurations of these relations.\nTo assess violations of all rules used in the experiments we use the same error metric $Err_{lmks}$ defined as:\n$Err_{lmks} (O_{expct}, O_{trans}) = \\begin{cases} inf & \\text{if } O_{expct} = O_{trans} = \\emptyset, \\\\ 0 & \\text{elif } O_{expct} = \\emptyset \\\\ Med \\frac{L2MP(kp_{expct}, kp_{trans})}{\\text{max}(1, \\text{#keypoints})} & \\text{else.} \\end{cases}$\nIf the pose estimation system only returns keypoints on the original image or the modified image, $Err_{lmks}$ returns an infinite value. Indeed, the transformations used in these experiments do not modify which landmarks the system should detect on the image, at most they change the expected position of the returned keypoints. Failing to detect any landmarks on just one of the pair of images is thus the worst violation of a rule possible.\nIf the pose estimation system returned keypoints for both images then $Err_{lmks}$ returns the median of the distance between the expected keypoint (following the metamorphic rule's relation and the keypoints returned by the system on the original image) and the keypoint returned by the system on the modified image for each landmark lmk. Using the median as a measure of the overall error of the system on an image attenuates the effect of outliers on the error value."}, {"title": "VI. RESULTS", "content": "This section analyses and discusses some of the results from our experiments following the research questions defined in Section V-A."}, {"title": "A. RQ1", "content": "Figure 4 shows the proportion of images in each dataset leading to a rule violation when testing Holistic with MET- POSE for different sets of rules and different error threshold"}, {"title": "B. RQ2", "content": "This RQ focuses on the difference between classic, ground truth based testing and MET-POSE."}, {"title": "C. RQ3", "content": "To analyse the contribution of different metamorphic rela- tions when using MET-POSE we can look at their subsumption rates. A rule $M_1$ subsumes a rule $M_2$ if, when $M_2$ detects a failure for an image then $M_1$ also detected that failure."}, {"title": "VII. RELATED WORK", "content": "The use of machine learning systems is becoming increas- ingly common in many diverse fields. Testing strategies for these systems are therefore being more widely recognised as a necessity, especially in safety critical systems [34]. In particular, these systems are tested with different focuses in mind such as: robustness to degradations [17] [35] [36] [37], testing for faults when using ML frameworks [38], testing the adequacy of the datasets used to train and test these systems [39] and testing the biases embedded in these systems [8], [40].\nIn particular, metamorphic testing is a convenient method to circumvent the oracle problem found when attempting to test many of these systems. This method has been used to test a wide range of ML systems, including: autonomous delivery robots [41], image classification systems [42], recommender systems [43], search engines [44] and chat bots [45].\nMore particularly, when looking at pose estimation systems, we can find previous work focused on the pose estimation of hands [17], and on predicting the trajectory of humans, done by autonomous systems [46].\nWhen looking at the particular model tested in this work, it has previously been explicitly evaluated on individuals from different regions of the world which has been reported in the model's corresponding Model Card [30], [47].\nOne of the main differences between the related work and the framework presented here is that we avoid the need for ground truth labelled data, meaning that MET-POSE can work with datasets without ground truth, which has not been done in previous metamorphic testing applied to pose estimation. We also do not focus only on robustness to degradations. We present a framework that can be used for various specific interests of the applications, which can be image degradation, but can encompass a wide range of potential concerns from fairness issues to sensitivity to image quality. Even if we do not focus on suggesting novel metamorphic rules, when novel metamorphic rules are needed for a specific application, MET- POSE can be applied to new datasets without the expense of labelling ground truth keypoints."}, {"title": "VIII. THREATS TO VALIDITY", "content": "We list (and classify following [48]) threats to the validity of our work here:\n\u2022 Construct Validity: A possible threat is the validity of the metrics used to reach our conclusions. The results would be different if instead of counting the number of inputs that fail with at least one metamorphic rule, we required multiple failures for each input to be counted. They would also look different depending on the metamorphic relations we take into account, or if the modified images are out of scope of the system under test. The image aggregation metric can also change the results depending on whether we measure the mean, median, minimum or maximum error of all keypoints in an output.\nTo mitigate this, we consider the median error as an image aggregation metric, which is less sensitive to outliers compared to the mean or the maximum. We also show the number of failed inputs for different selections of metamorphic relations. We choose to count the inputs when they fail for only one metamorphic relation in- stead of many because this is enough to show that the framework found a problem that would be relevant to the application engineers. Finally, we show how a wide and varied selection of different metamorphic relations do not completely subsume each other, so the errors found come from the test with various different rules, and not only one rule finding all the problems.\nWe also note that in this work we are not trying to find specific problems in the SUT, and so the influence of the metrics discussed here is reduced. They show that MET- POSE can be used to find problems in such systems, but the focus is not on which specific problems we found.\n\u2022 Internal Validity: Another threat is that the results shown were found by chance or due to mistakes in our imple- mentation, and not because of the causes that we expect. To mitigate this, we have carefully inspected our imple- mentation, and manually confirmed each step done until the results aggregation. We have also added an identity metamorphic relation as a sanity check to ensure that the system results do not change when we run the system with the same input twice, in which case we would need to run our experiments a number of times to reach a statistically significant conclusion.\n\u2022 External Validity: The current work may not generalise to other datasets or systems beyond the ones in this work. It is also not explored how effective it would be when used in a real application setting with a specific set of relevant input features and output requirements. In general, DL models are evolving rapidly and so it is common that many methods are rendered obsolete quickly.\nTo mitigate these, we have designed this framework in a way that it is highly dataset and system agnostic: any image is processed equally, not depending on its colour, number or type of subjects, etc.; and MET-POSE tests the SUT as a black-box. The only change required to use different ground truth annotations, or different systems, is due to the non-standardised pose estimation outputs and annotations, which is unavoidable. We have also left not only the specific metamorphic relations but also the error metric open to modification for different applications, facilitating adaptability to different contexts."}, {"title": "IX. CONCLUSIONS AND FUTURE WORK", "content": "In this work we propose MET-POSE, a metamorphic testing- based framework for pose estimation systems. We have fo- cused on making this framework both system- and dataset- agnostic, due to the rapid developments of the area of pose estimation systems. This should help the approach remain relevant even if architectures or methodological changes occur in the area.\nWe applied MET-POSE to Mediapipe Holistic using two datasets from different application domains. Results show that MET-POSE can detect failures of the system without ground truth data, i.e., without human annotations. They also show that, by leaving the definition of the metamorphic rules and the metrics used to assess violation of these rules open to the user, MET-POSE is adaptable and can test pose estimation systems for different use cases.\nAs future work, we plan to apply MET-POSE to different systems and use cases. This will first confirm the framework's adaptability. We also plan to show that, by using application- specific rules, practitioners who build these pose estimation systems can gain a better understanding of how they operate and even use this information towards repairing their systems."}]}