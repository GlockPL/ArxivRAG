{"title": "Invariant Correlation of Representation with Label", "authors": ["Gaojie Jin", "Ronghui Mu", "Xinping Yi", "Xiaowei Huang", "Lijun Zhang"], "abstract": "The Invariant Risk Minimization (IRM) approach aims to address the challenge\nof domain generalization by training a feature representation that remains invari-\nant across multiple environments. However, in noisy environments, IRM-related\ntechniques such as IRMv1 and VREx may be unable to achieve the optimal\nIRM solution, primarily due to erroneous optimization directions. To address this\nissue, we introduce ICorr (an abbreviation for Invariant Correlation), a novel\napproach designed to surmount the above challenge in noisy settings. Addition-\nally, we dig into a case study to analyze why previous methods may lose ground\nwhile ICorr can succeed. Through a theoretical lens, particularly from a causal-\nity perspective, we illustrate that the invariant correlation of representation with\nlabel is a necessary condition for the optimal invariant predictor in noisy envi-\nronments, whereas the optimization motivations for other methods may not be.\nFurthermore, we empirically demonstrate the effectiveness of ICorr by comparing\nit with other domain generalization methods on various noisy datasets.", "sections": [{"title": "1 Introduction", "content": "Over the past decade, deep neural networks (DNNs) have made remarkable progress\nin a wide range of applications, such as computer vision [1-3] and natural language\nprocessing [4, 5]. Typically, most deep learning models are trained using the Empiri-\ncal Risk Minimization (ERM) [6] approach, which assumes that training and testing\nsamples are independently drawn from an identical distribution (I.I.D. assumption).\nNevertheless, recent studies have reported increasing instances of DNN failures [7-9]\nwhen this I.I.D. assumption is violated due to distributional shifts in practice.\nInvariant Risk Minimization [10] is a novel learning approach that addresses the\nchallenge of domain generalization (also known as out of distribution problem) in\nthe face of distributional shifts. The fundamental concept behind IRM is to train a\nfeature representation that remains invariant across multiple environments [11], such\nthat a single classifier can perform well in all of them. Although obtaining the opti-\nmal invariant feature representation is challenging, previous works employ alternative\nmethods [12-14] to approximate it. The success of IRM approach in existing train-\ning environments can ensure its ability to generalize well in new environments with\nunseen distributional shifts, which is evidenced by positive empirical results [15, 16].\nHowever, in the real world, different environments (or domains) may exhibit vary-\ning levels of inherent (independent) noises, leading to various inherent losses. Even an\noptimal IRM model cannot mitigate these inherent losses, resulting in varying opti-\nmal losses across different environments. As shown in Figure 1, inherent noise (such\nas snow or water) can impact the invariant feature (dog), such as covering the face or\nblurring the body, resulting in different inherent losses. Existing IRM-related meth-\nods, such as IRMv1, VREx [17] and Rame et al. [15], focus on optimizing the model\nin different clean environments but may fail in these noisy situations.\nWe conduct an analysis in this study to identify the reasons why existing IRM-\nrelated methods may be ineffective in noisy environments. Upon examining the case\nstudy presented in Section 2.3, it has come to our attention that the optimization"}, {"title": "2 Study IRM in noisy environments", "content": ""}, {"title": "2.1 Preliminaries", "content": "Given that X and Y are the input and output spaces respectively, let $\\mathcal{E}:=\\{e_1,e_2, ..., e_m\\}$ be a collection of $m$ environments in the sample space $\\mathcal{X} \\times \\mathcal{Y}$ with dif-\nferent joint distributions $P_e(x, y)$, where $e \\in \\mathcal{E}$. Consider $\\mathcal{E}_{tr} \\subseteq \\mathcal{E}$ to be the training\nenvironments and $\\mathcal{S}_e:=\\{(x_e, y)\\}_{i=1}^{n_e}$ to be the training dataset drawn from distribu-\ntion $P_e(x, y) (e \\in \\mathcal{E}_{tr})$ with $n_e$ being dataset size. Given the above training datasets\n$\\mathcal{S}_e (e \\in \\mathcal{E}_{tr})$, the task is to learn an optimal model $f(\\cdot; w): \\mathcal{X} \\rightarrow \\mathcal{Y}$, such that $f(x_e; w)$\nperforms well in predicting $y$ when given $x_e$ not only for $e \\in \\mathcal{E}_{tr}$ but also for $e \\in \\mathcal{E}\\backslash\\mathcal{E}_{tr}$,\nwhere $w$ is the parameters of $f$.\nThe ERM algorithm [6] tries to solve the above problem via directly minimizing\nthe loss throughout training environments:\n$\\begin{equation}\n    \\min_{w: x \\rightarrow y} \\sum_{e \\in \\mathcal{E}_{tr}} \\mathbb{R}_e(w),\n    \\tag{ERM}\n\\end{equation}\nwhere $\\mathbb{R}_e(w), \\mathbb{R}(x_e, w)$ are the expected loss of $f(\\cdot; w)$ in the environment $e$, the loss\nof $f(x_e; w)$ for the data $x_e$, respectively.\nIRM [10] firstly supposes that the predictor $f(\\cdot; w)$ can be made up of $g(\\cdot; \\Phi)$ and\n$h(\\cdot; v)$, i.e., $f (\\cdot; w) = h(g(\\cdot; \\Phi); v)$, where $w = \\{v, \\Phi\\}$ are the model parameters. Here,"}, {"title": "2.2 Invariant correlation of representation with label", "content": "We now formally describe our method (ICorr) to extract invariant features in noisy\nenvironments. ICorr performs robust learning via stabilizing the correlation between\nrepresentation and true label across environments:\n$\\begin{equation}\n    \\min_{w: \\mathcal{X} \\rightarrow \\mathcal{H}} \\lambda \\text{Var}(\\rho_{f, y}(w)) + \\sum_{e \\in \\mathcal{E}_{tr}} \\mathbb{R}_e(w),\n    \\tag{ICorr}\n\\end{equation}\nwhere $\\rho_{f,y}(w) = E_{x_e, y}(f(x_e; w)y)$ is the correlation between $f(x_e; w)$ and $y$ in the\nenvironment $e$, $f(x_e; w) = f(x_e; w) - E_{x_e} (f(x_e; w))$, and $\\text{Var}(\\rho_{f,y}(w))$ represents\nthe variance of the correlation in $\\mathcal{E}_{tr}$. Here $\\lambda \\in [0, +\\infty)$ controls the balance between\nreducing average loss and enhancing stability of correlation, with $\\lambda = 0$ recovering\nERM, and $\\lambda \\rightarrow +\\infty$ leading ICorr to focus entirely on making the correlation equal.\nIn the following, we demonstrate the power of ICorr in noisy environments through\nthe case study (Section 2.3) and the theoretical analysis of causality (Section 3),\nrespectively."}, {"title": "2.3 Why is ICorr necessary (a case study in two-bit environments)", "content": "Arjovsky et al. [10] present the Colored-MNIST task, a synthetic challenge derived\nfrom MNIST, to demonstrate the efficacy of the IRM technique and IRMv1 in partic-\nular. Although MNIST pictures are grayscale, Colored-MNIST images are colored red\nor green in a manner that strongly (but spuriously) correlates with the class label. In\nthis case, ERM successfully learns to exploit the color during training, but it fails at\ntest time when the correlation with the color is inverted.\nKamath et al. [18] study an abstract version of Colored-MNIST based on two bits\nof input, where $y$ is the label to be predicted, $x_1$ is correlated with the label of the\nhand-written digit (0 \u2013 4 or 5 \u2013 9), and $x_2$ corresponds to the color (red or green)."}, {"title": "3 Theoretical analysis from causal perspective", "content": "In this section, we present our theoretical understanding of ICorr from the perspective\nof causality. Following the theoretical setting from Arjovsky et al. [10] and Peters\net al. [11], we formally prove that (1) $\\text{Var}(\\rho_{f,y}(w)) = 0$ is a necessary condition\nfor the optimal invariant predictor in noisy environments; (2) $||\\nabla_{v|_{v=1}}\\mathbb{R}_e(w)|| = 0$,\n$\\text{Var}(\\mathbb{R}_e(w)) = 0$ and some other minimal penalty terms may not be necessary for the\noptimal invariant predictor in noisy environments.\nSetting: Consider several training environments $\\mathcal{E}_{tr} = \\{e_1, e_2, ...\\}$ and $x_e$ to be the\nobserved input of $e \\in \\mathcal{E}_{tr}$. We adopt an anti-causal framework [10] with data generation\nprocess as follows:\n$\\begin{aligned}\ny &= \\gamma \\hat{x}_{inv} + \\eta_y,\n\\\\hat{x}_{inv} &= x_{inv} + \\eta_{inv}, x_s = x_s + \\eta_s,\n\\\\mathcal{x}_e &= \\mathcal{S}\\left(\\begin{array}{l}\n\\hat{x}_{inv} \\\\x_s\n\\end{array}\\right),\n\\end{aligned}$\nwhere $y \\in \\mathbb{R}^{d_{inv}}$ and $y \\neq 0$, the hidden invariant feature $\\hat{x}_{inv}$ and the observed\ninvariant feature $x_{inv}$ take values in $\\mathbb{R}^{d_{inv}}$, the hidden spurious feature $x_s$ and the\nobserved spurious feature $x_s$ take values in $\\mathbb{R}^{d_s}$, and $\\mathcal{S}: \\mathbb{R}^{(d_{inv}+d_s)} \\rightarrow \\mathbb{R}^{d}$ is an inherent\nmapping to mix features. The hidden spurious feature $x_s$ is generated by $y$ with any\nnon-invariant relationship, $\\eta_{inv}$ and $\\eta_{s}$ are independent Gaussian with bounded mean\nand variance changed by environments, $\\eta_y$ is an independent and invariant zero-mean\nGaussian with bounded variance. As the directed acyclic graph (DAG) in Figure 4(b)\nshows, the hidden invariant feature $\\hat{x}_{inv}$ generates the true label $y$ and $y$ generates\nthe hidden spurious feature $x_s$. In consideration of environmental noise, we can only\nobserve the input $\\mathcal{x}_e$ which is a mixture of $\\hat{x}_{inv}$ and $x_s$ after mapping. (Note that the\nobserved feature is generated by applying environmental noise to the hidden feature.)\nWe aim to learn a classifier to predict $y$ based on $\\mathcal{x}_e$, i.e., $f(\\mathcal{x}_e; w) = h(g(\\mathcal{x}_e; \\Phi); v)$.\nDrawing upon the foundational assumption from IRM [10], i.e., assume that there\nexists a mapping $\\mathcal{\\check{S}} : \\mathbb{R}^{d} \\rightarrow \\mathbb{R}^{d_{inv}}$ such that $\\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x})) = x_1$ for all $x_1 \\in \\mathbb{R}^{d_{inv}}$, $x_2 \\in \\mathbb{R}^{d_s}$, the following theorem mainly states that, in noisy environments, if there exists a\nrepresentation that elicits the optimal invariant predictor $f(\\cdot; w)$ across all possible\nenvironments $\\mathcal{E}$, then the correlation between $f(\\mathcal{x}_e; w)$ and $y$ remains invariant for all\n$e \\in \\mathcal{E}$.\nTheorem 3.1. Assume that there exists a mapping $\\mathcal{\\check{S}} : \\mathbb{R}^{d} \\rightarrow \\mathbb{R}^{d_{inv}}$ such that\n$\\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x})) = x_1$ for all $x_1 \\in \\mathbb{R}^{d_{inv}}, x_2 \\in \\mathbb{R}^{d_s}$. Then, if $\\Phi$ elicits the desired (optimal)\ninvariant predictor $f(\\cdot; w) = y^\\top \\mathcal{\\check{S}}(\\cdot)$, we have\n$\\begin{aligned}\n\\rho_{f,y}(w) &= E_{\\mathcal{x}_e,y} [y^\\top \\Phi \\mathcal{x}_e y] - E[y^\\top \\Phi \\mathcal{x}_e]E[y]\n\\\\&= E_{\\mathcal{x}_e,y} [y^\\top \\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x}))y] - E[y^\\top \\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x}))]E[y]\n\\\\&= E_{\\mathcal{x}_e,y} [y^\\top x_{inv} y] - E[y^\\top x_{inv}]E[y]\n\\\\&= E[(y^\\top x_{inv})^2] - [E(\\gamma^\\top x_{inv})]^2\n\\\\&= \\text{Var}(y^\\top x_{inv}),\n\\end{aligned}$\nholds for all $e \\in \\mathcal{E}$. Thus we get $\\text{Var}(\\rho_{f,y}(w)) = 0$.\nProof. See Appendix D.\nTheorem 3.1 indicates that in noisy environments, minimizing the regularization\nterm of ICorr, i.e., $\\text{Var}(\\rho_{f,y}(w))$, is a necessary condition to find the invariant features.\nThe intuition behind Theorem 3.1 is that, the correlation between the representation\nand the true label can effectively prevent interference in noisy environments, whereas\nIRMv1 and VREx may get stuck. In the following, we would like to point out that the"}, {"title": "4 Experiments", "content": "In this section, we implement extensive experiments with ColoredMNIST [10], Cir-\ncle dataset [24], noisy DomainBed [25] framework, noisy Waterbirds [26-28] and\nCelebA [29] datasets. The first part includes comprehensive experiments on ColoredM-\nNIST using multi-layer-perceptrons (MLP) with varying environmental noises. In the\nsecond part, we conduct further experiments to verify the effectiveness of ICorr in\nmore noisy environments with more architectures."}, {"title": "4.1 MLP with ColoredMNIST", "content": "Training setting: This proof-of-concept experiment of ColoredMNIST follows the\nsettings from Arjovsky et al. [10], Krueger et al. [17]. The MLP consists of two hidden\nlayers with 256 and 256 units respectively. Each of these hidden layers is followed by a"}, {"title": "6 Limitation", "content": "Our theoretical results are based on the assumption that there exists $\\mathcal{\\check{S}} \\in \\mathbb{R}^{d_{inv} \\times d}$\nsuch that $\\mathcal{\\check{S}}\\mathcal{S}(\\mathcal{x}) = x_1$, for all $x_1 \\in \\mathbb{R}^{d_{inv}}, \\mathcal{x}_2 \\in \\mathbb{R}^{d_s}$, which has also been utilized in\nthe pioneering work of IRM by Arjovsky et al. [10]. Nonetheless, this $\\mathcal{\\check{S}}$ may not exist\nin DNNs when facing complicated $\\mathcal{S}$. Although this may pose new challenges, we aim\nto advance our research by studying more possible cases of $\\mathcal{S}$ and $\\mathcal{\\check{S}}$ in the future."}, {"title": "7 Conclusion", "content": "In this work, we introduce an IRM-related method named ICorr, which leverages the\ncorrelation between representation and label to overcome the challenge of training\nan invariant predictor in noisy environments. A detailed case study involving two-\nbit environments is conducted to elucidate why conventional methods might falter,\nwhereas ICorr maintains its efficacy in such noisy settings. Through rigorous theo-\nretical analyses of causality, we demonstrate the critical importance of maintaining\ninvariant correlation across noisy environments to achieve the optimal IRM solution.\nIn addition to our theoretical insights, we conduct extensive experiments which show\nthe superior performance of ICorr compared to other methods in such noisy cases.\nData availability statement: The research conducted in this work solely utilizes\npublicly available datasets, the code is available in the uploaded file."}, {"title": "Appendix B Calculation details", "content": ""}, {"title": "B.1 Calculation for IRMv1, VREx and ICorr", "content": "Following Kamath et al. [18] and L\u00e9on Bottou, we provide the calculation details of\nIRMv1, VREx and ICorr solutions as follows.\nSuppose $\\mathcal{E}_{tr}$ consists of two environments $e_1 = (\\alpha, \\beta_{e_1}, \\eta_{e_1})$ and $e_2 = (\\alpha, \\beta_{e_2}, \\eta_{e_2})$.\nFrom the definition of IRMv1, VREx, ICorr, for any $f(x) = \\frac{1}{v} \\cdot g(x_e; \\Phi) = w_1x_1 + w_2x_2\nwith square loss, we have that:\nwhen optimizing IRMv1 till $\\nabla_{v|_{v=1}}\\mathbb{R}_e(w) = 0$, we get\n$\\begin{aligned}\nE_{x_{e_1},y} (w_1x_1^1 + w_2x_2^1 - y) (w_1x_1^1 + w_2x_2^1) &= 0, \\\\\nE_{x_{e_2},y} (w_1x_1^2 + w_2x_2^2 - y) (w_1x_1^2 + w_2x_2^2) &= 0;\n\\end{aligned} \\tag{B1}\nwhen optimizing VREx till $\\text{Var}(\\mathbb{R}_e(w)) = 0$, we get\n$E_{x_{e_1},y} (w_1x_1^1 + w_2x_2^1 \u2013 y)^2 = E_{x_{e_2},y} (w_1x_1^2 + w_2x_2^2 - y)^2; \\tag{B2}$\nwhen optimizing ICorr with $\\text{Var}[\\rho_{f,y}(w)] = 0$, we get\n$E_{x_{e_1},y}(w_1x_1^1y + w_2x_2^1y) = E_{x_{e_2},y} (w_1x_1^2y + w_2x_2^2y). \\tag{B3}$\nCase 1: For both $\\eta_{e_1} = 0$ and $\\eta_{e_2} = 0$, we have (i) $\\mathbb{E}[(x_1^i)^2] = \\mathbb{E}[(x_1^i)^2] = 1$, (ii)\n$\\mathbb{E}(x_1^i y) = \\alpha$, $\\mathbb{E}(x_2^i y) = b_i$, (iii) $\\mathbb{E}(x_1^i x_2^i) = \\alpha b_i$, where $\\alpha := 1 - 2\\alpha$ and $b_i := 1 - 2\\beta_{e_i}$\nfor $i \\in \\{1,2\\}$.\nThen, according to (B1), the solutions for IRMv1 ($\\lambda = +\\infty$) are\n(1) $w_1 = 0, w_2 = 0$;\n(2) $w_1 = \\alpha, w_2 = 0$;\n(3) $w_1 = \\frac{1}{2\\alpha}, w_2 = \\pm \\sqrt{\\frac{1}{2} - \\frac{1}{4\\alpha^2}}$ s.t. $\\alpha^2 > \\frac{1}{2}$;\n(4) $w_1 = - \\frac{1}{2\\alpha}, w_2 = \\mp \\sqrt{\\frac{1}{2} - \\frac{1}{4\\alpha^2}}$ s.t. $\\alpha^2 > \\frac{1}{2}, w_2 \\neq 0.$"}, {"title": "B.2 More calculation results", "content": "When optimizing IGA with $||\\nabla_w\\mathbb{R}_{e_1}(w) \u2013 \\nabla_w\\mathbb{R}_{e_2}(w)||^2 \\rightarrow 0$, we get\n$\\begin{aligned}\n(\\mathbb{E}_{x_{e_1},y}((x_1^1)^2w_1 + w_2x_1^1x_2^1 \u2013 x_1^1y) \u2013 \\mathbb{E}_{x_{e_2},y}((x_1^2)^2w_1 + w_2x_1^2x_2^2 \u2013 x_1^2y))^2 &+\\\\\n(\\mathbb{E}_{x_{e_1},y}((x_2^1)^2w_2 + w_1x_1^1x_2^1 \u2013 x_2^1 y) \u2013 \\mathbb{E}_{x_{e_2},y}((x_2^2)^2w_2 + w_1x_1^2x_2^2 \u2013 x_2^2 y))^2 &\\rightarrow 0;\n\\end{aligned} \\tag{B4}\nwhen optimizing Fishr with $||\\text{Var}(\\nabla_w\\mathbb{R}(x^{e_1}, w)) \u2013 \\text{Var}(\\nabla_w\\mathbb{R}(x^{e_2}, w))||^2 \\rightarrow 0$, we have\n$\\begin{aligned}\n\\mathbb{E}_{x_{e_1},y}((x_1^1)^2w_1 + w_2x_1^1x_2^1 \u2013 x_1^1y \u2013 \\mathbb{E}_{x_{e_1},y}((x_1^1)^2w_1 + w_2x_1^1x_2^1 \u2013 x_1^1y))^2 &-\\\\\n\\mathbb{E}_{x_{e_2},y}((x_1^2)^2w_1 + w_2x_1^2x_2^2 \u2013 x_1^2y \u2013 \\mathbb{E}_{x_{e_2},y}((x_1^2)^2w_1 + w_2x_1^2x_2^2 \u2013 x_1^2y))^2 &\\rightarrow 0, \\\\\n\\mathbb{E}_{x_{e_1},y}((x_2^1)^2w_2 + w_1x_1^1x_2^1 \u2013 x_2^1 y \u2013 \\mathbb{E}_{x_{e_1},y}((x_2^1)^2w_2 + w_1x_1^1x_2^1 \u2013 x_2^1 y))^2 &-\\\\\n\\mathbb{E}_{x_{e_2},y}((x_2^2)^2w_2 + w_1x_1^2x_2^2 \u2013 x_2^2 y \u2013 \\mathbb{E}_{x_{e_2},y}((x_2^2)^2w_2 + w_1x_1^2x_2^2 \u2013 x_2^2 y))^2 &\\rightarrow 0;\n\\end{aligned} \\tag{B5}"}, {"title": "Appendix C More causality analyses", "content": "Given the theoretical setting in Section 3, we have the following corollaries.\nSetting: Consider several training environments $\\mathcal{E}_{tr} = \\{e_1,e_2,...\\}$ and $x_e$ to be\nthe observed input of $e \\in \\mathcal{E}_{tr}$. We adopt an anti-causal framework [10] with data\ngeneration process as follows:\n$\\begin{aligned}\ny &= y^\\top \\hat{x}_{inv} + \\eta_y, \\\\\n\\hat{x}_{inv} &= x_{inv} + \\eta_{inv}, x_s = x_s + \\eta_s, \\\\\n\\mathcal{x}_e &= \\mathcal{S}\\left(\\begin{array}{l}\n\\hat{x}_{inv} \\\\x_s\n\\end{array}\\right),\n\\end{aligned}$\nwhere $y \\in \\mathbb{R}^{d_{inv}}$ and $y \\neq 0$, the hidden invariant feature $\\hat{x}_{inv}$ and the observed\ninvariant feature $x_{inv}$ take values in $\\mathbb{R}^{d_{inv}}$, the hidden spurious feature $x_s$ and the\nobserved spurious feature $x_s$ take values in $\\mathbb{R}^{d_s}$, and $\\mathcal{S}: \\mathbb{R}^{(d_{inv}+d_s)} \\rightarrow \\mathbb{R}^{d}$ is an inherent\nmapping to mix features. The hidden spurious feature $x_s$ is generated by $y$ with any\nnon-invariant relationship, $\\eta_{inv}$ and $\\eta_{s}$ are independent Gaussian with bounded mean\nand variance changed by environments, $\\eta_y$ is an independent and invariant zero-mean\nGaussian with bounded variance. As the directed acyclic graph (DAG) in Figure 4(b)\nshows, the hidden invariant feature $\\hat{x}_{inv}$ generates the true label $y$ and $y$ generates\nthe hidden spurious feature $x_s$. In consideration of environmental noise, we can only\nobserve the input $\\mathcal{x}_e$ which is a mixture of $x_{inv}$ and $x_s$ after mapping. (Note that the\nobserved feature is generated by applying environmental noise to the hidden feature.)\nWe follow the assumption from IRM [10], i.e., assume that there exists a mapping\n$\\mathcal{\\check{S}} : \\mathbb{R}^{d} \\rightarrow \\mathbb{R}^{d_{inv}}$ such that $\\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x})) = x_1$ for all $x_1 \\in \\mathbb{R}^{d_{inv}}, x_2 \\in \\mathbb{R}^{d_s}$. and aim to\nlearn a classifier to predict $y$ based on $\\mathcal{x}_e$, i.e., $f(\\mathcal{x}_e; w) = h(g(\\mathcal{x}_e; \\Phi); v)$.\nCorollary C.1. If $\\Phi$ elicits the desired invariant predictor $f(\\cdot; w) = y^\\top \\mathcal{\\check{S}}(\\cdot)$, there\nexist noisy environments $\\{e_1, e_2\\}$ such that\n$\\nabla_w\\mathbb{R}_{e_1}(w) \\neq \\nabla_w\\mathbb{R}_{e_2}(w).$"}, {"title": "Appendix D Proofs", "content": "Here, we provide the proofs for Theorem 3.1, Corollary 3.2 and Corollary 3.3,\nrespectively.\nProof 3.1. Assume that there exists a mapping $\\mathcal{\\check{S}} : \\mathbb{R}^{d} \\rightarrow \\mathbb{R}^{d_{inv}}$ such that $\\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x})) = x_1$\nfor all $x_1 \\in \\mathbb{R}^{d_{inv}}, x_2 \\in \\mathbb{R}^{d_s}$. Then, if $\\Phi$ elicits the desired (optimal) invariant\npredictor $f(\\cdot; w) = y^\\top \\mathcal{\\check{S}}(\\cdot)$, we have\n$\\begin{aligned}\n\\rho_{f,y} (w) &= E_{\\mathcal{x}_e,y} [f(\\mathcal{x}_e; w)y \u2013 E_{\\mathcal{x}_e} (f(\\mathcal{x}_e;w))y]\n\\\\&= E_{\\mathcal{x}_e,y} [y^\\top \\Phi \\mathcal{x}_e y] \u2013 E[y^\\top \\Phi \\mathcal{x}_e]E[y]\n\\\\&= E_{\\mathcal{x}_e,y} [y^\\top \\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x}))y] \u2013 E[y^\\top \\mathcal{\\check{S}}(\\mathcal{S}(\\mathcal{x}))]E[y]\n\\\\&= E_{\\mathcal{x}_e,y} [y^\\top x_{inv} y] \u2013 E[y^\\top x_{inv}]E[y]\n\\\\&= E[(y^\\top x_{inv})^2] \u2013 [E(\\gamma^\\top x_{inv})]^2\n\\\\&= \\text{Var}(y^\\top x_{inv}),\n\\end{aligned} \\tag{D8}$\nfor all $e \\in \\mathcal{E}$. As $\\text{Var}(y^\\top x_{inv})$ remains constant in all environments, we have\n$\\text{Var}(\\rho_{f,y}(w)) = 0$.\nHence, proved.  \\quad \\blacksquare\nProof 3.2. If $\\Phi$ elicits the desired invariant predictor $f(\\cdot; w) = y^\\top \\mathcal{\\check{S}}(\\cdot)$, consider\nsquare loss and the fixed \"dummy\" classifier $v = 1$, then\n$\\begin{aligned}\n\\frac{d\\mathbb{R}_e(w)}{dv_{|v=1}} &= \\frac{d\\mathbb{E}_{\\mathcal{x}_e,y}[(f(\\mathcal{x}_e; w) - y)^2]}{dv_{|v=1}}\n\\\\&= \\mathbb{E}_{\\mathcal{x}_e,y}[(v_{|v=1}(\\mathcal{x}_{inv} + y + \\eta_{inv}) \u2013 y^\\top \\mathcal{x}_{inv} \u2013 \\eta_y)^2]\n\\\\&= \\mathbb{E}_{\\mathcal{x}_e,y}((\\gamma^\\top \\eta_{inv})(y^\\top x_{inv} + (y^\\top \\eta_{inv})^2 \u2013 y^\\top x_{inv}\\eta_y \u2013 y^\\top \\eta_{inv}\\eta_y)).\n\\end{aligned} \\tag{D9}$\nObviously, when $y \\neq 0$, there exists $\\eta_{inv}$ in noisy environments such that $\\frac{d\\mathbb{R}_e(w)}{dv_{|v=1}} \\neq 0$.\n\\quad \\blacksquare"}, {"title": "Appendix E More experiments and details", "content": "Experimental details: All experiments are implemented on NVIDIA A100 and AMD\nEPYC 7452 32-Core Processor.\nFor the experiment with ColoredMNIST, we use the exactly same\nsetting as https://github.com/capybaralet/REx_code_release/blob/master/\nInvari-ant RiskMinimization/colored_mnist/main.py, only replacing the IRMv1\npenalty and VREx penalty with ICorr penalty and other penalties.\nFor the experiment with Circle Dataset, we use the exactly same setting as https:\n//github.com/hehaodele/CIDA/blob/master/toy-circle/main-half-circle.ipynb, only\napplying noises to source domains and adding ICorr penalty term.\nCausal Invariance experiment: We then describe the definition of Causal\nInvariance specified by [10, 11, 16, 18] as in Definition E.1.\nDefinition E.1. (Causal Invariance) Given a predictor $f(\\cdot; w) = h(g(\\cdot; \\Phi); v)$, the\nrepresentation produced by the featurizer $\\Phi$ is invariant over $\\mathcal{E}$ if and only if for all\n$e_1, e_2 \\in \\mathcal{E}$, it holds that\n$\\mathbb{E}_{x_{e_1},y}(y|g(x^{e_1}; \\Phi) = z) = \\mathbb{E}_{x_{e_2},y}(y|g(x^{e_2}; \\Phi) = z) \\tag{E11}$\nfor all $z \\in \\{g(x^{e_1}; \\Phi)|e_1\\} \\cap \\{g(x^{e_2}; \\Phi)|e_2\\}$.\nFollowing Chen et al. [16], a regression example is designed with $x: \\mathbb{R}^2 \\rightarrow y: \\mathbb{R}$.\nThe input $x$ is with two dimensions, i.e., $x = (x_1, x_2)$, where $x_1$ represents horizontal\naxis and $x_2$ represents vertical axis in Figure D3. $x_1$ is designed to be the invariant\nfeature and $x_2$ is designed to be the spurious feature. Consider environmental inherent"}]}