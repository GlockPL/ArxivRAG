{"title": "Diffusion based multi-domain neuroimaging\nharmonization method with preservation of\nanatomical details", "authors": ["Haoyu Lan", "Bino A. Varghese", "Nasim Sheikh-Bahaei", "Farshid Sepehrband", "Arthur W Toga", "Jeiran Choupan"], "abstract": "Multi-center neuroimaging studies face technical variability due to batch differ-\nences across sites, which potentially hinders data aggregation and impacts study\nreliability. Recent efforts in neuroimaging harmonization have aimed to mini-\nmize these technical gaps and reduce technical variability across batches. While\nGenerative Adversarial Networks (GAN) has been a prominent method for address-\ning image harmonization tasks, GAN-harmonized images suffer from artifacts or\nanatomical distortions. Given the advancements of denoising diffusion probabilis-\ntic model which produces high-fidelity images, we have assessed the efficacy of\nthe diffusion model for neuroimaging harmonization. we have demonstrated the\ndiffusion model's superior capability in harmonizing images from multiple do-\nmains, while GAN-based methods are limited to harmonizing images between two\ndomains per model. Our experiments highlight that the learned domain invariant\nanatomical condition reinforces the model to accurately preserve the anatomical\ndetails while differentiating batch differences at each diffusion step. Our proposed\nmethod has been tested on two public neuroimaging dataset ADNI1 and ABIDE II,\nyielding harmonization results with consistent anatomy preservation and superior\nFID score compared to the GAN-based methods. We have conducted multiple\nanalysis including extensive quantitative and qualitative evaluations against the\nbaseline models, ablation study showcasing the benefits of the learned conditions,\nand improvements in the consistency of perivascular spaces (PVS) segmentation\nthrough harmonization.", "sections": [{"title": "1 Introduction", "content": "Magnetic resonance imaging (MRI) data acquired from different batches, including various imaging\nsites or scanners, has shown promise in improving sample sizes for neuroscience studies that rely\non imaging and predictive efforts Bethlehem et al. [2022] Marek et al. [2022] Van Erp et al. [2014]."}, {"title": "", "content": "However, these neuroimaging data from multiple batches are susceptible to non-biological and\ntechnical variations that occur between data acquisition from different batches, commonly known\nas batch effects. These batch effects can arise from disparities in acquisition protocols, scanner\nmanufacturers, scanner drift, and hardware imperfections Jovicich et al. [2006]. The existence of\nbatch effects can potentially pose challenges in terms of reproducibility of neuroscience studies,\ngeneralizability of prediction algorithms, and effective integration of radiomics-based imaging\nbiomarkers in clinical practice Grech-Sollars et al. [2015]. Neglecting to consider the acknowledged\ninterference of batch effects can result in a reduction in effectiveness, less reliable discoveries,\nand potentially distorted results. Various types of methods have been investigated to harmonize\nthe neuroimaging data to remove the batch effects ranging from statistical methods focusing on\ncorrecting the feature distributions Fortin et al. [2017] Bayer et al. [2022] Fortin et al. [2016] to\nimage processing methods focusing on harmonizing the raw MRI images directly Cackowski et al.\n[2023] Chang et al. [2022] Yao et al. [2022] Zuo et al. [2021] Dinsdale et al. [2021] Ren et al. [2021].\nThere are limitations commonly recognized in the harmonization tasks, such as, possibly introduced\ncorrelation between subjects during the harmonization process due to the entangled batch effects and\nbiological effects. Therefore, the efficient separation between biological effects and batch effects and\na precise estimation of these effects are imperative.\nTo address the harmonization problem in neuroimaging data and overcome the existing issues in the\nharmonization methods, we attempted to utilize the diffusion probabilistic model Ho et al. [2020]\nand our contributions are as follows:\n\u2022 We formulated the neuroimaging harmonization problem as a controllable domain adaptation\nproblem.\n\u2022 We proposed the skip sampling step to reduce the sampling steps for the harmonization\npurpose.\n\u2022 We tested the proposed method in two public datasets ABIDE II and ADNI 1:\n1. Our diffusion model-based harmonization method achieved superior harmonization\nresults compared to GAN based models on ABIDE II dataset for site effects harmoniza-\ntion. We also visually demonstrated the effectiveness of multiple diffusion trajectories\nlearning of the proposed method.\n2. We evaluated the scanner effects harmonization by downstream PVS segmentation\nanalysis on ADNI 1 dataset and showed improved consistency of the PVS count ratio\nacross scanners.\nIn this study, we show that denoising diffusion model could effectively address the batch effects\nharmonization with the preservation of anatomical details. We also found the learned condition\nimproves the harmonization performance compared to fixed condition (edge map). In addition,\ndiffusion model provides strong ability of learning multiple diffusion trajectories controlled by the\ndomain embeddings, which enables the multi-domain harmonization through only one single model.\nCompared to GAN based harmonization method, diffusion model also has several other advantages\nsuch as stable training and high-fidelity image generation."}, {"title": "2 Related work", "content": "The field of generative models has garnered significant interest in recent years due to their remarkable\ncapability to learn the joint distribution. Mostly adopted models such as generative adversarial net-\nworks Goodfellow et al. [2020], variational autoencoder Doersch [2016], and probabilistic diffusion\nmodel Ho et al. [2020] Song et al. [2020] also had a great impact in the medical image analysis field.\nGAN models have been popularly implemented in the neuroimage harmonization task. Chang et al.\n[2022] modeled CycleGAN Zhu et al. [2017] to generate unpaired synthetic target scanner style\nimage, then used the original image to perform histogram matching with the synthetic target scanner\nstyle image and achieved style harmonization. Yao et al. [2022] proposed a style \u2013 content disentangle\nGAN to harmonize between the contrast enhanced T1w and high resolution T2w. Because batch ef-\nfects are implicitly defined as style, this method has the risk of incorrectly including biological effects\nas the style. Zuo et al. [2021] proposed a variational autoencoder based model Contrast Anatomy\nLearning and Analysis for MR Intensity Translation and Integration (CALAMITI). CALAMITI\nencodes image into low-dimensional style-invariant content representation, then generates target"}, {"title": "3 Proposed Method", "content": ""}, {"title": "3.1 Multi-domain neuroimaging harmonization as a controllable domain adaption problem", "content": "Neuroimaging data acquired at different manufactured scanners, or at different imaging sites often\ncontain non-biological domain shifts introduced by these technical variabilities Hu et al. [2023]Bayer\net al. [2022]. We approached the multi-domain neuroimaging harmonization as a controllable domain\nadaption task Farahani et al. [2021], which aims to learn the batch effects by a domain embedding\ncontrolled denoising diffusion process. Since one of the remained challenges in the most neuroimage\nharmonization techniques is the lack of the ability to disentangle the biological effects and batch\neffects during the harmonization process, we conditioned the diffusion process with a learned domain\ninvariant condition. This condition reinforces preservation of the anatomical details during the\ndiffusion harmonization process.\nWe introduced a denoising diffusion model based multi-domain harmonization framework (Figure 1)\nwhich includes a domain invariant condition extractor C and a denoising network Dt. Both modules\nwere controlled by the domain embedding which determines the diffusion trajectory."}, {"title": "3.2 Learned domain invariant conditioned controllable denoising diffusion model", "content": "Denoising diffusion probabilistic model (DDPM) learns to capture the underlying structure of\nclean images and the noise characteristics at each time step, enabling DDPM to effectively denoise\nnew, unseen images. The denoising network Dt was implemented following DDPM paper which\nis a positional time embedding t controlled U-Net Ronneberger et al. [2015] model with slight"}, {"title": "3.3 Skip sampling", "content": "Assume we have 100 steps for the diffusion process and at the end of the diffusion, X100 have\nbeen efficiently corrupted to the random noise. For the denoising network D100 to predict the\nuncorrupted images X0, the only resource it can rely on is the domain invariant condition Y and\ndomain embedding Ztarget. This feature makes the domain style prediction of X0 at diffusion step\n100 purely controlled by Ztarget and anatomical prediction of Xo purely conditioned on Y. One"}, {"title": "4 Experiments and Results", "content": ""}, {"title": "4.1 Dtaset", "content": "ADNI 1: We selected the older participants of the Alzheimer's Disease Neuroimaging Initiative\n(ADNI 1) Jack Jr et al. [2008] cohort as one of the experiment datasets. 456 participants, aged\nbetween 55 and 90 years were gathered during the 12-month follow-up period after recruitment. All\n456 subjects' MRI images collected for this study follow the same image acquisition: T1w MPRAGE\nMRI images using scanners manufactured by either GE Healthcare, Philips Medical Systems, or\nSiemens Medical Solutions operating at 1.5T field strength. These images had a voxel resolution of\n1.25 \u00d7 1.25 \u00d7 1.2mm\u00b3 and were obtained with the following acquisition parameters: TR=2400 ms,\nTE= 3.6 ms, flip angle=8.0 degrees, FOV=24 cm, and slice thickness=1.2mm.\nABIDE II : We selected data of four sites from the Autism Brain Imaging Data Exchange (ABIDE\nII) Di Martino et al. [2014] as one of the experiment datasets including 48 subjects from Erasmus\nUniversity Medical Center Rotterdam (EMC), 36 subjects from ETH Zurich (ETH), 90 subjects\nfrom Georgetown University and 78 subjects from NYU Langone Medical Center (NYU). Detailed\nacquisition parameters could be found in Table 2.\nwe selected axial slices from each subject with brain signals (whole background signal slices were\ndiscarded) which resulted in 45600 training samples/11400 testing samples for ADNI 1; 35280\ntraining samples/8820 testing samples for ABIDE II. Detailed image preprocessing steps could be\nfound in Appendix C."}, {"title": "4.2 Perivascular spaces", "content": "PVS Wardlaw et al. [2020]Barisano et al. [2022], also known as Virchow-Robin spaces, are fluid-filled\nspaces that surround penetrating blood vessels in the brain. These spaces are lined by a layer of\ncells and contain cerebrospinal fluid (CSF). PVS play an important role in the brain waste clearance\nexchanging nutrients and waste products between CSF and brain tissue. They are more visible in\nT2-weighted MRI sequences, in comparison with T1-weighted sequences. In certain conditions or\ndiseases, PVS may become enlarged or show abnormalities, which can be indicative of underlying\nhealth issues. Frangi filter Frangi et al. [1998] is an image processing algorithm that detects tubular\nstructures in the 2D or 3D image spaces and commonly adopted to segment PVS in the T1w or T2w\nMRI images Sepehrband et al. [2019]Lan et al. [2023]Ballerini et al. [2018]. To generate the PVS\ncount, binarized PVS map would be generated at first. Then the regions with less than 3 connected\nvoxels would be removed, which could be potential random noise or motion corruption captured by\nfrangi filter. Finally, the overall PVS count would be divided by total white matter volume to generate\nthe PVS count ratio as a more generalized measure. We used PVS count ratio as a evaluation metric\nof scanner effects existing in ADNI 1.\nBatch effects in the T1w images from ADNI 1 are the scanner effects and we focused on the PVS\nsegmentation as the downstream analysis to demonstrate the harmonization efficacy. Batch effects in\nthe T1w images from ABIDE II are the site effects and we reported FID score Heusel et al. [2017]\nand qualitative visualization to demonstrate the harmonization efficacy."}, {"title": "4.3 Experimental setup", "content": "The denoising network was designed following original DDPM U-Net noise estimation model with 5\nskip-connection levels and each level was constituted by two ResNet He et al. [2016] blocks each\nwith two convolutional layers. Self-attention Vaswani et al. [2017] was calculated at down-sampling\nand up-sampling path at third level and bottleneck layers. The condition extractor was designed the\nsame way as the denoising network with only one encoder, one decoder, and not controlled by the\npositional time embedding. Noise variance \u1e9e was quadratically schedule between 0.0001 and 0.5\nwith 100 steps as a fixed sequence. CycleGAN and Seg-Renorm models were downloaded from their\npublic GitHub repositories and finetuned accordingly with our experimental datasets. All experiments\nwere implemented and conducted using Python 3.8 and PyTorch 1.13.1 and deployed on NVIDIA\nGPU cluster equipped with eight V100 GPUs for training and testing.\nThe separately trained domain classifier was a ResNet with 6 levels and 2 convolution layers at each\nlevel. Self-attention was calculated before the sixth level. The domain classifier has been trained\nto classify the corresponding image domain and we used its multilayer perceptron layer with 512\nelements before the classification head as the domain embedding. All models were trained and\nreached optimal results on the validation data."}, {"title": "4.4 Domain embedding controls DDPM to learn multiple diffusion trajectories", "content": "Domain embedding controls diffusion model to learn multiple diffusion trajectories at once which\nenables multi-domain harmonization with single model. Figure 2 is the qualitative visualization of\nthe diffusion sampling process for the ABIDE II dataset. One sample of each of the three sites was\nrandomly selected for this visualization. To demonstrate multiple intermittent steps of the diffusion\nprocess of the harmonization task, skip sampling was not used. Z1 (red), Z2 (green) and Z3 (yellow)\nrepresent the three domain embeddings generated by the pretrained domain classifier and colored\narrows represent different sampling trajectories. Samples from four time-steps X100,X60,X30,X0 are\nshown for visual comparison. For the images on the left side, Ztarget equals to Zsource; for the images\non the right side, Ztarget is Z3. As time T goes from 100 to 0, the site difference (approximately\nindicated by the distance between each pair of dots at each time step) is increasing, which can also be\nvisually verified by image samples' differences at each time step on the left side. This indicates that\nthe denoising network learned multiple diffusion trajectories and correctly correlated to the control\ndomain embedding. By controlling sampling process with Z3 on the right side, the image samples'\ndifferences at each time step were reduced resulting in harmonized images."}, {"title": "4.5 Evaluation of harmonization on ABIDE II", "content": "Figure 3 shows the harmonization results of image samples from four sites EMC, ETH, GU and\nNYU of ABIDE II to the target image domains respectively. The far-left column shows samples of\ntarget image domains (reference of imaging texture), the top row shows samples of source image\ndomain (reference of anatomical details), and the rest of the images show harmonization results\nto the corresponding target image domain. The red dash squares highlight the harmonization case\nwhere target image domain equals to the source image domain. Within the zoomed in regions, it\ncould be easily noted that the source images have been harmonized to the target image domain with\ncorresponding textures and contrasts and have anatomical details preserved."}, {"title": "4.6 Harmonization improves consistency of PVS count ratio across MRI scanners on ADNI 1", "content": "As shown in Figure 5 A., we observed inconsistent Frangi filter segmented PVS count ratio distri-\nbutions among images in ADNI 1, with lower PVS count ratio in the images acquired by Philips\ncompared to images acquired from other two types of scanners. After the harmonization, PVS count\nratio distribution became consistent across images acquired from all three scanners. Figure 5 B.\nshows the original image acquired at Philips scanner, the image harmonized to GE scanner style\nand PVS segmentation overlays. The red circles indicate regions with increased PVS contrast in\nharmonized images compared to original images. The blue overlay is the PVS segmentation from\nthe harmonized image and the green overlay is the PVS segmentation from the original image. Note\nthat since green overlay was stacked on top of blue overlay, visible blue voxels indicate the PVS\nwhich were missed by the segmentation from the original image. The same Frangi filter threshold\nwas applied to both segmentations.\nWe used trained domain classifier to extract the domain embeddings from images for the t-SNE\nVan der Maaten and Hinton [2008] visualization which could be found in Figure 7. As shown in the\nFigure 7, t-SNE visualizes the extracted domain embedding vectors of test data in the two-dimensional\nspace for ADNI 1 dataset. Test images in the original image space have formed three distinct clusters\nas shown in the top left corner of the figure. After the images get harmonized to either GE, Philips, or\nSiemens scanner effects, the separations disappear and all test data belong to one big cluster, which\nindicates that the harmonized images only contain one of the three scanner effects."}, {"title": "4.7 Ablation study (learned condition improves the generated image quality)", "content": "We study alternative denoising network conditioning by removing the condition extractor network\nand instead using the edge map as the condition Y. As shown in Figure 6, samples from two image\ndomains were presented and 'Fixed condition' represents the edge map conditioning. NYU data is the\nonly site among four sites from ABIDE II that is sensitive to the artery signals. One interesting result\nfrom the edge map conditioning is the removed artery signals by harmonizing NYU data to EMC data\ndomain and generated artery signals by harmonizing EMC data to NYU data domain as indicated by\ngreen circles. However, the anatomical details were not fully preserved after the harmonization with\nedge map conditioning as indicated by red circles. In Table 1 we also reported inferior FID score of\nthe proposed method with fixed condition compared to the learned condition."}, {"title": "5 Discussion and Conclusion", "content": "We proposed a diffusion-based multi-domain harmonization framework which learns multiple diffu-\nsion trajectories correlated to image domains respectively. Diffusion model was conditioned on the\nlearned domain invariant condition which guarantees the anatomical details unchanged during the\nharmonization. A skip sampling was introduced to shorten the sampling process. We quantitatively\nevaluated our proposed method on ABIDE II dataset by FID score for site effects harmonization and\nqualitatively demonstrated the superior performance of our method compared to two baseline GAN\nbased models. Further, we evaluated our method on ADNI 1 dataset for scanner effects harmonization\nwith an additional PVS segmentation downstream analysis to show improved consistency of PVS\ncount ratio after the harmonization."}, {"title": "5.1 Limitations", "content": "ADNI 1 dataset used for the experiment was acquired under the 1.5T field strength with three imaging\nvendors; ABIDE II used for the experiment was acquired under 3T field strength from four imaging\nsites. For our experiment, the learned domain condition edge map for the diffusion model has been\nonly tested for the images acquired under the same field strength and harmonization focused on the\nimaging texture heterogeneities. In this study, we did not perform the harmonization tasks on images\nacquired under different field strengths or incorporating the super-resolution, nor the reliability of\nlearned domain condition edge map has been tested in those cases. Also, proposed method was\nonly tested on the neuroimaging data, which is the focus of this study. We will be looking forward"}, {"title": "5.2 Conclusion", "content": "In conclusion, our work showed efficacy of using diffusion model to tackle neuroimaging harmo-\nnization problem with the preservation of anatomical and biological details. Our work is specifically\nevaluated to harmonize the imaging texture heterogeneity caused by the technical variability present\nin the large cohorts of multi-center dataset. Such datasets are valuable to be used for investigating\nthe association between clinical pathologies and differentiating their lasting impacts on the clinical\nmanifestation of neurological diseases. For future work, it is recommended to explore a more efficient\ndomain embedding method which is capable of capturing the hierarchical domain variant."}, {"title": "A Skip sampling pseudocode", "content": ""}, {"title": "B Acquisition parameters of selected sites from ABIDE II", "content": ""}, {"title": "C Image preprocessing of the ANDI 1 and ABIDE II datasets", "content": "FreeSurfer version 7.1.1 recon-all module on the Laboratory of Neuro Imaging (LONI) pipeline\nsystem (https://pipeline.loni.usc.edu) initially resampled all images to 256 \u00d7 256 \u00d7 256 image size,\n1 \u00d7 1 \u00d7 1 mm3 voxel resolution, rescaled intensity range to 0-255, and reoriented the images to RAS\n(Right, Anterior, Superior) coordinate system. Non-parametric Non-uniform intensity Normalization\n(N3) Sled et al. [1998] was used to correct the bias field through FreeSurfer. The bias filed correction\nusing N3 was only meant to correct the bias field present equally in images acquired from different\nscanners or imaging sites. Preprocessed images have voxel intensity rescaled to 0 255, which\nremoved the intensity value range batch effect observed from images acquired from different sites\nand scanners."}, {"title": "Dt-SNE visualization of harmonization effect on ANDI 1", "content": "t-SNE visualization is shown in Figure 7."}]}