{"title": "FetDTIAlign: A Deep Learning Framework for Affine and Deformable Registration of Fetal Brain dMRI", "authors": ["Bo Li", "Qi Zeng", "Simon K. Warfield", "Davood Karimi"], "abstract": "Diffusion MRI (dMRI) offers unique insights into the microstructure of fetal brain tissue in utero. Longitudinal and cross-sectional studies of fetal dMRI have the potential to reveal subtle but crucial changes associated with normal and abnormal neurodevelopment. However, these studies depend on precise spatial alignment of data across scans and subjects, which is particularly challenging in fetal imaging due to the low data quality, rapid brain development, and limited anatomical landmarks for accurate registration. Existing registration methods, primarily developed for superior-quality adult data, are not well-suited for addressing these complexities. To bridge this gap, we introduce FetDTIAlign, a deep learning approach tailored to fetal brain dMRI, enabling accurate affine and deformable registration. FetDTIAlign integrates a novel dual-encoder architecture and iterative feature-based inference, effectively minimizing the impact of noise and low resolution to achieve accurate alignment. Additionally, it strategically employs different network configurations and domain-specific image features at each registration stage, addressing the unique challenges of affine and deformable registration, enhancing both robustness and accuracy. We validated FetDTIAlign on a dataset covering gestational ages between 23 and 36 weeks, encompassing 60 white matter tracts. For all age groups, Fet-DTIAlign consistently showed superior anatomical correspondence and the best visual alignment in both affine and deformable registration, outperforming two classical optimization-based methods and a deep learning-based pipeline. Further validation on external data from the Developing Human Connectome Project demonstrated the generalizability of our method to data collected with different acquisition protocols. Our results show the feasibility of using deep learning for fetal brain dMRI registration, providing a more accurate and reliable alternative to classical techniques. By enabling precise cross-subject and tract-specific analyses, FetDTIAlign paves the way for new discoveries in early brain development.", "sections": [{"title": "1 Introduction", "content": "Precise characterization of early brain growth in utero is crucial for understanding typical neurodevelopmental trajectories and identifying deviations that may indicate neurological disorders. This understanding is essential from a neuroscience viewpoint as the fetal period is one of the most important stages in brain development [1,2]. Moreover, it can potentially be helpful in identifying high-risk fetuses for prenatal counseling and early developmental services. In this context, diffusion MRI offers the unique possibility to quantify the developing white matter of the fetal brain. These advanced techniques are invaluable for imaging studies that seek to understand the trajectory of brain development and the underlying neuroanatomy and neuro-microstructure [3-6]. Diffusion MRI measures the directional movement of water molecules within the tissue, and thus allows for the reconstruction of the brain's white matter organization. This is crucial for quantifying the connectivity and integrity of neural pathways as they emerge and mature during fetal development. By capturing subtle changes in the diffusion properties of brain tissue, these methods advance our understanding of the complex processes underlying brain development in utero.\nIn brain imaging studies, voxel-wise analysis that compares local image measures across groups is commonly employed, with voxel-based morphometry (VBM) being a prime example [7]. VBM offers several advantages: it is fully automated, straightforward to apply, and capable of investigating the entire brain without the need to define regions or features of interest. However, VBM relies on precise spatial correspondence across datasets, which presents a significant challenge, particularly when it is applied to diffusion imaging. Alternatively, region-of-interest and tractography-based approaches are often favored for diffusion imaging, as they operate within the space of individual subject's results, thereby avoiding the spatial correspondence issues. Nevertheless, these methods typically require user intervention to define the region to be tested. To address these limitations and combine the strengths of these approaches, tract-based spatial statistics (TBSS) was proposed [8].\nTBSS, as implemented in the FMRIB Software Library (FSL) [9], was introduced to mitigate the effects of residual misalignment during the deformable registration of diffusion imaging. This approach facilitates localized cross-subject statistical analysis and eliminates the need to set a kernel size for smoothing as required in VBM [10]. Additionally, TBSS results are more reproducible than those of VBM or techniques that rely on manual ROI placement [11]. However, TBSS still requires that images be aligned in a common space, which presents significant challenges. Establishing anatomical correspondence across subjects is particularly difficult for low-quality data or for subjects with rapidly changing imaging characteristics, such as fetal brain images, which is the focus of this study. While the skeletonization and projection procedures in TBSS may compensate for minor misalignments, they can disrupt topological consistency when misalignments are substantial. Since only voxels containing locally maximal fractional anisotropy (FA) values are independently projected onto the skeleton without considering fiber tract geometry, regions between two skeleton points can be artificially split across multiple anatomical locations [12]. Furthermore, the construction of the skeleton across the entire white matter does not differentiate between adjacent white matter tracts. Consequently, voxels with locally maximal FA values may be misassigned to neighboring fiber tracts within the projection's search range, such as the inferior longitudinal and inferior frontal-occipital fasciculi [13].\nTo enhance the original TBSS pipeline, prior efforts have focused on its key components: 1) improving registration quality to achieve better anatomical correspondence across subjects, 2) refining the representation of tract-specific diffusion measures to increase specificity and reduce the influence of adjacent tracts [14-18], and 3) advancing the statistical analysis of the derived measures.\nImage registration is a powerful tool in medical imaging. It estimates a displacement field that describes how points in one image should move to optimally match the anatomically corresponding points in another image so that the same structures or image features can be compared across scans or subjects. It is however a complex and ill-posed estimation problem and presents additional challenges when co-registering matrix-encoded dMRI data compared with scalar images, such as T1-weighted MRI [19]. The spatial registration of dMRI has been performed using various diffusion-based measures, including FA scalar maps derived from diffusion tensor imaging (DTI) [20-24], diffusion tensors [4, 25-30], orientation distribution functions [31-34], tractography streamlines [35-37], and multi tensor-based models [38,39].\nSeveral studies have explored updating the TBSS pipeline with contemporary advancements in image registration techniques. For instance, [21] evaluated the feasibility of replacing TBSS's two-step registration-projection approach with a single registration step, finding that better alignment could be achieved by upsampling diffusion tensor rather than upsampling tensor-derived FA images when bringing the FA maps to the standard MNI152 space. [13] suggested using a high-resolution DTI template as the common space target for registration instead of using the default FA template. Similarly, improvements were observed when group-wise registration was employed to spatially normalize FA images to a study-specific template, [40, 41]. Improved registration increases the longitudinal test-retest reliability of TBSS [42] and allows for voxel-wise analysis that outperforms TBSS [22].\nNevertheless, achieving accurate in utero assessments of fetal brain development is fraught with complexities due to the dynamic and rapidly developing nature of the fetal brain during early growth, the small size of the developing structures, fetal and maternal motion, and the inherent limitations in resolution and signal-to-noise ratio of current imaging techniques. These complexities have precluded the use of TBSS for studying brain development in the human fetus. In this study, we lay the foundation by introducing the first computational method designed for accurate spatial alignment of fetal brain dMRI, i.e., FetDTIAlign, enabling voxel-wise and tract-specific imaging studies of the human fetus. Our method leverages advances in learning-based techniques for both affine and deformable registration, as well as recent availability of high-quality spatiotemporal fetal DTI atlases. We anticipate that FetDTIAlign, which integrates tract segmentation with a DTI-based high-dimensional registration framework, will ensure precise focal and geometric correspondence across fetal brains, enabling more accurate modeling of the early stage of brain's developmental trajectory."}, {"title": "2 Background", "content": null}, {"title": "2.1 Diffusion Tensor Imaging (DTI)", "content": "DTI is one of the local diffusion models that characterizes the diffusion of water molecules in biological tissues, providing insight into the microstructural integrity of white matter in the brain [43]. The core of DTI is the diffusion tensor, a mathematical construct represented as a 3 \u00d7 3 symmetric positive-definite matrix, D, which describes the diffusion process in three-dimensional space: \n$$D =\n\\begin{bmatrix}\nD_{xx} & D_{xy} & D_{xz} \\\\\nD_{xy} & D_{yy} & D_{yz} \\\\\nD_{xz} & D_{yz} & D_{zz}\n\\end{bmatrix}$$\nThis tensor is estimated from diffusion MRI acquired in multiple gradient directions [44]. Mathematically, the diffusion-weighted signal $S(g)$ in the presence of a diffusion gradient g can be expressed as:\n$$S(g) = S_0 \\exp (-b g D g),$$\nwhere: $S_0$ is the signal intensity without diffusion weighting, b is the diffusion weighting factor (i.e., b-value), and g is the unit vector in the direction of the applied gradient (i.e., b-vector).\nTo derive bio-physically meaningful measures from the diffusion tensor, the eigenvalues ($\u03bb_1, \u03bb_2, \u03bb_3$) of the tensor are calculated. These eigenvalues correspond to the principal diffusivities along the major, medium, and minor axes of diffusion. From these eigenvalues, several scalar diffusion measures are computed, each providing different insights into tissue microstructure. Fractional anisotropy (FA) quantifies the degree of anisotropy of diffusion, indicating how directional the diffusion is within a voxel:\n$$FA = \\sqrt{\\frac{3 \\sqrt{(\u03bb_1 \u2013 \\overline{\u03bb})^2 + (\u03bb_2 \u2013 \\overline{\u03bb})^2 + (\u03bb_3 \u2013 \\overline{\u03bb})^2}}{V2 \\sqrt{ \u03bb_1^2 + \u03bb_2^2 + \u03bb_3^2}},$$\nwhere $ \\overline{\u03bb} = \\frac{\u03bb_1+\u03bb_2+\u03bb_3}{3}$ is the mean diffusivity (MD).\nThese diffusion measures are fundamental in analyzing the microstructural properties of brain tissues and form the basis for more complex analyses, which will be described in the following sections."}, {"title": "2.2 Tract-Based Spatial Statistics (TBSS)", "content": "The standard TBSS pipeline [8] primarily concerns the FA maps computed from the DTI of a given group of subjects. It starts by registering all subjects' FA images into a common space by linear and nonlinear registration, using FLIRT and FNIRT approach as available in FSL [45, 46]. Three choices of the common space template (i.e., target image) are provided: (1) an existing image within the group that is identified as the most typical subject in the group, who has a minimum mean deformation to all other subjects, (2) a standard template image, for instance, \"FMRIB58_FA_1mm\" in the MNI152 space, and (3) a user-specified template. Once all subjects' FA images are aligned to the chosen target, the transformed images are averaged to create a mean FA image. Subsequently, an FA skeleton is computed from the mean FA image, the local surface perpendicular to the skeleton sheet is computed, and a search is performed in this direction to identify the voxel with the highest FA, which is deemed to represent the center of the tract. This is further filtered by an FA threshold in order to restrict further analysis to only the voxels that are within white matter and have good correspondence across subjects. Finally, each subject's aligned FA image is \"projected\" onto the mean FA skeleton. At each point in the skeleton, a given subject's FA image is searched in the perpendicular tract direction to find the maximum FA value, and assign this value to the skeleton voxel. This results in a 4D volume of all FA skeletonized. The aim here is to account for residual misalignment between subjects after the nonlinear registrations by achieving alignment between the skeleton and the subject's FA image, without requiring perfect nonlinear registration. However, the misalignment in the direction parallel to the tract is not considered [13]."}, {"title": "2.3 Tensor reorientation", "content": "Spatial registration of orientation-encoded vector images, such as diffusion tensors and diffusion-weighted volumes, requires not only anatomical correspondence at the voxel level but also directional correspondence of underlying white matter structures. This necessitates additional reorientation operation for each voxel to ensure alignment of the directional information, which essentially serves to correct for the cumulative rotational effects caused by the series of transformations applied to the corresponding tensors. The key step in reorienting a tensor is, therefore, to accurately estimate the overall rotation occurring during the transformation of each voxel.\nIn the context of a linear transformation, consider a square n \u00d7 n invertible real matrix A that defines a linear (non-translational) transformation on Rn, mapping a column vector x to Ax. The polar decomposition of A expresses it as the product A = RP, where the factor R is an n \u00d7 n real orthogonal matrix, and the factor P represents a positive-definite matrix [47]. In this decomposition, R represents a rotation (or reflection) in Rn, while P represents a scaling along the n orthogonal axes. Thus, the polar decomposition can be interpreted as separating the linear transformation defined by A into two distinct components: a scaling of the space along orthogonal directions (P), followed by a rotation (R) in Rn.\nThe closest rotation matrix to A can be computed in several ways. One approach is to use Gram-Schmidt orthogonalization. Alternatively, the polar decomposition can be reformulated by computing $S = \\sqrt{A^T A}$ and then obtaining R as $R = AS^{-1}$. Another method involves minimizing the Frobenius norm, which measures the Euclidean distance between A and R, subject to the constraint det(R) = +1 [3]. Additionally, the rotation can be parameterized explicitly and incorporated within the objective function [48]. In practice, when P is positive-definite and R is orthogonal, the existence of the singular value decomposition (SVD) of A (i.e., $A = W E V^T$) is equivalent to the existence of polar decomposition. Consequently, R can be obtained directly from the SVD of A by setting $R = W V^T$ and $P = V E V^T$.\nFor a non-linear deformation \u03c6, if \u03c6 is differentiable at a location x in Rn, then its differential at that location is represented by the Jacobian matrix $J_\u03c6(x)$. The linear transformation given by $J_\u03c6(x)$ provides the best linear approximation of \u03c6 in the vicinity of x. The rotation component of \u03c6 at x, i.e., $R_x$, can then be extracted through the polar decomposition of the Jacobian matrix $J_\u03c6(x)$."}, {"title": "3 Methods", "content": "Given a group of n diffusion measure maps I = {$I_1$, ..., $I_n$}, each described by scalar or vector values I(x) at spatial coordinate x \u2208 Xi, i = 1...n, the spatial normalization procedure estimates a set of transformations t = {$T_1$, ..., $T_n$} that aligns the images I to a common reference space X, such that the anatomically corresponding structures are of the same coordinate, and the underlying diffusion tensors are of the same orientation, i.e., $I_i(T_i) \u2248 I_j(T_j)$, \u2200i \u2260 j.\nIn this study, we employed a set of high-quality spatiotemporal fetal brain DTI template between 23 and 36 weeks of gestation [49] as the common reference for spatial normalization. For each GA group per week, denoted as $I_{GA}$, we registered all individual images in $I_{GA}$ to the corresponding GA-specific DTI and FA template $A_{GA}$. Thereafter, it allows for various spatiotemporal imaging studies, including discovering both tract-specific and voxel-wise imaging difference across groups, and modeling the early trajectory of fetal brain development. To serve as an end-to-end learning-based alternative to classical registration algorithms, we performed hierarchical optimization scheme to estimate both an affine $\u03a6_A$ and a residual nonlinear deformation $\u03a6_D$, and performed the tensor reorientation during optimization.\nLastly, to minimize the smoothing effects that can result from multiple interpolation steps, we applied the composed deformation field $\u03a6 = \u03a6_A \u00b0 \u03a6_D$ directly to the original images in a single interpolation operation."}, {"title": "3.1 Affine registration", "content": "Affine transformation between the fetal brain and the age-matched template was estimated from the feature embedding of the concatenated FA and diffusion tensor images. To improve registration robustness against varying initial positions, we applied extensive yet practical data augmentation to the training samples for both individual and template images. For each augmented transformation, we uniformly sampled the following random parameters: an isotropic scaling factor s\u2208 [0.9,1.1], a rotation angle $\u03b8_x, \u03b8_y, \u03b8_z \u2208 [\u221220\u00b0, 20\u00b0]$ around the image center and along only one of the x, y, and z axes, and a translation vector $t_x, t_y, t_z \u2208 [\u22124,4]$ voxels for translation along the respective axes. To ensure consistent data formatting and tensor reorientation, we followed the same procedure employed for template construction [48] to warp the FA and diffusion tensor images using the synthesized affine matrices.\nThe transformation was obtained through a learning-inference process, where an affine matrix $\u03a6_A$ was estimated from a trainable model G, with the trainable parameters \u03a8 optimized to minimize the dissimilarity between the registered subject and template. Specifically, for any image $I_i$ in a given gestational age group, the affine matrix between the image and the corresponding template $A_{GA}$ was estimated as follows:\n$$\u00d2_A = G(A_{GA}, I_i),$$\nand the performance metric was computed to drive the update of \u03a8. We employed a multi-task objective function $L_{\u03cca}$ to assess regional structural dissimilarity $(L_{FA})$ of warped FA images using local normalized cross-correlation with a cubic kernel of size $9^3$ voxels, and a voxel-wise tensor dissimilarity $(L_{DTI})$. Normalized cross-correlation is a widely used metric for assessing structural alignment in medical images owing to its robustness against intensity variations [50]. For quantifying the distance between pairs of diffusion tensors, various metrics have been proposed in the literature [25,48]. In this work, we used a combined metric of the following form:\n$$L_{DTI} = \\frac{1}{\u03a9_\u0391} \\sum_{x\u2208 \u03a9_A} (E_D(A_{GA}, R(I_i; \u03c6_A) R^T) + DD(A_{GA}, R(I_i; \u03c6_A) R^T)),$$\nIn this equation, R is the overall rotation component decomposed (Section 2.3) from the estimated affine transformation $\u03c6_A$ and applied to the 3 \u00d7 3 diffusion tensor matrix (Section 3.3) at each voxel. We employed a combination of the Euclidean Distance (ED) of the full tensor and the Diagonal Frobenius Distance (DD) to optimize the alignment. This hybrid approach provides a comprehensive measure of diffusion dissimilarity on both the full tensor's geometric information and specifically the diffusion along the primary anatomical axes while keeping the method computationally efficient. The metrics were averaged over the reoriented tensors $D_{i,A}$ within the brain region of the template $\u03a9_A$:\n$$E_D(D_{A}, D_{i,A}) = ||Da \u2013 Di,a||_2,$$\n$$DD(DA, Di,A) =(DA:xx - Di,A:xx)^2 + (DA:yy \u2013 Di,A:yy)^2 + (DA:zz \u2013 Di,A:zz)^2.$$\nCombining the two similarity terms, $L_{FA}$ was defined as $\u03b1L_{FA} + L_{DTI}$, where \u03b1 was empirically optimized for better validation performance.\nThe affine registration model consisted of two domain-specific encoders to generate feature embeddings, a registration head that estimates an optimal affine transformation matrix between the embeddings, and a tensor reorientation layer designed to correct for rotational effects on the underlying diffusion tensor orientations. We implemented a parallel-encoder architecture with two identical feature encoders, each consisting of four convolutional layers followed by LeakyReLU activations [51] and max-pooling (down-sampling factor of 2) [52], along with four additional convolutional layers without down-sampling. Since fully convolutional networks are not inherently rotation- or translation-invariant, we used separate weights for the affine registration encoders to allow each to specialize in the moving and target domains, better handling the large positional variance before alignment. The features, shaped as 83 \u00d7 32 at the most abstract level for both the moving and target domains, were aggregated to estimate the twelve affine parameters by aligning the mass centers of the feature embeddings using a least-squares fit [53-55]. To ensure sufficient capacity for handling large global transformations, we applied recurrent inference during testing, running the model i times. Each subsequent inference used the warped output of the previous inference as input. In this unsupervised setting, where target images were available, we computed the mean squared error (MSE) of the registered FA and diffusion tensor images after each inference. The final result was chosen based on the inference that yielded the lowest MSE for both FA and DTI. Specifically, if the lowest MSE occurred at the ith inference, the final affine transformation was obtained by composing the accumulated transformations from all previous steps: $\u03a6_\u0391 = \u03a6_{\u03911}\u00b0 \u03a6_{\u03912} \u00b0 ... \u03a6_{\u0391i}$. This transformation was then applied to warp the original moving image."}, {"title": "3.2 Deformable registration", "content": "Deformable registration between the affine-aligned fetal brain and the corresponding template was estimated using the FA and diffusion tensor images. During model training, tract segmentation masks were optionally incorporated in the loss function when available. Unlike the affine registration stage, where both images were concatenated and input as a whole, in the deformable registration stage, we extracted coarse-to-fine feature embeddings separately from scalar FA images $(F_{i,FA}^1, ..., F_{i,FA}^k, j = 1...k)$ and vector-encoded diffusion tensor images $(F_{i,DTI}^1, ..., F_{i,DTI}^k, j = 1...k)$ using an FA Encoder and a Tensor Encoder with k hierarchical scales. The use of 'modality'-specific encoders allowed us to derive complementary features from each, which were then concatenated at each scale ($F^j, F^j, j = 1...k$) for recurrent dense deformation estimation through a registration decoder. The entire process can be formulated as:\n$$(\u03a6_D = H(F^j, F'^j).$$\nFor deformable registration, both the FA and Tensor encoders utilized a symmetric Siamese architecture with shared weights for the affine-aligned moving and template images. After affine registration, the relative positions and orientations of the images were well aligned, reducing the impact of the inherent lack of rotation and translation invariance in convolutional networks. Consequently, shared weights between the encoders can be employed at this stage, as the images contain similar spatial information, enabling more effective generalization and minimizing the risk of overfitting. Each encoder operated at four different scales (i.e., k = 4), with each scale composed of two convolutional layers followed by average pooling with a down-sampling factor of 2.\nFor the decoder, we adopted the classical multi-resolution scheme, where the deformation field estimated in a coarser level was up-sampled and linearly interpolated to provide an initial deformation in the next finer level [19,56]. To estimate the residual deformation at each resolution level, we used warped feature embeddings $(F_j061)$ instead of warping the original moving images. This approach was expected to preserve the sparse details in fetal brain diffusion images by minimizing further interpolation and smoothing. Additionally, it eliminated the need for tensor reorientation at each resolution and leveraged the high-dimensional features, which are potentially more discriminative for image registration. For each resolution level, to optimize structural similarity across fine-grained local regions and broader spatial neighborhoods between warped feature embeddings, we employed correlation-aware multi-window multi-layer perceptron (CMLP) blocks [57]. These blocks compute local correlations and capture multi-range dependencies. Specifically, each block leverages multiple receptive field sizes, using window sizes of {$3^3,5^3,7^3$}, to aggregate spatially varying contextual information, which is integrated into the deformation field estimation. This multi-scale strategy allows for precise local alignment while ensuring spatial coherence over a broader context, facilitating the registration of regions with complex diffusion orientations.\nWe optimized the trainable parameters using a multi-task objective function with the finest scale deformation, $\u03a6_D$. Similar to the affine stage, our objective function measured structural FA similarity $L_{FA}$ (with a kernel of size $5^3$ voxels) and voxel-wise tensor similarity $L_{DTI}$. Additionally, the objective function included spatial correspondence of white matter tracts $L_{tract}$ quantified with the multi-class average Dice coefficient between aligned tract masks within the brain region of the tract atlas $\u03a9_A$. Meanwhile, to penalize large deviations of deformation and preserve anatomical topology during transformations, a deformation smoothness term $L_{def}$ was included, which computes the average spatial gradients of the deformation field over all voxels,\n$$L_{def}(\u03a6_D) = \\frac{1}{|\u03a9|} \\sum_{x\u2208\u03a9}||\u2207\u03a6(x)||_2^2,$$\nCombining the terms, $L_{op}$ was defined as $\u03b1L_{FA} + L_{DTI} + \u03b3L_{tract} + \u03b3L_{def}$, where \u03bb and \u03b3 were empirically optimized to achieve better validation performance."}, {"title": "3.3 Tensor reorientation", "content": "Reorientation of the diffusion tensor was performed in order to ensure that the local orientation of diffusion tensors remains consistent with the anatomy after an image transformation. We implemented tensor reorientation as a general computation layer within the trainable models for both affine and deformable registration. Each estimated affine matrix, as well as the residual nonlinear deformation, can be considered as a dense deformation field that describes the new position x' of each point after transformation. The differential of this field, represented by the Jacobian matrix $J(x)$, varies across locations and captures the local linear transformations, including rotation, scaling, and shearing. To isolate the rotation component R, we applied SVD to the Jacobian matrix, separating it from the scaling component, as explained in Section 2.3:\n$$J(x) = \\frac{\u2202x'}{\u2202x'},$$\n$$SVD : J\u00a2(x) = W E V^T,$$\n$$R=WV^T.$$"}, {"title": "4 Experiments", "content": "To evaluate the proposed FetDTIAlign, we applied it to spatially normalize a fetal brain MRI dataset to a template spanning 23 to 36 weeks of gestation (Section 4.1). We assessed the quality of both affine and deformable registration (Section 4.3) and compared the results with state-of-the-art classical and learning-based algorithms (Section 4.4)."}, {"title": "4.1 Study population and data acquisition", "content": "In-utero fetal MRI scans analyzed in this study were acquired as part of a prospective research study at Boston Children's Hospital (BCH) in Boston, MA. All participants provided written informed consent, and the BCH Institutional Review Board (IRB) approved the study while following HIPAA guidelines. The inclusion criteria for the study were mothers between 18 and 45 years of age who had normal pregnancies with gestational ages between 22 and 37 weeks. Exclusion criteria included any contraindications to MRI, high-risk pregnancies, fetal central nervous system anomalies, and maternal comorbidities such as diabetes, hypertension, or substance abuse. Imaging data were acquired using 3T MRI scanners. For diffusion MRI scans, 2-8 echo-planar diffusion-weighted volumes were acquired along orthogonal planes relative to the fetal head. Each acquisition included b-values of 0 s/mm\u00b2 (1-2 volumes), and 500 s/mm\u00b2 (12-24 volumes), TR of 3000-4000 ms, TE of 60 ms, in-plane resolution of 2 mm, and slice thickness of 2-4 mm.\nThe DTI templates were computed at one-week intervals using data from fetuses with gestational ages within the range of [GA \u2013 1,GA + 1] weeks. We conducted quantitative evaluations on data from three gestational age groups\u2014GA25, GA30, and GA35\u2014representing different stages of brain development and different tissue contrast. These groups consisted of diffusion data from 7, 11, and 4 subjects, respectively. The data used in the validation phase remained unseen for the learning-based methods during model development phase. For the training of the learning-based methods, we expanded the range to include subjects with gestational ages within [GA - 2, GA+2] weeks for each group, increasing the variation in the image pairs used for registration. This resulted in a training set of 335 image-atlas pairs, and a clean test-set of 101 pairs. The subject-wise data split is shown in"}, {"title": "4.2 Image preprocessing and white matter tract segmentation", "content": "Diffusion MRI data from BCH were pre-processed using a previously validated pipeline [59]. This pipeline used a Kalman filtering-based algorithm to track the fetal head motion and performs slice-to-volume registration to align the q-space dMRI data in a standard atlas space. The reconstructed q-space volume had an isotropic voxel size of 1.2 mm.\nWhite matter tract segmentation masks for fetuses included in the BCH data were obtained in a prior work [60] using a well-validated anatomically constrained fetal tractography method [61]. In brief, after computing a whole-brain tractogram for each fetus, an automatic tool [62] was used to extract individual streamline bundles representing well-defined tracts. Experts with extensive knowledge of fetal neuroanatomy and neuroradiology verified the tract extractions. Subjects with inferior tract extraction results were excluded. In order to convert the streamline bundles to binary tract masks for use in this study, we computed for each tract a streamline density map and rejected voxels containing less than 5 percentile of streamlines for that tract. A total of 60 white matter tracts were extracted for each fetus, which were reduced to 34 tract labels after combining the bilateral tracts."}, {"title": "4.3 Evaluation metrics", "content": "The quality of affine and deformable registration was evaluated using multiple metrics: the Dice coefficient for the warped white matter tract segmentations, image-wise cross-correlation for the registered FA maps, average cosine similarity for the registered diffusion tensors, and the physical plausibility of the estimated deformation fields, measured as the percentage of voxels with a negative Jacobian determinant (NJD%) in the region where the displacement is non-zero. These metrics were computed both between the template and subjects, as well as between pairs of subjects, and were restricted to the brain region.\nNotably, the upper bound of the Dice is less than one. This is because, while the Dice is averaged across non-empty labels, some tract segmentations, particularly those with bilateral structures, may be incomplete in individual scans, with either the left or right structure missing. In contrast, the tract atlas always presents complete structures, resulting in a maximum Dice below one.\nImage-wise cross-correlation (CC) between two scalar images is computed as\n$$CC(I_1, I_2) = \\frac{\\sum_{x\u2208\u03a9}(I_1(x) \u2013 \\overline{I_1})(I_2(x) \u2013 \\overline{I_2})}{\\sqrt{ \\sum_{x\u2208\u03a9} (I_1(x) \u2013 \\overline{I_1})^2 \\sum_{x\u2208\u03a9}(I_2(x) \u2013 \\overline{I_2})^2}},$$\nwhere $I_1(x)$ and $I_2(x)$ represent the intensity values at position x in the 3D images, and $\u012a_1$ and $\u012a_2$ are the mean intensity values of $I_1$ and $I_2$ across all voxels in \u03a9, the space of the brain region.\nIn addition, we utilize the Tenengrad sharpness measure [68], which quantifies image sharpness as the sum of squared gradient magnitudes, to evaluate the clarity of the mean FA map obtained using all methods. A higher sharpness value indicates better alignment, where anatomical structures overlap well, resulting in a clearer mean image. In contrast, lower sharpness suggests residual misalignment, as inconsistencies between subjects cause anatomical details to blur and average out, reducing clarity."}, {"title": "4.4 Baseline methods", "content": "Several state-of-the-art algorithms for spatiotemporal analysis of diffusion tensor images were implemented in this study, including classical instance optimization-based methods FSL [8] and DTI-TK [48], and learning-based techniques SynthMorph [53] and VoxelMorph [69].\nFSL TBSS (version 6.0.7.11), typically used for adult brain imaging, was adapted for this study to accommodate fetal brain imaging by incorporating fetal brain templates. Including the default configuration, the following algorithms were implemented:\n1. The default configuration, which uses the FMRIB58_FA mean FA image in standard space as the target image for spatial normalization, and uses its standard skeleton for the projection of individual FA images (denoted as the -T option; see Section 2.2).\n2. The pipeline that finds the most \"typical\" subject in the group as the target image for spatial normalization (the -n option).\n3. The pipeline that allows to specify an FA image as the group-wise target image for spatial normalization (the -t option). For this, we utilized GA-specific fetal FA template from an existing fetal DTI template [70], which we will refer to as CRL template in this paper.\n4. Another variant of the -t option pipeline, where we used the age-matched template from a more recent fetal DTI template that was constructed using superior fetal diffusion MRI scans from the developing Human Connectome Project\n5. A custom pipeline developed by combining the capabilities of DTI-TK and TBSS\nBriefly, FSL's FLIRT and FNIRT were used to register each subject's FA image to the GA-specific FA template as used in (3). Subsequently, projection and skeletonization were performed in the template space using FSL TBSS. The key distinction between this custom pipeline and the aforementioned integrated TBSS pipelines (1) - (4) lies in the final space used for spatial analysis. Regardless of the target image chosen, the integrated pipelines automatically take both the target and normalized images into 1 \u00d71\u00d71 mm MNI152 space through registration to the FMRIB58_FA template, which is constructed using adult images. In contrast, the custom pipeline can maintain the analysis within the GA-specific template space, avoiding potential issues associated with registering fetal brain images to an adult brain template.\nDTI-TK (version 2.3.1). The DTI-TK algorithm approximates the underlying deformable transformation between diffusion tensor images through piece-wise affine registration [48]. It has demonstrated superior performance over the FA-based registration employed in the original TBSS pipeline, owing to its ability to generate a group-specific DTI template by performing group-wise registration directly on tensor images [13,17,40]. Using this approach, we computed weekly GA-specific diffusion tensor templates. These templates were essentially correspondent with the FA templates from the CRL atlas mentioned above, and served as the group-wise target for all methods compared in this study.\nVoxelMorph represents a deep learning-based approach for deformable brain MR image registration [69]. It has demonstrated improved registration accuracy by incorporating the spatial correspondence of anatomical segmentations as an auxiliary loss term. To fully leverage this design, we included the Dice coefficient for available white matter tract segmentations, in addition to the original FA similarity measured using normalized cross-correlation with a window size of 9, and a regularization term. Since VoxelMorph is designed specifically for deformable registration and requires affine-aligned input images, we employed SynthMorph [53] a state-of-the-art affine registration framework as the affine component for VoxelMorph."}, {"title": "4.5 Implementation details", "content": "We adopted the same hyperparameters that were optimized and reported in the literature for our implementation. The learning-based algorithms were trained on a workstation equipped with an NVIDIA RTX A6000 GPU (48 GB memory) and an AMD Ryzen Threadripper PRO 5965WX 24-core CPU. For FetDTIAlign, the loss function weight A was set to 10 for affine registration and 100 for deformable registration, with y set to"}]}