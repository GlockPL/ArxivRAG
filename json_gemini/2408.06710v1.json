{"title": "Variational Learning of Gaussian Process Latent Variable Models through Stochastic Gradient Annealed Importance Sampling", "authors": ["Jian Xu", "Shian Du", "Junmei Yang", "Qianli Ma", "Delu Zeng"], "abstract": "Gaussian Process Latent Variable Models (GPLVMs) have become increasingly popular for unsupervised tasks such as dimensionality reduction and missing data recovery due to their flexibility and non-linear nature. An importance-weighted version of the Bayesian GPLVMs has been proposed to obtain a tighter variational bound. However, this version of the approach is primarily limited to analyzing simple data structures, as the generation of an effective proposal distribution can become quite challenging in high-dimensional spaces or with complex data sets. In this work, we propose an Annealed Importance Sampling (AIS) approach to address these issues. By transforming the posterior into a sequence of intermediate distributions using annealing, we combine the strengths of Sequential Monte Carlo samplers and VI to explore a wider range of posterior distributions and gradually approach the target distribution. We further propose an efficient algorithm by reparameterizing all variables in the evidence lower bound (ELBO). Experimental results on both toy and image datasets demonstrate that our method outperforms state-of-the-art methods in terms of tighter variational bounds, higher log-likelihoods, and more robust convergence.", "sections": [{"title": "I. INTRODUCTION", "content": "Gaussian processes (GPs) [1] have become a popular method for function estimation due to their non-parametric nature, flexibility, and ability to incorporate prior knowledge of the function. Gaussian Process Latent Variable Models (GPLVMs), introduced by [2], have paved the way for GPs to be utilized for unsupervised learning tasks such as dimensionality reduction and structure discovery for high-dimensional data. It provides a probabilistic mapping from an unobserved latent space H to data-space X.\nThe work by [3] proposed a Bayesian version of GPLVMs and introduced a variational inference (VI) framework for training GPLVMs using sparse representations to reduce model complexity. This method utilizes an approximate surrogate estimator $g(X, H)$ to replace the true probability term $p(X)$, \u0456.\u0435. $E_{q(H)}[g(X, H)] \\approx p(X)$. VI typically defines an evidence lower bound (ELBO) as the loss function for the model in place of log $p(X)$. To describe the accuracy of this lower bound, we discuss a Taylor expansion of log $p(X)$,\n$E_{q(H)}[log \\, g(X, H)] \\approx log \\, p(X) - \\frac{1}{2K} var_{q(H)}[\\frac{g(X, H)}{p(X)}].$ (1)\nThe formula has been discussed in numerous works, including [4], [5], [6]. Therefore, as the variance of the estimator decreases, the ELBO becomes tighter. Based on this formula and the basic principles of the central limit theorem, importance-weighted (IW) VI [6] seeks to reduce the variance of the estimator by repeatedly sampling from the proposal distribution $q(H)$, i.e., $g(X, H) = \\frac{1}{K} \\sum_{k=1}^{K} \\frac{p(X,H_k)}{q(H_k)}$, where $H_k \\sim q(H_k)$. An importance-weighted version [7] of the Bayesian GPLVMs based on this has been proposed to obtain a tighter variational bound. While this method can obtain a tighter lower bound than the classical VI, it is a common problem that the relative variance of this importance-sampling based estimator tends to increase with the dimension of the latent variable. Moreover, the generation of an effective proposal distribution can become quite challenging in high-dimensional spaces or with complex data sets.\nThe problem of standard importance sampling techniques is that it can be challenging to construct a proposal distribution $q(H)$ that performs well in high-dimensional spaces. To address these limitations, we propose a novel approach for variational learning of GPLVMs by leveraging Stochastic Gradient Annealed Importance Sampling (SG-AIS). AIS is derived from early work by [8] and has been further developed by [9], [10]. This approach remains one of the 'gold standard' techniques to estimate the evidence unbiasedly because it explores a wider range of posterior distributions and gradually approach the target distribution [11], [12], [13], [14].\nSpecifically, our proposed approach leverages an annealing procedure to transform the posterior distribution into a sequence of intermediate distributions, which can be approximated by using a Langevin stochastic flow. This dynamic is a time-inhomogeneous unadjusted Langevin dynamic that is easy to sample and optimize. We also propose an efficient algorithm designed by reparameterizing all variables in the ELBO. Furthermore, we propose a stochastic variant of our algorithm that utilizes gradients estimated from a subset of the dataset, which improves the speed and scalability of the algorithm. Our experiments on both toy and image datasets show that our approach outperforms state-of-the-art methods in GPLVMs, demonstrating lower variational bounds, higher log-likelihoods, and more robust convergence.\nOverall, our contributions are as follows:\n\u2022 We propose a novel approach for variational learning of GPLVMs by leveraging Stochastic Gradient Annealed Importance Sampling (SG-AIS), which addresses the limitations of standard importance sampling techniques and allows for the estimation of the evidence unbiasedly, resulting in a tighter lower bound and a better variational approximation in complex data and high-dimensional space.\n\u2022 We propose an efficient algorithm designed by reparameterizing all variables to further improve the estimation of the variational lower bounds. We also leverage stochastic optimization to maximize optimization efficiency.\n\u2022 Our experiments on both toy and image datasets demonstrate that our approach outperforms state-of-the-art methods in GPLVMs, showing lower variational bounds, higher log-likelihoods, and more robust convergence."}, {"title": "II. BACKGROUND", "content": "A. GPLVM Variational Inference\nIn GPLVMs, we have a training set comprising of $N$ D-dimensional real valued observations $X = {X_n}_{n=1}^N \\in R^{N \\times D}$. These data are associated with $N$ Q-dimensional latent variables, $H = {h_n}_{n=1}^N \\in R^{N \\times Q}$ where $Q < D$ provides dimensionality reduction [3]. The forward mapping $H \\rightarrow X$ is described by multi-output GPs independently defined across dimensions $D$. The work by [3] proposed a Bayesian version of GPLVMs using sparse representations to reduce model complexity. The formula is described as,\n$p(H) = \\prod_{n=1}^{N} N (h_n; 0, I_Q)$\n$p(F | U, H) = \\prod_{d=1}^{D} N (f_d; \\mu_d, Q_{nn})$\n$p(X | F, H) = \\prod_{n=1}^{N} \\prod_{d=1}^{D} N (X_{n,d}; f_d (h_n), \\sigma^2)$ (2)\nwhere $Q_{nn} = K_{nn} - K_{nm}K_{mm}^{-1}K_{mn}, \\mu_d = K_{nm}K_{mm}^{-1}u_d$, $F = {f_d}_{d=1}^D, U = {u_d}_{d=1}^D$ is the inducing variable [15], $x_d$ is the d-th column of X, and $m$ is the number of inducing points. $K_{nn}$ is the covariance matrix corresponding to a user-chosen positive-definite kernel function $k_c(h, h')$ evaluated on latent points ${h_n}_{n=1}^N$ and parameterized by hyperparameters $\\theta$. The kernel hyperparameters are shared across all dimensions $D$. It is assumed that the prior over U and H factorizes into $p(u_d)$ and $p(h_n)$, where $p(u_d) = N(0, K_{mm})$ and $p(h_n) = N(0, I_Q)$. Since $h_n \\in R^Q$ is unobservable, we need to do joint inference over $f(\\cdot)$ and $h$. Under the typical mean-field assumption of a factorized approximate posterior $q(f_d)q(h_n)$. We denote $\\psi$ as all variational parameters and $\\gamma$ as all GP hyperparameters. Thus, we arrive at the classical Mean-Field (MF) ELBO:\nMF-ELBO($\\gamma, \\psi$) = $\\sum_{n=1}^{N} \\sum_{d=1}^{D} E_{q(f_d)q(h_n)} log p(x_{n,d} | f_d, h_n) dh_n df_d$\n$- \\sum_{n=1}^{N} KL (q (h_n) || p (h_n)) - \\sum_{d=1}^{D} KL (q(u_d)||p(u_d))$, (3)\nwhere we use the typical approximation to integrate out the inducing variable,\n$q(f_d) = \\int p(f_d|u_d)q (u_d) du_d$. (4)\nB. Importance-weighted Variational Inference\nA main contribution of [7] is to propose a variational scheme for LV-GP models based on importance-weighted VI [6] via amortizing the optimization of the local variational parameters. IWVI provides a way of lower-bounding the log marginal likelihood more tightly and with less estimation variance by Jensen's inequality at the expense of increased computational complexity. The IW-ELBO is obtained by replacing the expectation likelihood term in Vanilla VI with a sample average of K terms:\nIW-ELBO($\\gamma, \\psi$) = $\\sum_{n=1}^{N} \\sum_{d=1}^{D} B_{n,d} - \\sum_{d=1}^{D} KL (q(u_d)||p(u_d))$, (5)\nwhere $B_{n,d} = E_{f_d, h_n} log(\\frac{1}{K} \\sum_{k=1}^{K} \\frac{p(X_{n,d} | f_d, h_{n,k}) \\, p(h_{n,k})}{q(h_{n,k})})$. Although the IW objective outperforms classical VI in terms of accuracy, its effectiveness is contingent on the variability of the importance weights: $\\frac{p (x_{n,d} | f_d, h_{n,k}) \\, p(h_{n,k})}{q(h_{n,k})}$. When these weights vary widely, the estimate will effectively rely on only the few points with the largest weights. To ensure the effectiveness of importance sampling, the proposal distribution defined by $q (h_{n,k})$ must therefore be a fairly good approximation to $p (x_{n,d} | f_d, h_{n,k}) p (h_{n,k})$, so that the importance weights do not vary wildly. Related theoretical proofs can be seen in [6], [5].\nWhen $h_{n,k}$ is high-dimensional, or the likelihood $p (x_{n,d} | f_d, h_{n,k})$ is multi-modal, finding a good importance sampling distribution can be very difficult, limiting the applicability of the method. Unfortunately, original research by [7] only discusses the case when $h_n$ is a one-dimensional latent variable, and they acknowledge that reliable inference for more complex cases is not yet fully understood or documented. To circumvent this issue, we provide an alternative for GPLVMs using Annealed Importance Sampling (AIS) [9], [10], [16], which defines state-of-the-art estimators of the evidence and designs efficient proposal importance distributions. Specially, we propose a novel ELBO, relying on unadjusted Langevin dynamics, which is a simple implementation that combines the strengths of Sequential Monte Carlo samplers and variational inference as detailed in Section III."}, {"title": "III. VARIATIONAL AIS SCHEME IN GPLVMS", "content": "A. Variational Inference via AIS\nAnnealed Importance Sampling (AIS)[10], [11], [12] is a technique for obtaining an unbiased estimate of the evidence $p(X)$. To achieve this, AIS uses a sequence of K bridging densities ${q_k(H)}_{k=1}^K$ that connect a simple base distribution $q_0(H)$ to the posterior distribution $p(H|X)$. By gradually interpolating between these distributions, AIS allows for an efficient computation of the evidence. This method is particularly useful when the posterior is difficult to sample from directly, as it allows us to estimate the evidence without evaluating the full posterior distribution directly. We can express this as follows:\n$p(X) = \\int p(X, H)dH = E_{q_{fwd}(H_{0:K})} \\frac{p_{bwd}(H_{0:K})}{q_{fwd}(H_{0:K})}$, (6)\nwhere the variational distribution $q_{fwd}$ and the target distribution $q_{bwd}$ can be written as:\n$q_{fwd} (H_{0:K}) = q_0 (H_0) T_1 (H_1 | H_0) \\cdots T_K (H_K | H_{K-1})$\n$q_{bwd} (H_{0:K}) = p (X, H_K) T_K (H_{K-1} | H_K) \\cdots T_1 (H_0 | H_1)$. (7)\nHere, we assume $T_k$ is a forward MCMC kernel that leaves $q_k(H)$ invariant, which ensures that ${T_k}_{k=1}^K$ are valid transition probabilities, i.e., $\\int q_k(H_{k-1})T_k (H_k | H_{k-1}) dH_{k-1} = q_k (H_k)$. And $T_k$ is the \u201cbackward\u201d Markov kernel moving each sample $H_k$ into a sample $H_{k-1}$ starting from a virtual sample $H_K$. $q_{fwd}$ represents the chain of states generated by AIS, and $q_{bwd}$ is a fictitious reverse chain which begins with a sample from $p(X, H)$ and applies the transitions in reverse order. In practice, the bridging densities have to be chosen carefully for a low variance estimate of the evidence. A typically method is to use geometric averages of the initial and target distributions to construct the sequence, i.e., $q_k (H) \\propto q_0(H)^{1-\\beta_k}p(X, H)^{\\beta_k}$ for $0 = \\beta_0 < \\beta_1 < \\cdots < \\beta_K = 1$. AIS has been proven theoretically to be consistent as $K \\rightarrow \\infty$ [10] and achieves accurate estimate of log$p(X)$ empirically with the asymptotic bias decreasing at a 1/K rate [13], [14].\nWith this, we can derive the AIS bound,\n$log \\, p(X) \\geq E_{q_{fwd} (H_{0:K})} log \\frac{p_{bwd} (H_{0:K})}{q_{fwd} (H_{0:K})}$\n$= E_{q_{fwd}(H_{0:K})} [logp (X, H_K) - log \\, q_0 (H_0)$\n$- \\sum_{k=1}^{K} log \\frac{T_k (H_k | H_{k-1})}{T_k (H_{k-1} | H_k)}]$. (8)\nThis objective can be obtained by applying Jensen's inequality. For the LVGP model, we can naturally derive its AIS lower bound:\n$L_{AIS} (\\psi, \\gamma)$\n$= \\sum_{n=1}^{N} \\sum_{d=1}^{D} E_{q_{fwd}(H_{0:K})} log p (x_{n,d} | f_d, h_{n,K})$\n$+ \\sum_{n=1}^{N} E_{q_{fwd}(H_{0:K})} [log p (h_{n,k}) \u2013 log q_0 (h_{n,0})]$\n$- \\sum_{k=1}^{K} E_{q_{fwd}(H_{0:K})} log \\frac{T_k (H_k | H_{k-1})}{T_k (H_{k-1} | H_k)}$\n$- \\sum_{d=1}^{D} KL (q(u_d) || p(u_d))$ (9)\nwhere $\\psi$ and $\\gamma$ indicate the sets of all variational parameters and all GP hyperparameters, respectively. Our purpose is to evaluate this bound. First we note that the last KL term is tractable if we assume the variational posteriors of $u_d$ are mean-field Gaussian distributions. So we concentrate on the terms in the expectation that we can evaluate relying on a Monte Carlo estimate. It is obvious that log $p (x_{n,d} | f_d, h_{n,K})$ is available in closed form as the conditional likelihood is Gaussian [15]. Therefore, the first three term can be computed by the popular \u201creparameterization trick\u201d [17], [18] to obtain an unbiased estimate of the expectation over $q_{fwd} (H_{0:K})$ and $q (f_d)$ (detailed in Section III-C). Afterwards, to evaluate expectation over $q_{fwd}$, we construct an MCMC transition operator $T_k$ which leaves $q_k$ invariant via a time-inhomogeneous unadjusted (overdamped) Langevin algorithm (ULA) as used in [19], [20], [21], [22] and jointly optimize $\\psi$ and $\\gamma$ by stochastic gradient descent.\nB. Time-inhomogeneous Unadjusted Langevin Diffusion\n$T_k$ can be constructed using a Markov kernel with an invariant density such as MH or HMC, which enables $q_{fwd}$ to converge to the posterior distribution of H. For the sake of simplicity, we consider the transition density $T_k$ associated to this discretization,\n$T_k (H_k|H_{k-1}) = N (H_k; H_{k-1} + \\eta \u2207 log q_k (H_{k-1}), 2\\eta I)$ (10)\nwhere $\\eta > 0$ is the step size and $q_k$ is bridging densities defined in Section III-A. Since we have $q_k (H) \\propto q_0(H)^{1-\\beta_k}p(X, H)^{\\beta_k}$ in Section III-A, the annealed potential energy is derived as:\n\u2207 log $q_k (\\cdot) = \\beta_k \u2207 log p(X, \\cdot) + (1 - \\beta_k) \u2207 log q_0(\\cdot)$. (11)\nAccording to conditional probability formula log $p(X) = log p (X) + log p (\\cdot)$, the model log likelihood simplifies to:\n\u2207log $p(X) = \\sum_{d=1}^{D} (\u2207log det (Q_{nn} + \\sigma^2I)$\n$+ (x_d - \\mu_d)^T (Q_{nn} + \\sigma^2I)^{-1} (x_d - \\mu_d))$. (12)\nSince Eq. (12) is analytical, the gradient can be computed through automatic differentiation [23]. The dynamical system propagates from a base variational distribution $q_0$ to a final distribution $Q_K$ which approximates the posterior density. Let $\\eta := \\frac{T}{K}$, then the proposal $q_{fwd}$ converges to the path measure of the following Langevin diffusion $(H_t)_{t \\in [0,T]}$ defined by the stochastic differential equation (SDE),\n$dH_t = \u2207 log q_t (H)dt + \\sqrt{2} dB_t, \\, \\, \\, H_0 \\sim q_0$ (13)\nwhere $(B_t)_{t \\in [0,T]}$ is standard multivariate Brownian motion and $q_t$ corresponds to $q_k$ in discrete-time for $t = t_k = k\\eta$. For long times, the solution of the Fokker-Planck equations [24] tends to the stationary distribution $q_{\\infty}(H) \\propto exp(p(X, H))$. Additional quantitative results measuring the law of $h_t$ for such annealed diffusions have been showed in [25], [26], [27]. For ease of sampling, we define the corresponding Euler-Maruyama discretization as,\n$H_k = H_{k-1} + \\eta\u2207 log q_k (H_{k-1}) + \\sqrt{2\\eta} \\epsilon_{k-1}$, (14)\nwhere $\\epsilon_k \\sim N(0, I)$, as done in [20], [21], [28]. Since such process is reversible w.r.t. $q_k$, based on [28], the reversal $T_k$ is typically realized by,\n$H_{k-1} = H_k + \\eta\u2207 log q_k (H_k) + \\sqrt{2\\eta} \\tilde{\\epsilon}_{k-1}$, (15)\nwhere $\\tilde{\\epsilon}_{k-1} = -\\frac{1}{\\sqrt{2\\eta}} [\u2207log q_k (H_{k-1}) + \u2207 log q_k (H_k)] - \\epsilon_{k-1}$. Based on Eq. (10), the term related to $T_k$ in Eq. (9) can be written explicitly as:\n$\\sum_{k=1}^{K} R_{k-1} = \\sum_{k=1}^{K} log \\frac{T_k (H_k | H_{k-1})}{T_k (H_{k-1} | H_k)}$\n$= \\sum_{k=1}^{K} \\frac{1}{2} (||\\tilde{\\epsilon}_{k-1}||^2 - ||\\epsilon_{k-1}||^2)$. (16)\nWe abbreviate this probability ratio as $R_{k-1}$. Additional proofs can be seen in Appendix A.\nC. Reparameterization Trick and Stochastic Gradient Descent\nFor ease of sampling, we consider a reparameterization version of Eq. (9) based on the Langevin mappings associated with $q_k$ given by\n$T_k(H_{k-1}) = H_{k-1} + \\eta \u2207 log q_k (H_{k-1}) + \\sqrt{2\\eta} \\epsilon_{k-1}$. (17)\nBased on the identity $H_k = T_k(H_{k-1})$, we have a representation of $H_k$ by a stochastic flow,\n$H_k = T_k (H_{k-1}) = T_k \\circ T_{k-1} \\circ \\cdots T_1 (H_0)$ (18)\nMoreover, for LVGP models, we also have a reparameterization version [29] of the posteriors of $H_0$ and $f_d$ in Eq. (9), that is,\n$h_{n,0} = a_n + L_n \\epsilon$\n$f_d = K_{nm}K_{mm}^{-1} (K_{mm} - S_d^T S_d)^{-1}K_{mm}K_{mn} \\epsilon_{f_d}$ (19)\nwhere vectors $a_n \\in R^Q$, $m_d \\in R^N$ and upper triangular matrixs $L_n$, $S_d$ are the variational parameters, $\\epsilon \\in R$, $\\epsilon_{f_d} \\in R^N$ are standard Gaussian distribution. After this reparameterization, a change of variable shows that AIS bound in Eq. (9) can be rewritten as:\n$L_{AIS}(\\psi, \\gamma)$\n$= \\sum_{n=1}^{N} \\sum_{d=1}^{D} E_{\\rho(\\epsilon_{f_d})p(\\epsilon_{0:K-1})p(\\epsilon)}} [logp (X_{n,d} | f_d, \\epsilon_{0:K-1}, \\epsilon)]$\n$+ \\sum_{n=1}^{N} E_{\\rho(\\epsilon_{0:K-1})p(\\epsilon)}} [log p (h_{n, K}) \u2013 log q_0 (h_{n,0})]$\n$+ \\sum_{k=1}^{K} E_{\\rho(\\epsilon_{0:K-1})p(\\epsilon)}} R_{k-1} - \\sum_{d=1}^{D} KL (q(u_d) || p(u_d))$, (20)\nwhere $R_{k-1}$ is defined in Eq. (16) and $h_{n,k}$ is reparameterized as $h_{n,k} = T_k \\circ T_{k-1} \\circ \\cdots T_1 (h_{n,0}) = \\sum_{i=1}^{k}T_i(a_n + L_n \\epsilon)$.\nIn order to accelerate training and sampling in our inference scheme, we propose a scalable variational bounds that are tractable in the large data regime based on stochastic variational inference [30], [29], [18], [31], [32] and stochastic gradient descent [19], [33], [34], [35], [36], [37] as described in Algorithm 1.\nInstead of computing the gradient of the full log likelihood, we suggest to use a stochastic variant to subsampling datasets into a mini-batch $D_J$ with $|X_J| = B$, where $J \\subset {1, 2, .., N}$ is the indice of any mini-batch. In the meantime, we replace the $p (X,H_K)$ term in Eq. (7) with another estimator computed using an independent mini-batch of indices $I \\subset {1, 2, .., N}$ with $|X_I | = B$, i.e.\nB. Dimensionality Reduction\nThe multi-phase Oilflow data [38] consists of 1000, 12d data points belonging to three classes which correspond to the different phases of oil flow in a pipeline. We reduced the data dimensions to 10 while attempting to preserve as much information as possible. We report the reconstruction error and MSE with \u00b1 2 standard errors over ten optimization runs. Since the training is unsupervised, the inherent ground-truth labels were not a part of training. The 2d projections of the latent space for oilflow data clearly shows that our model is able to discover the class structure.\nC. Make Predictions in Unseen Data\nWe conducted a reconstruction experiment on the MNIST and Frey Faces Data, focusing on how models capture uncertainty when training with missing data in structured inputs. For MNIST, we selected digits 1 and 7 with a latent variable dimensionality of 5. Each image has 784 pixels yielding a 784d data space\u00b9."}, {"title": "IV. EXPERIMENTS", "content": "A. Methods and Practical Guidelines\nIn the following section", "approaches": "a) Classical Sparse VI based on mean-field (MF) approximation [3", "7": "c) ULA-AIS as given by the algorithm presented in this paper. We also provide guidelines on how to tune the step sizes and annealing schedules in Algorithm 1 to optimize performance. We conducted all our experiments on a Tesla A100 GPU.\nVlog $p(X_I) \\sim \\frac{N"}, {"42": ".", "GPLVMs\nInput": "training data X", "H_k)": "", "epsilon_{0": "K-1"}, "epsilon) - \\sum_{d=1}^{D} KL (q(u_d) || p(u_d))$\nDo gradient desent on $L(\\psi, \\gamma)$\nuntil $\\psi, \\gamma$ converge\nFurthermore, in [43"], "mind": "n\u2022 Computational Efficiency: The annealing schedule should be carefully designed to balance the computational resources required for estimating the evidence. Too many bridging densities can lead to excessive computational burden", "Exploitation": "The annealing schedule should strike a balance between exploration and exploitation of the posterior distribution. An aggressive schedule that moves quickly from the base distribution to the posterior may lead to exploration limitations", "Transition": "The annealing schedule should ensure a smooth transition between bridging densities. Abrupt changes in the densities can result in high-variance importance weights, which may lead to inaccurate estimates. Smooth transitions can be achieved by gradually adjusting the temperature or using appropriate interpolation functions.\nWe often use a linear schedule, where the temperature values are fixed and regularly spaced between 0 and 1. However, this approach may not always work well in practice, as the search space is complex and high-dimensional.\nAlternatively, we can try to learn the temperature values $\\beta_k$ directly as additional inference parameters. In our experiments, we observed that the time complexity of Importance-weighted (IW) VI and SG-AIS almost linearly increases with"}