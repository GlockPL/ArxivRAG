{"title": "eDOC: Explainable Decoding Out-of-domain Cell Types with Evidential Learning", "authors": ["Chaochen Wu", "Meiyun Zuo", "Lei Xie"], "abstract": "Single-cell RNA-seq (scRNA-seq) technology is a powerful tool for unraveling the complexity of biological systems. One of essential and fundamental tasks in scRNA-seq data analysis is Cell Type Annotation (CTA). In spite of tremendous efforts in developing machine learning methods for this problem, several challenges remains. They include identifying Out-of-Domain (OOD) cell types, quantifying the uncertainty of unseen cell type annotations, and determining interpretable cell type-specific gene drivers for an OOD case. OOD cell types are often associated with therapeutic responses and disease origins, making them critical for precision medicine and early disease diagnosis. Additionally, scRNA-seq data contains tens thousands of gene expressions. Pinpointing gene drivers underlying CTA can provide deep insight into gene regulatory mechanisms and serve as disease biomarkers. In this study, we develop a new method, eDOC, to address aforementioned chal- lenges. eDOC leverages a transformer architecture with evidential learning to annotate In-Domain (IND) and OOD cell types as well as to highlight genes that contribute both IND cells and OOD cells in a single cell resolution. Rigorous experiments demonstrate that eDOC significantly improves the efficiency and effectiveness of OOD cell type and gene driver identification compared to other state-of-the-art methods. Our findings suggest that eDOC may provide new insights into single-cell biology.", "sections": [{"title": "1 Introduction", "content": "Advances in single-cell RNA sequencing (scRNA-seq) have facilitated elucidating biological complexity of tissues and organisms. The scRNA-seq provides deep insights into cell-level heterogenities underlying various diseases, like cancer, Alzheimer's disease, and autoimmune disease. One of critical tasks in scRNA- seq data analysis is to annotate cell types at a single cell resolution. Tremendous efforts in machine learning have been devoted to addressing this problem. However, several challenges remain. First, in a real-world application, some cells may not belong to any known (labeled) cell types, and are called unknown or unidentified cells. Reliable recognition of these unknown cells may facilitate discovering novel biological processes [20], and severing as biomarkers for precision medicine and disease diagnosis [15]. Second, it is important to quantify the reliability or uncertainty of the cell type annotation for risk-sensitive medical applications. Finally, to understand how the novel cell type rise, and explain the prediction, it is needed to interpret the new cell type by highlighting marker genes. Therefore, developing methods that can reliably distinguish known and unknown cells while determining interpretable gene drivers of cell types will harness single cell techniques for advancing basic biology and translational medicine.\nIn this studies, we treat the unknown cell type detection as an out-of-domain (OOD) sample detection task similar to OOD detection for languages [5] or images [16]. Although various types of OOD detection methods exist, quantifying the uncertainty of cell type annotation for a new cell and finding which features make a sample different from known cell types as an OOD case remain challenging. For In-Domain samples, interpretability techniques, like SHAP, can assess feature importance of a case given a trained model. However, these methods are not designed for unseen OOD samples that are significantly different from training dataset. For example, in a training set with K classification labels for all sentences, and we can use current interpretability methods to show which words contribute to K label classifications. However, when we meet the sentence belongs to an unknown label (OOD case) in the test set, we cannot tell which words contribute it be a OOD sample. For the unknown cell type annotation, task are summarized as: recognize if a cell is a unknown cell type, and identify which genes characterize a cell to be a new cell type. The left part of Fig. 1 illustrates the task for scRNA-seq data analysis.\nCurrently, transformer-based models are successful in not only various language tasks but also analyz- ing scRNA-seq data[31,8,4]. It is important to note a key difference between language and gene expression data: word order is crucial for text processing [28] and benefits self-supervised pre-training, but there is no inherent order for genes in scRNA-seq data. Therefore, we leverage this characteristic by employing the attention mask mechanism of Transformer [27] to test the effects of individual genes being present or absent. This approach allows us to efficiently explain cell types based on gene expressions.\nBased on above rationale, we introduce a new scRNA-seq analysis method called explainable Decoder for Out-of-domian Cell (eDOC). We use the Transformer architecture as a backbone to encode a single cell RNA expression data; instead using the [CLS] token for cell-type annotations, we train and inference cell types as a decoder only language model and output cell types for all token positions. We adopt evidential learning to train our model, which enables us to observe how individual genes contribute to both IND cell types and the OOD cell type with uncertainty change. In practice, our method does not require researchers to definitively identify all cell types with existing samples. They can use eDOC to classify uncertain or rare cells as OOD samples and decipher gene drivers associated with the new cell type. Advantages of our model are summarized as below:\n\u2013 Our method have a superior performance for OOD cell types detection without supervised training with OOD samples. Additionally, it can also accurately annotate known cell types.\n\u2013 To our best knowledge, our method can interpret OOD cell types with marker genes in a single-cell resolution for the first time, and it can also interpret IND cell types.\n\u2013 Our method is fast, simple and easy-to-use, and it only need transcriptomics data for training and inference without the requirement of additional knowledge or pre-training."}, {"title": "2 Related Work", "content": ""}, {"title": "2.1 Cell Type Annotation for scRNA-seq", "content": "There are primarily three categories of methods for the cell type annotation. The first type uses marker genes to specify cell types. For example, CD4 is one of the marker genes for T lymphocytes (T cells). This method relies on researchers' prior knowledge and databases, which is laborious and prone to error and bias [12]. The second type is the cluster-then-annotate approach, which is the most popular one. This method uses similarities of cells' gene expression profiles and assigns type labels to all cells within each cluster using genes' averaged expression levels. However, this approach is limited by low-coverage sequencing data from experiments [11]. The third type is supervised classification, and some of them are based on deep learning. scBERT[31] uses bidirectional encoder that is pre-trained by large-scale scRNA- seq data to classify cell types. scGPT [4] use the decoder architecture like GPT to pre-train model and annotate cell types using the gene expression of a cell. Several transformer-based methods highlight their interpretability with the attention score [31,3], but whether attention scores can be used for interpretation [13,29] is controversial. Genes that are important by rarely expressed may be masked by other genes and have low attention scores."}, {"title": "2.2 Out-of-domain Detection", "content": "Various strategies for OOD detection contribute to machine learning model deployment in the real world. Maximum softmax probabilities(MSP) [10] is a baseline that uses MSP score to distinguish between IND and OOD samples; LMCL [17] apply margin loss to learn discriminative deep features. Supervised Contrastive Learning (SCL) [33] tried to pull different samples with the same label together, and it addi- tionally improved K-Nearest Neighbors (KNN) based [36,24] and Mahalanobis distance-based [22] OOD detection. Besides the above methods, Uncertainty learning is a promising solution to OOD detection [2,26]. Some cell type annotation methods mentioned their ability in unknown cell detection [31,3,14], and their methods set a cut-off for the probability score of the output layer, which is similar to MSP."}, {"title": "3 Method", "content": ""}, {"title": "3.1 Problem Definition", "content": "We first consider the IND cell type annotation as a supervised multi-class classification task; the input and output are defined as $x_i$ and $y_i \\in \\{1,2,... K\\}$, respectively. Here, $x_i$ is a vector of the expression"}, {"title": "3.2 Gene Embedding", "content": "Similar to word sentences, we use the embedding layer to embed \u00d1 genes to $\\{g_n\\}_{n=1}^N$ and use fully- connected to encoding gene expression to $\\{h_n\\}_{n=1}^N$. We append the SLS token behind the last position of a gene sequence as the (N+1)th element, which is the compacted representation of N genes and their expression.\n$g_{SLS} = FC(H_{OneHot}), H_{One Hot} \\in R^{1\\times N}$\n$h_{SLS} = FC(H^N), H^N \\in R^{1\\times N}$\n$H^N$ is one cell's gene expression data that is directly collected from the N \u00d7 M matrix, and $H_{OneHot}$ is the One-Hot version of $H^N$, that represents whether a gene appear (value 1) in \u00d1 or not (value 0). We concatenate $g_n$ and $h_n$ to generate fused embedding $G_{N+1} \\in R^{(N+1)\\times d_g}$, and $d_g$ is the dimension of gene embeddings:\n$G_{N+1} = FC([{g_n}_{n=1}^N\\{h_n\\}_{n=1}^N])$"}, {"title": "3.3 Transformer Decoder", "content": "We used the decoder-only structure from Transformer [27] to encode gene and expression embedding:\n$\\Theta = Transformer(G_{N+1})$\nThen, a fully connected layer is applied to the Transformer output (\u0398) to produce E as the model output.\n$E = FC(\\Theta), E \\in R^{K\\times(N+1)}$\nBecause of the presence of the attention mask, the decoder model is constructed by N + 1 cell type annotators:\n$Y_n = CTA^n(g_1\\cdot H_1,\\cdots, g_n. H_n)$ \nIn the nth position, the model can only use the first n genes in the input sequence for estimating cell types, so eDOC is constructed by a strong cell type annotator in \u00d1 +1 position and \u00d1 \u201cweak\" annotators from 1 to N positions.\""}, {"title": "3.4 Model Training and Evidential Learning for Uncertainty Score", "content": "We employ the evidential deep learning (EDL) [23] to train the model and compute the uncertainty score for each output from the decoder. For the nth decoder output $E_n = [e_1,\\cdots, e_K]$, we got Dirichlet strength $S_n$ by:\n$S_n = \\sum_{k=1}^K (e_k + 1)$\nThe uncertainty score can be computed by:\n$U_n + \\sum_{k=1}^K \\frac{e_k}{S_n} = 1, U_n = \\frac{K}{S_n}$"}, {"title": "3.5 Cell Type Output and Interpretation", "content": "The last decoder output $E_{N+1}$ is applied for producing IND labels, because in this position model can use maximum gene information and their expression to make the best decision. The $u_{N+1}$ can be used to label OOD sample:\n$\\begin{cases} IND & u_{N+1} \\leq \\lambda \\\\ OOD & u_{N+1} > \\lambda\\end{cases}$\nWhere X is a threshold parameter. We use $u_n$ to interpret nth gene effect on IND and OOD cell by $u_{diff}$.\n$\\begin{cases}u_n^{IND} = u_{n-1} - u_n, & IND\\\\ u_n^{OOD} = u_n - u_{n-1}, & OOD\\end{cases}$\nThis metric is straightforward: if the nth gene has a high $u_n^{IND}$ and $u_{n-1} - u_n > 0$, this gene is important for IND cell types; if the nth gene have a high $u_n^{OOD}$ and $u_{n-1} - u_n < 0$, the appearance of this gene causes the confuse of cell type annotations, so it is important for OOD."}, {"title": "3.6 Order Shuffling for Robust Interpretation", "content": "eDOC can produce the cell type annotation and \u00d1-1 gene interpretation with a single run. Although the absence of order in gene set helps the model show genes effects in a single run, some driver genes, which are assigned front positions, have a strong effect that hides other genes' contribution (details see experiments). To ensure our method can observe gene effects in different positions, we can change the order of the input sequence. The simplest way is to randomly shuffle the order of the gene input sequence and run the model multiple times. Users can also manually move genes they are interested in the front of other genes that are known to be unimportant. In the training phase, we randomly select a maximum of N genes as the input sequence, changing the selection of genes and their order for different epochs."}, {"title": "3.7 Time Complexity and Deployment", "content": "Many scRNA-seq datasets only allow restricted access from authorized people, so researchers have to use limited computational resources to train models and perform analysis. eDOC use limited length (N + 1) of the sequence as the model input, which decrease the computation cost:\n$N+1 < N$\nBy running eDOC that costs T time, eDOC can produce results of IND cell type annotations, OOD detections, and the interpretation of N-1 genes at the same time. If we want to perform robust interpre- tation that quantifies how genes contribute to cell types comprehensively, the time complexity of eDOC is linear."}, {"title": "4 Experiments", "content": ""}, {"title": "4.1 Datasets and Experiment Settings", "content": "For the OOD detection of cells, we take Zheng68K for peripheral blood mononuclear cells (PBMC) [35] as the benchmark. It includes 11 PBMC cell types. We exclude three cell types: CD4+ T Helper2, CD34+, and CD4+/CD45RA+ /CD25- Naive T as OOD cells from the original dataset. We split eight types of IND cells into three portions for training, validation, and testing. By merging different numbers of testing IND cells with OOD cells, we obtain three test datasets with 25%, 50%, and 75% percentages of IND cells to evaluate the OOD detection. In the IND annotation setting, we take all cell types from Zheng68K and Segerstolpe [21] for training and testing. We use the F1 score as the metric for OOD detection as previous studies [33,36]. For testing IND cell type annotations, we use macro-averaged F1 and precision as metrics.\nThe N we used for IND and OOD experiments are 512, and selected N and their order change with training epochs. The Transformer backbone is constructed by 4 decoder layers with multi-head attention (8 heads). The threshold for OOD (\u03bb) is set to 0.1. The dropout rate we use is 0.5. We use a single RTX 3090Ti or L40S GPU to train eDOC."}, {"title": "4.2 OOD Cell Detection", "content": "We compare eDOC with state-of-the-art OOD detection methods: MSP [10], LMCL [17], supervised con- trasting learning (SCL) with Local Outlier Factor (LOF) and Gaussian Discriminant Analysis (GDA) [33], KNN with SCL (KNN+) [24], a Transformer-based cell type annotation method scRNA-seq (TOSICA) [3], scBERT, a meta-learning approach (MARS) [1], and an approach that use uncertainty quantifica- tion (scPoli) [6]. We show results in Table 1 The comparison result for the OOD detection proves the"}, {"title": "4.3 IND Cell Type Annotation", "content": "We also compared our method with SOTA IND cell type annotation methods: ACTINN [19], Scanpy [30], scVI [18], singleCellNet [25], xTrimoGene [8], scBERT [31], CellTypist [7]. The result is present in Table 2."}, {"title": "4.4 How does eDOC Explain and Label", "content": "Our method provides an intuitive insight into how gene expression contributes to cell type annotations. By removing masks of attention, the decoder can use more genes to decide cell types. For IND cells, more genes make the model more \u201cconfident\" in its cell types. Conversely, some genes make the model feel \"confused\" for OOD cells. When we use $u_n$ to describe this difference, we can observe $U_n - U_{n-1} < 0$ or $U_n - U_{n-1} > 0$ if the nth gene makes model more \u201cconfident\" or more \"confused\", respectively. We use the last position N + 1 as the cell representation because, in this position, the model can view all gene expressions, making it the most informative cell type annotator. We use eDOC to produce $u_n$ for each token position to compare OOD cells and IND cells in Fig. 2."}, {"title": "4.5 Robust Interpretation with Single Cell Cases", "content": "eDOC allows us to investigate how different genes contribute to IND cell type annotation and OOD cell detection robustly by simply changing the input order of genes. Because cell types are decided by multiple genes, and some genes may hide other genes' effects. eDOC can improve the gene interpretability for cell type annotation by placing genes in early n positions, and genes located in late positions (like n + 1 and n+2) make no contributions to cell type annotations in the nth position because the attention mask blocks the effect of genes in the late position. This allows us to reveal how genes affect cell types without being affected by non-marker genes. Many deep learning-based methods use attention weights for models' interpretability. Here, we compare the explanation from eDOC with that by attention weights. For IND cell type annotation, we select three cell types, and each cell type has five expressed important marker genes for this cell type, which are supported by literature. Fig. 4 shows that difference between eDOC and attention weights.\nFrom heatmaps, attention weights only focus on a portion of gene sets but miss a number of important genes. It may be caused by some genes with high attention weights hiding other genes' contributions."}, {"title": "5 Conclusion", "content": "In this paper, we introduce eDOC, a new method that can robustly detect novel cell types and identify marker genes simultaneously. eDOC not only outperforms state-of-the-art methods in cell type annota- tions but also for the first time can highlight important genes in an OOD setting. eDOC will facilitate biomedical researchers gaining new insights into disease mechanisms from expensive but invaluable se- quencing projects. Our work shows that progress in NLP and deep learning can benefit biomedical research. New AI methods have potential to address OOD challenges and improve the interpretability of biomedical data analysis.\neDOC provides a new strategy for analyzing scRNA-seq data by treating uncertain cells as out-of- distribution (OOD). This allows us to apply eDOC to explore novel and rarely appearing cell types and characterize them with marker genes. In the future, we will conduct experiments to examine how the marker genes discovered by eDOC contribute to cell phenotypes and the roles of identified cells and genes in diseases and treatments."}]}