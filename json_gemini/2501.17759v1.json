{"title": "Yin-Yang: Developing Motifs With Long-Term Structure And Controllability", "authors": ["Keshav Bhandari", "Geraint A. Wiggins", "Simon Colton"], "abstract": "Transformer models have made great strides in generating symbolically represented music with local coherence. However, controlling the development of motifs in a structured way with global form remains an open research area. One of the reasons for this challenge is due to the note-by-note autoregressive generation of such models, which lack the ability to correct themselves after deviations from the motif. In addition, their structural performance on datasets with shorter durations has not been studied in the literature. In this study, we propose Yin-Yang, a framework consisting of a phrase generator, phrase refiner, and phrase selector models for the development of motifs into melodies with long-term structure and controllability. The phrase refiner is trained on a novel corruption-refinement strategy which allows it to produce melodic and rhythmic variations of an original motif at generation time, thereby rectifying deviations of the phrase generator. We also introduce a new objective evaluation metric for quantifying how smoothly the motif manifests itself within the piece. Evaluation results show that our model achieves better performance compared to state-of-the-art transformer models while having the advantage of being controllable and making the generated musical structure semi-interpretable, paving the way for musical analysis. Our code and demo page can be found at https://github.com/keshavbhandari/yinyang.", "sections": [{"title": "Introduction", "content": "When developing a short musical motif into a complete monophonic piece, composers can repeat the previous context, vary it slightly, or create something novel departing from the original motif. While composing, it is important to consider local coherence by ensuring that the next notes logically follow the previous ones, in addition to incorporating motivic variations throughout, for an overarching structure. Additionally, one may aim to produce new sections to establish global form. This is common practice in western European musical composition where people employ techniques like fragmentation, sequencing, retrograde, inversion, etc. to develop the musical idea [21]. However, blindly applying these rules without considering the preceding context could be musically nonsensical. Conversely, straying too far from the original motif can lead to a lack of cohesion and unity. Finally, in some genres, repeating themes too much can be perceived as monotonous by listeners, making it undesirable [4].\nComputationally replicating the compositional process of developing a motif into a structured piece has been researched for decades, but remains an open challenge today [3, 13]. Unlike storytelling with clear plot structures, the \u201clanguage\" of musical structure is more abstract and heavily relies on repeating ideas, varying them slightly, and expanding on them. This makes explicitly modelling and representing musical structure challenging.\nSome studies consider the musical structure to be implicitly learnt during the training process. Approaches such as those in [2, 11, 22, 34] include various enhancements to the model architecture. Data-based enhancements, where additional structural data annotations are provided to improve the model's explicit generalizability of structure, are also explored. For example, the Lookback RNN [26] encodes repeating patterns from 1 or 2 bars ago in the input to allow the RNN model to better identify repeating events in the generated melody. Similarly, the R-Transformer [10] is trained on a dataset of 5 types of motif repetitions with a multiple loss objective. On the other hand, representation-based enhancements build on the idea that compact sequences would allow the model to see the complete musical work during training, enabling it to learn longer structural dependencies over the entire piece's duration [9,12]. Increasing the model's context window to fit much larger sequences is yet another way to expose the complete piece to the model [6,33]. Although these models show improvement over the baselines, they lack flexibility and control as their structure is automatically learnt.\nAnother class of models draws inspiration from the hierarchical nature of musical elements such as notes, chords, bars, phrases, and sections [8,28,35,36]. These models use this inherent hierarchy by employing specialized networks operating at various scales to generate music. However, the window sizes across the hierarchical tiers of the neural network are fixed during training and may not match the varying hierarchy in music structure across pieces and genres.\nPre-training methods have also been explored recently with models such as MelodyGLM [32], which introduces a multi-task pre-training framework tailored for melodies and a fine-tuning application for melody continuation and infilling tasks. Similarly, MuPT [19] explores the application of large language models to the pre-training of melodies encoded with a novel multi-track ABC notation. Recently, MelodyT5 [30] uses the T5 transformer architecture [20] for pre-training with multiple objectives on a large and diverse corpus of symbolic music data. The model was evaluated on various tasks including melody generation.\nMore recently, a new research area within deep learning called \"sub-task decomposition\" has emerged [3]. This approach breaks down the music generation process into smaller, more manageable steps (typically two). The first step aims"}, {"title": "Proposed Approach", "content": "At the core of our algorithm are the phrase generator and refiner models. The phrase generator is analogous to an autoregressive language model, which in the musical sense learns to generate content in the style of the dataset on which it is trained. As the phrase generator struggles with repetitions and novel motifs, the phrase refiner assists it structurally in either smoothly bringing back a variation of the motif or in defining a new motif for the next section of the piece. The phrase refiner is trained on a self-supervised corruption refinement strategy. During generation, transformations of the phrase containing the motif are presented to the phrase refiner to generate a meaningful variation with respect to the context."}, {"title": "Phrase Generator", "content": "Let the set of musical phrases\u00b3 in a dataset be {$P_1, P_2, . . ., P_N$}. The phrase generator $h_\\theta$ is an encoder-decoder transformer [24] model that is provided previous phrases as input to produce the next phrase as follows:\n$P_{N+1} = h_\\theta(P_k,P_{k+1},...,P_N, C)$                                                                                                                                                                                                                                                                                                                                     (1)\nwhere $k < N$, and $C$ are conditional tokens\nWe condition the model on the type of corruption, key and time signature, phrase length and the cadence of the target phrase $P_{N+1}$ to make it controllable at generation time. These conditional tokens are concatenated in the sequence."}, {"title": "Phrase Refiner", "content": "During training, we take two consecutive phrases from our dataset (e.g. $P_i$ and $P_{i+1}$) and corrupt $P_{i+1}$ with a corruption function $g_j$ (see Section 2.3) chosen at random from the set {$g_1,g_2,...,g_j$} such that:\n$P_{corrupted} = g_j(P_{i+1}).$\n(2)"}, {"title": "Transformation and Corruption Functions", "content": "During training, we corrupt every following phrase shown to the phrase refiner model based on the corruption functions shown below. We provide the model with corruption tokens to indicate the type of corruption. This can be seen visually in Figure 1. These corruption tokens are then paired with the transformations at generation time to refine the transformed phrases to better match the preceding context.\nFragmentation\u00b9: Returns a random crop or bar from the phrase.\nPermutation: Randomly shuffles either note pitch, duration, or both.\nIncorrect Inversion: Changes the pitch value of notes in the phrase randomly by [-4,4] semitones.\nMelodic Stripping & Addition: Melodic stripping omits out a note at random with a 50% probability whereas melodic addition introduces a new note from the same key signature of the phrase with a 50% probability."}, {"title": "Phrase Selector", "content": "The objective of the phrase selector model is to choose the most suitable phrase from a pool of generations for a given musical context within a section. One way to define \"most suitable\" may be a phrase that is the most likely generation of a previous phrase. K different $P_{n+1}$ phrases are generated from equations 1 and 5 above by varying the models' temperature parameter. Let $f_s(P_{n+1})$ represent the function that scores each of these generated phrases. The phrase with the highest score, denoted $P_{n+1}$, is selected as the most likely phrase given the context. Therefore, we have the following:\n$P_{n+1} = arg \\underset{P}{max} f_s(P_{n+1})$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (6)\nTo train the phrase selector model, we take two consecutive phrases from the same song and treat them as positive labels, while taking another pair from different songs as negative labels. We use a transformer encoder-only model with a binary classification objective for our setup. Note that while the phrase selector is put in place to ensure consistency of phrase-based generations, the objective function can also include other metrics based on musical tension, similarity, etc."}, {"title": "The Yin-Yang Framework", "content": "For a particular musical section [15], the Yin-Yang framework operates by first calling the phrase generator to generate an initial set of N phrases based on the given prompt. The phrase refiner is then invoked, taking the original motif (first phrase) and applying a high similarity transformation to generate a similar output. This transformed motif is then refined by the phrase refiner with respect to the last phrase generated from the phrase generator, producing the (N+1)th phrase. The ratio of phrases generated by the phrase generator versus those refined by the phrase refiner is controlled by a user-defined parameter G:R applicable within a particular section. For subjective experiments, this ratio was set to 2:1, meaning that the phrase generator produced 2 phrases before the refiner generated the 3rd phrase through motivic transformation and refinement. For the 4 phrases in each section, the phrases in this ratio were generated as [M,G,G,R,G], where M, G and R are the motif, generator and refiner models, respectively. The phrase selector is used on both models to select the most suitable generated phrase from a pool of 5 phrases (K = 5) with varying temperatures.\nTo generate the same section (e.g., AA), we copy the motif again and randomly sequence it an octave higher or lower, or keep it the same. The phrase generator is only allowed to see phrases as context within the particular section it generates for. To produce new sections, we take any arbitrary phrase from the previous sections and apply a low similarity transformation and refine it with respect to the last phrase of the previous section. To add more novelty to the new motif for the new section, we can limit the number of notes of the last phrase that the refiner sees as context, to reduce its dependence upon it. In our case, we limit it to only the last bar. The length of the new motif of the new section is conditioned to be between 9-16 notes. We also have the flexibility to modulate to new key signatures as both models condition on this information. A small example of the framework comprising 2 sections with 7 total phrases (A3B4) and a PG ratio of 1:1 can be seen in Figure 3. For our user study, we generate 20 phrases in ABACA form. Our aim is to have homogeneous or highly similar phrases within a section but heterogeneous phrases between new sections."}, {"title": "Experimental Configurations", "content": "3.1 Dataset\nWe used three monophonic folk song datasets in our study: MTC-FS-INST 2.0 [23], MTC-ANN-2.0.1 [14] and ESSEN Folksong Collections7. All three datasets have phrase annotations in JSON files which can be obtained here along with their documentation. We preprocessed the files by extracting each note's pitch and duration information, along with the key and time signatures. We included all key and time signatures in this study, but excluded songs with only a single phrase. Table 3 shows the statistics of all three datasets after preprocessing. As seen in the last two columns, the average song duration is quite short, typical of folk songs. Although some songs in the dataset develop the initial musical idea, this development is typically less extensive than in other genres, such as classical music, reflecting a characteristic feature of folk songs rather than a drawback. We chose this dataset because it highlights the effectiveness of our proposed methods in elaborating on a musical idea, even when fully developed songs are limited. To train all the models, we split the data into training, validation and test sets which account for 23,733 (~90%), 2,649 (~10%) and 100 files respectively. Each set comprises unique phrases with no overlap between them.\n3.2 Model Implementation Details\nThe phrase generator (PG) and phrase refiner (PR) models have a 4-layered encoder-decoder transformer architecture with 4 attention heads, hidden size of 512, and intermediate size of 2048. PG has a longer encoder sequence length of 2048 tokens to accommodate longer input contexts compared to 512 tokens for the PR as it only looks back at the last phrase. Both decoders have a context window of 512 as they generate a single phrase at a time. The phrase selector (PS) transformer is an encoder-only architecture with the same configurations as the encoder of the PR model but with a context window of 1024 tokens. All three models are trained for 30 epochs (or until early stopping) using the Adam optimizer with a learning rate of 0.0001, weight decay of 0.01, and maximum gradient norm of 3.0. We use the REMI sequence encoding [12] and pitch shifting (between \u00b112 semitones) data augmentation for all three models."}, {"title": "Baselines And Ablations", "content": "To demonstrate our framework's effectiveness against state-of-the-art transformer-based models that implicitly learn musical structure, we select two baselines. The first is the Music Transformer (MT) [11], which incorporates relative positional attention, a model-based enhancement. The second is the Compound Word Transformer (CP) [9], aimed at compact sequence representations, a feature-based enhancement. We train both models from scratch on the datasets used in this study with configurations similar to the PG model described above. Our goal is to demonstrate that, in comparison to the baselines, the Yin-Yang framework can extend motifs into longer, well-structured melodies without the need for explicit training on extended sequences.\nAdditionally, we aim to investigate the impact of the PS model on our framework's performance. To this end, we evaluate an ablated version of our framework, both with and without the PS model. We denote the complete Yin-Yang model with the selector as YY, and the ablated version without as YYA in all the experiments below. We re-emphasize the goal of this study is to go beyond the real dataset which has limited motivic development and new sections for the majority of the pieces. To this end, comparing our framework against the test set is not meaningful for the goal of our study."}, {"title": "Experimental Evaluation", "content": "4.1 Objective Evaluation\nPrevious studies [36] on structure generation used the COSIATEC compression ratio [18] and self-similarity matrices [31] to discover repeated segments, while [27] counted motif repetitions throughout the length of the generated piece. However, a major limitation is that these metrics can be inflated by excessive repetition of a pattern. For example, simply looping a phrase would yield high scores despite a lack of true structural development. Additionally, these metrics cannot quantify the gradual transformation and progression of the motif throughout the piece, a crucial aspect of motivic development in composition.\nMusical development requires manifesting the motif throughout a section. We design an objective metric to evaluate the smooth evolution from the initial motif and the extent to which the generated material is derived from the prompt. To this end, we trained a structural derivation (SD) model with a similar architecture to the phrase selector model but with a different training methodology. Instead of considering two consecutive phrases from the same song as a positive example, we allow the model to treat any pair of phrases within the same song as positive, while the negative examples remain phrases from different songs. During the evaluation, given a set of generated phrases {$P_1, P_2, ..., P_N$}, where P1 is the motif, we consider the average of the SD model's probabilities over phrase pairs {$P_1, P_2$}, {$P_1, P_3$}, . . ., {$P_1, P_\u2116$}.\nA moderate to high SD score indicates a smooth evolution of the generated music while adhering to the initial motif, quantifying its manifestation throughout the piece. In contrast, a low SD score may signify undesirable deviations from the motif. However, excessive repetition of a phrase can artificially inflate the SD score. Therefore, we complement the SD score with the Vendi score [7], a recently proposed general diversity evaluation metric for machine learning outputs. To extract the Vendi score, we analyze the similarity matrix computed from the embeddings of the last hidden state output of the SD model in {$P_1, P_2$}, {$P_1, P_3$},..., {$P_1, P_N$}. Passing this matrix through the Vendi score function gives us a diversity score for all the phrases in the song. A high Vendi score indicates highly diverse outputs, while a low score suggests over-repetition. Note that in preliminary experiments with the SD model, we were satisfied with its accuracy in detecting a smooth transition of motifs. Furthermore, as described below, we validated its usage through a listening study, investigating melodic smoothness with respect to the motif and unwanted repetitions.\nWe stress the importance of viewing both these scores simultaneously for a more holistic evaluation of the model's performance. As there is no easy way to differentiate between musical sections with the MT and CP baselines, we generate only Section A, comprising 20 phrases in total with the YY and YYA models in the objective study for a fair comparison. We also provide the pitch range and unique pitch averages per phrase as objective metrics to indicate the pitch contour height and pitch diversity of generations. The results are given in Table 4 with the analysis provided in Section 4.3."}, {"title": "Subjective Evaluation", "content": "We invited 22 people to participate in our listening test. Among these, 8 participants had at least some level of musical knowledge. We randomly chose 4 musical samples from each of the 4 models (CP, MT, YY and YYA). We conducted a mean opinion score (MOS) test in which participants were asked to provide their ratings from 1 (bad) to 5 (good) on the following aspects:\nCoherence (Ch): How well does the melody follow the initial prompt, and unfold smoothly throughout the piece?\nSimilarity (Sm): Does the melody have similarities to the initial prompt as it progresses?\nStructureness (Sa): Does the melody have recurring motifs, phrases, and sections and reasonable musical development?\nStructureness (St): Are there multiple distinct musical ideas present within the melody?\nExpectedness (E): Are there unwanted repetitions of phrases in the melody?"}, {"title": "Analysis and Discussion", "content": "We conducted a one-tailed ANOVA test across all 4 models for each metric in Table 5. The results were statistically significant at a = 0.001, indicating differences in means between models for each metric. Pairwise comparisons using the Tukey HSD test between all models revealed significantly better results for the YY and YYA models compared to the baselines. However, pairwise comparisons between YY and YYA did not show significant differences.\nThe low SD score of the CP baseline in Table 4 suggests an inability to manifest the motif throughout, often lacking motif-centered structural development. Its high Vendi score indicates that generations diverge too much from the initial prompt, supported by the low coherence (Ch) and similarity (Sm) participant scores in Table 5. The MT baseline in contrast tends to produce overly safe, motif-following notes at first glance, as seen in the higher SD score. However, excessive repetition throughout leads to low participant scores in structural metrics, confirmed by poor expectedness (E) and Vendi scores that indicate a lack of diversity. Participants found MT overly repetitive compared to CP, with significantly lower expectedness scores in pairwise tests.\nYY and YYA achieve significantly better results in all subjective evaluation metrics and a statistically higher overall MOS score as seen in Figure 4. The moderately high SD score along with the Vendi scores further suggest motif-centric structural development with varied outputs. While there is no theoretical upper bound on the Vendi score, we can interpret CP's score of 2.02 to indicate outputs that are so varied so as not to adhere to the motif and MT's score of 1.54 to be too repetitive, which are both confirmed by our user studies. Thus, YY and YYA models are placed appropriately in the middle for both metrics, making them neither overly repetitive nor structurally lacking.\nAlthough the YY model performs slightly better than the ablated YYA for several subjective questions, the differences were not statistically significant. Objectively, YY's slightly higher SD score complemented by the lower Vendi score align with the goal of the phrase selector choosing the most suitable next phrase, making the generated section more homogeneous. Removing the phrase selector in YYA gives more freedom to the PG and PR models to generate without an intermediary selection process. Thus, users can control the degree of homogeneity within the section by keeping the PS model in."}, {"title": "Conclusions and Future Work", "content": "In this work, we proposed Yin-Yang, a framework for developing a musical motif into a structured piece with controllability and long-term coherence. Our approach employs three models: a phrase generator to produce initial melodic phrases, a phrase refiner that applies transformations inspired by Western European music theory to produce motivic variations that logically develop the motif, and a phrase selector that chooses the most likely phrase sequence. Through objective and subjective evaluations, we demonstrated that our framework generates melodies with smooth structural evolution from the initial motif while maintaining diversity, outperforming state-of-the-art transformer models. The semi-interpretable generative nature of our approach also allows for musical analysis of the generated pieces. Yin-Yang takes a step towards computationally emulating the creative process of motivic development in musical composition.\nIn future work, we plan to use the Yin-Yang framework on complex datasets, including polyphonic music. The refiner and generator models could be conditioned on pitch contour, musical tension, chord progressions, etc. to give the music more direction. We can also equip the phrase selector with additional constraints in its search for the most suitable generation. Integrating these features could bring us closer to developing an intelligent music generation system capable of considering multiple decision points to enhance musical output."}]}