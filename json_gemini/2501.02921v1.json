{"title": "Unsupervised Tomato Split Anomaly Detection using Hyperspectral Imaging and Variational Autoencoders", "authors": ["Mahmoud Abdulsalam", "Usman Zahidi", "Bradley Hurst", "Simon Pearson", "Grzegorz Cielniak", "James Brown"], "abstract": "Tomato anomalies/damages pose a significant challenge in greenhouse farming. While this method of cultivation benefits from efficient resource utilization, anomalies can significantly degrade the quality of farm produce. A common anomaly associated with tomatoes is splitting, characterized by the development of cracks on the tomato skin, which degrades its quality. Detecting this type of anomaly is challenging due to dynamic variations in appearance and sizes, compounded by dataset scarcity. We address this problem in an unsupervised manner by utilizing a tailored variational autoencoder (VAE) with hyperspectral input. Preliminary analysis of the dataset enabled us to select the optimal range of wavelengths for detecting this anomaly. Our findings indicate that the 530nm - 550nm range is suitable for identifying tomato dry splits. The analysis on reconstruction loss allow us to not only detect the anomalies but also to some degree estimate the anomalous regions.", "sections": [{"title": "1 Introduction", "content": "Tomato fruit is rich in multivitamins, including Vitamin C and E, and contains the antioxidant lycopene. This fruit has been linked to reducing the risk of certain cardiovascular diseases, making it widely consumed [8]. Tomato cultivation is often conducted in controlled environments, particularly greenhouses, where external environmental factors have minimal impact on the produce [5]. However, despite these controlled conditions, some tomato anomalies may develop, both within and outside the greenhouse environment, which can degrade the quality of the fruit.\nThe split anomaly is a common issue in tomato cultivation. It is characterized by cracks on the tomato skin, exposing the internal flesh. This anomaly often varies in appearance and size, with some splits barely visible. Not only does it degrade the quality of the tomato, but it also makes the fruit susceptible to secondary infections. The split anomaly is often caused by a combination"}, {"title": "2", "content": "of factors, particularly fluctuations in temperature and water supply [9]. These factors are difficult to control, given the complexities of the tomato supply chain. Thus, effective detection methods are essential for the early identification of this anomaly. Early detection will increase the quality of the produce, reduce wastage, lower the cost of sorting, and ultimately enhance overall yield.\nThe use of Hyperspectral Imaging (HSI) allows for the observation of spectral properties of objects by visualizing them through several wavelengths. This capability has driven a shift in agricultural sensing applications from traditional RGB imaging being utilised for detection [1, 10, 20-22]. In the agricultural domain, hyperspectral imaging is employed for a variety of applications, including weed detection [2,19], pest and disease detection [25, 28], phenotyping [11,14], and anomaly detection for infection [16], bruises [4] and cracking [26].\nAnomaly detection through machine learning has been explored from multiple perspectives. A widely adopted approach involves unsupervised anomaly detection techniques, which can be classified into clustering-based, classification-based, reconstruction-based, and self-supervised methods [7,17]. Clustering-based methods learn the distribution of normal data, operating under the premise that anomalous data will occupy low-density regions, distinct from the primary clusters of normal data. Common models for clustering methods include Gaussian Mixture Models (GMM), which represent data distributions as a combination of multiple Gaussian distributions, each with its own mean and variance [29], and the Local Outlier Factor (LOF), which identifies outliers by measuring the local density deviation of a data point relative to its neighbors [6]. One-class SVM (OCSVM) [23] is a classification based approach that identifies patterns within the data by learning a decision boundary that separates the majority of data points from the rest. The aim is to detect anomalies by classifying new data points as either within the normal region or as outliers based on their deviation from the learned boundary. Self supervised approach leverage the inherent structure of the data to create tasks like predicting missing parts of the data or generating augmentations. The model then learns to distinguish between normal and abnormal patterns by solving these tasks [18,27]. Reconstruction-based models detect anomalies by evaluating reconstruction errors. The principle is that if a model, typically an autoencoder, is trained on normal data, it will struggle to accurately reconstruct anomalous data since it has not encountered such data during training [3]. A simple but yet an effective methods for anomaly detection.\nDespite these advancements, tomato split anomaly detection remains challenging due to the dynamic appearance and size variations of the anomalies. To address this, we propose an approach that utilises the reconstruction loss of a variational autoencoder to detect the challenging split anomaly. To the best of our knowledge, there is no available literature that has specifically targeted the tomato split anomaly detection using hyperspectral imaging."}, {"title": "2 Materials and Methods", "content": "The data collection setup includes a camera, lighting source, a computer system running Specim's Lumo software, and the fruit as seen in Fig. 1. The camera used is the FX10e hyperspectral camera from Specim [24]. This is a line scanner capable of scanning wavelengths ranging from 400nm to 1000nm. For the data collection, we configured the camera to scan 800 lines at a frame rate of 40 frames per second (fps). Each acquired image has dimensions of 1024 (width) \u00d7 800 (height) \u00d7 448 (depth), where the depth corresponds to the number of wavelengths. The lighting source is attached to the camera rig to ensure sufficient illumination for capturing the spectral properties of the fruit. The Lumo software, equipped with a graphical user interface, facilitates communication with the camera, visualization of the fruit, and the capture/storage of the hyperspectral images."}, {"title": "2.2 Dataset", "content": "A total of 20 scanning sessions of tomatoes yielded 74 tomato samples, which were further spatially augmented (rotation and flipping) to 305 normal instances and 55 anomalous instances. The data collection process was conducted in a dynamic fashion, with tomatoes presented in various orientations to enhance dataset robustness. Each capture included not only the tomatoes but also their stalks and calyxes, ensuring that all relevant parts of the fruit were represented to enrich the dataset. The RGB image samples are shown in Fig. 2."}, {"title": "2.3 Data Preprocessing", "content": "To eliminate sensor noise and calibrate the variation of intensities across wavelengths, the Hyperspectral images were corrected using the white and dark references according to Equation 1.\n$I_c = \\frac{I_i - I_d}{I_w - I_d}$ (1)\nwhere $I_c$ is the calibrated Image, $I_i$ is the original image, $I_d$ is the dark reference image and $I_w$ is the white reference image.\nBecause the data captured encompasses the tomato bunch, the next pre-processing task involves cropping each individual tomato from the image and masking out the background. For this, we utilized an open source tomato pre-trained YOLOv8 model [12, 13] to obtain the bounding boxes and masks of the Region of Interest (ROI). The pre-processing pipeline is illustrated in Fig. 4. Three wavelengths representing the Red, Green, and Blue (RGB) bands were"}, {"title": "2.4 Proposed Model Pipeline", "content": "Variational Autoencoder (VAE) The complete pipeline starts by having the input pre-processed as in Section 2.3. The processed input is passed to the VAE. As earlier discussed that our input (x) has a dimension (H, W, D) corresponding to Height, Width and Depth (spectral channels) of the HSI, the encoder consists of several convolutional layers compressing the input to give an output of two vectors: \u00b5 which is the mean and V = $logo^2$ which is the logarithm of the variance of the latent space distribution. Suppose the encoding process is E(x), we can say that:\n$\\mu = f_{\\mu}(E(x))$ (5)"}, {"title": "6", "content": "and,\n$V = f_v(E(x))$ (6)\nwhere $f_{\\mu}$ and $f_V$ are fully connected layers. The output of these functions \u00b5 and V are then used to create latent variable z. To enable backpropagation, z is sampled through a stochastic process. Since the direct sampling of z from the normal distribution $N(\\mu, \\sigma^2)$ may involve a non-differentiable operation which may hinder backpropagation, reparameterization trick is used to sample z as follows: firstly, a random variable is sampled from a standard normal distribution $N(0, I)$.\n$\\epsilon \\sim N(0, I)$ (7)\nwhere I is an identity matrix. Next, we shift and scale $\\epsilon$ using the \u00b5 and $\\sigma$ from the encoder to obtain the sampled z as follows.\nz = $\\mu$ + $\\sigma$$\\epsilon$ (8)\n$\\sigma$ is also expressed as $\\sigma = e^{(0.5 \\cdot V)}$ to make the value positive, and $\\cdot$ denotes element wise multiplication.\nAfter obtaining the latent variable z, the decoder is then used to map the latent variable back to the hyperspectral data space, producing a reconstruction $\\hat{x}$.\n$\\hat{x} = g(z)$ (9)\nThe loss function of the VAE combines a reconstruction loss and KL divergence loss. The reconstruction loss evaluates the accuracy of the decoder in re-constructing the hyperspectral image from its latent representation. To enhance sensitivity in detecting small anomalies, we utilize the L1 loss, which calculates the absolute difference between the reconstructed image and the original. The reconstruction loss is defined as:\n$L_{recon} = \\sum_{h=1}^{H} \\sum_{w=1}^{W} \\sum_{d=1}^{D} |x_{h,w,d} - \\hat{x}_{h,w,d}|$ (10)"}, {"title": "2.5 Training", "content": "The network was trained using the processed data as described in Section 2.3. The model training spanned 2500 epochs, with the latent space dimensionality S set to 100. Adam optimiser [15] was used and the learning rate was set to $10^{-3}$"}, {"title": "3 Results", "content": "The initial experiment aimed to identify the wavelengths of interest to enhance the accuracy of our model and reduce computational load by pinpointing key wavelengths while discarding redundant ones. We approached this task through both visual analysis and inspection of the reflectance.\nIn the visual analysis, we selected a range of wavelengths that encompass the entire spectrum and manually inspected the images to determine where the tomato split was most apparent. For example, in Figure 6, two sample images demonstrate that the split is most apparent in the wavelength range of 520.54 nm to 600.89 nm.\nFor the reflectance analysis, we selected two patches: one from the split region and another from a normal region and compared their spectral responses."}, {"title": "3.2 VAE Results", "content": "The reconstruction loss, derived from Equation 10 was employed to determine the anomaly status of the tomato. The objective is to establish a threshold that effectively distinguishes between normal and anomalous tomatoes. The threshold is determined by splitting the testing dataset, which comprises both normal and anomalous instances, into two halves to mitigate bias. Precision and recall were"}, {"title": "10", "content": "computed for the first half, yielding the F-score. The optimal threshold was estimated by evaluating the F-score across thresholds and selecting the threshold that maximized the score, as depicted in Figure 9. Subsequently, we validated this selected threshold on the remaining unseen data, generating the precision-recall plot shown in Figure 9. For different threshold @ in a set of thresholds $\\Theta$ depicting the range of reconstruction losses, the maximum F1 can be computed as:\n$F1_{max} = \\underset{\\theta \\in \\Theta}{max} \\frac{2 \\cdot Precision(\\theta) \\cdot Recall(\\theta)}{Precision(\\theta) + Recall(\\theta)}$ (14)\nSince the model was trained exclusively on normal data, the threshold is such that any reconstruction error exceeding this value indicates an anomaly. Conversely, errors below this threshold denote normal tomato. The threshold criterion for anomaly detection is defined by the following equation:\n$Status = \\begin{cases} Anomalous & \\text{if } L_{recon} > \\theta \\\\ Normal & \\text{otherwise} \\end{cases}$ (15)\nFigure 10 shows the reconstruction losses and the regularity scores of the test data, including both normal and anomalous instances. The regularity score is the normalised reconstruction loss. We have a total of 15 normal instances and 55 anomalous instances in the test set. The threshold ($\\theta$) = 1928.6 previously obtained effectively distinguishes between normal and anomalous tomato. From the figure, it can be observed that the reconstruction errors for normal"}, {"title": "4 Conclusion", "content": "In this study, we have presented an effective approach for detecting tomato split anomalies using a tailored variational autoencoder (VAE) with hyperspectral input. Our preliminary analysis identified the optimal wavelength range of 530nm\n550nm for detecting tomato split anomalies. The reconstruction loss of the proposed VAE was used as a metric to identify splits by selecting a suitable threshold. The VAE model demonstrated high detection accuracy by effectively having a lower reconstruction loss for the normal samples and relatively higher loss for the anomalous samples thus highlighting its potential for improving quality control in greenhouse farming.\nFuture work may focus on adding a classification head to classify the extent of the splits for grading purposes. Additionally, exploring anomaly detection with sufficient dataset and without the specularity of light on the target could further increase the accuracy of the model."}]}