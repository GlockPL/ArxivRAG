{"title": "SCMIL: Sparse Context-aware Multiple Instance Learning for Predicting Cancer Survival Probability Distribution in Whole Slide Images", "authors": ["Zekang Yang", "Hong Liu", "Xiangdong Wang"], "abstract": "Cancer survival prediction is a challenging task that involves analyzing of the tumor microenvironment within Whole Slide Image (WSI). Previous methods cannot effectively capture the intricate inter- action features among instances within the local area of WSI. More- over, existing methods for cancer survival prediction based on WSI of- ten fail to provide better clinically meaningful predictions. To over- come these challenges, we propose a Sparse Context-aware Multiple In- stance Learning (SCMIL) framework for predicting cancer survival prob- ability distributions. SCMIL innovatively segments patches into various clusters based on their morphological features and spatial location in- formation, subsequently leveraging sparse self-attention to discern the relationships between these patches with a context-aware perspective. Considering many patches are irrelevant to the task, we introduce a learnable patch filtering module called SoftFilter, which ensures that only interactions between task-relevant patches are considered. To en- hance the clinical relevance of our prediction, we propose a register- based mixture density network to forecast the survival probability dis- tribution for individual patients. We evaluate SCMIL on two public WSI datasets from the The Cancer Genome Atlas (TCGA) specifically focus- ing on lung adenocarcinom (LUAD) and kidney renal clear cell carcinoma (KIRC). Our experimental results indicate that SCMIL outperforms cur- rent state-of-the-art methods for survival prediction, offering more clin- ically meaningful and interpretable outcomes. Our code is accessible at https://github.com/yang-ze-kang/SCMIL.", "sections": [{"title": "1 Introduction", "content": "Using Whole Slide Image (WSI) to predict patient's cancer survival risk is crucial for health monitoring and personalized treatment in clinical settings. Patholo- gists typically examine WSIs manually to identify relevant biological features for diagnosis. However, the high resolution of WSI demands considering time and effort to complete the analysis. Automatic diagnosis using deep learning tech- nology has the potential to significantly reduce the workload of pathologists, and many studies have been conducted on this subject [3,16,24]. Obtaining fine- grained annotations for high-resolution WSI is challenging, and it is often treated as a weakly supervised learning task. In recent years, researchers have developed various methods to address this challenge, achieving commendable results in cancer diagnosis. Unlike cancer diagnosis, survival risk prediction involves not only extracting biomorphological features but also delving into the interactions between cells and tissues within the tumor microenvironment. Furthermore, pro- viding predictions with enhanced clinical relevance posed an additional challenge in the task of survival prediction [6].\nDue to the high resolution of WSIs, it is common practice to segment them into patches with a fixed size. Then a feature extractor, such as ImageNet pre- trained ResNet50 [9], is used to extract features from all patches, followed by multiple instance learning [11] for predictive analysis. Methods like AMIL [11], CLAM [16], and DSMIL [15] make predictions by identifying key patches. How- ever, these methods neglect the interaction among patches, which is insufficient for survival prediction tasks. Approaches such as WSISA [25], and DeepAttn- MISL [23] use clustering to divide patches into various phenotypes and then extract the features of each phenotype respectively. While these methods con- sider the morphological relationship between patches, they disregard the spatial connections. Methods like PatchGCN [2], and HGT [10] treat WSIs as point clouds with each patch represented as a node. Graph Convolutional Networks (GCNs) [7,14,22] are used to explore the relationships among patches. In these methods, each patch pays attention to the information from neighboring patches, requiring deeper layers to cover a wider area. However, an increase in layer depth leads to a significant rise in computational demands and GPU memory usage.\nAnd the mining of the relationship among patches also depends on the selec- tion of aggregation function. TransMIL [18] employs a self-attention mechanism along with the PPEG module to investigate inter-patch relationships. However, to mitigate GPU memory constraints, the author uses linear approximation for self-attention, resulting in a coarse-grained attention between patches.\nTo address the aforementioned challenges, we propose a Sparse Context- aware Multiple Instance Learning (SCMIL) framework for the prediction of pa- tient survival probability distributions. Our primary contributions are as follows:\n(1) We design a patch filtering module called SoftFilter to identify task-relevant patches and can be trained through backpropagation. (2) We propose the Sparse Context-aware Self-Attention (SCSA), which uses sparse self-attention to learn the interactions among local patches, while concurrently incorporating both spa- tial and morphological information to guide the learning of patch interactions in specific areas. (3) We present the Register-based Mixture Density Network (RegisterMDN), which can learn the parameters for each component of a Gaus- sian Mixture Model from data of cancer patient cohort and utilizes individual patient's data to forecast the weights of these components. This approach en-"}, {"title": "2 Methodology", "content": "Figure 1 depicts the pipeline of our proposed Sparse Context-aware Multiple In- stance Learning (SCMIL) framework. WSIs are segmented into fixed-size patches with 256x256 pixels, and irrelevant patches are filtered out. Subsequently, we use the feature extractor ViT [5] (F(x) in Figure 1), which has been pre-trained on a large-scale collection of WSIs using self-supervised learning [12], to extract the features $Feat \\in R^{n \\times d}$ for all patches. The fundamental principle of our SCMIL approach is to identify regions within high-resolution WSI that are most infor- mative for predicting patient survival risk. In these significant areas, we identify biomarkers that are associated with survival risk. By integrating the survival information from the cancer patient cohort, we can subsequently generate a survival probability distribution for the patient. SCMIL framework is mainly composed of three components: SoftFilter, Sparse Context-aware Self-Attention (SCSA), and the Register-based Mixture Density Network (RegisterMDN). Soft- Filter help SCSA focus on task-specific areas, and RegisterMDN predicts the survival probability distribution based on the wsi-level feature."}, {"title": "2.1 SoftFilter", "content": "Within each WSI, there exist numerous patches that are irrelevant to the imme- diate task. To address this problem, we design a learnable patch filtering module termed SoftFilter. SoftFilter inputs the features of patches into a Multilayer Per- ceptron (MLP) followed by a Sigmoid activation function to predict the patches' importance scores $IS \\in R^{n \\times 1}$.\n$IS = Sigmoid(MLP(Feat))$\nSubsequently, the features of each patch are element-wise multiplied by their corresponding importance score to derive the new features $H \\in R^{n \\times d}$. This process enables the SoftFilter module learnable without requiring patch-level supervision. $H$ are then partitioned into task-relevant features $H_{high}$ and task- irrelevant features $H_{low}$ according to the $IS$ threshold $Thre$. The task-relevant features are propagated to the SCSA module for learning the interactions among patches, while the task-irrelevant features bypass this stage."}, {"title": "2.2 Sparse Context-aware Self-Attention (SCSA)", "content": "After obtaining the task-relevant features, we devise a Sparse Context-aware Self-Attention (SCSA) module to explore the interactions among patches. The SCSA first cluster the potentially interacting patches into the $C$ clusters {$L_1$, $L_2$,..., $L_c$} based on the morphological features and spatial positions of the patches. Specifically, we employ the K-Means clustering algorithm to divide the task-relevant patches and the similarity between patches is obtained by a weighted sum of the cosine similarity of morphological features and the nor- malized Euclidean distance of spatial positions, with the weights being $w_1$ and $w_2$ respectively. To accommodate WSIs of varying sizes, we fix the size of the clusters and derive the number of clusters from the size of the clusters. Then we utilize the Multi-Head Self-Attention mechanism (MHSA) [19] to learn the relationships within each cluster and obtain refined features $L'$.\n$L'_i = MHSA(L_i) + L_i, i = 1, 2, ..., C$\nCompared with linear self-attentions methods [18,21], our sparse self-attention approach enables a more fine-grained attention to the relationships among patches. Subsequently, the features from all clusters, along with the task-irrelevant fea- tures, are concatenated. The WSI-level features $Feat'$ is obtained through an attention-weighted process [11]:\n$H' = Concat(L'_1, L'_2, ..., L'_C, H_{low})$\n$\\alpha_i = \\frac{exp(\\omega^T (tanh(VH^T_i) \\odot \\sigma(UH^T_i)))}{\\Sigma_{k=1}^n exp(\\omega^T (tanh(VH^T_k) \\odot \\sigma(UH^T_k)))}$\n$Feat' = \\Sigma_{i=1}^n \\alpha_i H'_i$\nwhere $U$, $V$, and $\\alpha$ are learnable parameters, $n$ is the number of patches within the WSI, $\\odot$ denotes element-wise multiplication, and $tanh(.)$ is the hyperbolic tangent function. The features $Feat'$ now contain biomarkers relevant to patient survival risk and are instrumental in subsequent survival prediction tasks."}, {"title": "2.3 RegisterMDN", "content": "Previous studies [1,2,10,23] for predicting survival risk based on WSIs mainly focus on predicting a time-independent risk value. This approach is of limited utility when considering only the risk value of an individual patient. A more comprehensive prognosis of a patient's survival risk should take into account the risk values and survival times of other patients within the cancer patient cohort. Moreover, looking at the risk value for a single patient does not pro- vide useful information. To provide more clinically meaningful predictions, we design the Register-based Mixture Density Network (RegisterMDN) inspired by SurvivlMDN [8] to predict the survival probability distribution for an individual patient.\nThe Mixed Density Network (MDN) translates the input to a probability distribution. We adopt Gaussian distributions as the components of the MDN, assuming that the number of components is $K$. We utilize the WSI-level features $Feat'$, the mean vector $P_m$, and the standard deviation vector $P_v$ as the input of our RegisterMDN. Both $P_m$ and $P_v$ are learnable parameters and learn the sur- vival risk characteristics of the specific cancer during the training phase. $Feat'$, $P_m$, and $P_v$ are through the neural networks to produce the weights $\\lambda_i(Feat')$, means $\\mu_i(P_m)$, and variances $\\sigma_i(P_v)$ of the mixture model. Consequently, we can get the Probability Density Function (PDF):\n$PDF(y|Feat', P_m, P_v) = \\Sigma_{i=1}^K \\lambda_i(Feat')\\mathcal{N}(y|\\mu_i(P_m), \\sigma_i(P_v))$\nThe patient's survival time is a positive number, so we define the survival time $t = g(x) = log(1 + exp(y))$. This transformation enables us to formulate the patient's Death Probability Density Function (DPDF) and Death Cumulative Density Function (DCDF):\n$DPDF(t|Feat', P_m, P_v) = \\frac{dg^{-1}}{dt} \\Sigma_{i=1}^K \\lambda_i(Feat')\\mathcal{N}(g^{-1}(t)|\\mu_i(P_m), \\sigma_i(P_v))$\n$DCDF(t|Feat', P_m, P_v) = \\Sigma_{i=1}^K \\lambda_i (Feat')erf(\\frac{g^{-1}(t) - \\mu_i(x)}{\\sigma_i(x)})$ where $erf(.)$ is the Gaussian error function. The patient's Survival Cumulative Distribution Function $SCDF(t|Feat', P_m, P_v) = 1 - DCDF(t|Feat', P_m, P_v)$ is the final predicted patient survival probability distribution.\nAssuming the patient's right uncensorship status is $c$ (1 for uncensored data and 0 for censored data), the duration from diagnosis to death is $d$, and the time from diagnosis to the last follow up is $o$. $t_d$ is either equal to $d$ ($c = 1$) or $o$ ($c = 0$). Then we can define the loss function of RegisterMDN with the help of maximum likelihood estimation:\n$loss = -c \\cdot log(DPDF(t_d|Feat', P_m, P_v))\n- (1-c) \\cdot log(SCDF(t_d|Feat', P_m, P_v))$"}, {"title": "3 Experiments", "content": "We evaluate the effectiveness of our method on The Caner Genome Atlas (TCGA) lung adenocarcinom (LUAD) with 452 cases and kidney renal clear cell carcinoma (KIRC) with 512 cases. All WSIs are analyzed at 20x mag- nification and cropped into 256 \u00d7 256 patches. The average number of patches per WSI is 12,097 for TCGA-LUAD, and 14,249 for TCGA-KIRC, with the largest number of patches is 84,365 from a TCGA-KIRC sample.\nIn our implementation, we set the cluster size $C$ in SCSA to be 64, the threshold $Thres$ in SoftFilter to be 0.5, and the number of components $K$ in RegisterMDN to be 100. We use cuML [17] to accelerate the execution of the K-Means algorithm on the GPU. For all comparison experiments and ablation experiments, we maintain a consistent hyperparameter setting: the learning rate of 2e-4 with a weight decay of 1e-3, the Adam optimizer is used to update the model weights, a dropout rate of 0.1, a batch size of 1, and training for 20 epochs. The 5-fold cross-validation are used on all datasets and models.\nThe conventional concordance index (C-Index) [20] is limted to provide a more comprehensive comparison between different methods. We introduce enhanced evaluation metrics. We use a time-dependent version of the concordance estimator (TDC) within a pre-specified time span [0, $\\tau$]. TDC measures the proportion of patients pairs for which the survival risks is cor- rectly ranked at multiple time points in [0, $\\tau$]. The Brier score (BS) calculates the mean square error between the ground-truth and the predicted probability. It mainly measures the calibration performance. To consider all times, we use an integrated BS (IBS) over time interval [0, $\\tau$]. Models with larger TDC and lower IBS demonstrate superior performance. The result of mean \u00b1 std is reported."}, {"title": "3.2 Experiments and Results", "content": "To compare the ability of our proposed SCMIL in learning cancer survival risk-related features with existing methods, we select several state-of-the-art methods, including AMIL [11], CLAM [16], DSMIL [15], PatchGCN [2], TransMIL [18], HIPT [1], and HGT [10]. We add the RegisterMDN module into these methods to predict the patient's survival probability distribution, ensuring a fair comparison with our method. SCMIL demonstrates its ability to learn interactions between related patches, which is an advancement over methods based on key patches [11,16,15]. Compared to GCNs- based methods [2,10] that focuses on adjacent patches, SCMIL offer a more adaptable attention scope. SCMIL also outperforms Transformer-based methods [1,18] that emphasize global patches by focusing more effectively on local regions of interest. "}, {"title": "3.3 Interpretability of the Proposed Method", "content": "We conduct an interpretability analysis for each module of SCMIL, and the visualization results are presented in Figure 3. The original image is located in the top left, the heatmap of IS is in the top right. The cluster distribution image is in the bottom left, and a zoomed-in view is in the bottom right. In the IS heat map, the color spectrum from red to yellow to blue represents a decrease in IS value. Areas closer to red are considered more valuable for the task. In the cluster distribution image, task-relevant patches are divided into different clusters by the model, with each color representing a different cluster. To determine which areas the model primarily focuses on for patch interactions, we calculate the average IS value for patches within clusters. The image in the bottom right of Figure 3 is an enlarged view of the region containing the cluster with the highest average IS value. The figure reveals that the model pays more attention to the perivascular area. Concurrently, clinical studies have identified angiogenesis and blood vessel invasion as significant factors in predicting cancer risk [4,13]. The knowledge acquired by our model coincides with clinical findings. "}, {"title": "4 Conclusion", "content": "In this paper, we propose SCMIL, a method designed to effectively identify in- stances related to survival risks from numerous instances and to discern the in- teractions among instances within the regions of interest. Moreover, our method synthesizes the information from cancer patient cohort to predict a more clin- ically meaningful survival probability distribution for individual patient. Ex- perimental results on two public WSI datasets demonstrate that our method achieves superior performance and richer interpretability compared to existing methods. In the future, we will extend our model for tasks such as predicting cancer recurrence and enhance the efficiency of our model."}]}