{"title": "Mitigating Exposure Bias in Score-Based Generation of Molecular Conformations", "authors": ["Sijia Wang", "Chen Wang", "Zhenhao Zhao", "Jiqiang Zhang", "Weiran Cai"], "abstract": "Molecular conformation generation poses a significant challenge in the field of computational chemistry. Recently, Diffusion Probabilistic Models (DPMs) and Score-Based Generative Models (SGMs) are effectively used due to their capacity for generating accurate conformations far beyond conventional physics-based approaches. However, the discrepancy between training and inference rises a critical problem known as the exposure bias. While this issue has been extensively investigated in DPMs, the existence of exposure bias in SGMs and its effective measurement remain unsolved, which hinders the use of compensation methods for SGMs, including ConfGF and Torsional Diffusion as the representatives. In this work, we first propose a method for measuring exposure bias in SGMs used for molecular conformation generation, which confirms the significant existence of exposure bias in these models and measures its value. We design a new compensation algorithm Input Perturbation (IP), which is adapted from a method originally designed for DPMs only. Experimental results show that by introducing IP, SGM-based molecular conformation models can significantly improve both the accuracy and diversity of the generated conformations. Especially by using the IP-enhanced Torsional Diffusion model, we achieve new state-of-the-art performance on the GEOM-Drugs dataset and are on par on GEOM-QM9. We provide the code publicly at https://github.com/jia-975/torsionalDiff-ip.", "sections": [{"title": "I. INTRODUCTION", "content": "Molecular conformation refers to the three-dimensional coordinates of a molecule, which is instrumental in ac- complishing many tasks such as molecular property pre- diction [1, 2], docking [3], and molecule generation [4, 5]. Traditional methods such as Molecular Dynamics [6] leverage physical principles to generate relatively accurate conformations. However, these methods regularly suffer from efficiency problems, particularly when dealing with large molecules [7]. Therefore, the generation of stable molecular conformations remains a grand challenge, primarily due to the intricate nature of molecular interactions and the computational demands associated with accurate modeling.\nRecent advancement has witnessed deep generative mod- els as a powerful tool for generating molecular conforma- tions. For instance, [8] introduces a Conditional Variational Graph Auto-Encoder, which represents the first attempt to use deep generative models for this problem, yet neglects the importance of invariance. To tackle the issue, GraphDG [9] and CGCF [10] model atomic distances, which are roto-translation invariant. [11] estimates the score of atomic distances. DGSM [12] improves the quality by modeling the long-range interactions of non-bonded atoms. GeoDiff, pro- posed in [13], uses equivariant neural networks to achieve the roto-translational equivariance. Furthermore, different from previous models that operate in the Euclidean space, [14] proposes the Torsional Diffusion in the space of torsional angles.\nHowever, as pointed out in [15], a systematic discrepancy arises between training and generation phases associated with Diffusion Probabilistic Models (DPMs) while the former is conditioned on real samples, the latter is conditioned on generated ones, ultimately leading to the problem known as an exposure bias. [15] first proposes this concept and suggests that a bias reduction approach by perturbing the input in the training phase. The issue of the exposure bias in DPMs has received significant attention, for which several effective methods have been proposed for its alleviation. [16] discovers the existence of the time-shift between training and sampling and proposes a new sampler to mitigate this bias. [17] points out that the rooting cause of exposure biases is the prediction error at each sampling step and proposes the Epsilon Scaling method.\nIn our work, we attempt to examine the exposure bias in molecular conformation generation and seek a solution for its mitigation. However, exposure biases have only been confirmed in DPMs up to date. Whether there is exposure bi- ases in Score-Based Generative Models (SGMs) and how to effectively measure such bias still lacks exploration. This hin- ders the use of compensation methods in the SGM category, including a full range of important molecular conformation generating models such as Torsional Diff and ConfGF. Here, we propose a method for measuring the exposure bias specif- ically in SGMs. With the detecting algorithm, we confirm the significant existence of exposure biases in this type of models and are able to make estimations of the values. This result enables the adaptation of a compensation algorithms for DPMs to SGMs. Specifically, our experiments on GEOM- QM9[18] and GEOM-Drugs [19] dataset have confirmed that by adapting the exposure bias compensation method Input Perturbation[15], originally designed for DPMs, to the representative models ConfGF and Torsional Diffusion in the SGM category can significantly improve both accuracy and diversity of the generation performance. Most notably, by using Torsional Diffusion as a baseline, we achieve a new state-of-the-art performance on the GEOM-Drugs dataset and a performance on par with the SOTA on GEOM-QM9. Overall, our contributions are:\n\u2022 We propose a method for measuring the exposure bias in SGMs, with which we confirm the significant existence"}, {"title": "II. RELATED WORK", "content": "In recent years, the employment of SGMs or DPMs in molecular conformation generation has attracted increas- ing attention. ConfGF introduces an innovative model that employs SGMs for molecular conformation [11]. ConfGF predicts scores for molecular distances and then computes conformation scores via the chain rule. The estimated scores allow generating stable conformations via the Langevin dynamics. [12] points out that we should not only model the forces between bonded atoms, but also consider those between non-bonded atoms. They propose the DGSM model, which further improves the quality of generated confor- mations. On the other hand, [13] designs an equivariant neural network [20] to address the roto-translation equiv- ariance. Each atom is viewed as a particle in GeoDiff, which learns to reverse the diffusion process as a Markov chain. Furthermore, [14] proposes the Torsional Diffusion by using a torsion angle space. This model divides con- formations into internal coordinates, computed using stan- dard cheminformatic methods, and torsion angles, obtained through a supermanifold-defined SGMs. Torsional Diffusion significantly reduces modeling complexity and enables the generation of high-quality conformations in shorter time.\nHowever, DPMs such as GeoDiff have a common prob- lem: they use real samples during training as inputs, but use predicted samples during generation, leading to an exposure bias [15\u201317]. The issue has received significant attention in DPMs, and several effective methods have been proposed to alleviate this bias. [15] first verifies that this bias follows a Gaussian distribution. They introduce a method named Input Perturbation (IP) by perturbing the input for reducing the bias. Time-Shift [16] locates a more compatible time point which can reduce the bias and proposes the Time-Shift Sampler. Epsilon Scaling [17] shows that the network output derived from real samples is always less than that obtained from predicted ones. However, the exposure bias in SGMs is still not tackled for molecular conformation generation. A reliable method for measuring exposure bias in SGMs is in need, which should confirm the existence of exposure biases in the models in this category and estimate their values."}, {"title": "III. PRELIMINARIES", "content": "Notations. In this paper, we represent a molecular graph as G = (V, E), where V = {V1, V2, ..., vv} is the set of vertices representing atoms, and E = {eij | (i,j) \u2286 V \u00d7 V} is the set of edges representing chemical bonds in the molecule. Each node vi represents atomic properties, such as nuclear charge and atomic coordinate ci \u2208 R\u00b3, and each edge eij represents the properties of the chemical bond between atoms vi and vj, such as the type of the bond.\nSince the directly connected bond relationships are insuffi- cient to fully characterize the conformation, we introduce vir- tual edges between 2-hop and 3-hop neighbors, as suggested in ConfGF [11] and GeoDiff [13], to reduce the degree of freedom. Hereafter, unless otherwise specified, we assume all molecular graphs are extended.\nProblem Definition. Given a graph G = (V, E), our objective is to establish a model that generates corresponding 3D molecular conformations C\u2208 RIVI\u00d73."}, {"title": "B. Score-based Generative Models", "content": "Score-based generative models (SGMs) [21\u201323] are a class of generative models that estimate the gradient of the data distribution via denoising score matching, and use annealed Langevin dynamics [24] for sampling. The objective mini- mizes $E_{p_{data}(C_0)}[||s_\u03b8(C_0) \u2013 \u2207_{C_0} log P_{data}(C_0)||^2]$, which can be equivalently represented in the following:\n$E_{p_{data}(C_0)}[tr(\u2207_{C_0}s_\u03b8(C_0)) + \\frac{1}{2}||s_\u03b8(C_0)||^2]$,\nwhere $C_0$ denotes the original data and $tr(\u2207_{C_0}s_\u03b8(C_0))$ is the Jacobian of $s_\u03b8(C_0)$, which is not scalable. However, the difficulty can potentially be solved by Denoising Score Matching [25], which perturbs the data $C_0$ and estimates the score of the perturbed data distribution instead. To be specific, for time $t$ and a noise level $\u03c3_t$, the noised sample $C_t$ can be expressed by\n$C_t = C_0 + \u03c3_t\u03b5$,\nwhere $\u03f5 \u223c N(0, I)$. The objective is then expressed as\n$E_{p(C_0)} E_{q_\u03c3(C_t|C_0)} [||s_\u03b8(C_t, \u03c3_t) \u2013 \u2207_{C_t} log q_{\u03c3_t}(C_t | C_0)||^2]$.\nWhen $\u03c3_t \u2248 0$, we consider $s_\u03b8(C_t, \u03c3_t) \u2248 \u2207_{C_t} log p(C_0)$. After the score networks $s_\u03b8(C_t, \u03c3_t)$ are trained, we can sample using annealed Langevin dynamics by continuously reducing the noise level. The sampling algorithm is shown in Algorithm 1"}, {"title": "IV. EXPOSURE BIAS IN CONFORMATION GENERATION", "content": "The concept of exposure bias is originally coined for DPMs, which addresses the discrepancy between training and inference phases [15]. Whether there is a similar exposure bias in SGMs and how to effectively measure it remains a key issue, which can significantly affect the conformation quality generated by this type of models, including ConfGF and Torsional Diffusion as representatives. Indeed, during the training process of SGMs, the input Ct to the network can be regarded as a ground truth sample (Eq. 2), while during the inference, the input is the predicted sample Ct along the Markov chain. This discrepancy between the ground truth and predicted samples accumulates in the sampling chain in the generation process, which should finally lead to a similar exposure bias as in DPMs [15-17].\nIn order to effectively measure the accumulation of such a bias in SGMs, we use the true sample Co to compare with the corresponding generated final result Co. Specifically, at a noise level ot, we first obtain Ct with a noise adding function equation fv, which can be expressed by Ct = fN(Co) with a noise level ot (which in the case of Confgf can be simply written as Eq. 2). Then we use Ct as a starting point to generate Co but with a zero-noise sampling function equation fs that does not include the random term: \u0108t = fs(Ct-1, at89(\u0108t\u22121,5t)). Based on these two values, the estimate of the exposure error is computed as et = ||Co - Co||. The algorithm is summarized in Algorithm 2."}, {"title": "B. Input Perturbation", "content": "The estimated bias confirms the existence of an exposure bias in SGMs, which requires a compensation method for its alleviation. As demonstrated in Fig. 1c, as well as in [15], the bias between the predicted and the true distributions follows a Gaussian-like distribution (though not in a strict sense). Therefore, to mitigate the inconsistency between training and generation phases, we perturb the input with a Gaussian noise in the training of the score function to enhance its robustness [15]. Specifically, we introduce perturbations to Co in Eq. 2\n$C_t = C_0 + \u03c3_t(\u03b5 + \u03bb_t\u03be)$,\nwhere $\u03bb_t$ is the weight of perturbation. The training objective remains $q_\u03c3(C_t|C_0)$, but the input is set to $C_t$ to take into account different conformations other than the ground truth, which is detailed in Algorithm 3. The generation process remains unchanged, as shown in Algorithm 1. This asymmetric procedure thus allows the trajectories to stick closer to the ground truth despite potential biases during generation. Here, we also follow the routine as in [15] and use a uniform noise level by setting $\u03bb_t$ = \u03bb for perturbation, independently of t, to avoid the complexity of training it twice. This is notable that since we only perturb the input, the rotational and translational equivariance is not affected. \u03bb is empirically set using a grid search on both QM9 and Drugs on a small range of values covering the last half of the sampling trajectory (as in Fig.1), which has usually the largest impact on the performance."}, {"title": "V. EXPERIMENTS", "content": "Following CGCF [10], we use the GEOM-QM9[18] and GEOM-Drugs[19] datasets for our experiments. The GEOM-QM9 dataset, derived from the QM9 dataset, com- prises 133,258 molecules, each containing an average of 9 heavy atoms per molecule. The GEOM-Drugs dataset has 304,466 molecules, each containing an average of 24.9 heavy atoms per molecule. We adopt the data partitioning method introduced in ConfGF [11] and GeoDiff [13], where 40,000 molecules are sampled for the training set. For each molecule, we select 5 conformations with low energy, resulting in a total of 200,000 conformations in the training set. The test set consists of 200 molecules. As the partitioning method for training set and test set of Tor. Diff. differs from that of typical deep learning models, we have therefore retrained the model.\nWe compare our method with state-of-the-art deep learning models. Specifically, they include VAE based CV-GAE [8], GraphDG [9] and ConfVAE [26], Continuous Flow based CGCF [10], GeoMol [27], DPM-based GeoDiff [13], SGM-based ConfGF[11], DGSM[12], and Torsional Diffusion [14]. We denote our input perturbation with the {-IP to indicate their relationship to the baseline methods. For example, the input perturbation of ConfGF is refered to as ConfGF-IP."}, {"title": "B. Conformation Comparison", "content": "We compare the quality of generated conformations. In our experiments, we generate twice the number of confor- mations as in the test set. To measure the difference between true and generated conformations, we employ the Root Mean Square Deviation (RMSD) for the heavy atoms:\n$RMSD(C, \\hat{C}) = \\underset{\\Phi}{min} \\sqrt{\\frac{1}{n}\\sum_{i=1}^{n}||\\Phi(C_i) \u2013 \\hat{C_i}||^2}$,\nwhere $n$ is the number of heavy atoms, $\\Phi$ is an alignment function using Kabsch algorithm[28], $C$ and $\\hat{C}$ are the sets of real and generated samples respectively. Following CGCF [10], we utilize the Coverage (COV) and Matching (MAT) to measure diversity and accuracy respectively, which can be defined as:\n$COV (S_g, S_r) = \\frac{|\\{C \u2208 S_r | RMSD(C, \\hat{C}) < \u03b4, \\hat{C} \u2208 S_g\\}|}{|S_r|}$,\n$MAT(S_g, S_r) = \\frac{1}{|S_r|} \\sum_{C \u2208 S_r} \\underset{\\hat{C} \u2208 S_g}{min} RMSD(C, \\hat{C})$,\nwhere $S_r$ is the set of conformations derived from real data, and $S_g$ is the set of generated conformations. A higher COV indicates greater diversity, while a smaller MAT signifies more accurate conformations. The threshold \u03b4 was set to 0.5\u00c5 for GEOM-QM9 and 1.25 \u00c5 for GEOM-Drugs."}, {"title": "C. Ablation Study", "content": "To demonstrate the effectiveness of the Input Perturba- tion method for SGMs, we conduct experiments on both distance-based ConfGF in the Euclidean space and torsion- angle based Torsional Diffusion. In addition, we conduct experiments on the conformation-based GeoDiff, a represen- tative of DPMs, as a reference to compare the performance enhancement on the two types of models.\nThe quality of conformation generation using IP is compared for three baseline models as shown in Tab. IV. In both Euclidean space and torsional angle space, the Input Perturbation method consistently improve the accuracy and diversity of the conformation.\nFuthermore, the experiments have confirmed that compared with the IP-based DPMs, we have achieved a considerable enhancement in the performance enhancement with IP-based SGMs."}, {"title": "Property Prediction", "content": "The task of property prediction in- volves predicting molecular ensemble properties [19] over a set of generated conformations. We sample 30 new molecules from the QM9 dataset and generate 50 conformations for each molecule. Quantum chemistry calculations are per- formed to compute the energy E, HOMO-LUMO gap \u0394\u03b5 for each conformation. For ConfGF-IP and GeoDiff-IP, we follow ConfGF [11] and GeoDiff [13] to calculate using Psi4 [29]. For Torsional Diffusion-IP, we follow Torsional Diffu- sion [14] and use GFN2-xTB[30]. Subsequently, we compare the average energy E, lowest energy Emin, average gap \u0394\u03b5, minimum gap \u0394\u025bmin, and maximum gap A&max with the corresponding ground truth values. The mean absolute error (MAE) is used to measure the accuracy of ensemble property prediction. As shown in Table V, our model significantly outperforms the baselines regarding all five properties."}, {"title": "VI. CONCLUSION", "content": "In this paper, we propose a method that estimates the exposure bias in SGMs used for molecular conformation generation, which is caused by the discrepancy existing between the inputs of the training and generating phases in the diffusion model, which is originally exhibited in DPMs. Based on the confirmation of the exposure bias, we adapt the bias compensation algorithms Input Perturbation for DPMS to SGMs, which significantly improve both accuracy and diversity of the generated molecular conformations. This demonstrates the necessity of alleviating such accumulated bias in the conformation generation and our method has extended both the concept of this type of systematic bias and an effective approach for their compensation."}]}