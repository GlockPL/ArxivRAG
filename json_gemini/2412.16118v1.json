{"title": "Convolutional Deep Operator Networks for Learning Nonlinear Focused Ultrasound Wave Propagation in Heterogeneous Spinal Cord Anatomy", "authors": ["Avisha Kumar", "Xuzhe Zhi", "Zan Ahmad", "Minglang Yin", "Amir Manbachi"], "abstract": "Focused ultrasound (FUS) therapy is a promising tool for optimally targeted treatment of spinal cord injuries (SCI), offering submillimeter precision to enhance blood flow at injury sites while minimizing impact on surrounding tissues. However, its efficacy is highly sensitive to the placement of the ultrasound source, as the spinal cord's complex geometry and acoustic heterogeneity distort and attenuate the FUS signal. Current approaches rely on computer simulations to solve the governing wave propagation equations and compute patient-specific pressure maps using ultrasound images of the spinal cord anatomy. While accurate, these high-fidelity simulations are computationally intensive, taking up to hours to complete parameter sweeps, which is impractical for real-time surgical decision-making. To address this bottleneck, we propose a convolutional deep operator network (DeepONet) to rapidly predict FUS pressure fields in patient spinal cords. Unlike conventional neural networks, DeepONets are well equipped to approximate the solution operator of the parametric partial differential equations (PDEs) that govern the behavior of FUS waves with varying initial and boundary conditions (i.e., new transducer locations or spinal cord geometries) without requiring extensive simulations. Trained on simulated pressure maps across diverse patient anatomies, this surrogate model achieves real-time predictions with only a 2% loss on the test set, significantly accelerating the modeling of nonlinear physical systems in heterogeneous domains. By facilitating rapid parameter sweeps in surgical settings, this work provides a crucial step toward precise and individualized solutions in neurosurgical treatments.", "sections": [{"title": "Introduction", "content": "Spinal cord injury (SCI) often leads to significant physiological issues following the initial trauma, including prolonged reduced blood flow to the injury site (hematoma) (Quadri et al. 2020). Current treatments, like surgical decompression, cannot precisely restore blood flow to the hematoma for optimal healing (Lonjaret et al. 2014; Ahuja et al. 2017). Focused ultrasound (FUS) therapy offers a targeted solution by generating acoustic pressure to enhance localized blood flow directly to a focal region (Hwang et al. 2021; Tsehay et al. 2022; Morishita et al. 2014; Hong et al. 2022). When administering FUS therapy, clinicians must ensure that the focal region of the resulting FUS pressure distribution maximally overlaps with the hematoma with minimal exposure to surrounding tissue for optimal therapeutic benefit. However, predicting FUS pressure fields in the spinal cord relative to transducer positions is difficult due to its complex geometric variations and acoustic heterogeneity that cause beam distortion (Kumar et al. 2023b)."}, {"title": "Computational Bottleneck", "content": "Computer simulations that numerically solve the governing FUS wave propagation equations can determine the pressure distribution through patient-specific spinal cord anatomy using ultrasound images (Treeby et al. 2018; Kumar et al. 2023a). This pressure distribution is crucial for non-invasively inferring the biological effects of a specific transducer placement, especially when treating a sensitive organ such as the spinal cord. To achieve optimal therapeutic results, all possible source locations along the region of interest in the spine must be evaluated. However, these predictions cannot be made prior to surgery, as a laminectomy is required to remove surrounding vertebral bone and create an acoustic window for ultrasound imaging. Other imaging methods, such as magnetic resonance imaging (MRI) and computed tomography (CT), do not adequately capture all the soft tissues within the spinal cord that have varying acoustic properties, which are essential for accurate simulations. Since these simulations can take several minutes to hours per patient, it is important to develop a faster method for solving the FUS wave equations in patient-specific spinal cord to support timely intraoperative decision-making.\nPrevious works in predicting ultrasound behavior includes physics-informed neural networks (PINNs) on ultrasound acoustic wave data to simulate regions with surface-breaking cracks and PINNs for transcranial ultrasound wave propagation (Wang et al. 2023; Shukla et al. 2020). These methods embed physical constraints of the acoustic wave equation into the loss equation of their models to ensure that predictions align closely with the underlying physics, improving accuracy in scenarios where direct measurements or high-quality imaging data may be limited (Raissi, Perdikaris, and Karniadakis 2019). While these approaches address the limitations of data-driven models that require extensive, diverse training datasets and overcome the challenges of traditional mesh-based methods\u2014such as time-intensive calculations for high-dimensional problems\u2014they must be retrained for each new input domain. This retraining is impractical for FUS treatment planning, as each patient's spinal cord geometry is unique, especially after sustaining an injury."}, {"title": "Operator Learning for PDES", "content": "Neural operator learning is a framework for learning mappings between infinite-dimensional function spaces, such as the solution generators for systems of partial differential equations (PDEs). This approach differs from traditional neural networks, which are designed to learn mappings between finite-dimensional vector spaces. By learning the underlying relationships between input functions (initial and boundary conditions) and their corresponding PDE solutions, neural operators aim to generalize across families of PDEs without requiring retraining for each new configuration (Kovachki et al. 2023).\nMathematically, a neural operator $G_\\theta$ maps an input function space $U(\\Omega; \\mathbb{R}^{d_u})$ to an output function space $V(\\Omega; \\mathbb{R}^{d_v})$, as follows:\n$G_\\theta : U(\\Omega; \\mathbb{R}^{d_u}) \\rightarrow V(\\Omega; \\mathbb{R}^{d_v}),$ (1)\nwhere $\\Omega \\subset \\mathbb{R}^d$ represents the spatial domain and $a \\in A$ parametrizes its shape. The parameters of the neural operator, $\\theta \\in \\Theta$, are optimized during training. The dimensions $d_u$ and $d_v$ refer to the sizes of the input and output function spaces, which may be subspaces of Sobolev spaces or spaces of continuous functions. These function spaces provide a broad mathematical setting for applications where the PDE solutions vary smoothly or have certain regularity properties.\nThe true solution operator $G$ is approximated by $G_\\theta$ using training data in the form of input-output pairs, ${U_i, V_i}_{i=1}^N$, where $u_i \\in U$ represents an input function, and $v_i = G(u_i) \\in V$ is the corresponding PDE solution. These pairs are typically generated from high-fidelity numerical simulations of the governing equations. For example, in modeling focused ultrasound (FUS) pressure fields in the spinal cord, $U$ may represent the initial and boundary conditions of the acoustic wave equation in a patient-specific spinal cord geometry, while $V$ corresponds to the resulting pressure distribution in the tissue.\nBy learning a direct mapping from inputs to solutions, neural operators can predict the solution to a PDE without solving it numerically, offering significant computational advantages. This makes them well-suited for applications requiring rapid predictions, such as real-time surgical planning for FUS treatment."}, {"title": "Proposed Framework", "content": "The proposed network architecture used in this work combines convolutional neural networks (CNNs) (Anwar et al. 2018) and deep operator networks (DeepONets) (Lu et al. 2021) to learn a generalizable mapping between images of the spinal cord anatomy and transducer/source location (input functions) and the resulting pressure fields across the spatial domain after FUS sonication (output functions). Trained on simulated pressure maps from diverse patient anatomies, the proposed model predicts pressure distributions across varying spinal cord geometries in real-time, achieving just 2% error on the test set. While operator learning has been explored in medical contexts (Loeffler et al. 2024; Zhou et al. 2024; Yin et al. 2022), this paper introduces its application for real-time optimization of neurosurgical interventions."}, {"title": "Methods", "content": ""}, {"title": "Data Generation", "content": "Learning a surrogate model to accelerate simulations requires an abundantly diverse and expressive training dataset, with both input images and corresponding ground truth simulation results. To train our neural operator, we generated simulated pressure maps using 1,000 sagittal B-mode ultrasound images of the thoracic spinal cord from 25 porcine subjects, captured both before and after contusion injuries (Kumar et al. 2024). Each image (25.6mm \u00d7 8.1mm) displayed anatomical structures with varying acoustic properties, including the dorsal space, dura, cerebrospinal fluid (CSF), pia, spinal cord, ventral space, and injury site (Figure 1A). Ground truth masks for these soft-tissue regions were used to define the computational domain to generate patient-specific acoustic phantoms of the spinal cords (Figure 1B).\nFor some images, due to the acquisition angle or the severity of injury, the anatomical boundaries between the dura, CSF, and pia or between the ventral dura and ventral space were indistinct. In these cases, the regions were grouped and labeled as the dura/pia complex or dura/ventral complex, respectively."}, {"title": "Computer Simulations", "content": "We use k-wave, a MATLAB toolbox for modeling acoustic wave propagation, to generate the simulated pressure maps (Treeby et al. 2018). By solving a system of first-order partial differential equations (PDEs) computationally equivalent to the generalized Westervelt equation, k-Wave is designed to account for nonlinearities introduced to wave propagation caused by high magnitude acoustic waves common in biomedical ultrasonics. The framework also models acoustically heterogeneous media, such as the spinal cord, where sound speed and ambient density vary spatially. The governing PDEs (Equations 2 \u2013 4) are solved at each time step via pseudo-spectral methods to obtain the pressure of the system at each grid location,\n$\\frac{\\partial u}{\\partial t} = -\\frac{1}{\\rho_0}\\nabla p,$ (2)\n$\\frac{\\partial \\rho}{\\partial t} = -(2\\rho + \\rho_0)\\nabla \\cdot u - u \\cdot \\nabla \\rho_0,$ (3)\n$p = c_0^2(\\rho + d \\cdot \\rho_0 + \\frac{B \\rho^2}{2A \\rho_0} - L \\rho),$ (4)\nwhere u is the acoustic particle velocity, p is the acoustic pressure,$\\rho$ is the acoustic density,$\\rho_0$ is ambient density, $c_0$ is the sound speed, and d is the acoustic particle displacement."}, {"title": "Network Architecture", "content": "Our proposed network architecture features a convolutional DeepONet, which is well suited for our problem given that we have a fixed rectangular domain $\\Omega$ for all training samples. In this context, we allow the pressure distributions from the FUS simulations to depend on 2 critical parameters:\n1. The unique spinal cord geometry of each patient which prescribes the acoustic heterogeneity in the parametric PDE.\n2. The specific transducer locations at which the pressure field is evaluated.\nTo account for these dependencies, our model incorporates two branch networks to encode the input function space and one trunk network to encode the output domain. The branch networks process patient-specific geometric and source-specific information, while the trunk network encodes the grid locations of the output pressure distribution.\nLet the governing wave equation be represented succinctly by:\n$\\mathcal{L}(p; u, z) = f, \\text{ in } \\Omega,$\nwhere:\n\u2022  $p \\in V(\\Omega)$ is the acoustic pressure distribution,\n\u2022  $u \\in U_1$ represents the patient-specific spinal cord geometry (e.g., anatomical masks),\n\u2022  $z \\in U_2$ represents the transducer location parameters (e.g., $(x, y)$),\n\u2022  $\\Omega \\subset \\mathbb{R}^2$ is the rectangular computational domain.\nThe neural operator approximates the solution operator $G : U_1 \\times U_2 \\rightarrow V$, such that:\n$p = G(u, z).$\nThe complete network architecture (depicted in Figure 2) consists of the following components:\n\u2022 Branch Network 1: A CNN with three convolutional layers, which encodes the patient-specific spinal cord geometry u. The CNN processes segmented anatomical masks from ultrasound images and outputs a latent representation $g_{geo} \\in \\mathbb{R}^q$.\n\u2022 Branch Network 2: A fully connected neural network (FCNN) with three hidden layers, which encodes the transducer location z. This network outputs a latent representation $g_{src} \\in \\mathbb{R}^r$.\n\u2022 Trunk Network: A fully connected neural network (FCNN) with three hidden layers, which encodes the grid locations $x \\in \\Omega$. The output of the trunk network is a spatial representation $h_{spatial} \\in \\mathbb{R}^s$.\nThe outputs of the branch and trunk networks are combined using a Hadamard product, resulting in a continuous representation of the predicted pressure map:\n$p(x) \\approx G_\\theta(u, z) (x) = \\sum_{i=1}^n (g_{src, i} \\cdot g_{geo, i}) h_{spatial, i} (x).$\nThe model is trained using simulation data generated by k-Wave, with the goal of minimizing the relative $L_2$ loss:\n$L = \\frac{||P_{pred} - P_{true} ||_2}{||P_{true} ||_2}.$\nThe Adam optimizer with a step-based learning rate schedule is employed for training. By efficiently approximating the operator G, this architecture maps patient-specific anatomical features and transducer parameters to acoustic pressure distributions. This enables rapid parameter sweeps, facilitating optimal source placement for treatment.\nWe compare the proposed operator network against two baseline models to evaluate performance in predicting pressure maps in heterogeneous spinal cord anatomy. The first baseline is a CNN model, similar to the branch net in the DeepONet architecture, consisting of three convolutional layers with additional layers for upsampling the output to match the dimensions of the expected simulation. The second baseline is a Fully Convolutional Network (FCN) with regression, a deep learning architecture typically designed for dense, pixel-wise prediction tasks, such as semantic segmentation, where continuous values are predicted for each pixel (Long, Shelhamer, and Darrell 2015; Sofka et al. 2017)."}, {"title": "Results", "content": "After developing the simulation training data and the task-specific deep learning models for predicting FUS pressure maps, each model was evaluated on unseen patient spinal cord geometries in the test set. The results are summarized in Table 3, with our proposed neural operator model outperforming the other deep learning models with only a 2% loss in the test set evaluated against all 8 locations (Figure 4). The visualization of the predictions made by the proposed neural operator model is presented in Figure 3. We also assessed the performance of CNN and FCN models trained on a single source location as a baseline comparison against the DeepONet model. From the test loss and prediction results (Figure 5), it is evident that the baseline CNN model fails to learn FUS pressure distributions in new spinal cord anatomy, with a loss of 64% even when trained on a single source location. Although the baseline FCN model trained on a single source location achieves a low loss of 2%, it proves impractical for location sweeps without embedding the source location into its architecture (69% loss).\nAdditionally, we compare the time required to generate 8 pressure maps using predictions from the proposed model versus high-fidelity numerical solutions computed with k-Wave on a macOS system equipped with an Apple M1 chip, featuring an 8-core CPU with 4 performance cores and 4 efficiency cores, 8-core GPU, and 8 GB of unified memory. This benchmarking provides insights into the computational efficiency of the model on consumer-grade hardware. Our findings indicate that the inference on our model takes 0.05 seconds, while obtaining the pressure maps using the numerical solver k-Wave, takes 76.1 total minutes (Table 4)."}, {"title": "Discussion", "content": "Numerical modeling is a promising tool for approximating the behavior of physical systems in complex media by solving the governing physical equations iteratively in a specified computational grid. These simulations allow clinicians to infer the biological effects of FUS in patient-specific anatomy, providing valuable insight in individualized treatment planning (i.e., where to place the source). However, the computational demands of these simulations limit their utility for real-time parameter sweeps needed to optimize intraoperative decision-making. High-fidelity ultrasound simulations using traditional finite difference and finite element methods require a resolution of 10 mesh points per acoustic wavelength (Zingg, Lomax, and Jurgens 1996). This results in prohibitively large computational grids, especially when modeling high-frequency biomedical transducers operating in the MHz range. This challenge is particularly significant in the context of spinal cord injury, where preoperative ultrasound imaging is not feasible until vertebral bone removal, requiring simulations to be performed intraoperatively. While MRI and CT imaging are available, they fail to provide adequate soft-tissue delineation required for the acoustic solvers. Ultrasound imaging, on the other hand, inherently captures the acoustic differences within the spinal cord, which are crucial for accurately predicting the propagation of the nonlinear FUS beam.\nOur proposed neural operator architecture, which integrates CNNs and DeepONets, demonstrates the ability to learn the solution operator for nonlinear FUS wave propagation in heterogeneous, patient-specific spinal cord anatomy, enabling real-time prediction of pressure maps. Unlike traditional neural networks which excel at finding patterns in data, operator learning frameworks provide a more principled approach that results in a model which respects the underlying continuous structure of the true PDE solution generator. This allows for predictions to be made based on various input functions without need for retraining or running expensive simulations repeatedly. In this case, the nonlinear operator is the mapping from a space of functions (patient spinal cord geometry) to another space of functions (acoustic pressure distribution). Accelerating FUS simulations can be transformative across several medical domains, such as glioblastoma or deep vein thrombosis, offering a novel approach to optimize ultrasound transducer placements for targeting tumors or blood clots while minimizing exposure to adjacent healthy tissue (Zhou 2011).\nWhile a FCN can learn pressure distributions across the spinal cord for a single source location with model loss comparable to the proposed approach, it lacks the ability to generalize effectively across multiple source locations. As a result, it is unsuitable for parameter sweeps to determine the optimal source location. To achieve comparable generalization capabilities with this architecture, it would require training with source location embeddings, likely increasing the computational and resource burden. This limitation is further exacerbated by the fact that the baseline FCN model is more than 4 times larger than the proposed neural operator (Table 2).\nOur proposed model efficiently and accurately learns the relationship between patient-specific anatomy and the corresponding in vivo pressure distribution for various transducer placements. The online computing time of this network is over 91,000 times faster than traditional simulations (Table 4), demonstrating the practical applicability of operator learning in surgical medicine, particularly for optimizing the use of therapeutic ultrasound.\nGiven the similarities in soft-tissue morphology, vasculature, and immune response after injury between porcine and human spinal cord anatomy, we anticipate that this model can generalize effectively to the human spinal cord (Toossi et al. 2021). Fine-tuning the final layers with human data would further enhance its performance and applicability. Moving forward, we aim to enhance this model by integrating a segmentation model into the preprocessing pipeline, replacing the use of the soft-tissue masks as inputs. This improvement will streamline intraoperative decision-making by eliminating the need for the tedious and manual segmentation currently required. Future efforts will focus on adapting the model to accept raw ultrasound images as inputs to the branch network instead of segmented masks, while maintaining high performance. Additionally, we plan to expand the training and evaluation process to include human spinal cord images, enhancing the clinical utility of this tool."}, {"title": "Conclusion", "content": "The deployment of advanced computational models in predictive ultrasound modeling holds potential to revolutionize personalized treatment planning by dramatically enhancing time efficiency and enabling scalable parameter sweeps at a fraction of the computational cost. Traditional numerical models, while highly accurate and physics-based, face a critical limitation: each new input, such as transducer location or patient anatomy, requires a complete recomputation of the solution, a computational luxury that cannot be afforded in time-sensitive environments like the operating room. In this paper, we introduced a deep operator network capable of predicting nonlinear focused ultrasound pressure maps in patient-specific, heterogeneous spinal cord anatomy, offering a paradigm-shifting approach to accelerating intraoperative treatment planning. With the advent of high-resolution ultrasound imaging and the increasing interest in focused ultrasound therapy for noninvasive treatments, the application of deep learning to develop efficient surrogate models can have far-reaching implications in healthcare, including tumor ablation and blood clot removal. This work underscores the immense promise of AI-driven solutions to address critical challenges in clinical decision-making and treatment optimization."}]}