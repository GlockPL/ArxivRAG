{"title": "JingFang: A Traditional Chinese Medicine Large Language Model of Expert-Level Medical Diagnosis and Syndrome Differentiation-Based Treatment", "authors": ["Yehan Yang", "Tianhao Ma", "Ruotai Li", "Xinhan Zheng", "Guodong Shan", "Chisheng Li"], "abstract": "Traditional Chinese medicine (TCM) plays a vital role in health protection and disease treatment, but its practical application requires extensive medical knowledge and clinical experience. Existing TCM Large Language Models (LLMs) exhibit critical limitations of uncomprehensive medical consultation and diagnoses, and inaccurate syndrome differentiation-based treatment. To address these issues, this study establishes JingFang (JF): a novel TCM Large Language Model that demonstrates the expert-level capability of medical diagnosis and syndrome differentiation-based treatment. We innovate a Multi-agent Dynamic Collaborative Chain-of-Thought Mechanism (MD-CCTM) for medical consultation, enabling JF with effective and accurate diagnostic ability. In addition, a Syndrome Agent and a Dual-Stage Retrieval Scheme (DSRS) are developed to significantly enhance the capacity of JF for disease treatment based on syndrome differentiation. Jing-Fang not only facilitates the application of LLMs but also promotes the effective practice of TCM in human health protection and disease treatment.", "sections": [{"title": "1. Introduction", "content": "Recently, the emergence of Large Language Models(LLMs) such as GPT-4(Achiam et al., 2023; Hurst et al., 2024), Llama3(Dubey et al., 2024), Deepseek-MOE(Dai et al., 2024a), Deepseek v2(Liu et al., 2024), and Qwen2.5(Yang et al., 2024a) has significantly advanced the field of natural language processing. These models not only possess exceptional language comprehension and generation capacity(Zhao et al., 2024), but also demonstrate strong cross-domain adaptability(Li et al., 2023; Bui et al., 2024; Thirunavukarasu et al., 2023) by integrating techniques such as pre-training(Han et al., 2021), fine-tuning(Ding et al., 2023), reinforcement learning(Cao et al., 2024), human feedback alignment(Yu et al., 2024), and knowledge graph retrieval(Wang et al., 2024). Among the numerous cross-domain applications of LLM, TCM has become one of the key focuses due to its importance in protecting human health and treating diseases(Lu et al., 2004; Zou et al., 2023; Ma et al., 2019), while the complexity of diagnosis and treatment of TCM poses a significant challenge.\nIn recent years, several studies have made some meaningful attempts, e.g. Zhongjing(Yang et al., 2024b), TCMChat(Dai et al., 2024b), Qibo (Zhang et al., 2024), BianCang (Wei et al., 2024), MedChatZH(Tan et al., 2024), etc. However, the critical limitations of the effective application of LLM in the diagnosis and treatment of TCM still remain. Unlike Western medicine, the core characteristic of TCM lies in its emphasis on treatment based on syndrome differentiation, which requires physicians to implement comprehensive medical diagnosis and accurately analyze symptoms and signs in patients. The diagnosis of TCM, which is the foundation for syndrome differentiation and treatment, is largely based on multiple rounds of personalized consultation to precisely collect patient information, which is complicated and uncertain. The scarcity of large-scale, accurately labeled multi-round consultation data leads to not good enough performance of existing models in extracting chief complaints of patients, mining symptoms, precise syndrome differentiation, and treatment. Additionally, current TCM LLMs lack explicit control over the diagnostic reasoning and decision process, which affects the model's interpretability and reliability. Existing models still have limitations in adaptability, scalability, flexibility, and maintenance cost, making it difficult to quickly adapt to changing diagnostic scenarios or different TCM knowledge systems.\nTo address these critical challenges and limitations, the main contributions of this work are summarized below:\n1. We develop JF: An expert-level medical diagnosis and syndrome differentiation-based treatment TCM LLM based on an innovative framework that integrates the technology of LLM Agent (Huang et al., 2024), Chain-of-Thought (CoT)(Chu et al., 2023), and Retrieval-Augmented Generation (RAG)(Gao et al., 2023) to significantly improve the completeness and precision of the model in medical consultation and syndrome differentiation-based treatment, addressing limitations of existing TCM models and empowering practical applications of LLM in TCM.\n2. A Multi-agent Dynamic Collaborative Chain-of-Thought Mechanism (MDCCTM) is invented to enable JF with dynamic reasoning and explicit decision-making capabilities for medical consultation. According to the mechanism, multiple agents with various TCM specialties are established and dynamically collaborate to conduct professional consultation for comprehensive information collection and accurate syndrome differentiation-based treatment.\n3. A Syndrome Agent and a Dual-Stage Retrieval Scheme (DSRS) is trained and developed correspondingly based on the preconditioned multilevel knowledge of TCM, which significantly improves JF's abilities of TCM syndrome differentiation and treatment in practical application"}, {"title": "2. Framework of JingFang", "content": "In this section, we introduce the framework of the proposed JingFang (referred to as the JF framework). As shown in Figure 1, the JF framework is designed to consist of three main modules: TCM Consultation, TCM Syndrome Differentiation, and TCM Treatment Reconmmendation, according to the authentic process of TCM diagnosis and treatment. JF works well based on the process in the framework, following the designed MDCCTM and DSRS to fulfill the professional and accurate diagnosis and treatment.\nTCM Consultation Module mainly involves the following steps:\n\u2460 Expert Team Construction: The Medical Record Agent summarizes the patient's symptoms and basic information for generating the chief complaint. Based on the chief complaint, the relevant TCM Specialist Agents and a TCM General Agent are gathered to form the TCM expert team for the diagnosis.\n\u2461 Consultation Construction: Each agent in the expert team constructs a consultation CoT based on their professional knowledge and the patient's current medical condition, incorporating multiple follow-up questions to ensure the consultation process is logical and progressively in-depth.\n\u2462 Consultation Integration and Evaluation: Based on the consultation CoT provided by each agent, the Summary Agent integrates and evaluates the questions and key points within to form a summary of the consultation CoT.\n\u2463 Consultation Analysis and Optimization: Each agent in the expert team further analyzes the summary and proposes modification suggestions to the summarized consultation CoT, then sends them back to the Summary Agent until all the expert agents agree to officially begin the consultation.\n\u2464 Multi-Round Consultation: Based on the optimized consultation CoT, the TCM Consultation Agent conducts multiple rounds of consultation to further clarify the patient's condition and collect vital information for diagnosis and treatment.\nTCM Syndrome Differentiation Module is mainly for exact syndrome differentiation. Once sufficient key information is gathered from the consultation module, the trained TCM Syndrome Agent integrates and analyzes the data to determine the patient's syndrome type for the accurate treatment of diseases.\nTCM Treatment Recommendation Module provides professional and targeted treatment recommendations for patients. The Treatment Agent is generated through a DRS to provide personalized treatment suggestions based on the patient's syndrome type and the patient's condition. For a detailed description of each module construction see Sec.3."}, {"title": "3. Method", "content": "In this section, we introduce the innovative and well-structured MDCCTM, DSRS, and the trained Syndrome Agent in detail."}, {"title": "3.1. Multi-agent Dynamic Collaborative Chain-of-Thought Mechanism", "content": "After an in-depth study of the TCM consultation process, we found that experienced TCM experts typically pre-set one or two follow-up consultation questions based on the patient's known condition, and make flexible and targeted adjustments to them based on more information during the consultation process. Inspired by this, the MDCCTM is developed to better fit the actual TCM consultation process, and the prompts: $prompt[]$ here, are particularly designed to facilitate agents to implement the specific functions. The MDCCTM can be formulated as follows:"}, {"title": "3.1.1. TCM EXPERT TEAM CONSTRUCTION", "content": "For comprehensive and targeted medical consultation, an Expert Agents Database consisting of TCM General Agents and TCM Specialist Agents from various fields including TCM internal medicine, surgery, gynecology, pediatrics, and so on, is constructed before medical consultation.\nWhen the consultation begins, a TCM Medical Record Agent summarizes the symptoms and basic information of the patient to generate the chief complaint M. According to M, a Manager Agent selects the relevant TCM Specialist Agent from the database to address the personal needs of patients. Each specialist expert $edi$ possesses the respective knowledge $Ked_i$, thus the TCM specialist agents domain corresponding to expert $edi$ can be represented via a mapping function $f_{LLM}$ as follows:\n$SD_i = f_{LLM}(M, Kedi, promptsd).$  (1)\nTo ensure the comprehensiveness of consultation CoT, the expert team for consultation is supplemented with a TCM General Agent $GD = gd, Kg$, containing one TCM general expert $gd$ and the TCM general knowledge $Kg$. Therefore, the TCM expert team is constructed as:\n$Team(M) = \\{SD, GD\\},$  (2)\nwhich ensures both the pertinence and comprehensiveness of the consultation. The expert team for consultation is established only once during the consultation process for each patient."}, {"title": "3.1.2. CONSULTATION COT CONSTRUCTION", "content": "To start the CoT construction at the t-th round of consultation, the TCM Medical Record Agent summarizes the patient's current condition $Cont$ from the current multi-round consultation result that is defined as: $C_t = \\{(Q_k, A_k) | k \u2208 [0, t]\\}$, where $Q_k, A_k$ is the question and the corresponding answer at k-th round of consultation. Thus, $Cont$ can be defined as:\n$Cont = Agen_{rm}(C_t, prompt_{rm}).$ (3)\nEach expert in the consultation expert team prioritizes 1-2 subsequent consultation CoT questions with explanations based on the current consultation result $C_t$, offering theoretical guidance for future consultations. Specifically, according to $C_t$, the TCM Specialized Agent $SD_i$ utilizes an LLM in conjunction with professional knowledge and specific prompts $prompt_{qa}$ to generate a consultation CoT $qait$ at t-th round of consultation:\n$q_{ait} = CoT_{sp} (C_t, SD_i, prompt_{qa})$ (4)\nMeanwhile, the TCM General Agent GD incorporates the TCM general knowledge to generate a comprehensive consultation CoT $g_{at}$:\n$g_{at} = CoT_{gen} (C_t, GD, prompt_{ga})$ (5)\nThe expert team's consultation CoT is constructed by combining the $q_{ait}$ and $g_{at}$ at t-th consultation :\n$TCOT_t = (q_{ati}, g_{at})$ (6)\nThis consultation CoT lays the foundation for subsequent consultation processes. In the following steps, the expert team iteratively revises and optimizes $TCoT_t$ to make the consultation process more refined and targeted."}, {"title": "3.1.3. CONSULTATION COT INTEGRATION AND EVALUATION", "content": "Integrating the widely used classical framework Ten Ques-tions Song(Hong et al., 2011) (TQS) that helps doctors assess the patient's condition from multiple dimensions, we establish a Consultation CoT Evaluation Algorithm (CCEA). To evaluate the comprehensiveness of the questions, we calculate the similarity of questions in the consultation CoT with those in the TQS as the score of comprehensiveness by using an embedding model. To evaluate the pertinence of the questions, the key issues of each expert (different TCM experts focus on the characteristic diseases and diagnostic points related to their specialty, e.g., internal medicine focuses on organ function) and the patient's known condition are incorporated as the basis for the pertinence score. The final score is obtained by aggregating these two scores to evaluate the consultation quality.\nBased on the patient's current condition $Cont$ and $TCoT_t$, an Evaluation Agent is designed to summarize the consultation CoT provided by the expert team and evaluate the consultation questions within the summarized consultation CoT via the TCM knowledge-based CCEA. Thus, a holistic consultation CoT $RCoT_{to}$ serves as the summary of the expert team's consultation CoT that includes the score for each question generated as:\n$RCoT_{to} = CoT_{sum}(TCoT_t, Cont, promptr)$ (7)"}, {"title": "3.1.4. CONSULTATION COT ANALYSIS AND OPTIMIZATION", "content": "Agents in the expert team further analyze the summary $RCoT_{to}$ based on the evaluation results, and provide feedback on whether they agree with it or not. If an expert disagrees, it will provide modification suggestions for low-score questions and optimize the consultation CoT to get a higher score calculated by CCEA. Through this optimization and feedback process, the TCM expert team ensures that the consultation CoT is both comprehensive and targeted. Specifically, in j-th round of feedback, expert suggestions are recorded as $Mod_j$ and the summary $RCoT_{tj}$ is updated as follows:\n$RCoT_{tj} = CoT_{opt}(RCoT_{t(j\u22121)}, Mod_{tj},promptr)$ (8)\nThe integration and optimization process continues until all experts agree on the summary or the maximum number of feedback rounds is reached, a final Consultation CoT $RCoT_{tf}$ is generated to start the official consultation in this round."}, {"title": "3.1.5. MULTI-ROUND CONSULTATION", "content": "Based on the consultation CoT $RCoT_{tf}$ and the current multi-round consultation result $C_t$ in the t-th round, a Consultation Agent is developed according to real-world consultation scenarios to generate the next round of consultation questions:\n$Q_{t+1} = Q_{gen}(RCoT_{tf}, Cont, prompt_{q}),$ (9)\nand interact with the patient. After this, the Medical Record Agent is called to systematically integrate the patient's condition into $Rec_t$, which is\n$Rec_t = Agen_{in}(M, RCoT_{tf}, Cont, prompt_{in}).$ (10)\nFollowing this process, a series of professional and targeted questions is generated to further explore the patient's condition. When the key information collected in the record of the patient is completed or the maximum number of consultation rounds is reached according to the Consultation Information Collection Algorithm3, the Medical Record Agent presents the final case $Rec_f$ to the next Syndrome Differentiation and Treatment Recommendation Module."}, {"title": "3.2. TCM Syndrome Agent", "content": "In the field of TCM, the accuracy of syndrome differentiation is the cornerstone of precise treatment. High-quality datasets are essential for LLMs to develop accurate syndrome differentiation capabilities. We observed that real-world TCM medical records and diagnostic data often contain a large amount of information unrelated to the patient's condition, i.e., noise, which cannot be easily removed through conventional regularization techniques. For example, phrases such as \"The patient visited our hospital for further integrated traditional Chinese and Western medicine treatment\" or \"The patient was advised to undergo cranial CT and blood tests but refused\" are not only irrelevant to the core condition but also interfere with the model's ability to focus on key disease-related information. At the same time, content in the medical record, such as \"Blood amylase test showed no significant abnormalities and abdominal CT indicated slight thickening of the ascending colon wall\", which requires medical instrument examinations, also needs to be screened out.\nAccording to the TQS, it helps TCM experts to comprehensively understand the patient's symptoms, medical history, and physical signs through a series of fundamental questions, providing key information for precise diagnosis. Inspired by this, we propose a universal data preprocessing method by utilizing LLM to automatically extract key information related to the TQS from raw data and strictly retain core information closely related to the patient's condition. This ensures alignment between the case outputs in the JF and the format of the training data cases, aiming to significantly enhance the accuracy of syndrome differentiation through more systematic and precise data processing.\nTo enable JF with TCM syndrome differentiation ability and smoothly complete accurate syndrome differentiation tasks within its framework, we particularly develop a TCM Syndrome Agent based on the fine-tuned LLM. Moreover, according to the final patient's condition summary from the multi-round consultation $Rec_f$, the TCM Syndrome Agent is used to identify the most likely syndrome type for the patient:\n$TCMs = Syndif(Rec_f, Cont, prompts,).$  (11)\nThe detailed description of syndrome differentiation database preconditioning and model fine-tuning see Sec.B.1 and Sec.B.2 respectively in the appendix."}, {"title": "3.3. TCM Treatment Agent", "content": "In TCM diagnosis and treatment, treatment recommendations are essentially formulated from the perspective of syndrome differentiation. In addition, TCM experts also integrate various aspects of a patient's information, including chief complaints, medical history, and constitution, dynamically adjusting treatment plans in response to changes in the patient's condition to ensure precise treatment. This complicated and changeable procedure is a characteristic of TCM treatment but poses a challenge to the precise treatment of LLMs. To facilitate LLMs with accurate and targeted treatment recommendations ability, a Dual-Stage Retrieval Scheme (DSRS) is proposed to offer the exact and targeted treatment recommendation. Here is the algorithm of DSRS, and the detailed introduction of it see Sec.C in the appendix.\nAccording to DSRS, a TCM Treatment Agent that utilizes the patient's condition summaries and syndrome differentiation results derived from multiple rounds of consultation is developed to automatically screen and recommend the most suitable prescriptions from a structured TCM prescription database:\n$TCMt = Treatgen(Rec_f, DBT_{CM},prompt_p).$  (12)\n$DBT_{CM}$ represents the delicately constructed TCM prescription database containing various TCM fields, including internal medicine, gynecology, pediatrics, and surgery. Each entry in the database includes essential information such as disease categories, syndrome types, clinical manifestations, representative formulas, commonly used herbs, and other therapeutic methods. Fig.3 illustrates an example of the performance of the TCM Treatment Agent, and for more information see Sec.E.4 in the appendix."}, {"title": "4. Experiments", "content": "In this section, we explore JF's advantages and limitations in practical applications via a series of systematic experiments. We demonstrate the performance of JF in different tasks from two core aspects: the accuracy of TCM syndrome differentiation and the effectiveness of multi-round TCM consultation. A detailed explanation of the evaluation methods and results is also provided."}, {"title": "4.1. Baseline Model", "content": "To comprehensively evaluate the performance of JF, we selected several representative open-source TCM models, i.e., Zhongjing-7B(Yang et al., 2024b), Mingyi-7B(Liao et al., 2024), Shenlong-7B(Wei Zhu & Wang, 2023), and Sun Simiao-7B(Xin Yan, 2023), as baselines. Moreover, we incorporate two state-of-the-art LLMs i.e., GPT-4o(Hurst et al., 2024) (one of the most advanced LLMs) and Qwen-Max(Team, 2024) (a leading Chinese-language LLM) for comparison. Various evaluation metrics are designed to ensure a comprehensive and fair assessment. Different tasks employed task-specific evaluation criteria, enabling a multi-dimensional analysis of the performance of JF."}, {"title": "4.2. Assessment of Syndrome Differentiation Accuracy", "content": "We have preprocessed over 63,000 real diagnostic data entries to select over 43,000 high-quality data entries for LLM fine-tuning. Based on this data, the Qwen2.5-7B-Instruct model and the Roberta model are taken respectively as the foundation model of JF for training its syndrome differentiation ability. Here, syndrome differentiation can also be considered as a classification task, thus we train it via these two different types of models. For the evaluation of TCM syndrome differentiation accuracy, we select 8,699 real-world TCM cases as the test dataset, covering 170 different syndrome types. Considering the imbalance in sample sizes across different categories, we use weighted evaluation metrics to assess the model's performance in various categories. The metrics include weighted precision: $P_w$, weighted recall: $R_w$, and weighted F1: $F1_w$, which are as follows:\n$P_w = \\frac{\\sum_{i=1}^{n} w_i \\cdot TP_i}{\\sum_{i=1}^{n} w_i \\cdot (TP_i + FP_i)},$ (13)\n$R_w = \\frac{\\sum_{i=1}^{n} w_i \\cdot TP_i}{\\sum_{i=1}^{n} w_i \\cdot (TP_i + FN_i)},$ (14)\n$F1_w = \\frac{\\sum_{i=1}^{n} w_i \\cdot TP_i}{\\sum_{i=1}^{n} w_i \\cdot (TP_i + 0.5 \\cdot (FP_i + FN_i))}.$ (15)\nHere, n is the number of TCM syndrome categories. $w_i$ represents the weight of the i-th category, which is calculated as the number of samples in category i divided by the total number of samples. $TP_i$ is the number of true positives for category i, $FP_i$ is the number of false positives for category i, and $FN_i$ is the number of false negatives for category i."}, {"title": "4.3. Medical Consultation Evaluation", "content": "For the evaluation of medical consultation ability, we randomly selected 100 cases from real TCM medical cases. These cases involve a variety of clinical conditions, which comprehensively reflect the diversity and complexity of TCM consultation. Based on these cases, an LLM is used to act as the patient and interact with JF and each baseline model to complete multi-round consultation, collecting the patient's medical information.\nTo professionally assess the capacity of medical consultation in multi-round consultation, multiple TCM experts are invited to score the models' performance from 0-10 points respectively based on four dimensions: Proactiveness, Accuracy, Practicality, and overall effectiveness, with a total score of 40 points. (For the specific evaluation criteria for each dimension, refer to Sec.A.) The evaluation in each dimension carefully considers the model's key abilities, such as proactiveness in gathering patient information and the model's responsiveness to the patient's actual needs in TCM consultations."}, {"title": "4.4. Ablation Experiment", "content": "To assess the effectiveness of key components within the JF framework, we conducted an ablation study focusing on its multi-round consultation capabilities and dataset applicability. By systematically comparing different framework configurations and evaluating performance on real-world TCM cases, this experiment provides insights into the contributions of the TCM General Agent and the robustness of the constructed TCM syndrome differentiation dataset."}, {"title": "4.4.1. EVALUATION OF TCM GENERAL AGENT IN MEDICAL CONSULTATION", "content": "To evaluate the impact of the combination of TCM Specialist Agent and TCM General Agent in MDCCTM on multi-round medical consultation and to analyze the key role and contributions of the TCM General Agent, this study compares two configurations: JF without TCM General Agent and JF with TCM General Agent, systematically analyzing their differences in performance in multi-round consultation.\nA total of 100 representative TCM cases were selected from real medical records to ensure data typicality and diversity, enhancing the clinical applicability of the experiment. The selection criteria included:\n1. Information completeness: Each case must contain comprehensive medical history, including chief complaints, present illness, past medical history, and family history.\n2. Diversity: The dataset includes various TCM syndrome types, ensuring that findings are applicable across different pathological conditions.\nTo maintain experimental control and standardization, we developed an LLM-based patient agent to simulate patient responses in multi-turn consultations. The patient agent was designed with the following constraints:\n1. Strict adherence to case details to ensure responses align with actual patient conditions.\n2. Concise and precise responses, avoiding unnecessary verbosity that could interfere with analysis.\n3. Responses limited to doctor consultations, following real patient response patterns.\nThese constraints ensure stability and consistency in patient interactions, minimizing external variability."}, {"title": "4.4.2. APPLICABILITY ASSESSMENT OF THE TCM SYNDROME DIFFERENTIATION DATASET", "content": "This ablation experiment is designed to demonstrate the effectiveness and applicability of our proposed method and constructed data for TCM syndrome differentiation and explore the influence of different foundation models (or the model with different sizes of parameters) on syndrome differentiation. We chose multiple representative open-source LLMs to test, which include the Qwen-2.5 series (Qwen-2.5-3B-Instruct, Qwen-2.5-7B-Instruct, Qwen-2.5-14B-Instruct) (Yang et al., 2024a), the DeepSeek series (DeepSeek-7B-Chat)(DeepSeek-AI, 2024), and the Llama series (Llama3.1-8B-Instruct) (Dubey et al., 2024).\nAs shown in Figure 5, all models in the test exhibit advanced performance in TCM syndrome differentiation compared to their original version before being trained via our method and data. According to the results, we observe that the choice of foundation model is not the key factor for improving the syndrome differentiation ability, while the method and data do. Moreover, compared to the performance of GPT-4o (0.4328), the results highlight the potential applicability and value of the proposed TCM syndrome differentiation method and dataset for future research. For a detailed description of the ablation experiment, refer to Sec.D."}, {"title": "5. Conclusion and Discussion", "content": "In this paper, we develop JingFang, a novel TCM LLM with expert-level capability, especially in medical diagnosis and syndrome differentiation-based treatment. The proposed model not only overcomes the key limitations of current TCM models but also enhances the applications of LLM in the TCM domain. To achieve professional medical consultation ability, the Multi-agent Dynamic Collaborative Chain-of-Thought Mechanism (MDCCTM) is innovated, integrating multiple agents with different TCM specialties to accord with the real-world medical consultation process. The MDCCTM facilitates JF with dynamic reasoning and explicit decision-making capabilities, enabling it to carry out comprehensive and targeted medical consultation, avoiding the omission of critical information, thereby laying a solid foundation for accurate diagnosis. In addition, a TCM Syndrome Agent is trained with preprocessed and structured multi-level TCM data, significantly enhancing JingFang's ability of TCM syndrome differentiation based on patients' complaints and condition. In the tests based on real medical records, the precision of syndrome differentiation of JF has improved greatly (by at least 50%), especially compared to the existing models. To achieve personalized and precise TCM treatment, the Dual-Stage Retrieval Scheme is established for the hybrid retrieval and extraction of TCM knowledge at both fine and coarse-grained levels. As a result, JingFang's treatment capability based on syndrome differentiation has made a remarkable breakthrough, enabling it to provide tailored and proficient treatment recommendations for patients and promoting the practical application of LLMs in the field of TCM.\nMoreover, continuing to deeply explore the potential application of the multi-agent collaborative mechanism and enhancing the innovative application of LLMs in different fields will be interesting. At the same time, in the field of TCM LLM, developing advanced multi-modal TCM large models to promote more efficient application of TCM, will also be very meaningful."}, {"title": "Impact Statement", "content": "This paper presents work that advances the application field of LLMs, particularly in the TCM domain. The proposed model can greatly improve the efficiency of doctors in medical diagnosis and treatment. However, in addition to existing ethical questions for this area (e.g. inaccurate content, bias, toxicity), our model cannot completely replace the role of doctors in the real clinical practice of TCM. Due to individual differences in patients and the complexity of real medical scenarios, specific diagnoses and treatments require careful adherence to the advice of real doctors."}, {"title": "A. TCM Consultation", "content": "To enable efficient consultation with the patient, we propose an \"Intelligent Dynamic Consultation Information Collection and Termination\u201d Algorithm. This algorithm automatically collects key points from the consultation CoT through a limited number of consultation rounds and automatically terminates the dialogue based on this consultation CoT when specific conditions are met. Based on TCM consultation knowledge, the key points are categorized into four types: symptom information, medical history information, lifestyle information, and other information, which helps to systematically extract crucial details. The algorithm's inputs include the maximum consultation rounds, patient inputs, and the consultation CoT, and through these inputs, it generates a set of key points and drives the conversation forward. Finally, the algorithm outputs the collected set of medical information points.\nThe core logic of the algorithm ensures the consultation continues through an infinite loop until termination conditions are met. To ensure the effective collection of diagnostic information, the algorithm maintains the set of medical information points and updates this set according to the progress of the consultation, determining whether to terminate the dialogue. In addition, the algorithm defines two additional algorithms: one to obtain the set of key points to collect and the other to update the set of information points based on the patient's input. These two auxiliary algorithms are executed through agents defined by prompts. The detailed methodology is presented in Algorithm 3."}, {"title": "B. TCM Syndrome Differentiation", "content": "B.1. Dataset Construction for Syndrome Differentiation\nDuring the construction of the syndrome differentiation dataset, we observed that real-world TCM case and diagnostic data often contain a substantial amount of information irrelevant to the patient's condition, which cannot be easily removed through regularization techniques. For instance, phrases such as \"The patient visited our hospital for further integrated traditional Chinese and Western medicine treatment\" or \"The patient was advised to undergo cranial CT and blood tests but refused\" are not only extraneous to the core condition but also hinder the model's ability to focus on key information about the illness. Moreover, the raw TCM case and diagnostic data frequently exhibit a high degree of redundancy in describing the patient's condition and physical signs, resulting in a low density of valid information, which adversely impacts fine-tuning performance and the generalization ability of LLMs.\nTo address these issues, we proposed a universal syndrome differentiation data cleaning method based on the TCM framework of the \"Ten Questions Song.\" This strategy aims to simulate the professional judgment of TCM experts using LLMs, accurately screening and reconstructing raw TCM case and diagnostic data to construct a high-quality syndrome differentiation dataset. Specifically, this approach strictly retains core information closely related to the patient's condition, optimizes the medical value of the data, and organizes the content systematically according to the \"Ten Questions Song\" framework to ensure the dataset includes key elements required for TCM syndrome differentiation. Through this strategy, we effectively eliminate redundant information, increase the structuralization of the data, and better adapt it to the application requirements of LLMs in TCM syndrome differentiation tasks.\nAs shown in Figure 6, the data-cleaning process enforces strict adherence to the \"Ten Questions Song\" framework by applying explicit data extraction rules, retaining only information directly related to the patient's condition. A comparison of the raw TCM case and diagnostic data with the cleaned dataset (Preconditioned TCM Data) reveals that the cleaned records are more focused on core symptoms, physical signs, and the evolution of the condition. Unrelated information is systematically removed, resulting in texts that are both precise and medically valuable. The core optimization points of this method include the following:\n1. Removal of non-essential medical information: Exclude content unrelated to the diagnostic process, such as procedural details, examination recommendations, and results from modern medical instruments. Retain only symptoms and signs directly relevant to syndrome differentiation analysis.\n2. Reduction of redundant descriptions and enhancement of information density: By simplifying repetitive records, the medical texts become more concise, improving data validity and utilization efficiency.\n3. Strengthening the comprehensiveness and pertinence of syndrome differentiation dataset: Comprehensiveness is reflected in the inclusion of all key consultation dimensions from the TCM \"Ten Questions Song,\" such as cold/heat, sweating, head/body, bowel movements, diet, sleep, medical history, and family history, ensuring the completeness of diagnostic criteria. Pertinence is achieved by prioritizing the retention of information related to core elements of syndrome differentiation (e.g., chief complaints, symptom changes, disease progression, and physical signs) while removing background or secondary information. This makes the dataset more aligned with the logic of TCM syndrome differentiation, thereby improving the accuracy of LLMs in clinical reasoning."}, {"title": "B.2. Model Training for Syndrome Differentiation", "content": "Based on the syndrome differentiation data-cleaning method proposed in this study, a total of over 43,000 high-quality syndrome differentiation data entries were obtained. These entries were split into training and testing datasets at a ratio of 8:2. Subsequently, the Qwen2.5-7B-Instruct model was fine-tuned using the LoRA method. The form of the training dataset is shown in Figure 7. In the experiments, we employed four A6000 GPUs (each with 48GB of memory). After multiple rounds of experimental tuning, we determined the optimal training parameters to ensure the stable convergence of the loss function. The specific training parameters included: \"lora rank\": 64, \"lora alpha\": 16, \"learning rate\": \"5e-4\", and \"batch size\": 16.\nGiven that the syndrome differentiation task in this study can be treated as a classification problem, and Encoder-only architectures (such as BERT and RoBERTa) generally outperform Decoder-only architectures in classification tasks, we further trained lightweight syndrome differentiation models based on RoBERTa. In these experiments, a new classification layer was added to RoBERTa model, with its output dimension matching the number of task categories. The classification layer was trained from scratch, and fp16 mixed precision training was used to reduce memory usage and improve training efficiency. The training loss is shown in Figure 8."}, {"title": "C. TCM Treatment Recommendation", "content": "Syndrome differentiation-based treatment is one of the core concepts in TCM. The fundamental idea is to identify the etiology and pathogenesis of a patient's condition and then adopt a personalized treatment strategy. Different diseases may present similar syndrome differentiation; for instance, the syndrome of wind-cold attacking the lungs may manifest not only in the common cold but also in acute bronchitis. Therefore, experienced TCM practitioners often rely on the results of syndrome differentiation, integrating the patient's medical history and constitution, to provide individualized treatment recommendations. This study employs a Dual-Stage approach to recall relevant TCM treatment knowledge based on the TCM formula dataset we have constructed.\nIn the first stage, the system screens candidate prescription data related to the patient's syndrome type from the TCM prescription database based on the differentiation outcomes. This screening process utilizes the patient's syndrome differentiation information, including syndrome type, etiology, and disease location, to narrow down the candidate prescriptions to those highly relevant to the patient's condition, thereby ensuring the pertinence and effectiveness of subsequent treatment recommendations. In the second stage, the system employs an embedding method to vectorize the patient's detailed medical history information and the clinical manifestations of the candidate prescriptions, subsequently calculating the similarity between them. This method allows for the assessment of how well the candidate prescriptions match the patient's condition. Finally, based on similarity rankings, the top three cases most similar to the patient's medical history information are selected (TOP-3). These \"top three most similar cases\u201d refer to cases that closely resemble the current patient's condition across multiple dimensions, including syndrome differentiation information, medical history, and symptom presentation. The detailed methodology is presented in Algorithm 4."}, {"title": "D. More Information of Ablation Experiment", "content": "D.1. Details of the Evaluation of TCM General Agent in Medical Consultation\nTo evaluate the impact of the combination of TCM Specialist Agent and TCM General Agent in MDCCTM on multi-round medical consultation and to analyze the key role and contributions of the TCM General Agent", "configurations": "JF without TCM General Agent and JF with TCM General Agent, systematically analyzing their differences in performance in multi-round consultation.\nA total of 100 representative TCM cases were selected from real medical records"}]}