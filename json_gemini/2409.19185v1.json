{"title": "Semi-Supervised Bone Marrow Lesion Detection from Knee MRI\nSegmentation Using Mask Inpainting Models", "authors": ["Shihua Qin", "Ming Zhang", "Juan Shan", "Taehoon Shin", "Jonghye Woo", "Fangxu Xing"], "abstract": "Bone marrow lesions (BMLs) are critical indicators of knee osteoarthritis (OA). Since they often appear as small,\nirregular structures with indistinguishable edges in knee magnetic resonance images (MRIs), effective detection of\nBMLs in MRI is vital for OA diagnosis and treatment. This paper proposes a semi-supervised local anomaly detection\nmethod using mask inpainting models for identification of BMLs in high-resolution knee MRI, effectively integrating a\n3D femur bone segmentation model, a large mask inpainting model, and a series of post-processing techniques. The\nmethod was evaluated using MRIs at various resolutions from a subset of the public Osteoarthritis Initiative database.\nDice score, Intersection over Union (IoU), and pixel-level sensitivity, specificity, and accuracy showed an advantage\nover the multiresolution knowledge distillation method\u2014a state-of-the-art global anomaly detection method. Especially,\nsegmentation performance is enhanced on higher-resolution images, achieving an over two times performance increase\non the Dice score and the IoU score at a 448x448 resolution level. We also demonstrate that with increasing size of the\nBML region, both the Dice and IoU scores improve as the proportion of distinguishable boundary decreases. The\nidentified BML masks can serve as markers for downstream tasks such as segmentation and classification. The proposed\nmethod has shown a potential in improving BML detection, laying a foundation for further advances in imaging-based\nOA research.", "sections": [{"title": "1. DESCRIPTION OF PURPOSE", "content": "Bone marrow lesions (BMLs) are painful alterations in subchondral bone due to repetitive microdamage at the articular\nsurface. They serve as key structural indicators for the onset and progression of knee osteoarthritis (OA)1,2. Accurate\ndetection of BMLs is crucial for the treatment and prevention of knee OA. In knee magnetic resonance imaging (MRI),\nBMLs often appear in irregular shapes and vary widely in size among different subjects, making manual labeling a\nstriving effort compared to labeling other structures. In addition, BMLs within the femur bone visually resemble\nstructured noise in knee MRI, which further increases difficulty in achieving manual segmentations in data of large\npopulations\u00b3.\nAnomaly detection, a technique that identifies unexpected and abnormal items that deviate from normally distributed\nsamples, has been widely used in medical imaging. Chatterjee et al.4 introduced an unsupervised anomaly detection\n(UAD) pipeline for detecting abnormalities in brain MRI using a context-encoder variational autoencoder (ceVAE)5,\nwhere a VAE was trained on healthy images with a context-encoder restoring masked images. To segment retinal fluid\nin optical coherence tomography images, the first Generative Adversarial Network (GAN)-based system, AnoGAN,6\nwas proposed for unsupervised anomaly detection, which introduced a novel inverse-mapping scheme that mapped high-\ndimensional normal images to a latent space representation. Most generative model-based UAD systems for medical\nimaging, such as ceVAE and AnoGAN, have limited ability to generate high-resolution medical images due to data\nlimitations and computational expense. Salehi et al.7 proposed the Multiresolution Knowledge Distillation (MKD)\nmethod for anomaly detection. Instead of generating healthy images, MKD enables better transfer of knowledge from\nthe pre-trained expert network to the cloner network, focusing on features that distinguish normality from anomalies.\nAnother method for generating healthy images is mask inpainting, which is a powerful image restoration technique used\nto remove unwanted structural elements from images. This principle can be effectively applied to medical imaging\nwhere anomalies are distributed in a noisy pattern. Instead of generating a complete image, mask inpainting focuses on\nreconstructing specific regions of interest (ROI) based on the context outside the masked area, thus improving the\nquality of generated images for anomaly detection. However, the use of inpainting for anomaly detection has not been\nextensively explored in BML detection applications.\nIn this paper, we propose a semi-supervised anomaly detection framework based on mask inpainting techniques to detect\nBMLs, as illustrated in Figure 1. Unlike a conventional UAD system, this approach requires a femur bone mask as ROI\nfor training on healthy images with masked regions. A generative model is then trained to inpaint the masked region.\nDuring prediction, an input image with anomalies in the femur bone is translated to one with a healthy femur bone\nregion. Post-processing steps are applied to generate the final BML segmentation. The proposed pipeline is not fully\nunsupervised due to the need for femur bone masks. However, femur bone segmentation is an easy task due to its simple\nand regular shapes as demonstrated by high Dice coefficient (96.94%) in our previous work8. Our proposed method\navoids detecting anomalies on the full image and instead focuses on specific regions, preventing information loss that\noccurs when images are resampled to a lower resolution due to the difficulties in generating high-resolution images."}, {"title": "2. METHOD", "content": "In this work, we used an open dataset from the Osteoarthritis Initiative (OAI) sponsored by the National Institutes of\nHealth. The knee MRI dataset comprises images from 210 subjects for training, each containing approximately 36 knee\nintermediate weighted fat-suppressed (IWFS) image slices, as well as images from 45 subjects for validation and 45\nsubjects for testing. The femur bone masks for the training set and the BML masks for the validation and test sets were\nannotated by trained medical professionals using a semi-automated tool.\nTo generate the femur bone mask, we applied U-Net++9 as a one-stage 3D semantic segmentation model. This model\nwas trained on a dedicated training set, utilizing data augmentation techniques to enhance performance. Specifically, the\n3D volumes were randomly cropped into 256x256x16 patches. During testing, the masks were generated in 3D and\nsubsequently split into 2D slices for further processing. This step achieved an ideal segmentation performance with an\naverage Dice coefficient of 94.34%. For inpainting, we utilized a resolution-robust large mask inpainting model\n(LaMa) 10 based on a GAN structure with a generator and a discriminator. The generator employs fast Fourier\nconvolutions (FFCs)\u00b9\u00b9 to expand the receptive field. FFC is based on channel-wise fast Fourier transform (FFT) which\nallows the model to have a wide receptive field from the early layers and enables efficiency of high-resolution images\ninpainting. During training, the 3D images were split into 2D slices, and we selected slices without BMLs paired with\ntheir manually annotated femur bone masks. Thus, the LaMa model was trained on 2D slices from normal knee MRIs\nwithout BMLs. Each slice was resized to different resolutions for various experiments. The input image includes a\nmanually annotated bone mask and a knee MRI with the femur bone masked, resulting in a two-channel input. Data\naugmentation techniques, such as random vertical and horizontal flipping, and random bias field12 augmentation, were\napplied to enhance model robustness.\nDuring testing, the input image x is masked by the generated bone mask m and get masked image $x \\otimes m$. Stacked\nwith mask m, we have two-channel input: stack($x \\otimes m$, m). We applied histogram equalization to enhance global\ncontrast of input x and output $\\hat{x}$, and get enhanced images $x' = HE(x)$ and $\\hat{x'} = HE(\\hat{x})$. Next, we performed a\nsubtraction between the reconstructed and original images to create a difference map. As BMLs tend to appear brighter\nthan the surrounding marrow, we zeroed out negative values, thus getting the final difference map $D(x', \\hat{x'}) = [\\hat{x'} - x']_{+}$.\nTo generate binary anomaly mask, each output slice was processed using Otsu's method13. After Otsu's thresholding, we\nget an initial binary mask m. Due to the presence of noise in knee MRIs, the subtraction operation cannot effectively\nlocate these noises, resulting in the mask m containing some very small and discontinuous structures. Therefore, a\nmorphological opening filter is used to remove small structural noise from the binary mask and a morphological closing\nis applied to fill small holes in the detected BMLs, refining the final anomaly mask. Notably, all the hyperparameters\nwere determined using a validation dataset."}, {"title": "3. RESULTS", "content": "To test the proposed method's ability to predict high-resolution images when trained on low-resolution data, we\nresampled the original MRI images to different resolutions. We compared the results using average Dice score, average\nIntersection over Union (IoU), pixel-level sensitivity, specificity, and accuracy. Additionally, we compared our method\nwith the state-of-the-art anomaly detection method MKD, which has achieved high performance in various medical\nanomaly detection tasks\u00b94. Quantitative comparison results between our method and MKD are shown in Table 1. The\noverall results in Dice and IoU are low, not only because BML segmentation is challenging due to their small size and\nlow contrast from the surrounding marrow, but also because we did not remove other anomalies besides BML. It also\nindicates that global detection methods such as MKD struggle on detection on high-resolution images. Even when using\nbone masks to constrain the location of detected anomalies, MKD results were unsatisfactory. Our method outperforms\nMKD, indicating that higher-resolution images improve segmentation performance, as reflected by higher Dice and IoU\nscores. Specifically, the original image size of 448x448 achieved the highest Dice of 0.42 and IoU of 0.30, compared to\nthe lowest input size of 128x128 that only achieved a Dice of 0.32 and IoU of 0.21. Sensitivity showed limitations with\naround 60%, as BML is a low-contrast lesion in IWFS MRI. This issue is particularly prominent near the boundary\nbetween BML and surrounding marrow, leading to a poor overlap between the predicted BML mask and the manually\nlabeled mask, especially for small BMLs with a large portion on the boundary. Although the quantitative results are\nlimited, the qualitative results shown in Figure 2 demonstrate that our method can accurately localize BMLs, even when\nthey are small, as seen in case 1. We separated the test data into five groups based on BML area, which indicate that\ndifferent BML sizes yield varying outcomes. As shown in Figure 3, with increasing BML size, both Dice and IoU scores\nimproved, as the proportion of distinguishable boundary decreases."}, {"title": "4. CONCLUSIONS", "content": "In this paper, we presented a semi-supervised anomaly detection system for detecting BMLs in high-resolution knee\nMRIs. Utilizing a combination of a high-performance 3D femur bone segmentation model, a mask inpainting model, and\npost-processing techniques, we aimed to address the challenges of segmenting BMLs, which are often small and difficult\nto distinguish from the surrounding bone marrow. The method was evaluated using knee MRIs at various resolutions,\nshowing an overall advantage over the MKD, especially at segmenting higher-resolution images. The proposed method\nhas the potential to improve BML detection, and the detected masks could serve as valuable markers for future tasks\nsuch as 3D segmentation or classification."}, {"title": "5. NEW WORK TO BE PRESENTED", "content": "In the full manuscript, we will provide a more comprehensive discussion of our results, including a detailed comparison\nwith other anomaly detection methods to highlight why our approach is superior. We will provide more examples, both\nvisually and quantitatively, on the results using our method and the comparison method. We will also analyze the\nperformance differences in depth and support our findings with extensive visualizations."}]}