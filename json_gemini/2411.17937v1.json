{"title": "Spatio-temporal Causal Learning for Streamflow Forecasting", "authors": ["Shu Wan", "Reepal Shah", "Qi Deng", "John Sabo", "Huan Liu", "K. Sel\u00e7uk Candan"], "abstract": "Streamflow plays an essential role in the sustainable planning and management of national water resources. Traditional hydrologic modeling approaches simulate streamflow by establishing connections across multiple physical processes, such as rainfall and runoff. These data, inherently connected both spatially and temporally, possess intrinsic causal relations that can be leveraged for robust and accurate forecasting. Recently, spatio-temporal graph neural networks (STGNNs) have been adopted, excelling in various domains, such as urban traffic management, weather forecasting, and pandemic control, and they also promise advances in streamflow management. However, learning causal relationships directly from vast observational data is theoretically and computationally challenging. In this study, we employ a river flow graph as prior knowledge to facilitate the learning of the causal structure and then use the learned causal graph to predict streamflow at targeted sites. The proposed model, Causal Streamflow Forecasting (CSF) is tested in a real-world study in the Brazos River basin in Texas. Our results demonstrate that our method outperforms regular spatio-temporal graph neural networks and achieves higher computational efficiency compared to traditional simulation methods. By effectively integrating river flow graphs with STGNNs, this research offers a novel approach to streamflow prediction, showcasing the potential of combining advanced neural network techniques with domain-specific knowledge for enhanced performance in hydrologic modeling.", "sections": [{"title": "I. INTRODUCTION", "content": "Streamflow forecasting [1] is essential for sustainable water resource management. Accurate predictions of streamflow rates are crucial for various applications, including flood forecasting, water supply management, and ecological preservation. Yet, streamflow forecasting presents a significant challenge due to the inherently nonlinear nature of hydrologic processes and the complex spatio-temporal dynamics that govern these systems. These dynamics are influenced by various forcing variables, such as weather conditions, surface topography, soil type, and vegetation.\nSpatio-temporal graph neural networks (STGNNs [2]) have recently received much attention, demonstrating strong performance in modeling spatio-temporal data. STGNNs start by defining a spatio-temporal graph (STG) where each node represents an instance in space and time. Spatial convolution layers are employed to capture spatial correlations among these nodes, while temporal convolution layers are used to model the temporal dependencies across different time steps. This approach has shown great success in multiple challenging real-world applications, such as smart transportation, climate forecasting, and pandemic prediction.\nEven though STGNNs have proven effective in modeling spatio-temporal data, this approach faces unique challenges in their application to the domain of hydrology due to their dependence on spatial correlations, making them vulnerable to out-of-distribution shifts. Consider for example the water data analyzed in this study (Figure 1), which comes from the Brazos River basin in Texas: The goal is to forecast future streamflow rates at target stations using the so-called forcing data from other stations within the basin.\n\u2022 Upstream-Downstream Order: In such scenario, for accurate streamflow forecasting, it is crucial to consider the directionality of water flow in the river network. For instance, a heavy rainfall event upstream can lead to increased streamflow downstream after a certain time lag. Unfortunately, STGNNs do not incorporate directionality effectively and, consequently, may incorporate information from downstream stations when predicting streamflow at upstream locations, which may be ineffective in this context: for instance, if human activities, such as dam construction, intervene a downstream station, this should not influence the predicted upstream streamflow rates.\n\u2022 Drainage Area Subordinations: The drainage area of a river basin is the region from which all precipitation flows to a common outlet. Stations within the same drainage area are hydrologicly connected, whereas stations from different drainage areas have no direct hydrologic connection. Understanding how different sub-areas contribute to the streamflow at various points in the basin wold help in building more accurate predictive models. Yet, STGNNS might overemphasize spatial proximity in forecasting: For example, they may try to exploit spatial correlations between geographically proximate stations that, in reality, belong to different drainage areas, resulting in inaccurate predictions.\nMachine learning-based spatio-temporal forecasting models typically make predictions by learning a mapping from historical data to future observations without explicitly considering the underlying physical processes. This approach may work"}, {"title": "II. BACKGROUND AND RELATED WORKS", "content": "In this study, we focus on streamflow forecasting in the Brazos River Basin, the second-largest river basin in Texas, covering a drainage area of 116,000 square kilometers. The basin's namesake river is the 14th longest in the United States, originating from the headwaters at Blackwater Draw in Roosevelt County and flowing to its mouth at the Gulf of Mexico. The Brazos River has the largest average annual flow volume in Texas (Figure 1). Streamflow forecasting has evolved significantly over the past decade, including advancements in process-based hydrologic modeling, data-driven machine learning models, physics-informed machine learning techniques to causal-guided machine learning approaches. Each approach offers unique strengths and faces distinct challenges in accurately predicting streamflow."}, {"title": "III. PROBLEM FORMULATION", "content": "In this section, we develop the necessary notations and formally define the spatio-temporal graph forecasting problem, followed by the introduction of the causal adjacency matrix used in our model."}, {"title": "A. Spatio-temporal Graph Forecasting", "content": "Spatio-temporal graph forecasting aims to predict future values at multiple spatial locations over time by modeling both spatial and temporal dependencies. Formally, we define a STG as a graph $G = (V, E)$, where $V = {V_1, V_2, . . ., V_n}$ represents the set of nodes, and $E$ is the set of edges representing relationships between these nodes. The spatial dependencies among the nodes are encoded in the adjacency matrix $A \\in \\mathbb{R}^{n\\times n}$, where a non-zero element $a_{ij}$ indicates a direct connection between nodes $v_i$ and $v_j$.\nLet $X_t = [X_{1,t}, X_{2,t},..., X_{n,t}] \\in \\mathbb{R}^{n\\times d}$ denote the dynamic feature matrix at time step $t$, where $x_{i,t} \\in \\mathbb{R}^d$ represents the dynamic features of node $i$ at time $t$, such as precipitation, temperature, and land use data. Additionally, let $S = [S_1, S_2,..., S_n] \\in \\mathbb{R}^{n\\times p}$ represent the static feature matrix, where $s_i \\in \\mathbb{R}^P$ corresponds to the static features of node $i$, such as elevation and soil type.\nIn this study, we introduce a hierarchical grouping structure. Each node $i \\in {1,2,..., n}$ is assigned to a specific group within a hierarchy $G = {g_1,g_2,...,g_m}$, where the function $Group(i) = g_j$ assigns node $i$ to group $g_j$. This hierarchical grouping captures sub-drainage areas or regional hydrological divisions that play a critical role in streamflow dynamics.\nThe goal of spatio-temporal forecasting in this study is to predict future streamflow rates $Y_{t+1}$ based on past streamflow rates $Y_{t-T:t}$, historical dynamic observations $X_{t-T:t}$ and static features $S$, over a time window $T$. The spatial dependencies encoded in the adjacency matrix $A$ and the hierarchical group structure $G$are also considered in the prediction function, as shown in Eq. (1):\n$\\widehat{Y}_{t+1} = f(Y_{t-T:t}, X_{t\u2212T:t}, S, A, G),$ (1)"}, {"title": "B. Causal Adjacency Matrix", "content": "The above problem formulation relies on an adjacency matrix as input. In this work, we construct this adjacency matrix in a causally informed manner. In particular, the causal adjacency matrix $A$ is based on the river flow graph generated based on the hydrologic principles. A non-zero entry $a_{causal}$ in $A$ indicates station $v_i$ is upstream and has direct connection to station $v_j$. This design ensures that the model respects the directionality and drainage hierarchy within the basin."}, {"title": "IV. PROPOSED APPROACH", "content": "The proposed model, Causal Streamflow Forecasting (CSF), involves a two-stage physically-aware hierarchical network designed to integrate both local and global hydrologic processes for accurate streamflow forecasting (Figure 3). This approach is divided into two main stages, station-level modeling and basin-level modeling, with each stage addressing different aspects of the forecasting problem."}, {"title": "A. Two-Stage Physically Aware Hierarchical Modelling", "content": "The two-stage design mimics the traditional process-based VIC-CaMa-Flood model (Figure 2). The station-level model, acting as a local model, aims to learn a latent runoff embedding. Meanwhile, the basin-level model, serving as a global model, uses a Spatio-temporal Graph Convolutional Network (STGCN) [2] as its backbone and is guided by the river flow graph to learn spatio-temporal dependencies causally.\n1) Stage 1: Station-level Modeling: In the first stage, a station-level model is developed to predict runoff using local forcing variables. These variables include weather data (such as precipitation and temperature), soil characteristics, and elevation data. The station-level model captures the dynamic hydrologic processes affecting each monitoring station. We use a Variational Autoencoder (VAE) [28] as the backbone of the station-level model due to its capability of learning complex distributions and capturing the variability in the input data. The latent embedding learned by the VAE is termed the \"runoff embedding\u201d to mimic the runoff process in hydrology. This embedding effectively represents the underlying factors influencing runoff at each station.\nA reconstruction loss is employed to guide the training of the VAE, along with the Evidence Lower Bound (ELBO) and regularization terms. The reconstruction loss ensures that the VAE can accurately reconstruct the input forcing variables from the latent space. The ELBO combines the reconstruction loss and a regularization term to ensure the learned latent space follows a predefined prior distribution, typically a standard normal distribution:\n$L_{station} = E_{q_{\\phi}(z|x)} [log p_{\\theta} (x|z)] \u2013 D_{KL}(q_{\\phi}(z|x)||p(z)),$ (2)\nwhere x represents the input forcing variables, z represents the latent variables (runoff embeddings), $q(z|x)$ is the approximate posterior distribution, $p_\\theta (x|z)$ is the likelihood of the data given the latent variables, $p(z)$ is the prior distribution of the latent variables, and $D_{KL}$ is the Kullback-Leibler divergence,"}, {"title": "2) Stage 2: Basin-level Modeling", "content": "In the second stage, a basin-level model is utilized to account to capture the broader spatio-temporal dynamics across the entire river basin.\nThe model uses a STGCN as the backbone, leveraging the river flow graph as the causal graph. The STGCN is designed to learn the spatio-temporal dependencies between different stations by processing the graph structure that represents the hydrologic connectivity within the basin.\nThe STGCN operates by first applying spatial graph convolutions followed by temporal convolutions. The spatial convolution at time step t for node i can be expressed as:\n$h_{ni,t}^{(l+1)} = \u03c3 \\left( \\sum_{j \\in \\mathcal{N}(i)} a_{ij} h_{nj,t}^{(l)} W^{(l)} \\right).$\nwhere $h_{ni,t}^{(l)}$ is the hidden representation of node i at layer l, $W^{(l)}$ is the spatial weight matrix for layer l, $N(i)$ is the set of neighboring nodes of i (determined by A), and \u03c3 is an activation function (e.g., ReLU). This operation aggregates information from causally relevant neighbors for each node. After the spatial aggregation, temporal dependencies are captured using temporal convolutional layers, which process the hidden representations over time:\n$h_{ni,t}^{(l+1)} = \\text{TemporalConv} \\left( h_{ni,t}^{(l)}, W^{(l)} \\right),$\nwhere $W^{(l)}$ is the temporal weight matrix for layer l, and TemporalConv represents the temporal convolution operation. By iteratively applying spatial and temporal convolutions, the STGCN can capture both the spatial relationships defined by the causal adjacency matrix A and the temporal dynamics, enabling accurate streamflow forecasting at each node in the network.\nNote that, in our design, the runoff embeddings learned in Stage 1 are passed as node embeddings in Stage 2. This integration allows the STGCN to incorporate the localized hydrologic information from each station while learning the broader spatio-temporal relationships across the basin.\nThe model's objective is to predict the streamflow rates at each station, accounting for both local and global hydrologic influences. Therefore, the prediction loss is the Mean Squared Error (MSE) between the predicted streamflow rates and the actual observed values:\n$L_{prediction} = \\frac{1}{N} \\sum_{i=1}^{N} (Y_i - \\widehat{Y}_i)^2,$(3)\nwhere $Y_i$ represents the actual streamflow rate at station i, $\\widehat{Y}_i$ represents the predicted streamflow rate, and N is the number of stations. Minimizing this loss function ensures that the predicted streamflow rates closely match the observed values, enhancing the model's accuracy.\nThe total loss function in the proposed CSF model combines the losses from both the station-level and basin-level stages to optimize the overall performance. The total loss $L_{total}$ is formulated as:\n$L_{total} = \u03bbL_{station} + (1 \u2212 \u03bb)L_{prediction},$(4)\nwhere \u03bb\u2208 [0, 1] is a hyperparameter that controls the relative contribution of each stage's losses.\nHierarchical Clustering. As the number of monitoring stations increases, the complexity of spatio-temporal dynamics grows super-exponentially, making data processing highly demanding. To address this, we leverage the hierarchical structure of stations (G) to reduce computational load and improve training efficiency. By clustering stations into hierarchical groups, we adopt a batching approach similar to [29], where shuffling occurs at the group level in each epoch. This strategy exploits the limited connectivity between distinct drainage areas, enabling efficient parallel training and reducing the overall complexity of model training."}, {"title": "V. EXPERIMENTS", "content": "The dataset used in this study comes from the Brazos River Basin and consists of five components: the river flow graph, daily meteorological forcings, daily streamflow observations, sub-drainage area subordination, and simulated runoff.\nThe 73 stations in this study are sampled from the whole basin. The river flow graph of the whole basin is generated from Digital Elevation Models (DEM) to capture the upstream-downstream relationships between the stations Figure 5. This graph serves as the basis for constructing the causal adjacency matrix A, which encodes the directional flow of water between stations.\nThe daily meteorological forcings, including precipitation, maximum temperature, minimum temperature, and wind speed, are extracted from Livneh's database [30]. This database provides near-surface gridded meteorological and derived hydrologic data for the U.S. continent (CONUS), with a daily temporal resolution spanning from 1915 to 2011, and a spatial resolution of 0.0625 degrees. For this study, we focus on the period from October 1, 1967, to September 27, 1977, comprising a total of 3,650 days. The 73 monitoring stations are located within the bounding box ranging from 29.03125\u00b0 to 34.65625\u00b0 N and 95.46875\u00b0 to 103.84375\u00b0 W.\nThe daily streamflow data is provided by the United States Geological Survey (USGS), with the same temporal resolution as the meteorological forcings. Streamflow data were capped at the 99th percentile to limit the influence of extreme values (Figure 4). The sub-drainage area subordination is determined by the Hydrologic Unit Codes (HUC), provided at HUC8 and HUC4 granularities. Finally, the runoff data is simulated using the VIC model, driven by the same meteorological forcings and calibrated by [6]."}, {"title": "B. Evaluation", "content": "1) Runoff Embedding: We design CSF as a two-stage physically aware hierarchical model to mimic the VIC-CaMa-Flood model. However, the runoff embeddings z learned in the station-level model (Figure 3a) are latent and lack direct ground truth for validation. To overcome this issue, we evaluate the learned embeddings with simulated runoff from the VIC model using the mutual k-nearest neighbor alignment metric [31].\nLet $z_i \\in \\mathbb{R}^d$ represent the runoff embedding for station i, where d is the embedding size. $r_i \\in \\mathbb{R}$ represent the simulated"}, {"title": "VI. CONCLUSION, LIMITATION AND FUTURE WORK", "content": "The CSF model consistently demonstrated superior performance across all forecasting horizons by effectively capturing spatio-temporal dependencies through its integration of the river flow graph and hierarchical network structure. The experiments showed that CSF outperforms traditional and machine learning models, achieving the highest accuracy in key metrics such as NSE, KGE, VE, and \u03c1. The ablation study confirmed the essential role of the hierarchical and river graph components. Embedding size analysis revealed"}]}