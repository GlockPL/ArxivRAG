{"title": "Registration of Longitudinal Liver Examinations for Tumor Progress Assessment", "authors": ["Walid Yassine", "Martin Charachon", "C\u00e9line Hudelot", "Roberto Ardon"], "abstract": "Assessing cancer progression in liver CT scans is a clinical challenge, requiring a comparison of scans at different times for the same patient. Practitioners must identify existing tumors, compare them with prior exams, identify new tumors, and evaluate overall disease evolution. This process is particularly complex in liver examinations due to misalignment between exams caused by several factors. Indeed, longitudinal liver examinations can undergo different non-pathological and pathological changes due to non-rigid deformations, the appearance or disappearance of pathologies, and other variations. In such cases, existing registration approaches, mainly based on intrinsic features may distort tumor regions, biasing the tumor progress evaluation step and the corresponding diagnosis. This work proposes a registration method based only on geometrical and anatomical information from liver segmentation, aimed at aligning longitudinal liver images for aided diagnosis. The proposed method is trained and tested on longitudinal liver CT scans, with 317 patients for training and 53 for testing. Our experimental results support our claims by showing that our method is better than other registration techniques by providing a smoother deformation while preserving the tumor burden\u00b3 within the volume. Qualitative results emphasize the importance of smooth deformations in preserving tumor appearance.", "sections": [{"title": "Introduction", "content": "Evaluating cancer progression in liver CT scans during patient follow-up poses a significant clinical challenge. In the healthcare workflow, practitioners compare scans taken at different times for the same patient. This process involves identifying new and pre-existing lesions in the latest scans and assessing tumor progression according to the RECIST [13] guidelines. This monitoring demands considerable effort as practitioners must recognize previously detected lesions, compare them to their counterparts in prior exams, identify any newly appearing"}, {"title": "Proposed Methodology", "content": "Let A and B represent images of the same patient captured at different time points, denoting the moving and fixed images, respectively. A and B are affinely aligned during a pre-processing step. We assume that we are equipped with a liver segmentation tool, and we note SA and SB as the 3D liver segmentation masks in images A and B, respectively. These entities are defined in a three-dimensional image space \u03a9\u2208 R\u00b3. Our objective is to determine a transformation function that aligns the segmentation SA of the moving image with the segmentation SB of the fixed image. Inspired by the previously mentioned works, we propose a new registration framework focusing on segmentation maps, illustrated in Fig. 2. The framework trains a model ge\u2081 to generate a displacement field \u00d8AB' when provided with a pair of segmentations SA and SB. Each component of AB' is a three-dimensional vector indicating the displacement of a specific voxel. Subsequently, we use a differentiable operation based on a spatial transformer network (STN) to apply this displacement field \u00d8AB' to the segmentation mask SA, resulting in S': the segmentation mask aligned with SB. To ensure effective registration, it is necessary to impose a set of constraints:\nDisplacement Field Regularity This first classical constraint penalizes the norm of the derivatives of the displacement field to ensure its local smoothness.\n$L_{smooth}(\u03a6) = ||\u2207\u03a6||^2 = \u2211_{i,j} (\\frac{\u2202\u03c6_i}{\u2202x_j})^2$ (1)\nSegmentation alignment A second constraint, Lsim, ensures alignment between the transformed mask SB' = SA + \u03a6\u0391\u0392' (SA) and the fixed mask S\u0432.\n$L_{sim} (S_B, S_{B'}) = 1 \u2212 DSC(S_B, S_{B'})$ (2)\nwhere, DSC refers here and henceforth to the Dice similarity coefficient [10]. Two additional constraints, inspired by [34,24,16], are also incorporated to prevent a trivial solution that excessively stretches the contours of SA in a non-plausible way to fit SB.\nAnti-Folding The constraint Lanti-folding, detailed in Eq. 3, prevents displacement field folding, avoiding unrealistic distortions in the image. It maintains local smoothness by ensuring non-overlapping gradient directions around each point p in the image space \u03a9.\n$L_{anti-folding}(\u03a6) = \u2211_{p\u2208\u03a9}\u2211_i (\u03b4(\\frac{\u2202^2\u03a6}{\u2202x_i^2}(p) + 1))$ (3)\nwhere, d(Q) is an indexing function that penalizes the gradient at folding points. Specifically, if Q\u2264 0, then d(Q) = 1, otherwise, \u03b4(Q) = 0.\nInverse Consistency The inverse consistency constraint Linv, detailed in Eq. 4, ensures that the predicted displacement fields are invertible and inversely consistent. Following [34]'s bidirectional approach, forward displacement fields from A to B (AB) and from B to A (\u0444\u0432\u0430), along with their estimated inverse fields, are computed. The constraint minimizes the Frobenius norm between the estimated inverse field \u00d8BA of the forward displacement field \u00d8AB and the true backward displacement field \u00d8\u0412\u0410 as expressed in Eq. 4. OBA is obtained through a sampling function that operates on the displacement fields. More details on the inverse consistency and the anti-folding losses are presented by [34].\n$L_{inv}(\u03a6_{AB}) = ||\u03a6_{AB} - \\hat{\u03a6_{AB}}|| with \\hat{\u03a6_{AB}} = \u03b6((-\u03a6_{BA},\u03a6_{AB}))$ (4)\nHowever, the inverse consistency constraint has limitations as there is no guarantee that \u0444\u0430\u0432(SA) = SB, except in cases where Lsim = 0. Consequently, the inverse consistency term can never be zero unless the transformed segmentation mask is identical to SB. To illustrate this, consider two points, a and b, on the segmentation masks SA and SB, respectively. In response, inspired by [22], we favor a cyclic method over a bidirectional one to compute the displacement fields. For a cyclic path, we obtain two successive displacement fields: one transforms a to b' and the other b' to a'. The second field \u0444\u2192a' starts where the first \u0424\u0430\u2192 ends, ensuring a well-defined inverse consistency loss. By doing this, we enforce the displacement field ab to be inversely consistent while gradually aligning b' to b during model training. Finally, the total loss function is formulated as follows:\n$L(S_A, S_B) =a L_{sim}(S_{B'}, S_B) + \u03b2 (L_{smooth}(\u03a6_{AB'}) + L_{smooth}(\u03a6_{B'A'})) + \u03b3 (L_{anti-folding}(\u03a6_{AB'}) + L_{anti-folding} (\u03a6_{B'A'})) + \u03bc (L_{inv}(\u03a6_{AB'}) + L_{inv}(\u03a6_{B'A'}))$ (5)\nIncremental Cyclic Diffeomorphic Registration We propose to extend our approach by introducing a two-step incremental cyclic diffeomorphic registration process (Fig. 3). The model predicts two displacement fields for each direction."}, {"title": "Experiments", "content": "Dataset and Implementation Details Our dataset includes 772 pairs of longitudinal liver examinations from 337 patients. 90% of these patients are allocated for training the registration methods, while a test set of 33 patients is reserved for assessing registration performance. An additional clinical dataset containing 40 exams from 20 liver cancer patients is used to evaluate tumor-wise metrics. A radiologist manually annotated the tumor masks of this dataset. The datasets were collected under the GDPR through a collaboration with a hospital. An initial liver area cropping and an affine registration (similar to [2]) are applied to eliminate global transformations, particularly in cases involving significant changes in patient position between examinations. This aligns with the framework described in Section 2, where we assumed that the images are affinely aligned, minimizing deformations of large amplitudes. For affine registration, a fully convolutional network (FCN) is used to predict the transformation matrix applied to the moving images. All Images are resampled to a size of (160, 160,"}, {"title": "Results and Discussion", "content": "Results For field regularity metrics, DiffeoCyc_inc-2 exhibits values of 0.002, 0.008, and 1 for $||\u2207\u03a6||_2$, $||A \u2013 A'||_1$, and |J < 0| metrics respectively. In contrast, NiftyReg (resp. Voxelmorph (NCC + DSC)), which are content-based methods, report values of 0.09 (resp. 0.04), 0.01 (resp. 0.027), 45145 (resp. 12845). The difference between DiffeoCyc_inc-2 and NiftyReg (resp. Voxelmorph) is significant (Pvalue < 0.01). NCC and MI metrics report comparable values (pvalue > 0.01) across methods between 0.43 and 0.45, with 0.37 for Voxelmorph (NCC + DSC).\nFor tumor-related metrics, NiftyReg manages to match 1 more tumor than the other methods (tumor inclusion ratio = 0.58). The tumor burden relative error for all methods varies between 0.11 and 0.16. DiffeoCyc_inc-2 reports a displacement field regularity of 0.002 and 0 voxels with non-diffeomorphic deformations.\nDiscussion Quantitative results in Tab. 1 show that our approaches stand out in metrics related to the field smoothness, emphasizing improved regularity in the generated transformations. Fig. 4 offers a qualitative analysis of the impact of displacement field regularity. Our method provides smooth displacement fields even for large deformations. In contrast, the transformation induced by VoxelMorph, applied directly to the segmentation masks, stretches the liver contours (red arrows). Although our approaches operate at the segmentation level rather than the image level, the content-based similarity metrics (NCC and MI) do not show significant differences between all the methods.\nResults in Tab. 2 show that content-based registration methods slightly outperform other methods in matching tumors and achieving higher inclusion ratios for registered tumors. However, these methods exhibit significantly lower regularity in displacement fields and risk warping lesions to better fit tumors at time t+ 1. This increases inclusion ratios, but preserving tumor burden alone is insufficient; maintaining tumor shape and appearance is also important for tumor progression evaluation when using both warped and reference images."}, {"title": "Conclusion", "content": "In this work, we introduced a registration framework designed to assist tumor progression assessment in longitudinal liver CT scans. Leveraging an automatic segmentation model, our framework aligns liver segmentation masks through smooth displacement fields. This alignment targets tumor alignment with minimal tumor deformation. Even though the internal structures of the liver may not be perfectly aligned after registration, their shape will be nearly preserved while being brought much closer to their counterpart in the reference image. The impact of this registration on a subsequent tumor progress/change detection module is to be addressed in future works."}, {"title": "Bidirectional vs Cyclic Approach", "content": "Why is the inverse consistency loss not well defined for a bidirectional approach? Let b' and a' be the new positions of a and b after registration by QAB and BA, respectively. As long as a' \u2260 a and b' \u2260 b, the inverse consistency loss can not be zero, Va \u2208 SA and b \u2208 SB. While we impose the fields a->b' and b->a' to be inversely consistent, the starting point (b) of the second field does not necessarily coincide with the ending point (b') of the first. The following diagram illustrates the motivation behind employing a cyclic approach rather than a bidirectional one, as presented in section 2, paragraph 2."}, {"title": "Public Datasets", "content": "In the healthcare domain, releasing public datasets involves a rigorous process due to the sensitive nature of the information they contain. Longitudinal studies further complicate this process, requiring patients to undergo at least two examinations at specific time intervals. This scarcity of public longitudinal datasets is particularly evident in our case for abdominal CT scans of the liver. Existing public datasets, such as ADNI-2 [4], ISBI-2015 (MS lesion segmentation challenge by [8]), OASIS-2 [25] and OASIS-3 [23], primarily focus on brain studies, making them unsuitable for our specific use case. This is attributed to the inherent disparity between the longitudinal brain and abdominal images, as discussed in Section 1, especially since the impact of the temporal dimension is more pronounced in abdominal images than in brain images. Learn2Reg [18] offers data for CT-MRI modalities in inter-patient or intra-patient abdominal examinations. However, it lacks the essential longitudinal aspect needed to address the temporal nature of our specific use case."}]}