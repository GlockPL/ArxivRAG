{"title": "KG4Diagnosis: A Hierarchical Multi-Agent LLM Framework with Knowledge Graph Enhancement for Medical Diagnosis", "authors": ["Kaiwen Zuo", "Yirui Jiang", "Fan Mo", "Pietro Lio"], "abstract": "Integrating Large Language Models (LLMs) in healthcare diagnosis demands systematic frameworks that can handle complex medical scenarios while maintaining specialized expertise. We present KG4Diagnosis, a novel hierarchical multi-agent framework that combines LLMs with automated knowledge graph construction, encompassing 362 common diseases across medical specialties. Our framework mirrors real-world medical systems through a two-tier architecture: a general practitioner (GP) agent for initial assessment and triage, coordinating with specialized agents for in-depth diagnosis in specific domains. The core innovation lies in our end-to-end knowledge graph generation methodology, incorporating: (1) semantic-driven entity and relation extraction optimized for medical terminology, (2) multi-dimensional decision relationship reconstruction from unstructured medical texts, and (3) human-guided reasoning for knowledge expansion. KG4Diagnosis serves as an extensible foundation for specialized medical diagnosis systems, with capabilities to incorporate new diseases and medical knowledge. The framework's modular design enables seamless integration of domain-specific enhancements, making it valuable for developing targeted medical diagnosis systems. We provide architectural guidelines and protocols to facilitate adoption across medical contexts.", "sections": [{"title": "Introduction", "content": "Knowledge graphs (KGs) have emerged as transformative tools across numerous domains, showcasing their ability to organize complex datasets and support advanced reasoning and decision-making. In finance, KGs play a pivotal role in risk assessment and fraud detection by linking disparate financial datasets to uncover hidden patterns and relationships. For example, the application of KGs in detecting fraudulent related party transactions enables financial institutions to model complex interdependencies between entities, improving accuracy in identifying fraudulent activities (Zhang, Li, and Wang 2023). Similarly, in education, KGs enhance personalized learning by structuring knowledge from vast academic resources to recommend tailored learning paths. A notable implementation includes the use of KGs to integrate data from curriculum design, student assessments, and teaching resources, creating adaptive systems that improve student engagement and outcomes.. In manufacturing, knowledge graphs (KGs) enable automation and optimization of processes by integrating heterogeneous data sources. A recent study highlighted their role in Reconfigurable Manufacturing Systems (RMS), where semantic models and KGs support automated asset capability matching and reconfiguration solutions. This approach demonstrated significant improvements in efficiency, cost reduction, and productivity by leveraging structured knowledge for dynamic decision-making in manufacturing systems (Mo et al. 2024).\nIn the medical domain, KGs (Abdulla, Mukherjee, and Ranganathan 2023; Alam, Giglou, and Malik 2023; Wu et al. 2024) serve as crucial infrastructure for organizing diverse healthcare data and supporting clinical decision-making. However, constructing and reasoning over medical KGs (Abdulla, Mukherjee, and Ranganathan 2023; Al Khatib et al. 2024), particularly from unstructured and multimodal data, presents significant challenges that existing approaches have not fully addressed.\nCurrent methods for medical KG construction span traditional rule-based systems to advanced AI models. Rule-based and ontology-driven approaches using SNOMED-CT (Chang and Mostafa 2021) and UMLS (Amos et al. 2020) offer reliability but lack scalability and struggle with unstructured data. While Large Language Models (LLMs) like GPT (OpenAI 2022, 2023; Touvron et al. 2023; Garc\u00eda-Ferrero et al. 2024) and MedPaLM (Qian et al. 2024) show promise in generating structured knowledge from unstructured data, they face challenges with hallucination and accuracy (Huang et al. 2023; Tonmoy et al. 2024; Guo et al. 2024). Hybrid approaches incorporating Graph Neural Networks (GNNs) attempt to balance symbolic reasoning with deep learning but remain computationally complex and dependent on well-structured inputs (Zhang 2021; Zhang et al. 2024; Shuifa et al. 2023).\nFor diagnosis and treatment, medical KGs provide a critical foundation for identifying patterns and relationships within patient data, medical literature, and clinical guidelines (Li et al. 2020). In diagnosis, KGs help map symptoms to potential conditions, identify relevant tests, and prioritize differential diagnoses (Tang et al. 2023). In treatment, KGs assist in recommending personalized treatment"}, {"title": "Methodology", "content": "KG4Diagnosis is designed as a hierarchical multi-agent framework that integrates LLMs with automated knowledge graph construction for medical diagnosis (see Figure 1). The system architecture consists of two primary components: a knowledge graph construction pipeline that processes and structures medical knowledge and a Camel-based multi-agent system that enables hierarchical medical decision-making. This design mirrors real-world medical practices, where general practitioners collaborate with specialists to provide comprehensive patient care (see Figure 2)."}, {"title": "Knowledge Graph Construction Pipeline", "content": "This framework implements a three-stage process for the automated construction of a medical knowledge graph. Initially, medical documents are segmented into data chunks that adhere to the contextual constraints of the knowledge graph. Subsequently, a semantic-driven entity and relationship extraction module is employed to extract entities and relationships from these data chunks. This process leverages BioBERT, a model specifically designed for the biomedical domain, which ensures the precise extraction of medical entities and the identification of relationships between them. In the following stage, based on the extracted entities and relationships, a knowledge graph is constructed, thereby facilitating its automatic generation. We also enhance the medical knowledge graph by using LLMs to identify broader, context-aware entities and relations, complementing BioBERT's domain-specific extractions.\nIn the last stage, the expansion and validation of the knowledge graph will be facilitated through expert evaluation. Medical experts will manually validate the relationships that have been constructed, and the verified knowledge will be used to train large-scale models to facilitate future knowledge expansion.\nThe details of each part of the construction pipeline are as follows:\nStage 1: Data Chunking and Segmentation In the first stage, medical documents are segmented into data chunks based on contextual constraints. Let D = {d1,d2,...,dn} represent a set of medical documents. Each document di is segmented into m data chunks:\nCi = {Cil, Ci2,..., Cim}\nThese chunks Cij are generated using context-based segmentation rules. The segmentation process can be mathematically represented as:\nfseg(di) \u2192 Ci\nwhere fseg is a function that maps a document di to a set of data chunks Ci.\nStage 2: Semantic-driven Entity and Relationship Extraction The pipeline leverages BioBERT's contextual embeddings along with medical ontologies, such as SNOMED-CT and UMLS, to extract entities and relationships from the segmented data chunks. The process of extraction can be represented as follows:\n\u2022 Entity Extraction: The set of extracted entities E is defined as:\nE = {\u20ac1, \u20ac2,...,en}\nwhere E represents the set of medical entities, such as diseases, drugs, symptoms, etc."}, {"title": "Stage 3: Knowledge Graph Construction", "content": "Once entities and relationships are extracted, a knowledge graph is constructed. A knowledge graph can be represented as a graph G, where:\nG = (V, E)\nHere, the set of nodes V = {e1, e2, ..., ek} represents the medical entities, and the set of edges E = {r1,2,...,r\u0131} represents the relationships between these entities.\nThe construction of the knowledge graph is based on the extracted entities and relationships. Thus, the knowledge graph can be represented as:\nG = (V, E) where V = E and E = R\nThe nodes represent entities, and the edges represent relationships."}, {"title": "Stage 4: LLM-Augmented Knowledge Graph", "content": "We utilize LLMs to enhance the medical knowledge graph by identifying entities and relations that extend beyond BioBERT's extraction capabilities. While BioBERT excels in precise, domain-specific extractions within the biomedical field, LLMs contribute broader, context-aware semantic extractions, especially from complex or ambiguous medical texts. The enriched entities and relations are stored in dedicated databases and integrated into the knowledge graph, which is then optimized for reasoning with LLMs. This enhanced knowledge graph supports advanced diagnostic workflows by enabling more robust reasoning and decision-making through the synergistic capabilities of multi-agent systems and LLM-driven diagnostic reasoning."}, {"title": "Stage 5: Human-Guided Reasoning", "content": "In this final stage, expert validation is crucial in ensuring the quality and accuracy of the constructed relationships and entities in the knowledge graph. The expert validation process involves active learning and reinforcement learning techniques to expand the graph with verified and reliable information.\n\u2022 Expert Validation of Relationships: Medical experts manually review the extracted relationships R between entities to validate their clinical relevance. If a relationship (ei, r, ej) is confirmed to be accurate, it is retained in the knowledge graph. If a relationship is deemed invalid or uncertain, it is either corrected or removed.\n\u2022 Graph Expansion with Expert-Verified Relationships: After validation, the knowledge graph is expanded by incorporating new, expert-verified entities and relationships. The validated graph is enriched with these confirmed connections, improving the graph's reliability and comprehensiveness.\nGexpanded = GU Validated Entities and Relationships\nwhere Gexpanded represents the expanded knowledge graph that includes both previously extracted and expert-verified entities and relationships.\nThrough this expert-guided validation and expansion process, the knowledge graph evolves into a robust and reliable resource for medical research and clinical decision-making."}, {"title": "Hierarchical Multi-Agent Framework for Medical Diagnosis", "content": "To address the complexity of medical diagnostic reasoning, we developed a hierarchical multi-agent framework that processes user queries for diagnosis. This framework integrates a General Practitioner Large Language Model (GP-LLM) and multiple domain-specific Consultant Large Language Models (Consultant-LLMs). The diagnostic process is mathematically modelled as follows:\nGP-LLM: Primary Diagnostic Agent The GP-LLM serves as the initial interface for analyzing user queries. Let the user query be denoted by q \u2208 Q, where is the set of all possible user queries. The diagnostic confidence for a query q producing a preliminary diagnosis x is defined as:\nPGP(x|q) = fGP(q) (1)\nwhere PGP(x q) \u2208 [0,1] is the confidence assigned by the GP-LLM to the diagnosis x, and fGP represents the probabilistic diagnostic function based on a broad-spectrum knowledge base.\nThe GP-LLM initiates a referral when:\nPGP(xq) <\u0442 or x \u2208 Xs (2)\nHere:\n\u2022 Tis the confidence threshold for referral (set to 0.7).\n\u2022 X CX is the subset of diagnoses requiring specialized expertise.\nThe output of the GP-LLM is expressed as:\nOutputGp =\n(Referral to Consultant-LLM, if PGP(x|q) <r or x \u2208 Xs,\nDiagnosis: x, otherwise. (3)\nConsultant-LLMs: Specialized Diagnostic Agents Each Consultant-LLM is optimized for a specific medical domain, such as rheumatology. Let Agent; represent the ith Consultant-LLM, where i = 1,2,...,n and n = 4 (cardiology, neurology, endocrinology and rheumatology) in this framework. The confidence function for Agent; diagnosing a condition y from query q is defined as:\nPAgent (y|q) = fAgent, (q) (4)\nwhere PAgent; (y | q) \u2208 [0,1] and fagent; is the probabilistic diagnostic function based on domain-specific training datasets and clinical guidelines.\nFor cases requiring collaborative reasoning between multiple agents, the final diagnosis confidence is computed as:\nn\nPfinal (z | q) = \u2211 Wi PAgent; (z | q) (5)\ni=1\nwhere wi represents the weight assigned to Agent's contribution, normalized such that \u2211=1 Wi = 1.\nInter-Agent Communication Protocol The referral and communication processes ensure the seamless transfer of cases and collaborative refinement. Let T(A, B, q) denote the transfer of the user query q from agent A to agent B. The transfer function is modeled as:\nT(A, B, q) = $(q), \u00a2 : Q \u2192 Q' (6)\nwhere & transforms q into a format compatible with the receiving agent B. Feedback to the GP-LLM updates its knowledge base KGP as follows:\n(t+1)\nKGP\n= KGP\n+ \u0394\u039a (7)\nwhere AK is the incremental knowledge derived from Consultant-LLMs.\nReferral Decision Threshold The referral decision is mathematically defined as:\nReferral =\nf1, if PGP(x | q) < \u03c4or x \u2208 Xs\n10, otherwise. (8)\nHere:\n\u2022 Referral = 1 indicates escalation to a Consultant-LLM.\n\u2022 Referral = 0 implies retention of the query within the GP-LLM."}, {"title": "Advanced Diagnosis with Multi-Agent Collaboration", "content": "For complex queries requiring input from multiple Consultant-LLMs, the final diagnosis confidence is calculated as:\n1\nn\nPfinal (zq) \u03a3PAgent (219), \u0396\u2208Z (9)\nn\ni=1\nwhere Z C X represents the space of complex diagnoses requiring multi-domain expertise.\nSummary This modelling formalizes the diagnostic reasoning within the hierarchical multi-agent framework. The confidence functions PGP(x | q), PAgent; (y | q), and Pfinal (z | q) define the probabilistic outputs of the GP-LLM, individual Consultant-LLMs, and the collaborative multi-agent system, respectively. The confidence threshold (r = 0.7) ensures accurate and efficient escalation to specialized diagnostic agents when necessary."}, {"title": "Future Training and Evaluation Work", "content": "The system's training approach encompasses a comprehensive coverage of 362 common diseases across multiple medical specialties, representing a significant scope in medical diagnosis. The training process is strategically designed to be multi-faceted, combining general medical knowledge with specialized domain expertise. For each disease category, we implement targeted fine-tuning protocols for the respective specialist agents, ensuring deep domain-specific knowledge while maintaining coherent integration within the broader framework.\nOur continuous learning mechanism enhances the initial training through dynamic agent interactions and feedback loops. This approach allows the system to evolve and refine its diagnostic capabilities over time, adapting to new medical insights and patterns identified through agent collaboration.\nThe framework, implemented using PyTorch for neural network components and Neo4j for knowledge graph management, currently encompasses all 362 diseases in its knowledge base, with structured pathways for knowledge expansion.\nGiven the framework's comprehensive scope and innovative approach to medical diagnosis, a comprehensive benchmark is currently being developed to evaluate performance across multiple dimensions, including diagnostic accuracy, hallucination prevention, and multi-agent coordination efficiency. This benchmark will provide standardized metrics for assessing medical AI systems and will be made publicly available through our GitHub repository upon completion. The forthcoming benchmark aims to establish new standards for evaluating hierarchical multi-agent systems in medical applications, facilitating future research and development in this critical domain."}, {"title": "Discussion", "content": "The development and evaluation of KG4Diagnosis, encompassing 362 common diseases across multiple medical specialties, reveals significant insights into integrating hierarchical multi-agent systems with medical knowledge graphs for healthcare applications. Our comprehensive framework demonstrates both promising capabilities and important challenges that warrant further investigation."}, {"title": "Technical Achievements and Innovations", "content": "The combination of automated knowledge graph construction with hierarchical multi-agent architecture shows encouraging results in addressing key challenges in medical Al systems. Our framework's ability to maintain diagnostic accuracy while preventing hallucination represents a significant advancement over traditional single-agent approaches. Particularly noteworthy is the effectiveness of our semantic-driven entity extraction and relationship reconstruction modules in handling complex medical terminology and relationships, achieving higher precision compared to conventional methods."}, {"title": "System Adaptability and Scalability", "content": "The resulting knowledge graph structure demonstrates the complex interconnections between different disease entities, symptoms, and diagnostic patterns. This comprehensive coverage supports efficient knowledge navigation and hierarchical decision-making processes. The modularity of our framework shows particular strength in incorporating new medical domains and knowledge, making it well-suited for the dynamic nature of medical knowledge.\nHowever, scalability analysis reveals important considerations. While the hierarchical structure efficiently manages computational resources through its tiered decision-making process, the system faces increasing complexity in coordinating multiple specialist agents as the number of medical domains expands. This highlights the need for more sophisticated coordination mechanisms in future iterations."}, {"title": "Limitations and Challenges", "content": "The system's performance can be influenced by the quality and comprehensiveness of the underlying knowledge graph, particularly in rare or complex medical conditions. Challenges remain in handling edge cases where medical knowledge is rapidly evolving or when dealing with rare disease combinations not well-represented in the training data.\nFuture research will involve conducting experiments on the state-of-the-art MedQA dataset to validate the superiority of our framework. MEDQA can be used to perform benchmark tests, thus evaluating the reproducibility of the perfect functioning of LLM. Meanwhile, this will allow us to benchmark our framework against other prominent models, such as ESM-1b, Med-PaLM, and BioGPT. By evaluating performance in MedQA, we aim not only to demonstrate the competitive advantages of our system but also to identify areas for further improvement. Additionally, the system's heavy reliance on high-quality medical data for both knowledge graph construction and agent training presents challenges for deployment in regions with limited medical data resources. While our framework shows strong performance in well-documented medical conditions, its effectiveness in handling rare diseases or unusual symptom combinations requires further investigation."}, {"title": "Related Work", "content": "Rule-Based and Ontology-Driven Approaches: Recent advances in the construction and reasoning of medical KG have spawned various methodological approaches (Lu et al. 2024; Li et al. 2020; Peng et al. 2023), each offering unique advantages while facing distinct challenges. Traditional approaches to medical KG construction primarily rely on rule-based systems and ontology-driven techniques. While these methods excel in producing interpretable outputs and maintaining structural consistency through established medical ontologies, they face significant limitations in scalability and processing unstructured data (Abdulla, Mukherjee, and Ranganathan 2023).\nDeep Learning and Pre-Trained Models: The emergence of deep learning methods, particularly pre-trained language models such as BERT and BioBERT (Masoumi et al. 2024), has substantially improved information extraction capabilities in clinical texts. However, these models often struggle with domain-specific nuances and require considerable computational resources (Alsentzer et al. 2019).LLMs represent an advancement in processing unstructured medical data. While recent studies demonstrate their potential in generating structured knowledge and understanding complex medical relationships, challenges persist regarding hallucination and validation (Brown et al. 2020). The Med-HALT benchmark and contrastive decoding techniques have emerged as promising approaches to address these concerns (Liu et al. 2023). Furthermore, integrating LLMs with multi-agent systems (MAS) has shown particular promise in medical applications (Singhal et al. 2023b).\nHybrid Symbolic-Neural Approaches: Hybrid approaches combining symbolic reasoning with neural architectures have gained traction for their ability to balance interpretability with adaptability. These systems integrate knowledge-driven reasoning with data-driven learning, though they require well-curated inputs and face computational scalability challenges (Wu, Zhang, and Lin 2023). Recent innovations in multimodal integration have expanded KG capabilities to incorporate diverse data types, including clinical notes, medical imaging, and laboratory results, although standardization and fusion challenges remain (Zhou et al. 2022).\nAdvancements in Medical LLMs: Recent advancements in medical LLMs have significantly enhanced the field of natural language understanding in healthcare. Models like ESM-1b (Rives et al. 2021), originally developed for protein representation, have shown promise in biomedical applications, leveraging evolutionary scale modeling to analyze biological sequences with high accuracy. Med-PaLM (Singhal et al. 2023a),, on the other hand, represents a specialized adaptation of general-purpose LLMs for clinical use, focusing on answering medical questions and reasoning within structured datasets. Similarly, MediTron (Bosselut et al. 2024) and BioGPT (Luo et al. 2022) have been designed to extract biomedical knowledge, with MediTron excelling in multimodal data integration and BioGPT being fine-tuned specifically on biomedical literature for entity and relation extraction tasks. The recent development of GPT-4-medprompt (Nori et al. 2023) further pushes the boundaries of medical LLMs by integrating domain-specific prompts to guide reasoning, improving contextual accuracy and reducing hallucination in medical applications.\nHierarchical Multi-Agent Architectures: The emergence of hierarchical multi-agent architectures represents a particularly promising direction. Pandey et al. (Pandey, Amod, and Kumar 2024) demonstrate that such architectures can effectively mirror real-world medical systems, with general-purpose agents handling initial assessment and specialized agents managing domain-specific diagnoses. This approach not only improves diagnostic accuracy but also enhances system scalability and reliability.\nDespite these advancements, the field continues to grapple with several critical challenges. The processing of unstructured medical data remains a significant hurdle, requiring more sophisticated approaches for accurate information extraction and structuring (Avula et al. 2022). The prevention and detection of LLM hallucinations in medical contexts demands continued innovation in verification mechanisms and validation protocols (Huang et al. 2023). Additionally, the integration of multimodal medical information presents ongoing challenges in data standardization and fusion. The coordination of multiple specialized agents within medical systems requires further refinement of communication protocols and decision-making frameworks. Furthermore, the development of comprehensive and standardized evaluation protocols for medical KG systems remains an active area of research, which is essential for ensuring the reliability and effectiveness of these systems in clinical applications. These interconnected challenges present opportunities for innovative solutions that combine the strengths of various approaches while addressing their individual limitations."}, {"title": "Conclusion", "content": "This paper presents KG4Diagnosis, a novel hierarchical multi-agent framework that integrates automated knowledge graph construction with specialized LLMs for medical diagnosis. Our implementation, covering 362 common diseases, demonstrates the effectiveness of combining knowledge graphs with a hierarchical multi-agent architecture to address critical challenges in medical AI systems. The framework's innovations lie in its three-stage knowledge graph construction pipeline and hierarchical-based agent structure, where semantic-driven processing and human-guided reasoning create a robust knowledge foundation, while the multi-tiered agent architecture mirrors real-world medical practices. The system demonstrates significant advantages in preventing hallucination through multiple validation layers and managing computational resources through targeted specialist consultation. Although our current implementation shows promising results, we are developing comprehensive benchmarks to provide standardized evaluation metrics for the community. This work not only contributes a practical solution for current medical AI challenges but also establishes a foundation for future developments in hierarchical multi-agent systems for healthcare applications, potentially improving healthcare delivery and patient outcomes."}]}