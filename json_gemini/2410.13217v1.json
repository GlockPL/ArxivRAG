{"title": "MixEHR-Nest: Identifying Subphenotypes within Electronic Health Records through Hierarchical Guided-Topic Modeling", "authors": ["Ruohan Wang", "Zilong Wang", "Ziyang Song", "David Buckeridge", "Yue Li"], "abstract": "Automatic subphenotyping from electronic health records (EHRs) provides numerous opportunities to understand diseases with unique subgroups and enhance personalized medicine for patients. However, existing machine learning algorithms either focus on specific diseases for better interpretability or produce coarse-grained phenotype topics without considering nuanced disease patterns. In this study, we propose a guided topic model, MixEHR-Nest, to infer sub-phenotype topics from thousands of disease using multi-modal EHR data. Specifically, MixEHR-Nest detects multiple subtopics from each phenotype topic, whose prior is guided by the expert-curated phenotype concepts such as Phenotype Codes (PheCodes) or Clinical Classification Software (CCS) codes. We evaluated MixEHR-Nest on two EHR datasets: (1) the MIMIC-III dataset consisting of over 38 thousand patients from intensive care unit (ICU) from Beth Israel Deaconess Medical Center (BIDMC) in Boston, USA; (2) the healthcare administrative database PopHR, comprising 1.3 million patients from Montreal, Canada. Experimental results demonstrate that MixEHR-Nest can identify subphenotypes with distinct patterns within each phenotype, which are predictive for disease progression and severity. Consequently, MixEHR-Nest distinguishes between type 1 and type 2 diabetes by inferring subphenotypes using CCS codes, which do not differentiate these two subtype concepts. Additionally, MixEHR-Nest not only improved the prediction accuracy of short-term mortality of ICU patients and initial insulin treatment in diabetic patients but also revealed the contributions of subphenotypes. For longitudinal analysis, MixEHR-Nest identified subphenotypes of distinct age prevalence under the same phenotypes, such as asthma, leukemia, epilepsy, and depression. The MixEHR-Nest software is available at GitHub: https://github.com/li-lab-mcgill/MixEHR-Nest.", "sections": [{"title": "1 Introduction", "content": "The widespread adoption of electronic health records (EHRs) offers numerous opportunities to refine medical concepts and automate disease diagnosis. EHRs contain a heterogeneous collection of patient health data, comprising structured data such as International Classification of Diseases (ICD) codes, Diagnosis-Related Group (DRG) codes, and medication codes (RxNorm), as well as unstructured data such as clinical notes. Distilling interpretable phenotype representations from multi-modal data can enhance the understanding of patient health status and the prediction of disease onset. In clinical practice, diseases often occur as subphenotypes, which are subgroups of traits within the same disease label but with distinct phenotypic characteristics. These subphenotypes can differ in severity and underlying pathology, thereby explaining varied responses to the same medical treatments and promoting precision medicine research.\nTraditional phenotyping methods rely on human-curated phenotype concepts, such as Phenotype Codes (PheCodes) and Clinical Classification Software (CCS) codes, which group ICD diagnostic"}, {"title": "2 Related Works", "content": "Existing research on automatic subphenotyping has largely focused on clustering techniques [23, 35], non-negative matrix/tensor factorization [19], mixture models [32] or autoencoder methods [4, 47, 50]. These methods typically struggle with poor identifiability when applied to large, heterogeneous cohort with thousands of diseases. Consequently, most research focus on single diseases groups, such as acute respiratory distress syndrome (ARDS) [9, 30, 39], asthma [48, 49], sepsis [6, 32, 36], and acute kidney injury (AKI) [5, 50]. Scaling these methods to identify subphenotypes across broader disease categories remains a challenge.\nUnsupervised topic models are often seen as a potential solution for handling large topic numbers, but they generally do not incorporate expert knowledge into inference process, limiting their ability to identify clinically meaningful phenotypes. Recently, expert-guided topic models like MixEHR-Guided and MixEHR-Seed leverage seed-guided topic inference to infer expert-defined phenotype topics [3, 40]. Built on the heterogeneous topic model MixEHR [24], these models can learn from multi-modal EHR data and assign distinct phenotype topic distributions for each modality. However, despite their ability to annotate thousands of phenotypes, they fall short in capturing fine-grained phenotypic patterns for subphenotyping."}, {"title": "3 Methodology", "content": "Here we provide a high-level overview of the methods. Section 3.1 outlines the data-generative process of MixEHR-Nest. The key difference from the standard Latent Dirichlet Allocation is the introduction of a phenotype-guided subtopic prior. Section 3.2 describes the inference algorithm to infer the subtopic assignment (i.e., z) of each EHR code. Section 3.3 details parameter initialization, which is crucial for model performance. Finally, Section 3.4 describes the inference of disease subtopic mixtures of test patients. All the notations are either defined in Table 1 or in-text."}, {"title": "3.1 MixEHR-Nest model generative process", "content": "In this study, MixEHR-Nest takes into account the subphenotypes by assigning M subtopics within each of K phenotype topics, resulting in a total of K X M topics. For each patient d out of D patients, its topic mixture Od follows a Dirichlet distribution with asymmetric topic priors \u03b1d \u2208 RK\u00d7M, which guide posterior topic inference for subphenotypes (Fig.1 a). For each EHR code i from the patient d, MixEHR-Nest infers a topic assignment zid sampled from a Categorical distribution based on the topic mixture Od. Its EHR code xid is sampled from the Dirichlet-distributed phenotype topic distribution \u03a6km=zid given the topic assignment zid.\nTo incorporate expert knowledge, we utilize two phenotype taxonomies: (1) 1641 expert-curated PheCodes from the the Phenome-wide association studies (PheWAS) [13]; (2) the 281 coarse-grained CCS codes from CCS mapping. Both mapping systems group clinically relevant ICD codes into broadly defined phenotype concepts. Consequently, the model infers each phenotype topic for either a PheCode or CCS code\nThe data generative process of MixEHR-Nest is as follows:\n(1) For the subtopic m\u2208 {1,..., M} within the disease topic k\u2208 {1, ..., K} given the EHR modality t \u2208 {1, ..., T}:\n(a) Sample K \u00d7 M global phenotype topics from Dirichlet distribution \u03a6(t) ~ Dir (\u03b2)\nkm\n(2) For each patient d\u2208 {1, . . ., D}, sample a patient-topic mixture Od ~ Dir (\u03b1d):\n(a) For each EHR token i \u2208 {1,..., N(t) } among the N(t) tokens with modality t for patient d:\n(i) Sample a topic assignment: z(t) ~ Cat (\u0398d).\nid\n(ii) Sample an EHR code: x(t) ~ Cat (\u03a6(t))\nwhere Dir(.) and Cat(.) indicate Dirichlet and Categorical distributions, respectively. To run MixEHR-Nest model, we provide"}, {"title": "3.2 Inference", "content": "In this section, we provide the equations for the inference of the phenotype-guided prior and modality-specific topic assignments. We detailed the derivation of the collapsed Gibbs sampling of the LDA in Appendix A.3.\nICD-specific topic inference. For each ICD code i of the patient d, we infer the topic assignment z(ICD) indicating the underlying subphenotype topic, given all the other topic assignments z(ICD).\nKXM\n= km \u03a3\nn=1\n\u03b2+ nw.km WICDB+ WICD n (1)\nKXM\n(ICD)\n(t=ICD)\n((t=ICD)\n(ICD).\nNon-ICD-modality topic inference. For the unguided non-ICD modalities, the updates of topic assignments are defined as follows:\nKXM\n@dkm+ndi.d))\nkm=1\n(3)\n(ICD)\nand \u0144 from ICD-modality to guide the infer-\nonce of topic assignments from the non-ICD modalities. We can\n(non-ICD) , the updates of topic assignments are defined as follows:\n-w.km Wnon\u2212ICDB+ W(3)\nCross-sectional topic inference. For cross-sectional EHR data such as MIMIC-III, we rely on the phenotype-guided topic assignments from the ICD modality as it defines the phenotype concept (e.g., PheCode). We first infer topics on ICD modality iteratively until convergence. Given the ICD-modality topic assignments, we infer non-ICD modalities iteratively until convergence. For each modality t, the convergence is evaluated by the log marginal likelihood: L(t) =\nKXM\n+nw.km)\n\u03a3\u03ba\u03a7\u039c \u0395\u03b8d,m |z] =\n(ICD)\nLongitudinal topic inference. For longitudinal administrative healthcare data such as PopHR, each patients could have multiple visits, where the same code can be recorded multiple times across their medical histories. For each patient, we compute the occurrence of EHR codes across medical visits. We then jointly infer topic assignments from both ICD and non-ICD modalities by alternating between them at each iteration. We iterate Gibbs samplings until"}, {"title": "3.3 Initialization", "content": "Prior Initialization. For cross-sectional EHR data, where each ICD-9 code is observed only once per patient, we set the hyperparameter \u03b1dkm to 0.9 if the subphenotype m associated with topic k is observed for a patient d. Otherwise, we randomly sample the value from a range of [0.001, 0.01]. For longitudinal EHR data, where each code can occur multiple times during patient visits, we estimate probabilities using a two-component Poisson and Lognorm mixture model for each PheCode via maximum a posteriori (\u039c\u0391\u03a1) [3, 25, 26]. If a patient d has the PheCodes, we set the hyperparameter cd,k = (\u03b1d,k1 ,..., \u03b1d,kM ) to the estimated prior values for phenotype k; otherwise, the corresponding topic priors are set to 0. We provide details about the hyperparameter setup for prior initialization in Appendix A.1\n(t)\n(ICD)\nInitialization of sufficient statistics. We initialize sufficient statistics n.dkm = \u03a3 (t)\n[zid = km] and nw.km = \u03a3 [zid = km] [xt= (1)\nw] to align with priors \u03b1, effectively guiding the posterior inference.\n(t)\nHere, ndkm represents the total count of tokens assigned to topic km for patient d for modality t, and nw (t) represents the count of tokens with value w assigned to topic km for modality t across all patients. We leverage the PheWAS or CCS mapping to project ICD codes to PheCodes or CCS codes.\nFor ICD modality, for each patient d, we examine if its ICD code x(ICD)\n(ICD)\nid = w for i \u2208 (1, ..., N (ICD)) is associated with the phenotype topic k. We then select a random subtopic m within the topic k is selected by incrementing n.dkm and nw.k1 by 1.\nFor the tokens from non-ICD modalities, we randomly sample subtopics based on the primary topics observed from the ICD modality (Appendix A.2).\nWe then compute n.dkm\n(ICD)\n(non-ICD)\n+nxn.dkm by weighting\nwk from both ICD and non-ICD modalities, where n is a weighting hyperparameter. This aggregation method mitigates the potential impact of inaccurate topic assignments from the non-ICD fea-tures, effectively leveraging the guided knowledge from ICD modality. We consider the setup of hyperparameter \u03b7 \u2208 {0.2, 0.4, 0.6.0.8, 1} using a validation set as described in Section 5.1."}, {"title": "3.4 Predict phenotypes for new patients", "content": "N(t)\n, we first initialize the patient-topic assignments nd'km\n, we perform Gibbs\nFor a new patient d' with EHR tokens denoted as x(t) for i = 1,..., N(t) we first initialize the patient-topic assignments n.d'km the same way as in Section 3.3. We then infer topic assignments from ICD and non-ICD modalities, where the non-ICD topic inference leverages the guided information ICD-inferred topic assignments. This is similar to the topic inference during training (Section 3.2) except fixing the estimated topic distributions (t) . The detailed algorithm is provided as follows:\n(1) For each ICD code i \u2208 (1,..., N (ICD), ), we perform Gibbs sampling on z1 =w\nICD based on Eq.(1) with fixed \u03a6(ICD)\n(7(t) xidikm\n=w'"}, {"title": "4 Dataset and Preprocessing", "content": "4.1 MIMIC-III dataset\nMedical Information Mart for Intensive Care (MIMIC) III contains de-identified EHR data from over 46,000 patients admitted to the intensive care units (ICU) of Beth Israel Deaconess Medical Center between 2001 and 2012 [21]. The MIMIC-III dataset was obtained and used in accordance with the PhysioNet user agreement. To preprocess the multi-modal EHR data, we followed the practice described in existing study [3]. Specifically, we pre-processed the ICD9 code, current procedures terminology (CPT) code, Diagnosis-Related Group (DRG) code, laboratory tests, medication, and doctor notes. We included the MIMIC dataset of entire admission data and the subjects were divided into single-admission and multiple-admission groups for the analysis in Section 5.1 where the distinction is further explored.\n4.2 PopHR dataset\nPopHR is a large-scale administrative healthcare data consisting of 1.3 million patients from the Quebec province of Canada between 1998 and 2014 [37]. It includes multiple data sources such as inpatient and outpatient physician claims, hospital discharge abstracts, and outpatient drug claims. We used three data modalities from this dataset: ICD-9 diagnostic codes, administrative procedure codes (ACT), and prescriptions from outpatient physician encounters. For prescription modality, we used active drug ingredients as unique IDs; for the other two modalities, we used ICD-9 and ACT codes, respectively. We removed all features with patient frequencies above 25% to mitigate the influence of common and non-specific features. The resulting dataset includes 5,738 unique ICD-9 codes, 6,544 ACT codes, and 1,235 drug ingredients for a total of 13,517 unique count features. Additionally, we utilized the PopHR dataset for longitudinal analysis, as the patients can encounter multiple occurrences of ICD-9 code across their medical histories.\n4.3 Phenotype guidance\nWe utilized the phenotype concepts from PheWAS and CCS systems with respect to the ICD-9 codes. The PheWAS systems maps ICD-9 codes to around 1,800 PheCodes (https://phewascatalog.org/phecodes) [13]. It provides a hierarchical structure of PheCodes, allowing us to capture phenotype concepts from various phenotypic grain. The CCS system maps projects ICD-9 codes to 212 CCS codes [1, 44]. In this study, we consider 2-decimal PheCodes and all CCS codes, associated ICD codes are observed in at least one patient in the EHR dataset. Consequently, we obtained 1641 Phe-Codes and 1570 PheCodes from the MIMIC-III and PopHR datasets, respectively."}, {"title": "5 Experiments", "content": "5.1 ICU mortality prediction using MIMIC-III\nIn this experiment using the MIMIC-III dataset, we evaluate that the modeling of subphenotype topics could improve mortality prediction by analyzing severity levels (Fig.S1 a). We divide the dataset into single and multiple-admission groups (Sec.4.1 and Fig.S1 a). The single-admission group is used to train the MixEHR-Nest model and estimate the topic distribution \u03a6, which is then used to infer the patient-topic mixture \u03b8 for the multiple-admission group based on their second-last admission records (Sec.3.4 and Fig.S1 a). We avoid the last admission, which contains mortality-related information. The patient-topic mixtures of the multiple-admission group are divided into training, validation, and test sets as inputs to classifiers (Fig.Sla), following standard machine learning practices, except that the input features are the topic mixtures inferred by MixEHR-Nest. We tuned the hyperparameter \u03b7 (Eq 11) using five different values of n to infer topic mixtures 0 for both the training and validation sets, resulting in five pairs of train and Oval. An elastic net or random forest (RF) classifier using the scikit-learn [33] was trained on train and Ytrain to predict mortality using Oval. We used the area under precision-recall curve (AUPRC) as the evaluation metric. The experiment was repeated for 20 random train-validation splits, and the model with the highest mean AUPRC was selected to predict mortality in the test set (Fig.S1 b). We compared two baselines: RF using a and feature count matrices measured by top K precision.\n5.2 Explaining mortality by subphenotypes\nIn this experiment, we assess the contribution of subphenotypes concerning ICU mortality prediction in theMIMIC-III dataset using a RF classifier. We computed global feature importance scores for all subphenotypes used by the RF and calculated SHapley Additive exPlanations (SHAP) values to explain individual mortality predictions [28, 29]. For each subject d, we calculated SHAP values for \u03b8d,km inferred by MixEHR-Nest from their second last admission. For the ascertainment analysis, we computed SHAP values of all subphenotypes in the top 100 patients with the highest mortality risk. We computed SHAP values using the public SHAP package.\n5.3 Insulin Usage Prediction\nTo assess the impacts of subphenotypes ondisease severity, we aimed to identify subphenotypes that can predict insulin treatment six months after the initial diabetic diagnosis, indicating the potential exacerbation of diabetic condition. Following the procedure described by [41], we extracted 78,712 diabetic patients with ICD-9 codes 250x from the PopHR dataset. These patients had continuous public drug insurance for hospitalization or medical billing, allowing us to track their medication records. We defined the start of insurance coverage as the date of a patient's first diabetes diagnosis. Patients were included if they had continuous public drug insurance following the diagnosis, defined by either (1) having at least 6 months of uninterrupted insurance or (2) having insurance"}, {"title": "5.4 Estimating age-dependent sub-phenotypes", "content": "In this experiment, we aimed to estimate the relative prevalence of its subphenotypes stratified by age using the PopHR dataset, which represents the general population in Montreal [37]. For each patient d, we computed its patient-topic mixtures \u03b8dkm as the estimated risk scores for the subtopic m within the phenotype k. For a given age tage, we identified the set of patients de Stage such that Tmin,d \u2264 tage \u2264 Tmax,d, where Tmin,d and Tmax,d are the first and last recorded ages of patient d in the PopHR dataset. Here, Stage denotes the set of all patients whose recorded age range includes tage. We then estimated the population-level prevalence of subtopic m within the phenotype k at age tage as the mean patient-topic mixture over Stage: km,tage Stage EdeStage \u03b8dkmTo estimate the relative prevalence over time, we used a predefined sequence of ages y to calculated the relative prevalence at age tage as pkm,tage,rel = Stey pkm,t Stey km, For the baseline prevalence of each phenotype k, we replaced the patient topic mixture km with the patient phenotype counts ndkm and then calculated the relative baseline population-level prevalence."}, {"title": "6 Results", "content": "6.1 Subphenotype inference from MIMIC-III\nWe first used CCS Codes for phenotype guidance by categorizing ICD-9 Codes into 281 broad disease categories. As a proof-of-concept, we employed the coarse-grained CCS taxonomy to demonstrate that MixEHR-Nest can refine these broad categories into clinically meaningful subphenotype topics. Using the MIMIC-III dataset, we showed that MixEHR-Nest's subphenotype topic inference using CCS codes '219-Short gestation; low birth weight; and fetal growth retardation' ('low birth') and '50-Diabetes mellitus with complications' ('diabetes'), selected for their detailed granularity levels. This approach highlights the potential of subphenotype topics to enhance disease categorization and improve clinical insights.\nTo achieve this refinement, selecting the parameter M-which determines the number of subphenotype topics-was critical. While in some previous studies, subtypes were not explicitly considered and M was typically set to 1, we explored the benefits of increasing this number. Based on findings in related works, which suggest that values of M = 3[51] or M = 4[27] are effective in many cases, we decided to focus on these two settings.\nTo demonstrate the impact of subphenotype topic numbers on disease interpretability, we experimented with varying the number M of subtopics per phenotype. At M = 1, our MixEHR-Nest"}, {"title": "6.2 High-risk sub-phenotypes in MIMIC-III", "content": "We utilized MixEHR-Nest to predict patient mortality based on training data from the second-last admission over eight months. As shown in Fig. 3, it illustrated the precision of various models for predicting ICU mortality among the top K patients. MixEHR-Nest achieved the highest precision of 0.34 for the top 300 patients.\nWe focused\non Cirrhosis due to its high mortality rate, ranging from 34% to\n69% [12]. The subphenotype 571.51-2 represents the most advanced\nstage, marked by severe complications and high mortality risk. The\nICD modality (Fig.5 a, ICD Modality) highlights severe cases such as\n\"Autoimmune hepatitis (571.42)\", which is associated with jaundice\nand amenorrhea [31]. In contrast, subphenotype 571.51-0 includes\nconditions like chronic hepatitis C with hepatic coma (070.44) and\nhepatorenal syndrome (572.4), often managed with antiviral thera-\npies [15]. Subphenotype 571.51-1 is characterized by features such\nas esophageal varices without bleeding (456.1) and unspecified viral\nhepatitis C with hepatic coma (070.71).\nIn the medication modality, methylprednisolone is a high-probability\nmedication for subphenotype 571.51-2, used to treat severe inflam-\nmation and immune response complications [20]. In the CPT modal-\nity, it shows that critical procedures such as cholecystectomy is\nassociated with high morbidity [11, 43]. Doctor notes frequently\nmention 'cirrhosis', 'lactulose', and 'encephalopathy' for subpheno-\ntype 571.51-2, highlighting its severity [7, 8] (Fig.5 a)."}, {"title": "6.3 Insulin usage prediction in PopHR", "content": "For the top risked patients in each subphenotype, we observed differences in their predictive power.Diabetes mellitus-3 demonstrated the highest precision up to the top 250 patients, while Diabetes"}, {"title": "6.4 Age prevalence of subphenotypes in PopHR", "content": "We leveraged the inferred patient topic mixtures to investigate the population-level prevalence of subtopic for 8 diverse phenotypes with respect to age and compared with the baseline using the PheCode counts (Fig.7). These diseases were selected as a proof-of-concept due to their diverse onsets across ages. Notably, the subphenotype trends exhibit more distinct patterns compared to the baseline trend, which appears averaged over the 3 subphenotype trends. For instance, asthma is known to exhibit two age peaks at 10 and 75. The inferred subphenotype asthma-2 is more prevalent at an earlier age, but less so at the later in life. In contrast, the baseline prevalence exhibits a much flatter pattern, averaging out the salient features from the three subphenotype prevalence trends. Leukemia exhibits two modes: one at around 10 years old as shown by leukemia-2 and leukemia-3; another at around 75 years old as shown by leukemia-1. Similarly, the three epilepsy subphenotypes show three stages of clear prevalence, which is unobserved in baseline method. Specifically, epilepsy-3 is more prevalent at early age; epilepsy-1 peaks at middle ages; and epilepsy-2 continues to rise into senior age. Depression subphenotype also exhibits intriguing pattern, indicating adolescence (depression-1), average age of pregnancy (depression-1), and menopause (depression-2). Depression-3 resembles the baseline population prevalence, remaining relatively low and stable across all ages, except after. Melanoma-2 and -3 exhibit similar prevalence patterns with a peak at 60 years old, while malanoma-1 and baseline show a delayed but significant rise in prevalence at a later age. In contrast, the prevalence for COPD, colon cancer and lung cancer is rather consistent among subphenotypes and baseline, with peaks at 80, 75, and 65 years old, respectively."}, {"title": "7 Discussion", "content": "The increasing adoption of EHRs and the advancement of automatic subphenotyping techniques provide numerous opportunities for healthcare applications such as personalized risk prediction and precision medicine. This stemmed from the realization that patients with seemingly homogeneous diseases often display varying severity and require potentially drastically different treatment plans according to the underlying cause of the symptoms. In this study, we propose a nested-guided topic modeling algorithm called MixEHR-Nest to simultaneously model the subtopics for more than 1500 phenotypes based on two high-dimensional and multimodal population-level EHR datasets. MixEHR-Nest can be guided by any expert-curated phenotype codes, nested with several subtopics controlled as a hyperparameter. MixEHR-Nest is highly scalable because of the use of the bag-of-words representations and the efficient collapsed Gibb-sampling topic inference algorithm inherited from its predecessors [18]. The learned latent subtopic mixtures are identifiable for all the diseases because we can confidently observe how the subtopics are associated with its main phenotype"}, {"title": "A Appendix", "content": "A.1 An example of prior initialization\nIn the case of MIMIC-III,f patient d has PheCode k, we raise the values in the kth row of ad to relatively high value (e.g., 0.9) compared to the hyperparameters corresponding to the unobserved PheCode (e.g., values randomly sampled from a range of [0.001, 0.01]). For example, suppose we have K = 4 PheCode-guided topics and M = 3 sub-topics per topic. If the patient d has ICD-9 code that belongs to the definition of PheCode 2 but nothing else, then the topic prior hyperparameter matrix \u03b1d is set to:\n\u03b1d =\n0.005 0.008 0.002\nIn the case of PopHR, we raise the values in the kth row of \u03b1d to the two-component Poisson and Lognorm mixture model estimate, while keeping other rows 0.\nA.2 Example of initialization of sufficient statistics\nFor example, suppose a patient d has two ICD tokens x1d , x2d and one non-ICD token x1 . The ICD token x1d has been \nassign with one of the three subtopics k1,k2, k3 and x(non-ICD)\nd ,we randomly (non\u2212ICD) with one of the six subtopics k1, k2, k3, k1, k2, k3. We then increment (non-ICD)  1 and (non-ICD\n\n(ICD)  (ICD) \nassign it with with one of the six subtopics k1, k2, k3, k1, k2, k3. We then increment A3 LDA using collapsed Gibbs Sampling Derivation"}]}