{"title": "SANDWICH: Towards an Offline, Differentiable, Fully-Trainable Wireless Neural Ray-Tracing Surrogate", "authors": ["Yifei Jin", "Ali Maatouk", "Sarunas Girdzijauskas", "Shugong Xu", "Leandros Tassiulas", "Rex Ying"], "abstract": "Wireless ray-tracing (RT) is emerging as a key tool for three-dimensional (3D) wireless channel modeling, driven by advances in graphical rendering. Current approaches struggle to accurately model beyond 5G (B5G) network signaling, which often operates at higher frequencies and is more susceptible to environmental conditions and changes. Existing online learning solutions require real-time environmental supervision during training, which is both costly and incompatible with GPU-based processing. In response, we propose a novel approach that redefines ray trajectory generation as a sequential decision-making problem, leveraging generative models to jointly learn the optical, physical, and signal properties within each designated environment. Our work introduces the Scene-Aware Neural Decision Wireless Channel Raytracing Hierarchy (SANDWICH), an innovative offline, fully differentiable approach that can be trained entirely on GPUs. SANDWICH offers superior performance compared to existing online learning methods, outperforms the baseline by 4e-2 rad in RT accuracy and only fades 0.5 dB away from toplined channel gain estimation.", "sections": [{"title": "I. INTRODUCTION", "content": "Wireless ray-tracing (RT) approaches model interactions between electromagnetic (EM) waves and their physical environment. Recent years have seen increased interest in wireless RT due to its potential to capture complex signal behaviors, especially in B5G and 6G scenarios [2, 4, 15, 29, 8, 6, 12, 28, 24]. Traditionally, RT relies on computationally intensive Maxwell equations (ME) or specialized wireless raytracers, where complex solvers [1] are introduced by integrating heuristics from geometrical optics (GO) and uniform theory of diffraction (UTD). Thanks to computational EM theory [13], one can use shooting and bouncing rays sequence (SBS) while being GO/UTD-compliant to approximate EM waves in high frequency.\nWireless RT Surrogate. Recently research has been exploring learning-based methods as RT surrogates [15], aiming to reduce the computational costs of traditional wireless ray tracers and improve their scalability. In this context, Wireless RT is typically formulated as a sparsely-supervised and non-differentiable objective. Since the transmitter (Tx) emits a large volume of GO/UTD-feasible rays, only a small, countable subset of these rays are relevant for wireless reception at the receiver (Rx).\nSeveral approaches have been proposed in the literature to address such challenges. For example, Orekondy et al. [15] mitigate these issues through online, continuous feedback mechanisms, such as temporal difference (TD) learning. Alternatively, other approaches, such as those in [8] and [4], employ monte carlo (MC) methods to collect and refine a diverse set of ray trajectories. Nevertheless, existing methods are hindered by several significant limitations: 1) Dependence on real-time feedback from radio environment modeling or RT engines during training, 2) Incompatibility with GPU-based training, and 3) Lack of support for vectorization, thus limiting the ability to process batches of rays efficiently.\nProposed Method. In this paper, we address wireless RT in indoor environments, considering Tx/Rx locations, signal-surface interaction, and surface texture information. We propose scene-aware neural decision wireless channel raytracing hierarchy (SANDWICH): a novel transformer-based offline learning method to perform wireless RT. SANDWICH addresses the aforementioned limitations by allowing learning from a limited set of collected RT results, without assumptions on the radio environment or supervision density. Additionally, our goal is to develop efficient and scalable wireless RT surrogates that eliminate the dependency on online supervision, and enable a vectorized, GPU-trainable neural wireless RT surrogate.\nTo achieve our objectives, and inspired by the success of generative pre-trained transformers (GPTs), we suggest that"}, {"title": "III. PROBLEM FORMULATION", "content": "3D Channel Modeling. Wireless RT is a specialized subfield within wireless channel estimation, particularly relevant in 3D environments where millimeter-wave (mmWave) propagation can be statistically described as follows [20]:\n$h(t,\\Theta, \\Phi) = \\Sigma_{r_k \\in {r}} a_k(t) \\delta(t-\\tau_k(t)) \\delta(\\Theta-\\Theta_k(t)) \\delta(\\Phi-\\Phi_k(t))$   (1)\nIn Eq. (1), where a wireless channel is represented by a set of rays (denote as $\\{r_k\\}$, with cardinality $|\\{r_k\\}| = K$). Each ray $r_k$ is characterized by its signal gain $a_k(t)$, one-way delay $\\tau_k(t)$, and phase $\\Theta_k(t), \\Phi_k(t)$ for arrival and departure angle, respectively, expressed using Dirac function $\\delta$. These parameters summarize the property of SBS, which includes a series of ray-surface interactions, in the environment $F$.\nMDP on Wireless RT. Given the locations of the Tx and Rx, denoted by $loc(Tx)$ and $loc(Rx)$ respectively, a set of rays $\\{r_k\\}$ are emitted from Tx and interacts with F through a designated simulator S until received at Rx [2, 18]. Following the work in [15], the RT training formulation can be done through an MDP (S,A,P), decomposing the ray set $\\{r_k\\}$ into state space $S \\subset R^3$, action space $A \\subset SO(3)$, where $SO(3)$ denotes 3D rotation group, and transition dynamics P. Each state $s_i \\in S$ represents the coordinate of a ray in its trajectory, while each action $a_i = (\\phi, \\theta) \\in A$ denotes the radian $\\phi$ and azimuth $\\theta$ out-angle relative to the previous hop $S_{i-1}$. The interaction $t_i$ at each state $s_i$ can be categorized into three types: reflection (R), diffraction (D), and penetration (P) that attributes on $s_i$ as property of wireless signals. The transition function is defined as $P(S_{i+1}|S_i,a_i)=S(F,s_i,a_i)$ through S as collected experience in SBS. A logic-based receiver classifier $Rec(Rx, F, \\{r_k\\})$ determines if the rays in $\\{r_k\\}$ successfully reach the Rx. The objective is to learn a neural policy $\\pi_{out}$ that predicts identical ray set $\\{r_k\\}$ on new $loc(Tx)$, $loc(Rx)$ with S's estimation.\nSuch MDP formulation of wireless RT integrates several inherent challenges: 1) Sparse Supervision/reward: Reward signals are granted on a per-SBS basis, spanning across a sequence of decisions, leading to sparse supervision. 2) Non-differential Objective: Wireless ray propagation is influenced not only by the locations and configurations of the Tx and Rx but also by the 3D structure and texture of the environment. Consequently, wireless RT results may not be differentiable in a 2D plane, emphasizing the need for a sequential representation-based learning approach. 3) OOD Samples in S: To demonstrate the generalization capabilities of the proposed model, the test environment includes novel Tx and Rx locations $loc(Tx)$, $loc(Rx)$, resulting in an extrapolated state space. This highlights the necessity of incor-"}, {"title": "IV. METHODOLOGY", "content": "The key idea is to preserve the ray generation process as stateful, with each generation step conditioned by the whole generated sequence. This is critical to handle the sparse rewards of wireless RT within an offline RL framework, as the expected return is granted for the whole SBS, outlined in PF I. Such insight diverges from greedy policy's state embedding [15], (Tx,Rx)-conditioned embedding [23, 21], or upsampling methods used to densify existing RT results [22].\nDecision Transformer. DT [3] is promising for handling sequential decision-making by referencing all prior decisions within a sequence. DT models are prompted by the expected return $E(R_{tg}(r_k))$ to perform auto-regressive generation against sets of wireless RT SBS GT $\\{r_k\\}$, which makes end-to-end sequential decision-making differentiable. DT takes the input form as a sequence of $\\{(s_i,a_i,r_{tgi})\\} \\in (S,A,R_{tg})$, as illustrated in Fig. 2, To offer a near-differentiable reward measure $R_{tg}$ to such sequence, we propose a novel fitness function $R_{SBS}(r_k,\\{r_k\\})$ to formulate the collective reward $R_{tg}(r_k)$:\n$R_{tg}(r_k)=R_{SBS}(r_k,\\{r_k\\})=-argmin(\\underset{r_k'\\in\\{r_k\\}}{L_{ray}(r_k,r'_k)}-P_{\\angle}(r'_k,F))$   (2)\nIn Eq. (2), $L_{ray}$ is an angular set-based loss that supervises the geometric scale:\n$L_{ray} (r_k,r'_k) = \\Sigma_{j \\in [L]}W_jlog(a_j-a'_j|), a_j \\in r_k$.  (3)\nIn Eq. (3), $w_j$ is a heuristic reverse sequential weight to encourage the transformer to learn the Markovian properties of the sequence. Unlike an increasing weighted reward in Vanilia DT, this decreasing weighted reward emphasizes supervision on the closest match to the GT ray during the early generation steps. This approach helps avoid a trivial solution that could arise between two optimal matches.\n$P_{\\angle}(r'_k,F)=o_B(r'_k,F)+\\Sigma_{j\\in\\{r\\}}B_U(\\{(a'_j,t_j)\\\\})+T_E(r'_k,Rx)$   (4)\nIn Eq. (4), $o_B(r'_k,F)$ penalizes any outbound attempts by $r'_k$ from F. The term $T_E(r, Rx)$ introduces a penalty $e_d$, where $d\\geq d_o$, if $r$ misses $loc(Rx)$ by a tunable distance $d_o$. Lastly, $B_U(\\{(a',t_j)\\\\})$ ensures geometric consistency between (a',tj):\n$B_U(\\{(a',t_j)\\\\})=\\begin{cases}\nargmin_{a'_j}(|1_{ax}a'_j|-|1_{ax}a'_{j-1}|) & \\text{if } t_j =R\\\\\n-10 & \\text{if } t_j=P,a'_j \\neq a'_{j+1}\\\\\n0 & \\text{otherwise}\n\\end{cases}$   (5)\nIn Eq. (5), a' is the directional vector defined by a', while $1_{ax}$ denotes a set of unit vectors along the 3D axes. $R_{SBS}$ aligns the expected return with wireless RT performance while addressing reachability and GO constraints. Such correspondence fitness is inspired by the adversarial clustering method described in [17]. The holistic metric of SBS validity enables DT to operate without requiring per-action, online supervision, allowing wireless RT tasks unconstrained by simulators (in contrast to [15, 26]), and empowers vectorization and GPU-training.\nFib Augmentation. DT shares a suboptimal generalization performance as per [9, 14], either promoted by OOD expected return or state space, especially in SBS testset including OOD Tx, Rx locations. To handle such challenge, We propose the following building blocks: 1) We introduce a data augmentation scheme, Fib($r_k$), leveraging the Fibonacci sphere to generate augmented SBS with non-trivial dynamic properties. This approach is inspired by Rogne [19]. 2) Additionally, we incorporate state supervision into the backbone DT to enforce scene awareness during ray interactions. This is achieved through a loss function $L_t(r_k, F)$ designed to hint DT on aware of interaction type alongside with ray generation, inspired by DADT. [9].\nSuch building blocks are housed in the training pipeline, referenced in Fig. 2: i) SBS Extraction: We segment each $r_k$ into set of sequential action and state type $\\{(a_j,t_j)\\}_{k}$, where $a_j = (\\phi_j,\\theta_j)$. ii) Fib Augmentation: We generate a batch of normal Fibonacci spheres for each $a_j$ and sampled augmented ray $Fib(r_k)=r_k=\\{(a_j,t_j)\\}_{k}$ by introducing tunable variances $(\\sigma_{\\phi},\\sigma_{\\theta})$ around $(\\phi,\\theta)$. iii) Decision Sequence Formulation: We apply $R_{SBS}$ to $R_{tg}$ for the augmented dataset, shuffled"}, {"title": "V. EXPERIMENTS", "content": "We train SANDWICH and other baseline models for environments from the SOTA DeepLayout [27]. We create a standalone GYM environment for each layout and test against 3 test sets [CHECKERBOARD, GENZ, GENDIAG], as introduced in [15]. CHECKERBOARD only includes OOD Tx sample, with identical Rx location, GENZ introduces Rx locates on a different horizontal plane, while GENDIAG introduces Rx location from a novel distribution in the 3D environment. All test sets include 15 novel Tx locations and approximately 1800 Rx locations, each (Tx, Rx) pair includes at most 30 possible rays.\nAblation Against Decision Transformer Families. To prove the effectiveness of introduced novel building blocks, we conduct an ablation study against vanilla DT (train against $L_{ray}$) and DT with Lt. We train with the same hyper-parameter and test against all three test sets, and compare the best baseline from [15] as a reference in Fig. 3. Both the Fib($r_k$) and $L_{type}$ contributes to SANDWICH's superior performance over vanilla DT and baselines. Also, due to bias propagation in generation task [11], applying $L_{type}$ and Fib($r_k$) can restrain such degradation when path length increases.\nWireless RT: Geometrical Accuracy. We consider the performance of wireless RT accuracy by mean averaged angular loss in all three test sets. We compare our proposed solution against claimed and reproduced baselines in [15]. As no code was available for reproducing the baselines, for MLP baseline [21, 23], we consider a hyper-parameter search scheme towards downstream tasks for non-provided hyperparameters, i.e.: batch size, number of epochs, and formulation of angular supervision. For KNN baselines [22], we offer 2 forms of reproduction 1) We reproduce according to [15] which offers an n=1 matching within Tx and Rx between train and test sets. 2) We run n=6 KNN and pick the best-performing neighbor for angular loss, this upper-bounds the vanilla KNN reproduction performance as per claimed in [22]. For WINERT baseline, the logic component is not provided so we only apply claimed performance. We show that the proposed SANDWICH outperforms the previous baseline method in different generalizations of (Tx, Rx) locations.\nTurbo learning: RT as a prior for RSSI estimation. Finally, we consider using generated rays as prior for received signal strength indicator (RSSI) prediction to examine the usability of wireless RT. The GCE serves as a topline that takes GT wireless RT as input, which bounds the best capability of the GCE. We apply the generated ray through SANDWICH to GCE and compare it against the topline and non-wireless RT-based solutions, with their implementations the same as in Table II. In Table I, we show that SANDWICH generated ray provides similar performance as GCE using GT wireless RT result while outperforming other non-RT based baselines."}, {"title": "VI. CONCLUSION", "content": "We propose SANDWICH, a novel wireless RT neural surrogate that is offline, fully differentiable, and GPU-trainable. We enhance model accuracy by employing a DT with state supervision and introducing a novel data augmentation technique. We demonstrate generated wireless RT provides prior knowledge comparable to a genuine wireless raytracer in channel modeling. This work enables efficient, reliable wireless RT solutions adaptable to various environments, with potential future advancements in scene reconstruction and joint communication-sensing integration."}]}