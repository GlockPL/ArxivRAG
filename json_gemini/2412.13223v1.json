{"title": "Generative modeling of protein ensembles guided by crystallographic electron densities", "authors": ["Sai Advaith Maddipatla", "Nadav Bojan Sellam", "Sanketh Vedula", "Ailie Marx", "Alex Bronstein"], "abstract": "Proteins are dynamic, adopting ensembles of conformations. The nature of this conformational heterogenity is imprinted in the raw electron density measurements obtained from X-ray crystallography experiments. Fitting an ensemble of protein structures to these measurements is a challenging, ill-posed inverse problem. We propose a non-i.i.d. ensemble guidance approach to solve this problem using existing protein structure generative models and demonstrate that it accurately recovers complicated multi-modal alternate protein backbone conformations observed in certain single crystal measurements.", "sections": [{"title": "1 Introduction", "content": "Proteins are dynamic molecules, transitioning between states during biological processes and otherwise thermodynamically sampling conformations within these states. Although models generated by X-ray crystallography typically depict a single conformation, this is actually an ensemble measurement. Protein crystals are an enormous array of molecules and the electron density reconstructed from the diffraction captures variability between the atom locations in this array. As flexibility in the protein chain increases, the electron density becomes increasingly spread out. Since it is difficult to recognise and model the specific conformations giving rise to the average density, variability around the best-fit model is typically reported only indirectly, in the form of the B factor. However, where detectable, crystallographers model atoms in multiple alternate locations (commonly termed, altlocs). Alternately located segments of the protein backbone have remained under-recognised, since most visualisation platforms (e.g., pymol and chimeraX) and programs using structural models as inputs (e.g., gromacs) ignore altlocs altogether or resolve them with simple heuristics [4]. A recent work [11] created a comprehensive catalogue of altlocs extracted from PDB structures, suggesting that this dataset should find use in efforts towards predicting multiple structures from a single sequence. Interestingly, the authors showed that for a set of well-separated and stable altlocs, even if structural ensemble predictors recognise the region as being flexible, they fail to capture the experimentally determined conformations or even the bimodality of the distribution of backbone conformations.\nRepresenting proteins as ensembles of model structures, better capturing their dynamic nature, is a key goal in structural biology [15] and protein structure prediction. We suggest an generative approach that directly produces samples that are faithful to the experimental data. We showcase the proposed approach on electron densities resolved from X-ray crystallography, focusing on altloc regions having at least two clearly distinct conformations."}, {"title": "2 Methods", "content": "Notation. We denote by a the amino-acid sequence, x the backbone coordinates of a protein structure, and let x be the sidechain dihedral angles from which the side chain atom coordinates can be straightforwardly computed and denoted by {yi(x, x, a)}. Note that the dependence on the sequence a is implicit as the amino acid identities are required to calculate the atom locations from x and X. We denote by p(x) the distribution of the random variable x, and by F\u3002: R\u00b3 \u2192 R and F: R\u00b3 \u2192 R the observed and calculated electron densities, respectively.\nProblem setting. Given an experimentally observed electron density of a protein structure Fo and the amino-acid sequence a, our goal is to recover the posterior distribution p(x, xa, Fo) of protein structure that explains F\u3002by sampling a non-i.i.d. ensemble X = {(xm,xm)} from it. Following the standard Bayes' theorem, the posterior of the ensemble can be factorized as p(Xa, Fo) x p(Fo|X,a) \u00b7 p(X|a) = p(Fo|X,a) \u00b7 \u041fk p(xm, xm|a), where p(F\uff61|X, a) is the likelihood of observing Fo given a structure ensemble X and p(x, xa) is the prior distribution of the protein conformations given the sequence. It is crucial to observe that the samples in the ensemble are not independent. While the prior can be split into independent terms p(xm, xm|a), the likelihood generally depends on all the samples at once and is, therefore, inseparable. Our approach is summarized in Figure 1.\nProtein structure prior.\nWe employ Chroma [5] to model the distribution of feasible protein structures. While other protein structure generative models exist [1, 6], we chose Chroma because it is a score-based generative models, and it effectively models p(x, x, a).\nWe also experimented with distributional graphormer (DiG)[17], however, we found that the score modeled by DiG is unstable, and it models only the backbone atoms, and does not model backbone oxygens and sidechains, which contribute to majority of the electron density.\nChroma models the all-atom representation of the protein structure by the fol-lowing factorized form, p(x, x, a) = p(x)p(a, x|x), where the distribution of backbone coordinates, p(x), is modeled via a score-based diffusion model, and p(a, x|x) is modeled as an autoregressive model. Chroma's forward diffusion process is modeled as a variance-preserving SDE [13], whose"}, {"title": "", "content": "backward SDE is given by,\ndx = \\left[-\\frac{1}{2}x - PP^T \\nabla_x \\log p_t(x)\\right] \\beta_t dt + \\sqrt{\\beta_t} Pn,\nwhere P is a fixed preconditioning matrix, Bt is the noise schedule, and n is isotropic Gaussian noise. The score function \u2207x log pt (x) is modeled as an equivariant graph attention network. Sampling occurs by first drawing backbone coordinates by integrating Eq. 1 from [T, 0]. Modeling xall given x is presented in the sequel. Because Chroma models the backbone coordinates x independently to the sequence, conditioning xall on the sequence a can be done trivially by substitution. We discuss the details of sidechain packing in Section A.1 in the Appendix.\nModeling the likelihood. Assuming p(F\uff61|X, a) is Gaussian, the log-likelihood of Fo is given by,\nlogp(F\uff61|X, a) = - \\frac{1}{2} ||F\uff61 - \\frac{1}{|X|}\\sum_m F(x^m, x^m, a)||_2^2,\nwhere || ||2 is the L2 norm in the space of electron densities, and the individual F\u025b terms are given by the kernel density estimates,\nF_c (\\xi) = \\sum_{k=1}^{N_s} \\sum_{i=1}^{N_A} \\sum_{j=1}^{5} A_{ij} \\left( \\frac{4\\pi}{b_{ij} + B} \\right)^{3/2} \\cdot \\exp \\left(-\\frac{4\\pi^2}{b_{ij} + B} \\cdot ||R_k y_i(x^m, x^m, a) + t_k - \\xi ||^2 \\right),\nwhere Ns is the number of symmetry operations, A is the number of atoms in the asymmetric unit, Rk is the rotation matrix of the k-th symmetry operation, tk is the translation vector of the k-th symmetry operation, y is the location of the i-th atom, aij and bij are tabulated form factors [10], B is the B-factor, and & is the point in space at which density is calculated. In standard molecular replacement and structure refinement pipelines, the B-factor is used to model the experimental electron density as a mixture of Gaussians. In our approach, however, we essentially sample directly from the joint distribution of the atom locations which allows more complex density models. The B-factor is, therefore, more akin to the bandwidth parameter in kernel density estimation (KDE) techniques. We apply a uniform B-factor across all atoms that should be inversely proportional to the ensemble size. Ideally, the optimization of the exact value should be part of the sampling procedure that we intend to develop in the future; here, we adopted a somewhat naive approach by taking the average of the individual B-factors for each atom in the given protein structure.\nSampling from the posterior. To sample a non-independent ensemble from the posterior, we define the joint diffusion variable X = (x1,...,x|x|) concatenating all backbone coordinates of the ensemble, and plug Eq. 2 into the backward SDE equation [3, 16],\ndX = \\frac{1}{2}\\left[-X-PPT (\\nabla_x \\log p_t (X) + \u03b7\\cdot \\nabla_x x\\log p(F\uff61|X, X(X), a))\\right] \\beta_t dt + \\sqrt{\u03b2e}Pn.\nNote that the diffusion is only applied to the backbone coordinates, from which the sidechain dihedrals X(X) = (x1,...,x|x|) are calculated using the differentiable sidechain packer. While the unconditional (prior) score term, \u2207x log pt (X), is separable (i.e., block diagonal), the guidance term is inseparable as mentioned above. The hyperparameter \u03b7 is used to scale the guidance score directing the diffusion model to generate samples that are better aligned with the observed density, thereby increasing the likelihood of Eq. 2.\nFiltering samples using matching pursuit. We observed that when sampling large ensembles using non-i.i.d. guidance, certain samples in the ensemble tend to overfit to noise in the density map, reducing the overall ensemble quality. To mitigate this, we adopt a matching pursuit-based approach [8] to filter out low-quality samples and greedily select a subset of the ensemble, X\u2081 = {(xm, xm) : m\u2208 I}, that best aligns with Fo. Starting with I = (), each iteration seeks to maximize log gp(Fo|XI\u222a{m}, a) over all m \u2209 I. The optimal element m is then added to the support set I and the process is repeated until the likelihood no longer increases. The procedure is summarized as Algorithm A2 in Appendix A."}, {"title": "3 Results", "content": "Experimental setup. To evaluate the efficacy of our methods, we primarily aim to assess the alignment between the density computed from sampled conformers, Fc, and the experimentally observed densities, Fo. Additionally, we seek to investigate the ability of our approach to generate accurate conformers in the structural space. We, therefore, focus on regions where the density exhibits multi-modal behavior and aim to recover alternate locations (altlocs) consistent with those modeled in the original PDB structures. To facilitate these investigations, we selected crystallographic protein structures from the Protein Data Bank (PDB) [2] that exhibit discernible separation between backbone and sidechain atoms at the altloc residues using the analysis in [11]. Note that all these examples present highly intricate multi-modal backbone distributions that are poorly predicted by existing ensemble sampling techniques. We further restricted our attention to high resolution structures (2.5 \u00c5 or better) to ensure high-quality electron density maps. Since the electron density maps available in the PDB are mean-centered and lack an absolute scale, we converted them to physical units (e\u00af/\u00c5\u00b3) following the method described in [7]. A comprehensive list of proteins used in our experiments is reported in Table A3.\nFor all experiments, we will use the publicly available versions of Chroma's diffusion-based backbone sampler and Chroma's GNN-based sidechain packer for x-angle prediction as our prior [5]. Since the backbone sampler is not sequence-conditioned, applying density guidance across the entire protein would exacerbate the ill-posed nature of the problem. To mitigate this, we employ Chroma's SubstructureConditioner to constrain atoms outside the target residues to their ground truth locations. All visualizations were rendered using ChimeraX [9].\nEvaluation criteria. The results were evaluated using a batch sampling approach. For each batch, we identified a subset of samples that provided the optimal match to the observed electron density. The similarity between the observed electron density and the mean calculated density of the selected subset was quantified using cosine similarity \u3008F\u3002, Fc)/(||Fo||\u00b7 || Fc||) in the space of electron densities. Furthermore, we computed an alternate location (altloc) proximity score for each sample in the batch. The score was calculated as bimodality_score(x) = (1 \u2013 min(r(x), 1/r(x))) \u00b7 sign(r(x) - 1/r(x)), where r(x) = ||x - XA||/||X - XB||, and x\u0104 and xB are the backbone atom locations of altlocs A and B, respectively. In this formulation, score(x) approaches \u20131 as x converges to altloc A, and approaches +1 as x converges to altloc B."}, {"title": "", "content": "Density alignment. To evaluate the proposed method's effectiveness in aligning with Fo, we compare the samples generated using density-guided diffusion with those from an unconditional diffusion process. Using the procedure outlined in Algorithm A1 we sample a batch of 16 density-guided conformers. Likewise, a batch of 16 unconditional conformers are sampled using Eq. 1. Both batches are filtered (Algorithm A2) to retain at most 5 samples that best fit the observed Fo map. From these best-performing conformers, we construct the Fe map and compute the correlation with Fo using cosine similarity. This evaluation is repeated across all proteins listed in Table A3. The quantitative results comparing unconditional sampling and density-guided sampling are presented in Figure A3. Due to variations in resolution, the results are not comparable across proteins. However, we note that while Chroma provides a strong prior for protein structures, it struggles to accurately capture experimental density. This reinforces the finding that other protein ensemble sampling programs cannot correctly reproduce the observed densities in such intricately flexible regions [11]. Additionally, Figure 2 visually showcases, on three structures, how guided sampling improves the alignment between Fc and Fo.\nBimodality and structural alignment. We evaluate the impact of aligning with the experimental density on the structural space. Specifically, we focus on regions of proteins with alternate conformations (altlocs) where the density exhibits a bimodal distribution. By conditioning our diffusion process on Fo, we aim to capture this bimodality and generate samples consistent with the originally modeled altlocs in the PDB. From the aforementioned experiment, we utilize the filtered samples from both density-guided and unconditional ensembles. Each sample is assigned proximity score to one of the altloc (A or B). The resulting score distributions are visualized in Figure 3. Guided sampling consistently achieves bi- and multi-modal behavior with proximities to both modeled altlocs (positive and negative modes in the plot), while the unconditional counterpart often fails to correctly represent this behavior. Additionally, our method performs well in regions with unimodal density and no alternative conformations, as detailed in Section A.3 and visualized in Figures Al and A2 in the Appendix."}, {"title": "4 Conclusion", "content": "In this work, we presented a novel density-guided generative modeling approach for reconstructing protein structure ensembles from crystallographic electron density maps. By formulating the task as an inverse problem, we leveraged a pre-trained diffusion model as a flexible prior over protein backbone conformations, introducing a non-i.i.d. score guidance technique that optimizes the ensemble as a whole, rather than individual structures thereof. Our method outperforms unconditional sampling, particularly in multimodal regions, recovering altlocs consistent with PDB data and aligning more closely with the observed electron densities. Looking forward, our method opens several promising directions for future exploration, such as extending to larger proteins, enhancing the modeling of B-factors, improving sidechain packing accuracy, and extending to the forward models of other experimental modalities such as cryoEM/ET. We believe that our work also provides an important step toward more accurate and data-driven modeling of protein dynamics."}, {"title": "A Appendix and Supplemental Material", "content": "A.1 Side-chain packing\nAs previously mentioned in Section 2, the diffusion model's prior is defined over the backbone coordinates of the protein structure. However, majority of the electron density is concentrated near the sidechain atoms. To account for this, we leverage Chroma's sidechain packer to sample the X dihedral angles and impute the sidechain atoms using the sampled angles and the rotamer library [12]. Since the density map is generated from a noise-free protein structure, we denoise the backbone atoms x at each iteration using the diffusion model before computing the x angles. The denoised variable xo serves as an estimate of the noiseless backbones x.\nThe X sampler is an autoregressive sidechain decoder that models le (x|x, a) \u2248 log p(x|x), where \u03b8 denote the model parameters. The autoregressive decomposition of the likelihood is given by\nlo(xx, a) = \\sum_{i}lo(Xi | Xi-1, Xi-2, ... X1, a, x).\nOnce the x angles are sampled, the combination with the backbone coordinates x fully describes the protein structure.\nUnfortunately, sampling x angles for every amino acid at each timestep of the diffusion process introduces a significant computational bottleneck, which can severely impede the sampling procedure. To mitigate this, we restrict x dihedral angle sampling to the amino acids being optimized, along with a window of size W = 5 amino acids before and after the target region. Incorporating this window provides the model with greater structural context, thereby enhancing the accuracy of the angle predictions. For non-target residues, where the structure is anchored by the SubstructureConditioner, X angles are computed using the ground truth coordinates from the PDB file.\nAdditionally, performing x dihderal angle sampling and backpropagating through the X sampling and the diffusion models at every iteration results in an excessively long and computationally expensive backpropagation graph. Given that atomic coordinates generally exhibit minimal change between iterations, this repeated sampling and backpropagation can become redundant. Hence, we implement a Gibbs-sampling-based optimization strategy [14].\nSpecifically, we sample the dihedral angles only once every Tx iterations and then detach them from the backpropagation graph. During the intermediate iterations, we freeze the backbone coordinates x and optimize the angles Sx times based on Eq. 2. This approach stabilizes the backpropagtaion process while ensuring that the sidechains conform to the observed density Fo.\nThe specifics of sidechain packing are presented in Algorithm A1.\nA.2 Hyperparameters\nIn our experiment, we employed a guidance scale of 9.0 and clipped the gradient norms to a maximum of 32.5. The X diheral angels were resampled every 40 diffusion steps (Tx). For each diffusion step, 25 SGD optimization steps (Sx) were performed on the x with a step size of 0.001. We generated a batch of 16 samples with non-i.i.d guidance. Notably, all the results presented in this paper were obtained using these hyperparameters without any additional tuning, highlighting the simplicity and robustness of our density-guidance approach.\nA.3 Unimodal densities\nAs a control experiment, we evaluated our method on protein 7EC8, specifically on chain B, which exhibits unimodal behavior. We sampled two regions: residues 205-208, which are characterized by a low B-factor, and residues 143-146, which display a higher B-factor. Although both regions are unimodal, the increased B-factor in residues 143-146 led to more spread-out and blurred density, resulting in slight variability in the samples. The cosine similarity results for both regions are shown in Table A1, demonstrating that our guided method consistently outperformed the unconditional approach. A visual comparison of the results is presented in Figures Al and A2."}, {"title": "A.4 Ablation", "content": "We conducted an ablation study on the batched (non-i.i.d) sampling procedure. As discussed in Section 2, our density-guidance approach leverages a batch of non-i.i.d samples, where we compute an expectation over Fe maps and compare it to Fo as depicted in Eq. 2. In contrast, when we generate i.i.d samples by optimizing each sample individually without taking an expectation \u2013 the performance deteriorates, as shown in Table A2."}, {"title": "A.5 Algorithms", "content": "Algorithm A1 Density-guided backbone sampling\nRequire: Backbone denoising diffusion model \u20ac\u03b8; X sampling model X\u04e9; X resample time steps Tx; number of x optimization steps Sx; x optimization step size Xx; target density Fo; number of diffusion steps N; guidance scale \u5165; preconditioning matrix P; diffusion schedule constants {an}=1, {n}=1 as in chroma; amino acid sequence of the protein a; F density forward model.\n1: z ~ N(0, I)\n2: XN = Pz\nN\n3: for n = N to 1 do\n4: n ~ N(0, I)\n5: \u20ac = \u03b5\u03c1 (\u03c7\u03b7, \u03b7)\n6: \u03bc = 2(1) \u03a7\u03b7VanVan+1\u03b1\u03c0\u00e2n\u00e2n\n7: x0 = \u03a7\u03b7 \u2013 \u221a1 \u2013 \u03b1\u03c0\u00eaVan\n8: if n \u2208 Tx then\n9: \u00c2n = \u03c7\u03b8(20) \u25b7 Optimize the side-chain angles\n10: else\n11: Initialize Xn,0 = Xn+1\n12: for i = 0 to Sx - 1 do\n13: Xt,i+1 = Xt,i - xx\u2207x ||Fc(all_atom(x0, Xt,i, a)) \u2013 Fo||2\n14: end for\n15: \u00c2n = Xn,Sx\n16: end if\n17: Xn-1 = + AVx [||Fc(all_atom(x0, Xn, a)) - Fol|2] + \u221aBPn \u25b7 Eq. 4\n18: end for\n19: return x0\nAlgorithm A2 Selecting samples using matching pursuit [8]\nRequire: D = {d1,...,dn}: Sample densities (F) from forward model, dt: Target density from Fo density map, corr(\u00b7, \u00b7): Function to compute correlation metric, mmax: Maximum allowed samples to select, a: Amino Acid sequence of the protein\n1: I = 0\n2: P = {0, 1, 2, . . ., |D| \u2212 1}\n3: Scurrent = 0\n4: while I < mmax do\n5: c = {corr(dz\u222a{i}, dt) | di \u2208 D, i \u00a2 P}\n6: best, Smax = argmax c, max c \u25b7 Maximize log p(Fo|XTU{ibest}, a)\n7: I = IU {ibest} \u25b7 Add best sample\n8: P = P \\{ibest} \u25b7 Update candidates\n9: if Smax Scurrent then\n10: break\n11: end if\n12: Scurrent Smax\n13: end while\n14: return I"}]}