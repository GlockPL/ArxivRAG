{"title": "HybridLinker: Topology-Guided Posterior Sampling for Enhanced Diversity and Validity in 3D Molecular Linker Generation", "authors": ["Minyeong Hwang", "Ziseok Lee", "Kwangsoo Kim", "Kyungsu Kim", "Eunho Yang"], "abstract": "Linker generation is critical in drug discovery ap- plications such as lead optimization and PROTAC design, where molecular fragments are assembled into diverse drug candidates. Existing methods fall into PC-Free and PC-Aware categories based on their use of 3D point clouds (PC). PC-Free models prioritize diversity but suffer from lower validity due to overlooking PC constraints, while PC-Aware models ensure higher validity but re- strict diversity by enforcing strict PC constraints. To overcome these trade-offs without additional training, we propose HybridLinker, a framework that enhances PC-Aware inference by providing diverse bonding topologies from a pretrained PC- Free model as guidance. At its core, we propose LinkerDPS, the first diffusion posterior sampling (DPS) method operating across PC-Free and PC- Aware spaces, bridging molecular topology with 3D point clouds via an energy-inspired function. By transferring the diverse sampling distribution of PC-Free models into the PC-Aware distribu- tion, HybridLinker significantly and consistently surpasses baselines, improving both validity and diversity in foundational molecular design and applied property optimization tasks, establishing a new DPS framework in the molecular and graph domains beyond imaging.", "sections": [{"title": "1. Introduction", "content": "Fragment-based drug discovery strategically assembles molecular fragments to create stable and effective drug can- didates. A key challenge is linker generation, which involves designing molecular linkers that connect fragments while ensuring their validity. In this work, we categorize existing linker generation models into Point Cloud Free (PC-Free)"}, {"title": "2. Background", "content": ""}, {"title": "2.1. Molecule Generation", "content": "Molecular Representations A molecule is commonly represented as a molecular graph, where nodes correspond to atoms, and edges represent covalent bonds (Huang et al., 2024). We formalize this below.\nDefinition 2.1 (3D Molecular Graph). A 3D molecular graph is defined as a triplet $G = (V, E, R)$, where:\n\u2022 V is the list of atoms in the molecule.\n\u2022 E is the set of chemical bonds, represented as an adjacency tensor.\n\u2022 $R\u2208 R^{|V|\u00d73}$ denotes the 3D conformation, specifying the spatial coordinates of each atom.\nGiven a molecular graph with N atoms, we adopt the following encoding scheme: V is one-hot encoded as $V\u2208 {0,1}^{N\u00d7A}$, where A is the number of atom types. E is stored as an adjacency tensor $E\u2208 {0,1}^{N\u00d7N\u00d7B}$, where B is the number of bond types.\nWe also introduce two key sub-representations:\n\u2022 The bonding topology, denoted as $T = (V, E)$, which captures the connectivity of atoms without considering spatial information.\n\u2022 The point cloud representation, given by $(V, R)$, which encodes atom types and 3D positions but omits bond information.\nThus, a 3D molecular graph can be equivalently expressed as $G = (T, R)$, combining both connectivity and geometry. We write $P_G = P_{T,R}$ to denote the distribution (dataset) of valid 3D molecular graphs which can be seen as the joint distribution over the bonding topology and 3D conforma- tion."}, {"title": "2.2. Problem Setup: Linker Generation", "content": "Suppose we are given two molecule fragments $G_1 = (T_1, R_1)$ and $G_2 = (T_2, R_2)$, where $G_1$ and $G_2$ are sub- graphs of a reference molecule $G_{ref} = (T_{ref}, R_{ref})$. The ref- erence molecule $G_{ref}$, which contains $N_{ref} = |V_{ref}|$ atoms, is chemically valid, and belongs to a molecular graph dataset."}, {"title": "2.3. PC-Free and PC-Aware Approaches", "content": "Existing works in linker generation are divided into two approaches, Point Cloud Free (PC-Free) and Point Cloud Aware (PC-Aware) approaches, based on awareness of frag- ments' conformation $R_{cond}$ on determining the bonding topology of output molecule $T$. To clarity, the ways they sample T are distinguished as following:\nPC-Free: $P_{T|T_{cond}} (T | T_{cond})$\nPC-Aware: $P_{T|T_{cond},R_{cond}} (T|T_{cond}, R_{cond})$\nIn the following, we explain each approach in detail with related models.\nPoint Cloud Free (PC-Free) Approach. PC-Free ap- proaches (Jin et al., 2023; Imrie et al., 2020) model the conditional distribution as in (3), sequentially sampling the bonding topology T conditioned on only the fragments' bonding topology $T_{cond}$ and then the 3D conformation R.\n$P_G(G | F) = P_{T(T | F) \u00b7 P_{R|T(R | T,F)}$\nPC-Free $P_{T(T | T_{cond}) \u00b7 P_{R|T(R | T,F)}$"}, {"title": "2.4. Trade-Off in Diversity and Validity", "content": "Due to different sampling strategy, PC-Free and PC-Aware models exhibit an inverse relationship between diversity and validity. Specifically, PC-Free models demonstrate high diversity but low validity, whereas PC-Aware models achieve high validity but low diversity.\nDiversity PC-Free models generate T without condition- ing on $R_{cond}$, leading to greater diversity compared to PC- Aware models, which incorporate $R_{cond}$ in sampling T. This follows from the general principle that conditioning reduces entropy,\n$H(T | T_{cond}, R_{cond}) \u2264 H(T | T_{cond}).$\nValidity PC-Free models face validity issues due to the inaccurate assumptions in (3). Since the 3D conformations of fragments, $R_1$ and $R_2$, are ignored when determining the bonding topology T', even a model that perfectly learns the target distribution $P_{2D}$ will still deviate from the true molecular distribution $P_G$. In contrast, PC-Aware models inherently overcome this limitation by explicitly training on the linker generation task in (5)."}, {"title": "2.5. Diffusion-based Molecule Generation", "content": "The molecular diffusion model (Hoogeboom et al., 2022; Igashov et al., 2024; Corso et al., 2023b) has emerged as a leading architecture for various molecule generation tasks, including PC-Aware linker generation (Igashov et al., 2024). It leverages the reverse diffusion process to iteratively de-noise a randomly sampled $x_\u315c ~ N(0, I)$ into a valid point cloud $x_o = (V, R)$ in T timesteps. Specifically, the process is formulated as\n$X_T ~ N(0,I)$\n$dxt = [f(xt,t) + g\u00b2(t)x_ , log pt(xt)] dt + g(t)dW_t$"}, {"title": "3. Method", "content": "Rather than directly sampling $G' ~ P_G$ in a single step, we propose a hybrid two-step approach that leverages both PC-Free and PC-Aware linker generation models."}, {"title": "3.1. Motivation for a Hybrid Approach", "content": "Experimental Comparison To validate this trade-off, we evaluate PC-Free and PC-Aware models on the ZINC dataset using standard metrics: Validity for validity, Uniqueness for diversity and V + U for diversity of valid molecules. The experimental setup follows Section 4.1. As shown in Table 2, PC-Free models excel in diversity, while PC-Aware models perform best in validity, confirming our hypothesis.\nAs observed in V + U score, the trade-off between diversity"}, {"title": "3.2. Hybrid Approach", "content": "We develop a straightforward and intuitive pipeline that inte- grates two pretrained models, leveraging a novel theoretical methodology to execute the process. To adopt two types of models, we rewrite our sampling as two-step pipeline given a fragment condition $F = T_{cond} R_{cond}$ as (8),\n$P_{G,G}(G,G | F) = P_G(G | F) \u00b7 P_{G|G}(G | G, F)$\nwhere we first sample surrogate molecule G to support sampling of G."}, {"title": "3.3. Posterior Sampling From $P_{G|2D}$", "content": "The challenge in sampling $P_{G|2D}$ lies in refining an invalid surrogate molecule into a valid one, which corresponds to the inverse problem (Gutha et al., 2024; Yang et al., 2024; Chung et al., 2024a) in the molecular domain. Since this area remains unexplored, we introduce LinkerDPS, the first DPS (Chung et al., 2024a) method designed for the molecu- lar domain. By adopting the reverse process of the diffusion- based PC-Aware model, LinkerDPS samples a refined point cloud $(V, R)$ favored by the pretrained prior distribution of valid point clouds.\n$P(V, R | G, F) = \\frac{p(V, R | F) \u00b7 p(G | V, R, F)}{p(GF)}$\nAs shown in (10), leveraging Bayes' rule, we decompose $p(V, R | G, F)$ into the prior distribution $p(V, R | F)$ and the likelihood $p(G | V, R, F)$, which respectively ensure the validity of $(V, R)$ and its affinity with G. Beyond the prior learned by the pretrained PC-Aware model, we design the likelihood of $G = (V, E, R)$ as follows. Note that we disregard the condition F by considering V and R as stricter constraints. Additionally, we assume mutual independence of V, E, R given V and R.\nLikelihood of Atom To ensure consistency between the surrogate and generated molecules, we enforce that the atoms of both molecules remain the same. Formally, the likelihood of V is defined as\n$P_{V|V}(V | V) := I(V = V)$\nwhere II denotes the indicator function.\nLikelihood of Bond and Conformation To account for the cross-domain nature of bond likelihood given a point cloud, we introduce a molecular energy-inspired function U, defined as\n$U(E^*, R^*) := \u03a3 \\frac{1}{|\\tilde{R}_i - \\tilde{R}_j |^{3}}$,\n1<i,j<|V|", "Latex": "\\begin{aligned}\n||\\tilde{R}_i - \\tilde{R}_j |^{3} \\neq 0\n\\end{aligned}"}, {"title": "LinkerDPS Formulation", "content": "Utilizing (11) and (14) to ex- press the likelihood in (10), sampling $p(V, R | G)$ reduces to sampling R while keeping V = V fixed, formulated as\n$p(R | G, V, F)  \u00d7 p(R | V, F) \u00b7 p(E, R | R).$\nAccordingly, LinkerDPS implements conditional sampling of the conformation R via the reverse diffusion process:\n$drt = [f(rt,t) + g\u00b2(t) Vrelog pt(rt | E, R, V)] dt + g(t)dWt$\nwhere rt follows the prior distribution induced by the for- ward process of PR. Applying Bayes' rule, we express:\n$Vrt log pt (rt E, R, V) = Vrt log pt (rt|V) + Vrt log pt (E, R|rt, V)$\nTo compute $Vrt log pt (rt|V)$, we employ an inpainting strategy (Lugmayr et al., 2022) and introduce a conditional score estimator s*, derived from the pretrained score esti- mator se of the PC-Aware model:\n$s_0*(rt, t, V, F) \u2248 \u2207rt log pt(rt|V).$"}, {"title": "4. Experiments", "content": "4.1. Experiment Setup\nWe evaluate linker generation algorithms on for 400 fragment-linker pairs from ZINC-250K (G\u00f3mez-Bombarelli et al., 2018), which are the test data in prior linker gener- ation work (Imrie et al., 2020). Further, we run 50 times sampling for each fragment and use 20,000 samples in total for our experiments. To evaluate generated samples' valid- ity, we use the metric Validity described in Section 2.1. To score the diversity of samples, we use the followings to capture diversity in multiple perspective: Uniqueness, Nov- elty, V+U, V+N, V+HD, V+FG, and V+BM. Uniqueness and Novelty accounts for all samples satisfying topological valence rule, but the others measures the diversity of valid molecules by counting only the valid samples. More details"}, {"title": "4.2. Result: Advanced Diversity of Valid Molecules", "content": "We run quantitative comparison of each linker generation algorithm in Table 3, demonstrating that HybridLinker suc- cessfully balance both high validity and diversity while all the baselines fail. The high scores in all diversity counting only valid moleucles (V+U, V+N, V+HD, V+FG, V+BM), indicate that its diversity is driven by meaningful substruc- tural variations. Notably, the high V+N score highlights Hy- bridLinker's ability to discover non-trivial linkers for given fragments. When using DeLinker as the surrogate generator, HybridLinker achieves the highest validity, while utilizing surrogates from FFLOM boosts diversity while maintaining competitive validity. Importantly, HybridLinker also main- tains high Uniqueness and Novelty scores, showing that its superior diversity of valid molecules stems from a balanced enhancement of both validity and diversity."}, {"title": "4.3. Application: Property Optimization", "content": "Property optimization, which aims to identify molecules with high scores in specific measurements, is a direct appli- cation benefitted by sample diversity. Here, we demonstrate that the high diversity of HybridLinker enhances property optimization results through the following two experiments: Druglikeness Optimization and Molecule Descriptor Opti- mization. We describe the latter experiment in Appendix E"}, {"title": "4.4. Discussion", "content": "HybridLinker as a Foundational Model As shown in Table 3, HybridLinker excels in linker generation by si- multaneously achieving high diversity and validity-two fundamental pillars of drug discovery. Beyond its strong performance in core metrics, it also demonstrates excep- tional results in application-driven tasks, as highlighted in Table 4. Moreover, as a zero-shot framework that seam- lessly integrates pretrained PC-Free and PC-Aware models, HybridLinker remains highly adaptable to future advance- ments in these models, further enhancing its capabilities. These strengths establish HybridLinker as a foundational framework for linker generation, offering both versatility and long-term scalability in molecular design.\nVersatility of LinkerDPS At the core of HybridLinker is LinkerDPS, the first DPS approach to enable cross- domain guidance from molecular topology to molecular point clouds. By decomposing molecule generation into two sequential tasks, LinkerDPS facilitates the seamless integration of specialized models for each domain. We an- ticipate that its capability will extend to a broader range of applications, particularly in tackling complex challenges at the intersection of topology and point cloud modeling by leveraging domain-specific expertise. Notably, large-scale molecule generation-one of the most pressing challenges in modern drug discovery due to its complexity-could become a new frontier for LinkerDPS, offering a scalable solution to this critical problem."}, {"title": "5. Conclusion", "content": "We introduce HybridLinker, a zero-shot framework that inte- grates pretrained PC-Free and PC-Aware models to balance diversity and validity without additional training. At its core, LinkerDPS enables cross-domain guidance from molecular topology to point clouds, decomposing molecular sampling into sequential subtasks. Our results validate effectiveness of LinkerDPS as well as HybridLinker, and we anticipate its application in scalable large-molecule generation by break- ing complex problems into manageable steps."}, {"title": "Impact Statement", "content": "This work aims to advance drug discovery by leveraging the remarkable computational power of modern artificial intelli- gence. While we acknowledge both the significant benefits and potential risks associated with our approach, such as accelerating drug development for emerging viral threats like COVID-19 or inadvertently facilitating the discovery of unintended compounds, we emphasize the importance of responsible application. We hope this technology will be uti- lized ethically to drive positive advancements in healthcare and pharmaceutical research."}, {"title": "Acknowledgement", "content": "This work was supported by Institute of Information & com- munications Technology Planning & Evaluation (IITP) grant funded by the Korea government (MSIT) [NO.RS2021- II211343, Artificial Intelligence Graduate School Program (Seoul National University), No.2022-0-00984, No.2019- 0-00075, Artificial Intelligence Graduate School Program (KAIST)]"}, {"title": "A. Extended Definition of Validity", "content": "In this work, we extend the previous definition of molecule validity, focusing on each topology representation, to reflect its point cloud representations, which is a crucial consideration to make the the validity indicates its stability in 3D space where they serve a drug. We accounts for not only the valence rule in molecular topology but also the coherence of molecular point cloud with the topology. Molecular potential energy U is adopted to score the pair of topology and point cloud. We determine the validity of given molecule based on its conformation energy, the gap of its energy the its optimal energy attained in its most stable conformation without external constraints as fragments condition. To clarify, higher conformation energy means the molecule is unstable, also can be interpreted by Boltzmann distribution. We choos the widely used cut-off 25(kcal / mol) (Sitzmann et al., 2012; Kirchmair et al., 2006; Peach et al., 2017) of practically allowable conformation energy as our threshold \u012bval, and label the molecule valid if its conformation energy is lower than the Tval. We use RDKit (Landrum, 2022) to compute U and molecule's optimal conformation."}, {"title": "B. Experimetal Details", "content": ""}, {"title": "B.1. Dataset Construction", "content": "Following DeLinker (Imrie et al., 2020), we select a subset of 250,000 molecules from the ZINC dataset. The energetically stable conformation of each molecule is determined using MMFF force field optimization (Halgren, 1996) implemented in RDKit (Landrum, 2022). As in prior work (Hussain & Rea, 2010), molecular fragmentation is performed by applying double bond cuts on acyclic single bonds that are not part of functional groups. Following the preprocessing steps in DeLinker (Imrie et al., 2020), we construct 418,797 fragment-linker pairs and further select 400 pairs as our test set, aligning with the test set used in DeLinker (Imrie et al., 2020). In this study, we exclusively use the test set to evaluate HybridLinker, as our method does not require additional training but instead operates in a zero-shot manner using pretrained models."}, {"title": "B.2. Implmentation of Baselines and HybridLinker", "content": "We compare HybridLinker with recent baselines for linker generation, falls into either PC-Free models or PC-Aware models. FFLOM (Jin et al., 2023) and DeLinker (Imrie et al., 2020) are included to represents PC-Free models. For the PC-Free models, we adopt the strong and easy-to-use conformation generation algorithm, ETKDG (Riniker & Landrum, 2015), to predict conformation of molecule topology they generate. For PC-Aware models, we include 3DLinker (Huang et al., 2022) and DiffLinker (Igashov et al., 2024) as baseline models.\nHybridLinker is implemented utilizing both pretrained PC-Free models and PC-Aware models, respectively. As far we know, DiffLinker is the only strong PC-Aware baseline, and we adopt it in HybridLinker's second stage. As for the PC-Free model in the first step, we utilze FFLOM and DeLinker, as the two are only strong PC-Free baselines. In the experiment, we refer the PC-Free model in HybridLinker's first stage as surrogate generator. Note that we do not conduct additional training of baselines. Further, we found that if surrogate molecule G from the first stage is already valid, skipping second stage to sample G but directly sample G = G is effective to achieve high performance. We follow this scheme in our experiments.\nFurther, we use ETKDGv3 (Riniker & Landrum, 2015) algorithm provided by RDkit (Landrum, 2022) as the off-the-shelf conformation predictor R, and Obabel (O'Boyle et al., 2011) as post-hoc bond predictor E."}, {"title": "B.3. Evaluation Metrics", "content": "In Section 4.2, we first evaluate the samples generated by each algorithm based on their validity and diversity. Notably, we extend the definition of Validity from prior works to account for both valence rules in bonding topology and energetic stability in the 3D graph. To evaluate sample diversity, we incorporate standard metrics such as Uniqueness and Novelty. However, unlike prior works that define Novelty as the fraction of novel molecules, we compute it as the fraction of molecules that are both unique and novel. Additionally, we introduce three more diversity metrics introduced in (Hu et al., 2024)-HamDiv, FG, BM\u2014to capture diversity from different perspectives, specifically, molecule fingerprint, number of unique functional group, and number of unique molecular scaffolds, respectively. We follow the implementation in the repository (https://github.com/HXYfighter/HamDiv) to caculate them. We also heavily focus on calculating each diversity score counting only the valid molecules (diversity metrics for valid molecules). In the main paper, we denote them as V+U (Uniqueness), V+N (Novelty), V+HD (HamDiv), V+FG (FG), and V+BM (BM). For instance, the calculation of V+U for a given fragment pair differs from that of Uniqueness as follows:\n$Uniqueness = \\frac{S}{N},$\nwhere  S = \\{T\\}~_{i=1}^N  represents the set of topologies for the  N  generated molecules corresponding to the fragment pair. The\nother diversity metrics for valid molecules are computed in a similar manner. All metrics above are first calculated for 50\nsamples for each fragments, and averaged over the test fragments.\nWe also evaluate the drug-likeness and chemical properties of the generated samples. In Section 4.3, we compare the\ndrug-likeness of samples from each algorithm. For drug-likeness scoring, we use QED(Bickerton et al., 2012), SA(Ertl &\nSchuffenhauer, 2009), and PLogP(You et al., 2018), which measure general drug quality, synthetic accessibility, and the"}, {"title": "C. Algorithmic Comparison on PC-Aware model, PC-Free model, and HybridLinker", "content": "Here, we illustrate the algorithmic distinction of HybridLinker compared to PC-Aware and PC-Free models. While PC- Aware and PC-Free models perform either PC-Aware or PC-Free inference, specializing in validity or diversity respectively, HybridLinker integrates both inference types in two-step pipeline, effectively leveraging the strengths of both approaches."}, {"title": "D. Details of LinkerDPS", "content": ""}, {"title": "D.1. Overview on Diffusion Posterior Sampling", "content": "Diffusion Posterior Sampling (DPS) (Chung et al., 2024a) is a novel method for addressing noisy inverse problems using diffusion models. Diffusion models, which are typically employed for generative tasks, works in reverse process of diffusion forward pass that progressively add noise to data.\nFormally, the diffusion forward process is governed by\n$xt = \u221aatxo + \u221a1 \u2212 \u0101t\u20ac, \u03b5 ~ N(0, I), t \u2208 [0, T]$\nwhere at is a variance scheduler that decrease from 1 at t = 1 to 0 at t = 0 and 20 is the clean ground truth image from the data distribution Pdata.\nTo recover the data generating distribution, we can use the reverse process defined as\n$dxt = [f(xt,t) + g\u00b2(t)\u2207x+ log p(xt)] dt + g(t)dwt, t\u2208 [0,T]$\nwhere the drift coefficient f is defined by $f(xt,t) = \\frac{B_tx_t}{2}$ and diffusion coefficient g is defined by $g(t) = \\sqrt{\u03b2t}$ for\n$Bt = \\frac{1- \\overline{a_t}}{2}, \\frac{\\mathrm{d}\\overline{a_t}}{\\mathrm{d}t}$. Further, w is a standard Wiener process flows backward from t = T to t = 0 and dt is an infinitesimal\nnegative timestep. Here, since the score x\u2081 log p(xt) is intractable, the neural score network $s_0^*$ where"}, {"title": "D.2. DPS Approximation", "content": "Exploiting Definition D.1, (Chung et al., 2024a) proposed Theorem D.3 about DPS approximation.\nDefinition D.1 (Jensen Gap (Gao et al., 2017)). Let x be a random variable with distribution p(x). For some function f that may or may not be convex, the Jensen gap is defined as\n$J(f,x ~ p(x)) = E[f(x)] \u2212 f(E[x])$,\\\nwhere the expectation is taken over p(x).\nDefinition D.2. The general form of the forward model of an inverse problem can be stated as\n$y = A(xo) + \u20ac $\nwhere y, \u0454 \u2208 R, xo \u2208 Rd and A(\u00b7) : Rd \u2192 Rn is the forward measurement operator and e is the measurement noise.\nTheorem D.3. For the measurement model defined in Definition D.2 with \u0454 ~ N(0, \u03c3\u00b2I), we have\n$p(y | xt) \u2248 p(y | xo)$\nwhere the approximation error can be quantified with the Jensen gap, which is upper bounded by\n$I < \\frac{d}{\\sqrt{2\\pi \\sigma^2}}\\ e^{-1/2\\sigma^2} ||\\nabla A(x)||_{m1}$,\nwhere $|\\nabla A(x)| := \\max_{x} |\\nabla A(x)|$ and $m_1 := \u222b ||xo - xo||p(xo|xt) dxo$"}, {"title": "D.3. Adaptation of DPS Approximation", "content": "Inspired by Theorem D.3, we propose Theorem D.4 about LinkerDPS approximation exploting (D.5) and (D.6). Theorem D.4 provides the reasoning for line 12 in Algorithm 4, where we approximate Vr\u2081p(\u1ebc, \u0158 | rt, V) ~ \u2207r\u2081p(\u1ebc, \u0158 | \u00ee). This approximation is what allows all terms in the algorithm to be analytically tractable, as the measurement distribution is given.\nTheorem D.4. (LinkerDPS Approximation) For the given cross domain measurement model,\n$p(E, R | r) =  \\frac{1}{Z} e^{-[\\phi_1(r;R)/2\\sigma_1^2]+\\phi_2(r; E)/\\sigma_2^2]}$\nwhere 01, 02 \u2208 R and $\u03c6_1, \u03c6_2$ are defined as\n$\u03c6_1(r; R) := ||R \u2212 r||2$,\n$\u03c6_2(r; E) := \u03a3 \\Lambda_{\\varepsilon_{ij} \\neq 0} || \\tilde{r}_i -  \\tilde{r}_j || ,$\n1<i,j<|V|\nwe have\n$p_t(E, R|rt, V) = p(E, R|\\hat{r}),$  \nwhere ro is the expectation of ro given V and the approximation error for (36) can be quantified with the Jensen gap, which\nis upper bounded by"}, {"title": "D.4. Computation of Guidance Term in LinkerDPS", "content": "We show that the \u2207r, log p(\u1ebc, \u0158 | \u00ee) in (21) is tractable as follows.\nWe first apply chain rule and have\n$Vr\u2081 log p(\u1ebc, \u0158 | \u0155) = \u2207r\u2081r \u2022 \u2207 log p(\u1ebc, \u0158 | \u0155)$\nLeveraging r = a (rt + (1-t). So (rt, t | V)), the former term Vr\u2081r can be computed using autograd.\nThe latter \u2207 log p(\u1ebc, \u0158 | \u00ee) is expressed as\n$\u2207 log p(y|r) = -\u2207\u03c6_1(r ; R) \u2212 \u2207\u03c6_2(r ; E),$\nwhere\n$\u03c6_1(r ; R) := ||R \u2212 r||2$,\n$\u03c6_2(r ; E) := \u03a3 \\Lambda_{\\varepsilon_{ij} \\neq 0} || \\tilde{r}_i -  \\tilde{r}_j || ,$\n1<i,j<|V|\n$\u2207_{\u03c61}  and \u2207_{\u03c62}$ are computed in straightforward as\n$\u2207_{r} \u03c6_1(r ; R) = \u22122(Ri \u2212 ri)$\n$\u2207_{r} \u03c6_2(r ; E) = -2\\sum \\Lambda_{\\varepsilon_{ij} \\neq 0} \\frac{(\\tilde{r}_i -  \\tilde{r}_j)}{|| \\tilde{r}_i -  \\tilde{r}_j ||},$\n<i,j<|V|\nwhich makes (49) tractable."}, {"title": "D.5. Conditional Score Estimator", "content": "Leveraging pretrained score estimator se* :\n$So* (vt, rt, t, F) = \u2207vt,rt log pt (Ut, rt),$\nwe introduce the conditional score estimator s*:\n$so* (rt, t, vo, F) = \u2207rt log pt (rt|vo).$\nWe define its operation as\n$so* (rt, t, vo, F) = m\" \u00a9 So* (vt, rt, t, F), where vt ~ N(\u221a1 - \u03b2\u03b9\u03c5\u03bf, \u03b2\u03b5\u0399)$\nwhere m\" is the masking operation that eliminates dimensions for v and remains those for r.\nTo validate its estimation, we utilize the following decoupling approximation (Lugmayr et al., 2022; Zheng et al., 2025):\n$p(vt, rt | vo) \u2248 p(rt | vt) \u00b7 p(vt | vo)$\nIt assumes vt following forward process p(vt | vo) has sufficient information on vo, to clarify, p(rt | Ut, vo) \u2248 p(rt | vt).\nLeveraging independence of vt and rt given vo as"}, {"title": "D.6. Algorithm for LinkerDPS", "content": "We describe alorithm of LinkerDPS in Algorithm 4, which is to adopt ancestral sampling (Ho et al., 2020a) with our reverse process discussed in Section 3.3. Similarly to prior work (Chung et al., 2024a), we choose step size {\\varepsilon_t}_{t=1}^T to be $ \\varepsilon_t = |\\nabla(U(\\tilde{R}|f) + U(\\tilde{E}|f))|| with g\u2032 = 0.01$"}, {"title": "E. Property Optimization: Descriptor Optimization", "content": "In this experiment, we identify the molecule whose descriptor value is closest to a randomly sampled target value to assess the effectiveness of each generation algorithm. The target value is drawn from an approximated Gaussian distribution of the descriptors of reference molecules in the test dataset. We then select the molecule that minimizes the descriptor distance to the target value. This minimum distance serves as the evaluation metric, where a smaller value indicates that the algorithm better captures a diverse range of molecular properties. We consider five molecular descriptors: Ipc, MolLogP, MolWt, TPSA, and LabuteASA. Table 5 presents the average score of each algorithm across the fragments in the ZINC test dataset. The results highlight the strength of HybridLinkers, as they achieve the best or second-best scores across most descriptors."}, {"title": "F. Ablation Study", "content": "The refinement process using LinkerDPS plays a central role in HybridLinker. To assess the contribution of each component in p(\u011e | V, R)\u2014namely, the likelihood of atoms, bonds, and conformation, each providing three types of guidance\u2014we conduct an ablation study in Table 4. Variants of LinkerDPS (A-DPS) are tested by selectively removing specific likelihood components. Additionally, we introduce a version where the likelihood of atoms is modeled as a continuous distribution using a Gaussian kernel:\n$p(\\tilde{\u03c5} | \u03c5) \u03b1 \u03ba(\\tilde{\u03c5}, \u03c5),$\nwhich allows for a continuous representation of atomic properties. To implement this, we employ the following reverse process:\n$dxt = [f(xt,t) + g\u00b2(t)\u2207x log pt(xt | V, \u00c9, \u0154)] dt + g(t)dWt,$\nwhere xt follows the prior distribution induced by the forward process of p(v, R | F). The LinkerDPS approximation for pt(V, E, \u0158 | xt) is straightforward to adapt, and we apply this approximation to compute the score in (60).\nTable 6 reveals that even variants using a single type of guidance outperform baseline methods. Performance improves further when combining two types, with the best results achieved when all three guidance components are incorporated. The marginal gains from additional guidance suggest that each component provides complementary yet overlapping information about molecular topology. Notably, relaxing the condition on atoms reduces molecular diversity, while the strict constraint on atoms ensures the preservation of surrogate atoms, reinforcing its role in maintaining molecular consistency. While validity slightly improves in the absence of inpainting, this is likely due to the repeated generation of certain valid molecules, as reflected in the decline of diversity metrics that count only valid molecules (V+U and V+N)."}, {"title": "G. Additional Discussion on Experimental Results", "content": "Impact of Balancing Diversity and Validity in Drug Discovery Balancing diversity and validity is a fundamental"}]}