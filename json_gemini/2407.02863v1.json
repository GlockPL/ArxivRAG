{"title": "Fast maneuver recovery from aerial observation: trajectory clustering and outliers rejection", "authors": ["Nelson de Moura", "Augustin Gervreau-Mercier", "Fernando Garrido", "Fawzi Nashashibi"], "abstract": "Abstract-The implementation of road user models that realistically reproduce a credible behavior in a multi-agent simulation is still an open problem. A data-driven approach is proposed here to infer behaviors that may exist in real situation to obtain different types of trajectories from a large set of observations. The data, and its classification, could then be used to train models capable to extrapolate such behavior. Cars and two different types of Vulnerable Road Users (VRU) will be considered by the trajectory clustering methods proposed: pedestrians and cyclists. The results reported here evaluate methods to extract well-defined trajectory classes from raw data without the use of map information while also separating \"eccentric\" or incomplete trajectories from the ones that are complete and representative in any scenario. Two environments will serve as test for the methods develop, three different intersections and one roundabout. The resulting clusters of trajectories can then be used for prediction or learning tasks or discarded if it is composed by outliers.", "sections": [{"title": "INTRODUCTION", "content": "Simulation is a indispensable tool to prove the efficacy and viability of any framework or system capable to drive an Automated Vehicle (AV) before integration with a prototype. In most cases these simulations reproduce the behaviors of other road users based on real recordings, which in this case the behavior of all road users is fixed ahead of time, or it relies on hybrid approaches, mixing real information with some a priori hypothesis, modeling and/or knowledge about the agents being represented. The main goal of this work is to produce classifications of trajectories to feed these hybrid methods with reliable and diverse set of trajectories, for different situations and different road users while being fast to execute and reliable enough to sift through outliers at input.\nTrajectory clustering has been a long research topic in the AV area. Many articles deal specially with the analysis of vehicle trajectory as a way to retrieve the possible trajectories in an environment, to study the traffic flow intersections [1], to discover possible longitudinal behaviors of vehicles [2], to execute some learning task [3] or even to examine the scenarios that might happen during driving [4]. Thus, the goal of this paper is to propose a fast and robust way to recover sets of trajectories for vehicles and vulnerable road users (VRU), delivering sets of trajectory samples as input to all the aforementioned tasks in a simple manner.\nApproaches based on clustering with dynamic time warp-ing (DTW) are the norm in the literature. In [4] three different threshold comparisons were made using the DTW distance metric to establish a similarity relationship between scenarios involving multiple road users. K-means and fuzzy c-means were used for [1], [5] with longest common sub-sequence (LCSS) to cluster trajectories in intersections so to derive insights about the traffic flow in multiple lane cross-intersections. Changing from the urban to aerial traffic, [6] proposed a method to combine k-means with outlier removal based on information theory by the minimization of the holoentropy and achieving good results clustering flight trajectories. With a different motivation, [2] implemented a fast k-means clustering method only for vehicles and bypassing the outliers problem. And on a totally different scale [3] applied the same idea of trajectory clustering but on a city scale, learning an embedding to simplify the trajectory representation and then clustering the projected data to find vehicles with similar behavior.\nThe contribution of this paper is two-fold: First, to propose a fast clustering method for maneuver retrieval from real observations that do not need any map information and that is compatible with vehicles and VRUs. Second, to adapt this model to deal with trajectories that can be considered as outliers, separating these \"eccentric\"\u00b9 and/or erroneous in-stances without disturbing the clustering process. A preview of the results obtained can be seen in Figure 1. Given the"}, {"title": "SEPARATING TRAJECTORIES OF INTEREST", "content": "Differently from the vehicle trajectories studied in [2], VRU trajectories are less constraint by its environment and are also more prone to acquisition error as well (shadows, changes in direction, multiple users close by). Also, when a scenario for observation is defined some of the less intuitive trajectories become superfluous, considering the interest of keeping only those which represent behaviors that can be transposed in other scenarios. Take, for example, the tra-jectories displayed in Figure 2 (white cross represents the beginning of the trajectory and black cross the end): these three different sets may represent a real-life situation, like getting out of a store and entering in a car but they are not of interest since they are scenario-specific. These types of trajectories will be qualified as eccentric from now on."}, {"title": "Dynamic time warp (DTW)", "content": "DTW was first introduced in the speech processing domain as a way to compare two time series that have different phases. Even though the trajectories studied here were sam-pled at the same frequency, they may have different lengths and although corresponding to the same maneuver in an intersection. Consider two discrete time series, represented by (2) and (3), with different sizes n and m, where K = {ko, k1,..., kn,..., km, . . .} represents the sampled periods:\n$R[K] = r[ko], r[k1],...,r[kn]$\n$S[K] = s[ko], s[k1],..., s[km]$\nThe goal of the DTW is to calculate the optimal sequence of pairs of point indexes, one from each time series. This is done by minimizing the euclidean distance between the points indicated by the index pair, from (r[ko], s[ko]) to (r[kn], s[km]), using a certain set of increments to walk from the former to the latter. In the standard implementation (equation 5) three steps are tested: +1 on the index 1, +1 on the index 2 or +1 in both. Equation (4) defines the DTW from R and S as the calculated sum of distances, which are determined by the recursion in Equation (5), for 0 \u2264 i \u2264 kn and 0 \u2264 j \u2264 km.\n$DTW(R, S) = \\gamma(k_n, k_m)$\n$\\gamma(i, j) = d(r[k_i], s[k_j])+ \\min [\\gamma(i \u2013 1, j), \\gamma(i, j \u2212 1), \\gamma(\u0456 \u2212 1, j \u2212 1)] $"}, {"title": "Clustering methods", "content": "Three main methods were used to cluster the trajectories using the DTW distance: hierarchical clustering, partition around medoids (or k-medoids) and dissimilarity matrix clustering.\n1) Hierarchical clustering: The hierarchical clustering used was based on a agglomerative processes, i.e., it starts with each sample being a cluster and at each step it merges the two most similar clusters, to then continue this process until the desired number of clusters is achieved [15]. The metric used to measure the similarity of two clusters, thus to decide with clusters should be merged at a given iteration, was the average linkage, Equation (7):\n$d_{c_i,c_j} = \\frac{1}{N\\cdot M} \\sum_{X_i \\in C_i} \\sum_{X_j \\in C_j} d(x_i,x_j)$,\nWhere Ci and Cj are two clusters being evaluated and N and M are the number of elements inside each respective cluster. The distance measure used is the DTW (from (1)).\n2) Partition around medoids (or k-medoids): It uses the same sequence of calculation - allocation of elements in clus-ter then center recalculation - from the k-means algorithm but using the medoid element as the cluster center (equation 6), not a synthetic average of elements [16]. Such adaptation is common in cases where it is difficult to calculate the average of elements being clustered, as for example when these do not have the same length.\n3) Dissimilarity matrix clustering: The algorithm was proposed to accelerate the clustering of vehicle's trajecto-ries in [2], in comparison with the k-means algorithm. To simplify the k-means calculation, it is applied at each row of the dissimilarity matrix for the entire dataset to look for the smallest cluster center of all rows (which will be the one that has the smallest sum of distances to the element represented by the row). Then, all the elements assigned to this minimal cluster are removed from the matrix and the process is executed again, until the desired number of clusters is achieved. If there are any left, then they are assigned to the cluster in which it has the smallest distance to its medoid."}, {"title": "METHODS EVALUATED", "content": "Independently from the clustering method used from the proposed in the previous section, some errors in classification might still appear, even if a higher number of clusters is used. To cluster using the DTW distance considers only the shape of the trajectory, which might mix trajectories that have small but important differences at its origin or terminus but that share an important part of its path. Hence, to correct this errors the initial and final points shall be used in a separate clustering procedure split the elements based on these points. Then, it will be necessary to check if any of the just-obtained sub-clusters should be fused back together, if they really are on the same maneuver, or even if they should be merged with other sub-clusters, to determine the final result. Algorithm 1 shows how the entire clustering process with this post-processing operation works. The interval [nkmin, nkmax] refers to the minimal and maximal number of clusters to be evaluated."}, {"title": "Reorganization using initial and final points", "content": "Two different approaches were taken to evaluate the best solution to further divide the clusters according to their initial and final points:\n\u2022 Cluster both initial and final points on the same array, establishing automatically the sub-cluster groupings\n\u2022 Cluster the initial point, then the final point and list the grouping created comparing both results.\nGiven that a search based on a number of clusters is already being executed, the mean-shift algorithm was used to execute these two options of post-processing, avoiding a nested search. After the merge process will happen, to fuse clusters with fairly similar characteristics, only differing from a few meters from each other while retaining its significant part, for example a left turn, a street crossing, etc.\nEvaluating if two sub-clusters should be merged is done using the medoid of each cluster, together with the spread of elements in each sub-cluster, Equation (8). The variable mi represents the medoid of the cluster Ci and N\u2081 its number of trajectories. To merge one sub-cluster with another it is necessary that the distance between both medoids be smaller than the sum of spreads for the respective clusters (line 5 of algorithm 2). To discard small differences, the medoid of one cluster is projected into the other (line 3 of algorithm 2), so that the similarity disregard any errors in tracking or even small differences in the start or terminus of the trajectory. If this condition is true, there is another to be fulfilled: the calculated projection should be equal or higher than a certain percentage of the original trajectory (which is defined in Table II for all cases examined here).\n$spr_{C_i} = \\frac{1}{N_i} \\sum_{X_i \\in C_i} d_{DTW} (m_i, x_i)$"}, {"title": "Evaluating cluster partition quality", "content": "Finally, it is necessary to evaluate the clusters according to the similarity of elements inside each cluster and in other clusters as well. Three metrics will be used for it: the Davies-Bouldin index the Silhouette score and the spread on cluster, proposed here. The DB index will be slightly modified to allow a better representation of the distribution quality for a certain number of clusters, while the latter will be used as it was defined in [17].\n1) Davies-Bouldin index (DB): The Davies-Bouldin index (DB) is originally defined as the average of the maximal value of Rij, as if defined in Equations (11) and (12). Equation (8) is used to calculate the spread si. Since it is the maximal value of Rij that is used to calculate the final score, it has creates a dependency to the number of clusters, i.e. the decrease on the score is connected to a higher number of cluster and not necessarily a better distribution.\n$R_{ij} = \\frac{(s_i + s_j)}{d_{ij}}$\n$DB_{nc} = \\frac{1}{N_c} \\sum_{i=0}^{n_c}  \\underset{[j=1,...,n_c, i\\neq j]}{max} R_{ij}$\nThus, a small modification was done, to use the average of Rij, not its maximal value, as it can be seen in Equation (13). This offers less bias to the number of clusters, considering always all the distribution of elements being evaluated. The 1 discounts the distance of the medoid to itself, which is zero.\n$DB_{nc} = \\frac{1}{n_c n_c-1} \\sum_{i=0}^{n_c} \\sum_{j=0}^{n_c} R_{ij}$\n2) Silhouette score (Slh.): Another metric to evaluate the clustering quality is the silhouette score, proposed in [17]. Differently from the DB score, it is calculated for each element being clustered, with a(i) begin the average dissim-ilarity (DTW distance in this case) of element i to all other elements in its cluster. The other value necessary to calculate the silhouette is the minimum average dissimilarity between the element in question to the other clusters, Equation (15).\n$s_{c_i} (i) = \\frac{b(i) \u2013 a(i)}{max (a(i), b(i))}$\n$b(i) = \\underset{C_j \\neq C_i}{min} d_{DTW} (b(i), C_j)$"}, {"title": "Methodology", "content": "Two different sources of data will be used to test the algorithms proposed here: the inD dataset [7] and the roundD dataset [8]. Both are obtained using a unnamed aerial vehicle (UAV), the former containing four different intersections and the latter three roundabouts, all in Germany. The information about the number of trajectories per scenario and per road user can be found in table I; the number of files refers to the data-batch file division for each scenario: in the inD case only the first three intersections were used for the VRU (for the vehicle case all intersection were tested) and for the roundD there are two files with two different roundabouts that are not used (only a few observations); the other scenarios are obtained from the observation of a third one (files 02 to 23).\nThis data was split into three scenarios, given the number of trajectories (the clustering results of the three scenarios could be merged using the algorithm proposed in [2]). For the clustering execution all three road user trajectories from inD were used (in blue at Table I), while for the rounD only the vehicles' trajectories could be used, due to the low number of observations for pedestrians and cyclists (in red at Table I)."}, {"title": "Pedestrians", "content": "There are three intersection scenarios for pedestrians, all in the inD dataset. The most important problem with pedestrians is the high variability of maneuvers, because it have an almost constraint-free environment to evolve and also due to detection and tracking errors during the dataset acquisition and post-processing. It is a real challenge for the clustering process to treat all these problems and produce a compact cluster set. The results for scenarios 0 and 2 can be seen in table III and table IV.\nThe abbreviation Agglo refers to the pure agglomerative clustering, A2MS to the agglomerative followed by two mean-shits, on the initial and final points separately and A1MS to one mean-shift on the initial and final points on the same array. For all tables, III through XI, the time indicated is the average clustering time per cluster calculated. In the column best nk the first value is the nominal value of the number of clusters used, and in parenthesis it is the final number of clusters, and in the last column the percentage of the original trajectories present in the final classification (in parenthesis the number of rejected trajectories).\nBoth scenarios are two extremes for the clustering pro-cess: one has few trajectories and not many options for a pedestrian to evolve in the environment and the other has much more of both. It is exactly of possible destinations and the possibility to use the same space in both directions that make the silhouette measure to fail when choosing the best method. Since the number of optimal clusters for each method is different, the spread on cluster, defined in III-B.3 is the best choice of criteria to select the best method overall and in the current case it indicates that the agglomerative clustering with two mean-shift applications (A2MS) is the best option for the scenario 0 and 2 (for the 1 as well, for space limitations it will not be shown here)."}, {"title": "Cyclists", "content": "The cyclist data was acquired at the same intersections than the pedestrians. From the set of trajectories given by the dataset the approximate cyclist behavior can be considered as somewhat between cars and pedestrians, with a constrained movement, but still able to access multiple parts of the road environment. For scenario 1 results (Table V) the main distinction that can be made from the pure agglo. and its modification is the opposite of what was observed with pedestrians."}, {"title": "Vehicles", "content": "For vehicles the volume of data increases, with the addi-tion of inD dataset scenario 3 and the entire rounD dataset. Since the movements for vehicles are very constrained there are almost none eccentric behavior, hence the goal here is to eliminate all the erroneous samples; for example, trajectories that end at the middle of the intersection. In some cases this was possible, notably on scenarios 1 and 2 for the inD dataset, however, in scenario 0 one maneuver got separated as the result of the mean-shift and merge mechanism for the A2MS method (Figure 6). Beyond that all other maneuvers for 0 were correctly determined."}, {"title": "CONCLUSION", "content": "A new method to cluster trajectories, A2MS, together with a metric defined for the trajectory clustering case, the spread on cluster, were proposed and tested with the datasets inD and rounD. Using an hierarchical clustering combined with DTW distance measure and a as cluster distribution measure, A2MS proved to be the most efficient in the tested methods to produce tight and concentrated clusters with minimal number of outliers.\nThe immediate next step is to use this clustering method in conjunction with the longitudinal approach proposed by [2] to extract drivers' behaviors from real data. But more broadly the method proposed here has multiple uses, from prepare data to learning tasks for planning, decision-making or prediction to even the study of traffic flow in a predeter-mined zone. Ultimately, this method allows in the future to collect data to train a representation of trajectories so that comparisons could be made with trajectories from different road configurations."}]}