{"title": "Predictive Monitoring of Black-Box Dynamical Systems", "authors": ["Thomas A. Henzinger", "Fabian Kresse", "Kaushik Mallik", "Emily Yu", "\u0110or\u0111e \u017dikeli\u0107"], "abstract": "We study the problem of predictive runtime monitoring of black-box dynamical systems with quantitative safety properties. The black-box setting stipulates that the exact semantics of the dynamical system and the controller are unknown, and that we are only able to observe the state of the controlled (aka, closed-loop) system at finitely many time points. We present a novel framework for predicting future states of the system based on the states observed in the past. The numbers of past states and of predicted future states are parameters provided by the user. Our method is based on a combination of Taylor's expansion and the backward difference operator for numerical differentiation. We also derive an upper bound on the prediction error under the assumption that the system dynamics and the controller are smooth. The predicted states are then used to predict safety violations ahead in time. Our experiments demonstrate practical applicability of our method for complex black-box systems, showing that it is computationally lightweight and yet significantly more accurate than the state-of-the-art predictive safety monitoring techniques.", "sections": [{"title": "1. Introduction", "content": "A majority of autonomous systems nowadays depend on advanced artificial intelligence (AI) technologies. For instance, in self-driving cars, perception modules are almost synonymous to machine-learned computer vision software (Janai et al., 2020) and controllers are routinely designed using deep reinforcement learning algorithms (Lillicrap et al., 2016). Although revolutionary, these AI technologies are hard to analyze and pose serious risk with respect to the safe and correct behavior of the underlying systems (Amodei et al., 2016).\nTowards the safe and trustworthy deployment of AI-powered systems, we study the problem of predictive runtime monitoring of continuous-time dynamical systems possibly operated by a learned controller. We consider the black-box setting, in which the exact semantics of the system dynamics and the controller are unknown. Rather, one is only able to observe the state of the system at finitely many sampling instances. Our goal is to design a runtime monitoring algorithm which, at each sampling point, takes the past states into account, and predicts the future states and resulting future safety status of the system within a given time horizon. Unlike traditional runtime monitoring concerning fulfillment of safety only in the past (Bartocci and Falcone, 2018), our predictive monitors raise safety warnings before they actually take place, so that the system can be intervened and steered out of danger in time, e.g., by using a fail-safe backup controller as in shielding (Alshiekh et al., 2018)."}, {"title": "2. Preliminaries and Problem Statement", "content": "Controlled dynamical systems. A controlled dynamical system, or system in short, is defined via\n$\\frac{dx(t)}{dt} = f(x(t), u(t)), x(0) = x_0, \\forall t \\geq 0 . u(t) = \\pi(x(t)),$ (1)\nwhere $t \\in \\mathbb{R}_{\\geq0}$ denotes time, $x(t) \\in X \\subseteq \\mathbb{R}^n$ and $u(t) \\in U \\subseteq \\mathbb{R}^m$ denote the state and the control input at time $t$, $x_0 \\in X$ is the initial state, $f : X \\times U \\rightarrow X$ is the (nonlinear) dynamics, and $\\pi : X \\rightarrow U$ is the controller which assigns a control input to each state. In what follows, we assume that the dynamics $f$ and the controller $\\pi$ are locally Lipschitz continuous, and the Picard-Lindel\u00f6f theorem guarantees the existence and uniqueness of the solution of (1); the solution will be denoted as $\\xi: \\mathbb{R}_{>0} \\rightarrow \\mathbb{R}^n$ and called the trajectory of the system. Local Lipschitz continuity of dynamics is a standard assumption in control theory (Dawson et al., 2023), and is also satisfied by neural network controllers with all common activations, including ReLU, sigmoid, and tanh (Szegedy et al., 2014).\nSafety properties. We consider quantitative safety properties which are functions of the form $f: X \\rightarrow \\mathbb{R}$, assigning a real valued safety level to each system state. We say that the controlled"}, {"title": "Problem statement.", "content": "Suppose we are given a black-box controlled dynamical system and a quantitative safety property $f$; both the dynamics and the controller of the system are unknown but we can observe the resulting trajectory $\\xi$. Let $\\tau\\in \\mathbb{R}_{\\geq0}$ be a given sampling time and $h \\in \\mathbb{N}$ be a given prediction horizon. A predictive runtime monitor, or a monitor in short, observes the trajectory of the system at the sampling instances, and after each new observation, predicts the safety levels in the next $h$ sampling instances. Formally, at each time $t \\in \\{1, 2, 3, . . .\\}$, the monitor takes the input sequence ..., $\\xi(t - 2\\tau)$, $\\xi(t - \\tau)$, $\\xi(t)$ in account and outputs either the sequence $f(\\xi(t + \\tau)), ..., f(\\xi(t + h\\tau))$ or a statistic thereof (e.g., the minimum $f$ or the first instance when $f$ becomes negative). We consider the problem of designing a monitor for the given safety property.\nTaylor's expansion. Before presenting our monitor, we recall Taylor's polynomial of a $(l + 1)$-times continuously differentiable function $g : \\mathbb{R} \\rightarrow \\mathbb{R}$. For each $1 < i < l$, denote by $g^{(i)}$ the i-th derivative of $g$. For a fixed point $t \\in \\mathbb{R}$, the Taylor's polynomial of $g$ of degree $l$ at point $t$ is\n$P_l(s) = g(t) + \\frac{g^{(1)}(t)}{1!} (s - t) +  \\frac{g^{(2)}(t)}{2!} (s - t)^2 + ... +  \\frac{g^{(l)}(t)}{l!} (s - t)^l.$\n(2)\nThe following theorem is a classical result from mathematical analysis which provides an upper bound on the approximation error of a function via its Taylor's polynomial at a given point.\nTheorem 1 (Taylor's theorem (Rudin, 1964)) Suppose that $g : \\mathbb{R} \\rightarrow \\mathbb{R}$ is an $(l + 1)$-times continuously differentiable function. Let $t \\in \\mathbb{R}$ and let $P_l$ be the Taylor's polynomial of $g$ of degree $l$ at point $t$. Then, for every $s \\in \\mathbb{R}$, there exists a point $r \\in (t, s)$ such that\n$g(s) \u2013 P_l(s) = \\frac{g^{(l+1)}(r)}{(l + 1)!} (s \u2013 t)^{l+1}.$\nHence, if $B \\geq \\sup_{r \\in (t,s)} |g^{(l+1)} (r)|$, then we have $|g(s) \u2013 P_l(s)| \\leq \\frac{B}{(l + 1)!} (s \u2013 t)^{l+1}."}, {"title": "3. Algorithms", "content": "The heart of our monitor is a numerical algorithm (Sec. 3.1) for predicting the future states of a given black-box system from the states observed so far along the trajectory. These predicted future states will then be used to obtain the desired predictive runtime monitor (Sec. 3.2)."}, {"title": "3.1. A Numerical Algorithm for Predicting Future States", "content": "Our (state) prediction algorithm has two phases: (1) In the learning phase, for each dimension $i \\in [1; n]$ of the system's state space, we use a polynomial with time as its variable to approximate the dimension $i$ of the trajectory $\\xi$. The polynomial approximation function is obtained via a numerical procedure that uses a finite set of past states $\\xi(t - k\\tau), . . ., \\xi(t - 2\\tau), \\xi(t - \\tau), \\xi(t)$ with an appropriately large $k$, which we will refer to as the $\\tau$-stencil of length $(k + 1)$ ending at $t$. We write $x_k = \\xi(t \u2212 k\\tau),...,x_{\u22121} = \\xi(t \u2212 \\tau), x_0 = \\xi(t)$, omitting $t$ whenever it is clear from the context. (2) In the prediction phase, the obtained polynomial approximation functions are used to compute the predictions of the future states up to the horizon $h$, denoted as $x_1 = \\xi(t+\\tau),...,x_h = \\xi(t+h\\tau)$.\nLearning phase. The learning phase independently considers each dimension $i \\in [1; n]$ of the system's state space and computes a polynomial approximation for the $i$-th dimension of the trajectory function $\\xi$. Hence, in what follows, without loss of generality we assume that $n = 1$ and present our procedure for computing a polynomial approximation to the real-valued signal $\\xi$.\nWe use the Taylor's polynomial $P_l$ of $\\xi$ of a given degree $l$ as the polynomial approximation. The challenge in obtaining $P_l$ is that its coefficients depend on the values of the derivatives $\\xi^{(1)}, ..., \\xi^{(l)}$ at time point $t$, which are unknown to us owing to the black-box nature of the system.\nTherefore, we numerically approximate the values of the derivatives using the backward difference (BD) method (Gear, 1967) from the observed stencil $x_{\u2212k},...,x_0$ ending at time $t$. In particular, the BD approximation of the $i$-th derivative at $x_0$ is obtained as:\n$\\nabla^i_{x_0} := \\begin{cases} (x_0 - x_{-1}) / \\tau & \\text{if } i = 1, \\\\ (\\nabla^{i-1}_{x_0} - \\nabla^{i-1}_{x_{-1}}) / \\tau & \\text{otherwise.} \\end{cases}$\nThe following closed-form expression can be obtained from the inductive definition above:\n$\\nabla^i_{x_0} = \\frac{1}{\\tau^i} \\sum_{j=0}^i (-1)^j \\binom{i}{j} x_{-j}$\n(3)\nIt can be easily verified that $\\nabla^i_{x_0}$ depends on states up to $x_{-i}$ in the past, and therefore the length of the stencil must be $k + 1 > l$. The approximation error is formally derived in the following lemma.\nLemma 2 Let $i > 0$ and suppose that $\\xi : \\mathbb{R} \\rightarrow \\mathbb{R}$ is an $(i + 1)$-times continuously differentiable function. Then, for every given stencil of length $k + 1 > i$, the following holds:\n$|\\xi^{(i)}(t) - \\nabla^i_{x_0}| \\leq \\tau \\frac{\\xi^{(i+1)}(t)}{(i + 1)!}  \\sum_{j=0}^i \\binom{i}{j} j^{i+1} + O(\\tau^2)$. (4)\nThe approximation $\\nabla^i_{x_0}$ is called the first order approximation, because for small $\\tau < 1$, asymptotically, the first order term in $\\tau$ dominates the error (i.e., the error is $O(\\tau)$). Higher order BD approximations would lead to smaller errors and will be considered in future works.\nProof [Proof of Lem. 2] In (3), if we use the following infinite Taylor's series expansion of $x_{\u2212j}$\n$x_{-j} = \\xi(t \u2013 j\\tau) = \\xi(t) + \\frac{(j\\tau)}{1!} \\xi^{(1)}(t) + \\frac{(j\\tau)^2}{2!} \\xi^{(2)}(t) + \\frac{(j\\tau)^3}{3!} \\xi^{(3)}(t) + ...,$\nwe observe that terms with derivatives of $\\xi$ of order lower than $i$ cancel out, and we obtain:\n$\\nabla^i_{x_0} \\frac{1}{\\tau^i} \\sum_{p=i+1}^\\infty \\frac{\\xi^{(p)}(t)}{p!} \\sum_{j=0}^i (-1)^j \\binom{i}{j} (j\\tau)^p.$\nThe claim is established by separating the dominating term with $p = i + 1$ (which results in the first order term in $\\tau$) in the sum on the right hand side from the higher order terms.\nWe use $\\tilde{P_l}(\\cdot)$ to denote the approximated Taylor's polynomial obtained by replacing each $\\xi^{(i)}(t)$ in (2) with its BD approximation $\\nabla^i_{x_0}$."}, {"title": "Prediction phase.", "content": "The prediction phase of our monitor uses the approximated Taylor's polynomial $\\tilde{P_l}$ of the trajectory $\\xi$ around the current time $t$ in order to compute the predicted future states, denoted as $x_1 = \\tilde{P_l}(t+\\tau),...,x_h = \\tilde{P_l}(t+h\\tau)$. The following theorem establishes an error bound.\nTheorem 4 Let $l > 0$ and suppose that $\\xi : \\mathbb{R} \\rightarrow \\mathbb{R}$ is an $(l + 1)$-times continuously differentiable function. Let $\\tilde{P_l}(s)$ be the approximated Taylor's polynomial obtained from a given stencil of length $k + 1 \\geq l$ ending at time $t$ and the given sampling time $\\tau$. Let $h \\in \\mathbb{N}$ be a given horizon, and $m \\in [1; h]$ be an arbitrary future sampling instance within the horizon. Suppose for every $p \\in [1,1 + 1]$, $B_p$ denotes the upper bound on the p-th derivative of $\\xi$ in the interval $(t,t + m\\tau)$, \u0456.\u0435., $B_p = \\sup_{r \\in (t,t+m\\tau)} \\xi^{(p)} (r)$. Then,\n$|\\xi(t + m\\tau) \u2013 \\tilde{P_l}(t + m\\tau)| <  \\frac{B_{l+1}}{(l + 1)!} (m\\tau)^{l+1} + \\frac{1}{\\tau} \\sum_{p=1}^{l} \\frac{B_{p+1}}{(p + 1)!}  \\sum_{j=0}^p \\binom{p}{j} (-1)^j j^{p+1} + O(\\tau^2) = O((m\\tau)^{l+1} + \\tau).$\nProof Follows by combining Thm. 1 and Lem. 2.\nThm. 4 suggests that, for small m and for $\\tau < 1$, the prediction error is linear in $\\tau$, \u0456.\u0435., $O(\\tau)$. However, for long prediction horizons $h$ that allow $m \\in [1; h]$ to become too large, the term $(m\\tau)^{l+1}$ may dominate over $\\tau$, and therefore the prediction error may increase to $O((m\\tau)^{l+1})$. Hence, considering larger prediction horizon $h$ requires using smaller sampling time $\\tau$. This trend is visible in the ablation tests that we present in the experiments section. Finally, we remark that the $(l+1)$-times differentiability assumption is necessary only for our error bound analysis in Thm. 4. However, our numerical algorithm for predicting future states remains well defined even without this assumption."}, {"title": "3.2. Taylor-Based Predictive Monitoring (TPM)", "content": "We now present TPM, our predictive runtime monitor for safety properties, based on the numerical state prediction algorithm in Sec. 3.1; the monitor's pseudocode is presented in Alg. 1. The monitor continuously observes the samples drawn from the system's trajectory and stores the latest $l + 1$ samples in the FIFO queue Q. Using the states stored in Q as a stencil, TPM first computes the predicted future states using the approximate Taylor's polynomial (Line 7). Afterwards, in Line 8, it outputs the safety levels of the predicted states or a desired statistic thereof, like the minimum safety level in $h$ steps or the first time instance when safety is violated (i.e., $f$ drops below zero)."}, {"title": "4. Experimental Evaluation", "content": "We implemented the algorithms from Sec. 3 in a prototype tool written in Python, and performed experiments to investigate the following two research questions: (i) How does TPM compare to"}, {"title": "4.1. Experiment 1: Comparison to the Classical Time-to-Collision Method", "content": "We compared the performance of TPM to the baseline time-to-collision (TTC) (Vogel, 2003), a widely used measure in autonomous driving for predicting on-road safety violations (Wang et al., 2021). The TTC metric represents a special case of our approach with $l = 1$, utilizing only the current velocity to estimate the time to collision, assuming the vehicle continues in a straight line along its current orientation.\nWe design TPM monitors with two different types of outputs, namely boolean safety outputs and quantitative safety outputs, each of which can also be predicted by modifying the TTC algorithm. In the following, we describe the two types of outputs along with ways to measure their accuracy, for which we consider the actual system's trajectory as the ground truth."}, {"title": "4.2. Experiment 2: Prediction Accuracy and Ablation Tests", "content": "To visually inspect the prediction accuracy of TPM, in Fig. 3, we plot the outputs of several instances of our monitor, with different horizon lengths, alongside the actual trajectory. We observe that the prediction error increases with longer prediction horizons. To further analyze the relationship between prediction error, Taylor polynomial's degree $l$, and prediction horizon $h$, we conduct ablation tests whose results are shown in Fig. 2. We observe that for F1Tenth, the configuration with $l = 2$ outperforms the rest, for both PP and FTG agents, with the improvement being particularly significant for PP agents. As the prediction horizon increases beyond 0.8s (80 prediction steps), the configuration with $l = 1$ becomes slightly better for the FTG agents. In the F-16 environment, we observe that $l = 3$ yields the best performance."}, {"title": "Monitoring overhead.", "content": "Our experiments were ran on a personal computer with 12th Gen Intel(R) Core(TM) i9-12900K processor and 32GB RAM. In our experiments, the monitoring overhead per observation consistently remains below 0.001 seconds for $l < 14$ and $h = 1$, or for $l < 5$ and $h < 10$. For longer prediction horizons, the overhead incrementally increases to approximately 0.002 seconds. These results demonstrate the efficiency of our monitor, confirming its lightweight nature and suitability for practical applicability."}, {"title": "5. Conclusion", "content": "We introduced a lightweight predictive runtime monitoring framework for black-box controlled dynamical systems, which is able to predict safety violations ahead in time. At each time step, our monitor learns a Taylor-based polynomial approximation of the system's state trajectory from the past observations, which is then used to perform predictions of future states so that safety violations can be predicted. We derive formal upper bounds on the prediction error, given the knowledge of bounds on the derivatives of the trajectory. We present the effectiveness of our monitor on models of a racing car and a fighter aircraft taken from the literature. Future work will focus on studying numerical instabilities, higher order numerical approximations of the derivatives in Taylor's polynomial, different forms of polynomial approximations, as well as extensions to stochastic dynamical systems, multi-agent scenarios, and broader applications beyond safety verification."}]}