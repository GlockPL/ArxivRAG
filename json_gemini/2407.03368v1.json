{"title": "Predict. Optimize. Revise. On Forecast and Policy Stability in Energy Management Systems", "authors": ["Evgenii Genov", "Julian Ruddick", "Christoph Bergmeir", "Majid Vafaeipour", "Thierry Coosemans", "Salvador Garc\u00eda", "Maarten Messagie"], "abstract": "This research addresses the challenge of integrating forecasting and optimization in energy management systems, focusing on the impacts of switching costs, forecast accuracy, and stability. It proposes a novel framework for analyzing online optimization problems with switching costs and enabled by deterministic and probabilistic forecasts. Through empirical evaluation and theoretical analysis, the research reveals the balance between forecast accuracy, stability, and switching costs in shaping policy performance. Conducted in the context of battery scheduling within energy management applications, it introduces a metric for evaluating probabilistic forecast stability and examines the effects of forecast accuracy and stability on optimization outcomes using the real-world case of the Citylearn 2022 competition. Findings indicate that switching costs significantly influence the trade-off between forecast accuracy and stability, highlighting the importance of integrated systems that enable collaboration between forecasting and operational units for improved decision-making. The study shows that committing to a policy for longer periods can be advantageous over frequent updates. Results also show a correlation between forecast stability and policy performance, suggesting that stable forecasts can mitigate switching costs. The proposed framework provides valuable insights for energy sector decision-makers and forecast practitioners when designing the operation of an energy management system.", "sections": [{"title": "I. INTRODUCTION", "content": "Managing energy assets in a grid system is a complex task that requires decision-making under uncertainty. The dynamics and stochasticity of the environment create a constantly evolving and inherently complex system. This reality necessitates making decisions with an incomplete knowledge of the future and for a limited time window, a scenario frequently approached through the lens of online optimization. In many applications, the future is reasonably predictable. Indeed, it is possible to make predictions about future cost function with a significant accuracy, particularly near future.\nTo effectively manage this, it is useful to combine the forecast of the problem environment with the optimization of the decision-making process. This combination of forecasting and decision-making is often referred to as the predict, then optimize problem, or an online optimization with predictions. The online optimization problems with predictions are commonly seen in energy applications such as electric vehicle charging [1] [2], battery scheduling [3][4] and energy and flexibility dispatch problems [5] [6]. In number of these applications, the decision-maker is faced with switching costs, which are the costs associated with updating the operational plan. For instance, transitioning from \\(X_{t-1}\\) to \\(x_t\\) typically incurs a switching cost or ramp cost, \\(d(x_t - X_{t-1})\\). Consequently, the stage cost becomes time-coupled and is defined as: \\(C_t(x_{t\u22121},x_t) := f_t(x_t) + d(x_t - x_{t-1})\\).\nIn the energy sector, the switching costs can arise from various factors, such as the physical limitations of ramping up or down energy production [7], managing server load balancing [8] and payment of network fees associated with energy trading [9]. While there has been a significant amount of research on online optimization problems with predictions, there is a gap in the literature on the impact of switching costs on the interaction between forecast model and the optimization algorithm. We address this gap by studying two aspects of the combined system: time-coupling and forecast stability.\nSwitching costs are a direct consequence of time-coupling, when the action \\(x_t\\) at time \\(t\\) influences the future actions \\(X_{t+1}\\) and system states \\(S_{t+1}\\), as defined by Lin et al. [8]. Errors in forecasts act as 'switching incentive' compelling policy revisions using more accurate predictions aligned with up-to-date information and the actual state of the system. This perspective suggests a balancing act between forecast accuracy and switching costs. This paper explores how this trade-off influences the system's design and operation, suggesting a nuanced view of forecasting's role in optimization.\nIn principle, forecasts used in optimization can be updated every time new information becomes available, often span"}, {"title": "A. Related work", "content": "The problem of decision making with no complete information is often called an online optimization problem. According to Powell [10], the problem involves two main challenges: modelling the sequence of decisions and designing a policy to maximize the objective. Our focus is on a type of optimization problem that depends on the current state, uses a direct lookahead approach, and includes switching costs. The exact details of this problem are given in the Problem Statement in the Section II-A.\nLiterature solutions for integrating forecasting and optimization are classified based on the linkage of these subproblems. There are three categories: Direct, Indirect, and Semi-direct methods.\nDirect methods engage with the optimization problem during training of the forecast making it an integrated approach which is known as 'predict and optimize'. Such approach is proposed in Elmachtoub and Grigas [11], with optimization cost integrated directly into the forecast loss function to align forecasts with end-use optimization. This optimizes the prediction model in the forecasting stage for better decision-making in the optimization stage. The computational burden is partially resolved by using a simplified loss function, however more complex problems can still pose significant computational challenges. There are also other works that design an alternative task-specific loss function, such as reported in Mandi et al. [12], and tested on a real-world energy management problem.\nIndirect methods regard the two subproblems as separate, also referred in literature as 'predict, then optimize'. This approach is regarded as standard and is widely applied in practice. In the study by Vanderschueren et al. [13], an empirical evaluation of direct and indirect approaches is conducted in the context of cost-sensitive classification. Although the study is not directly applicable to the scheduling problems, it is interesting to note that those authors find that the indirect approach where optimization is performed on the predictions of the classifier outperforms the integrated approach. Therefore, the effectiveness of cost-sensitive classification may not always align with the intuitively expected benefits of integrated training within the 'predict and optimize'.\nThe third category, Semi-direct methods, considers characteristics of the optimization problem but abstains from direct interaction during training of the forecast. These methods can take various forms, as potential improvements can occur at any stage outside of the training process. An example is found in the work by Kazmi and Paskevich [14], where those authors propose a Bayesian Optimization approach for integrating the downstream optimization problem into the hyperparameter tuning process of the forecast model.\nThere is a noticeable gap in the literature when it comes to studying operational aspects of forecasting model and optimization deployment. For forecasting, the frequency of the forecast revision can be interpreted as both the frequency of the forecast model deployment and the frequency of model training. The latter aspect is studied by Spiliotis and Petropoulos [15], where those authors investigate different scenarios of updating the model fit for univariate exponential smoothing (ES) and univariate gradient boosting models (LightGBM).\nWe are particularly interested in the applications of optimization with predictions in environments where switching costs are present. This topic has featured in research on online convex optimization (OCO) problems. In control theory, a widespread strategy for tackling online multi-step optimization challenges is the employment of the Receding Horizon Control (RHC) algorithm, also referred to as model predictive control (MPC). When rerun at every time step, this method commits to the first step of the future horizon while treating later decisions as advisory. The research conducted by Chen et al. [16] sheds light on the role of noisy prediction in the design of the OCO algorithm. Those authors propose a model that simulates realistic prediction errors. Using this model, they show analytically that an alternative Averaging Fixed Horizon Control (AFHC) algorithm can achieve sublinear regret and a constant competitive ratio, which indicate a desirable level of optimality in reference to the theoretical best policy. Those authors state that other algorithms can reach better performance if they can use the predictions more efficiently. A later work, Chen et al. [17], introduces a class of policies known as Committed Horizon Control (CHC), which extends the principles of Receding Horizon Control (RHC) and Adaptive Forward Horizon Control (AFHC) through the integration of a commitment concept. This concept involves specifying a predetermined number of steps that the algorithm executes. The analysis of the generalized problem reveals a trade-off set by the varying levels of switching costs and quality of the predictions. The general observation is that the level of commitment is problem-specific and depends on the nature of the switching costs and the quality of the predictions. Therefore, the results show that the commitment level should be tuned for maximizing the performance of the policy.\nCurrent work sets to explore the performance of commitment-based policies in the context of energy management systems. We are particularly interested in analyzing the forecast and planning stability, as a potential factor that influences the performance of the policy. A comprehensive study of forecast stability is made by Godahewa et al. [18]."}, {"title": "B. Contents and Contributions", "content": "Through a systematic review of the literature, it becomes evident that the effects of predictions on online optimization problems with switching costs are not well understood. This present research aims to address this gap by studying the impact of forecast stability and accuracy on the performance of the policy in the context of energy management systems. The principle contributions are as follows:\n\u2022 First, we conduct a theoretical analysis of the performance bounds on the solving algorithm in an online optimization problem with switching costs. We discuss the role of policy commitment and draw a parallel to stability. A trade off is demonstrated between forecast accuracy and switching costs, with the commitment level regulating the balance between the two.\n\u2022 We investigate the effect of forecast accuracy and stability on the downstream performance of the optimization policy. We extend the definition of forecast stability towards probabilistic forecasts and propose a metric for measuring horizontal and vertical stability of scenario sets.\n\u2022 An empirical evaluation of the stability of deterministic and probabilistic scenario sets is conducted. We use the case study of the integrated forecasting and optimization energy management problem from the Citylearn 2022 competition. Based on the case study, we analyze the relationship between forecast accuracy, stability and the performance of the policy. We show that running the policy for a longer period provides a simple mechanism to avoid switching costs while maintaining or improving the performance.\n\u2022 Lastly, the paper concludes with a discussion of the general implications of the results for the design of the energy management systems followed by suggested future research directions."}, {"title": "II. METHODOLOGY", "content": "This paper addresses the challenge of optimizing battery storage management within a multi-agent energy management system. The setting of the problem is first outlined in the CityLearn Challenge 2022 [32] and based on a real-world dataset from a grid-interactive community. More generally, we consider an online optimization with switching costs. The problem is solved with model predictive control (MPC) and full details of the objective score and relevant constraints are provided in Appendix A. The problem includes finding an optimal state-dependent policy \\(X^{MPC}(S_t|0LA)\\). The decision-maker is faced with a sequence of decisions, where the decision at each step is based on the current state \\(S_t\\) of the system and the direct lookahead approximation \\((LA\\). Using the framework proposed by Powell [10], we use the following formulation:\n\\(X^{MPC}(S_t|0LA) = \\underset{X_{t+1},..., X_{t+H}}{arg\\, min} \\sum_{i\\in \\N}W^i \\left(\\sum_{t'=t+1}^{t+H} k^i(x_{tt'},\\Theta) + B ||X_{tt'} - X_{t(t'-1)}||\\]\\)\nIn this formulation:\n\u2022 \\(X^{MPC}(S_t|0LA)\\) Represents the optimal set of decisions (battery charging \\(x^{pos}\\) and discharging \\(x^{reg}\\) actions) made by the MPC at time t based on the current state \\(S_t\\) and the lookahead approximation model \\((LA\\). This model enables predicting future costs within a horizon H, taking into account the expected electric load and PV generation.\n\u2022 \\(C(x; S)\\) is the cost function, which is a function of actions \\(x = x_t, ...X_{t+H}\\) and states \\(S = S_t, ...S_{t+H}\\).\n\u2022 \\(W^s\\) Weight factor for scenarios, indicating the importance of different scenarios in the decision-making process. We assume that the weight factors are equal for all scenarios. In the deterministic case, the number of scenarios is equal to 1.\n\u2022 \\(h(x_{tt'}; \\Theta)\\) Represents the cost of the set of decisions \\(X_{t+1}, ..., X_{t+H}\\) given the future forecast scenarios generated by the model \\(OLA\\).\n\u2022 \\(\\beta ||X_{tt'} - X_{t(t'-1)}||\\) is a switching cost, where \\(\\beta \\in R^+\\), and \\(||\\cdot||\\) can be any norm in \\(R^n\\). The switching cost is imposed by ramping costs, integral to the objective function.\nOptimized battery schedules are evaluated using a set of KPIs. The optimization targets the minimization of the equally weighted sum of the normalized electricity cost C and carbon emissions G. The optimization score is defined as:\n\\(Average Score = avg\\left(\\frac{C_{entry}}{C_{no\\, battery}}, \\frac{G_{entry}}{G_{no\\, battery}}\\right)\\)\nWhen grid-related Key Performance Indicators (KPIs) are included, the average includes the grid score D. The grid"}, {"title": "B. Optimization", "content": "The optimal policy is computed for the current state of the system and the forecast for the next H time steps. An online optimization algorithm typically determines the optimal actions \\(X_{t+1},..., X_{t+H}\\) given a prediction window of length H. Every \\(v\\) time steps, the optimization is rerun to generate a new plan. This algorithm is referred to as a Fixed Horizon Control (FHC) algorithm.\nIn the context of the online optimization algorithms, the term \"commitment\" refers to the duration or number of time steps for which the optimized policy is committed to before the optimization process is rerun to generate a new plan. This concept plays a crucial role in determining how frequently the optimization is updated based on new information, accumulation of forecast errors and changes in the system's state. An FHC algorithm with the shortest commitment is the Receding Horizon Control (RHC) algorithm. In RHC, the commitment is \\(v = 1\\), indicating that the optimization is rerun at every time step.\nSimilar to the optimization, the forecast is also run in a rolling origin fashion. The optimal policy is then applied to the system for the next \\(v_F\\) time steps and the process is repeated every \\(v_F\\) steps. In summary, both the forecast and the optimization have the same rolling origin setup and need to be updated at certain intervals while committing to \\(v\\) steps. Ultimately, at each time step, the decision-maker is faced with a decision to either reuse the current plan or to revise it. Similarly, the forecast can be reused or revised."}, {"title": "C. Theoretical Analysis of Performance Bounds", "content": "In this section, we analyze the upper bound on the performance of the FHC algorithm with a limited commitment \\(v\\). We focus on the cost difference between the optimal policy and the policy produced by the FHC algorithm. Specifically, we examine the impact of the commitment \\(v\\), which defines"}, {"title": "IV. DISCUSSION", "content": "The observations from the results are consistent with the theoretical analysis of the upper bound on the competitive difference of the FHC algorithm. We observe that the optimal commitment period is dependent on the forecast properties.\nThe inclusion of switching costs in the optimization problem changes the relationship between desired forecast properties and the optimization score. The forecast error is broadly lower with shorter commitment periods, however, the horizontal and vertical stability become also relevant. In the theoretical analysis, we see that for a more realistic model of the prediction noise with exponentially decaying correlation, a trade-off emerges between the forecast error and the switching costs. Through testing with real data, we observe that switching costs can be partially mitigated by committing to more stable forecasts and optimization plans.\nThe addition of switching costs makes the algorithmic problem harder as it forces current actions to depend on beliefs about future cost functions.\nWe identify two reasons for underperformance of the algorithm with a minimal commitment period (RHC, equivalent to FHC with \\(v_O\\) = 1). Firstly, when the policy is computed for a period in a problem with switching cost, the past decisions are calculated as optimal with respect to future decisions given the forecast, however, after the policy is reviewed at the next iteration with an updated forecast, the optimality of the executed decision at the recent time step does not hold, since the future policies within the same horizon are reviewed. A simple illustrative example would be the battery is discharged first with an outlook for charging in the future when the price is more favorable. Once the forecast and policy updates, the updated policy is discharging again, however the battery has been discharged earlier. The second reason is that while the objective cost function does include the term for the switching costs \\(B||Xt-Xt\u22121||\\), the switching costs are computed pairwise between loads at close time instances. However, since the total charging capacity of batteries is finite and limited, it is advantageous to regulate switching costs within longer action windows.\nWhen prediction is inaccurate in the look-ahead window, the RHC is more effective than FHC with a commitment period. If we make predictions accurate for a small window \\(\\gamma\\) and then inaccurate for the remaining (\\(\\omega\\) \u2013 \\(\\gamma\\)) steps of the lookahead window, the fixed horizon policy is affected by the inaccurate predictions whereas RHC only acts on the correct ones. This is typically the case for a multi-step horizon forecast when the nearest steps are predicted at a higher accuracy. The situation changes for a stochastic MPC, generally hedged better against prediction errors. We can see from the results that FHC with longer commitment period becomes viable when the optimization is computed for a set of scenarios, as opposed to a deterministic point forecast."}, {"title": "V. CONCLUSION", "content": "In conclusion, this study highlights the critical role that switching costs, forecast accuracy, and stability play in the design and operation of energy management systems. In summary, our analysis shows that in systems where forecasts guide decision making, stability of predictions can reduce the frequency and severity of policy revisions, thereby mitigating the financial and operational impacts of switching costs. Our findings have significant implications for the design of energy management systems. They suggest that enhancing the stability of forecasts can improve system performance by reducing the need for frequent adjustments and managing the trade-offs between immediate and future resource allocation more effectively. Furthermore, we propose a novel approach to evaluating the stability of probabilistic forecasts using the Earth Mover's Distance, which provides a robust measure of the dissimilarity between scenario sets.\nLooking ahead, there are questions remaining to be addressed. For future research, we recommend further exploration into methods that enhance forecast stability without compromising accuracy. It would be beneficial to extend this work to other applications with switching costs, such as supply chain management and financial trading. Furthermore, from literature and current findings, there are indications that methods like AFHC and stochastic FHC, show more robustness in hedging against the forecast errors by aggregating policies with different underlying scenarios. However, they require more computational resources and are more complex to implement. An interesting avenue for future research would be defining the criteria for problems where these methods are most effective. These efforts would contribute to a deeper understanding of forecast-dependent optimization and improve the operational strategies of energy management systems facing an evolving energy landscape."}, {"title": "A. Optimization score", "content": "Optimized battery schedules are evaluated using a set of KPIs, each of which is targeted for minimization. The optimization targets the minimization of the equally weighted sum of the normalized electricity cost C and carbon emissions G. The optimization score is defined as:\n\\(Average Score = avg\\left(\\frac{C_{entry}}{C_{no\\, battery}}, \\frac{G_{entry}}{G_{no\\, battery}}\\right)\\)\nWhen grid-related KPIs are included, the average includes the grid score D. The grid score is computed as the mean of the normalized ramping KPI R and the Load Factor KPI (1 \u2013 L). The grid score, D, introduces switching costs in the optimization by accounting for the ramping costs associated with frequent changes in forecasting. Therefore, in order to provide a comprehensive analysis of the impact of switching costs on the optimization, in this study we consider both optimizations with and without the grid score. The average score with the grid cost is defined as:\n\\(Average Score (with grid cost) = avg\\left(\\frac{C_{entry}}{C_{no\\, battery}}, \\frac{G_{entry}}{G_{no\\, battery}}, D\\right)\\)\nAll the scores range from 0 to 1 because they are normalized by the no-battery scenario, representing the improvement as a fraction of the metric compared to the no-battery scenario.\nThe normalized electricity cost, C, as delineated in Eq. 22, is the ratio of electricity spending in a given policy, Cpolicy, to the spending in a reference scenario without battery intervention, Cnobattery The cost metric c is further defined in Eq. 23 as the aggregate of the non-negative product of district-level net electricity price, \\(E_h\\) \u00d7 \\(T_h\\)($), where \\(E_h\\) denotes the electricity consumption of the district at the hour h and \\(T_h\\) specifies the electricity rate corresponding to that hour.\n\\(C = \\frac{C_{submission}}{C_{nobattery}}\\)\n\\(c = \\sum_{h=0}^{n-1} max(0, E_h \u00d7 T_h)\\)\nSimilarly, the normalized carbon emissions, G, is defined in Eq. 24 as the ratio of district carbon emissions for a given policy, gpolicy, relative to the emissions in the aforementioned baseline scenario, Inobattery. The emission metric g is elaborated in Eq. 25 as the sum of carbon emissions, measured in (kgCO2e/kWh), given by \\(E_h\\) \u00d7 \\(O_h\\). Here, \\(O_h\\) represents the carbon intensity for the hour h.\n\\(G = \\frac{I_{submission}}{I_{nobattery}}\\)\n\\(g = \\sum_{h=0}^{n-1} max(0, E_h \u00d7 O_h)\\)\nLastly, the evaluation metric includes a grid-related KPI, D. The metric follows grid-level objectives, such as the minimization of ramping and load factor. It is defined as the mean of the normalized ramping KPI, R, and the Load Factor KPI,"}, {"title": "B. MPC Formulation", "content": "\\(C(S_t, x_t, \\Theta^A) = \\sum_{i\\in price, carbon,grid} C_i(S_t,\\Theta^{t+H})\\)\nsubject to\n\\(SOC_{min} \\leq SOC_t \\leq SOC_{max}, \\forall t,\\)\n\\(x_t = x_{Pos} + x_{reg}, S_t,\\)\n\\(P_{max} \\leq x_{reg} \\leq 0, \\forall t,\\)\n\\(SOC_t = SOC_{t\u22121} + \\frac{1}{N_{charging}} x_{Pos} - \\frac{1}{N_{discharging}} x_{reg}, \\forall t.\\)\nIn this formulation:\n\u2022 \\(X^{MPC}(S|\\Theta^A)\\) Represents the optimal set of decisions (battery charging \\(x^{pos}\\) and discharing \\(x^{res}\\) actions) made by the MPC at time t based on the current state \\(S_t\\) and the lookahead approximation model \\(\\Theta^{A-1}\\) This model enables predicting future costs within a horizon H, taking into account the expected electric load and PV generation.\n\u2022 \\(W^s\\) Weight factor for scenarios, indicating the importance of different scenarios in the decision-making process. We assume that the weight factors are equal for all scenarios. In the deterministic case, the number of scenarios is equal to 1.\n\u2022 \\(C_{price}\\), \\(C_{carbon}\\), and \\(C_{grid}\\) are cost functions representing the cost of electricity, the cost associated with carbon"}]}