{"title": "Symmetry-Constrained Generation of Diverse Low-Bandgap Molecules with Monte Carlo Tree Search", "authors": ["Akshay Subramanian", "James Damewood", "Juno Nam", "Kevin P. Greenman", "Avni P. Singhal", "Rafael G\u00f3mez-Bombarelli"], "abstract": "Organic optoelectronic materials are a promising avenue for next-generation electronic devices due to their solution processability, mechanical flexibility, and tunable electronic properties. In particular, near-infrared (NIR) sensitive molecules have unique applications in night-vision equipment and biomedical imaging. Molecular engineering has played a crucial role in developing non-fullerene acceptors (NFAs) such as the Y-series molecules, which have significantly improved the power conversion efficiency (PCE) of solar cells and enhanced spectral coverage in the NIR region. However, systematically designing molecules with targeted optoelectronic properties while ensuring synthetic accessibility remains a challenge. To address this, we leverage structural priors from domain-focused, patent-mined datasets of organic electronic molecules using a symmetry-aware fragment decomposition algorithm and a fragment-constrained Monte Carlo Tree Search (MCTS) generator. Our approach generates candidates that retain symmetry constraints from the patent dataset, while also exhibiting red-shifted absorption, as validated by TD-DFT calculations.", "sections": [{"title": "1. Introduction", "content": "Organic optoelectronic materials have emerged as promising candidates for next-generation electronic devices, particularly in the fields of organic photodiodes (OPDs) and organic photovoltaics (OPVs). These materials offer unique advantages such as solution processability, mechanical flexibility, and tunable electronic properties, making them attractive alternatives to traditional inorganic semiconductors\n(Sun et al., 2022; Li et al., 2022; Shan et al., 2022). Of particular interest are low-bandgap \u03c0-conjugated organic molecules and polymers sensitive to near-infrared (NIR) wavelengths, which can harvest a broader portion of the solar spectrum, extending beyond the visible range. These NIR-sensitive materials have found diverse applications, from military night-vision equipment to biomedical imaging devices and semi-transparent photovoltaics (Xu et al., 2008; Liu et al., 2017; Li et al., 2017; Xu et al., 2017). The optimization of molecular structures, especially the design of improved donor-acceptor (D-A) systems, has led to substantial progress in the power conversion efficiency (PCE) of OPV devices. Over the past decade, PCE has increased from around 5% to over 19% for single-junction devices (Meng et al., 2022). This advancement is largely attributed to the development of non-fullerene acceptors (NFAs), which offer more tunability of energy levels and absorption spectra through molecular engineering, than fullerene acceptors (FAs) (Yan et al., 2018). The Y-series family of NFAs (Y1 through Y6) has been a particularly promising class of molecules (Yang, 2021), which has sparked several follow-up designs and derivatives (He et al., 2022). These improvements highlight the role of molecular design in enhancing device performance and the potential for further advancements through innovative approaches to materials discovery.\nOver the past half-decade, generative models have received tremendous attention in molecular design (Schwalbe-Koda & G\u00f3mez-Bombarelli, 2020; Elton et al., 2019), using a variety of algorithms and molecular representations (Segler et al., 2018; Bjerrum & Threlfall, 2017; G\u00f3mez-Bombarelli et al., 2018; Kusner et al., 2017; Olivecrona et al., 2017; Mercado et al., 2021; Jin et al., 2018; Flam-Shepherd et al., 2021). However, without special attention to synthetic accessibility, off-the-shelf models often generate non-synthesizable designs (Gao & Coley, 2020). Several existing approaches incorporate knowledge about synthesizability into generative models, either implicitly or explicitly.\nImplicit approaches typically work by 1) biasing the objective function for property optimization with an additional synthesizability term, 2) applying a synthesizability filter post-hoc to generated candidates, or 3) constraining the training dataset using combinatorial enumerations of molec-"}, {"title": "2. Methods", "content": "Our previous work developed an automated pipeline to mine USPTO patents and create domain-focused unsupervised datasets of molecular structures (Subramanian et al., 2023). These patent-derived molecules likely possess two important characteristics: high performance (justifying the investment in a patent application) and synthetic accessibility. Consequently, the fragments present in these structures, along with their reactive positions (points of connectivity), potentially correlate with both synthetic accessibility and domain-specific properties. Moreover, the symmetry of reactive positions relative to each other encodes information about the synthetic pathways used to create these molecules. To effectively leverage this structural and synthetic information, we have developed a two-stage method: Fragment Decomposition: We designed an algorithm that extracts fragments and their reactive positions from patent-mined structures, while marking each reactive position in a way that faithfully represents the identity of the substructure attached to it. This preserves important contextual information about molecular connectivity. Constrained Generation: We implemented a generation algorithm based on MCTS that constrains the output to molecules composed solely of patent-extracted fragments. These fragments are attached at their corresponding reactive positions while adhering to the symmetry requirements observed in the original patent structures. This approach aims to maintain synthetic feasibility while exploring novel molecular configurations. By combining these two"}, {"title": "2.1. Fragment Identity, Connectivity and Symmetry", "content": "To utilize this information effectively during generation, we develop:\n1.  A fragment decomposition algorithm that extracts fragments and their reactive positions from patent-mined structures, preserving symmetry information.\n2.  A generation algorithm based on Monte Carlo Tree Search (MCTS) (Kocsis & Szepesv\u00e1ri, 2006; Coulom, 2006; \u015awiechowski et al., 2023) that constrains the generated molecules to contain only the previously extracted fragments attached at their reactive positions, while satisfying symmetry requirements.\nWe evaluate our method on two chemical spaces of different sizes, a smaller, focused space of Y6-derivatives (Yang, 2021), and a much larger space of patent-mined fragment derivatives (Subramanian et al., 2023). We employ Time-Dependent Density Functional Theory (TD-DFT) to obtain our \"ground-truth\" bandgaps for training and evaluation. Our generated candidates retain symmetry constraints from the patent dataset while also exhibiting red-shifted absorption."}, {"title": "2.1.1. FRAGMENT DECOMPOSITION", "content": "We developed a fragment decomposition algorithm that preserves connectivity and symmetry information from patent molecules. We achieve this through a recursive application of RDKit reaction SMARTS (Landrum et al., 2013). More details are provided in the following paragraphs, and an illustrative example is shown in Figure 1(b).\nA reaction SMARTS string is first defined to indicate what types of bonds must be deleted during decomposition. For our purpose, we defined this so that single bonds connecting an aromatic ring with an aliphatic chain, or an aromatic ring to another aromatic ring are matched. The algorithm consists of two steps: 1) creation of fragment vocabulary, 2) fragment decomposition and assignment of reactive sites.\nIn step 1, the reaction SMARTS is applied to the molecule to get all possible fragments that are obtainable from deletion of one bond in the molecule. The vocabulary of unique fragments is created, and each is assigned a unique ID. For the IDs, we use numbers [0, N) where N is the number of fragments in the vocabulary. Details on how this is actually represented in our code implementation are given in SI Section E.\nIn step 2, the original molecule is recursively decomposed with one-bond deletions to form a binary tree. After every application of the reaction SMARTS, the reactive positions (positions at which bond deletion was performed) on the fragment are labeled using the ID of the fragment which was attached before the bond was broken. This preserves information about the identity of the fragment which was connected at the reactive position. The two fragments are then checked for a match with the reaction SMARTS to see if further decomposition is possible. If possible, the same series of steps described above is performed on the fragment. Otherwise, the fragment is a leaf node on the binary tree, and is added to the list of final fragments.\nFinally, memoization (Michie, 1968) can be used to prevent redundant decompositions of the same fragment. We memoize computations in a hash table during tree creation, and reuse previously performed computations. Figure 1 illustrates this process of fragment decomposition on an example molecule."}, {"title": "2.1.2. GENERATION WITH MCTS", "content": "We frame the problem of designing a molecule as a series of building block/molecular fragment choices. MCTS is an efficient method of navigating large exploration spaces, that learns to optimize a chosen reward function by iteratively updating value estimates for action choices in the tree (Kocsis & Szepesv\u00e1ri, 2006; Coulom, 2006; \u015awiechowski et al., 2023; Silver et al., 2016). Since our objective is to design low-bandgap molecules, our reward function of choice is the negative bandgap as predicted by Chemprop (Heid et al., 2023), a message-passing neural network (MPNN) architecture that we trained on labels obtained from TD-DFT calculations. Each iteration of the MCTS algorithm consists of four sequential steps: selection, expansion, rollout, and backpropagation. The selection step starts with the root node and traverses the already explored portions of the tree to reach a leaf node. In our work, the path from the"}, {"title": "2.2. Generating Chemically Diverse but Optimal Candidates", "content": "We aimed to generate a number of chemically diverse, yet also high performing candidates to increase the likelihood of at least a subset of candidates being experimentally synthesizable. In addition, we have observed empirically from our previous work that the proxy reward predictor has the tendency to be adversarially attacked during training in reinforcement learning settings because of its potential un-reliability in out of domain regions (Subramanian et al., 2023). Proposing chemically diverse molecules that have high predicted rewards can allow for an increased chance that a subset of the proposals is in-domain for the reward predictor. The vanilla formulation of MCTS converges at a policy that maximizes expected cumulative reward (Silver et al., 2016; \u015awiechowski et al., 2023), and hence does not guarantee chemical diversity. To overcome this limitation, we iteratively re-train MCTS with a time-dependent reward term that penalizes chemical similarity to high-performing molecules from previous iterations. More formally,\n$R_i(x) = C(x) - \\text{max}_{y \\in Y_{<i}} S(x, y)$ (1)\nwhere $R_i$ is the reward used for training MCTS at the ith iteration, C is the property reward function, $Y_{<i}$ is the inventory of high-performing molecules collected from iterations i' < i, and S is a function computing similarity between molecules x and y (which we choose to be Tanimoto similarity). Figure 2(a) shows the evolution of the bandgap and similarity as a function of iteration. The point displayed at each iteration corresponds to the molecule with the lowest bandgap from the last 100 timesteps of MCTS training. We can see that the constrained optimization task becomes more challenging as more molecules are appended to the inventory $Y_{<i}$, resulting in an upward trend in both blue and red curves. Figure 2(b) zooms into a single iteration and shows the bandgap and similarity curves as a function of training step. In this case, training seems to converge after around 2,000 training steps."}, {"title": "2.3. Markov Decision Process", "content": "The Markov Decision Process (MDP) can be defined as a tuple of the state space S, the action space A, the reward R, and the transition probability P. We define MDPs for our two demonstrative tasks below."}, {"title": "2.3.1. Y6 DERIVATIVES", "content": "We formulated this to be a highly focused and relatively small-sized chemical space as a test bed for exploring the capabilities of the approach. Building a molecule involves four hierarchies of actions to be made: 1) modification of heteroatoms and ring sizes in the Y6 core, 2) optional addition of pi-bridges to extend conjugation in the molecule, 3) addition of terminal end-groups, and 4) addition of alkyl chains. Many of the fragment choices included here were taken directly from suggestions provided in Yang (2021). We provide a more formal description of the MDP below.\nLet $S_t$ and $A_t$ denote the state and action spaces respectively at timestep t. Then, $S_1$ is a singleton set containing the Y6 core marked with modifiable positions shown in Figure 1(a). The first group of actions (with action spaces $A_{1<t<4}$) are those that modify the structure of the central Y6 core by allowing heteroatom and ring-expansion modifications at positions marked with pos0, pos1, pos2, and pos3."}, {"title": "2.3.2. PATENT-EXTRACTED FRAGMENT DERIVATIVES", "content": "We formulated this to be a more expansive test case with a much larger chemical space, with the aim of discovering highly red-shifted molecules with diverse chemistries. In regimes of this size, exhaustive enumeration of all achievable molecules becomes impractical. Building a molecule in this environment involves three hierarchies of actions: 1) Choosing a core fragment, 2) Optional addition of pi-bridges to the core, and 3) Addition of terminal end-groups/alkyl chains.\nIn this case, each reaction involves not just the choice of a fragment identity, but also the choice of reactive position to which it has to be attached. The choice of reactive position is included as stochasticity in the environment rather than"}, {"title": "2.4. Training Reward Predictor", "content": ""}, {"title": "2.4.1. TD-DFT CALCULATIONS", "content": "TD-DFT calculations were used as \"ground-truth\" labels to train our Chemprop reward predictor, as well as to validate the bandgaps of generated candidates. Calculations were performed with the same pipeline that we used in Subramanian et al. (2023). RDKit ETKDG (Landrum et al., 2013) approach was used to generate initial conformations, with at least 1,500 attempts. The conformers were ranked according to their MMFF94 energies, and the 20 with the lowest energies were chosen (Riniker & Landrum, 2015). An initial geometry optimization was performed with semi-empirical tight-binding density functional theory (GFN2-xTB) (Bannwarth et al., 2019) in ORCA 4.2.0 (Neese et al., 2020). Subsequent geometry optimizations were performed on the lowest energy xTB conformers at the BP86(Becke & Becke, 1988)-D3(Grimme et al., 2011)/def2-SVP(Weigend & Ahlrichs, 2005) level of theory. Finally, single-point TD-DFT calculations were performed at the wB97X-D3(Chai & Head-Gordon, 2009)/def2-SVPD level of theory using the Tamm-Dancoff approximation (TDA) (Hirata & Head-"}, {"title": "2.4.2. ACTIVE LEARNING FOR DATA COLLECTION", "content": "To ensure that the reward predictor is accurate in the generation domain of MCTS, we performed iterations of active learning (AL) with a combination of acquisition functions to collect training data. Figure 3 shows the improvement in reward predictor with each iteration of AL. Chemprop (Heid et al., 2023) was our architecture of choice for the reward predictor. It was first pre-trained on a dataset containing 5,568 datapoints obtained from patents and labeled with TD-DFT bandgaps which we created in Subramanian et al. (2023). The second round of training was performed on random rollouts generated from MCTS. These two rounds were sufficient to get accurate (we chose the stopping criterion to be an RMSE of 0.2 eV) performance on the focused Y6 chemical space, but the patent-extracted fragment space required an additional round of training. This was done on a combination of datapoints obtained from 1) running the iterative procedure described in Section 2.2 and choosing the best candidate from the last 100 training steps of each iteration, and 2) choosing 100 molecules with the highest value of expected improvement (EI) from 10,000 randomly sampled candidates from MCTS.\n$EI(x) = (\\mu - f(x^*)) \\Phi(\\frac{\\mu-f(x^*)}{\\sigma}) + \\sigma \\varphi(\\frac{\\mu-f(x^*)}{\\sigma})$\nwhere u is the negative of the Chemprop-predicted bandgap, and o is the standard deviation of predictions from the model ensemble, which is a measure of model uncertainty. $\\Phi$ and $\\varphi$ are the cumulative distribution function (CDF) and probability density function (PDF) of a normal distribution, respectively. $f(x^*)$ is the highest value of predicted reward from the current batch of candidates. While acquisition method 1 obtains a diverse set of most optimal candidates, method 2 obtains a set of optimal candidates as well as suboptimal but high-uncertainty candidates. Together, these two acquisition methods provide training data in explorative and exploitative regimes."}, {"title": "3. Results and Discussion", "content": "We validated the final 100 diverse candidates obtained from each of Y6 and patent MDPs with TD-DFT bandgap calculations. We show histograms of these bandgaps in Figure 2 (e) in comparison to the original patent dataset, and random rollouts sampled from MCTS. It can be seen that the MCTS optimized patent and Y6 candidates are strongly red-shifted with respect to random rollouts as well as the patent distribution.\nOn the final 100 structures from each MDP, we performed k-"}, {"title": "4. Conclusions", "content": "In this paper, we developed an approach based on the Monte Carlo Tree Search algorithm to generate optimal low-bandgap molecules while also maintaining a degree of synthetic accessibility. We achieve this by utilizing structural priors from a domain-focused patent-mined dataset of organic electronics molecules through a symmetry-aware fragment decomposition algorithm and a fragment-constrained MCTS generator. Our generated candidates retain symmetry constraints from the patent dataset while also exhibiting red-shifted absorption. As future extensions to this work, the optimization objective can be augmented to include solubility (along with the inclusion of alkyl chain exploration into the MDP) and oscillator strengths. Finally, while our approach for diverse candidate generation is iterative, non-iterative objectives as used in GFlowNet (Bengio et al., 2023) could be more efficient alternatives for the future."}]}