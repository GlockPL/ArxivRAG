{"title": "PhantomWiki: On-Demand Datasets for Reasoning and Retrieval Evaluation", "authors": ["Albert Gong", "Kamil\u0117 Stankevi\u010di\u016bt\u0117", "Chao Wan", "Anmol Kabra", "Raphael Thesmar", "Johann Lee", "Julius Klenke", "Carla P. Gomes", "Kilian Q. Weinberger"], "abstract": "High-quality benchmarks are essential for evaluating reasoning and retrieval capabilities of large language models (LLMs). However, curating datasets for this purpose is not a permanent solution as they are prone to data leakage and inflated performance results. To address these challenges, we propose PhantomWiki: a pipeline to generate unique, factually consistent document corpora with diverse question-answer pairs. Unlike prior work, PhantomWiki is neither a fixed dataset, nor is it based on any existing data. Instead, a new PhantomWiki instance is generated on demand for each evaluation. We vary the question difficulty and corpus size to disentangle reasoning and retrieval capabilities respectively, and find that PhantomWiki datasets are surprisingly challenging for frontier LLMs. Thus, we contribute a scalable and data leakage-resistant framework for disentangled evaluation of reasoning, retrieval, and tool-use abilities.", "sections": [{"title": "1. Introduction", "content": "Designing agents that can perform complex reasoning while interfacing with a large-scale, dynamic corpus-like Wikipedia-is a long-standing goal in the field of natural language processing (Feldman & El-Yaniv, 2019; Min et al., 2019). Such a goal may be within reach given the impressive capabilities of recent language models, which are all trained on internet-scale data. For example, the ability of LLMs to solve math problems on GSM8K (Cobbe et al., 2021) and mathematical olympiads (AlphaProof & AlphaGeometry, 2024) could bode well for agents to answer highly quantitative questions. On benchmarks like DROP (Dua et al., 2019) and MMLU (Hendrycks et al., 2020), these LLMs demonstrate advanced reading comprehension and general reasoning capabilities, both necessary for intelligent agents. When augmented with retrievers (Muennighoff et al., 2022) and tools (Patil et al., 2023), LLMs seem to already possess a strong ability for accessing external datastores and knowledge bases.\nHowever, it is unclear to what extent these models rely on their internal knowledge, which can easily become outdated, versus their reasoning and retrieval abilities. Consider the example, \"What is the date of birth of Wolfgang Amadeus Mozart?\". Since this fact is contained within LLMs' pre-training data, asking LLMs this question cannot provide reliable insight on whether the answer was deduced, retrieved or recalled. At the same time, existing approaches that perturb Wikipedia facts (Cohen et al., 2024; Meng et al., 2022; Elazar et al., 2021) to construct new question-answer pairs face challenges of ensuring factual consistency across articles. For example, changing Mozart's date of birth to 2025 also requires modifying Beethoven's article to erase the fact that Beethoven might have met Mozart in 1787!\nOne could hope to isolate reasoning from factual knowledge using mathematical or logical reasoning benchmarks. Unfortunately, such benchmarks are not entirely reliable as indicators of reasoning performance either. On GSM8K, a dataset of grade school math problems, Mirzadeh et al. (2024) report that frontier models perform significantly worse with minor or even meaningless alterations to the test data-indicating these models are vulnerable to overfitting at best and exact memorization at worst. To ensure fair comparison, LLMs need to be evaluated in a way that does not depend on any particular dataset instance.\nFollowing this philosophy, we develop PhantomWiki. At the click of a button, PhantomWiki generates a fictional universe of characters along with a set of facts about them. We reflect these facts in a large-scale corpus, mimicking the style of fan-wiki websites. Then we generate question-answer pairs about the universe, encapsulating the types of multi-hop questions commonly considered in the question-answering (QA) literature.\nWe design PhantomWiki to decouple the testing of LLM reasoning and retrieval capabilities in a range of settings. In the first setting, the universe is small enough so that all relevant"}, {"title": "2. Related Work", "content": "Agent benchmarks, such as T-bench (Yao et al., 2024), Tool-Woz (Lattimer et al., 2024), Alfworld (Shridhar et al., 2020) and WebArena (Zhou et al., 2023), focus on tasks where the agent is given a binary reward for successful completion of a task (e.g., booking a flight, making a purchase). In this work, we focuses more on tasks where the agent is rewarded for responding to a question with a factually correct answer. (In Section 3, we concretize what we mean by a \"fact\" and \"correctness\".) Zhou et al. (2023, Section 3.2) include a category of information-seeking tasks, however these tasks often require navigation across multiple pages or focus on user-centric content. Yao et al. (2024, Appendix. A) measure task difficulty based on the average success rate of frontier models (e.g., GPT-4). Our work defines a model-agnostic measure of difficulty, which we show provides more meaningful insight into the reasoning and retrieval aspects of LLMs.\nIn the QA domain, existing benchmarks are designed to test whether LLMs are able to reason and use tools. Closer to our work in the space of question-answering agents is the ToolQA benchmark of Zhuang et al. (2023). They introduce a framework to construct question-answer pairs from databases and documents by first generating question templates using LLMs, then filtering for high-quality templates, and finally deriving ground-truth answers by writing corresponding Python programs for each question template. Zhuang et al. (2023, Tab. 1) construct two pure-text datasets: SciREX with 438 documents and 5 question templates, and Agenda with 10k event entries and 10 question templates. In constrast, PhantomWiki generates instances at much larger scale with 50 question templates and 1 million documents.\nFor generating factually-grounded answers, retrieval augmented generation (RAG) has emerged as the predominant paradigm (Lewis et al., 2020; Karpukhin et al., 2020; Guu et al., 2020). However, evaluating RAG systems is notoriously difficult, leading to a flourishing of retrieval benchmarks (Petroni et al., 2020; Saad-Falcon et al., 2023; Jin et al., 2024; Hsia et al., 2024; Mao et al., 2024; Rau et al., 2024). A key pain-point of RAG is handling questions that involve multi-hop reasoning. This motivated Tang & Yang (2024) to design the MultiHop-RAG dataset with synthetically generated questions and Su et al. (2024) to curate a dataset of question-answer pairs that requires intensive"}, {"title": "3. PhantomWiki Construction", "content": "PhantomWiki is at its core an on-demand random generator of fictional worlds. Similarly to the wiki hosting services popular in film, video games, and literature\u00b9, we represent these fictional worlds through Wikipedia-like biographical entries about their characters. We then test the model's retrieval skills and its understanding of the fictional world through an accompanying set of automatically generated question-answer pairs.\n3.1. Generating a Phantom Wiki Universe\nThe first stage of the PhantomWiki pipeline generates a random universe of n characters as well as the document corpus describing it, as illustrated in Figure 2, (1-2).\nGenerating Characters. Each character in a PhantomWiki universe is described through its social relationships and personal facts (Figure 2, (1)). For the social relationships, we first generate family trees, following the family tree generator of Hohenecker & Lukasiewicz (2020). We iteratively pick a person and generate their parent or child based on various constraints\u00b2, until the user-specified universe size of n people is reached. The user can also specify other hyperparameters like the number of trees, their maximal depth, and the maximal number of offspring for each person. In addition to the family trees, we generate a friendship graph using the Erd\u0151s\u2013R\u00e9nyi model (making two people friends with some fixed probability, typically controlled by the desired average number of friendships.)\nGenerating Facts. Next, we generate personal facts for each person in the PhantomWiki universe. Names are assigned during the family generation procedure, with the first name sampled based on the character's gender and the sur-"}, {"title": "3.2. Generating Question-Answer Pairs", "content": "In the second half of the PhantomWiki pipeline, we generate a set of questions with verifiable answers, as shown in Figure 2, (3-4).\nGenerating Questions. We implement automatic question generation through a context-free grammar (CFG, Hopcroft et al. 2001) of question templates, which we then use to sample complete questions. For example, the question template \"Who is the <relation> of <name>?\" can be used to sample the question \"Who is the friend of David?\" (see Figure 2, (3)). The main advantage of using a CFG is that it efficiently and systematically obtains all possible compositions of questions for some recursion depth d. For instance, the following subset of our context-free grammar:\nGenerating Answers. To ensure that the answers to"}, {"title": "3.3. Phantom Wiki Complexity", "content": "The goal of PhantomWiki is to generate memorization-resistant evaluation datasets that are challenging in both reasoning and retrieval aspects. In this section, we discuss our conceptual and practical design choices that help us achieve this goal.\nUniverse Space Complexity. To ensure that our evaluation with PhantomWiki is memorization and data leakage-resistant,\nwe first show that the space of possible universes is sufficiently large to generate enough unique instances. Observe that the number of possible friendship assignments grows at the rate of ${2n^2}$ (Flajolet & Sedgewick, 2009, Ex. II.5) as the number of individuals n in the universe increases. Similarly, assuming each individual is assigned one fact from each category (job, hobby, etc.), the number of possible fact assignments grows at the rate (cn), where c is the total number of choices across the categories. PhantomWiki thus samples a corpus from \u2208($2n^2cn$) possible universes, which leads to diverse datasets optimal for data leakage-resistant evaluation. We note that as future work PhantomWiki could be extended to increase this diversity, e.g. by adding a temporal dimension of events.\nReasoning Complexity. The CFG enables us to recursively compose templates that lead to complex reasoning questions. Observe that our CFG in Appendix B produces O(d) question templates as the recursion depth d increases. Moreover, we can increase the difficulty of each template by"}, {"title": "4. Experimental Validation", "content": "We evaluate reasoning and retrieval capabilities of several frontier LLMs using PhantomWiki, by decomposing their performance over questions of varying difficulty and universes of varying sizes.\n4.1. Evaluation Setup\nWe generate PhantomWiki instances with n ranging from 50 to 10K-a universe size for which the total length of articles exceed the LLM context length. For the evaluation, only the articles (not the Prolog database or the generated graphs) will be provided to the LLMs. To ensure that our findings are not tied to any specific PhantomWiki instance, we use 3 random dataset seeds for each configuration. Creating PhantomWiki instances with different random seeds leads to entirely different combinations of names, relations, and personal facts. In each instance, we generate question templates with maximum recursion depth d = 20, for a total of 50 templates. We sample 10 questions for each template, yielding a total of 500 questions per Phantom Wiki instance. As shown in Figures 5 and 6 (Appendix B), these questions have varying difficulty and number of answers. Accordingly, we prompt the LLMs to predict all answers as a comma-separated list and measure correctness with the answer-level F1 score.\n4.2. Models and Prompting Techniques\nWe test both open- and closed-source LLMs, namely OpenAI's GPT-4o (Hurst et al., 2024), Google's Gemini-1.5-Flash (Gemini Team, Google, 2024), and the instruction-tuned version of Meta's Llama-3.3-70B model (Dubey et al., 2024). We also evaluate DeepSeekAI's DeepSeek-R1-32B (Guo et al., 2025) (distilled with Qwen-2.5-32B (Yang et al., 2024)), which is an open-weights LLM trained on reasoning trace datasets. We prompt each LLM with the following techniques, broadly grouped in three ways:\nIn-Context Prompting. This technique includes the whole document corpus as part of the prompt. We use this type of prompting in conjunction with two strategies: ZEROSHOT-where the document corpus is immediately followed by the question-and Chain-of-Thought (COT) prompting (Wei et al., 2022), where we additionally include some examples on how step-by-step reasoning could lead to the correct answer. We include these prompts in Appendix C.2, as well as modifications to the ZEROSHOT strategy for DeepSeek-R1-32B.\nRAG Prompting. This setting augments generation with a pre-trained neural retriever (Lewis et al., 2020). We implement this by first searching for the 4 most relevant documents to the posed question based on UAE-LARGE-V1 embeddings. Next, we incorporate these retrieved documents into the model's prompt. Finally, we add in the same ZEROSHOT and COT prompts as In-Context Prompting. We document details on our retrieval algorithm in Appendix C.3.\nAgentic Prompting. REACT (Yao et al., 2022) is a prompting technique that enables LLMs to interleave reasoning steps with tool interactions, to solve complex tasks. For PhantomWiki QA task, the LLMs are provided with keyword-based tools RetrieveArticle and Search to retrieve relevant documents (see Appendix C.6 for tool"}, {"title": "4.3. Discussion", "content": "In Table 2, we report the mean F1 score across various universe sizes, LLMs, and prompting techniques. We first average F1 scores over all questions in a PhantomWiki instance, then compute the mean and standard error across the dataset generation seeds.\nWe first consider the small-universe setting (n = 50) in Table 2, which corresponds to roughly 16K tokens for the LLMs we test. In-Context prompting techniques outperform other techniques: COT with GPT-4o attains the highest performance, followed by ZEROSHOT with DeepSeek-R1-32B. Next, we consider the setting of medium universes (n = 500). Here the full document corpus can still be included in all LLMs' contexts, but we find that ZEROSHOT performs poorly for all LLMs, and DeepSeek-R1-32B especially struggles. F1 scores of COT for all LLMs degrade as well compared to n = 50, but not worse than REACT. Finally, in the setting of large universes (n = 5000), none of the LLMs we evaluate can accommodate the full document corpus. In-context techniques are no longer viable, and we must rely on RAG prompting and agentic prompting. RAG prompting attain poor F1 scores because the retriever fails to retrieve documents relevant for answering complex questions. On the other hand, agentic prompting technique shines in comparison to other techniques, indicating that LLMs are better suited to dynamically retrieve documents while reasoning on a question. We attribute the poor performance of DeepSeek-R1-32B in agentic prompting technique to its inferior tool-calling abilities compared to the other LLMs."}, {"title": "5. Evaluating Reasoning", "content": "To isolate LLM reasoning capabilities with PhantomWiki, we investigate model performance on small universes (n = 50) in Figure 3. Note that contexts of all LLMs can fully include small universe document corpora. Each PhantomWiki dataset contains questions covering a wide range of difficulty. We evaluate three approaches: in-context prompting, RAG prompting, and agentic prompting. For each we plot the F1 scores as a function of question difficulty, as measured by the number of reasoning steps necessary to answer the question. As mentioned in Section 3.3, this is determined by the type of question templates and the sampled relationships. For all LLMs and prompting techniques, we verify empirically that questions with larger reasoning steps are indeed more challenging to answer. By allowing question difficulty to be adjusted, PhantomWiki serves as a foundation"}, {"title": "6. Evaluating Retrieval", "content": "Next, to evaluate LLM retrieval capabilities, we use PhantomWiki to contrast two settings: (1) small universes where the document corpus can comfortably fit in LLM context, and (2) large universes where the full corpus exceeds context lengths. To this end, we increase the universe size up to n = 10K, which corresponds to document corpora well beyond the context lengths of state-of-the-art LLMs, and display the results in Figure 4.\nFor very small universes, COT usually outperforms ZE-"}, {"title": "7. Conclusion and Future Work", "content": "We introduce PhantomWiki-a benchmarking framework to evaluate reasoning and retrieval capabilities of language models. As we increase the question complexity and universe size, we observe that current state-of-the-art LLMs struggle in both aspects. PhantomWiki is scalable and memorization-resistant, hence well-suited to evaluate future generations of language models.\nOur work brings forth several research directions. Noting how we generate document corpora and questions, PhantomWiki is resistant to data contamination. We leave to future work to empirically test this claim, and to develop theory to formally prove that our benchmark is memorization-resistant. In this work we focus on question-answering over text corpora. We hope to extend PhantomWiki to other knowledge bases and modalities such as vision and audio, enabling analogous test suites for multimodal models."}, {"title": "Impact Statement", "content": "By leveraging context-free grammars and Prolog, PhantomWiki is able to generate large, durable and challenging datasets without using LLMs. The datasets have low computational, monetary, and environmental cost and our open-source framework is accessible to any user.\nSince PhantomWiki randomly generates datasets that do not reference any existing data, the evaluation benchmark is resistant to data leakage and memorization while training. The approach of publishing a dataset generation procedure rather than a fixed dataset also encourages better research practices (by using fresh datasets instead of overfitting to a single instance), and enables a more accurate evaluation of"}, {"title": "A. Background", "content": "A.1. Context-Free Grammars\nContext-free grammar (CFG) is a type of formal grammar where the productions rules govern how to generate text from non-terminals and terminals. A context-free grammar is defined by G = (V, \u03a3, R, S) where V and \u2211 denotes nonterminal and terminal respectively. R is a finite relation in V \u00d7 (VUE)* which specifies the production rules of the grammar. S \u2208 V is the start symbol. A production rule in R has the form\n$\\alpha - \\beta$       (1)\nwhere a \u2208 V, \u03b2\u2208 (VU \u03a3)*. It is conventional to list all rules with the same left-hand side on the same line and separate the right-hand side with \u201c|\u201d like a \u2192 \u03b21 | \u03b22."}, {"title": "B. Question template generation", "content": "B.1. Context-Free Grammar\nWe use the following CFG to generate question templates:\nB.2. CFG-generated question templates\nOur CFG produces the following 50 question templates at recursion depth d = 20. Note how the recursive production rule R_c -> R | N leads to chained productions."}, {"title": "C. Baseline Details", "content": "C.1. LLM SAMPLING HYPERPARAMETERS"}, {"title": "C.2. ZEROSHOT-SIMPLE", "content": "We use the following prompt for all models, where evidence is the concatenation of all documents in the Phantom Wiki instance.\nNow answer the following question:\nQuestion: {{question}}\n{{scratchpad}}"}]}